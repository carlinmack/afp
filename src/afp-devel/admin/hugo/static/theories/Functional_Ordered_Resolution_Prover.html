<div id="Weighted_FO_Ordered_Resolution_Prover">
<div class="head">
<h1>Theory Weighted_FO_Ordered_Resolution_Prover</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       A Fair Ordered Resolution Prover for First-Order Clauses with Weights
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2017
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2017
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A Fair Ordered Resolution Prover for First-Order Clauses with Weights›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>weighted_RP›</span></span></span></span> prover introduced below operates on finite multisets of clauses and
organizes the multiset of processed clauses as a priority queue to ensure that inferences are
performed in a fair manner, to guarantee completeness.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Weighted_FO_Ordered_Resolution_Prover
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../Ordered_Resolution_Prover/FO_Ordered_Resolution_Prover.html">Ordered_Resolution_Prover.FO_Ordered_Resolution_Prover</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> wclause <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">×</span> nat"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> wstate <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wclause multiset <span class="main">×</span> <span class="tfree">'a</span> wclause multiset <span class="main">×</span> <span class="tfree">'a</span> wclause multiset <span class="main">×</span> nat"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">state_of_wstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate <span class="main">⇒</span> <span class="tfree">'a</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">state_of_wstate</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span>set_mset <span class="main">(</span>image_mset fst <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">,</span> set_mset <span class="main">(</span>image_mset fst <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">,</span> set_mset <span class="main">(</span>image_mset fst <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> weighted_FO_resolution_prover <span class="main">=</span>
  FO_resolution_prover <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">subst_atm</span></span> <span class="quoted"><span class="free">id_subst</span></span> <span class="quoted"><span class="free">comp_subst</span></span> <span class="quoted"><span class="free">renamings_apart</span></span> <span class="quoted"><span class="free">atm_of_atms</span></span> <span class="quoted"><span class="free">mgu</span></span> <span class="quoted"><span class="free">less_atm</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wellorder<span class="main">)</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">subst_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">id_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">comp_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">renamings_apart</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause list <span class="main">⇒</span> <span class="tfree">'s</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">atm_of_atms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">mgu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'s</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">less_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">weight</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">×</span> nat <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    weight_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">clss_of_wstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clss_of_wstate</span> <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">≡</span> clss_of_state <span class="main">(</span>state_of_wstate <span class="free"><span class="bound"><span class="entity">St</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">N_of_wstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">N_of_wstate</span> <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">≡</span> N_of_state <span class="main">(</span>state_of_wstate <span class="free"><span class="bound"><span class="entity">St</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">P_of_wstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P_of_wstate</span> <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">≡</span> P_of_state <span class="main">(</span>state_of_wstate <span class="free"><span class="bound"><span class="entity">St</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Q_of_wstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q_of_wstate</span> <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">≡</span> Q_of_state <span class="main">(</span>state_of_wstate <span class="free"><span class="bound"><span class="entity">St</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wN_of_wstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate <span class="main">⇒</span> <span class="tfree">'a</span> wclause multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wN_of_wstate</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wP_of_wstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate <span class="main">⇒</span> <span class="tfree">'a</span> wclause multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wP_of_wstate</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wQ_of_wstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate <span class="main">⇒</span> <span class="tfree">'a</span> wclause multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wQ_of_wstate</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">n_of_wstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">n_of_wstate</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> of_wstate_split<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>wN_of_wstate <span class="free">St</span><span class="main">,</span> wP_of_wstate <span class="free">St</span><span class="main">,</span> wQ_of_wstate <span class="free">St</span><span class="main">,</span> n_of_wstate <span class="free">St</span><span class="main">)</span> <span class="main">=</span> <span class="free">St</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">St</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">grounding_of_wstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">grounding_of_wstate</span> <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">≡</span> grounding_of_state <span class="main">(</span>state_of_wstate <span class="free"><span class="bound"><span class="entity">St</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Liminf_wstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate llist <span class="main">⇒</span> <span class="tfree">'a</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Liminf_wstate</span> <span class="free"><span class="bound"><span class="entity">Sts</span></span></span> <span class="main">≡</span> Liminf_state <span class="main">(</span>lmap state_of_wstate <span class="free"><span class="bound"><span class="entity">Sts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> timestamp_le_weight<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> weight_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">k</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">k</span></span></span><span class="main"><span class="main">]</span></span> Suc_le_eq le_less le_trans<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">weighted_RP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate <span class="main">⇒</span> <span class="tfree">'a</span> wstate <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  tautology_deletion<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span> Pos <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> forward_subsumption<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∈#</span> image_mset fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">⟹</span> subsumes <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> backward_subsumption_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∈#</span> image_mset fst <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∈#</span> image_mset fst <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟹</span>
    strictly_subsumes <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="main">{#</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="bound">E</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> backward_subsumption_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∈#</span> image_mset fst <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⟹</span> strictly_subsumes <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> forward_reduction<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L'</span></span></span><span class="main">#}</span> <span class="main">∈#</span> image_mset fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">L'</span></span></span> <span class="keyword1">⋅l</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> backward_reduction_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L'</span></span></span><span class="main">#}</span> <span class="main">∈#</span> image_mset fst <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⟹</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">L'</span></span></span> <span class="keyword1">⋅l</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">#}</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> backward_reduction_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L'</span></span></span><span class="main">#}</span> <span class="main">∈#</span> image_mset fst <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⟹</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">L'</span></span></span> <span class="keyword1">⋅l</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> clause_processing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> inference_computation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="free">weight</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> mset_set <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> concls_of
      <span class="main">(</span>inference_system.inferences_between <span class="main">(</span>ord_FO_Γ <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="main">(</span>image_mset fst <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="main">{#</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="bound">D</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weighted_RP_imp_RP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">St</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">St'</span> <span class="main">⟹</span> state_of_wstate <span class="free">St</span> <span class="main">↝</span> state_of_wstate <span class="free">St'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> weighted_RP.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>backward_subsumption_P <span class="skolem">D</span> <span class="skolem">N</span> <span class="skolem">C</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(↝)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
          RP.backward_subsumption_P<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">D</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main"><span class="main">`</span></span></span> set_mset <span class="skolem"><span class="skolem"><span class="skolem">N</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">C</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main"><span class="main">`</span></span></span> set_mset <span class="skolem"><span class="skolem"><span class="skolem">P</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">C</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span>
            <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main"><span class="main">`</span></span></span> set_mset <span class="skolem"><span class="skolem"><span class="skolem">Q</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">use</span> backward_subsumption_P <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>inference_computation <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">i</span> <span class="skolem">N</span> <span class="skolem">n</span> <span class="skolem">Q</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(↝)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
           RP.inference_computation<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main"><span class="main">`</span></span></span> set_mset <span class="skolem"><span class="skolem"><span class="skolem">N</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main"><span class="main">`</span></span></span> set_mset <span class="skolem"><span class="skolem"><span class="skolem">Q</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">C</span></span></span></span></span></span>
             <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main"><span class="main">`</span></span></span> set_mset <span class="skolem"><span class="skolem"><span class="skolem">P</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">C</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
         <span class="operator">use</span> inference_computation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_ord_FO_resolution_inferences_between <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>
           <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> comp_def image_comp inference_system.inferences_between_def›</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> RP.intros <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> final_weighted_RP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">St</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> weighted_RP.cases<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">Sts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate llist"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    full_deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"full_chain <span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span> <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    empty_P0<span class="main">:</span> <span class="quoted"><span class="quoted">"P_of_wstate <span class="main">(</span>lhd <span class="free">Sts</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    empty_Q0<span class="main">:</span> <span class="quoted"><span class="quoted">"Q_of_wstate <span class="main">(</span>lhd <span class="free">Sts</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_Sts0<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>clss_of_wstate <span class="main">(</span>lhd <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lhd <span class="free">Sts</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> deriv <span class="main">=</span> full_chain_imp_chain<span class="main">[</span><span class="operator">OF</span> full_deriv<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> lhd_lmap_Sts <span class="main">=</span> llist.map_sel<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> chain_not_lnull<span class="main"><span class="main">[</span></span><span class="operator">OF</span> deriv<span class="main"><span class="main">]</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> deriv_RP<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(↝)</span> <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> deriv weighted_RP_imp_RP <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chain_lmap<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_Sts0_RP<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>clss_of_state <span class="main">(</span>lhd <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_Sts0 chain_length_pos<span class="main">[</span><span class="operator">OF</span> deriv<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_P0_RP<span class="main">:</span> <span class="quoted"><span class="quoted">"P_of_state <span class="main">(</span>lhd <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> empty_P0 chain_length_pos<span class="main">[</span><span class="operator">OF</span> deriv<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_Q0_RP<span class="main">:</span> <span class="quoted"><span class="quoted">"Q_of_state <span class="main">(</span>lhd <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> empty_Q0 chain_length_pos<span class="main">[</span><span class="operator">OF</span> deriv<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> Sts_thms <span class="main">=</span> deriv_RP finite_Sts0_RP empty_P0_RP empty_Q0_RP

<span class="keyword1"><span class="command">theorem</span></span> weighted_RP_model<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">St</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">St'</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨s</span> grounding_of_wstate <span class="free">St'</span> <span class="main">⟷</span> <span class="free">I</span> <span class="keyword1">⊨s</span> grounding_of_wstate <span class="free">St</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> RP_model Sts_thms weighted_RP_imp_RP <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">S_gQ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S_gQ</span> <span class="main">≡</span> S_Q <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> sq<span class="main">:</span> selection <span class="quoted">S_gQ</span>
  <span class="keyword1"><span class="command">unfolding</span></span> S_Q_def <span class="keyword1"><span class="command">using</span></span> S_M_selects_subseteq S_M_selects_neg_lits selection_axioms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> gd<span class="main">:</span> ground_resolution_with_selection <span class="quoted">S_gQ</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">interpretation</span></span> src<span class="main">:</span> standard_redundancy_criterion_reductive <span class="quoted">gd.ord_Γ</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">interpretation</span></span> src<span class="main">:</span> standard_redundancy_criterion_counterex_reducing <span class="quoted">gd.ord_Γ</span>
  <span class="quoted"><span class="quoted">"ground_resolution_with_selection.INTERP S_gQ"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">lemmas</span></span> ord_Γ_saturated_upto_def <span class="main">=</span> src.saturated_upto_def
<span class="keyword1"><span class="command">lemmas</span></span> ord_Γ_saturated_upto_complete <span class="main">=</span> src.saturated_upto_complete
<span class="keyword1"><span class="command">lemmas</span></span> ord_Γ_contradiction_Rf <span class="main">=</span> src.contradiction_Rf

<span class="keyword1"><span class="command">theorem</span></span> weighted_RP_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Liminf_wstate <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="main">(</span>grounding_of_wstate <span class="main">(</span>lhd <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RP_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> deriv_RP assms<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> lhd_lmap_Sts<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RP_filtered_measure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> wclause <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> wstate <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RP_filtered_measure</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">p</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">P</span><span class="main">,</span> <span class="bound">Q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span>sum_mset <span class="main">(</span>image_mset <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> Suc <span class="main">(</span>size <span class="bound">C</span><span class="main">)</span><span class="main">)</span> <span class="main">{#</span><span class="bound">Di</span> <span class="main">∈#</span> <span class="bound">N</span> <span class="main">+</span> <span class="bound">P</span> <span class="main">+</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">p</span> <span class="bound">Di</span><span class="main">#}</span><span class="main">)</span><span class="main">,</span>
      size <span class="main">{#</span><span class="bound">Di</span> <span class="main">∈#</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">p</span> <span class="bound">Di</span><span class="main">#}</span><span class="main">,</span> size <span class="main">{#</span><span class="bound">Di</span> <span class="main">∈#</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">p</span> <span class="bound">Di</span><span class="main">#}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RP_combined_measure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> wstate <span class="main">⇒</span> nat <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RP_combined_measure</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">w</span> <span class="bound">St</span><span class="main">.</span>
     <span class="main">(</span><span class="bound">w</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> n_of_wstate <span class="bound">St</span><span class="main">,</span> RP_filtered_measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">w</span><span class="main">)</span> <span class="bound">St</span><span class="main">,</span>
      RP_filtered_measure <span class="main">(</span><span class="main">λ</span><span class="bound">Ci</span><span class="main">.</span> True<span class="main">)</span> <span class="bound">St</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">RP_filtered_relation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RP_filtered_relation</span> <span class="main">≡</span> natLess <span class="keyword1">&lt;*lex*&gt;</span> natLess <span class="keyword1">&lt;*lex*&gt;</span> natLess"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">RP_combined_relation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">×</span>
    <span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RP_combined_relation</span> <span class="main">≡</span> natLess <span class="keyword1">&lt;*lex*&gt;</span> RP_filtered_relation <span class="keyword1">&lt;*lex*&gt;</span> RP_filtered_relation"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fst3</span> <span class="main">::</span> <span class="tfree">'b</span> <span class="main">*</span> <span class="tfree">'c</span> <span class="main">*</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">≡</span> fst"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">snd3</span> <span class="main">::</span> <span class="tfree">'b</span> <span class="main">*</span> <span class="tfree">'c</span> <span class="main">*</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">trd3</span> <span class="main">::</span> <span class="tfree">'b</span> <span class="main">*</span> <span class="tfree">'c</span> <span class="main">*</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> snd <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  wf_RP_filtered_relation<span class="main">:</span> <span class="quoted"><span class="quoted">"wf RP_filtered_relation"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  wf_RP_combined_relation<span class="main">:</span> <span class="quoted"><span class="quoted">"wf RP_combined_relation"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> natLess_def <span class="keyword1"><span class="command">using</span></span> wf_less wf_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> multiset_sum_of_Suc_f_monotone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">⊂#</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">N</span><span class="main">.</span> Suc <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> Suc <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">N</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">M</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">M</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">M</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_union sum_mset.union<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">M</span><span class="main">.</span> Suc <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gr_zeroI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">N</span><span class="main">.</span> Suc <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">M</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span><span class="main">.</span> Suc <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_union_subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">x</span> <span class="main">(</span>remove1_mset <span class="skolem">x</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> add.prems add_mset_remove_trivial_If mset_subset_insertD<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.commute add_less_cancel_right sum_mset.insert<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> multiset_sum_monotone_f'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="main">⊂#</span> <span class="free">DD</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> <span class="free">CC</span><span class="main">.</span> Suc <span class="main">(</span><span class="free">f</span> <span class="bound">C</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> <span class="free">DD</span><span class="main">.</span> Suc <span class="main">(</span><span class="free">f</span> <span class="bound">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multiset_sum_of_Suc_f_monotone<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∘</span> fst"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> comp_apply image_mset_cong2 split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_mset_strict_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">p</span> <span class="bound">y</span><span class="main">#}</span> <span class="main">⊂#</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">E</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">p</span> <span class="bound">E</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">{#</span><span class="bound">E</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">p</span> <span class="bound">E</span><span class="main">#}</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> count <span class="free">M</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> lt_count<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">p</span> <span class="bound">y</span><span class="main">#}</span> <span class="free">x</span> <span class="main">&lt;</span> count <span class="free">M</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> subseteq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_not_refl2 subset_mset.le_neq_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weighted_RP_measure_decreasing_N<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">St</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">St'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span> <span class="main">∈#</span> wN_of_wstate <span class="free">St</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RP_filtered_measure <span class="main">(</span><span class="main">λ</span><span class="bound">Ci</span><span class="main">.</span> True<span class="main">)</span> <span class="free">St'</span><span class="main">,</span> RP_filtered_measure <span class="main">(</span><span class="main">λ</span><span class="bound">Ci</span><span class="main">.</span> True<span class="main">)</span> <span class="free">St</span><span class="main">)</span>
    <span class="main">∈</span> RP_filtered_relation"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> weighted_RP.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>backward_subsumption_P <span class="skolem">D</span> <span class="skolem">N</span> <span class="skolem">C'</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">E</span> <span class="main">≠</span> <span class="skolem">C'</span><span class="main">#}</span> <span class="main">⊂#</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_mset_strict_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="main">¬</span>fst <span class="bound">X</span> <span class="main">=</span>  <span class="skolem">C'</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> filter_mset_cong fst_conv prod.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">E</span> <span class="main">≠</span> <span class="skolem">C'</span><span class="main">#}</span><span class="main">.</span> Suc <span class="main">(</span>size <span class="bound">C</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> Suc <span class="main">(</span>size <span class="bound">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multiset_sum_monotone_f'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">E</span> <span class="main">≠</span> <span class="skolem">C'</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted">size</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> natLess_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> natLess_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> weighted_RP_measure_decreasing_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">St</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">St'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="free">St</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">St'</span><span class="main">,</span> RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">St</span><span class="main">)</span>
    <span class="main">∈</span> RP_combined_relation"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> weighted_RP.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>backward_subsumption_P <span class="skolem">D</span> <span class="skolem">N</span> <span class="skolem">C'</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">n</span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">St</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">St</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> <span class="main">{#</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">E</span> <span class="main">≠</span> <span class="skolem">C'</span><span class="main">#}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">St'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">St'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> backward_subsumption_P <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> P'_sub_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊂#</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P'_def <span class="keyword1"><span class="command">using</span></span> filter_mset_strict_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">Dj</span><span class="main">.</span> fst <span class="bound">Dj</span> <span class="main">≠</span> <span class="skolem">C'</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> filter_mset_cong fst_conv prod.case_eq_if<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> P'_subeq_P_filter<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span><span class="bound">Ca</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P'</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">Ca</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P'_sub_P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multiset_filter_mono<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St'</span><span class="main">)</span>
    <span class="main">≤</span> fst3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> St'_def St_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">Ca</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P'</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span><span class="main">.</span> Suc <span class="main">(</span>size <span class="bound">C</span><span class="main">)</span><span class="main">)</span>
    <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">Ca</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> Suc <span class="main">(</span>size <span class="bound">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P'_subeq_P_filter <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_image_mset_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst3 <span class="main">(</span>snd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St'</span><span class="main">)</span><span class="main">)</span>
    <span class="main">≤</span> fst3 <span class="main">(</span>snd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> St'_def St_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd3 <span class="main">(</span>snd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St'</span><span class="main">)</span><span class="main">)</span>
    <span class="main">≤</span> snd3 <span class="main">(</span>snd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> St'_def St_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> P'_subeq_P_filter <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="main">(</span><span class="bound">Ca</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P'</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span>
    <span class="main">≤</span> size <span class="main">{#</span><span class="main">(</span><span class="bound">Ca</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_mset_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trd3 <span class="main">(</span>snd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St'</span><span class="main">)</span><span class="main">)</span>
    <span class="main">≤</span> trd3 <span class="main">(</span>snd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> St'_def St_def <span class="keyword1"><span class="command">unfolding</span></span> fst_def snd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> P'_sub_P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P'</span><span class="main">.</span> Suc <span class="main">(</span>size <span class="bound">C</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> Suc <span class="main">(</span>size <span class="bound">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multiset_sum_monotone_f'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">E</span> <span class="main">≠</span> <span class="skolem">C'</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted">size</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> P'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst3 <span class="main">(</span>trd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St'</span><span class="main">)</span><span class="main">)</span>
    <span class="main">&lt;</span> fst3 <span class="main">(</span>trd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P'_def St'_def St_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> natLess_def P'_def St'_def St_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>inference_computation <span class="skolem">P</span> <span class="skolem">C'</span> <span class="skolem">i'</span> <span class="skolem">N</span> <span class="skolem">n</span> <span class="skolem">Q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">n</span> <span class="main">&gt;</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> Suc <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> natLess_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> n_nle_w<span class="main">:</span> False

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">St</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">St</span> <span class="main">=</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">St'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">St'</span> <span class="main">=</span>  <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="main">{#</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">D</span> <span class="main">≠</span> <span class="skolem">C'</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">Q</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">concls</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wclause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">concls</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> concls_of <span class="main">(</span>inference_system.inferences_between <span class="main">(</span>ord_FO_Γ <span class="free">S</span><span class="main">)</span>
         <span class="main">(</span>fst <span class="main">`</span> set_mset <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">C'</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">concls</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> concls_def <span class="keyword1"><span class="command">using</span></span> finite_ord_FO_resolution_inferences_between <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">D</span></span><span class="main">,</span> <span class="bound"><span class="bound">ia</span></span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">concls</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> concls_def <span class="keyword1"><span class="command">using</span></span> n_nle_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈#</span> mset_set <span class="skolem">concls</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fin filter_mset_empty_if_finite_and_filter_set_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">concls</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> n_low_weight_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">N</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inference_computation <span class="keyword1"><span class="command">unfolding</span></span> concls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">weight</span> <span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inference_computation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i'_le_w_Ci<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> timestamp_le_weight<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="skolem">C'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> subs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">N</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">D</span> <span class="main">≠</span> <span class="skolem">C'</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span>
      <span class="main">⊆#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈#</span> <span class="main">{#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">Q</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n_low_weight_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_filter_mono<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St'</span><span class="main">)</span>
      <span class="main">≤</span> fst3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> St'_def St_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>RP_filtered_measure <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St'</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">N</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="bound">D</span> <span class="main">≠</span> <span class="skolem">C'</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span><span class="main">.</span>
         <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span><span class="main">.</span> Suc <span class="main">(</span>size <span class="bound">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> St'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈#</span> <span class="main">{#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">Q</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span><span class="main">.</span>
      Suc <span class="main">(</span>size <span class="bound">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subs sum_image_mset_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> fst <span class="main">(</span>RP_filtered_measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> St_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst3 <span class="main">(</span>snd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St'</span><span class="main">)</span><span class="main">)</span>
      <span class="main">≤</span> fst3 <span class="main">(</span>snd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd3 <span class="main">(</span>snd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      snd3 <span class="main">(</span>snd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> St_def St'_def <span class="keyword1"><span class="command">using</span></span> n_low_weight_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trd3 <span class="main">(</span>snd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St'</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span>
      trd3 <span class="main">(</span>snd3 <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">St</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> St_def St'_def <span class="keyword1"><span class="command">using</span></span> i'_le_w_Ci
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_imp_less_Suc multiset_filter_mono size_mset_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> natLess_def St'_def St_def lex_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> natLess_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> preserve_min_or_delete_completely<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">St</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">St'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="free">St</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="free">St</span> <span class="main">⟶</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="free">St'</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∉#</span> wP_of_wstate <span class="free">St'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> weighted_RP.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>backward_reduction_P <span class="skolem">D</span> <span class="skolem">L'</span> <span class="skolem">N</span> <span class="skolem">L</span> <span class="skolem">σ</span> <span class="skolem">C'</span> <span class="skolem">P</span> <span class="skolem">i'</span> <span class="skolem">Q</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="skolem">C'</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">L</span><span class="main">#}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True_outer<span class="main">:</span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> C_i_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> backward_reduction_P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="skolem">i'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> backward_reduction_P <span class="keyword1"><span class="command">unfolding</span></span> True_outer<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nin_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">∉#</span> <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_in_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> max backward_reduction_P<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> True_outer<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> True_outer<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> nin_P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> C_i_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> C_i_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> backward_reduction_P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> preserve_min_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">St</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">St'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="free">St'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="free">St</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="free">St</span> <span class="main">⟶</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="free">St'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms preserve_min_or_delete_completely <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> preserve_min_P_Sts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> deriv assms chain_lnth_rel preserve_min_P <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> in_lnth_in_Supremum_ldrop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Sup_llist <span class="main">(</span>lmap set_mset <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> ldrop_eq_LConsD ldropn_0 llist.simps<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span> contra_subsetD
      ldrop_enat ldropn_Suc_conv_ldropn lnth_0 lnth_lmap lnth_subset_Sup_llist<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> persistent_wclause_in_P_if_persistent_clause_in_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap P_of_state <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap <span class="main">(</span>set_mset <span class="main">∘</span> wP_of_wstate<span class="main">)</span> <span class="free">Sts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t_C</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_C_p<span class="main">:</span>
    <span class="quoted"><span class="quoted">"enat <span class="skolem">t_C</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">t_C</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">∈</span> P_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_p<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">t_C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_C_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lnth <span class="free">Sts</span> <span class="skolem">t_C</span>"</span></span><span class="main">)</span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> Ci_in_nth_wP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">using</span></span> that t_C_p<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">t_C</span> <span class="main">+</span> <span class="main">_</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lnth <span class="free">Sts</span> <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">in_Sup_wP</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">in_Sup_wP</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Sup_llist <span class="main">(</span>lmap <span class="main">(</span>set_mset <span class="main">∘</span> wP_of_wstate<span class="main">)</span> <span class="main">(</span>ldrop <span class="skolem">t_C</span> <span class="free">Sts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">in_Sup_wP</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_p assms<span class="main">(</span>1<span class="main">)</span> in_lnth_in_Supremum_ldrop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t_C</span></span> <span class="quoted"><span class="quoted">"lmap wP_of_wstate <span class="free">Sts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">]</span> t_C_p
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_Sup_wP_def llist.map_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_p<span class="main">:</span> <span class="quoted"><span class="quoted">"is_least <span class="skolem">in_Sup_wP</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_Sup_wP_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> least_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Sup_llist <span class="main">(</span>lmap <span class="main">(</span>set_mset <span class="main">∘</span> wP_of_wstate<span class="main">)</span> <span class="main">(</span>ldrop <span class="skolem">t_C</span> <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_least_def in_Sup_wP_def <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_smallest<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> enat <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="bound">t</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.commute ldrop_enat ldrop_eq_LConsD ldrop_ldrop ldropn_Suc_conv_ldropn
        plus_enat_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>  lnth_ldropn Sup_llist_def UN_I ldrop_lmap llength_lmap lnth_lmap
        mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> j_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t_Cj</span><span class="main">.</span> <span class="bound">t_Cj</span> <span class="main">&lt;</span> llength <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="skolem">t_C</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="main">(</span>ldrop <span class="skolem">t_C</span> <span class="free">Sts</span><span class="main">)</span> <span class="bound">t_Cj</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_Sup_wP_def Sup_llist_def is_least_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t_Cj</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_p<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t_Cj</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"enat <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t_Cj</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.commute ldrop_enat ldrop_eq_LConsD ldrop_ldrop ldropn_Suc_conv_ldropn
        plus_enat_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> lhd_ldropn<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Ci_stays<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t_Cj</span> <span class="main">+</span> <span class="skolem">t</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t_Cj</span> <span class="main">+</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> j_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> any_Ck_in_wP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t_Cj</span> <span class="main">+</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">using</span></span> that j_p j_smallest Suc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Suc_ile_eq add.commute add.left_commute add_Suc less_imp_le plus_enat_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
          the_enat.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> Cj_in_wP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t_Cj</span> <span class="main">+</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Suc_ile_eq add.commute add_Suc_right less_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> P_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t_Cj</span> <span class="main">+</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t_C_p<span class="main">(</span>2<span class="main">)</span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t_Cj</span> <span class="main">+</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Suc.prems Ci_in_nth_wP add.commute add.left_commute add_Suc_right enat_ord_code<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t_Cj</span> <span class="main">+</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> preserve_min_P_Sts Cj_in_wP any_Ck_in_wP Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈#</span> lnth <span class="main">(</span>lmap wP_of_wstate <span class="free">Sts</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t_Cj</span> <span class="main">+</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Suc.prems add.commute add_Suc_right lnth_lmap<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t_Cj</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">&lt;</span> llength <span class="main">(</span>lmap <span class="main">(</span>set_mset <span class="main">∘</span> wP_of_wstate<span class="main">)</span> <span class="free">Sts</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ci_stays<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">t_C</span> <span class="main">+</span> <span class="skolem">t_Cj</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add_diff_inverse llength_lmap<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap <span class="main">(</span>set_mset <span class="main">∘</span> wP_of_wstate<span class="main">)</span> <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">using</span></span> j_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap <span class="main">(</span>set_mset <span class="main">∘</span> wP_of_wstate<span class="main">)</span> <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lfinite_not_LNil_nth_llast<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Sts</span> <span class="main">≠</span> LNil"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> llength <span class="free">Sts</span><span class="main">.</span> lnth <span class="free">Sts</span> <span class="bound">i</span> <span class="main">=</span> llast <span class="free">Sts</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> llength <span class="free">Sts</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lfinite.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lfinite_LConsI <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> LNil"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True zero_enat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      i_p<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="skolem">xs</span> <span class="main">∧</span> lnth <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">=</span> llast <span class="skolem">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> llength <span class="skolem">xs</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> enat <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lfinite_LConsI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="main">(</span>LCons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_ile_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> i_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lnth <span class="main">(</span>LCons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> llast <span class="main">(</span>LCons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gr_implies_not_zero llast_LCons llength_lnull lnth_Suc_LCons<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> i_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> llength <span class="main">(</span>LCons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> enat <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym_conv2 eSuc_enat eSuc_ile_mono ileI1 iless_Suc_eq llength_LCons<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fair_if_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">Sts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fair_state_seq <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> unfair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> fair_state_seq <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> no_inf_from_last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">¬</span> llast <span class="free">Sts</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fin full_chain_iff_chain<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span>"</span></span> <span class="quoted"><span class="free">Sts</span></span><span class="main">]</span> full_deriv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> unfair <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap N_of_state <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>
       <span class="main">∪</span> Liminf_llist <span class="main">(</span>lmap P_of_state <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fair_state_seq_def Liminf_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_p<span class="main">:</span>
    <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟹</span>
     <span class="skolem">C</span> <span class="main">∈</span> N_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> P_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> C_in_llast<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> N_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>llast <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> P_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>llast <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      l_p<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">l</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">∧</span> lnth <span class="free">Sts</span> <span class="skolem">l</span> <span class="main">=</span> llast <span class="free">Sts</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> llength <span class="free">Sts</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> enat <span class="skolem">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fin lfinite_not_LNil_nth_llast i_p<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> N_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> P_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i_p<span class="main">(</span>1<span class="main">)</span> i_p<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> l_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wclause multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> wN_of_wstate <span class="main">(</span>llast <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wclause multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> wP_of_wstate <span class="main">(</span>llast <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wclause multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> wQ_of_wstate <span class="main">(</span>llast <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> n_of_wstate <span class="main">(</span>llast <span class="free">Sts</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"N_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>llast <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">N</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"llast <span class="free">Sts</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"llast <span class="free">Sts</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> weighted_RP.clause_processing<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="skolem">D</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="skolem">Q</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> N_def P_def Q_def n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">St'</span><span class="main">.</span> llast <span class="free">Sts</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">St'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"N_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>llast <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"llast <span class="free">Sts</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> P_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>llast <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C_in_llast <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"llast <span class="free">Sts</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">weight</span> <span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">weight</span> <span class="main">`</span> set_mset <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span><span class="main">.</span> is_least <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> <span class="main">(</span><span class="free">weight</span> <span class="main">`</span> set_mset <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="bound">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> least_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">D'</span><span class="main">,</span> <span class="bound">j'</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="free">weight</span> <span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="bound">D'</span><span class="main">,</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms linorder_not_less <span class="keyword1"><span class="command">unfolding</span></span> is_least_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 6 0<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">D'</span><span class="main">,</span> <span class="bound">j'</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span><span class="main">.</span> <span class="free">weight</span> <span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="bound">D'</span><span class="main">,</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      Dj_in_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> min <span class="keyword1"><span class="command">have</span></span> min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">D'</span><span class="main">,</span> <span class="bound">j'</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">#}</span><span class="main">.</span> <span class="free">weight</span> <span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="free">weight</span> <span class="main">(</span><span class="bound">D'</span><span class="main">,</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mset_subset_diff_self<span class="main">[</span><span class="operator">OF</span> Dj_in_p<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">N'</span> <span class="main">=</span> mset_set <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">D'</span><span class="main">.</span> <span class="main">(</span><span class="bound">D'</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> concls_of <span class="main">(</span>inference_system.inferences_between <span class="main">(</span>ord_FO_Γ <span class="free">S</span><span class="main">)</span>
         <span class="main">(</span>set_mset <span class="main">(</span>image_mset fst <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span> <span class="skolem">D</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"llast <span class="free">Sts</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span><span class="skolem">N'</span><span class="main">,</span> <span class="main">{#</span><span class="main">(</span><span class="bound">D'</span><span class="main">,</span> <span class="bound">j'</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">P</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">#}</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">≠</span> <span class="skolem">D</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">Q</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">D</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> weighted_RP.inference_computation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="skolem">D</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">N'</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">Q</span></span><span class="main">,</span> <span class="operator">OF</span> min N'_def<span class="main">]</span>
        of_wstate_split<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"llast <span class="free">Sts</span>"</span></span><span class="main">]</span> Dj_in_p
      <span class="keyword1"><span class="command">unfolding</span></span> N_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> P_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Q_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> n_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">St'</span><span class="main">.</span> llast <span class="free">Sts</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">St'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">St'</span><span class="main">.</span> llast <span class="free">Sts</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">St'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> no_inf_from_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> N_of_state_state_of_wstate_wN_of_wstate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> N_of_state <span class="main">(</span>state_of_wstate <span class="free">St</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> wN_of_wstate <span class="free">St</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> N_of_state.elims assms eq_fst_iff fstI fst_conv image_iff of_wstate_split set_image_mset
      state_of_wstate.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_wN_of_wstate_in_N_of_wstate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈#</span> wN_of_wstate <span class="free">St</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">∈</span> N_of_wstate <span class="free">St</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_guards_query_query<span class="main"><span class="main">)</span></span> N_of_state.simps fst_conv image_eqI of_wstate_split
      set_image_mset state_of_wstate.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_wP_of_wstate_in_P_of_wstate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="free">St</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">∈</span> P_of_wstate <span class="free">St</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_guards_query_query<span class="main"><span class="main">)</span></span> P_of_state.simps fst_conv image_eqI of_wstate_split
      set_image_mset state_of_wstate.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_wQ_of_wstate_in_Q_of_wstate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈#</span> wQ_of_wstate <span class="free">St</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">∈</span> Q_of_wstate <span class="free">St</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_guards_query_query<span class="main"><span class="main">)</span></span> Q_of_state.simps fst_conv image_eqI of_wstate_split
      set_image_mset state_of_wstate.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> n_of_wstate_weighted_RP_increasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">St</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">St'</span> <span class="main">⟹</span> n_of_wstate <span class="free">St</span> <span class="main">≤</span> n_of_wstate <span class="free">St'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> weighted_RP.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_of_wstate_monotonic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"n_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> n_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"n_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> n_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enat_ord_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> le_less_Suc_eq less_le_trans not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lnth <span class="free">Sts</span> <span class="skolem">i</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deriv chain_lnth_rel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span>"</span></span> <span class="quoted"><span class="free">Sts</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"n_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> n_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n_of_wstate_weighted_RP_increasing<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lnth <span class="free">Sts</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"lnth <span class="free">Sts</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> infinite_chain_relation_measure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    measure_decreasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">St</span> <span class="bound">St'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">St</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">St</span> <span class="bound">St'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">m</span> <span class="bound">St'</span><span class="main">,</span> <span class="free">m</span> <span class="bound">St</span><span class="main">)</span> <span class="main">∈</span> <span class="free">mR</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    non_infer_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    inf<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="free">Sts</span> <span class="main">=</span> <span class="main">∞</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>lnth <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">mR</span><span class="main">)</span><span class="main">¯¯</span> <span class="main">(</span>lmap <span class="free">m</span> <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> lnth_rel_chain<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="main">(</span>lmap <span class="free">m</span> <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> inf <span class="keyword1"><span class="command">have</span></span> ldrop_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span> <span class="main">=</span> <span class="main">∞</span> <span class="main">∧</span> <span class="main">¬</span> lfinite <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> llength_eq_infty_conv_lfinite<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">St</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">St</span> <span class="main">=</span> lnth <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">St'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">St'</span> <span class="main">=</span> lnth <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> P'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">St</span> <span class="main">∧</span> <span class="free">P</span> <span class="skolem">St'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> St_def St'_def <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ldrop_inf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">St</span> <span class="skolem">St'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> St_def St'_def
      <span class="keyword1"><span class="command">using</span></span> non_infer_chain infinite_chain_lnth_rel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span>"</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="skolem">St'</span><span class="main">,</span> <span class="free">m</span> <span class="skolem">St</span><span class="main">)</span> <span class="main">∈</span> <span class="free">mR</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> measure_decreasing P' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lnth <span class="main">(</span>lmap <span class="free">m</span> <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> lnth <span class="main">(</span>lmap <span class="free">m</span> <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span>
      <span class="main">∈</span> <span class="free">mR</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> St_def St'_def <span class="keyword1"><span class="command">using</span></span> lnth_lmap
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> enat.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> enat_add_left_cancel enat_ord_simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> inf ldrop_lmap llength_lmap
          lnth_ldrop plus_enat_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> enat <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="main">(</span>lmap <span class="free">m</span> <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">mR</span><span class="main">)</span><span class="main">¯¯</span> <span class="main">(</span>lnth <span class="main">(</span>lmap <span class="free">m</span> <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span>
      <span class="main">(</span>lnth <span class="main">(</span>lmap <span class="free">m</span> <span class="main">(</span>ldrop <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> weighted_RP_fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair_state_seq <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> fair_state_seq <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> inff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lfinite <span class="free">Sts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fair_if_finite
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="free">Sts</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> llength_eq_infty_conv_lfinite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap N_of_state <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>
       <span class="main">∪</span> Liminf_llist <span class="main">(</span>lmap P_of_state <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fair_state_seq_def Liminf_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap N_of_state <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">x</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xa</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="bound">xa</span> <span class="main">∧</span> enat <span class="bound">xa</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟶</span> <span class="skolem">C</span> <span class="main">∈</span> N_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> wN_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf N_of_state_state_of_wstate_wN_of_wstate<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_p<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> wN_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> chain_drop_Sts<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span> <span class="main">(</span>ldrop <span class="skolem">k</span> <span class="free">Sts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> deriv inf inff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_chain_ldropn_chain ldrop_enat<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> in_N_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> wN_of_wstate <span class="main">(</span>lnth <span class="main">(</span>ldrop <span class="skolem">k</span> <span class="free">Sts</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> k_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute inf<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> RP_filtered_relation<span class="main">)</span><span class="main">¯¯</span> <span class="main">(</span>lmap <span class="main">(</span>RP_filtered_measure <span class="main">(</span><span class="main">λ</span><span class="bound">Ci</span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>ldrop <span class="skolem">k</span> <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inff inf weighted_RP_measure_decreasing_N chain_drop_Sts
        infinite_chain_relation_measure<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">St</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈#</span> wN_of_wstate <span class="bound">St</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> wfP_iff_no_infinite_down_chain_llist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> RP_filtered_relation"</span></span><span class="main">]</span>
        wf_RP_filtered_relation inff
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> inf_llist_lnth ldrop_enat_inf_llist lfinite_inf_llist
        lfinite_lmap wfPUNIVI wf_induct_rule<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap P_of_state <span class="main">(</span>lmap state_of_wstate <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_p<span class="main">:</span>
      <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟹</span> <span class="skolem">C</span> <span class="main">∈</span> P_of_state <span class="main">(</span>state_of_wstate <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap <span class="main">(</span>set_mset <span class="main">∘</span> wP_of_wstate<span class="main">)</span> <span class="free">Sts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> persistent_wclause_in_P_if_persistent_clause_in_P<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> asm inf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">≥</span> <span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set_mset <span class="main">∘</span> wP_of_wstate<span class="main">)</span> <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">using</span></span> inff inf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_p<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k'</span></span><span class="main">≥</span><span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set_mset <span class="main">∘</span> wP_of_wstate<span class="main">)</span> <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">k'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> Ci_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set_mset <span class="main">∘</span> wP_of_wstate<span class="main">)</span> <span class="main">(</span>lnth <span class="main">(</span>ldrop <span class="skolem">k</span> <span class="free">Sts</span><span class="main">)</span> <span class="bound">k'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> k_p lnth_ldrop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="main">_</span> <span class="quoted"><span class="free">Sts</span></span><span class="main">]</span> inf inff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Ci_inn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈#</span> <span class="main">(</span>wP_of_wstate<span class="main">)</span> <span class="main">(</span>lnth <span class="main">(</span>ldrop <span class="skolem">k</span> <span class="free">Sts</span><span class="main">)</span> <span class="bound">k'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span> <span class="main">(</span>ldrop <span class="skolem">k</span> <span class="free">Sts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> deriv inf_chain_ldropn_chain inf inff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_chain_ldropn_chain ldrop_enat<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> RP_combined_relation<span class="main">)</span><span class="main">¯¯</span>
      <span class="main">(</span>lmap <span class="main">(</span>RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ldrop <span class="skolem">k</span> <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inff inf Ci_in weighted_RP_measure_decreasing_P
        infinite_chain_relation_measure<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">St</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈#</span> wP_of_wstate <span class="bound">St</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span>"</span></span>
          <span class="quoted"><span class="quoted">"RP_combined_measure <span class="main">(</span><span class="free">weight</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> wfP_iff_no_infinite_down_chain_llist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> RP_combined_relation"</span></span><span class="main">]</span>
        wf_RP_combined_relation inff
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> inf_llist_lnth ldrop_enat_inf_llist lfinite_inf_llist lfinite_lmap wfPUNIVI
          wf_induct_rule<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> weighted_RP_saturated<span class="main">:</span> <span class="quoted"><span class="quoted">"src.saturated_upto <span class="main">(</span>Liminf_llist <span class="main">(</span>lmap grounding_of_wstate <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> RP_saturated_if_fair<span class="main">[</span><span class="operator">OF</span> deriv_RP weighted_RP_fair empty_Q0_RP<span class="main">,</span> <span class="operator">unfolded</span> llist.map_comp<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> weighted_RP_complete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="main">(</span>grounding_of_wstate <span class="main">(</span>lhd <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">{#}</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>Liminf_wstate <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> RP_complete_if_fair<span class="main">[</span><span class="operator">OF</span> deriv_RP weighted_RP_fair empty_Q0_RP<span class="main">,</span> <span class="operator">simplified</span> lhd_lmap_Sts<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> weighted_FO_resolution_prover_with_size_timestamp_factors <span class="main">=</span>
  FO_resolution_prover <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">subst_atm</span></span> <span class="quoted"><span class="free">id_subst</span></span> <span class="quoted"><span class="free">comp_subst</span></span> <span class="quoted"><span class="free">renamings_apart</span></span> <span class="quoted"><span class="free">atm_of_atms</span></span> <span class="quoted"><span class="free">mgu</span></span> <span class="quoted"><span class="free">less_atm</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wellorder<span class="main">)</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">subst_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">id_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">comp_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">renamings_apart</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal multiset list <span class="main">⇒</span> <span class="tfree">'s</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">atm_of_atms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">mgu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'s</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">less_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">size_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">size_factor</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">timestamp_factor</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    timestamp_factor_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">timestamp_factor</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">weight</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wclause <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">weight</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size_factor</span> <span class="main">*</span> size_multiset <span class="main">(</span>size_literal <span class="free">size_atm</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">+</span> <span class="free">timestamp_factor</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weight_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> weight <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> weight <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> timestamp_factor_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> weight.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">sublocale</span></span> wrp<span class="main">:</span> weighted_FO_resolution_prover _ _ _ _ _ _ _ _ <span class="quoted">weight</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">rule</span> weight_mono<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> wrp.weighted_RP <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span>"</span> 50<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Deterministic_FO_Ordered_Resolution_Prover">
<div class="head">
<h1>Theory Deterministic_FO_Ordered_Resolution_Prover</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       A Deterministic Ordered Resolution Prover for First-Order Clauses
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2017
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2018
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A Deterministic Ordered Resolution Prover for First-Order Clauses›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>deterministic_RP›</span></span></span></span> prover introduced below is a deterministic program that works on finite
lists, committing to a strategy for assigning priorities to clauses. However, it is not fully
executable: It abstracts over operations on atoms and employs logical specifications instead of
executable functions for auxiliary notions.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Deterministic_FO_Ordered_Resolution_Prover
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../Polynomial_Factorization/Missing_List.html">Polynomial_Factorization.Missing_List</a>
    <a href="Weighted_FO_Ordered_Resolution_Prover.html">Weighted_FO_Ordered_Resolution_Prover</a>
    <a href="../Lambda_Free_RPOs/Lambda_Free_Util.html">Lambda_Free_RPOs.Lambda_Free_Util</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Library›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> apfst_fst_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"apfst <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span><span class="main">,</span> snd <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> apfst_conv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> prod.collapse<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> apfst_comp_rpair_const<span class="main">:</span> <span class="quoted"><span class="quoted">"apfst <span class="free">f</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>

<span class="comment1">(* TODO: Move to Isabelle's "List.thy"? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> length_remove1_less<span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> length <span class="main">(</span>remove1 <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_filter_neq_eq_filter_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="bound">z</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_map_remdups_gen<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>remdups_gen <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>remdups_gen <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> remdups_gen.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_filter_neq_eq_filter_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_remdups_gen_ident<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>remdups_gen <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> mset <span class="main">(</span>remdups_gen <span class="skolem">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> remdups_gen.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> f <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f remdups_gen.simps ih<span class="main">[</span><span class="operator">OF</span> f<span class="main">,</span> <span class="operator">unfolded</span> f<span class="main">]</span> mset.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_set list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> mset_set.insert_remove removeAll_filter_not_eq
          remove_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> remove_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Move to Isabelle? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> funpow_fixpoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_imp_eq_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtranclp.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> tranclp_imp_eq_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> tranclp.induct<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Prover›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> lclause <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> dclause <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause <span class="main">×</span> nat"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> dstate <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dclause list <span class="main">×</span> <span class="tfree">'a</span> dclause list <span class="main">×</span> <span class="tfree">'a</span> dclause list <span class="main">×</span> nat"</span></span>

<span class="keyword1"><span class="command">locale</span></span> deterministic_FO_resolution_prover <span class="main">=</span>
  weighted_FO_resolution_prover_with_size_timestamp_factors <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">subst_atm</span></span> <span class="quoted"><span class="free">id_subst</span></span> <span class="quoted"><span class="free">comp_subst</span></span>
    <span class="quoted"><span class="free">renamings_apart</span></span> <span class="quoted"><span class="free">atm_of_atms</span></span> <span class="quoted"><span class="free">mgu</span></span> <span class="quoted"><span class="free">less_atm</span></span> <span class="quoted"><span class="free">size_atm</span></span> <span class="quoted"><span class="free">timestamp_factor</span></span> <span class="quoted"><span class="free">size_factor</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wellorder<span class="main">)</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">subst_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">id_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">comp_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">renamings_apart</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal multiset list <span class="main">⇒</span> <span class="tfree">'s</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">atm_of_atms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">mgu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'s</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">less_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">size_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">timestamp_factor</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">size_factor</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    S_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_atm_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">less_atm</span> <span class="free">A</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ex_ground_subst less_atm_ground less_atm_stable <span class="keyword1"><span class="command">unfolding</span></span> is_ground_subst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wstate_of_dstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dstate <span class="main">⇒</span> <span class="tfree">'a</span> wstate"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wstate_of_dstate</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span>mset <span class="main">(</span>map <span class="main">(</span>apfst mset<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">,</span> mset <span class="main">(</span>map <span class="main">(</span>apfst mset<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">,</span> mset <span class="main">(</span>map <span class="main">(</span>apfst mset<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">state_of_dstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dstate <span class="main">⇒</span> <span class="tfree">'a</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">state_of_dstate</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>mset <span class="main">∘</span> fst<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">,</span> set <span class="main">(</span>map <span class="main">(</span>mset <span class="main">∘</span> fst<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">,</span> set <span class="main">(</span>map <span class="main">(</span>mset <span class="main">∘</span> fst<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">clss_of_dstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dstate <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clss_of_dstate</span> <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">≡</span> clss_of_state <span class="main">(</span>state_of_dstate <span class="free"><span class="bound"><span class="entity">St</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_final_dstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dstate <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_final_dstate</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> is_final_dstate.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rtrancl_weighted_RP</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup>)</span></span> <span class="main">≡</span> <span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trancl_weighted_RP</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>+</sup></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>+</sup>)</span></span> <span class="main">≡</span> <span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_tautology</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_tautology</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="main">∈</span> set <span class="main">(</span>map atm_of <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">.</span> Pos <span class="bound">A</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∧</span> Neg <span class="bound">A</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subsume</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause list <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subsume</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">D</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">Ds</span></span></span><span class="main">.</span> subsumes <span class="main">(</span>mset <span class="bound">D</span><span class="main">)</span> <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strictly_subsume</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause list <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strictly_subsume</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">D</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">Ds</span></span></span><span class="main">.</span> strictly_subsumes <span class="main">(</span>mset <span class="bound">D</span><span class="main">)</span> <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_reducible_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> literal <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_reducible_on</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟷</span> subsumes <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">-</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">#}</span><span class="main">)</span> <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">#}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_reducible_lit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause list <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> literal <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_reducible_lit</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">⟷</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">D</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">Ds</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">L'</span> <span class="main">∈</span> set <span class="bound">D</span><span class="main">.</span> <span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="bound">L'</span> <span class="keyword1">⋅l</span> <span class="bound">σ</span> <span class="main">∧</span> mset <span class="main">(</span>remove1 <span class="bound">L'</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">⊆#</span> mset <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">reduce</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause list <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reduce</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">reduce</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> is_reducible_lit <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">then</span> <span class="free">reduce</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">C'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">#</span> <span class="free">reduce</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">is_irreducible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause list <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_irreducible</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≡</span> reduce <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">is_reducible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause list <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_reducible</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≡</span> reduce <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reduce_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> dclause list <span class="main">⇒</span> <span class="tfree">'a</span> dclause list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reduce_all</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> map <span class="main">(</span>apfst <span class="main">(</span>reduce <span class="main">[</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">]</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">reduce_all2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> dclause list <span class="main">⇒</span> <span class="tfree">'a</span> dclause list <span class="main">×</span> <span class="tfree">'a</span> dclause list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reduce_all2</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">reduce_all2</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ci</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span>
      <span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ci</span></span></span><span class="main">;</span>
      <span class="bound">C'</span> <span class="main">=</span> reduce <span class="main">[</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">]</span> <span class="main">[]</span> <span class="bound">C</span>
    <span class="keyword1">in</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="bound">C'</span> <span class="main">=</span> <span class="bound">C</span> <span class="keyword1">then</span> apsnd <span class="keyword1">else</span> apfst<span class="main">)</span> <span class="main">(</span>Cons <span class="main">(</span><span class="bound">C'</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">reduce_all2</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_all</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remove_all</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> <span class="free">remove_all</span> <span class="main">(</span>remove1 <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">else</span> <span class="free">remove_all</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove_all_mset_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">ys</span> <span class="main">⊆#</span> mset <span class="free">xs</span> <span class="main">⟹</span> mset <span class="main">(</span>remove_all <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">-</span> mset <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> y_in<span class="main">:</span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subs<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">ys</span> <span class="main">⊆#</span> mset <span class="main">(</span>remove1 <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_subset_eq_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> y_in Cons subs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">resolvent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span><span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">resolvent</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">CA</span></span></span> <span class="free"><span class="bound"><span class="entity">Ls</span></span></span> <span class="main">=</span>
   map <span class="main">(</span><span class="main">λ</span><span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="keyword1">⋅l</span> <span class="main">(</span>the <span class="main">(</span><span class="free">mgu</span> <span class="main">{</span>insert <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>atms_of <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">Ls</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>remove_all <span class="free"><span class="bound"><span class="entity">CA</span></span></span> <span class="free"><span class="bound"><span class="entity">Ls</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">resolvable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">resolvable</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">CA</span></span></span> <span class="free"><span class="bound"><span class="entity">Ls</span></span></span> <span class="main">⟷</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">σ</span> <span class="main">=</span> <span class="main">(</span><span class="free">mgu</span> <span class="main">{</span>insert <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>atms_of <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">Ls</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="bound">σ</span> <span class="main">≠</span> None
      <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Ls</span></span></span> <span class="main">≠</span> <span class="main">[]</span>
      <span class="main">∧</span> maximal_wrt <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">⋅a</span> the <span class="bound">σ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>add_mset <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> the <span class="bound">σ</span><span class="main">)</span>
      <span class="main">∧</span> strictly_maximal_wrt <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">⋅a</span> the <span class="bound">σ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">CA</span></span></span> <span class="main">-</span> mset <span class="free"><span class="bound"><span class="entity">Ls</span></span></span><span class="main">)</span> <span class="main">⋅</span> the <span class="bound">σ</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">L</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">Ls</span></span></span><span class="main">.</span> is_pos <span class="bound">L</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">resolve_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">resolve_on</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">CA</span></span></span> <span class="main">=</span> map <span class="main">(</span>resolvent <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">CA</span></span></span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span>resolvable <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">CA</span></span></span><span class="main">)</span> <span class="main">(</span>subseqs <span class="free"><span class="bound"><span class="entity">CA</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">resolve</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">resolve</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span>
   concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span>
     <span class="main">(</span><span class="keyword1">case</span> <span class="bound">L</span> <span class="keyword1">of</span>
        Pos <span class="bound">A</span> <span class="main">⇒</span> <span class="main">[]</span>
      <span class="main">|</span> Neg <span class="bound">A</span> <span class="main">⇒</span>
        <span class="keyword1">if</span> maximal_wrt <span class="bound">A</span> <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
          resolve_on <span class="bound">A</span> <span class="main">(</span>remove1 <span class="bound">L</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>
        <span class="keyword1">else</span>
          <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">resolve_rename</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">resolve_rename</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">σs</span> <span class="main">=</span> <span class="free">renamings_apart</span> <span class="main">[</span>mset <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span> mset <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">]</span> <span class="keyword1">in</span>
      resolve <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> last <span class="bound">σs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> hd <span class="bound">σs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">resolve_rename_either_way</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause <span class="main">⇒</span> <span class="tfree">'a</span> lclause list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">resolve_rename_either_way</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> resolve_rename <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">@</span> resolve_rename <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">select_min_weight_clause</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dclause <span class="main">⇒</span> <span class="tfree">'a</span> dclause list <span class="main">⇒</span> <span class="tfree">'a</span> dclause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">select_min_weight_clause</span> <span class="free"><span class="bound"><span class="entity">Ci</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ci</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">select_min_weight_clause</span> <span class="free"><span class="bound"><span class="entity">Ci</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Dj</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Djs</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="free">select_min_weight_clause</span>
     <span class="main">(</span><span class="keyword1">if</span> weight <span class="main">(</span>apfst mset <span class="free"><span class="bound"><span class="entity">Dj</span></span></span><span class="main">)</span> <span class="main">&lt;</span> weight <span class="main">(</span>apfst mset <span class="free"><span class="bound"><span class="entity">Ci</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">Dj</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">Ci</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Djs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> select_min_weight_clause_in<span class="main">:</span> <span class="quoted"><span class="quoted">"select_min_weight_clause <span class="free">P0</span> <span class="free">P</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">P0</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P0</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">remdups_clss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dclause list <span class="main">⇒</span> <span class="tfree">'a</span> dclause list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remdups_clss</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remdups_clss</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ci</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Cis</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span>
      <span class="bound">Ci'</span> <span class="main">=</span> select_min_weight_clause <span class="free"><span class="bound"><span class="entity">Ci</span></span></span> <span class="free"><span class="bound"><span class="entity">Cis</span></span></span>
    <span class="keyword1">in</span>
      <span class="bound">Ci'</span> <span class="main">#</span> <span class="free">remdups_clss</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mset <span class="bound">D</span> <span class="main">≠</span> mset <span class="main">(</span>fst <span class="bound">Ci'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ci</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Cis</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">termination</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure length"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> in_measure length_filter_less prod.case_eq_if select_min_weight_clause_in<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> remdups_clss.simps<span class="main">(</span>2<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">deterministic_RP_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dstate <span class="main">⇒</span> <span class="tfree">'a</span> dstate"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deterministic_RP_step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">Ci</span> <span class="main">∈</span> set <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">.</span> fst <span class="bound">Ci</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> remdups_clss <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> length <span class="main">(</span>remdups_clss <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="keyword1">of</span>
        <span class="main">[]</span> <span class="main">⇒</span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">of</span>
           <span class="main">[]</span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
         <span class="main">|</span> <span class="bound">P0</span> <span class="main">#</span> <span class="bound">P'</span> <span class="main">⇒</span>
           <span class="keyword1">let</span>
             <span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> select_min_weight_clause <span class="bound">P0</span> <span class="bound">P'</span><span class="main">;</span>
             <span class="bound">N</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>remdups_gen mset <span class="main">(</span>resolve_rename <span class="bound">C</span> <span class="bound">C</span>
               <span class="main">@</span> concat <span class="main">(</span>map <span class="main">(</span>resolve_rename_either_way <span class="bound">C</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
             <span class="bound">P</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> mset <span class="bound">D</span> <span class="main">≠</span> mset <span class="bound">C</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">;</span>
             <span class="bound">Q</span> <span class="main">=</span> <span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">;</span>
             <span class="bound">n</span> <span class="main">=</span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span>
           <span class="keyword1">in</span>
             <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">P</span><span class="main">,</span> <span class="bound">Q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">#</span> <span class="bound">N</span> <span class="main">⇒</span>
        <span class="keyword1">let</span>
          <span class="bound">C</span> <span class="main">=</span> reduce <span class="main">(</span>map fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="bound">C</span>
        <span class="keyword1">in</span>
          <span class="keyword1">if</span> <span class="bound">C</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
            <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
          <span class="keyword1">else</span> <span class="keyword1">if</span> is_tautology <span class="bound">C</span> <span class="main">∨</span> subsume <span class="main">(</span>map fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">C</span> <span class="keyword1">then</span>
            <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
          <span class="keyword1">else</span>
            <span class="keyword1">let</span>
              <span class="bound">P</span> <span class="main">=</span> reduce_all <span class="bound">C</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">;</span>
              <span class="main">(</span><span class="bound">back_to_P</span><span class="main">,</span> <span class="bound">Q</span><span class="main">)</span> <span class="main">=</span> reduce_all2 <span class="bound">C</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">;</span>
              <span class="bound">P</span> <span class="main">=</span> <span class="bound">back_to_P</span> <span class="main">@</span> <span class="bound">P</span><span class="main">;</span>
              <span class="bound">Q</span> <span class="main">=</span> filter <span class="main">(</span>Not <span class="main">∘</span> strictly_subsume <span class="main">[</span><span class="bound">C</span><span class="main">]</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="bound">Q</span><span class="main">;</span>
              <span class="bound">P</span> <span class="main">=</span> filter <span class="main">(</span>Not <span class="main">∘</span> strictly_subsume <span class="main">[</span><span class="bound">C</span><span class="main">]</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="bound">P</span><span class="main">;</span>
              <span class="bound">P</span> <span class="main">=</span> <span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">#</span> <span class="bound">P</span>
            <span class="keyword1">in</span>
              <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">P</span><span class="main">,</span> <span class="bound">Q</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> deterministic_RP_step.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>option<span class="main">)</span> <span class="entity">deterministic_RP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dstate <span class="main">⇒</span> <span class="tfree">'a</span> lclause list option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deterministic_RP</span> <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> is_final_dstate <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="keyword1">then</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">Q</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="keyword1">in</span> Some <span class="main">(</span>map fst <span class="bound">Q</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="free">deterministic_RP</span> <span class="main">(</span>deterministic_RP_step <span class="free"><span class="bound"><span class="entity">St</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_final_dstate_imp_not_weighted_RP<span class="main">:</span> <span class="quoted"><span class="quoted">"is_final_dstate <span class="free">St</span> <span class="main">⟹</span> <span class="main">¬</span> wstate_of_dstate <span class="free">St</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">St'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wrp.final_weighted_RP
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">St</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wrp.final_weighted_RP <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_final_dstate.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_final_dstate_funpow_imp_deterministic_RP_neq_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_final_dstate <span class="main">(</span><span class="main">(</span>deterministic_RP_step <span class="main">^^</span> <span class="free">k</span><span class="main">)</span> <span class="free">St</span><span class="main">)</span> <span class="main">⟹</span> deterministic_RP <span class="free">St</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">St</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> final_Sk <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">unfolded</span> funpow_swap1<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> final_Sk<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> deterministic_RP.simps<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> deterministic_RP.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_reducible_lit_mono_cls<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="free">C</span> <span class="main">⊆#</span> mset <span class="free">C'</span> <span class="main">⟹</span> is_reducible_lit <span class="free">Ds</span> <span class="free">C</span> <span class="free">L</span> <span class="main">⟹</span> is_reducible_lit <span class="free">Ds</span> <span class="free">C'</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_reducible_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_mset.order.trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_reducible_lit_mset_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="free">C</span> <span class="main">=</span> mset <span class="free">C'</span> <span class="main">⟹</span> is_reducible_lit <span class="free">Ds</span> <span class="free">C'</span> <span class="free">L</span> <span class="main">⟷</span> is_reducible_lit <span class="free">Ds</span> <span class="free">C</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_reducible_lit_mono_cls subset_mset.order_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_reducible_lit_remove1_Cons_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈</span> set <span class="free">C'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_reducible_lit <span class="free">Ds</span> <span class="main">(</span><span class="free">C</span> <span class="main">@</span> remove1 <span class="free">L</span> <span class="main">(</span><span class="free">M</span> <span class="main">#</span> <span class="free">C'</span><span class="main">)</span><span class="main">)</span> <span class="free">L</span> <span class="main">⟷</span>
    is_reducible_lit <span class="free">Ds</span> <span class="main">(</span><span class="free">M</span> <span class="main">#</span> <span class="free">C</span> <span class="main">@</span> remove1 <span class="free">L</span> <span class="free">C'</span><span class="main">)</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> is_reducible_lit_mset_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reduce_mset_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">C</span> <span class="main">=</span> mset <span class="free">C'</span> <span class="main">⟹</span> reduce <span class="free">Ds</span> <span class="free">C</span> <span class="free">E</span> <span class="main">=</span> reduce <span class="free">Ds</span> <span class="free">C'</span> <span class="free">E</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">E</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">C'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">L</span> <span class="skolem">E</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> mset_eq <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>
    mset_lc_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="skolem">L</span> <span class="main">#</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span><span class="skolem">L</span> <span class="main">#</span> <span class="skolem">C'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    mset_ce_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="skolem">C</span> <span class="main">@</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span><span class="skolem">C'</span> <span class="main">@</span> <span class="skolem">E</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mset_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> mset_eq<span class="main">]</span> ih<span class="main">[</span><span class="operator">OF</span> mset_lc_eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_reducible_lit_mset_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mset_ce_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> reduce_rotate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reduce <span class="free">Ds</span> <span class="main">(</span><span class="free">C</span> <span class="main">@</span> <span class="main">[</span><span class="free">L</span><span class="main">]</span><span class="main">)</span> <span class="free">E</span> <span class="main">=</span> reduce <span class="free">Ds</span> <span class="main">(</span><span class="free">L</span> <span class="main">#</span> <span class="free">C</span><span class="main">)</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reduce_mset_eq<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_reduce_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>reduce <span class="free">Ds</span> <span class="free">C</span> <span class="free">E</span><span class="main">)</span> <span class="main">⊆#</span> mset <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">E</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_mset_imp_subset_add_mset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reduce_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"reduce <span class="free">Ds</span> <span class="free">C</span> <span class="main">(</span>reduce <span class="free">Ds</span> <span class="free">C</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> reduce <span class="free">Ds</span> <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">E</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_reduce_subset
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_reducible_lit_mono_cls<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">@</span> reduce <span class="free">Ds</span> <span class="main">(</span><span class="skolem">L</span> <span class="main">#</span> <span class="skolem">C</span><span class="main">)</span> <span class="skolem">E</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">@</span> <span class="skolem">E</span>"</span></span> <span class="quoted"><span class="free">Ds</span></span> <span class="quoted"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">L</span> <span class="skolem">E</span> <span class="skolem">C</span><span class="main"><span class="main">,</span></span>
        <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_reducible_lit_imp_is_reducible<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈</span> set <span class="free">C'</span> <span class="main">⟹</span> is_reducible_lit <span class="free">Ds</span> <span class="main">(</span><span class="free">C</span> <span class="main">@</span> remove1 <span class="free">L</span> <span class="free">C'</span><span class="main">)</span> <span class="free">L</span> <span class="main">⟹</span> reduce <span class="free">Ds</span> <span class="free">C</span> <span class="free">C'</span> <span class="main">≠</span> <span class="free">C'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">M</span> <span class="skolem">C'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> l_in <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> l_red <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_reducible_lit <span class="free">Ds</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">@</span> <span class="skolem">C'</span><span class="main">)</span> <span class="skolem">M</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> mset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mset_reduce_subset multi_self_add_other_not_self
          subset_mset.eq_iff subset_mset_imp_subset_add_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> m_irred<span class="main">:</span> False
    <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈</span> set <span class="skolem">C'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"is_reducible_lit <span class="free">Ds</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">#</span> <span class="skolem">C</span> <span class="main">@</span> remove1 <span class="free">L</span> <span class="skolem">C'</span><span class="main">)</span> <span class="free">L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_in l_red m_irred is_reducible_lit_remove1_Cons_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">#</span> <span class="skolem">C</span>"</span></span><span class="main"><span class="main">]</span></span> m_irred<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> is_reducible_imp_is_reducible_lit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reduce <span class="free">Ds</span> <span class="free">C</span> <span class="free">C'</span> <span class="main">≠</span> <span class="free">C'</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">L</span> <span class="main">∈</span> set <span class="free">C'</span><span class="main">.</span> is_reducible_lit <span class="free">Ds</span> <span class="main">(</span><span class="free">C</span> <span class="main">@</span> remove1 <span class="bound">L</span> <span class="free">C'</span><span class="main">)</span> <span class="bound">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">M</span> <span class="skolem">C'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> mc'_red <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_reducible_lit <span class="free">Ds</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">@</span> <span class="skolem">C'</span><span class="main">)</span> <span class="skolem">M</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> m_irred<span class="main">:</span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">#</span> <span class="skolem">C</span>"</span></span><span class="main">]</span> mc'_red<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">simplified</span> m_irred<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> m_irred
        is_reducible_lit_remove1_Cons_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> is_irreducible_iff_nexists_is_reducible_lit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reduce <span class="free">Ds</span> <span class="free">C</span> <span class="free">C'</span> <span class="main">=</span> <span class="free">C'</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span> <span class="main">∈</span> set <span class="free">C'</span><span class="main">.</span> is_reducible_lit <span class="free">Ds</span> <span class="main">(</span><span class="free">C</span> <span class="main">@</span> remove1 <span class="bound">L</span> <span class="free">C'</span><span class="main">)</span> <span class="bound">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_reducible_imp_is_reducible_lit is_reducible_lit_imp_is_reducible <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_irreducible_mset_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">E</span> <span class="main">=</span> mset <span class="free">E'</span> <span class="main">⟹</span> reduce <span class="free">Ds</span> <span class="free">C</span> <span class="free">E</span> <span class="main">=</span> <span class="free">E</span> <span class="main">⟷</span> reduce <span class="free">Ds</span> <span class="free">C</span> <span class="free">E'</span> <span class="main">=</span> <span class="free">E'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_irreducible_iff_nexists_is_reducible_lit
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> is_reducible_lit_mset_iff mset_remove1 set_mset_mset union_code<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> select_min_weight_clause_min_weight<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ci</span> <span class="main">=</span> select_min_weight_clause <span class="free">P0</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span>apfst mset <span class="free">Ci</span><span class="main">)</span> <span class="main">=</span> Min <span class="main">(</span><span class="main">(</span>weight <span class="main">∘</span> apfst mset<span class="main">)</span> <span class="main">`</span> set <span class="main">(</span><span class="free">P0</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P0</span></span> <span class="quoted"><span class="free">Ci</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">P1</span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ci <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span>apfst mset <span class="skolem">P1</span><span class="main">)</span> <span class="main">&lt;</span> weight <span class="main">(</span>apfst mset <span class="skolem">P0</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> min<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span><span class="main">(</span>weight <span class="main">∘</span> apfst mset<span class="main">)</span> <span class="main">`</span> set <span class="main">(</span><span class="skolem">P0</span> <span class="main">#</span> <span class="skolem">P1</span> <span class="main">#</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      Min <span class="main">(</span><span class="main">(</span>weight <span class="main">∘</span> apfst mset<span class="main">)</span> <span class="main">`</span> set <span class="main">(</span><span class="skolem">P1</span> <span class="main">#</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> min <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Ci</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">Ci</span></span> <span class="quoted"><span class="skolem">P1</span></span><span class="main"><span class="main">]</span></span> ci True<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span><span class="main">(</span>weight <span class="main">∘</span> apfst mset<span class="main">)</span> <span class="main">`</span> set <span class="main">(</span><span class="skolem">P0</span> <span class="main">#</span> <span class="skolem">P1</span> <span class="main">#</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      Min <span class="main">(</span><span class="main">(</span>weight <span class="main">∘</span> apfst mset<span class="main">)</span> <span class="main">`</span> set <span class="main">(</span><span class="skolem">P1</span> <span class="main">#</span> <span class="skolem">P0</span> <span class="main">#</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">Min</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> min<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span><span class="main">(</span>weight <span class="main">∘</span> apfst mset<span class="main">)</span> <span class="main">`</span> set <span class="main">(</span><span class="skolem">P0</span> <span class="main">#</span> <span class="skolem">P1</span> <span class="main">#</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      Min <span class="main">(</span><span class="main">(</span>weight <span class="main">∘</span> apfst mset<span class="main">)</span> <span class="main">`</span> set <span class="main">(</span><span class="skolem">P0</span> <span class="main">#</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> False eq_iff <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> min <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Ci</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">Ci</span></span> <span class="quoted"><span class="skolem">P1</span></span><span class="main"><span class="main">]</span></span> ci False<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> remdups_clss_Nil_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"remdups_clss <span class="free">Cs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">Cs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Cs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">hypsubst</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> remdups_clss.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_N_if_Nil_in_P_or_Q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nil_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span><span class="free">P</span> <span class="main">@</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> ih<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">N0</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="skolem">N0</span> <span class="main">#</span> <span class="skolem">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> wstate_of_dstate <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
          wrp.forward_subsumption<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="free"><span class="free"><span class="free">P</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="free"><span class="free"><span class="free">Q</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span>
            <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>fst <span class="skolem"><span class="skolem"><span class="skolem">N0</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">N</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="skolem"><span class="skolem"><span class="skolem">N0</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">use</span> nil_in <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main">:</span> image_def apfst_fst_snd›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> remove_strictly_subsumed_clauses_in_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    c_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p_nsubs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">P</span><span class="main">.</span> <span class="main">¬</span> strictly_subsume <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="bound">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span> <span class="main">@</span> <span class="free">P'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>
    <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span> <span class="main">@</span> filter <span class="main">(</span>Not <span class="main">∘</span> strictly_subsume <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="free">P'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p_nsubs
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">P'</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> p_nsubs <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">P'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Suc

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Dj</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> hd <span class="skolem">P'</span> <span class="main">#</span> tl <span class="skolem">P'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Suc_conv list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.exhaust_sel<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"strictly_subsume <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">(</span>fst <span class="var">?Dj</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> subs<span class="main">:</span> True

      <span class="keyword1"><span class="command">have</span></span> p_filtered<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> image_mset <span class="main">(</span>apfst mset<span class="main">)</span> <span class="main">(</span>mset <span class="skolem">P</span><span class="main">)</span><span class="main">.</span> <span class="bound">E</span> <span class="main">≠</span> mset <span class="main">(</span>fst <span class="var">?Dj</span><span class="main">)</span><span class="main">#}</span> <span class="main">=</span>
        image_mset <span class="main">(</span>apfst mset<span class="main">)</span> <span class="main">(</span>mset <span class="skolem">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filter_mset_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> True"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
            <span class="operator">use</span> subs p_nsubs <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> strictly_subsume_def›</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> image_mset <span class="main">(</span>apfst mset<span class="main">)</span> <span class="main">(</span>mset <span class="skolem">P'</span><span class="main">)</span><span class="main">.</span> <span class="bound">E</span> <span class="main">≠</span> mset <span class="main">(</span>fst <span class="var">?Dj</span><span class="main">)</span><span class="main">#}</span> <span class="main">=</span>
        <span class="main">{#</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> image_mset <span class="main">(</span>apfst mset<span class="main">)</span> <span class="main">(</span>mset <span class="var">?P''</span><span class="main">)</span><span class="main">.</span> <span class="bound">E</span> <span class="main">≠</span> mset <span class="main">(</span>fst <span class="var">?Dj</span><span class="main">)</span><span class="main">#}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> p'<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        image_mset <span class="main">(</span>apfst mset<span class="main">)</span> <span class="main">(</span>mset <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> mset <span class="bound">E</span> <span class="main">≠</span> mset <span class="main">(</span>fst <span class="var">?Dj</span><span class="main">)</span><span class="main">)</span> <span class="var">?P''</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_mset_filter_swap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> case_prod_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> p'_filtered<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈#</span> image_mset <span class="main">(</span>apfst mset<span class="main">)</span> <span class="main">(</span>mset <span class="skolem">P'</span><span class="main">)</span><span class="main">.</span> <span class="bound">E</span> <span class="main">≠</span> mset <span class="main">(</span>fst <span class="var">?Dj</span><span class="main">)</span><span class="main">#}</span> <span class="main">=</span>
        image_mset <span class="main">(</span>apfst mset<span class="main">)</span> <span class="main">(</span>mset <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> mset <span class="bound">E</span> <span class="main">≠</span> mset <span class="main">(</span>fst <span class="var">?Dj</span><span class="main">)</span><span class="main">)</span> <span class="var">?P''</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">.</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">@</span> <span class="skolem">P'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>
        <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> mset <span class="bound">E</span> <span class="main">≠</span> mset <span class="main">(</span>fst <span class="var">?Dj</span><span class="main">)</span><span class="main">)</span> <span class="var">?P''</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
              wrp.backward_subsumption_P<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="free"><span class="free"><span class="free">C</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="free"><span class="free"><span class="free">N</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>fst <span class="var"><span class="var"><span class="var">?Dj</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span>
                <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">P</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">P'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="free"><span class="free"><span class="free">Q</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">use</span> c_in subs <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> p_filtered p'_filtered arg_cong<span class="main">[</span><span class="operator">OF</span> p'<span class="main">,</span> <span class="operator">of</span> <span class="quoted">set</span><span class="main">]</span>
            strictly_subsume_def›</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>
        <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">@</span> filter <span class="main">(</span>Not <span class="main">∘</span> strictly_subsume <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">P'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup>)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
              ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"filter <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">E</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">l</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> mset <span class="bound"><span class="bound">E</span></span> <span class="main"><span class="main">≠</span></span> mset <span class="main"><span class="main">(</span></span>fst <span class="var"><span class="var">?Dj</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="var"><span class="var">?P''</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> p'<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> subs
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> image_mset <span class="main"><span class="main">(</span></span>apfst mset<span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> strictly_subsume_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> p'<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> list.size<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> less_Suc0 less_add_same_cancel1 linorder_neqE_nat
            not_add_less1 sum_length_filter_compl trans_less_add1<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> p_nsubs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> nsubs<span class="main">:</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup>)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
              ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P''</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">P</span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">[</span></span><span class="var"><span class="var">?Dj</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> nsubs p_nsubs
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p'<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted">mset</span><span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p'<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"filter <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">f</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> p'<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove_strictly_subsumed_clauses_in_Q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> c_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span> <span class="main">@</span> <span class="free">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>
    <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span> <span class="main">@</span> filter <span class="main">(</span>Not <span class="main">∘</span> strictly_subsume <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="free">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> ih<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">Dj</span> <span class="skolem">Q'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="skolem">Q</span> <span class="main">@</span> <span class="skolem">Dj</span> <span class="main">#</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span>
    wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="skolem">Q</span> <span class="main">@</span> filter <span class="main">(</span>Not <span class="main">∘</span> strictly_subsume <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="main">[</span><span class="skolem">Dj</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"strictly_subsume <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">(</span>fst <span class="skolem">Dj</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> subs<span class="main">:</span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="skolem">Q</span> <span class="main">@</span> <span class="skolem">Dj</span> <span class="main">#</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="skolem">Q</span> <span class="main">@</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
            wrp.backward_subsumption_Q<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="free"><span class="free"><span class="free">C</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="free"><span class="free"><span class="free">N</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>fst <span class="skolem"><span class="skolem"><span class="skolem">Dj</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span>
              <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="free"><span class="free"><span class="free">P</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">Q</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Q'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="skolem"><span class="skolem"><span class="skolem">Dj</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">use</span> c_in subs <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> apfst_fst_snd strictly_subsume_def›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">@</span> filter <span class="main">(</span>Not <span class="main">∘</span> strictly_subsume <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="main">[</span><span class="skolem">Dj</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> reduce_clause_in_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    c_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p_irred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">P</span> <span class="main">@</span> <span class="free">P'</span><span class="main">)</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="free">j</span> <span class="main">⟶</span> is_irreducible <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="bound">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span> <span class="main">@</span> <span class="main">(</span><span class="free">D</span> <span class="main">@</span> <span class="free">D'</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">P'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>
    <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span> <span class="main">@</span> <span class="main">(</span><span class="free">D</span> <span class="main">@</span> reduce <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="free">D</span> <span class="free">D'</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">P'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> ih<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">L</span> <span class="skolem">D'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_reducible_lit <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="skolem">D'</span><span class="main">)</span> <span class="skolem">L</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> l_red<span class="main">:</span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
      l'_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">∈</span> set <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      not_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">L</span> <span class="main">=</span> <span class="skolem">L'</span> <span class="keyword1">⋅l</span> <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      subs<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>remove1 <span class="skolem">L'</span> <span class="free">C</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⊆#</span> mset <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="skolem">D'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_reducible_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1"><span class="command">have</span></span> ldd'_red<span class="main">:</span> <span class="quoted"><span class="quoted">"is_reducible <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">(</span><span class="skolem">L</span> <span class="main">#</span> <span class="skolem">D</span> <span class="main">@</span> <span class="skolem">D'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_reducible_lit_imp_is_reducible<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> l_red <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> lt_imp_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">P</span> <span class="main">@</span> <span class="free">P'</span><span class="main">)</span><span class="main">.</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">⟶</span> mset <span class="bound">E</span> <span class="main">≠</span> mset <span class="main">(</span><span class="skolem">L</span> <span class="main">#</span> <span class="skolem">D</span> <span class="main">@</span> <span class="skolem">D'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_irred ldd'_red is_irreducible_mset_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="skolem">L</span> <span class="main">#</span> <span class="skolem">D'</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">P'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>
      <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="skolem">D'</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">P'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
            wrp.backward_reduction_P<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="free"><span class="free">C</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">{#</span></span><span class="skolem"><span class="skolem">L'</span></span><span class="main"><span class="main">#}</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">L'</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main">(</span></span>map <span class="main"><span class="main">(</span></span>apfst mset<span class="main"><span class="main">)</span></span> <span class="free"><span class="free">N</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">L</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ</span></span></span></span>
              <span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">D</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">D'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main">(</span></span>map <span class="main"><span class="main">(</span></span>apfst mset<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">P</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">P'</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main">(</span></span>map <span class="main"><span class="main">(</span></span>apfst mset<span class="main"><span class="main">)</span></span> <span class="free"><span class="free">Q</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> l'_in not_l subs c_in lt_imp_neq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span> l_red <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">L</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> reduce_clause_in_Q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    c_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p_irred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">P</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="free">j</span> <span class="main">⟶</span> is_irreducible <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="bound">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d'_red<span class="main">:</span> <span class="quoted"><span class="quoted">"reduce <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="free">D</span> <span class="free">D'</span> <span class="main">≠</span> <span class="free">D'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span> <span class="main">@</span> <span class="main">(</span><span class="free">D</span> <span class="main">@</span> <span class="free">D'</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>
    <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="main">(</span><span class="free">D</span> <span class="main">@</span> reduce <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="free">D</span> <span class="free">D'</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span> <span class="main">@</span> <span class="free">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> d'_red
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">L</span> <span class="skolem">D'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ld'_red <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_reducible_lit <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="skolem">D'</span><span class="main">)</span> <span class="skolem">L</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> l_red<span class="main">:</span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
      l'_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">∈</span> set <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      not_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">L</span> <span class="main">=</span> <span class="skolem">L'</span> <span class="keyword1">⋅l</span> <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      subs<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>remove1 <span class="skolem">L'</span> <span class="free">C</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⊆#</span> mset <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="skolem">D'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_reducible_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="skolem">L</span> <span class="main">#</span> <span class="skolem">D'</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>
      <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="skolem">D'</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">#</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span> <span class="main">@</span> <span class="free">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
            wrp.backward_reduction_Q<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="free"><span class="free"><span class="free">C</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">{#</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">L'</span></span></span><span class="main"><span class="main"><span class="main">#}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">L'</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="free"><span class="free"><span class="free">N</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">L</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ</span></span></span></span></span></span>
              <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">D</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">D'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="free"><span class="free"><span class="free">P</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">Q</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="free"><span class="free"><span class="free">Q'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">use</span> l'_in not_l subs c_in <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> l_red p_irred reduce_clause_in_P<span class="main">[</span><span class="operator">OF</span> c_in<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="skolem">D</span></span> <span class="quoted"><span class="skolem">D'</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">@</span> <span class="free">Q'</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> l_nred<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> d'_red<span class="main">:</span> <span class="quoted"><span class="quoted">"reduce <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">L</span><span class="main">]</span><span class="main">)</span> <span class="skolem">D'</span> <span class="main">≠</span> <span class="skolem">D'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ld'_red <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> d'_red<span class="main">]</span> l_nred <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> reduce_clauses_in_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    c_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p_irred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">P</span><span class="main">.</span> is_irreducible <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="bound">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span> <span class="main">@</span> <span class="free">P'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span> <span class="main">@</span> reduce_all <span class="free">C</span> <span class="free">P'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> reduce_all_def
  <span class="keyword1"><span class="command">using</span></span> p_irred
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">P'</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> suc_l <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> p_irred <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> p'_nnil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> suc_l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Max <span class="main">(</span>snd <span class="main">`</span> set <span class="skolem">P'</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Dj</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dclause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    dj_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Dj</span> <span class="main">∈</span> set <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    snd_dj<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">Dj</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="skolem">P'</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> image_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_def j_def length_Suc_conv list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> suc_l<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">P'</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">using</span></span> p'_nnil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">P'</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">≥</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P1'</span></span> <span class="skolem"><span class="skolem">P2'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dclause list"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
    p'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> <span class="skolem">P1'</span> <span class="main">@</span> <span class="skolem">Dj</span> <span class="main">#</span> <span class="skolem">P2'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="operator">OF</span> dj_in<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">@</span> <span class="skolem">P1'</span> <span class="main">@</span> <span class="skolem">Dj</span> <span class="main">#</span> <span class="skolem">P2'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>
     <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">@</span> <span class="skolem">P1'</span> <span class="main">@</span> apfst <span class="main">(</span>reduce <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">Dj</span> <span class="main">#</span> <span class="skolem">P2'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> append_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> surjective_pairing<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Dj</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> snd_dj<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> apfst_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> reduce_clause_in_P<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> append_Nil<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> c_in<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> p_irred j_max<span class="main">[</span><span class="operator">unfolded</span> p'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">@</span> <span class="skolem">P1'</span> <span class="main">@</span> apfst <span class="main">(</span>reduce <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">Dj</span> <span class="main">#</span> <span class="skolem">P2'</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>
     <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">@</span> map <span class="main">(</span>apfst <span class="main">(</span>reduce <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P1'</span> <span class="main">@</span> <span class="skolem">Dj</span> <span class="main">#</span> <span class="skolem">P2'</span><span class="main">)</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup>)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
          ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">P1'</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">P2'</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"apfst <span class="main"><span class="main">(</span></span>reduce <span class="main"><span class="main">[</span></span><span class="free"><span class="free">C</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">Dj</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> suc_l reduce_idem p_irred <span class="keyword1"><span class="command">unfolding</span></span> p' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> p' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> reduce_clauses_in_Q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    c_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p_irred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">E</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">P</span><span class="main">.</span> is_irreducible <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="bound">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span> <span class="main">@</span> <span class="free">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>
    <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> fst <span class="main">(</span>reduce_all2 <span class="free">C</span> <span class="free">Q'</span><span class="main">)</span> <span class="main">@</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span> <span class="main">@</span> snd <span class="main">(</span>reduce_all2 <span class="free">C</span> <span class="free">Q'</span><span class="main">)</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p_irred
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">Dj</span> <span class="skolem">Q'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> p_irred <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_irreducible <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">(</span>fst <span class="skolem">Dj</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">Dj</span><span class="main">]</span>"</span></span><span class="main">]</span> p_irred <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> d_red<span class="main">:</span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span> <span class="main">@</span> <span class="skolem">Dj</span> <span class="main">#</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>
      <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="main">(</span>reduce <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">[]</span> <span class="main">(</span>fst <span class="skolem">Dj</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">Dj</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span> <span class="main">@</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_irred reduce_clause_in_Q<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">Dj</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">Q</span></span> <span class="quoted"><span class="skolem">Q'</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">OF</span> c_in _ d_red<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Dj</span></span><span class="main">)</span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>reduce <span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="main">[]</span> <span class="main">(</span>fst <span class="skolem">Dj</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">Dj</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="skolem">Q</span></span><span class="main">]</span> d_red p_irred reduce_idem
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> eligible_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eligible <span class="free">S</span> <span class="free">σ</span> <span class="free">As</span> <span class="free">DA</span> <span class="main">⟷</span> <span class="free">As</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> length <span class="free">As</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> maximal_wrt <span class="main">(</span>hd <span class="free">As</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">DA</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eligible.simps S_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_one_side_prem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ord_resolve <span class="free">S</span> <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span> <span class="main">⟹</span> length <span class="free">CAs</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> length <span class="free">AAs</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> length <span class="free">As</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ord_resolve.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eligible_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_rename_one_side_prem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ord_resolve_rename <span class="free">S</span> <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span> <span class="main">⟹</span> length <span class="free">CAs</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> length <span class="free">AAs</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> length <span class="free">As</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ord_resolve_rename.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ord_resolve_one_side_prem<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Bin_ord_resolve</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Bin_ord_resolve</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="main">∃</span><span class="bound">AA</span> <span class="bound">A</span> <span class="bound">σ</span><span class="main">.</span> ord_resolve <span class="free">S</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">[</span><span class="bound">AA</span><span class="main">]</span> <span class="main">[</span><span class="bound">A</span><span class="main">]</span> <span class="bound">σ</span> <span class="bound">E</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Bin_ord_resolve_rename</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Bin_ord_resolve_rename</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="main">∃</span><span class="bound">AA</span> <span class="bound">A</span> <span class="bound">σ</span><span class="main">.</span> ord_resolve_rename <span class="free">S</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">[</span><span class="bound">AA</span><span class="main">]</span> <span class="main">[</span><span class="bound">A</span><span class="main">]</span> <span class="bound">σ</span> <span class="bound">E</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> resolve_on_eq_UNION_Bin_ord_resolve<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">`</span> set <span class="main">(</span>resolve_on <span class="free">A</span> <span class="free">D</span> <span class="free">CA</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="main">∃</span><span class="bound">AA</span> <span class="bound">σ</span><span class="main">.</span> ord_resolve <span class="free">S</span> <span class="main">[</span>mset <span class="free">CA</span><span class="main">]</span> <span class="main">(</span><span class="main">{#</span>Neg <span class="free">A</span><span class="main">#}</span> <span class="main">+</span> mset <span class="free">D</span><span class="main">)</span> <span class="main">[</span><span class="bound">AA</span><span class="main">]</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="bound">σ</span> <span class="bound">E</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> set <span class="main">(</span>resolve_on <span class="free">A</span> <span class="free">D</span> <span class="free">CA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> resolvent <span class="free">D</span> <span class="free">A</span> <span class="free">CA</span> <span class="main">`</span> <span class="main">{</span><span class="bound">Ls</span><span class="main">.</span> subseq <span class="bound">Ls</span> <span class="free">CA</span> <span class="main">∧</span> resolvable <span class="free">A</span> <span class="free">D</span> <span class="free">CA</span> <span class="bound">Ls</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> resolve_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> Ls_p<span class="main">:</span> <span class="quoted"><span class="quoted">"resolvent <span class="free">D</span> <span class="free">A</span> <span class="free">CA</span> <span class="skolem">Ls</span> <span class="main">=</span> <span class="skolem">E</span>"</span></span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">Ls</span> <span class="free">CA</span> <span class="main">∧</span> resolvable <span class="free">A</span> <span class="free">D</span> <span class="free">CA</span> <span class="skolem">Ls</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> the <span class="main">(</span><span class="free">mgu</span> <span class="main">{</span>insert <span class="free">A</span> <span class="main">(</span>atms_of <span class="main">(</span>mset <span class="skolem">Ls</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> σ_p<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">mgu</span> <span class="main">{</span>insert <span class="free">A</span> <span class="main">(</span>atms_of <span class="main">(</span>mset <span class="skolem">Ls</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> Some <span class="skolem">σ</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">Ls</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="quoted"><span class="quoted">"eligible <span class="free">S</span> <span class="skolem">σ</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="main">(</span>add_mset <span class="main">(</span>Neg <span class="free">A</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"strictly_maximal_wrt <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>mset <span class="free">CA</span> <span class="main">-</span> mset <span class="skolem">Ls</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">L</span> <span class="main">∈</span> set <span class="skolem">Ls</span><span class="main">.</span> is_pos <span class="bound">L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ls_p <span class="keyword1"><span class="command">unfolding</span></span> resolvable_def <span class="keyword1"><span class="command">unfolding</span></span> Let_def eligible.simps <span class="keyword1"><span class="command">using</span></span> S_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> σ_p <span class="keyword1"><span class="command">have</span></span> σ_p2<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">mgu</span> <span class="main">{</span>insert <span class="free">A</span> <span class="main">(</span>atms_of <span class="main">(</span>mset <span class="skolem">Ls</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> Ls_sub_CA<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">Ls</span> <span class="main">⊆#</span> mset <span class="free">CA</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subseq_mset_subseteq_mset Ls_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>resolvent <span class="free">D</span> <span class="free">A</span> <span class="free">CA</span> <span class="skolem">Ls</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">[</span>mset <span class="free">CA</span> <span class="main">-</span> mset <span class="skolem">Ls</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">+</span> mset <span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> resolvent_def σ_p2 subst_cls_def <span class="keyword1"><span class="command">using</span></span> remove_all_mset_minus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Ls</span></span> <span class="quoted"><span class="free">CA</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>mset <span class="free">CA</span> <span class="main">-</span> mset <span class="skolem">Ls</span><span class="main">]</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">L</span> <span class="main">∈</span> set <span class="skolem">Ls</span><span class="main">.</span> is_pos <span class="bound">L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> σ_p<span class="main">(</span>5<span class="main">)</span> list_all_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted">is_pos</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>Pos <span class="main">(</span>atm_of <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="skolem">Ls</span><span class="main">#}</span> <span class="main">=</span> mset <span class="skolem">Ls</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">Ls</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">CA</span> <span class="main">=</span> <span class="main">[</span>mset <span class="free">CA</span> <span class="main">-</span> mset <span class="skolem">Ls</span><span class="main">]</span> <span class="main">!</span> <span class="main">0</span> <span class="main">+</span> <span class="main">{#</span>Pos <span class="main">(</span>atm_of <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="skolem">Ls</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ls_sub_CA <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ls</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> σ_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">σ</span> <span class="main">=</span> <span class="free">mgu</span> <span class="main">{</span>insert <span class="free">A</span> <span class="main">(</span>atm_of <span class="main">`</span> set <span class="skolem">Ls</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> σ_p <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eligible <span class="free">S</span> <span class="skolem">σ</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="main">(</span>add_mset <span class="main">(</span>Neg <span class="free">A</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> σ_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strictly_maximal_wrt <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span>mset <span class="free">CA</span> <span class="main">-</span> mset <span class="skolem">Ls</span><span class="main">]</span> <span class="main">!</span> <span class="main">0</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> σ_p<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>mset <span class="free">CA</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Cs</span><span class="main">.</span> mset <span class="main">(</span>resolvent <span class="free">D</span> <span class="free">A</span> <span class="free">CA</span> <span class="skolem">Ls</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="bound">Cs</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">+</span> mset <span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span>
        <span class="main">∧</span> length <span class="bound">Cs</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">∧</span> mset <span class="free">CA</span> <span class="main">=</span> <span class="bound">Cs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">+</span> <span class="main">{#</span>Pos <span class="main">(</span>atm_of <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="skolem">Ls</span><span class="main">#}</span>
        <span class="main">∧</span> <span class="skolem">Ls</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> Some <span class="skolem">σ</span> <span class="main">=</span> <span class="free">mgu</span> <span class="main">{</span>insert <span class="free">A</span> <span class="main">(</span>atm_of <span class="main">`</span> set <span class="skolem">Ls</span><span class="main">)</span><span class="main">}</span>
        <span class="main">∧</span> eligible <span class="free">S</span> <span class="skolem">σ</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="main">(</span>add_mset <span class="main">(</span>Neg <span class="free">A</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> strictly_maximal_wrt <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span><span class="bound">Cs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span>
        <span class="main">∧</span> <span class="free">S</span> <span class="main">(</span>mset <span class="free">CA</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ord_resolve <span class="free">S</span> <span class="main">[</span>mset <span class="free">CA</span><span class="main">]</span> <span class="main">(</span>add_mset <span class="main">(</span>Neg <span class="free">A</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>image_mset atm_of <span class="main">(</span>mset <span class="skolem">Ls</span><span class="main">)</span><span class="main">]</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span>
      <span class="skolem">σ</span> <span class="main">(</span>mset <span class="main">(</span>resolvent <span class="free">D</span> <span class="free">A</span> <span class="free">CA</span> <span class="skolem">Ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ord_resolve.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">AA</span> <span class="bound">σ</span><span class="main">.</span> ord_resolve <span class="free">S</span> <span class="main">[</span>mset <span class="free">CA</span><span class="main">]</span> <span class="main">(</span>add_mset <span class="main">(</span>Neg <span class="free">A</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="bound">AA</span><span class="main">]</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="bound">σ</span> <span class="main">(</span>mset <span class="skolem">E</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ls_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">`</span> set <span class="main">(</span>resolve_on <span class="free">A</span> <span class="free">D</span> <span class="free">CA</span><span class="main">)</span>
    <span class="main">⊆</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="main">∃</span><span class="bound">AA</span> <span class="bound">σ</span><span class="main">.</span> ord_resolve <span class="free">S</span> <span class="main">[</span>mset <span class="free">CA</span><span class="main">]</span> <span class="main">(</span><span class="main">{#</span>Neg <span class="free">A</span><span class="main">#}</span> <span class="main">+</span> mset <span class="free">D</span><span class="main">)</span> <span class="main">[</span><span class="bound">AA</span><span class="main">]</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="bound">σ</span> <span class="bound">E</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">E</span> <span class="skolem">AA</span> <span class="skolem">σ</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ord_resolve <span class="free">S</span> <span class="main">[</span>mset <span class="free">CA</span><span class="main">]</span> <span class="main">(</span>add_mset <span class="main">(</span>Neg <span class="free">A</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">AA</span><span class="main">]</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="skolem">σ</span> <span class="skolem">E</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> res'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> sum_list <span class="skolem">Cs</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">+</span> mset <span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span>"</span></span>
      <span class="quoted"><span class="quoted">"length <span class="skolem">Cs</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
      <span class="quoted"><span class="quoted">"mset <span class="free">CA</span> <span class="main">=</span> <span class="skolem">Cs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">+</span> poss <span class="skolem">AA</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
      <span class="quoted"><span class="quoted">"Some <span class="skolem">σ</span> <span class="main">=</span> <span class="free">mgu</span> <span class="main">{</span>insert <span class="free">A</span> <span class="main">(</span>set_mset <span class="skolem">AA</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"eligible <span class="free">S</span> <span class="skolem">σ</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="main">(</span>add_mset <span class="main">(</span>Neg <span class="free">A</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"strictly_maximal_wrt <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Cs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span><span class="skolem">Cs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">+</span> poss <span class="skolem">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ord_resolve.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="skolem">Cs</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> sum_list <span class="skolem">Cs</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">+</span> mset <span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span>"</span></span>
      <span class="quoted"><span class="quoted">"mset <span class="free">CA</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">+</span> poss <span class="skolem">AA</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
      <span class="quoted"><span class="quoted">"Some <span class="skolem">σ</span> <span class="main">=</span> <span class="free">mgu</span> <span class="main">{</span>insert <span class="free">A</span> <span class="main">(</span>set_mset <span class="skolem">AA</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"eligible <span class="free">S</span> <span class="skolem">σ</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="main">(</span>add_mset <span class="main">(</span>Neg <span class="free">A</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"strictly_maximal_wrt <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">+</span> poss <span class="skolem">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ord_resolve.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">+</span> mset <span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">using</span></span> res'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> res' <span class="main">=</span> this res<span class="main">(</span>2-7<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Al</span><span class="main">.</span> mset <span class="bound">Al</span> <span class="main">=</span> <span class="skolem">AA</span> <span class="main">∧</span> subseq <span class="main">(</span>map Pos <span class="bound">Al</span><span class="main">)</span> <span class="free">CA</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> res<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">CA</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">AA</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">L</span> <span class="skolem">CA</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∈#</span> poss <span class="skolem">AA</span> "</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pos_L<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pos <span class="skolem">L</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> rem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A'</span><span class="main">.</span> Pos <span class="bound">A'</span> <span class="main">∈#</span> poss <span class="skolem">AA</span> <span class="main">⟹</span>
          remove1_mset <span class="main">(</span>Pos <span class="bound">A'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">+</span> poss <span class="skolem">AA</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">+</span> poss <span class="main">(</span>remove1_mset <span class="bound">A'</span> <span class="skolem">AA</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">AA</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">CA</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">+</span> <span class="main">(</span>poss <span class="main">(</span><span class="skolem">AA</span> <span class="main">-</span> <span class="main">{#</span>atm_of <span class="skolem">L</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True Cons<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_remove_trivial rem literal.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> pos_L<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Al</span><span class="main">.</span> mset <span class="bound">Al</span> <span class="main">=</span> remove1_mset <span class="main">(</span>atm_of <span class="skolem">L</span><span class="main">)</span> <span class="skolem">AA</span> <span class="main">∧</span> subseq <span class="main">(</span>map Pos <span class="bound">Al</span><span class="main">)</span> <span class="skolem">CA</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">AA</span> <span class="main">-</span> <span class="main">{#</span>atm_of <span class="skolem">L</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Al</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"mset <span class="skolem">Al</span> <span class="main">=</span> remove1_mset <span class="main">(</span>atm_of <span class="skolem">L</span><span class="main">)</span> <span class="skolem">AA</span> <span class="main">∧</span> subseq <span class="main">(</span>map Pos <span class="skolem">Al</span><span class="main">)</span> <span class="skolem">CA</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"mset <span class="main">(</span>atm_of <span class="skolem">L</span> <span class="main">#</span> <span class="skolem">Al</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">AA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"subseq <span class="main">(</span>map Pos <span class="main">(</span>atm_of <span class="skolem">L</span> <span class="main">#</span> <span class="skolem">Al</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">L</span> <span class="main">#</span> <span class="skolem">CA</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_L<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">CA</span> <span class="main">=</span> remove1_mset <span class="skolem">L</span> <span class="skolem">C</span> <span class="main">+</span> poss <span class="skolem">AA</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff add_mset_remove_trivial mset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> set_mset_union single_subset_iff
              subset_mset.add_diff_assoc2 union_single_eq_member<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Al</span><span class="main">.</span> mset <span class="bound">Al</span> <span class="main">=</span> <span class="skolem">AA</span> <span class="main">∧</span> subseq <span class="main">(</span>map Pos <span class="bound">Al</span><span class="main">)</span> <span class="skolem">CA</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">L</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="skolem">AA</span></span><span class="main">]</span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Al</span></span> <span class="keyword2"><span class="keyword">where</span></span> Al_p<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">Al</span> <span class="main">=</span> <span class="skolem">AA</span>"</span></span> <span class="quoted"><span class="quoted">"subseq <span class="main">(</span>map Pos <span class="skolem">Al</span><span class="main">)</span> <span class="free">CA</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Ls</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ls</span> <span class="main">=</span> map Pos <span class="skolem">Al</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">CA</span> <span class="main">-</span> mset <span class="skolem">Ls</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Ls_def <span class="keyword1"><span class="command">using</span></span> res<span class="main">(</span>2<span class="main">)</span> Al_p<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ls_subq_ca<span class="main">:</span> <span class="quoted"><span class="quoted">"subseq <span class="skolem">Ls</span> <span class="free">CA</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Ls_def <span class="keyword1"><span class="command">using</span></span> Al_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">mgu</span> <span class="main">{</span>insert <span class="free">A</span> <span class="main">(</span>atms_of <span class="main">(</span>mset <span class="skolem">Ls</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Ls_def <span class="keyword1"><span class="command">using</span></span> res<span class="main">(</span>4<span class="main">)</span> Al_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atms_of_poss mset_map<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ls</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Al_p<span class="main">(</span>1<span class="main">)</span> Ls_def res'<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> σ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">mgu</span> <span class="main">{</span>insert <span class="free">A</span> <span class="main">(</span>set <span class="skolem">Al</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">σ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> res'<span class="main">(</span>4<span class="main">)</span> Al_p<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.sel  set_mset_mset<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eligible <span class="free">S</span> <span class="main">(</span>the <span class="main">(</span><span class="free">mgu</span> <span class="main">{</span>insert <span class="free">A</span> <span class="main">(</span>atms_of <span class="main">(</span>mset <span class="skolem">Ls</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span>
        <span class="main">(</span>add_mset <span class="main">(</span>Neg <span class="free">A</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Ls_def <span class="keyword1"><span class="command">using</span></span> res  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strictly_maximal_wrt <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> the <span class="main">(</span><span class="free">mgu</span> <span class="main">{</span>insert <span class="free">A</span> <span class="main">(</span>atms_of <span class="main">(</span>mset <span class="skolem">Ls</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">(</span>mset <span class="free">CA</span> <span class="main">-</span> mset <span class="skolem">Ls</span><span class="main">)</span> <span class="main">⋅</span> the <span class="main">(</span><span class="free">mgu</span> <span class="main">{</span>insert <span class="free">A</span> <span class="main">(</span>atms_of <span class="main">(</span>mset <span class="skolem">Ls</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Ls_def <span class="keyword1"><span class="command">using</span></span> res σ_p Al_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">L</span> <span class="main">∈</span> set <span class="skolem">Ls</span><span class="main">.</span> is_pos <span class="bound">L</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ls_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"resolvable <span class="free">A</span> <span class="free">D</span> <span class="free">CA</span> <span class="skolem">Ls</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> resolvable_def <span class="keyword1"><span class="command">unfolding</span></span> eligible.simps <span class="keyword1"><span class="command">using</span></span> S_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> ls_sub_ca<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">Ls</span> <span class="main">⊆#</span> mset <span class="free">CA</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ls_subq_ca subseq_mset_subseteq_mset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Ls</span></span> <span class="quoted"><span class="free">CA</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">x</span> <span class="keyword1">⋅l</span> <span class="skolem">σ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="free">CA</span> <span class="main">-</span> mset <span class="skolem">Ls</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">M</span> <span class="keyword1">⋅l</span> <span class="skolem">σ</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈#</span> mset <span class="free">D</span><span class="main">#}</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">+</span> mset <span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diff <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">x</span> <span class="keyword1">⋅l</span> <span class="skolem">σ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="free">CA</span> <span class="main">-</span> mset <span class="skolem">Ls</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">M</span> <span class="keyword1">⋅l</span> <span class="skolem">σ</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈#</span> mset <span class="free">D</span><span class="main">#}</span> <span class="main">=</span> <span class="skolem">E</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> res'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">M</span> <span class="keyword1">⋅l</span> <span class="skolem">σ</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈#</span> mset <span class="main">(</span>remove_all <span class="free">CA</span> <span class="skolem">Ls</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">M</span> <span class="keyword1">⋅l</span> <span class="skolem">σ</span> <span class="main">.</span> <span class="bound">M</span> <span class="main">∈#</span> mset <span class="free">D</span><span class="main">#}</span> <span class="main">=</span> <span class="skolem">E</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> remove_all_mset_minus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Ls</span></span> <span class="quoted"><span class="free">CA</span></span><span class="main">]</span> ls_sub_ca <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>resolvent <span class="free">D</span> <span class="free">A</span> <span class="free">CA</span> <span class="skolem">Ls</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">E</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> resolvable_def Let_def resolvent_def <span class="keyword1"><span class="command">using</span></span> Al_p<span class="main">(</span>1<span class="main">)</span> Ls_def atms_of_poss res'<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_union mset_append mset_map option.sel<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> mset <span class="main">`</span> set <span class="main">(</span>resolve_on <span class="free">A</span> <span class="free">D</span> <span class="free">CA</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> resolve_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="main">∃</span><span class="bound">AA</span> <span class="bound">σ</span><span class="main">.</span> ord_resolve <span class="free">S</span> <span class="main">[</span>mset <span class="free">CA</span><span class="main">]</span> <span class="main">(</span><span class="main">{#</span>Neg <span class="free">A</span><span class="main">#}</span> <span class="main">+</span> mset <span class="free">D</span><span class="main">)</span> <span class="main">[</span><span class="bound">AA</span><span class="main">]</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="bound">σ</span> <span class="bound">E</span><span class="main">}</span>
    <span class="main">⊆</span> mset <span class="main">`</span> set <span class="main">(</span>resolve_on <span class="free">A</span> <span class="free">D</span> <span class="free">CA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_resolve_eq_UNION_set_resolve_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>resolve <span class="free">C</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">⋃</span><span class="bound">L</span> <span class="main">∈</span> set <span class="free">D</span><span class="main">.</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="bound">L</span> <span class="keyword1">of</span>
         Pos <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{}</span>
       <span class="main">|</span> Neg <span class="bound">A</span> <span class="main">⇒</span> <span class="keyword1">if</span> maximal_wrt <span class="bound">A</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span> <span class="keyword1">then</span> set <span class="main">(</span>resolve_on <span class="bound">A</span> <span class="main">(</span>remove1 <span class="bound">L</span> <span class="free">D</span><span class="main">)</span> <span class="free">C</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> resolve_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> literal.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> resolve_eq_Bin_ord_resolve<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">`</span> set <span class="main">(</span>resolve <span class="free">C</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> Bin_ord_resolve <span class="main">(</span>mset <span class="free">C</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_resolve_eq_UNION_set_resolve_on
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> image_UN literal.case_distrib if_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> resolve_on_eq_UNION_Bin_ord_resolve<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_antisym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> literal.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> literal.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Neg <span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">AA</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">σ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> ord_resolve.simps<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ord_resolve.simps<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eligible_iff <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subst_cls_add_mset subst_cls_union<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> maximal_wrt_subst<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sat</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ord_resolve.simps<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> set_mset_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> poss_in_map_clauseD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"poss <span class="free">AA</span> <span class="main">⊆#</span> map_clause <span class="free">f</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">AA0</span><span class="main">.</span> poss <span class="bound">AA0</span> <span class="main">⊆#</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">AA</span> <span class="main">=</span> <span class="main">{#</span><span class="free">f</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈#</span> <span class="bound">AA0</span><span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">AA</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">A</span> <span class="skolem">AA</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> aaa_sub <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pos <span class="skolem">A</span> <span class="main">∈#</span> map_clause <span class="free">f</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> aaa_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    pa0_in<span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="skolem">A0</span> <span class="main">∈#</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">A0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span> <span class="main">(</span><span class="operator">metis</span> literal.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> literal.exhaust literal.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> literal.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">,</span></span>10<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poss <span class="skolem">AA</span> <span class="main">⊆#</span> map_clause <span class="free">f</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">-</span> <span class="main">{#</span>Pos <span class="skolem">A0</span><span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pa0_in aaa_sub<span class="main">[</span><span class="operator">unfolded</span> a<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_mset_remove1_mset_if insert_subset_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AA0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    paa0_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"poss <span class="skolem">AA0</span> <span class="main">⊆#</span> <span class="skolem">C</span> <span class="main">-</span> <span class="main">{#</span>Pos <span class="skolem">A0</span><span class="main">#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">=</span> image_mset <span class="free">f</span> <span class="skolem">AA0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poss <span class="main">(</span>add_mset <span class="skolem">A0</span> <span class="skolem">AA0</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pa0_in paa0_sub <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_subset_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">A</span> <span class="skolem">AA</span> <span class="main">=</span> image_mset <span class="free">f</span> <span class="main">(</span>add_mset <span class="skolem">A0</span> <span class="skolem">AA0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> a aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> poss_subset_filterD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"poss <span class="free">AA</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="free">ρ</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈#</span> mset <span class="free">C</span><span class="main">#}</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">AA0</span><span class="main">.</span> poss <span class="bound">AA0</span> <span class="main">⊆#</span> mset <span class="free">C</span> <span class="main">∧</span> <span class="free">AA</span> <span class="main">=</span> <span class="bound">AA0</span> <span class="keyword1">⋅am</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_def subst_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poss_in_map_clauseD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_in_map_literalD<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">∈</span> map_literal <span class="free">f</span> <span class="main">`</span> <span class="free">D</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">A0</span><span class="main">.</span> Neg <span class="bound">A0</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">A0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> image_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_in_filterD<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">∈#</span> <span class="main">{#</span><span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="free">ρ'</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈#</span> mset <span class="free">D</span><span class="main">#}</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">A0</span><span class="main">.</span> Neg <span class="bound">A0</span> <span class="main">∈#</span> mset <span class="free">D</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="bound">A0</span> <span class="keyword1">⋅a</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_lit_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> neg_in_map_literalD<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> resolve_rename_eq_Bin_ord_resolve_rename<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">`</span> set <span class="main">(</span>resolve_rename <span class="free">C</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> Bin_ord_resolve_rename <span class="main">(</span>mset <span class="free">C</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> order_antisym subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ρs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">renamings_apart</span> <span class="main">[</span>mset <span class="free">D</span><span class="main">,</span> mset <span class="free">C</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ρ'</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">=</span> hd <span class="var">?ρs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ρ</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">=</span> last <span class="var">?ρs</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> tl_ρs<span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="var">?ρs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">ρ</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ρ_def
    <span class="keyword1"><span class="command">using</span></span> renamings_apart_length Nitpick.size_list_simp<span class="main">(</span>2<span class="main">)</span> Suc_length_conv last.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> length_greater_0_conv list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">E</span>
    <span class="keyword3"><span class="command">assume</span></span> e_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> mset <span class="main">`</span> set <span class="main">(</span>resolve_rename <span class="free">C</span> <span class="free">D</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> e_in <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AA</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
      aa_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"poss <span class="skolem">AA</span> <span class="main">⊆#</span> mset <span class="free">C</span> <span class="main">⋅</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      a_in<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="skolem">A</span> <span class="main">∈#</span> mset <span class="free">D</span> <span class="main">⋅</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve <span class="free">S</span> <span class="main">[</span>mset <span class="free">C</span> <span class="main">⋅</span> <span class="skolem">ρ</span><span class="main">]</span> <span class="main">{#</span><span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="skolem">ρ'</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈#</span> mset <span class="free">D</span><span class="main">#}</span> <span class="main">[</span><span class="skolem">AA</span><span class="main">]</span> <span class="main">[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">σ</span> <span class="skolem">E</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ρ'_def ρ_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command">using</span></span> e_in <span class="keyword1"><span class="command">unfolding</span></span> resolve_rename_def Let_def resolve_eq_Bin_ord_resolve
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> ord_resolve_one_side_prem<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> ord_resolve.simps<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">AA</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_cls_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Melem_subst_cls set_mset_mset subst_cls_def union_single_eq_member<span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AA0</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      aa0_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"poss <span class="skolem">AA0</span> <span class="main">⊆#</span> mset <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">=</span> <span class="skolem">AA0</span> <span class="keyword1">⋅am</span> <span class="skolem">ρ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> aa_sub
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ord_resolve.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> res_e<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poss_subset_filterD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> aa_sub<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subst_cls_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A0</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
      a0_in<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="skolem">A0</span> <span class="main">∈</span> set <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A0</span> <span class="keyword1">⋅a</span> <span class="skolem">ρ'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ord_resolve.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> res_e<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> neg_in_filterD<span class="main">[</span><span class="operator">OF</span> a_in<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subst_cls_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> Bin_ord_resolve_rename <span class="main">(</span>mset <span class="free">C</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ord_resolve_rename.simps
      <span class="keyword1"><span class="command">using</span></span> res_e
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">AA0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> aa0_sub<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">A0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> a0_in<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> aa a ρ'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> ρ_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> tl_ρs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_cls_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">E</span>
    <span class="keyword3"><span class="command">assume</span></span> e_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> Bin_ord_resolve_rename <span class="main">(</span>mset <span class="free">C</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> mset <span class="main">`</span> set <span class="main">(</span>resolve_rename <span class="free">C</span> <span class="free">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e_in
      <span class="keyword1"><span class="command">unfolding</span></span> resolve_rename_def Let_def resolve_eq_Bin_ord_resolve ord_resolve_rename.simps
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">AA</span> <span class="keyword1">⋅am</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">A</span> <span class="keyword1">⋅a</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">σ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tl_ρs ρ'_def ρ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_cls_def subst_cls_lists_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bin_ord_FO_Γ_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ord_FO_Γ <span class="free">S</span> <span class="main">=</span> <span class="main">{</span>Infer <span class="main">{#</span><span class="bound">CA</span><span class="main">#}</span> <span class="bound">DA</span> <span class="bound">E</span> <span class="main">|</span> <span class="bound">CA</span> <span class="bound">DA</span> <span class="bound">AA</span> <span class="bound">A</span> <span class="bound">σ</span> <span class="bound">E</span><span class="main">.</span> ord_resolve_rename <span class="free">S</span> <span class="main">[</span><span class="bound">CA</span><span class="main">]</span> <span class="bound">DA</span> <span class="main">[</span><span class="bound">AA</span><span class="main">]</span> <span class="main">[</span><span class="bound">A</span><span class="main">]</span> <span class="bound">σ</span> <span class="bound">E</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ord_FO_Γ_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order.antisym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> ord_resolve_rename_one_side_prem<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_length_conv length_0_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> ord_FO_Γ_side_prem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">∈</span> ord_FO_Γ <span class="free">S</span> <span class="main">⟹</span> side_prems_of <span class="free">γ</span> <span class="main">=</span> <span class="main">{#</span><span class="keyword1">THE</span> <span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈#</span> side_prems_of <span class="free">γ</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bin_ord_FO_Γ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>

<span class="keyword1"><span class="command">lemma</span></span> ord_FO_Γ_infer_from_Collect_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">γ</span></span> <span class="main">∈</span> ord_FO_Γ <span class="free">S</span><span class="main">.</span> infer_from <span class="main">(</span><span class="free">DD</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span><span class="main">)</span> <span class="bound">γ</span> <span class="main">∧</span> <span class="free">C</span> <span class="main">∈#</span> prems_of <span class="bound">γ</span><span class="main">}</span> <span class="main">=</span>
   <span class="main">{</span><span class="bound"><span class="bound">γ</span></span> <span class="main">∈</span> ord_FO_Γ <span class="free">S</span><span class="main">.</span> <span class="main">∃</span><span class="bound">D</span> <span class="main">∈</span> <span class="free">DD</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span><span class="main">.</span> prems_of <span class="bound">γ</span> <span class="main">=</span> <span class="main">{#</span><span class="free">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">#}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> infer_from_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_eq_subset<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> ord_FO_Γ_side_prem<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ord_FO_Γ_side_prem<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ord_FO_Γ_side_prem<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> ord_FO_Γ_side_prem<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> inferences_between_eq_UNION<span class="main">:</span> <span class="quoted"><span class="quoted">"inference_system.inferences_between <span class="main">(</span>ord_FO_Γ <span class="free">S</span><span class="main">)</span> <span class="free">Q</span> <span class="free">C</span> <span class="main">=</span>
  inference_system.inferences_between <span class="main">(</span>ord_FO_Γ <span class="free">S</span><span class="main">)</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span> <span class="free">C</span>
  <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">D</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> inference_system.inferences_between <span class="main">(</span>ord_FO_Γ <span class="free">S</span><span class="main">)</span> <span class="main">{</span><span class="bound">D</span><span class="main">}</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ord_FO_Γ_infer_from_Collect_eq inference_system.inferences_between_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> concls_of_inferences_between_singleton_eq_Bin_ord_resolve_rename<span class="main">:</span>
  <span class="quoted"><span class="quoted">"concls_of <span class="main">(</span>inference_system.inferences_between <span class="main">(</span>ord_FO_Γ <span class="free">S</span><span class="main">)</span> <span class="main">{</span><span class="free">D</span><span class="main">}</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span>
   Bin_ord_resolve_rename <span class="free">C</span> <span class="free">C</span> <span class="main">∪</span> Bin_ord_resolve_rename <span class="free">C</span> <span class="free">D</span> <span class="main">∪</span> Bin_ord_resolve_rename <span class="free">D</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> order_antisym subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">E</span>
  <span class="keyword3"><span class="command">assume</span></span> e_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> concls_of <span class="main">(</span>inference_system.inferences_between <span class="main">(</span>ord_FO_Γ <span class="free">S</span><span class="main">)</span> <span class="main">{</span><span class="free">D</span><span class="main">}</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> Bin_ord_resolve_rename <span class="free">C</span> <span class="free">C</span> <span class="main">∪</span> Bin_ord_resolve_rename <span class="free">C</span> <span class="free">D</span>
    <span class="main">∪</span> Bin_ord_resolve_rename <span class="free">D</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inference_system.inferences_between_def ord_FO_Γ_infer_from_Collect_eq
      bin_ord_FO_Γ_def infer_from_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mset_eq_add_mset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inference_system.inferences_between_def infer_from_def ord_FO_Γ_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concls_of_inferences_between_eq_Bin_ord_resolve_rename<span class="main">:</span>
  <span class="quoted"><span class="quoted">"concls_of <span class="main">(</span>inference_system.inferences_between <span class="main">(</span>ord_FO_Γ <span class="free">S</span><span class="main">)</span> <span class="free">Q</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span>
   Bin_ord_resolve_rename <span class="free">C</span> <span class="free">C</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">D</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> Bin_ord_resolve_rename <span class="free">C</span> <span class="bound">D</span> <span class="main">∪</span> Bin_ord_resolve_rename <span class="bound">D</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> inferences_between_eq_UNION<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un image_UN concls_of_inferences_between_singleton_eq_Bin_ord_resolve_rename<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> resolve_rename_either_way_eq_congls_of_inferences_between<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">`</span> set <span class="main">(</span>resolve_rename <span class="free">C</span> <span class="free">C</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">D</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> mset <span class="main">`</span> set <span class="main">(</span>resolve_rename_either_way <span class="free">C</span> <span class="bound">D</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   concls_of <span class="main">(</span>inference_system.inferences_between <span class="main">(</span>ord_FO_Γ <span class="free">S</span><span class="main">)</span> <span class="main">(</span>mset <span class="main">`</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resolve_rename_either_way_def image_Un resolve_rename_eq_Bin_ord_resolve_rename
      concls_of_inferences_between_eq_Bin_ord_resolve_rename UN_Un_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compute_inferences<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ci_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ci_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈#</span> mset <span class="main">(</span>map <span class="main">(</span>apfst mset<span class="main">)</span> <span class="free">P</span><span class="main">)</span><span class="main">.</span> weight <span class="main">(</span>mset <span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> weight <span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span>
     wstate_of_dstate <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>remdups_gen mset <span class="main">(</span>resolve_rename <span class="free">C</span> <span class="free">C</span> <span class="main">@</span>
         concat <span class="main">(</span>map <span class="main">(</span>resolve_rename_either_way <span class="free">C</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> mset <span class="bound">D</span> <span class="main">≠</span> mset <span class="free">C</span><span class="main">)</span> <span class="free">P</span><span class="main">,</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">Q</span><span class="main">,</span> Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> wstate_of_dstate <span class="main">(</span><span class="var">?N</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ms_ci_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">C</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈#</span> image_mset <span class="main">(</span>apfst mset<span class="main">)</span> <span class="main">(</span>mset <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ci_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
          wrp.inference_computation<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main">(</span></span>map <span class="main"><span class="main">(</span></span>apfst mset<span class="main"><span class="main">)</span></span> <span class="free"><span class="free">P</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">{#</span></span><span class="main"><span class="main">(</span></span>mset <span class="free"><span class="free">C</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">#}</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="free"><span class="free">C</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span>
            <span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main">(</span></span>map <span class="main"><span class="main">(</span></span>apfst mset<span class="main"><span class="main">)</span></span> <span class="var"><span class="var">?N</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main">(</span></span>map <span class="main"><span class="main">(</span></span>apfst mset<span class="main"><span class="main">)</span></span> <span class="free"><span class="free">Q</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mset_remove_trivial_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ms_ci_in<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ms_ci_in
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ci_in image_mset_remove1_mset_if<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> apfst_conv case_prodE case_prodI2 case_prod_conv filter_mset_cong
        image_mset_filter_swap mset_filter<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ci_min in_diffD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> list.map_comp apfst_comp_rpair_const<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> list.map_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mset_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mset_map_remdups_gen mset_remdups_gen_ident<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> image_mset_mset_set<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mset_set_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_ord_FO_resolution_inferences_between<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">N</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">D</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">D</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">n</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">`</span></span> <span class="bound"><span class="bound">N</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_concat list.map_comp image_comp<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> resolve_rename_either_way_eq_congls_of_inferences_between<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="free">Q</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp comp_def image_UN<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonfinal_deterministic_RP_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    nonfinal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_final_dstate <span class="free">St</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">St'</span> <span class="main">=</span> deterministic_RP_step <span class="free">St</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="free">St</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>+</sup></span> wstate_of_dstate <span class="free">St'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dclause list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
    st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">St</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">St</span></span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">unfolded</span> st deterministic_RP_step.simps<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ci</span> <span class="main">∈</span> set <span class="skolem">P</span> <span class="main">∪</span> set <span class="skolem">Q</span><span class="main">.</span> fst <span class="bound">Ci</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> nil_in<span class="main">:</span> True
    <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">simplified</span> nil_in<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

    <span class="keyword1"><span class="command">have</span></span> nil_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span><span class="skolem">P</span> <span class="main">@</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nil_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> star<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span><span class="skolem">P</span> <span class="main">@</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">⟹</span>
      wstate_of_dstate <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> remdups_clss <span class="skolem">P</span> <span class="main">@</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">+</span> length <span class="main">(</span>remdups_clss <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>remdups_clss <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">N</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="skolem">Q</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">note</span></span> len_p <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> nil_in' <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> p_nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> len_p remdups_clss_Nil_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> empty_N_if_Nil_in_P_or_Q<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nil_in'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> p_nil<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> p_nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> suc_k <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> nil_in' <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> suc_k remdups_clss_Nil_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> p_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> hd <span class="skolem">P</span> <span class="main">#</span> tl <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
        ci<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> select_min_weight_clause <span class="main">(</span>hd <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>tl <span class="skolem">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> ci_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ci <span class="keyword1"><span class="command">using</span></span> p_cons select_min_weight_clause_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="skolem">P</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> ci_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈#</span> mset <span class="main">(</span>map <span class="main">(</span>apfst mset<span class="main">)</span> <span class="skolem">P</span><span class="main">)</span><span class="main">.</span> weight <span class="main">(</span>mset <span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> weight <span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> p_cons<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_min_weight_clause_min_weight<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ci<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> mset <span class="bound">D</span> <span class="main">≠</span> mset <span class="skolem">C</span><span class="main">)</span> <span class="skolem">P</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> ms_p'_ci_q_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>remdups_clss <span class="var">?P'</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>remdups_clss <span class="skolem">P</span> <span class="main">@</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> p_cons<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> remdups_clss.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta p_cons<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ci<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_p<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>remdups_clss <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>remdups_clss <span class="var">?P'</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Suc_eq_plus1_left add.assoc add_right_cancel length_Cons length_append
            mset_eq_length<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> empty_N_if_Nil_in_P_or_Q<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nil_in'<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dclause list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> wstate_of_dstate <span class="main">(</span><span class="skolem">N'</span><span class="main">,</span> <span class="var">?P'</span><span class="main">,</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Q</span><span class="main">,</span> Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> compute_inferences<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ci_in<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> ci_min <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> remdups_clss <span class="skolem">P</span> <span class="main">@</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">+</span> length <span class="main">(</span>remdups_clss <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup>)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
            ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P'</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">C</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">Q</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">N'</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem">n</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> ms_p'_ci_q_eq suc_k nil_in' ci_in
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_p<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> apfst_conv image_mset_add_mset<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> st step <span class="keyword1"><span class="command">using</span></span> star<span class="main">[</span><span class="operator">OF</span> nil_in'<span class="main">]</span> nonfinal<span class="main">[</span><span class="operator">unfolded</span> st is_final_dstate.simps<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> nil_ni<span class="main">:</span> False
    <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">simplified</span> nil_ni<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">N</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> n_nil<span class="main">:</span> Nil
      <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">unfolded</span> n_nil<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">P</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> n_nil nonfinal<span class="main">[</span><span class="operator">unfolded</span> st<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_final_dstate.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> p_cons<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">P0</span> <span class="skolem">P'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">unfolded</span> p_cons list.case<span class="main">,</span> <span class="operator">folded</span> p_cons<span class="main">]</span>

        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
          ci<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> select_min_weight_clause <span class="skolem">P0</span> <span class="skolem">P'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">unfolded</span> select<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

        <span class="keyword1"><span class="command">have</span></span> ci_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">P</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> select_min_weight_clause_in<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P0</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P'</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> ci p_cons<span class="main"><span class="main">]</span></span><span class="main">)</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> st n_nil step p_cons<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> ci<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> prod.case
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tranclp.r_into_trancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> compute_inferences<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ci_in<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_min_weight_clause_min_weight<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ci<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> p_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> n_cons<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">Ci</span> <span class="skolem">N'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">unfolded</span> n_cons<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
        ci<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ci</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Ci</span></span><span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">unfolded</span> ci<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">=</span> reduce <span class="main">(</span>map fst <span class="skolem">P</span> <span class="main">@</span> map fst <span class="skolem">Q</span><span class="main">)</span> <span class="main">[]</span> <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">unfolded</span> ci C'_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">E</span> <span class="main">@</span> <span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>
           <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">E</span> <span class="main">@</span> reduce <span class="main">(</span>map fst <span class="skolem">P</span> <span class="main">@</span> map fst <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">E</span> <span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">E</span>
        <span class="keyword1"><span class="command">unfolding</span></span> C'_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">E</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">L</span> <span class="skolem">C</span><span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_reducible_lit <span class="main">(</span>map fst <span class="skolem">P</span> <span class="main">@</span> map fst <span class="skolem">Q</span><span class="main">)</span> <span class="main">(</span><span class="skolem">E</span> <span class="main">@</span> <span class="skolem">C</span><span class="main">)</span> <span class="skolem">L</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> l_red<span class="main">:</span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> red_lc<span class="main">:</span>
            <span class="quoted"><span class="quoted">"reduce <span class="main">(</span>map fst <span class="skolem">P</span> <span class="main">@</span> map fst <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span><span class="skolem">L</span> <span class="main">#</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> reduce <span class="main">(</span>map fst <span class="skolem">P</span> <span class="main">@</span> map fst <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">E</span> <span class="skolem">C</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">P</span> <span class="main">@</span> map fst <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">=</span> remove1 <span class="skolem">L'</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">∈</span> set <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">L</span> <span class="main">=</span> <span class="skolem">L'</span> <span class="keyword1">⋅l</span> <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            <span class="quoted"><span class="quoted">"mset <span class="skolem">D'</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⊆#</span> mset <span class="main">(</span><span class="skolem">E</span> <span class="main">@</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l_red <span class="keyword1"><span class="command">unfolding</span></span> is_reducible_lit_def comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> σ<span class="main">:</span>
            <span class="quoted"><span class="quoted">"mset <span class="skolem">D'</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">L'</span><span class="main">#}</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>mset <span class="main">∘</span> fst<span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">@</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">L</span> <span class="main">=</span> <span class="skolem">L'</span> <span class="keyword1">⋅l</span> <span class="skolem">σ</span> <span class="main">∧</span> mset <span class="skolem">D'</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⊆#</span> mset <span class="main">(</span><span class="skolem">E</span> <span class="main">@</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> is_reducible_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">E</span> <span class="main">@</span> <span class="skolem">L</span> <span class="main">#</span> <span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>
              <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">E</span> <span class="main">@</span> <span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
                  wrp.forward_reduction<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="skolem"><span class="skolem"><span class="skolem">D'</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">L'</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">P</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span>
                    <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Q</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">L</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">E</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">C</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">N'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span>
                    <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="main">(</span><span class="operator">use</span> σ <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> comp_def›</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> red_lc <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">E</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">#</span> <span class="skolem">E</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> red_C<span class="main">:</span>
        <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> C'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> self_append_conv2<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> proc_C<span class="main">:</span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span>
          <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> wstate_of_dstate <span class="main">(</span><span class="skolem">N'</span><span class="main">,</span> <span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">P'</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P'</span> <span class="skolem">Q'</span> <span class="skolem">n'</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
              wrp.clause_processing<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">N'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="skolem"><span class="skolem"><span class="skolem">C'</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span>
                <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">P'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Q'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
            <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">note</span></span> c'_nil <span class="main">=</span> this
        <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">simplified</span> c'_nil<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

        <span class="keyword1"><span class="command">have</span></span>
          filter_p<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span>Not <span class="main">∘</span> strictly_subsume <span class="main">[</span><span class="main">[]</span><span class="main">]</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">P</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          filter_q<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span>Not <span class="main">∘</span> strictly_subsume <span class="main">[</span><span class="main">[]</span><span class="main">]</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">Q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> nil_ni <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsume_def filter_empty_conv find_None_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

        <span class="keyword1"><span class="command">note</span></span> red_C<span class="main">[</span><span class="operator">unfolded</span> c'_nil<span class="main">]</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>
            <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup>)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
                remove_strictly_subsumed_clauses_in_P<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">unfolded</span> append_Nil<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span>
                <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_p<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup>)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
                remove_strictly_subsumed_clauses_in_Q<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">unfolded</span> append_Nil<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span>
                <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_q<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> proc_C<span class="main">[</span><span class="operator">unfolded</span> c'_nil<span class="main">,</span> <span class="operator">THEN</span> tranclp.r_into_trancl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="skolem">N'</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>
            <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> empty_N_if_Nil_in_P_or_Q<span class="main">)</span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> wstate_of_dstate <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
                wrp.inference_computation<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ord_FO_resolution_inferences_between_empty_empty<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> step st n_cons ci <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> c'_nnil<span class="main">:</span> False
        <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">simplified</span> c'_nnil<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_tautology <span class="skolem">C'</span> <span class="main">∨</span> subsume <span class="main">(</span>map fst <span class="skolem">P</span> <span class="main">@</span> map fst <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">C'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> taut_or_subs<span class="main">:</span> True
          <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">simplified</span> taut_or_subs<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> wstate_of_dstate <span class="main">(</span><span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_tautology <span class="skolem">C'</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
              neg_a<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="skolem">A</span> <span class="main">∈</span> set <span class="skolem">C'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pos_a<span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="skolem">A</span> <span class="main">∈</span> set <span class="skolem">C'</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> is_tautology_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
                    wrp.tautology_deletion<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="skolem"><span class="skolem"><span class="skolem">C'</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">N'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span>
                      <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">P</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Q</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="main">(</span><span class="operator">use</span> neg_a pos_a <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp_all</span><span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subsume <span class="main">(</span>map fst <span class="skolem">P</span> <span class="main">@</span> map fst <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">C'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> taut_or_subs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
              d_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">P</span> <span class="main">@</span> map fst <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
              subs<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="main">(</span>mset <span class="skolem">D</span><span class="main">)</span> <span class="main">(</span>mset <span class="skolem">C'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> subsume_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _
                    wrp.forward_subsumption<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="skolem"><span class="skolem"><span class="skolem">D</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">P</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span>
                      <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Q</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="skolem"><span class="skolem"><span class="skolem">C'</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">(</span></span></span>map <span class="main"><span class="main"><span class="main">(</span></span></span>apfst mset<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">N'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
                  <span class="operator">use</span> d_in subs <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> subsume_def›</span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> step st n_cons ci <span class="keyword1"><span class="command">using</span></span> red_C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp_into_tranclp1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> not_taut_or_subs<span class="main">:</span> False
          <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">simplified</span> not_taut_or_subs<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> literal list <span class="main">×</span> nat<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> reduce_all <span class="skolem">C'</span> <span class="skolem">P</span>"</span></span>

          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">back_to_P</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dclause list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            red_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">back_to_P</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">)</span> <span class="main">=</span> reduce_all2 <span class="skolem">C'</span> <span class="skolem">Q</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust<span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">unfolded</span> red_Q<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q''</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> literal list <span class="main">×</span> nat<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">Q''</span> <span class="main">=</span> filter <span class="main">(</span>Not <span class="main">∘</span> strictly_subsume <span class="main">[</span><span class="skolem">C'</span><span class="main">]</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">Q'</span>"</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P''</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> literal list <span class="main">×</span> nat<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">P''</span> <span class="main">=</span> filter <span class="main">(</span>Not <span class="main">∘</span> strictly_subsume <span class="main">[</span><span class="skolem">C'</span><span class="main">]</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="main">(</span><span class="skolem">back_to_P</span> <span class="main">@</span> <span class="skolem">P'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">unfolded</span> P'_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Q''_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> P''_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span>
              <span class="operator">simplified</span><span class="main">]</span>

          <span class="keyword1"><span class="command">note</span></span> red_C
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>
              <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> P'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reduce_clauses_in_P<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> append_Nil<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">back_to_P</span> <span class="main">@</span> <span class="skolem">P'</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> P'_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reduce_clauses_in_Q<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">C'</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Q</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> red_Q<span class="main"><span class="main">,</span></span>
                  <span class="operator">unfolded</span> append_Nil prod.sel<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reduce_idem <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reduce_all_def<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">back_to_P</span> <span class="main">@</span> <span class="skolem">P'</span><span class="main">,</span> <span class="skolem">Q''</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> Q''_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> remove_strictly_subsumed_clauses_in_Q<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> append_Nil<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span><span class="main">(</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P''</span><span class="main">,</span> <span class="skolem">Q''</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> P''_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> remove_strictly_subsumed_clauses_in_P<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> append_Nil<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> proc_C<span class="main">[</span><span class="operator">THEN</span> tranclp.r_into_trancl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> step st n_cons ci P''_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> final_deterministic_RP_step<span class="main">:</span> <span class="quoted"><span class="quoted">"is_final_dstate <span class="free">St</span> <span class="main">⟹</span> deterministic_RP_step <span class="free">St</span> <span class="main">=</span> <span class="free">St</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">St</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> deterministic_RP_step.simps is_final_dstate.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> deterministic_RP_SomeD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"deterministic_RP <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N'</span> <span class="bound">P'</span> <span class="bound">Q'</span> <span class="bound">n'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>deterministic_RP_step <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">P</span><span class="main">,</span> <span class="free">Q</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">N'</span><span class="main">,</span> <span class="bound">P'</span><span class="main">,</span> <span class="bound">Q'</span><span class="main">,</span> <span class="bound">n'</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> is_final_dstate <span class="main">(</span><span class="bound">N'</span><span class="main">,</span> <span class="bound">P'</span><span class="main">,</span> <span class="bound">Q'</span><span class="main">,</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> map fst <span class="bound">Q'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> deterministic_RP.raw_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">self_call</span> <span class="skolem">St</span> <span class="skolem">R</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> step <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dclause list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
    st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">St</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">St</span></span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">unfolded</span> st<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_final_dstate <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>deterministic_RP_step <span class="main">^^</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>
      <span class="main">∧</span> is_final_dstate <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">R</span> <span class="main">=</span> map fst <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> st <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> nonfinal<span class="main">:</span> False
    <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">[</span><span class="operator">simplified</span> nonfinal<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dclause list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>deterministic_RP_step <span class="main">^^</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>deterministic_RP_step <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"is_final_dstate <span class="main">(</span><span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> map fst <span class="skolem">Q'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> step<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> st funpow_Suc_right<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">THEN</span> fun_cong<span class="main">,</span> <span class="operator">unfolded</span> comp_apply<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">N0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dclause list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">n0</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lclause list"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">St0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dstate"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">St0</span> <span class="main">≡</span> <span class="main">(</span><span class="free">N0</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free">n0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">grounded_N0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">grounded_N0</span> <span class="main">≡</span> grounding_of_clss <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>mset <span class="main">∘</span> fst<span class="main">)</span> <span class="free">N0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">grounded_R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">grounded_R</span> <span class="main">≡</span> grounding_of_clss <span class="main">(</span>set <span class="main">(</span>map mset <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">derivation_from</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dstate <span class="main">⇒</span> <span class="tfree">'a</span> dstate llist"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">derivation_from</span> <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">=</span>
   LCons <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">(</span><span class="keyword1">if</span> is_final_dstate <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="keyword1">then</span> LNil <span class="keyword1">else</span> <span class="free">derivation_from</span> <span class="main">(</span>deterministic_RP_step <span class="free"><span class="bound"><span class="entity">St</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Sts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dstate llist"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Sts</span> <span class="main">≡</span> derivation_from St0"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">wSts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate llist"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wSts</span> <span class="main">≡</span> lmap wstate_of_dstate Sts"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> full_deriv_wSts_trancl_weighted_RP<span class="main">:</span> <span class="quoted"><span class="quoted">"full_chain <span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>+</sup>)</span> wSts"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Sts'</span> <span class="main">=</span> derivation_from <span class="skolem">St0'</span> <span class="main">⟹</span> full_chain <span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>+</sup>)</span> <span class="main">(</span>lmap wstate_of_dstate <span class="skolem">Sts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">St0'</span> <span class="skolem">Sts'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">St0'</span></span> <span class="quoted"><span class="skolem">Sts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> full_chain.coinduct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> sts'<span class="main">:</span> full_chain
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_final_dstate <span class="skolem">St0'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ltl <span class="main">(</span>lmap wstate_of_dstate <span class="skolem">Sts'</span><span class="main">)</span> <span class="main">=</span> LNil"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sts' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lmap wstate_of_dstate <span class="skolem">Sts'</span> <span class="main">=</span> LCons <span class="main">(</span>wstate_of_dstate <span class="skolem">St0'</span><span class="main">)</span> LNil"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sts' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> derivation_from.code<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> derivation_from.code<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">St''</span><span class="main">.</span> <span class="main">¬</span> wstate_of_dstate <span class="skolem">St0'</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="bound">St''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_final_dstate_imp_not_weighted_RP<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> tranclpD<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> nfinal<span class="main">:</span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lmap wstate_of_dstate <span class="skolem">Sts'</span> <span class="main">=</span>
        LCons <span class="main">(</span>wstate_of_dstate <span class="skolem">St0'</span><span class="main">)</span> <span class="main">(</span>lmap wstate_of_dstate <span class="main">(</span>ltl <span class="skolem">Sts'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sts' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> derivation_from.code<span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ltl <span class="skolem">Sts'</span> <span class="main">=</span> derivation_from <span class="main">(</span>deterministic_RP_step <span class="skolem">St0'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sts' <span class="keyword1"><span class="command">using</span></span> nfinal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> derivation_from.code<span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wstate_of_dstate <span class="skolem">St0'</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>+</sup></span> wstate_of_dstate <span class="main">(</span>lhd <span class="main">(</span>ltl <span class="skolem">Sts'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sts' <span class="keyword1"><span class="command">using</span></span> nonfinal_deterministic_RP_step<span class="main">[</span><span class="operator">OF</span> nfinal refl<span class="main">]</span> nfinal
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> derivation_from.code<span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> deriv_wSts_trancl_weighted_RP <span class="main">=</span> full_chain_imp_chain<span class="main">[</span><span class="operator">OF</span> full_deriv_wSts_trancl_weighted_RP<span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sswSts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wstate llist"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sswSts</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">wSts'</span><span class="main">.</span>
     full_chain <span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span> <span class="bound">wSts'</span> <span class="main">∧</span> emb wSts <span class="bound">wSts'</span> <span class="main">∧</span> lhd <span class="bound">wSts'</span> <span class="main">=</span> lhd wSts <span class="main">∧</span> llast <span class="bound">wSts'</span> <span class="main">=</span> llast wSts<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sswSts<span class="main">:</span>
  <span class="quoted"><span class="quoted">"full_chain <span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span> sswSts <span class="main">∧</span> emb wSts sswSts <span class="main">∧</span> lhd sswSts <span class="main">=</span> lhd wSts <span class="main">∧</span> llast sswSts <span class="main">=</span> llast wSts"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sswSts_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> full_chain_tranclp_imp_exists_full_chain<span class="main"><span class="main">[</span></span><span class="operator">OF</span>
          full_deriv_wSts_trancl_weighted_RP<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> full_deriv_sswSts_weighted_RP <span class="main">=</span> sswSts<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> emb_sswSts <span class="main">=</span> sswSts<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">THEN</span> conjunct1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> lfinite_sswSts_iff <span class="main">=</span> emb_lfinite<span class="main">[</span><span class="operator">OF</span> emb_sswSts<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> lhd_sswSts <span class="main">=</span> sswSts<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">THEN</span> conjunct1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> llast_sswSts <span class="main">=</span> sswSts<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> deriv_sswSts_weighted_RP <span class="main">=</span> full_chain_imp_chain<span class="main">[</span><span class="operator">OF</span> full_deriv_sswSts_weighted_RP<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> not_lnull_sswSts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull sswSts"</span></span>
  <span class="keyword1"><span class="command">using</span></span> deriv_sswSts_weighted_RP <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chain.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_ssgP0<span class="main">:</span> <span class="quoted"><span class="quoted">"wrp.P_of_wstate <span class="main">(</span>lhd sswSts<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lhd_sswSts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> derivation_from.code<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_ssgQ0<span class="main">:</span> <span class="quoted"><span class="quoted">"wrp.Q_of_wstate <span class="main">(</span>lhd sswSts<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lhd_sswSts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> derivation_from.code<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> sswSts_thms <span class="main">=</span> full_deriv_sswSts_weighted_RP empty_ssgP0 empty_ssgQ0

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">S_ssgQ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S_ssgQ</span> <span class="main">≡</span> wrp.S_gQ sswSts"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ord_Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> inference set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ord_Γ</span> <span class="main">≡</span> ground_resolution_with_selection.ord_Γ S_ssgQ"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Rf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Rf</span> <span class="main">≡</span> standard_redundancy_criterion.Rf"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Ri</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> inference set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ri</span> <span class="main">≡</span> standard_redundancy_criterion.Ri ord_Γ"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">saturated_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">saturated_upto</span> <span class="main">≡</span> redundancy_criterion.saturated_upto ord_Γ Rf Ri"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> drp_some<span class="main">:</span> <span class="quoted"><span class="quoted">"deterministic_RP St0 <span class="main">=</span> Some <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lfinite_Sts<span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite Sts"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> deterministic_RP.raw_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ drp_some<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">self_call</span> <span class="skolem">St</span> <span class="skolem">St'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> step <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> derivation_from.code<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ih<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lfinite_wSts<span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite wSts"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lfinite_lmap<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> lfinite_Sts<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> lfinite_sswSts <span class="main">=</span> lfinite_sswSts_iff<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">,</span> <span class="operator">OF</span> lfinite_wSts<span class="main">]</span>

<span class="keyword1"><span class="command">theorem</span></span>
  deterministic_RP_saturated<span class="main">:</span> <span class="quoted"><span class="quoted">"saturated_upto grounded_R"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?saturated</span></span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  deterministic_RP_model<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> grounded_N0 <span class="main">⟷</span> <span class="free">I</span> <span class="keyword1">⊨s</span> grounded_R"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?model</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dclause list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
    k_steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>deterministic_RP_step <span class="main">^^</span> <span class="skolem">k</span><span class="main">)</span> St0 <span class="main">=</span> <span class="main">(</span><span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?Stk</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    final<span class="main">:</span> <span class="quoted"><span class="quoted">"is_final_dstate <span class="main">(</span><span class="skolem">N'</span><span class="main">,</span> <span class="skolem">P'</span><span class="main">,</span> <span class="skolem">Q'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> map fst <span class="skolem">Q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deterministic_RP_SomeD<span class="main">[</span><span class="operator">OF</span> drp_some<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> wrp<span class="main">:</span> <span class="quoted"><span class="quoted">"wstate_of_dstate St0 <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇧</span><sup>*</sup></span> wstate_of_dstate <span class="main">(</span>llast Sts<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lfinite_chain_imp_rtranclp_lhd_llast
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> deriv_sswSts_weighted_RP derivation_from.disc_iff derivation_from.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
        lfinite_Sts lfinite_sswSts llast_lmap llist.map_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sswSts<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> last_sts<span class="main">:</span> <span class="quoted"><span class="quoted">"llast Sts <span class="main">=</span> <span class="var">?Stk</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>deterministic_RP_step <span class="main">^^</span> <span class="skolem">k'</span><span class="main">)</span> <span class="skolem">St0'</span> <span class="main">=</span> <span class="var">?Stk</span> <span class="main">⟹</span> llast <span class="main">(</span>derivation_from <span class="skolem">St0'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?Stk</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">St0'</span> <span class="skolem">k'</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">St0'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> final <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> derivation_from.code<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> suc_k'_steps <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_final_dstate <span class="skolem">St0'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"deterministic_RP_step <span class="skolem">St0'</span>"</span></span><span class="main">]</span> suc_k'_steps final_deterministic_RP_step
            funpow_fixpoint<span class="main">[</span><span class="operator">of</span> <span class="quoted">deterministic_RP_step</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"deterministic_RP_step <span class="skolem">St0'</span>"</span></span><span class="main">]</span> suc_k'_steps
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> derivation_from.code<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> llast_LCons funpow_swap1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> k_steps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> fin_gr_fgsts<span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite <span class="main">(</span>lmap wrp.grounding_of_wstate sswSts<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lfinite_lmap<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> lfinite_sswSts<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> lim_last<span class="main">:</span> <span class="quoted"><span class="quoted">"Liminf_llist <span class="main">(</span>lmap wrp.grounding_of_wstate sswSts<span class="main">)</span> <span class="main">=</span>
    wrp.grounding_of_wstate <span class="main">(</span>llast sswSts<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lfinite_Liminf_llist<span class="main">[</span><span class="operator">OF</span> fin_gr_fgsts<span class="main">]</span> llast_lmap<span class="main">[</span><span class="operator">OF</span> lfinite_sswSts not_lnull_sswSts<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> not_lnull_sswSts <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> gr_st0<span class="main">:</span> <span class="quoted"><span class="quoted">"wrp.grounding_of_wstate <span class="main">(</span>wstate_of_dstate St0<span class="main">)</span> <span class="main">=</span> grounded_N0"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?saturated</span> <span class="main">∧</span> <span class="var">?model</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> set <span class="free">R</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> emp_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> grounded_R"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ex_ground_subst<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"grounded_R <span class="main">⊆</span> wrp.grounding_of_wstate <span class="main">(</span>llast sswSts<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r llast_sswSts
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_sts llast_lmap<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lfinite_Sts<span class="main"><span class="main">]</span></span> grounding_of_clss_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gr_last_st<span class="main">:</span> <span class="quoted"><span class="quoted">"grounded_R <span class="main">⊆</span> wrp.grounding_of_wstate <span class="main">(</span>wstate_of_dstate <span class="main">(</span>llast Sts<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lfinite_Sts llast_lmap llast_sswSts<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> gr_r_fls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I</span> <span class="keyword1">⊨s</span> grounded_R"</span></span>
      <span class="keyword1"><span class="command">using</span></span> emp_in <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gr_last_fls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I</span> <span class="keyword1">⊨s</span> wrp.grounding_of_wstate <span class="main">(</span>wstate_of_dstate <span class="main">(</span>llast Sts<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gr_last_st <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?saturated</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wrp.ord_Γ_saturated_upto_def<span class="main">[</span><span class="operator">OF</span> sswSts_thms<span class="main">]</span>
        wrp.ord_Γ_contradiction_Rf<span class="main">[</span><span class="operator">OF</span> sswSts_thms emp_in<span class="main">]</span> inference_system.inferences_from_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?model</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gr_r_fls<span class="main">[</span><span class="operator">THEN</span> eq_False<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp_imp_eq_image<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">St</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">I</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">⊨s</span></span></span> wrp.grounding_of_wstate <span class="bound"><span class="bound"><span class="bound">St</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ wrp<span class="main"><span class="main">,</span></span>
            <span class="operator">unfolded</span> gr_st0 gr_last_fls<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> eq_False<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">use</span> wrp.weighted_RP_model<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sswSts_thms<span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gr_last<span class="main">:</span> <span class="quoted"><span class="quoted">"wrp.grounding_of_wstate <span class="main">(</span>llast sswSts<span class="main">)</span> <span class="main">=</span> grounded_R"</span></span>
      <span class="keyword1"><span class="command">using</span></span> final <span class="keyword1"><span class="command">unfolding</span></span> r llast_sswSts
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_sts llast_lmap<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lfinite_Sts<span class="main"><span class="main">]</span></span> comp_def is_final_dstate.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gr_last_st<span class="main">:</span> <span class="quoted"><span class="quoted">"wrp.grounding_of_wstate <span class="main">(</span>wstate_of_dstate <span class="main">(</span>llast Sts<span class="main">)</span><span class="main">)</span> <span class="main">=</span> grounded_R"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lfinite_Sts llast_lmap llast_sswSts<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?saturated</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> wrp.weighted_RP_saturated<span class="main">[</span><span class="operator">OF</span> sswSts_thms<span class="main">,</span> <span class="operator">unfolded</span> gr_last lim_last<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?model</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp_imp_eq_image<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">(↝<span class="hidden">⇩</span><sub>w</sub>)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">St</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">I</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">⊨s</span></span></span> wrp.grounding_of_wstate <span class="bound"><span class="bound"><span class="bound">St</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ wrp<span class="main"><span class="main">,</span></span>
            <span class="operator">unfolded</span> gr_st0 gr_last_st<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">use</span> wrp.weighted_RP_model<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sswSts_thms<span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?saturated</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?model</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> deterministic_RP_refutation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable grounded_N0 <span class="main">⟷</span> <span class="main">{#}</span> <span class="main">∈</span> grounded_R"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable grounded_R"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> deterministic_RP_model<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable grounded_R"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deterministic_RP_model<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrp.ord_Γ_saturated_upto_complete<span class="main">[</span><span class="operator">OF</span> sswSts_thms deterministic_RP_saturated<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> drp_none<span class="main">:</span> <span class="quoted"><span class="quoted">"deterministic_RP St0 <span class="main">=</span> None"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> deterministic_RP_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfiable grounded_N0"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable grounded_N0"</span></span>

  <span class="keyword1"><span class="command">have</span></span> unsat_wSts0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="main">(</span>wrp.grounding_of_wstate <span class="main">(</span>lhd wSts<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unsat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> derivation_from.code<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> bot_in_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>wrp.Liminf_wstate sswSts<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wrp.weighted_RP_complete<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sswSts_thms unsat_wSts0<span class="main"><span class="main">[</span></span><span class="operator">folded</span> lhd_sswSts<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> bot_in_lim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>wrp.Liminf_wstate wSts<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lfinite Sts"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> fin<span class="main">:</span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wrp.Liminf_wstate sswSts <span class="main">=</span> wrp.Liminf_wstate wSts"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Liminf_state_fin<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fin lfinite_sswSts_iff not_lnull_sswSts<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> llast_lmap<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lfinite_sswSts_iff fin not_lnull_sswSts llast_sswSts<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> bot_in_ss <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> bot_in_ss Q_of_Liminf_state_inf<span class="main">[</span><span class="operator">OF</span> _ emb_lmap<span class="main"><span class="main">[</span></span><span class="operator">OF</span> emb_sswSts<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
    k_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">k</span> <span class="main">&lt;</span> llength Sts"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    emp_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> wrp.Q_of_wstate <span class="main">(</span>lnth wSts <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_state_def Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> emp_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>state_of_dstate <span class="main">(</span><span class="main">(</span>deterministic_RP_step <span class="main">^^</span> <span class="skolem">k</span><span class="main">)</span> St0<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">k</span> <span class="main">&lt;</span> llength <span class="skolem">Sts'</span> <span class="main">⟹</span> <span class="skolem">Sts'</span> <span class="main">=</span> derivation_from <span class="skolem">St0'</span> <span class="main">⟹</span>
      <span class="main">{#}</span> <span class="main">∈</span> wrp.Q_of_wstate <span class="main">(</span>lnth <span class="main">(</span>lmap wstate_of_dstate <span class="skolem">Sts'</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="main">{#}</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>state_of_dstate <span class="main">(</span><span class="main">(</span>deterministic_RP_step <span class="main">^^</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">St0'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">St0'</span> <span class="skolem">Sts'</span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">St0'</span></span> <span class="quoted"><span class="skolem">Sts'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> derivation_from.code<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">St0'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> sk_lt <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> sts' <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> emp_in_sk <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> k_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">k</span> <span class="main">&lt;</span> llength <span class="main">(</span>ltl <span class="skolem">Sts'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sk_lt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Sts'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_ile_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ltl <span class="skolem">Sts'</span> <span class="main">=</span> derivation_from <span class="main">(</span>deterministic_RP_step <span class="skolem">St0'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sts' k_lt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Sts'</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> wrp.Q_of_wstate <span class="main">(</span>lnth <span class="main">(</span>lmap wstate_of_dstate <span class="main">(</span>ltl <span class="skolem">Sts'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> emp_in_sk k_lt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Sts'</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ltl <span class="skolem">Sts'</span>"</span></span> <span class="quoted"><span class="quoted">"deterministic_RP_step <span class="skolem">St0'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_swap1<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> k_lt emp_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deterministic_RP St0 <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_final_dstate_funpow_imp_deterministic_RP_neq_None<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">k</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>deterministic_RP_step <span class="main">^^</span> <span class="skolem">k</span><span class="main">)</span> St0"</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">use</span> emp_in <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main">:</span> deterministic_RP_step.simps is_final_dstate.simps›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> drp_none <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IsaFoR_Term">
<div class="head">
<h1>Theory IsaFoR_Term</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Integration of IsaFoR Terms and the Knuth-Bendix Order
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2017
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Integration of \textsf{IsaFoR} Terms and the Knuth--Bendix Order›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory implements the abstract interface for atoms and substitutions using
the \textsf{IsaFoR} library.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> IsaFoR_Term
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../Deriving/Derive.html">Deriving.Derive</a>
    <a href="../Ordered_Resolution_Prover/Abstract_Substitution.html">Ordered_Resolution_Prover.Abstract_Substitution</a>
    <a href="../First_Order_Terms/Unification.html">First_Order_Terms.Unification</a>
    <a href="../First_Order_Terms/Subsumption.html">First_Order_Terms.Subsumption</a>
    <span class="quoted">"<a href="../../HOL/HOL-Cardinals/Wellorder_Extension.html">HOL-Cardinals.Wellorder_Extension</a>"</span>
    <a href="../Open_Induction/Restricted_Predicates.html">Open_Induction.Restricted_Predicates</a>
    <a href="../Knuth_Bendix_Order/KBO.html">Knuth_Bendix_Order.KBO</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> mgu

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subst_apply_literal</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term literal <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> gsubst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> term literal"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅lit</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1"><span class="free">⋅lit</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> map_literal <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_apply_clause</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term clause <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> gsubst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> term clause"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅cls</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1"><span class="free">⋅cls</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅lit</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">vars_lit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term literal <span class="main">⇒</span> <span class="tfree">'v</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars_lit</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> vars_term <span class="main">(</span>atm_of <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vars_clause</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term clause <span class="main">⇒</span> <span class="tfree">'v</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars_clause</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> Union <span class="main">(</span>set_mset <span class="main">(</span>image_mset vars_lit <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vars_clause_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term clause list <span class="main">⇒</span> <span class="tfree">'v</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars_clause_list</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">=</span> Union <span class="main">(</span>vars_clause <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vars_partitioned</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> term clause list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars_partitioned</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">⟷</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="main">(</span>vars_clause <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> vars_clause <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_clause_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆#</span> <span class="free">C</span> <span class="main">⟹</span> vars_clause <span class="free">S</span> <span class="main">⊆</span> vars_clause <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vars_clause_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> substitution_ops <span class="quoted"><span class="quoted">"<span class="main">(⋅)</span>"</span></span> <span class="quoted">Var</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(∘<span class="hidden">⇩</span><sub>s</sub>)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_atm_is_ground_on_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="main">(</span><span class="free">A</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> vars_term <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="main">(</span><span class="free">σ</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_ground_atm_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_lit_is_ground_on_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ground_lit<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_lit <span class="main">(</span>subst_lit <span class="free">L</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_in_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> vars_lit <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="main">(</span><span class="free">σ</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"atm_of <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> v_in_L <span class="keyword1"><span class="command">have</span></span> A_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> vars_term <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="main">(</span><span class="var">?A</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_lit <span class="keyword1"><span class="command">unfolding</span></span> is_ground_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> A_p is_ground_atm_is_ground_on_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_cls_is_ground_on_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ground_clause<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="main">(</span>subst_cls <span class="free">C</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    v_in_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> vars_clause <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="main">(</span><span class="free">σ</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> v_in_C <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> L_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> vars_lit <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vars_clause_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ground_lit <span class="main">(</span>subst_lit <span class="skolem">L</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_clause <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_def subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> L_p is_ground_lit_is_ground_on_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_cls_list_is_ground_on_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ground_list<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls_list <span class="main">(</span>subst_cls_list <span class="free">Cs</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> v_in_Cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> vars_clause_list <span class="free">Cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="main">(</span><span class="free">σ</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> v_in_Cs <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> set <span class="free">Cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> vars_clause <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vars_clause_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="main">(</span>subst_cls <span class="skolem">C</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_list <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_list_def subst_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> C_p is_ground_cls_is_ground_on_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_on_vars_lit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> vars_lit <span class="free">L</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">τ</span> <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_lit <span class="free">L</span> <span class="free">σ</span> <span class="main">=</span> subst_lit <span class="free">L</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pos <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> vars_term <span class="skolem">x</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">τ</span> <span class="bound">v</span> <span class="main">⟹</span> subst_atm_abbrev <span class="skolem">x</span> <span class="free">σ</span> <span class="main">=</span> subst_atm_abbrev <span class="skolem">x</span> <span class="free">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_subst_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_lit_def <span class="keyword1"><span class="command">using</span></span> Pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> vars_term <span class="skolem">x</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">τ</span> <span class="bound">v</span> <span class="main">⟹</span> subst_atm_abbrev <span class="skolem">x</span> <span class="free">σ</span> <span class="main">=</span> subst_atm_abbrev <span class="skolem">x</span> <span class="free">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_subst_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_lit_def <span class="keyword1"><span class="command">using</span></span> Neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_list_of_mset_in_S<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>list_of_mset <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_of_mset <span class="free">S</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈#</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_of_mset <span class="free">S</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>list_of_mset <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_of_mset <span class="free">S</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈#</span> mset <span class="main">(</span>list_of_mset <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_multiset_in_set<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_on_vars_clause<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> vars_clause <span class="free">S</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">τ</span> <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_cls <span class="free">S</span> <span class="free">σ</span> <span class="main">=</span> subst_cls <span class="free">S</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> assms image_eqI image_mset_cong2 mem_simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> same_on_vars_lit set_image_mset
      subst_cls_def vars_clause_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_partitioned_var_disjoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vars_partitioned <span class="free">Cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"var_disjoint <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> var_disjoint_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> term<span class="main">)</span> list›</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">σs</span> <span class="main">=</span> length <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> vars_partitioned_def<span class="main">]</span> Fun_More.fun_merge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map vars_clause <span class="free">Cs</span>"</span></span> <span class="quoted"><span class="quoted">"nth <span class="skolem">σs</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    σ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>map vars_clause <span class="free">Cs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> map vars_clause <span class="free">Cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆#</span> <span class="free">Cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⟶</span> subst_cls <span class="bound">S</span> <span class="main">(</span><span class="skolem">σs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> subst_cls <span class="bound">S</span> <span class="skolem">σ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> term literal multiset"</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">Cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆#</span> <span class="free">Cs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> vars_clause <span class="skolem">S</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="bound">v</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="bound">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vars_clause_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">]</span> σ_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst_cls <span class="skolem">S</span> <span class="main">(</span><span class="skolem">σs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> subst_cls <span class="skolem">S</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> same_on_vars_clause <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆#</span> <span class="free">Cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⟶</span> subst_cls <span class="bound">S</span> <span class="main">(</span><span class="skolem">σs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> subst_cls <span class="bound">S</span> <span class="bound">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_in_instance_in_range_term<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_term <span class="main">(</span>subst_atm_abbrev <span class="free">A</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊆</span> Union <span class="main">(</span>image vars_term <span class="main">(</span>range <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_in_instance_in_range_lit<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_lit <span class="main">(</span>subst_lit <span class="free">L</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊆</span> Union <span class="main">(</span>image vars_term <span class="main">(</span>range <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pos <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_term <span class="main">(</span><span class="skolem">A</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊆</span> Union <span class="main">(</span>image vars_term <span class="main">(</span>range <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars_in_instance_in_range_term<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_term <span class="main">(</span><span class="skolem">A</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊆</span> Union <span class="main">(</span>image vars_term <span class="main">(</span>range <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars_in_instance_in_range_term<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_in_instance_in_range_cls<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>subst_cls <span class="free">C</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊆</span> Union <span class="main">(</span>image vars_term <span class="main">(</span>range <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vars_clause_def subst_cls_def <span class="keyword1"><span class="command">using</span></span> vars_in_instance_in_range_lit<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">renamings_apart</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> nat<span class="main">)</span> term clause list <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> nat<span class="main">)</span> subst<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">renamings_apart</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">renamings_apart</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">σs</span> <span class="main">=</span> <span class="free">renamings_apart</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Var <span class="main">(</span><span class="bound">v</span> <span class="main">+</span> Max <span class="main">(</span>vars_clause_list <span class="main">(</span>subst_cls_lists <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="bound">σs</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="bound">σs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">var_map_of_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> nat<span class="main">)</span> subst <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">var_map_of_subst</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> the_Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> len_renamings_apart<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>renamings_apart <span class="free">Cs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> renamings_apart_is_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span> <span class="main">∈</span> set <span class="main">(</span>renamings_apart <span class="free">Cs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> is_Var <span class="main">(</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> renamings_apart_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span> <span class="main">∈</span> set <span class="main">(</span>renamings_apart <span class="free">Cs</span><span class="main">)</span><span class="main">.</span> inj <span class="bound">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">Cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Var <span class="main">(</span>Suc <span class="main">(</span><span class="bound">v</span> <span class="main">+</span> Max <span class="main">(</span>vars_clause_list
               <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> add_right_imp_eq injI nat.inject term.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_vars_clause<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>vars_clause <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vars_clause_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_vars_clause_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>vars_clause_list <span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vars_clause_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Suc_Max_notin_set<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> Suc <span class="main">(</span><span class="free">v</span> <span class="main">+</span> Max <span class="main">(</span>insert <span class="main">0</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max.boundedE Suc_n_not_le_n empty_iff finite.insertI le_add2 vimageE vimageI
      vimage_Suc_insert_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_partitioned_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars_partitioned <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vars_partitioned_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_lists_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_cls_lists <span class="free">Cs</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_clause_hd_partitioned_from_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="main">≠</span><span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>hd <span class="main">(</span>subst_cls_lists <span class="free">Cs</span> <span class="main">(</span>renamings_apart <span class="free">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∩</span> vars_clause_list <span class="main">(</span>tl <span class="main">(</span>subst_cls_lists <span class="free">Cs</span> <span class="main">(</span>renamings_apart <span class="free">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">C</span> <span class="skolem">Cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span>Suc <span class="main">(</span><span class="bound">v</span> <span class="main">+</span> Max <span class="main">(</span><span class="main">(</span>vars_clause_list <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span>
                        <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> term"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Var <span class="main">(</span><span class="skolem">σ'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>subst_cls <span class="skolem">C</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>vars_term <span class="main">`</span> range <span class="skolem">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars_in_instance_in_range_cls<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> σ_def σ'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>vars_term <span class="main">`</span> range <span class="skolem">σ</span><span class="main">)</span>
    <span class="main">∩</span> vars_clause_list <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="skolem">σ'</span> <span class="main">∩</span> vars_clause_list <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> σ'_def <span class="keyword1"><span class="command">using</span></span> Suc_Max_notin_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> σ_def σ'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>subst_cls <span class="skolem">C</span> <span class="skolem">σ</span><span class="main">)</span>
     <span class="main">∩</span> vars_clause_list <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> σ_def σ'_def <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def subst_cls_lists_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_partitioned_renamings_apart<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_partitioned <span class="main">(</span>subst_cls_lists <span class="free">Cs</span> <span class="main">(</span>renamings_apart <span class="free">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">C</span> <span class="skolem">Cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">Cs</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∩</span>
        vars_clause <span class="main">(</span>subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j'</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> i'j'<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">j'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∩</span>
        vars_clause <span class="main">(</span>subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> i'j'<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">i'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> disjoin_C_Cs<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">∩</span>
        vars_clause_list <span class="main">(</span><span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vars_clause_hd_partitioned_from_tl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def subst_cls_lists_def<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_clause <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>
          <span class="main">∈</span> set <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i'j' ij <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_less_SucD length_map len_renamings_apart length_zip min_less_iff_conj
              nth_mem<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_clause <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i'j' ij
          <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span> <span class="main">∈</span> set <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> vars_clause <span class="bound">D</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>
        <span class="main">⊆</span> Union <span class="main">(</span>set <span class="main">(</span>map vars_clause <span class="main">(</span><span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">∩</span>
        vars_clause <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disjoin_C_Cs <span class="keyword1"><span class="command">unfolding</span></span> vars_clause_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span>
        subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i'j' ij <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∩</span>
        vars_clause <span class="main">(</span>subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i'j' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">j'</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> i'j'<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">i'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">j'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span><span class="main">&lt;</span>length <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ij i'j' <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_renamings_apart<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span><span class="main">&lt;</span>length <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ij i'j' <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_renamings_apart<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">j'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">j'</span>›</span></span> ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">∩</span>
          vars_clause <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> vars_partitioned_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∩</span>
        vars_clause <span class="main">(</span>subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> i'j'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_cls_lists_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹vars_clause <span class="main">(</span>subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∩</span>
        vars_clause <span class="main">(</span>subst_cls_lists <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">(</span>renamings_apart <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vars_partitioned_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Int_commute Suc_lessI len_renamings_apart length_map
        length_nth_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_zip min.idem nat.inject not_less_eq subst_cls_lists_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> substitution <span class="quoted"><span class="quoted">"<span class="main">(⋅)</span>"</span></span> <span class="quoted"><span class="quoted">"Var <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> nat<span class="main">)</span> term"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(∘<span class="hidden">⇩</span><sub>s</sub>)</span>"</span></span> <span class="quoted">renamings_apart</span> <span class="quoted"><span class="quoted">"Fun undefined"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⋅</span> Var <span class="main">=</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">τ</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⋅</span> <span class="bound">τ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">σ</span> <span class="main">=</span> <span class="bound">A</span> <span class="main">⋅</span> <span class="bound">τ</span> <span class="main">⋅</span> <span class="bound">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> <span class="bound">A</span> <span class="main">⋅</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">σ</span> <span class="main">=</span> <span class="bound">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_term_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> nat<span class="main">)</span> term clause"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="main">(</span>subst_cls <span class="skolem">C</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ground_atms_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> vars_clause <span class="skolem">C</span> <span class="main">⟹</span> is_ground_atm <span class="main">(</span><span class="skolem">σ</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> is_ground_cls_is_ground_on_var<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">some_ground_trm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> nat<span class="main">)</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">some_ground_trm</span> <span class="main">=</span> <span class="main">(</span>Fun undefined <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ground_trm<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="skolem">some_ground_trm</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_ground_atm_def some_ground_trm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">∈</span> vars_clause <span class="skolem">C</span> <span class="keyword1">then</span> <span class="skolem">σ</span> <span class="bound">v</span> <span class="keyword1">else</span> <span class="skolem">some_ground_trm</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> τ_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> vars_clause <span class="skolem">C</span><span class="main">.</span> <span class="skolem">σ</span> <span class="bound">v</span> <span class="main">=</span> <span class="skolem">τ</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> τ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> all_ground_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="main">(</span><span class="skolem">τ</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> vars_clause <span class="skolem">C</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ground_atms_σ τ_σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> τ_def <span class="keyword1"><span class="command">using</span></span> ground_trm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_ground_subst_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="main">(</span>subst_atm_abbrev <span class="skolem">A</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">A</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> all_ground_τ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">As</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> all_ground_τ
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ground_atm_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> vars_clause <span class="skolem">C</span><span class="main">.</span> <span class="skolem">σ</span> <span class="bound">v</span> <span class="main">=</span> <span class="skolem">τ</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> τ_σ <span class="keyword1"><span class="command">unfolding</span></span> vars_clause_list_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_cls <span class="skolem">C</span> <span class="skolem">σ</span> <span class="main">=</span> subst_cls <span class="skolem">C</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> same_on_vars_clause <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> is_ground_subst <span class="bound">τ</span> <span class="main">∧</span> subst_cls <span class="skolem">C</span> <span class="bound">τ</span> <span class="main">=</span> subst_cls <span class="skolem">C</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> nat<span class="main">)</span> term clause list"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">Cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_renamings_apart <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> nat<span class="main">)</span> term clause list"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> nat<span class="main">)</span> Term.term"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ρ_renaming<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> set <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> inj_is_renaming<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> nat<span class="main">)</span> subst<span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> is_Var <span class="main">(</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> inj <span class="bound">σ</span> <span class="main">⟹</span> is_renaming <span class="bound">σ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> nat<span class="main">)</span> subst"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> is_var_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> is_Var <span class="main">(</span><span class="skolem">σ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> inj_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="skolem">σ</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">=</span> var_map_of_subst <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> Var <span class="main">∘</span> <span class="skolem">σ'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> σ'_def var_map_of_subst_def <span class="keyword1"><span class="command">using</span></span> is_var_σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">from</span></span> is_var_σ inj_σ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj <span class="skolem">σ'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> is_renaming_def <span class="keyword1"><span class="command">unfolding</span></span> subst_domain_def inj_on_def σ'_def var_map_of_subst_def
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> term.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv <span class="skolem">σ'</span> <span class="main">∘</span> <span class="skolem">σ'</span> <span class="main">=</span> id"</span></span>
        <span class="keyword1"><span class="command">using</span></span> inv_o_cancel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Var <span class="main">∘</span> <span class="main">(</span>inv <span class="skolem">σ'</span> <span class="main">∘</span> <span class="skolem">σ'</span><span class="main">)</span> <span class="main">=</span> Var"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Var <span class="main">∘</span> <span class="main">(</span>inv <span class="skolem">σ'</span> <span class="main">∘</span> <span class="skolem">σ'</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Var <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Var <span class="main">∘</span> <span class="skolem">σ'</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>Var <span class="main">∘</span> <span class="main">(</span>inv <span class="skolem">σ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Var <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> subst_compose_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>Var <span class="main">∘</span> <span class="main">(</span>inv <span class="skolem">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Var"</span></span>
        <span class="keyword1"><span class="command">using</span></span> σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_renaming <span class="skolem">σ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> is_renaming_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> is_renaming <span class="bound">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> renamings_apart_is_Var renamings_apart_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_renaming <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ρ_renaming <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> nat<span class="main">)</span> term clause list"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_partitioned <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars_partitioned_renamings_apart <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"var_disjoint <span class="main">(</span>subst_cls_lists <span class="skolem">Cs</span> <span class="main">(</span>renamings_apart <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars_partitioned_var_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">As</span> <span class="bound">Bs</span><span class="main">.</span> Fun undefined <span class="bound">As</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> Fun undefined <span class="bound">Bs</span> <span class="main">⟷</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⋅</span> <span class="bound">σ</span><span class="main">)</span> <span class="bound">As</span> <span class="main">=</span> <span class="bound">Bs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span>strictly_generalizes_atm <span class="main">::</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wfP_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_subsumes<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strictly_generalizes_atm_def generalizes_atm_def term_subsumable.subsumes_def
        subsumeseq_term.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pairs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">pairs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">pairs</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">derive</span></span> compare <span class="quoted"><span class="quoted">"term"</span></span>
<span class="keyword1"><span class="command">derive</span></span> compare <span class="quoted"><span class="quoted">"literal"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> class_linorder_compare<span class="main">:</span> <span class="quoted"><span class="quoted">"class.linorder <span class="main">(</span>le_of_comp compare<span class="main">)</span> <span class="main">(</span>lt_of_comp compare<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lt_of_comp_def le_of_comp_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> comparator.sym comparator_compare invert_order.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> order.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> comparator_compare comparator_def order.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> comparator.sym comparator_compare invert_order.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> order.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comparator.sym comparator_compare invert_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> compare_linorder<span class="main">:</span> linorder
  <span class="quoted"><span class="quoted">"le_of_comp compare"</span></span>
  <span class="quoted"><span class="quoted">"lt_of_comp compare"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> class_linorder_compare<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Pairs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Pairs</span> <span class="free"><span class="bound"><span class="entity">AAA</span></span></span> <span class="main">=</span> concat <span class="main">(</span>compare_linorder.sorted_list_of_set
     <span class="main">(</span><span class="main">(</span>pairs <span class="main">∘</span> compare_linorder.sorted_list_of_set<span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">AAA</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unifies_all_pairs_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>pairs <span class="free">xs</span><span class="main">)</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> snd <span class="bound">p</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pairs.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pairs.simps list.set ball_Un ball_simps simp_thms fst_conv snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> in_pair_in_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="main">(</span>pairs <span class="free">As</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="free">As</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">∈</span> set <span class="free">As</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">As</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">A</span> <span class="skolem">As</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Cons_outer <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">As</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons_outer <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">B</span> <span class="skolem">As'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons_outer <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_pairs_sorted_list_of_set_in_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">AAA</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">AA</span> <span class="main">∈</span> <span class="free">AAA</span><span class="main">.</span> finite <span class="bound">AA</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">AB_pairs</span> <span class="main">∈</span> <span class="main">(</span>pairs <span class="main">∘</span> compare_linorder.sorted_list_of_set<span class="main">)</span> <span class="main">`</span> <span class="free">AAA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="main">_</span> <span class="main">::</span> compare<span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">AB_pairs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">AA</span><span class="main">.</span> <span class="bound">AA</span> <span class="main">∈</span> <span class="free">AAA</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">∈</span> <span class="bound">AA</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">∈</span> <span class="bound">AA</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">AB_pairs</span> <span class="main">∈</span> <span class="main">(</span>pairs <span class="main">∘</span> compare_linorder.sorted_list_of_set<span class="main">)</span> <span class="main">`</span> <span class="free">AAA</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AA</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    AA_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">∈</span> <span class="free">AAA</span> <span class="main">∧</span> <span class="main">(</span>pairs <span class="main">∘</span> compare_linorder.sorted_list_of_set<span class="main">)</span> <span class="skolem">AA</span> <span class="main">=</span> <span class="free">AB_pairs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>pairs <span class="main">(</span>compare_linorder.sorted_list_of_set <span class="skolem">AA</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AA_p<span class="main">[</span><span class="main">]</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="main">(</span>compare_linorder.sorted_list_of_set <span class="skolem">AA</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> set <span class="main">(</span>compare_linorder.sorted_list_of_set <span class="skolem">AA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_pair_in_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> AA_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unifiers_Pairs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">AAA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">AA</span> <span class="main">∈</span> <span class="free">AAA</span><span class="main">.</span> finite <span class="bound">AA</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unifiers <span class="main">(</span>set <span class="main">(</span>Pairs <span class="free">AAA</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> is_unifiers <span class="bound">σ</span> <span class="free">AAA</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> subst"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> unifiers <span class="main">(</span>set <span class="main">(</span>Pairs <span class="free">AAA</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">AA</span><span class="main">.</span> <span class="bound">AA</span> <span class="main">∈</span> <span class="free">AAA</span> <span class="main">⟹</span> card <span class="main">(</span><span class="bound">AA</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">AA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> term set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> asm'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">∈</span> <span class="free">AAA</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>pairs <span class="main">(</span>compare_linorder.sorted_list_of_set <span class="skolem">AA</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      subst_atm_abbrev <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span> subst_atm_abbrev <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms asm <span class="keyword1"><span class="command">unfolding</span></span> Pairs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="skolem">AA</span><span class="main">.</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="skolem">AA</span><span class="main">.</span> subst_atm_abbrev <span class="bound">A</span> <span class="skolem">σ</span> <span class="main">=</span> subst_atm_abbrev <span class="bound">B</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms asm' <span class="keyword1"><span class="command">unfolding</span></span> unifies_all_pairs_iff
      <span class="keyword1"><span class="command">using</span></span> compare_linorder.sorted_list_of_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">AA</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> imageE card.empty card_Suc_eq card_mono finite.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_insert le_SucI
           singletonI subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> is_unifiers <span class="bound">σ</span> <span class="free">AAA</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_unifiers_def is_unifier_def subst_atms_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> subst"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> is_unifiers <span class="bound">σ</span> <span class="free">AAA</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">AB_pairs</span> <span class="skolem">A</span> <span class="skolem">B</span>
    <span class="keyword3"><span class="command">assume</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">AB_pairs</span> <span class="main">∈</span> set <span class="main">(</span>compare_linorder.sorted_list_of_set
         <span class="main">(</span><span class="main">(</span>pairs <span class="main">∘</span> compare_linorder.sorted_list_of_set<span class="main">)</span> <span class="main">`</span> <span class="free">AAA</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">AB_pairs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">AA</span><span class="main">.</span> <span class="bound">AA</span> <span class="main">∈</span> <span class="free">AAA</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">∈</span> <span class="bound">AA</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">∈</span> <span class="bound">AA</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_pairs_sorted_list_of_set_in_set<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AA</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">∈</span> <span class="free">AAA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="skolem">AA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="skolem">AA</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> a assms asm <span class="keyword1"><span class="command">have</span></span> card_AA_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">AA</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_unifiers_def is_unifier_def subst_atms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_atm_abbrev <span class="skolem">A</span> <span class="skolem">σ</span> <span class="main">=</span> subst_atm_abbrev <span class="skolem">B</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">AA</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_atm_abbrev <span class="skolem">A</span> <span class="skolem">σ</span> <span class="main">∈</span> <span class="skolem">AA</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">σ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a assms asm card_AA_σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_atm_abbrev <span class="skolem">B</span> <span class="skolem">σ</span> <span class="main">∈</span> <span class="skolem">AA</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">σ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a assms asm card_AA_σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> a assms asm card_AA_σ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> card_Suc_eq singletonD<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">AA</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a assms asm card_AA_σ
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> a assms asm card_AA_σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> unifiers <span class="main">(</span>set <span class="main">(</span>Pairs <span class="free">AAA</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Pairs_def unifiers_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mgu_sets</span> <span class="free"><span class="bound"><span class="entity">AAA</span></span></span> <span class="main">=</span> map_option subst_of <span class="main">(</span>unify <span class="main">(</span>Pairs <span class="free"><span class="bound"><span class="entity">AAA</span></span></span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> mgu <span class="quoted"><span class="quoted">"<span class="main">(⋅)</span>"</span></span> <span class="quoted"><span class="quoted">"Var <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span> <span class="main">::</span> compare<span class="main">,</span> nat<span class="main">)</span> term"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(∘<span class="hidden">⇩</span><sub>s</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"Fun undefined"</span></span>
  <span class="quoted">renamings_apart</span> <span class="quoted">mgu_sets</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">AAA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> compare<span class="main">,</span> nat<span class="main">)</span> term set set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> subst"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">AAA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">AA</span> <span class="main">∈</span> <span class="skolem">AAA</span><span class="main">.</span> finite <span class="bound">AA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mgu_sets <span class="skolem">AAA</span> <span class="main">=</span> Some <span class="skolem">σ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_imgu <span class="skolem">σ</span> <span class="main">(</span>set <span class="main">(</span>Pairs <span class="skolem">AAA</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unify_sound <span class="keyword1"><span class="command">unfolding</span></span> mgu_sets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_mgu <span class="skolem">σ</span> <span class="skolem">AAA</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_imgu_def is_mgu_def unifiers_Pairs<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">AAA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> compare<span class="main">,</span> nat<span class="main">)</span> term set set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> subst"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">AAA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">AA</span> <span class="main">∈</span> <span class="skolem">AAA</span><span class="main">.</span> finite <span class="bound">AA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_unifiers <span class="skolem">σ</span> <span class="skolem">AAA</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> unifiers <span class="main">(</span>set <span class="main">(</span>Pairs <span class="skolem">AAA</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_mgu_def unifiers_Pairs<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> mgu_sets <span class="skolem">AAA</span> <span class="main">=</span> Some <span class="bound">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unify_complete <span class="keyword1"><span class="command">unfolding</span></span> mgu_sets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">prod</span>
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">list</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This part extends and integrates and the Knuth--Bendix order defined in
\textsf{IsaFoR}.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'f</span> weights <span class="main">=</span>
  w <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> nat"</span></span>
  w0 <span class="main">::</span> <span class="quoted">nat</span>
  pr_strict <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span>
  least <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">⇒</span> bool"</span></span>
  scf <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span>

<span class="keyword1"><span class="command">class</span></span> weighted <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">weights</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> weights"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> weights_adm<span class="main">:</span>
    <span class="quoted"><span class="quoted">"admissible_kbo
       <span class="main">(</span>w <span class="free">weights</span><span class="main">)</span> <span class="main">(</span>w0 <span class="free">weights</span><span class="main">)</span> <span class="main">(</span>pr_strict <span class="free">weights</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>pr_strict <span class="free">weights</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span><span class="main">)</span> <span class="main">(</span>least <span class="free">weights</span><span class="main">)</span> <span class="main">(</span>scf <span class="free">weights</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pr_strict_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fi</span> <span class="main">=</span> <span class="free">gj</span> <span class="main">∨</span> pr_strict <span class="free">weights</span> <span class="free">fi</span> <span class="free">gj</span> <span class="main">∨</span> pr_strict <span class="free">weights</span> <span class="free">gj</span> <span class="free">fi</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pr_strict_asymp<span class="main">:</span> <span class="quoted"><span class="quoted">"asymp <span class="main">(</span>pr_strict <span class="free">weights</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> scf_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> scf <span class="free">weights</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> unit <span class="main">::</span> <span class="quoted">weighted</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">weights_unit</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit weights"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">weights_unit</span> <span class="main">=</span>
  <span class="main">⦇</span>w <span class="main">=</span> Suc <span class="main">∘</span> snd<span class="main">,</span> w0 <span class="main">=</span> <span class="main">1</span><span class="main">,</span> pr_strict <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="bound">m</span><span class="main">,</span> least <span class="main">=</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">,</span> scf <span class="main">=</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weights_unit_def SN_iff_wf asymp.simps irreflp_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_inv_image<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> wf<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">snd</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> KBO<span class="main">:</span>
  admissible_kbo
    <span class="quoted"><span class="quoted">"w <span class="main">(</span>weights <span class="main">::</span> <span class="tfree">'f</span> <span class="main">::</span> weighted weights<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"w0 <span class="main">(</span>weights <span class="main">::</span> <span class="tfree">'f</span> <span class="main">::</span> weighted weights<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"pr_strict weights"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>pr_strict weights<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"least weights"</span></span> <span class="quoted"><span class="quoted">"scf weights"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> weight <span class="main">=</span> <span class="quoted">KBO.weight</span>
    <span class="keyword2"><span class="keyword">and</span></span> kbo <span class="main">=</span> <span class="quoted">KBO.kbo</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weights_adm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> kbo_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"kbo <span class="free">s</span> <span class="free">t</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">wt</span> <span class="main">=</span> weight <span class="free">t</span><span class="main">;</span> <span class="bound">ws</span> <span class="main">=</span> weight <span class="free">s</span> <span class="keyword1">in</span>
  <span class="keyword1">if</span> vars_term_ms <span class="main">(</span>KBO.SCF <span class="free">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>KBO.SCF <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">wt</span> <span class="main">≤</span> <span class="bound">ws</span>
  <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="bound">wt</span> <span class="main">&lt;</span> <span class="bound">ws</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free">s</span> <span class="keyword1">of</span>
        Var <span class="bound">y</span> <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span> Var <span class="bound">x</span> <span class="main">⇒</span> True <span class="main">|</span> Fun <span class="bound">g</span> <span class="bound">ts</span> <span class="main">⇒</span> <span class="bound">ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> least weights <span class="bound">g</span><span class="main">)</span>
      <span class="main">|</span> Fun <span class="bound">f</span> <span class="bound">ss</span> <span class="main">⇒</span>
          <span class="main">(</span><span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span>
            Var <span class="bound">x</span> <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
          <span class="main">|</span> Fun <span class="bound">g</span> <span class="bound">ts</span> <span class="main">⇒</span>
              <span class="keyword1">if</span> pr_strict weights <span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
              <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span> <span class="keyword1">then</span> lex_ext_unbounded kbo <span class="bound">ss</span> <span class="bound">ts</span>
              <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> KBO.kbo.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">less_kbo</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> fst <span class="main">(</span>kbo <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_kbo_gtotal<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">s</span> <span class="main">⟹</span> ground <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∨</span> less_kbo <span class="free">s</span> <span class="free">t</span> <span class="main">∨</span> less_kbo <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_kbo_def <span class="keyword1"><span class="command">using</span></span> KBO.S_ground_total <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pr_strict_total subset_UNIV<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_kbo_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span> <span class="main">::</span> weighted<span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"less_kbo <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> less_kbo <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_kbo_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> KBO.S_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wfP_less_kbo<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP less_kbo"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>kbo <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pr_strict_asymp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> asymp.simps irreflp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> KBO.S_SN scf_ok<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SN_iff_wf wfP_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_kbo_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"term"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">weighted</span><span class="main">,</span> <span class="quoted">type</span><span class="main">)</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">leq_term</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">leq</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> less_kbo <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">leq</span> <span class="main">∧</span> Well_order <span class="bound">leq</span> <span class="main">∧</span> Field <span class="bound">leq</span> <span class="main">=</span> UNIV<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_trm_extension<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> less_kbo <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span> <span class="main">⊆</span> leq_term"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> leq_term_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> total_well_order_extension<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wfP_less_kbo<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wfP_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> less_trm_well_order<span class="main">:</span> <span class="quoted"><span class="quoted">"well_order leq_term"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> leq_term_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> total_well_order_extension<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wfP_less_kbo<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wfP_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_term</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> weighted<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq_term</span> <span class="main">=</span> in_rel leq_term"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_term</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> weighted<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_term</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> strict <span class="main">(≤)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> leq_term_minus_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"leq_term <span class="main">-</span> Id <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_trm_well_order
  <span class="keyword1"><span class="command">unfolding</span></span> well_order_on_def linear_order_on_def partial_order_on_def antisym_def less_term_def less_eq_term_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> less_term_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span> <span class="main">=</span> in_rel <span class="main">(</span>leq_term <span class="main">-</span> Id<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_rel_Collect_case_prod_eq leq_term_minus_Id<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> less_less_eq refl trans antisym total<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less_less_eq <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> less_term_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>refl <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> less_trm_well_order
    <span class="keyword1"><span class="command">unfolding</span></span> well_order_on_def linear_order_on_def partial_order_on_def preorder_on_def refl_on_def
      less_eq_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>trans <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> less_trm_well_order
    <span class="keyword1"><span class="command">unfolding</span></span> well_order_on_def linear_order_on_def partial_order_on_def preorder_on_def trans_def
      less_eq_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>antisym <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> less_trm_well_order
    <span class="keyword1"><span class="command">unfolding</span></span> well_order_on_def linear_order_on_def partial_order_on_def antisym_def
      less_eq_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>total <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> less_trm_well_order
    <span class="keyword1"><span class="command">unfolding</span></span> well_order_on_def linear_order_on_def partial_order_on_def preorder_on_def refl_on_def
      Relation.total_on_def less_eq_term_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"term"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">weighted</span><span class="main">,</span> <span class="quoted">type</span><span class="main">)</span> <span class="quoted">wellorder</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_trm_well_order<span class="main">[</span><span class="operator">unfolded</span> well_order_on_def wf_def leq_term_minus_Id<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ground_less_less_kbo<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">s</span> <span class="main">⟹</span> ground <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">&lt;</span> <span class="free">t</span> <span class="main">⟹</span> less_kbo <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_kbo_gtotal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> less_trm_extension
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_term_def less_eq_term_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_kbo_less<span class="main">:</span> <span class="quoted"><span class="quoted">"less_kbo <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_trm_extension
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_term_alt less_kbo_def KBO.S_irrefl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_atm_ground<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="free">t</span> <span class="main">⟷</span> ground <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_atm_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth list_eq_iff_nth_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Executable_Subsumption">
<div class="head">
<h1>Theory Executable_Subsumption</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       An Executable Algorithm for Clause Subsumption
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2017
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹An Executable Algorithm for Clause Subsumption›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory provides an executable functional implementation of clause
subsumption, building on the \textsf{IsaFoR} library.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Executable_Subsumption
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="IsaFoR_Term.html">IsaFoR_Term</a>
    <a href="../First_Order_Terms/Matching.html">First_Order_Terms.Matching</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Naive Implementation of Clause Subsumption›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subsumes_list</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subsumes_list</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">Ks</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subsumes_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Ls</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ks</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="main">∃</span><span class="bound">K</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">Ks</span></span></span><span class="main">.</span> is_pos <span class="bound">K</span> <span class="main">=</span> is_pos <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span>
       <span class="main">(</span><span class="keyword1">case</span> match_term_list <span class="main">[</span><span class="main">(</span>atm_of <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">,</span> atm_of <span class="bound">K</span><span class="main">)</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">of</span>
         None <span class="main">⇒</span> False
       <span class="main">|</span> Some <span class="bound">ρ</span> <span class="main">⇒</span> <span class="free">subsumes_list</span> <span class="free"><span class="bound"><span class="entity">Ls</span></span></span> <span class="main">(</span>remove1 <span class="bound">K</span> <span class="free"><span class="bound"><span class="entity">Ks</span></span></span><span class="main">)</span> <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atm_of_map_literal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atm_of <span class="main">(</span>map_literal <span class="free">f</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>atm_of <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">extends_subst</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extends_subst_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extends_subst <span class="free">σ</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extends_subst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> extends_subst_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"extends_subst <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> extends_subst <span class="free">τ</span> <span class="free">ρ</span> <span class="main">⟹</span> extends_subst <span class="free">σ</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extends_subst_def dom_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extends_subst_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"extends_subst <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> dom <span class="free">σ</span> <span class="main">⊆</span> dom <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extends_subst_def dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> extends_subst_extends<span class="main">:</span> <span class="quoted"><span class="quoted">"extends_subst <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> dom <span class="free">σ</span> <span class="main">⟹</span> <span class="free">τ</span> <span class="free">x</span> <span class="main">=</span> <span class="free">σ</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extends_subst_def dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> extends_subst_fun_upd_new<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">x</span> <span class="main">=</span> None <span class="main">⟹</span> extends_subst <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">τ</span> <span class="main">⟷</span> extends_subst <span class="free">σ</span> <span class="free">τ</span> <span class="main">∧</span> <span class="free">τ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extends_subst_def dom_fun_upd subst_of_map_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extends_subst_fun_upd_matching<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">t</span> <span class="main">⟹</span> extends_subst <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">τ</span> <span class="main">⟷</span> extends_subst <span class="free">σ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extends_subst_def dom_fun_upd subst_of_map_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extends_subst_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extends_subst Map.empty <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extends_subst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> extends_subst_cong_term<span class="main">:</span>
  <span class="quoted"><span class="quoted">"extends_subst <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> vars_term <span class="free">t</span> <span class="main">⊆</span> dom <span class="free">σ</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⋅</span> subst_of_map Var <span class="free">σ</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> subst_of_map Var <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extends_subst_def subst_of_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> term_subst_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extends_subst_cong_lit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"extends_subst <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> vars_lit <span class="free">L</span> <span class="main">⊆</span> dom <span class="free">σ</span> <span class="main">⟹</span> <span class="free">L</span> <span class="keyword1">⋅lit</span> subst_of_map Var <span class="free">σ</span> <span class="main">=</span> <span class="free">L</span> <span class="keyword1">⋅lit</span> subst_of_map Var <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extends_subst_cong_term<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subsumes_modulo</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> dom <span class="bound">τ</span> <span class="main">=</span> vars_clause <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∪</span> dom <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">∧</span> extends_subst <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">τ</span> <span class="main">∧</span> subst_cls <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>subst_of_map Var <span class="bound">τ</span><span class="main">)</span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subsumes_list_modulo</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subsumes_list_modulo</span> <span class="free"><span class="bound"><span class="entity">Ls</span></span></span> <span class="free"><span class="bound"><span class="entity">Ks</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> subsumes_modulo <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">Ls</span></span></span><span class="main">)</span> <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">Ks</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_clause_add_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars_clause <span class="main">(</span>add_mset <span class="free">L</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> vars_lit <span class="free">L</span> <span class="main">∪</span> vars_clause <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vars_clause_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subsumes_list_modulo_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes_list_modulo <span class="main">(</span><span class="free">L</span> <span class="main">#</span> <span class="free">Ls</span><span class="main">)</span> <span class="free">Ks</span> <span class="free">σ</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">K</span> <span class="main">∈</span> set <span class="free">Ks</span><span class="main">.</span> <span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> extends_subst <span class="free">σ</span> <span class="bound">τ</span> <span class="main">∧</span> dom <span class="bound">τ</span> <span class="main">=</span> vars_lit <span class="free">L</span> <span class="main">∪</span> dom <span class="free">σ</span> <span class="main">∧</span> <span class="free">L</span> <span class="keyword1">⋅lit</span> <span class="main">(</span>subst_of_map Var <span class="bound">τ</span><span class="main">)</span> <span class="main">=</span> <span class="bound">K</span>
     <span class="main">∧</span> subsumes_list_modulo <span class="free">Ls</span> <span class="main">(</span>remove1 <span class="bound">K</span> <span class="free">Ks</span><span class="main">)</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subsumes_modulo_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> left_right right_left<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left_right <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">L</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">⋅lit</span></span></span> subst_of_map Var <span class="skolem"><span class="skolem"><span class="skolem">τ</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span>
      exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">if</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> vars_lit <span class="free"><span class="free"><span class="free">L</span></span></span> <span class="main"><span class="main"><span class="main">∪</span></span></span> dom <span class="free"><span class="free"><span class="free">σ</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">then</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">τ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">else</span></span></span> None"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">τ</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extends_subst_def dom_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_subset_eq_iff subst_lit_def  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> extends_subst_cong_lit<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right_left <span class="skolem">K</span> <span class="skolem">τ</span> <span class="skolem">τ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">L</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">⋅lit</span></span></span> subst_of_map Var <span class="skolem"><span class="skolem"><span class="skolem">τ</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">τ'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">τ</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_subset_eq_iff subst_lit_def extends_subst_cong_lit
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> extends_subst_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decompose_Some_var_terms<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose <span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>Fun <span class="free">g</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">eqs</span> <span class="main">⟹</span>
   <span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∧</span> length <span class="free">ss</span> <span class="main">=</span> length <span class="free">ts</span> <span class="main">∧</span> <span class="free">eqs</span> <span class="main">=</span> zip <span class="free">ss</span> <span class="free">ts</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">,</span> Fun <span class="free">g</span> <span class="free">ts</span><span class="main">)</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span><span class="main">.</span> vars_term <span class="bound">t</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="free">eqs</span> <span class="main">@</span> <span class="free">P</span><span class="main">)</span><span class="main">.</span> vars_term <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> decompose_Some<span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip in_set_conv_nth Bex_def image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> match_term_list_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"match_term_list <span class="free">tus</span> <span class="free">σ</span> <span class="main">=</span> Some <span class="free">τ</span> <span class="main">⟹</span>
  extends_subst <span class="free">σ</span> <span class="free">τ</span> <span class="main">∧</span> dom <span class="free">τ</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">∈</span>set <span class="free">tus</span><span class="main">.</span> vars_term <span class="bound">t</span><span class="main">)</span> <span class="main">∪</span> dom <span class="free">σ</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span><span class="main">∈</span>set <span class="free">tus</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> subst_of_map Var <span class="free">τ</span> <span class="main">=</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">tus</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match_term_list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extends_subst_fun_upd_new extends_subst_fun_upd_matching
      subst_of_map_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> extends_subst_extends <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">g</span> <span class="skolem">ts</span> <span class="skolem">P</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eqs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"decompose <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">eqs</span>"</span></span>
    <span class="quoted"><span class="quoted">"match_term_list <span class="main">(</span><span class="skolem">eqs</span> <span class="main">@</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> decompose_Some_var_terms<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> extend dom subst<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> subst
    <span class="keyword1"><span class="command">from</span></span> subst<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 6 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth list_eq_iff_nth_eq Ball_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> match_term_list_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"match_term_list <span class="free">tus</span> <span class="free">σ</span> <span class="main">=</span> None <span class="main">⟹</span>
   extends_subst <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> dom <span class="free">τ</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">∈</span>set <span class="free">tus</span><span class="main">.</span> vars_term <span class="bound">t</span><span class="main">)</span> <span class="main">∪</span> dom <span class="free">σ</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span><span class="main">∈</span>set <span class="free">tus</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> subst_of_map Var <span class="free">τ</span> <span class="main">≠</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">tus</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match_term_list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extends_subst_fun_upd_new extends_subst_fun_upd_matching
      subst_of_map_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> extends_subst_extends <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">g</span> <span class="skolem">ts</span> <span class="skolem">P</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"decompose <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eqs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"decompose <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">eqs</span>"</span></span>
      <span class="quoted"><span class="quoted">"match_term_list <span class="main">(</span><span class="skolem">eqs</span> <span class="main">@</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this 3<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 3<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span> arg_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∪</span> dom <span class="skolem">σ</span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> decompose_Some_var_terms<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> subst<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> subst
      <span class="keyword1"><span class="command">from</span></span> subst<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> subst<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> subst<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth list_eq_iff_nth_eq Ball_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> unique_extends_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extends<span class="main">:</span> <span class="quoted"><span class="quoted">"extends_subst <span class="free">σ</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"extends_subst <span class="free">σ</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    dom<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">τ</span> <span class="main">=</span> vars_term <span class="free">t</span> <span class="main">∪</span> dom <span class="free">σ</span>"</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">ρ</span> <span class="main">=</span> vars_term <span class="free">t</span> <span class="main">∪</span> dom <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> subst_of_map Var <span class="free">ρ</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> subst_of_map Var <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">=</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="free">σ</span>"</span></span> <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="free">t</span>"</span></span> <span class="main">|</span> <span class="main">(</span>c<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">τ</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> a
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> extends <span class="keyword1"><span class="command">unfolding</span></span> extends_subst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> b
    <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> trans<span class="main">[</span><span class="operator">OF</span> dom<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dom<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_of_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> c
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subsumes_list_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subsumes_list <span class="free">Ls</span> <span class="free">Ks</span> <span class="free">σ</span> <span class="main">⟷</span> subsumes_list_modulo <span class="free">Ls</span> <span class="free">Ks</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ls</span></span> <span class="quoted"><span class="free">Ks</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subsumes_list.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">L</span> <span class="skolem">Ls</span> <span class="skolem">Ks</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subsumes_list_modulo_Cons subsumes_list.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">intro</span> bex_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> ext iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> LR RL<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LR <span class="skolem">K</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> LR<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">K</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons.IH <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match_term_list_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RL <span class="skolem">K</span> <span class="skolem">τ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"match_term_list <span class="main">[</span><span class="main">(</span>atm_of <span class="skolem">L</span><span class="main">,</span> atm_of <span class="skolem">K</span><span class="main">)</span><span class="main">]</span> <span class="skolem">σ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">with</span></span> RL <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons.IH <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match_term_list_complete<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">τ'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> RL <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> unique_extends_subst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="skolem">τ</span></span> <span class="quoted"><span class="skolem">τ'</span></span> <span class="quoted"><span class="quoted">"atm_of <span class="skolem">L</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons.IH <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match_term_list_sound<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subsumes_modulo_def subst_cls_def vars_clause_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> extends_subst_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subsumes_subsumes_list<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subsumes <span class="main">(</span>mset <span class="free">Ls</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">Ks</span><span class="main">)</span> <span class="main">=</span> subsumes_list <span class="free">Ls</span> <span class="free">Ks</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subsumes_list_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Ls</span></span> <span class="quoted"><span class="free">Ks</span></span> <span class="quoted">Map.empty</span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"subsumes <span class="main">(</span>mset <span class="free">Ls</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">Ks</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"subst_cls <span class="main">(</span>mset <span class="free">Ls</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">⊆#</span> mset <span class="free">Ks</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> vars_clause <span class="main">(</span>mset <span class="free">Ls</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="skolem">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subsumes_list_modulo <span class="free">Ls</span> <span class="free">Ks</span> Map.empty"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subsumes_modulo_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> same_on_vars_clause<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"subst_of_map Var <span class="skolem"><span class="skolem"><span class="skolem">τ</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">τ</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_of_map_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subsumes_modulo_def subst_lit_def subsumes_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_subsumes_subsumes_list<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strictly_subsumes <span class="main">(</span>mset <span class="free">Ls</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">Ks</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>subsumes_list <span class="free">Ls</span> <span class="free">Ks</span> Map.empty <span class="main">∧</span> <span class="main">¬</span> subsumes_list <span class="free">Ks</span> <span class="free">Ls</span> Map.empty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def subsumes_subsumes_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subsumes_list_filterD<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes_list <span class="free">Ls</span> <span class="main">(</span>filter <span class="free">P</span> <span class="free">Ks</span><span class="main">)</span> <span class="free">σ</span> <span class="main">⟹</span> subsumes_list <span class="free">Ls</span> <span class="free">Ks</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ls</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Ks</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">L</span> <span class="skolem">Ls</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons.IH <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_remove1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subsumes_list_filterI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">L</span> <span class="bound">K</span> <span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈</span> set <span class="free">Ls</span> <span class="main">⟹</span>
    match_term_list <span class="main">[</span><span class="main">(</span>atm_of <span class="bound">L</span><span class="main">,</span> atm_of <span class="bound">K</span><span class="main">)</span><span class="main">]</span> <span class="bound">σ</span> <span class="main">=</span> Some <span class="bound">τ</span> <span class="main">⟹</span> is_pos <span class="bound">L</span> <span class="main">=</span> is_pos <span class="bound">K</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">K</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subsumes_list <span class="free">Ls</span> <span class="free">Ks</span> <span class="free">σ</span> <span class="main">⟹</span> subsumes_list <span class="free">Ls</span> <span class="main">(</span>filter <span class="free">P</span> <span class="free">Ks</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ls</span></span> <span class="quoted"><span class="free">Ks</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subsumes_list.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">L</span> <span class="skolem">Ls</span> <span class="skolem">Ks</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subsumes_list.simps set_filter bex_simps conj_assoc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> bexE conjE<span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_remove1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons.IH<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subsumes_list_Cons_filter_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sorted_wrt<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">leq</span> <span class="main">(</span><span class="free">L</span> <span class="main">#</span> <span class="free">Ls</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"transp <span class="free">leq</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">L</span> <span class="bound">K</span> <span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span>
    match_term_list <span class="main">[</span><span class="main">(</span>atm_of <span class="bound">L</span><span class="main">,</span> atm_of <span class="bound">K</span><span class="main">)</span><span class="main">]</span> <span class="bound">σ</span> <span class="main">=</span> Some <span class="bound">τ</span> <span class="main">⟹</span> is_pos <span class="bound">L</span> <span class="main">=</span> is_pos <span class="bound">K</span> <span class="main">⟹</span> <span class="free">leq</span> <span class="bound">L</span> <span class="bound">K</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subsumes_list <span class="main">(</span><span class="free">L</span> <span class="main">#</span> <span class="free">Ls</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="free">leq</span> <span class="free">L</span><span class="main">)</span> <span class="free">Ks</span><span class="main">)</span> <span class="free">σ</span> <span class="main">⟷</span> subsumes_list <span class="main">(</span><span class="free">L</span> <span class="main">#</span> <span class="free">Ls</span><span class="main">)</span> <span class="free">Ks</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subsumes_list_filterD subsumes_list_filterI<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> list.set insert_iff
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> L K σ τ
    <span class="keyword1"><span class="command">using</span></span> sorted_wrt <span class="keyword1"><span class="command">unfolding</span></span> List.sorted_wrt.simps<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> transpD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> match<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">leq_head</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">leq_head</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>root <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> root <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>None<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> True
  <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> None<span class="main">)</span> <span class="main">⇒</span> False
  <span class="main">|</span> <span class="main">(</span>Some <span class="bound">f</span><span class="main">,</span> Some <span class="bound">g</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">f</span> <span class="main">≤</span> <span class="bound">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">leq_lit</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>Neg <span class="main"><span class="bound">_</span></span><span class="main">,</span> Pos <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> True
  <span class="main">|</span> <span class="main">(</span>Pos <span class="main"><span class="bound">_</span></span><span class="main">,</span> Neg <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> False
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> leq_head <span class="main">(</span>atm_of <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="main">(</span>atm_of <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> transp_leq_lit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transp leq_lit"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> transp_def leq_lit_def leq_head_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits literal.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reflp_leq_lit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reflp_on leq_lit <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> reflp_on_def leq_lit_def leq_head_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits literal.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> total_leq_lit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"total_on leq_lit <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> total_on_def leq_lit_def leq_head_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits literal.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leq_head_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"leq_head <span class="free">t</span> <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> leq_head_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leq_lit_match<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">L</span> <span class="free">K</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term literal"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match_term_list <span class="main">[</span><span class="main">(</span>atm_of <span class="free">L</span><span class="main">,</span> atm_of <span class="free">K</span><span class="main">)</span><span class="main">]</span> <span class="free">σ</span> <span class="main">=</span> Some <span class="free">τ</span> <span class="main">⟹</span> is_pos <span class="free">L</span> <span class="main">=</span> is_pos <span class="free">K</span> <span class="main">⟹</span> leq_lit <span class="free">L</span> <span class="free">K</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">K</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> leq_lit_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match_term_list_sound <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Optimized Implementation of Clause Subsumption›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subsumes_list_filter</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subsumes_list_filter</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">Ks</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subsumes_list_filter</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Ls</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ks</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Ks</span> <span class="main">=</span> filter <span class="main">(</span>leq_lit <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ks</span></span></span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="main">∃</span><span class="bound">K</span> <span class="main">∈</span> set <span class="bound">Ks</span><span class="main">.</span> is_pos <span class="bound">K</span> <span class="main">=</span> is_pos <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span>
       <span class="main">(</span><span class="keyword1">case</span> match_term_list <span class="main">[</span><span class="main">(</span>atm_of <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">,</span> atm_of <span class="bound">K</span><span class="main">)</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">of</span>
         None <span class="main">⇒</span> False
       <span class="main">|</span> Some <span class="bound">ρ</span> <span class="main">⇒</span> <span class="free">subsumes_list_filter</span> <span class="free"><span class="bound"><span class="entity">Ls</span></span></span> <span class="main">(</span>remove1 <span class="bound">K</span> <span class="bound">Ks</span><span class="main">)</span> <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_subsumes_list_subsumes_list_filter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_wrt leq_lit <span class="free">Ls</span> <span class="main">⟹</span> subsumes_list <span class="free">Ls</span> <span class="free">Ks</span> <span class="free">σ</span> <span class="main">=</span> subsumes_list_filter <span class="free">Ls</span> <span class="free">Ks</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Ls</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Ks</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">L</span> <span class="skolem">Ls</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subsumes_list <span class="main">(</span><span class="skolem">L</span> <span class="main">#</span> <span class="skolem">Ls</span><span class="main">)</span> <span class="skolem">Ks</span> <span class="skolem">σ</span> <span class="main">=</span> subsumes_list <span class="main">(</span><span class="skolem">L</span> <span class="main">#</span> <span class="skolem">Ls</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span>leq_lit <span class="skolem">L</span><span class="main">)</span> <span class="skolem">Ks</span><span class="main">)</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subsumes_list_Cons_filter_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> leq_lit_match<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subsumes_list <span class="main">(</span><span class="skolem">L</span> <span class="main">#</span> <span class="skolem">Ls</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span>leq_lit <span class="skolem">L</span><span class="main">)</span> <span class="skolem">Ks</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span> subsumes_list_filter <span class="main">(</span><span class="skolem">L</span> <span class="main">#</span> <span class="skolem">Ls</span><span class="main">)</span> <span class="skolem">Ks</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons.IH <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of Deterministic QuickSort›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This is the functional description of the standard variant of deterministic
  QuickSort that always chooses the first list element as the pivot as given
  by Hoare in 1962. For a list that is already sorted, this leads to $n(n-1)$
  comparisons, but as is well known, the average case is much better.

  The code below is adapted from Manuel Eberl's <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Quick_Sort_Cost›</span></span></span></span> AFP
  entry, but without invoking probability theory and using a predicate instead
  of a set.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">quicksort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">quicksort</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">quicksort</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="free">quicksort</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="free">quicksort</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can easily show that this QuickSort is correct:
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> mset_quicksort <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>quicksort <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> quicksort.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">corollary</span></span> set_quicksort <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>quicksort <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> quicksort.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> sorted_wrt_quicksort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transp <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total_on <span class="free">R</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"reflp_on <span class="free">R</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span>quicksort <span class="free">R</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> quicksort.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">R</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">R</span> <span class="skolem">b</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> that <span class="keyword1"><span class="command">unfolding</span></span> total_on_def reflp_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="skolem">R</span> <span class="main">(</span>quicksort <span class="skolem">R</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">R</span> <span class="bound">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"sorted_wrt <span class="skolem">R</span> <span class="main">(</span>quicksort <span class="skolem">R</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">R</span> <span class="bound">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="quoted">"2.IH"</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> total_on_def reflp_on_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_append <span class="quoted"><span class="quoted">‹transp <span class="skolem">R</span>›</span></span>
     <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> transpD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹transp <span class="skolem">R</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> total<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
End of the material adapted from Eberl's <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Quick_Sort_Cost›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subsumes_list_subsumes_list_filter<span class="main">[</span><span class="operator">abs_def</span><span class="main">,</span> <span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subsumes_list <span class="free">Ls</span> <span class="free">Ks</span> <span class="free">σ</span> <span class="main">=</span> subsumes_list_filter <span class="main">(</span>quicksort leq_lit <span class="free">Ls</span><span class="main">)</span> <span class="free">Ks</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subsumes_list_alt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> subsumes_list_alt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
    sorted_wrt_subsumes_list_subsumes_list_filter<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_quicksort<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Executable_FO_Ordered_Resolution_Prover">
<div class="head">
<h1>Theory Executable_FO_Ordered_Resolution_Prover</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       An Executable Simple Ordered Resolution Prover for First-Order Clauses
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2017, 2018
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2018
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹An Executable Simple Ordered Resolution Prover for First-Order Clauses›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory provides an executable functional implementation of the
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>deterministic_RP›</span></span></span></span> prover, building on the \textsf{IsaFoR} library
for the notion of terms and on the Knuth--Bendix order.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Executable_FO_Ordered_Resolution_Prover
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Deterministic_FO_Ordered_Resolution_Prover.html">Deterministic_FO_Ordered_Resolution_Prover</a>
    <a href="Executable_Subsumption.html">Executable_Subsumption</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span>
    <a href="../Show/Show_Instances.html">Show.Show_Instances</a>
    <a href="IsaFoR_Term.html">IsaFoR_Term</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> RP<span class="main">:</span> deterministic_FO_resolution_prover <span class="keyword2"><span class="keyword">where</span></span>
  S <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  subst_atm <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(⋅)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  id_subst <span class="main">=</span> <span class="quoted"><span class="quoted">"Var <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span> <span class="main">::</span> <span class="main">{</span>weighted<span class="main">,</span> compare_order<span class="main">}</span><span class="main">,</span> nat<span class="main">)</span> term"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  comp_subst <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(∘<span class="hidden">⇩</span><sub>s</sub>)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  renamings_apart <span class="main">=</span> <span class="quoted">renamings_apart</span> <span class="keyword2"><span class="keyword">and</span></span>
  atm_of_atms <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun undefined"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  mgu <span class="main">=</span> <span class="quoted">mgu_sets</span> <span class="keyword2"><span class="keyword">and</span></span>
  less_atm <span class="main">=</span> <span class="quoted">less_kbo</span> <span class="keyword2"><span class="keyword">and</span></span>
  size_atm <span class="main">=</span> <span class="quoted">size</span> <span class="keyword2"><span class="keyword">and</span></span>
  timestamp_factor <span class="main">=</span> <span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  size_factor <span class="main">=</span> <span class="quoted"><span class="main">1</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> deterministic_RP <span class="main">=</span> <span class="quoted">RP.deterministic_RP</span>
  <span class="keyword2"><span class="keyword">and</span></span> deterministic_RP_step <span class="main">=</span> <span class="quoted">RP.deterministic_RP_step</span>
  <span class="keyword2"><span class="keyword">and</span></span> is_final_dstate <span class="main">=</span> <span class="quoted">RP.is_final_dstate</span>
  <span class="keyword2"><span class="keyword">and</span></span> is_reducible_lit <span class="main">=</span> <span class="quoted">RP.is_reducible_lit</span>
  <span class="keyword2"><span class="keyword">and</span></span> is_tautology <span class="main">=</span> <span class="quoted">RP.is_tautology</span>
  <span class="keyword2"><span class="keyword">and</span></span> maximal_wrt <span class="main">=</span> <span class="quoted">RP.maximal_wrt</span>
  <span class="keyword2"><span class="keyword">and</span></span> reduce <span class="main">=</span> <span class="quoted">RP.reduce</span>
  <span class="keyword2"><span class="keyword">and</span></span> reduce_all <span class="main">=</span> <span class="quoted">RP.reduce_all</span>
  <span class="keyword2"><span class="keyword">and</span></span> reduce_all2 <span class="main">=</span> <span class="quoted">RP.reduce_all2</span>
  <span class="keyword2"><span class="keyword">and</span></span> remdups_clss <span class="main">=</span> <span class="quoted">RP.remdups_clss</span>
  <span class="keyword2"><span class="keyword">and</span></span> resolve <span class="main">=</span> <span class="quoted">RP.resolve</span>
  <span class="keyword2"><span class="keyword">and</span></span> resolve_on <span class="main">=</span> <span class="quoted">RP.resolve_on</span>
  <span class="keyword2"><span class="keyword">and</span></span> resolvable <span class="main">=</span> <span class="quoted">RP.resolvable</span>
  <span class="keyword2"><span class="keyword">and</span></span> resolvent <span class="main">=</span> <span class="quoted">RP.resolvent</span>
  <span class="keyword2"><span class="keyword">and</span></span> resolve_rename <span class="main">=</span> <span class="quoted">RP.resolve_rename</span>
  <span class="keyword2"><span class="keyword">and</span></span> resolve_rename_either_way <span class="main">=</span> <span class="quoted">RP.resolve_rename_either_way</span>
  <span class="keyword2"><span class="keyword">and</span></span> select_min_weight_clause <span class="main">=</span> <span class="quoted">RP.select_min_weight_clause</span>
  <span class="keyword2"><span class="keyword">and</span></span> strictly_maximal_wrt <span class="main">=</span> <span class="quoted">RP.strictly_maximal_wrt</span>
  <span class="keyword2"><span class="keyword">and</span></span> strictly_subsume <span class="main">=</span> <span class="quoted">RP.strictly_subsume</span>
  <span class="keyword2"><span class="keyword">and</span></span> subsume <span class="main">=</span> <span class="quoted">RP.subsume</span>
  <span class="keyword2"><span class="keyword">and</span></span> weight <span class="main">=</span> <span class="quoted">RP.weight</span>
  <span class="keyword2"><span class="keyword">and</span></span> St0 <span class="main">=</span> <span class="quoted">RP.St0</span>
  <span class="keyword2"><span class="keyword">and</span></span> sorted_list_of_set <span class="main">=</span> <span class="quoted"><span class="quoted">"linorder.sorted_list_of_set <span class="main">(</span>le_of_comp compare<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sort_key <span class="main">=</span> <span class="quoted"><span class="quoted">"linorder.sort_key <span class="main">(</span>le_of_comp compare<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> insort_key <span class="main">=</span> <span class="quoted"><span class="quoted">"linorder.insort_key <span class="main">(</span>le_of_comp compare<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_kbo_subst is_ground_atm_ground less_kbo_less <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ground_less_less_kbo<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span>
  RP.deterministic_RP.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  RP.deterministic_RP_step.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  RP.is_final_dstate.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  RP.is_tautology_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  RP.reduce.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  RP.reduce_all_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  RP.reduce_all2.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  RP.resolve_rename_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  RP.resolve_rename_either_way_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  RP.select_min_weight_clause.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  RP.weight.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  St0_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  substitution_ops.strictly_subsumes_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  substitution_ops.subst_cls_lists_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  substitution_ops.subst_lit_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
  substitution_ops.subst_cls_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> remove1_mset_subset_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1_mset <span class="free">a</span> <span class="free">A</span> <span class="main">⊆#</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">⊆#</span> add_mset <span class="free">a</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_add_single subset_eq_diff_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Bex_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">Q</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> Bex <span class="free">B</span> <span class="free">P</span> <span class="main">=</span> Bex <span class="free">B</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_reducible_lit_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RP.is_reducible_lit <span class="free">Ds</span> <span class="free">C</span> <span class="free">L</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">D</span> <span class="main">∈</span> set <span class="free">Ds</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L'</span> <span class="main">∈</span> set <span class="bound">D</span><span class="main">.</span>
     <span class="keyword1">if</span> is_pos <span class="bound">L'</span> <span class="main">=</span> is_neg <span class="free">L</span> <span class="keyword1">then</span>
       <span class="main">(</span><span class="keyword1">case</span> match_term_list <span class="main">[</span><span class="main">(</span>atm_of <span class="bound">L'</span><span class="main">,</span> atm_of <span class="free">L</span><span class="main">)</span><span class="main">]</span> Map.empty <span class="keyword1">of</span>
         None <span class="main">⇒</span> False
       <span class="main">|</span> Some <span class="bound">σ</span> <span class="main">⇒</span> subsumes_list <span class="main">(</span>remove1 <span class="bound">L'</span> <span class="bound">D</span><span class="main">)</span> <span class="free">C</span> <span class="bound">σ</span><span class="main">)</span>
     <span class="keyword1">else</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RP.is_reducible_lit_def subsumes_list_alt subsumes_modulo_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Bex_cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> D L'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">split</span> if_splits option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> σ
      <span class="keyword1"><span class="command">using</span></span> term_subst_eq<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"subst_of_map Var <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> vars_lit <span class="skolem">L'</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="skolem">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">L'</span></span><span class="main"><span class="keyword3">;</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lit_def subst_of_map_def
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  match_term_list_complete<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> vars_lit <span class="skolem">L'</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="skolem">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> σ
      <span class="keyword1"><span class="command">using</span></span> term_subst_eq<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"subst_of_map Var <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> vars_lit <span class="skolem">L'</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="skolem">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">L'</span></span><span class="main"><span class="keyword3">;</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lit_def subst_of_map_def
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  match_term_list_complete<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> vars_lit <span class="skolem">L'</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="skolem">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> σ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">L'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lit_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> σ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">L'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lit_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> σ τ
      <span class="keyword1"><span class="command">using</span></span> same_on_vars_clause<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>remove1 <span class="skolem">L'</span> <span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"subst_of_map Var
        <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> vars_clause <span class="main">(</span>remove1_mset <span class="skolem">L'</span> <span class="main">(</span>mset <span class="skolem">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> dom <span class="skolem">σ</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="skolem">τ</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">τ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">L'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lit_def dom_def subst_of_map_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match_term_list_sound <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> vars_clause <span class="main">(</span>remove1_mset <span class="skolem">L'</span> <span class="main">(</span>mset <span class="skolem">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> dom <span class="skolem">σ</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="skolem">τ</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extends_subst_def subst_of_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> term_subst_eq_rev<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> σ τ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">L'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lit_def subst_of_map_def extends_subst_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match_term_list_sound <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"subst_of_map Var <span class="skolem">τ</span>"</span></span><span class="main"><span class="main">]</span></span> term_subst_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> σ τ
      <span class="keyword1"><span class="command">using</span></span> same_on_vars_clause<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>remove1 <span class="skolem">L'</span> <span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"subst_of_map Var
        <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> vars_clause <span class="main">(</span>remove1_mset <span class="skolem">L'</span> <span class="main">(</span>mset <span class="skolem">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> dom <span class="skolem">σ</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="skolem">τ</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">τ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">L'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lit_def dom_def subst_of_map_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match_term_list_sound <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> vars_clause <span class="main">(</span>remove1_mset <span class="skolem">L'</span> <span class="main">(</span>mset <span class="skolem">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> dom <span class="skolem">σ</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="skolem">τ</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extends_subst_def subst_of_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> term_subst_eq_rev<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> σ τ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">L'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lit_def subst_of_map_def extends_subst_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match_term_list_sound <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"subst_of_map Var <span class="skolem">τ</span>"</span></span><span class="main"><span class="main">]</span></span> term_subst_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> σ τ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">L'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lit_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> σ τ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">L'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lit_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span>
  Pairs_def<span class="main">[</span><span class="operator">folded</span> sorted_list_of_set_def<span class="main">,</span> <span class="operator">code</span><span class="main">]</span>
  linorder.sorted_list_of_set_sort_remdups<span class="main">[</span><span class="operator">OF</span> class_linorder_compare<span class="main">,</span>
    <span class="operator">folded</span> sorted_list_of_set_def sort_key_def<span class="main">,</span> <span class="operator">code</span><span class="main">]</span>
  linorder.sort_key_def<span class="main">[</span><span class="operator">OF</span> class_linorder_compare<span class="main">,</span> <span class="operator">folded</span> sort_key_def insort_key_def<span class="main">,</span> <span class="operator">code</span><span class="main">]</span>
  linorder.insort_key.simps<span class="main">[</span><span class="operator">OF</span> class_linorder_compare<span class="main">,</span> <span class="operator">folded</span> insort_key_def<span class="main">,</span> <span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">St0</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">deterministic_RP</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> RP

<span class="comment1">(*arbitrary*)</span>
<span class="keyword1"><span class="command">instantiation</span></span> nat <span class="main">::</span> <span class="quoted">weighted</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">weights_nat</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat weights"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">weights_nat</span> <span class="main">=</span>
  <span class="main">⦇</span>w <span class="main">=</span> Suc <span class="main">∘</span> prod_encode<span class="main">,</span> w0 <span class="main">=</span> <span class="main">1</span><span class="main">,</span> pr_strict <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span> <span class="main">&gt;</span> <span class="bound">g</span> <span class="main">∨</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="bound">m</span><span class="main">,</span> least <span class="main">=</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">,</span> scf <span class="main">=</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weights_nat_def SN_iff_wf asymp.simps irreflp_def prod_encode_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_lex_prod<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prover</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat<span class="main">,</span> nat<span class="main">)</span> Term.term literal list <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prover</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> deterministic_RP <span class="main">(</span>St0 <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> True
    <span class="main">|</span> Some <span class="bound">R</span> <span class="main">⇒</span> <span class="main">[]</span> <span class="main">∉</span> set <span class="bound">R</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> prover_complete_refutation<span class="main">:</span> <span class="quoted"><span class="quoted">"prover <span class="free">N</span> <span class="main">⟷</span> satisfiable <span class="main">(</span>RP.grounded_N0 <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prover_def St0_def
  <span class="keyword1"><span class="command">using</span></span> RP.deterministic_RP_complete<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> RP.deterministic_RP_refutation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> grounding_of_clss_def grounding_of_cls_def ex_ground_subst
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">string_literal_of_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">string_literal_of_nat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> String.implode <span class="main">(</span>show <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">prover</span></span> <span class="quoted"><span class="quoted">Fun</span></span> <span class="quoted"><span class="quoted">Var</span></span> <span class="quoted"><span class="quoted">Pos</span></span> <span class="quoted"><span class="quoted">Neg</span></span> <span class="quoted"><span class="quoted">string_literal_of_nat</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">::</span>nat"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc"</span></span></span> <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> RPx

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔭</span> <span class="main">≡</span> Fun <span class="numeral">42</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔞</span> <span class="main">≡</span> Fun <span class="main">0</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔟</span> <span class="main">≡</span> Fun <span class="main">1</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔠</span> <span class="main">≡</span> Fun <span class="numeral">2</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≡</span> Var <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≡</span> Var <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">≡</span> Var <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"prover
  <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[</span>Neg <span class="main">(</span>𝔭<span class="main">[</span>X<span class="main">,</span>Y<span class="main">,</span>Z<span class="main">]</span><span class="main">)</span><span class="main">,</span> Pos <span class="main">(</span>𝔭<span class="main">[</span>Y<span class="main">,</span>Z<span class="main">,</span>X<span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="main">[</span>Pos <span class="main">(</span>𝔭<span class="main">[</span>𝔠<span class="main">,</span>𝔞<span class="main">,</span>𝔟<span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="main">[</span>Neg <span class="main">(</span>𝔭<span class="main">[</span>𝔟<span class="main">,</span>𝔠<span class="main">,</span>𝔞<span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>
  <span class="main">::</span> <span class="main">(</span><span class="main">(</span>nat<span class="main">,</span> nat<span class="main">)</span> Term.term literal list <span class="main">×</span> nat<span class="main">)</span> list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"prover
  <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[</span>Pos <span class="main">(</span>𝔭<span class="main">[</span>X<span class="main">,</span>Y<span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span>Neg <span class="main">(</span>𝔭<span class="main">[</span>X<span class="main">,</span>X<span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>
  <span class="main">::</span> <span class="main">(</span><span class="main">(</span>nat<span class="main">,</span> nat<span class="main">)</span> Term.term literal list <span class="main">×</span> nat<span class="main">)</span> list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"prover <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[</span>Neg <span class="main">(</span>𝔭<span class="main">[</span>X<span class="main">,</span>Y<span class="main">,</span>Z<span class="main">]</span><span class="main">)</span><span class="main">,</span> Pos <span class="main">(</span>𝔭<span class="main">[</span>Y<span class="main">,</span>Z<span class="main">,</span>X<span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>
  <span class="main">::</span> <span class="main">(</span><span class="main">(</span>nat<span class="main">,</span> nat<span class="main">)</span> Term.term literal list <span class="main">×</span> nat<span class="main">)</span> list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_MSC015_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>nat<span class="main">,</span> nat<span class="main">)</span> Term.term literal list <span class="main">×</span> nat<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_MSC015_1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span>
       <span class="bound">init</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span>Pos <span class="main">(</span>𝔭 <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> 𝔞<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">rules</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">[</span>Neg <span class="main">(</span>𝔭 <span class="main">(</span>map Var <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">@</span> 𝔞 <span class="main">#</span> replicate <span class="bound">i</span> 𝔟<span class="main">)</span><span class="main">)</span><span class="main">,</span>
                         Pos <span class="main">(</span>𝔭 <span class="main">(</span>map Var <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">@</span> 𝔟 <span class="main">#</span> replicate <span class="bound">i</span> 𝔞<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">;</span>
       <span class="bound">goal</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span>Neg <span class="main">(</span>𝔭 <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> 𝔟<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="bound">init</span> <span class="main">#</span> <span class="bound">rules</span> <span class="main">@</span> <span class="main">[</span><span class="bound">goal</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"prover <span class="main">(</span>mk_MSC015_1 <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"prover <span class="main">(</span>mk_MSC015_1 <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"prover <span class="main">(</span>mk_MSC015_1 <span class="numeral">3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"prover <span class="main">(</span>mk_MSC015_1 <span class="numeral">4</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"prover <span class="main">(</span>mk_MSC015_1 <span class="numeral">5</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"prover <span class="main">(</span>mk_MSC015_1 <span class="numeral">10</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
     <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="bound">x10</span> <span class="bound">x11</span> <span class="bound">x12</span> <span class="bound">x13</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="bound">x10</span> <span class="bound">x11</span> <span class="bound">x12</span> <span class="bound">x13</span> <span class="free">a</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="bound">x10</span> <span class="bound">x11</span> <span class="bound">x12</span> <span class="bound">x13</span> <span class="free">b</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="bound">x10</span> <span class="bound">x11</span> <span class="bound">x12</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="bound">x10</span> <span class="bound">x11</span> <span class="bound">x12</span> <span class="free">a</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="bound">x10</span> <span class="bound">x11</span> <span class="bound">x12</span> <span class="free">b</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="bound">x10</span> <span class="bound">x11</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="bound">x10</span> <span class="bound">x11</span> <span class="free">a</span> <span class="free">b</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="bound">x10</span> <span class="bound">x11</span> <span class="free">b</span> <span class="free">a</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="bound">x10</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="bound">x10</span> <span class="free">a</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="bound">x10</span> <span class="free">b</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="free">a</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="bound">x9</span> <span class="free">b</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="free">a</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="bound">x8</span> <span class="free">b</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="free">a</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="bound">x7</span> <span class="free">b</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="free">a</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="bound">x6</span> <span class="free">b</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="free">a</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="free">b</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="free">a</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">x4</span> <span class="free">b</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="free">a</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="free">b</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="free">a</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="free">b</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span><span class="main">.</span>
       <span class="main">¬</span> <span class="free">p</span> <span class="bound">x1</span> <span class="free">a</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="bound">x1</span> <span class="free">b</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="free">p</span> <span class="free">a</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="main">∨</span>
       <span class="free">p</span> <span class="free">b</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span> <span class="free">a</span><span class="main">)</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span> <span class="free">b</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>