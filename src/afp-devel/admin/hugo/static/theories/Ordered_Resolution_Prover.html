<div id="Map2">
<div class="head">
<h1>Theory Map2</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Map Function on Two Parallel Lists
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2017
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Map Function on Two Parallel Lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Map2
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines a map function that applies a (curried) binary function elementwise to two
parallel lists.

The definition is taken from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">url</span></span> "https://www.isa-afp.org/browser_info/current/AFP/Jinja/Listn.html"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">map2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'c</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> map <span class="main">(</span>case_prod <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map2_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map2 <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nil_is_map_conv list.exhaust list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zip.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zip_Cons_Cons zip_Nil<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_map2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">t</span> <span class="main">=</span> length <span class="free">s</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">`</span> set <span class="main">(</span>map2 <span class="free">f</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map2 <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map2_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">t</span> <span class="main">=</span> length <span class="free">s</span> <span class="main">⟹</span> map2 <span class="free">f</span> <span class="main">(</span>tl <span class="free">t</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>map2 <span class="free">f</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> hd_Cons_tl list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> map2_empty_iff map_tl tl_Nil zip_Cons_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_zip_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">xs</span> <span class="main">(</span>zip <span class="free">ys</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_map2_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">t</span> <span class="main">=</span> length <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map2 <span class="free">f</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">t</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>map2 <span class="free">f</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>map2 <span class="free">f</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> map2 <span class="free">f</span> <span class="free">s</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> i_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this i_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">t</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">t</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>map2 <span class="free">f</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> i_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> map2 <span class="free">f</span> <span class="free">s</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>map2 <span class="free">f</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lazy_List_Liminf">
<div class="head">
<h1>Theory Lazy_List_Liminf</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Supremum and Liminf of Lazy Lists
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017, 2020
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Maintainer:  Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Supremum and Liminf of Lazy Lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lazy_List_Liminf
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../Coinductive/Coinductive_List.html">Coinductive.Coinductive_List</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Lazy lists, as defined in the \emph{Archive of Formal Proofs}, provide finite and infinite lists in
one type, defined coinductively. The present theory introduces the concept of the union of all
elements of a lazy list of sets and the limit of such a lazy list. The definitions are stated more
generally in terms of lattices. The basis for this theory is Section 4.1 (``Theorem Proving
Processes'') of Bachmair and Ganzinger's chapter.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Library›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_llength_ltake<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>ltake <span class="free">k</span> <span class="free">Xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Supremum›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Sup_llist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set llist <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Sup_llist</span> <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free"><span class="bound"><span class="entity">Xs</span></span></span><span class="main">}</span><span class="main">.</span> lnth <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lnth_subset_Sup_llist<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">⟹</span> lnth <span class="free">Xs</span> <span class="free">i</span> <span class="main">⊆</span> Sup_llist <span class="free">Xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_llist_imp_exists_index<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Sup_llist <span class="free">Xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> lnth <span class="free">Xs</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> exists_index_imp_Sup_llist<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> lnth <span class="free">Xs</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> Sup_llist <span class="free">Xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_llist_LNil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_llist LNil <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_llist_LCons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_llist <span class="main">(</span>LCons <span class="free">X</span> <span class="free">Xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span> <span class="main">∪</span> Sup_llist <span class="free">Xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_llist_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subset_antisym subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>LCons <span class="free">X</span> <span class="free">Xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> lnth <span class="main">(</span>LCons <span class="free">X</span> <span class="free">Xs</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>LCons <span class="free">X</span> <span class="free">Xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lnth <span class="main">(</span>LCons <span class="free">X</span> <span class="free">Xs</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> nth <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> lnth <span class="free">Xs</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lnth_LCons' neq0_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> lnth <span class="free">Xs</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> len Suc_pred' eSuc_enat iless_Suc_eq less_irrefl llength_LCons not_less order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span><span class="main">}</span><span class="main">.</span> lnth <span class="free">Xs</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> i0_lb lnth_0 zero_enat_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Suc_ile_eq lnth_Suc_LCons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lhd_subset_Sup_llist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="free">Xs</span> <span class="main">⟹</span> lhd <span class="free">Xs</span> <span class="main">⊆</span> Sup_llist <span class="free">Xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Supremum up-to›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Sup_upto_llist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set llist <span class="main">⇒</span> enat <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Sup_upto_llist</span> <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="main">∧</span> enat <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span><span class="main">.</span> lnth <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_upto_llist_eq_Sup_llist_ltake<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_upto_llist <span class="free">Xs</span> <span class="free">j</span> <span class="main">=</span> Sup_llist <span class="main">(</span>ltake <span class="main">(</span>eSuc <span class="free">j</span><span class="main">)</span> <span class="free">Xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_upto_llist_def Sup_llist_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong Sup.SUP_cong iless_Suc_eq lnth_ltake less_llength_ltake mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_upto_llist_enat_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Sup_upto_llist <span class="free">Xs</span> <span class="main">(</span>enat <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> lnull <span class="free">Xs</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> lhd <span class="free">Xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lnull <span class="free">Xs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Sup_upto_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Sup_upto_llist_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lhd_conv_lnth enat_0 enat_0_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_upto_llist_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Sup_upto_llist <span class="free">Xs</span> <span class="main">(</span>enat <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   Sup_upto_llist <span class="free">Xs</span> <span class="main">(</span>enat <span class="free">j</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> enat <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="keyword1">then</span> lnth <span class="free">Xs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_upto_llist_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_SucI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> le_SucE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_upto_llist_infinity<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_upto_llist <span class="free">Xs</span> <span class="main">∞</span> <span class="main">=</span> Sup_llist <span class="free">Xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_upto_llist_def Sup_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_upto_llist_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_upto_llist <span class="free">Xs</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> lnull <span class="free">Xs</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> lhd <span class="free">Xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> zero_enat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upto_llist_enat_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_upto_llist_eSuc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Sup_upto_llist <span class="free">Xs</span> <span class="main">(</span>eSuc <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> <span class="free">j</span> <span class="keyword1">of</span>
      enat <span class="bound">k</span> <span class="main">⇒</span> Sup_upto_llist <span class="free">Xs</span> <span class="main">(</span>enat <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">∞</span> <span class="main">⇒</span> Sup_llist <span class="free">Xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eSuc_enat <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> enat.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_upto_llist_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> Sup_upto_llist <span class="free">Xs</span> <span class="free">j</span> <span class="main">⊆</span> Sup_upto_llist <span class="free">Xs</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_upto_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_upto_llist_subset_Sup_llist<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_upto_llist <span class="free">Xs</span> <span class="free">j</span> <span class="main">⊆</span> Sup_llist <span class="free">Xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_llist_def Sup_upto_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> elem_Sup_llist_imp_Sup_upto_llist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Sup_llist <span class="free">Xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> llength <span class="free">Xs</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> Sup_upto_llist <span class="free">Xs</span> <span class="main">(</span>enat <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_llist_def Sup_upto_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> lnth_subset_Sup_upto_llist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">⟹</span> lnth <span class="free">Xs</span> <span class="free">j</span> <span class="main">⊆</span> Sup_upto_llist <span class="free">Xs</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_upto_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_Sup_llist_imp_Sup_upto_llist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> Sup_llist <span class="free">Xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">X</span> <span class="main">⊆</span> Sup_upto_llist <span class="free">Xs</span> <span class="main">(</span>enat <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Sup_llist <span class="free">Xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> Sup_llist <span class="free">Xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Sup_upto_llist <span class="free">Xs</span> <span class="main">(</span>enat <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> elem_Sup_llist_imp_Sup_upto_llist <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> X <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> Sup_upto_llist <span class="free">Xs</span> <span class="main">(</span>enat <span class="skolem">k'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="skolem">X</span> <span class="main">⊆</span> Sup_upto_llist <span class="free">Xs</span> <span class="main">(</span>max <span class="skolem">k</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k k' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> Sup_upto_llist_mono enat_ord_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert_subset
      max.cobounded1 max.cobounded2 subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Liminf›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Liminf_llist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set llist <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Liminf_llist</span> <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free"><span class="bound"><span class="entity">Xs</span></span></span><span class="main">}</span><span class="main">.</span> <span class="main">⋂</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free"><span class="bound"><span class="entity">Xs</span></span></span><span class="main">}</span><span class="main">.</span> lnth <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_llist_LNil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Liminf_llist LNil <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_llist_LCons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Liminf_llist <span class="main">(</span>LCons <span class="free">X</span> <span class="free">Xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> lnull <span class="free">Xs</span> <span class="keyword1">then</span> <span class="free">X</span> <span class="keyword1">else</span> Liminf_llist <span class="free">Xs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lnull <span class="free">Xs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> nnull<span class="main">:</span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">≤</span> llength <span class="free">Xs</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">≤</span> llength <span class="free">Xs</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">∈</span> lnth <span class="main">(</span>LCons <span class="free">X</span> <span class="free">Xs</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> enat <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> llength <span class="free">Xs</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">≤</span> llength <span class="free">Xs</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">∈</span> lnth <span class="main">(</span>LCons <span class="free">X</span> <span class="free">Xs</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"llength <span class="free">Xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
            <span class="operator">metis</span> not_lnull_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> nnull<span class="main"><span class="main">]</span></span> Suc_le_D eSuc_enat eSuc_ile_mono
              llength_LCons not_less_eq_eq zero_enat_def zero_le<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">metis</span> Suc_leD enat_ord_code<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">∈</span> lnth <span class="free">Xs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_ile_eq Suc_n_not_le_n lift_Suc_mono_le lnth_Suc_LCons nat_le_linear<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Liminf_llist_def nnull<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">∈</span> lnth <span class="free">Xs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        i<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">∈</span> lnth <span class="free">Xs</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> llength <span class="free">Xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_ile_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">≤</span> llength <span class="free">Xs</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">∈</span> lnth <span class="main">(</span>LCons <span class="free">X</span> <span class="free">Xs</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc_ile_eq Suc_le_D j <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">≤</span> llength <span class="free">Xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">≤</span> llength <span class="free">Xs</span> <span class="main">⟶</span>
        <span class="skolem">x</span> <span class="main">∈</span> lnth <span class="main">(</span>LCons <span class="free">X</span> <span class="free">Xs</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Liminf_llist_def nnull<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Liminf_llist_def enat_0_iff<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lfinite_Liminf_llist<span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">Xs</span> <span class="main">⟹</span> Liminf_llist <span class="free">Xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> lnull <span class="free">Xs</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> llast <span class="free">Xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lfinite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LCons <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> LCons <span class="skolem">y</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> not_lnull_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> xs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Liminf_llist_LCons LCons.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> xs<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> llast_LCons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Liminf_llist_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_llist_ltl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="main">(</span>ltl <span class="free">Xs</span><span class="main">)</span> <span class="main">⟹</span> Liminf_llist <span class="free">Xs</span> <span class="main">=</span> Liminf_llist <span class="main">(</span>ltl <span class="free">Xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Liminf_llist_LCons lhd_LCons_ltl lnull_ltlI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_llist_subset_Sup_llist<span class="main">:</span> <span class="quoted"><span class="quoted">"Liminf_llist <span class="free">Xs</span> <span class="main">⊆</span> Sup_llist <span class="free">Xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def Sup_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> image_Liminf_llist_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> Liminf_llist <span class="free">Ns</span> <span class="main">⊆</span> Liminf_llist <span class="main">(</span>lmap <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">Ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_llist_imp_exists_index<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Liminf_llist <span class="free">Xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> lnth <span class="free">Xs</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> not_Liminf_llist_imp_exists_index<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="free">Xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> Liminf_llist <span class="free">Xs</span> <span class="main">⟹</span> enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> lnth <span class="free">Xs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_subset_Liminf_llist_imp_exists_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    nnil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="free">Xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    in_lim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> Liminf_llist <span class="free">Xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span><span class="main">}</span><span class="main">.</span> lnth <span class="free">Xs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> nnil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> nemp<span class="main">:</span> False

    <span class="keyword1"><span class="command">have</span></span> in_lim'<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span><span class="main">}</span><span class="main">.</span> lnth <span class="free">Xs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_lim<span class="main">[</span><span class="operator">unfolded</span> Liminf_llist_def<span class="main">]</span> in_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i_of</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      i_of_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> enat <span class="main">(</span><span class="skolem">i_of</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      in_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i_of</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span><span class="main">}</span><span class="main">.</span> lnth <span class="free">Xs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bchoice<span class="main">[</span><span class="operator">OF</span> in_lim'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i_max</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">i_max</span> <span class="main">=</span> Max <span class="main">(</span><span class="skolem">i_of</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i_max</span> <span class="main">∈</span> <span class="skolem">i_of</span> <span class="main">`</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fin i_max_def nemp<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x_max</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      x_max_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x_max</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      i_max_is<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i_max</span> <span class="main">=</span> <span class="skolem">i_of</span> <span class="skolem">x_max</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> i_max_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> le_i_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="skolem">i_of</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">i_max</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> i_max_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fin<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i_max</span> <span class="main">&lt;</span> llength <span class="free">Xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i_of_lt x_max_in i_max_is <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i_max</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span><span class="main">}</span><span class="main">.</span> lnth <span class="free">Xs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_in_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i_of</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span><span class="main">}</span><span class="main">.</span> lnth <span class="free">Xs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_inter <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i_max</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span><span class="main">}</span>
        <span class="main">⊆</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i_of</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> x_in le_i_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i_max</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span><span class="main">}</span><span class="main">.</span> lnth <span class="free">Xs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_llist_lmap_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>Sup_llist <span class="main">(</span>lmap <span class="free">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Liminf_llist <span class="main">(</span>lmap <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> Liminf_llist <span class="main">(</span>lmap <span class="free">g</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      x_in_fgj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟶</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">xs</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">g</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> ex_in_gi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">g</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f_inj i_lt x_in_fgj <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def Sup_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟶</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">xs</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">g</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">SOME</span></span> <span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">g</span></span> <span class="main"><span class="main">(</span></span>lnth <span class="free"><span class="free">xs</span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">f</span></span> <span class="bound"><span class="bound">y</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> ex_in_gi<span class="main">]</span> x_in_fgj f_inj i_lt x_in_fgj <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def Sup_llist_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> imageE<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> Liminf_llist <span class="main">(</span>lmap <span class="free">g</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i_lt <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> image_Liminf_llist_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"lmap <span class="free">g</span> <span class="free">xs</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> llist.map_comp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_llist_lmap_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> lset <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Y</span> <span class="main">∈</span> lset <span class="free">xs</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">∩</span> <span class="free">h</span> <span class="bound">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Liminf_llist <span class="main">(</span>lmap <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">∪</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    Liminf_llist <span class="main">(</span>lmap <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> Liminf_llist <span class="main">(</span>lmap <span class="free">h</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">xs</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">g</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">h</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_in<span class="main">[</span><span class="operator">unfolded</span> Liminf_llist_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> enat <span class="bound">i'</span> <span class="main">&lt;</span> llength <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">xs</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">g</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> enat <span class="bound">i'</span> <span class="main">&lt;</span> llength <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">xs</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">h</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> disjoint_iff_not_equal<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_lset_conv_lnth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_set_filter_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Liminf_llist <span class="main">(</span>lmap <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="free">Xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> Liminf_llist <span class="free">Xs</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Liminf up-to›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Liminf_upto_llist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set llist <span class="main">⇒</span> enat <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Liminf_upto_llist</span> <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="main">∧</span> enat <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span><span class="main">.</span>
      <span class="main">⋂</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="main">∧</span> enat <span class="bound">j</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span><span class="main">.</span> lnth <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_upto_llist_eq_Liminf_llist_ltake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Liminf_upto_llist <span class="free">Xs</span> <span class="free">j</span> <span class="main">=</span> Liminf_llist <span class="main">(</span>ltake <span class="main">(</span>eSuc <span class="free">j</span><span class="main">)</span> <span class="free">Xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Liminf_upto_llist_def Liminf_llist_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong Sup.SUP_cong iless_Suc_eq lnth_ltake less_llength_ltake mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_upto_llist_enat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Liminf_upto_llist <span class="free">Xs</span> <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> enat <span class="free">k</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="keyword1">then</span> lnth <span class="free">Xs</span> <span class="free">k</span> <span class="keyword1">else</span> <span class="keyword1">if</span> lnull <span class="free">Xs</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> llast <span class="free">Xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"enat <span class="free">k</span> <span class="main">&lt;</span> llength <span class="free">Xs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_upto_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> k_ge<span class="main">:</span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lnull <span class="free">Xs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> nil<span class="main">:</span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_upto_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> nnil<span class="main">:</span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    j<span class="main">:</span> <span class="quoted"><span class="quoted">"eSuc <span class="main">(</span>enat <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> llength <span class="free">Xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k_ge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eSuc_enat_iff enat_ile le_less_linear lhd_LCons_ltl llength_LCons<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">Xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k_ge not_lfinite_llength <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> le_k<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟷</span> enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="free">Xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> k_ge linear order_le_less_subst2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Liminf_upto_llist <span class="free">Xs</span> <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="main">=</span> llast <span class="free">Xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j nnil lfinite_Liminf_llist<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> nnil
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_upto_llist_def Liminf_llist_def <span class="keyword1"><span class="command">using</span></span> llast_conv_lnth<span class="main">[</span><span class="operator">OF</span> j<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_k<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> k_ge nnil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_upto_llist_infinity<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Liminf_upto_llist <span class="free">Xs</span> <span class="main">∞</span> <span class="main">=</span> Liminf_llist <span class="free">Xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Liminf_upto_llist_def Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_upto_llist_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Liminf_upto_llist <span class="free">Xs</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> lnull <span class="free">Xs</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> lhd <span class="free">Xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Liminf_upto_llist_def image_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enat_0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enat_0 lnth_0_conv_lhd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_upto_llist_eSuc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Liminf_upto_llist <span class="free">Xs</span> <span class="main">(</span>eSuc <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> <span class="free">j</span> <span class="keyword1">of</span>
      enat <span class="bound">k</span> <span class="main">⇒</span> Liminf_upto_llist <span class="free">Xs</span> <span class="main">(</span>enat <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">∞</span> <span class="main">⇒</span> Liminf_llist <span class="free">Xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eSuc_enat <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> enat.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> elem_Liminf_llist_imp_Liminf_upto_llist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Liminf_llist <span class="free">Xs</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> llength <span class="free">Xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Xs</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∈</span> Liminf_upto_llist <span class="free">Xs</span> <span class="main">(</span>enat <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def Liminf_upto_llist_def <span class="keyword1"><span class="command">using</span></span> enat_ord_simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lazy_List_Chain">
<div class="head">
<h1>Theory Lazy_List_Chain</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Relational Chains over Lazy Lists
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2017
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2017
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relational Chains over Lazy Lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lazy_List_Chain
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/BNF_Corec.html">HOL-Library.BNF_Corec</a>"</span>
    <a href="Lazy_List_Liminf.html">Lazy_List_Liminf</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A chain is a lazy lists of elements such that all pairs of consecutive elements are related by a
given relation. A full chain is either an infinite chain or a finite chain that cannot be extended.
The inspiration for this theory is Section 4.1 (``Theorem Proving Processes'') of Bachmair and
Ganzinger's chapter.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Chains›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">chain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> llist <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  chain_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">chain</span> <span class="free">R</span> <span class="main">(</span>LCons <span class="free"><span class="bound"><span class="entity">x</span></span></span> LNil<span class="main">)</span>"</span></span>
<span class="main">|</span> chain_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">chain</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>lhd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">chain</span> <span class="free">R</span> <span class="main">(</span>LCons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  chain_LNil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> chain <span class="free">R</span> LNil"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  chain_not_lnull<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">¬</span> lnull <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> chain.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chain_lappend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    r_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    r_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    mid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span>llast <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>lhd <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="main">(</span>lappend <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">xs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> r_xs mid
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lfinite.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lfinite_LConsI <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> fin <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ih <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> r_xxs <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> mid <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> LNil"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> r_ys mid <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> chain_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> xs_nnil<span class="main">:</span> False
      <span class="keyword1"><span class="command">have</span></span> r_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chain.simps ltl_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> r_xxs xs_nnil<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> mid'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span>llast <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>lhd <span class="free">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> llast_LCons lnull_def mid xs_nnil<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">x</span> <span class="main">(</span>lhd <span class="main">(</span>lappend <span class="skolem">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> chain.simps lhd_LCons lhd_lappend chain_not_lnull ltl_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> r_xxs
            xs_nnil<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lappend_code<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> r_xs mid'<span class="main">]</span> start <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> chain_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_xs lappend_inf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chain_length_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> llength <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chain_ldropn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> llength <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="main">(</span>ldropn <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> chain.cases ldrop_eSuc_ltl ldropn_LNil ldropn_eq_LNil ltl_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> not_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inf_chain_ldropn_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">¬</span> lfinite <span class="free">xs</span> <span class="main">⟹</span> chain <span class="free">R</span> <span class="main">(</span>ldropn <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chain.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chain_ldropn not_lfinite_llength<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inf_chain_ltl_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">¬</span> lfinite <span class="free">xs</span> <span class="main">⟹</span> chain <span class="free">R</span> <span class="main">(</span>ltl <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_chain_ldropn_chain ldropn_0 ldropn_ltl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chain_lnth_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    chain<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    len<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> ldropn <span class="free">j</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"llength <span class="skolem">ys</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ys_def <span class="keyword1"><span class="command">using</span></span> len
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def funpow_swap1 ldropn_0 ldropn_def ldropn_eq_LNil ldropn_ltl not_less
        one_enat_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y0</span></span> <span class="skolem"><span class="skolem">y1</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> LCons <span class="skolem">y0</span> <span class="main">(</span>LCons <span class="skolem">y1</span> <span class="skolem">ys'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ys_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_ile_eq ldropn_Suc_conv_ldropn len less_imp_not_less not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ys_def <span class="keyword1"><span class="command">using</span></span> Suc_ile_eq chain chain_ldropn len less_imp_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">y0</span> <span class="skolem">y1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> chain.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_def <span class="keyword1"><span class="command">unfolding</span></span> ys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ldropn_Suc_conv_ldropn ldropn_eq_LConsD llist.inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> infinite_chain_lnth_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lfinite <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">r</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">(</span>lnth <span class="free">c</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>lnth <span class="free">c</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms chain_lnth_rel lfinite_conv_llength_enat <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> lnth_rel_chain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> enat <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">xs</span> <span class="main">⟶</span> <span class="free">R</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chain.coinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> chain
  <span class="keyword1"><span class="command">note</span></span> nnul <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> nth_chain <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lnull <span class="main">(</span>ltl <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> LCons <span class="main">(</span>lhd <span class="skolem">xs</span><span class="main">)</span> LNil"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nnul True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> llist.expand<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> nnul'<span class="main">:</span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> LCons <span class="main">(</span>lhd <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>ltl <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nnul <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> enat <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="main">(</span>ltl <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">R</span> <span class="main">(</span>lnth <span class="main">(</span>ltl <span class="skolem">xs</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>lnth <span class="main">(</span>ltl <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nnul nth_chain
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 ldrop_eSuc_ltl ldropn_Suc_conv_ldropn ldropn_eq_LConsD lnth_ltl<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span>lhd <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>lhd <span class="main">(</span>ltl <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nnul' nnul nth_chain<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ldropn_0 ldropn_Suc_conv_ldropn ldropn_eq_LConsD lhd_LCons_ltl lhd_conv_lnth
          lnth_Suc_LCons ltl_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chain_lmap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">R'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R'</span> <span class="main">(</span>lmap <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> chain
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> LCons <span class="bound">y</span> LNil<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ys</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> LCons <span class="bound">x</span> <span class="bound">ys</span> <span class="main">∧</span> chain <span class="free">R</span> <span class="bound">ys</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="main">(</span>lhd <span class="bound">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chain.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> LCons <span class="bound">x</span> <span class="bound">ys</span> <span class="main">∧</span> chain <span class="free">R</span> <span class="bound">ys</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="main">(</span>lhd <span class="bound">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span> <span class="bound">x</span><span class="main">.</span> lmap <span class="free">f</span> <span class="skolem">xs</span> <span class="main">=</span> LCons <span class="bound">x</span> <span class="bound">ys</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">=</span> lmap <span class="free">f</span> <span class="bound">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">R'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> chain <span class="free">R</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">R'</span> <span class="bound">x</span> <span class="main">(</span>lhd <span class="bound">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chain
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> lhd_LCons llist.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> llist.exhaust_sel llist.map_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
          lmap_eq_LNil chain_not_lnull ltl_lmap ltl_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chain_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">R'</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R'</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> chain_lmap<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> llist.map_ident<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lfinite_chain_imp_rtranclp_lhd_llast<span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">xs</span> <span class="main">⟹</span> chain <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>lhd <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>llast <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lfinite.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lfinite_LConsI <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> fin_xs <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ih <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> r_x_xs <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> LNil"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> xs_nnil<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_x_xs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> chain.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> r_xs<span class="main">]</span> xs_nnil r_x_xs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chain.cases converse_rtranclp_into_rtranclp lhd_LCons llast_LCons chain_not_lnull
          ltl_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> tranclp_imp_exists_finite_chain_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> chain <span class="free">R</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tranclp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>r_into_trancl <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chain.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>trancl_into_trancl <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> rstar_xy <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ih <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> r_yz <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    xs<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ys_def <span class="keyword1"><span class="command">using</span></span> r_yz chain_lappend<span class="main">[</span><span class="operator">OF</span> xs chain_singleton<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lappend_llist_of_LCons llast_LCons<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> chain_consE<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="main">(</span>LCons <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> chain_nontrivE<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="main">(</span>LCons <span class="free">x</span> <span class="main">(</span>LCons <span class="free">y</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A Coinductive Puzzle›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">prepend</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prepend</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prepend</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> LCons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">prepend</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lnull_prepend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lnull <span class="main">(</span>prepend <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> lnull <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lhd_prepend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lhd <span class="main">(</span>prepend <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span> hd <span class="free">xs</span> <span class="keyword1">else</span> lhd <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_LNil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prepend <span class="free">xs</span> LNil <span class="main">=</span> llist_of <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lfinite_prepend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite <span class="main">(</span>prepend <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> lfinite <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> llength_prepend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>prepend <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> llength <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> enat_0 iadd_Suc eSuc_enat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> llast_prepend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="free">ys</span> <span class="main">⟹</span> llast <span class="main">(</span>prepend <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> llast <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> llast_LCons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_prepend<span class="main">:</span> <span class="quoted"><span class="quoted">"prepend <span class="free">xs</span> <span class="main">(</span>prepend <span class="free">ys</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> prepend <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> chain_prepend<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="main">(</span>llist_of <span class="free">zs</span><span class="main">)</span> <span class="main">⟹</span> last <span class="free">zs</span> <span class="main">=</span> lhd <span class="free">xs</span> <span class="main">⟹</span> chain <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> chain <span class="free">R</span> <span class="main">(</span>prepend <span class="free">zs</span> <span class="main">(</span>ltl <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lnull_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> chain_cons <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> chain_consE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lmap_prepend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lmap <span class="free">f</span> <span class="main">(</span>prepend <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> prepend <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>lmap <span class="free">f</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lset_prepend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lset <span class="main">(</span>prepend <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∪</span> lset <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_LCons<span class="main">:</span> <span class="quoted"><span class="quoted">"prepend <span class="free">xs</span> <span class="main">(</span>LCons <span class="free">y</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> prepend <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lnth_prepend<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lnth <span class="main">(</span>prepend <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="keyword1">then</span> nth <span class="free">xs</span> <span class="free">i</span> <span class="keyword1">else</span> lnth <span class="free">ys</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lnth_LCons' nth_Cons'<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> lfinite_less_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> less<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> lfinite <span class="bound">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">zs</span><span class="main">.</span> llength <span class="bound">zs</span> <span class="main">&lt;</span> llength <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"the_enat <span class="main">(</span>llength <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> less<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lfinite_llength_enat <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eSuc_enat <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_enatE llength_eq_enat_lfiniteD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> lfinite_prepend_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> LNil prepend<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> LNil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> LNil"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prepend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> lfinite <span class="bound">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">zs</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">=</span> prepend <span class="bound">ys</span> <span class="bound">zs</span> <span class="main">∧</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lfinite_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LNil neq_Nil_conv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lfinite_llength_enat <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prepend<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"LCons <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">emb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> llist <span class="main">⇒</span> <span class="tfree">'a</span> llist <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"lfinite <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">emb</span> LNil <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">emb</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟹</span> <span class="free">emb</span> <span class="main">(</span>LCons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>prepend <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">(</span>LCons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> emb_LConsE<span class="main">:</span> <span class="quoted"><span class="quoted">"emb <span class="main">(</span>LCons <span class="free">z</span> <span class="free">zs</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> emb_LNil1E<span class="main">:</span> <span class="quoted"><span class="quoted">"emb LNil <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> emb_LNil2E<span class="main">:</span> <span class="quoted"><span class="quoted">"emb <span class="free">xs</span> LNil"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_lfinite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"emb <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">ys</span> <span class="main">⟷</span> lfinite <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lfinite_induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lnull_def neq_LNil_conv <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> emb_LNil1E emb_LConsE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lfinite_less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> less.prems <span class="quoted"><span class="quoted">‹lfinite <span class="skolem">ys</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eSuc_enat <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> emb_LNil1E emb_LConsE less.IH<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lfinite_llength_enat<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">prepend_cong1</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">X</span> <span class="keyword2"><span class="keyword">where</span></span>
  prepend_cong1_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">prepend_cong1</span> <span class="free">X</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> prepend_cong1_prepend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prepend_cong1</span> <span class="free">X</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟹</span> <span class="free">prepend_cong1</span> <span class="free">X</span> <span class="main">(</span>prepend <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_prepend_coinduct<span class="main">[</span><span class="operator">rotated</span><span class="main">,</span> <span class="operator">case_names</span> emb<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x1</span> <span class="bound">x2</span><span class="main">.</span> <span class="free">X</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">x1</span> <span class="main">=</span> LNil <span class="main">∧</span> <span class="bound">x2</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">∧</span> lfinite <span class="bound">xs</span><span class="main">)</span>
     <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">x</span> <span class="bound">zs</span><span class="main">.</span> <span class="bound">x1</span> <span class="main">=</span> LCons <span class="bound">x</span> <span class="bound">xs</span> <span class="main">∧</span> <span class="bound">x2</span> <span class="main">=</span> prepend <span class="bound">zs</span> <span class="main">(</span>LCons <span class="bound">x</span> <span class="bound">ys</span><span class="main">)</span>
       <span class="main">∧</span> <span class="main">(</span>prepend_cong1 <span class="main">(</span><span class="free">X</span> <span class="bound">xs</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">∨</span> emb <span class="bound">xs</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x1</span> <span class="bound">x2</span><span class="main">.</span> <span class="free">X</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="main">⟹</span> <span class="var">?bisim</span> <span class="bound">x1</span> <span class="bound">x2</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">x1</span> <span class="free">x2</span> <span class="main">⟹</span> emb <span class="free">x1</span> <span class="free">x2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> emb.coinduct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prepend_cong1_base<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">zs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"prepend_cong1 <span class="main">(</span><span class="free">X</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bisim</span> <span class="skolem">xs</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prepend_cong1.induct<span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prepend_prepend<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">chain'</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">chain'</span> <span class="free">R</span> <span class="main">(</span>LCons <span class="free"><span class="bound"><span class="entity">x</span></span></span> LNil<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">@</span> <span class="main">[</span>lhd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">chain'</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">chain'</span> <span class="free">R</span> <span class="main">(</span>LCons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>prepend <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> chain_imp_chain'<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> chain' <span class="free">R</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chain'.coinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> chain'
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chain.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>chain_cons <span class="skolem">zs</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI2 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">zs</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chain.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> chain'_imp_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"chain' <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> chain <span class="free">R</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chain.coinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> chain
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chain'.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">y</span> <span class="skolem">zs</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI2 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"prepend <span class="skolem"><span class="skolem"><span class="skolem">zs</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">ys</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> neq_Nil_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> chain.cases chain_nontrivE
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chain'.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> chain_chain'<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">=</span> chain'"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chain_imp_chain' chain'_imp_chain<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chain_prepend_coinduct<span class="main">[</span><span class="operator">case_names</span> chain<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">X</span> <span class="bound">x</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> LCons <span class="bound">z</span> LNil<span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="bound">xs</span> <span class="bound">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> LCons <span class="bound">y</span> <span class="main">(</span>prepend <span class="bound">zs</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="free">X</span> <span class="bound">xs</span> <span class="main">∨</span> chain <span class="free">R</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">∧</span> chain <span class="free">R</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span>lhd <span class="bound">xs</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> chain <span class="free">R</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> chain_chain'<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> chain'.coinduct<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chain_chain'<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">pick</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pick</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">xs</span><span class="main">.</span> chain <span class="free">R</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> pick<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="free">x</span> <span class="main">#</span> pick <span class="free">x</span> <span class="free">y</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pick_def <span class="keyword1"><span class="command">using</span></span> tranclp_imp_exists_finite_chain_list<span class="main">[</span><span class="operator">THEN</span> someI_ex<span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">friend_of_corec</span></span> prepend <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"prepend <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">xs</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">ys</span> <span class="keyword1">of</span> LNil <span class="main">⇒</span> LNil <span class="main">|</span> LCons <span class="bound">x</span> <span class="bound">xs</span> <span class="main">⇒</span> LCons <span class="bound">x</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs'</span> <span class="main">⇒</span> LCons <span class="bound">x</span> <span class="main">(</span>prepend <span class="bound">xs'</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits llist.splits<span class="main">)</span> <span class="operator">transfer_prover</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">corec</span></span> <span class="entity">wit</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wit</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">of</span> LCons <span class="bound">x</span> <span class="main">(</span>LCons <span class="bound">y</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⇒</span>
     LCons <span class="bound">x</span> <span class="main">(</span>prepend <span class="main">(</span>pick <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">wit</span> <span class="main">(</span>LCons <span class="bound">y</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span>
  wit_LNil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wit LNil <span class="main">=</span> LNil"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  wit_lsingleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wit <span class="main">(</span>LCons <span class="free">x</span> LNil<span class="main">)</span> <span class="main">=</span> LCons <span class="free">x</span> LNil"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  wit_LCons2<span class="main">:</span> <span class="quoted"><span class="quoted">"wit <span class="main">(</span>LCons <span class="free">x</span> <span class="main">(</span>LCons <span class="free">y</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>LCons <span class="free">x</span> <span class="main">(</span>prepend <span class="main">(</span>pick <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>wit <span class="main">(</span>LCons <span class="free">y</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> wit.code<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> lnull_wit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lnull <span class="main">(</span>wit <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> lnull <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> wit.code<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> llist.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> lhd_wit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">xs</span> <span class="main">⟹</span> lhd <span class="main">(</span>wit <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> lhd <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> chain.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">subst</span> wit.code<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> llist.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> LNil_eq_iff_lnull<span class="main">:</span> <span class="quoted"><span class="quoted">"LNil <span class="main">=</span> <span class="free">xs</span> <span class="main">⟷</span> lnull <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_wit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">xs</span> <span class="main">⟹</span> emb <span class="free">xs</span> <span class="main">(</span>wit <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> emb_prepend_coinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>emb <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chain.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>chain_cons <span class="skolem">zs</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wit.code<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> llist.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">::</span> <span class="main">_</span> llist"</span></span><span class="main"><span class="main">]</span></span>
          prepend_cong1_prepend<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prepend_cong1_base<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">LNil</span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span> emb.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> lfinite_wit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="main">(</span>wit <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> lfinite <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> emb_wit emb_lfinite assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> llast_wit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"llast <span class="main">(</span>wit <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> llast <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">xs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lfinite.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lfinite_LConsI <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wit_LCons2 llast_LCons <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> chain_nontrivE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> llast_linfinite assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chain_tranclp_imp_exists_chain<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chain <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">xs</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> chain <span class="free">R</span> <span class="bound">ys</span> <span class="main">∧</span> emb <span class="free">xs</span> <span class="bound">ys</span> <span class="main">∧</span> lhd <span class="bound">ys</span> <span class="main">=</span> lhd <span class="free">xs</span> <span class="main">∧</span> llast <span class="bound">ys</span> <span class="main">=</span> llast <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"wit <span class="free"><span class="free">xs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chain_prepend_coinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> chain
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> wit.code<span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> chain.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> llist.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pick<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_lset_mono<span class="main">[</span><span class="operator">rotated</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lset <span class="free">xs</span> <span class="main">⟹</span> emb <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> lset <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> llist.set_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> emb_LConsE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_Ball_lset_antimono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"emb <span class="free">Xs</span> <span class="free">Ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Y</span> <span class="main">∈</span> lset <span class="free">Ys</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> lset <span class="free">Xs</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> emb_lset_mono<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_lfinite_antimono<span class="main">[</span><span class="operator">rotated</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">ys</span> <span class="main">⟹</span> emb <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> lfinite <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lfinite_prepend_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> emb_LNil2E <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LNil_eq_iff_lnull prepend_LCons <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> emb.cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_Liminf_llist_mono_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"emb <span class="free">Xs</span> <span class="free">Ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lfinite <span class="free">Xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lfinite <span class="free">Ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> lnth <span class="free">Ys</span> <span class="bound">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> lnth <span class="free">Xs</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Xs</span></span> <span class="quoted"><span class="free">Ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> emb_Ball_lset_antimono<span class="main">[</span><span class="operator">OF</span> less<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> less<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> Ball_def in_lset_conv_lnth simp_thms
        not_lfinite_llength<span class="main">[</span><span class="operator">OF</span> less<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> not_lfinite_llength<span class="main">[</span><span class="operator">OF</span> less<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> enat_ord_code subset_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Xs</span> <span class="main">=</span> LCons <span class="skolem">b</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ys</span> <span class="main">=</span> prepend <span class="skolem">as</span> <span class="main">(</span>LCons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"emb <span class="skolem">xs</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> emb.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≥</span><span class="skolem">j</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> lnth <span class="skolem">xs</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≥</span><span class="skolem">j</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> lnth <span class="skolem">bs</span> <span class="bound">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
      <span class="keyword1"><span class="command">using</span></span> that less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹emb <span class="skolem">xs</span> <span class="skolem">bs</span>›</span></span><span class="main">]</span> less<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≥</span><span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">as</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> lnth <span class="skolem">xs</span> <span class="bound">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> IH allI<span class="main">)</span>
        <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> length <span class="skolem"><span class="skolem"><span class="skolem">as</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lnth_prepend lnth_LCons'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lnth_LCons'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_Liminf_llist_infinite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"emb <span class="free">Xs</span> <span class="free">Ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lfinite <span class="free">Xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Liminf_llist <span class="free">Ys</span> <span class="main">⊆</span> Liminf_llist <span class="free">Xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lfinite <span class="free">Ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> emb_lfinite_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_lfinite_llength <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> emb_Liminf_llist_mono_aux<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_lmap<span class="main">:</span> <span class="quoted"><span class="quoted">"emb <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> emb <span class="main">(</span>lmap <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>lmap <span class="free">f</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> emb.coinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> emb
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> xs<span class="main">:</span> <span class="main">(</span>LCons <span class="skolem">x</span> <span class="skolem">xs'</span><span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ysa0</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">zs0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> prepend <span class="skolem">zs0</span> <span class="main">(</span>LCons <span class="skolem">x</span> <span class="skolem">ysa0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      emb'<span class="main">:</span> <span class="quoted"><span class="quoted">"emb <span class="skolem">xs'</span> <span class="skolem">ysa0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> emb_LConsE<span class="main">[</span><span class="operator">OF</span> emb<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> xs<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xsa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lmap <span class="free">f</span> <span class="skolem">xs'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="skolem">zs0</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ysa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lmap <span class="free">f</span> <span class="skolem">ysa0</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lmap <span class="free">f</span> <span class="skolem">xs</span> <span class="main">=</span> LCons <span class="var">?xa</span> <span class="var">?xsa</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lmap <span class="free">f</span> <span class="skolem">ys</span> <span class="main">=</span> prepend <span class="var">?zs</span> <span class="main">(</span>LCons <span class="var">?xa</span> <span class="var">?ysa</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ys <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xsa</span> <span class="bound">ysa</span><span class="main">.</span> <span class="var">?xsa</span> <span class="main">=</span> lmap <span class="free">f</span> <span class="bound">xsa</span> <span class="main">∧</span> <span class="var">?ysa</span> <span class="main">=</span> lmap <span class="free">f</span> <span class="bound">ysa</span> <span class="main">∧</span> emb <span class="bound">xsa</span> <span class="bound">ysa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> emb' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emb_lfinite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> emb<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chain_inf_llist_if_infinite_chain_function<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lfinite <span class="main">(</span>inf_llist <span class="free">f</span><span class="main">)</span> <span class="main">∧</span> chain <span class="free">r</span><span class="main">¯¯</span> <span class="main">(</span>inf_llist <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lnth_rel_chain<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> infinite_chain_function_iff_infinite_chain_llist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="main">(</span><span class="bound">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> <span class="main">¬</span> lfinite <span class="bound">c</span> <span class="main">∧</span> chain <span class="free">r</span><span class="main">¯¯</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chain_inf_llist_if_infinite_chain_function infinite_chain_lnth_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> wfP_iff_no_infinite_down_chain_llist<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∄</span><span class="bound">c</span><span class="main">.</span> <span class="main">¬</span> lfinite <span class="bound">c</span> <span class="main">∧</span> chain <span class="free">r</span><span class="main">¯¯</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="free">r</span> <span class="main">⟷</span>  wf <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wfP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∄</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_iff_no_infinite_down_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∄</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="main">(</span><span class="bound">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∄</span><span class="bound">c</span><span class="main">.</span> <span class="main">¬</span>lfinite <span class="bound">c</span> <span class="main">∧</span> chain <span class="free">r</span><span class="main">¯¯</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> infinite_chain_function_iff_infinite_chain_llist <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Full Chains›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">full_chain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> llist <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  full_chain_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">¬</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">full_chain</span> <span class="free">R</span> <span class="main">(</span>LCons <span class="free"><span class="bound"><span class="entity">x</span></span></span> LNil<span class="main">)</span>"</span></span>
<span class="main">|</span> full_chain_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">full_chain</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>lhd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">full_chain</span> <span class="free">R</span> <span class="main">(</span>LCons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  full_chain_LNil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> full_chain <span class="free">R</span> LNil"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  full_chain_not_lnull<span class="main">:</span> <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">¬</span> lnull <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> full_chain.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> full_chain_ldropn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> full<span class="main">:</span> <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> llength <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="main">(</span>ldropn <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> full_chain.cases ldrop_eSuc_ltl ldropn_LNil ldropn_eq_LNil ltl_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> not_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> full_chain_iff_chain<span class="main">:</span>
  <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="free">xs</span> <span class="main">⟷</span> chain <span class="free">R</span> <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span>lfinite <span class="free">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">¬</span> <span class="free">R</span> <span class="main">(</span>llast <span class="free">xs</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI conjI impI allI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> full<span class="main">:</span> <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="free">xs</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> full <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> full_chain.cases<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      suc_n<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">=</span> llength <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chain chain_length_pos lessE less_enatE lfinite_conv_llength_enat<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="main">(</span>ldropn <span class="skolem">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> full_chain_ldropn<span class="main"><span class="main">[</span></span><span class="operator">OF</span> full<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> suc_n Suc_ile_eq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ldropn <span class="skolem">n</span> <span class="free">xs</span> <span class="main">=</span> LCons <span class="main">(</span>llast <span class="free">xs</span><span class="main">)</span> LNil"</span></span>
      <span class="keyword1"><span class="command">using</span></span> suc_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enat_le_plus_same<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> enat_ord_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gen_llength_def
          ldropn_Suc_conv_ldropn ldropn_all lessI llast_ldropn llast_singleton llength_code<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">R</span> <span class="main">(</span>llast <span class="free">xs</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> full_chain.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"lfinite <span class="free">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">¬</span> <span class="free">R</span> <span class="main">(</span>llast <span class="free">xs</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> chain.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> lfinite_LConsI llast_LCons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> full_chain_imp_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> chain <span class="free">R</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> full_chain_iff_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> full_chain_length_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> llength <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> chain_length_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> full_chain_imp_chain<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> full_chain_lnth_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> enat <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">xs</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>lnth <span class="free">xs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> chain_lnth_rel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> full_chain_imp_chain<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> full_chain_consE<span class="main">:</span> <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="main">(</span>LCons <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> full_chain_nontrivE<span class="main">:</span> <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="main">(</span>LCons <span class="free">x</span> <span class="main">(</span>LCons <span class="free">y</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> full_chain_tranclp_imp_exists_full_chain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> full<span class="main">:</span> <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> full_chain <span class="free">R</span> <span class="bound">ys</span> <span class="main">∧</span> emb <span class="free">xs</span> <span class="bound">ys</span> <span class="main">∧</span> lhd <span class="bound">ys</span> <span class="main">=</span> lhd <span class="free">xs</span> <span class="main">∧</span> llast <span class="bound">ys</span> <span class="main">=</span> llast <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys<span class="main">:</span>
    <span class="quoted"><span class="quoted">"chain <span class="free">R</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"emb <span class="free">xs</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"lhd <span class="skolem">ys</span> <span class="main">=</span> lhd <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"llast <span class="skolem">ys</span> <span class="main">=</span> llast <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> full_chain_imp_chain<span class="main">[</span><span class="operator">OF</span> full<span class="main">]</span> chain_tranclp_imp_exists_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"full_chain <span class="free">R</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ys<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> emb_lfinite<span class="main">[</span><span class="operator">OF</span> ys<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> full <span class="keyword1"><span class="command">unfolding</span></span> full_chain_iff_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ys<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Clausal_Logic">
<div class="head">
<h1>Theory Clausal_Logic</h1>
</div>
<pre class="source"><span class="comment1">(* Title:        Clausal Logic
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Author:      Mathias Fleury &lt;mathias.fleury at mpi-inf.mpg.de&gt;, 2014
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Clausal Logic›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Clausal_Logic
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../Nested_Multisets_Ordinals/Multiset_More.html">Nested_Multisets_Ordinals.Multiset_More</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Resolution operates of clauses, which are disjunctions of literals. The material formalized here
corresponds roughly to Sections 2.1 (``Formulas and Clauses'') of Bachmair and Ganzinger, excluding
the formula and term syntax.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Literals›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Literals consist of a polarity (positive or negative) and an atom, of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> literal <span class="main">=</span>
  <span class="entity">is_pos</span><span class="main">:</span> Pos <span class="main">(</span><span class="free"><span class="entity">atm_of</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span>
<span class="main">|</span> Neg <span class="main">(</span>atm_of<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">is_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_neg</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> <span class="main">¬</span> is_pos <span class="free"><span class="bound"><span class="entity">L</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Pos_atm_of_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="main">(</span>atm_of <span class="free">L</span><span class="main">)</span> <span class="main">=</span> <span class="free">L</span> <span class="main">⟷</span> is_pos <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Neg_atm_of_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="main">(</span>atm_of <span class="free">L</span><span class="main">)</span> <span class="main">=</span> <span class="free">L</span> <span class="main">⟷</span> is_neg <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_literal_atm_of<span class="main">:</span> <span class="quoted"><span class="quoted">"set_literal <span class="free">L</span> <span class="main">=</span> <span class="main">{</span>atm_of <span class="free">L</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_lit_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> <span class="free">P</span> <span class="bound">L</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Pos <span class="bound">A</span><span class="main">)</span> <span class="main">∨</span> <span class="free">P</span> <span class="main">(</span>Neg <span class="bound">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> literal.exhaust<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> literal <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">uminus</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">uminus_literal</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal <span class="main">⇒</span> <span class="tfree">'a</span> literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"uminus <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_pos <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">then</span> Neg <span class="keyword1">else</span> Pos<span class="main">)</span> <span class="main">(</span>atm_of <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  uminus_Pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> Pos <span class="free">A</span> <span class="main">=</span> Neg <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  uminus_Neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> Neg <span class="free">A</span> <span class="main">=</span> Pos <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uminus_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> atm_of_uminus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atm_of <span class="main">(</span><span class="main">-</span><span class="free">L</span><span class="main">)</span> <span class="main">=</span> atm_of <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> uminus_of_uminus_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'v</span> literal<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uminus_literal_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> uminus_not_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span> <span class="tfree">'v</span> literal<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> uminus_not_id'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span> <span class="tfree">'v</span> literal<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> uminus_eq_inj<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'v</span> literal<span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span><span class="main">)</span> <span class="operator">auto</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> uminus_lit_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span> literal<span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="free">b</span> <span class="main">⟷</span> <span class="main">-</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_pos_neg_not_is_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pos <span class="main">(</span><span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span> is_pos <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instantiation</span></span> literal <span class="main">::</span> <span class="main">(</span><span class="quoted">preorder</span><span class="main">)</span> <span class="quoted">preorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_literal</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal <span class="main">⇒</span> <span class="tfree">'a</span> literal <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_literal</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟷</span> atm_of <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">&lt;</span> atm_of <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∨</span> atm_of <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≤</span> atm_of <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> is_neg <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">&lt;</span> is_neg <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_literal</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal <span class="main">⇒</span> <span class="tfree">'a</span> literal <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq_literal</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟷</span> atm_of <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">&lt;</span> atm_of <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∨</span> atm_of <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≤</span> atm_of <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> is_neg <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≤</span> is_neg <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_literal_def less_eq_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_le_not_le<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> literal <span class="main">::</span> <span class="main">(</span><span class="quoted">order</span><span class="main">)</span> <span class="quoted">order</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_literal_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> literal.expand<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_less_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">&lt;</span> Neg <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_less_pos_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">&lt;</span> Pos <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">&lt;</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_less_neg_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">&lt;</span> Neg <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_le_not_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_less_pos_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">&lt;</span> Pos <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">&lt;</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_less_neg_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">&lt;</span> Neg <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">&lt;</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_le_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">≤</span> Neg <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_le_pos_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">≤</span> Pos <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_le_not_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_le_neg_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">≤</span> Neg <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_le_pos_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">≤</span> Pos <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">&lt;</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_le_neg_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">≤</span> Neg <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leq_imp_less_eq_atm_of<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≤</span> <span class="free">M</span> <span class="main">⟹</span> atm_of <span class="free">L</span> <span class="main">≤</span> atm_of <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_literal_def <span class="keyword1"><span class="command">using</span></span> less_imp_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">instantiation</span></span> literal <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_literal_def less_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> literal <span class="main">::</span> <span class="main">(</span><span class="quoted">wellorder</span><span class="main">)</span> <span class="quoted">wellorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">intro_classes</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">L</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">&lt;</span> <span class="bound">L</span> <span class="main">⟹</span> <span class="skolem">P</span> <span class="bound">M</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">P</span> <span class="bound">L</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">P</span> <span class="main">(</span>Pos <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="main">(</span>Neg <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">P</span> <span class="main">(</span>Pos <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="main">(</span>Neg <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ih ih<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_literal_def atm_of_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> literal.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ih<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">(</span>Pos <span class="bound">A</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="main">(</span>Neg <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less_induct<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">L</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Clauses›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Clauses are (finite) multisets of literals.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> clause <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal multiset"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">map_clause</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'b</span> clause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_clause</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> image_mset <span class="main">(</span>map_literal <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_clause</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'b</span> clause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel_clause</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> rel_mset <span class="main">(</span>rel_literal <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">poss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">poss</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">≡</span> <span class="main">{#</span>Pos <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">negs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">negs</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">≡</span> <span class="main">{#</span>Neg <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">#}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_in_lits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> Max_mset <span class="free">C</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_atm_of_set_mset_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> Max <span class="main">(</span>atm_of <span class="main">`</span> set_mset <span class="free">C</span><span class="main">)</span> <span class="main">=</span> atm_of <span class="main">(</span>Max_mset <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mono_Max_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_def less_eq_literal_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_pos_neg_less_multiset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> max<span class="main">:</span> <span class="quoted"><span class="quoted">"Max_mset <span class="free">C</span> <span class="main">=</span> Pos <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> neg<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">∈#</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">&lt;</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max_mset <span class="free">C</span> <span class="main">&lt;</span> Neg <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> max <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> neg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Max_less_iff empty_iff ex_gt_imp_less_multiset finite_set_mset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_Max_imp_neg_notin<span class="main">:</span> <span class="quoted"><span class="quoted">"Max_mset <span class="free">C</span> <span class="main">=</span> Pos <span class="free">A</span> <span class="main">⟹</span> Neg <span class="free">A</span> <span class="main">∉#</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Max_pos_neg_less_multiset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> less_eq_Max_lit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> Max_mset <span class="free">C</span> <span class="main">≤</span> Max_mset <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> less_eq_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ex_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="free">D</span> <span class="bound">x</span> <span class="main">&lt;</span> count <span class="free">C</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">y</span></span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">.</span> count <span class="free">C</span> <span class="bound">y</span> <span class="main">&lt;</span> count <span class="free">D</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ne <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max_mset <span class="free">C</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_in_lits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈#</span> <span class="free">D</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">l</span> <span class="main">&lt;</span> Max_mset <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_gt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_greater_zero_iff count_inI less_not_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Max_mset <span class="free">D</span> <span class="main">&lt;</span> Max_mset <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max.coboundedI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_set_mset<span class="main"><span class="main">]</span></span> le_less_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atms_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atms_of</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> atm_of <span class="main">`</span> set_mset <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atms_of_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atms_of <span class="main">{#}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> atms_of_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atms_of <span class="main">{#</span><span class="free">L</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{</span>atm_of <span class="free">L</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> atms_of_add_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atms_of <span class="main">(</span>add_mset <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>atm_of <span class="free">a</span><span class="main">)</span> <span class="main">(</span>atms_of <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> atms_of_union_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atms_of <span class="main">(</span><span class="free">A</span> <span class="main">∪#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> atms_of <span class="free">A</span> <span class="main">∪</span> atms_of <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_atms_of<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>atms_of <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atms_of_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atm_of_lit_in_atms_of<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> atm_of <span class="free">L</span> <span class="main">∈</span> atms_of <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atms_of_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atms_of_plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atms_of <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> atms_of <span class="free">C</span> <span class="main">∪</span> atms_of <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_atms_of_minusD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> atms_of <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_of_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_diffD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_lit_in_atms_of<span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> atms_of <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_lit_in_atms_of<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> atms_of <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> atm_imp_pos_or_neg_lit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> atms_of <span class="free">C</span> <span class="main">⟹</span> Pos <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">∨</span> Neg <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def image_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Neg_atm_of_iff Pos_atm_of_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atm_iff_pos_or_neg_lit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> atms_of <span class="free">L</span> <span class="main">⟷</span> Pos <span class="free">A</span> <span class="main">∈#</span> <span class="free">L</span> <span class="main">∨</span> Neg <span class="free">A</span> <span class="main">∈#</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pos_lit_in_atms_of neg_lit_in_atms_of <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> atm_imp_pos_or_neg_lit<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atm_of_eq_atm_of<span class="main">:</span> <span class="quoted"><span class="quoted">"atm_of <span class="free">L</span> <span class="main">=</span> atm_of <span class="free">L'</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">L</span> <span class="main">=</span> <span class="free">L'</span> <span class="main">∨</span> <span class="free">L</span> <span class="main">=</span> <span class="main">-</span><span class="free">L'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">L'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> atm_of_in_atm_of_set_iff_in_set_or_uminus_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"atm_of <span class="free">L</span> <span class="main">∈</span> atm_of <span class="main">`</span> <span class="free">I</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">L</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">-</span><span class="free">L</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atm_of_eq_atm_of<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lits_subseteq_imp_atms_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">C</span> <span class="main">⊆</span> set_mset <span class="free">D</span> <span class="main">⟹</span> atms_of <span class="free">C</span> <span class="main">⊆</span> atms_of <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> atms_empty_iff_empty<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atms_of <span class="free">C</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def image_def Collect_empty_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>
  atms_of_poss<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atms_of <span class="main">(</span>poss <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="free">AA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  atms_of_negs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atms_of <span class="main">(</span>negs <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="free">AA</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> less_eq_Max_atms_of<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> Max <span class="main">(</span>atms_of <span class="free">C</span><span class="main">)</span> <span class="main">≤</span> Max <span class="main">(</span>atms_of <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_atm_of_set_mset_commute leq_imp_less_eq_atm_of less_eq_Max_lit
      less_eq_multiset_empty_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> le_multiset_Max_in_imp_Max<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max <span class="main">(</span>atms_of <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> atms_of <span class="free">C</span> <span class="main">⟹</span> Max <span class="main">(</span>atms_of <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max.coboundedI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_atms_of<span class="main"><span class="main">]</span></span> atms_of_def empty_iff eq_iff image_subsetI
      less_eq_Max_atms_of set_mset_empty subset_Compl_self_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atm_of_Max_lit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> atm_of <span class="main">(</span>Max_mset <span class="free">C</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span>atms_of <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def Max_atm_of_set_mset_commute <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_lit_eq_pos_or_neg_Max_atm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> Max_mset <span class="free">C</span> <span class="main">=</span> Pos <span class="main">(</span>Max <span class="main">(</span>atms_of <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> Max_mset <span class="free">C</span> <span class="main">=</span> Neg <span class="main">(</span>Max <span class="main">(</span>atms_of <span class="free">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Neg_atm_of_iff Pos_atm_of_iff atm_of_Max_lit<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atms_less_imp_lit_less_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> atms_of <span class="free">C</span> <span class="main">⟹</span> <span class="bound">B</span> <span class="main">&lt;</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">L</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">L</span> <span class="main">&lt;</span> Pos <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def less_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> atms_less_eq_imp_lit_less_eq_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> atms_of <span class="free">C</span> <span class="main">⟹</span> <span class="bound">B</span> <span class="main">≤</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">L</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">L</span> <span class="main">≤</span> Neg <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_literal_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atm_of_lit_in_atms_of<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Herbrand_Interpretation">
<div class="head">
<h1>Theory Herbrand_Interpretation</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Herbrand Interpretation
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Maintainer:  Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Herbrand Intepretation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Herbrand_Interpretation
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Clausal_Logic.html">Clausal_Logic</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The material formalized here corresponds roughly to Sections 2.2 (``Herbrand
Interpretations'') of Bachmair and Ganzinger, excluding the formula and term
syntax.

A Herbrand interpretation is a set of ground atoms that are to be considered true.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> interp <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">true_lit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interp <span class="main">⇒</span> <span class="tfree">'a</span> literal <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨l</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1"><span class="free">⊨l</span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> is_pos <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span> <span class="keyword1">else</span> Not<span class="main">)</span> <span class="main">(</span>atm_of <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> true_lit_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨l</span> Pos <span class="free">A</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨l</span> Neg <span class="free">A</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> true_lit_iff<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨l</span> <span class="free">L</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span><span class="main">.</span> <span class="free">L</span> <span class="main">=</span> Pos <span class="bound">A</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="free">L</span> <span class="main">=</span> Neg <span class="bound">A</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">true_cls</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interp <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1">⊨l</span> <span class="bound">L</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_empty<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I</span> <span class="main">⊨</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_singleton<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span> <span class="main">⟷</span> <span class="free">I</span> <span class="keyword1">⊨l</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_add_mset<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> add_mset <span class="free">C</span> <span class="free">D</span> <span class="main">⟷</span> <span class="free">I</span> <span class="keyword1">⊨l</span> <span class="free">C</span> <span class="main">∨</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_union<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">+</span> <span class="free">D</span> <span class="main">⟷</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">∨</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">C</span> <span class="main">⊆</span> set_mset <span class="free">D</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_cls_def subset_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">J</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    false_to_true_imp_ex_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">J</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">A</span> <span class="main">∈</span> <span class="free">J</span><span class="main">.</span> Pos <span class="bound">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    true_to_false_imp_ex_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">J</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">A</span> <span class="main">∈</span> <span class="free">J</span><span class="main">.</span> Neg <span class="bound">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> subset_iff true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> literal.collapse true_lit_simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_replicate_mset<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> replicate_mset <span class="free">n</span> <span class="free">L</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">I</span> <span class="keyword1">⊨l</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> true_cls_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_literal_in_imp_true_cls<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_literal_notin_imp_true_cls<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_neg_in_imp_true<span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> Neg <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">true_clss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interp <span class="main">⇒</span> <span class="tfree">'a</span> clause set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨s</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1"><span class="free">⊨s</span></span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⊨</span> <span class="bound">C</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> true_clss_empty<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> true_clss_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> true_clss_singleton<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span> <span class="main">⟷</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> true_clss_insert<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> insert <span class="free">C</span> <span class="free">DD</span> <span class="main">⟷</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">DD</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> true_clss_union<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">CC</span> <span class="main">∪</span> <span class="free">DD</span> <span class="main">⟷</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">CC</span> <span class="main">∧</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">DD</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> true_clss_Union<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="main">⋃</span> <span class="free">CCC</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">CC</span> <span class="main">∈</span> <span class="free">CCC</span><span class="main">.</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="bound">CC</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> true_clss_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">DD</span> <span class="main">⊆</span> <span class="free">CC</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">CC</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">DD</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsetD true_clss_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> true_clss_mono_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">D</span> <span class="main">∈</span> <span class="free">DD</span><span class="main">.</span> <span class="main">∃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> <span class="bound">C</span> <span class="main">⊆#</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">CC</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">DD</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def true_cls_def true_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mset_subset_eqD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> true_clss_subclause<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆#</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="main">{</span><span class="free">D</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> true_clss_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">C</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">satisfiable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">satisfiable</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨s</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> satisfiable_antimono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="main">⊆</span> <span class="free">DD</span> <span class="main">⟹</span> satisfiable <span class="free">DD</span> <span class="main">⟹</span> satisfiable <span class="free">CC</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> true_clss_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> unsatisfiable_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="main">⊆</span> <span class="free">DD</span> <span class="main">⟹</span> <span class="main">¬</span> satisfiable <span class="free">CC</span> <span class="main">⟹</span> <span class="main">¬</span> satisfiable <span class="free">DD</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> satisfiable_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">true_cls_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interp <span class="main">⇒</span> <span class="tfree">'a</span> clause multiset <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨m</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1"><span class="free">⊨m</span></span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⊨</span> <span class="bound">C</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_mset_empty<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_mset_singleton<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> <span class="main">{#</span><span class="free">C</span><span class="main">#}</span> <span class="main">⟷</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> true_cls_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_mset_union<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> <span class="free">CC</span> <span class="main">+</span> <span class="free">DD</span> <span class="main">⟷</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="free">CC</span> <span class="main">∧</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="free">DD</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_mset_Union<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="free">CCC</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">CC</span> <span class="main">∈#</span> <span class="free">CCC</span><span class="main">.</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="bound">CC</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_mset_add_mset<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> add_mset <span class="free">C</span> <span class="free">CC</span> <span class="main">⟷</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="free">CC</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_mset_image_mset<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> image_mset <span class="free">f</span> <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">.</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_mset_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">DD</span> <span class="main">⊆</span> set_mset <span class="free">CC</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="free">CC</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="free">DD</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_cls_mset_def subset_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_mset_mono_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">D</span> <span class="main">∈#</span> <span class="free">DD</span><span class="main">.</span> <span class="main">∃</span><span class="bound">C</span> <span class="main">∈#</span> <span class="free">CC</span><span class="main">.</span> <span class="bound">C</span> <span class="main">⊆#</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="free">CC</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="free">DD</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_cls_mset_def true_cls_def true_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mset_subset_eqD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> true_clss_set_mset<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> set_mset <span class="free">CC</span> <span class="main">⟷</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="free">CC</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def true_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> true_clss_mset_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">CC</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨m</span> mset_set <span class="free">CC</span> <span class="main">⟷</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">CC</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def true_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> true_cls_mset_true_cls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> <span class="free">CC</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">∈#</span> <span class="free">CC</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> true_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abstract_Substitution">
<div class="head">
<h1>Theory Abstract_Substitution</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Abstract Substitutions
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2016, 2017
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract Substitutions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Abstract_Substitution
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Clausal_Logic.html">Clausal_Logic</a> <a href="Map2.html">Map2</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Atoms and substitutions are abstracted away behind some locales, to avoid having a direct dependency
on the IsaFoR library.

Conventions: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'s›</span></span></span></span> substitutions, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a›</span></span></span></span> atoms.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Library›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f_Suc_decr_eventually_const<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">l'</span></span> <span class="main">≥</span> <span class="bound">l</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">l'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">l</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">l'</span></span> <span class="main">≥</span> <span class="bound">l</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">l'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">&gt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">i'</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">l'</span></span> <span class="main">≥</span> <span class="skolem">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l'</span> <span class="main">≠</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">l'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      l'_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">≥</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="free">f</span> <span class="skolem">l'</span> <span class="main">≠</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">l'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">l'</span> <span class="main">&gt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">l'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> leq le_eq_less_or_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="free">f</span> <span class="skolem">l'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> leq l'_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">l'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lift_Suc_antimono_le<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i'</span></span> <span class="main">&gt;</span> <span class="skolem">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i'</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l'_p less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g_sm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    g_sm_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">g_sm</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">g_sm</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">c</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">g_sm</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">0</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c_def g_sm_p<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="skolem">c</span><span class="main">)</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">fc</span> <span class="main">::</span> nat <span class="main">⇒</span> nat<span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">fc</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="bound">fc</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> wf_less_than <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_iff_no_infinite_down_chain<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution Operators›</span></span>

<span class="keyword1"><span class="command">locale</span></span> substitution_ops <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">subst_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">id_subst</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">comp_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subst_atm_abbrev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅a</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_atm_abbrev</span> <span class="main">≡</span> <span class="free">subst_atm</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">comp_subst_abbrev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊙</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">comp_subst_abbrev</span> <span class="main">≡</span> <span class="free">comp_subst</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">comp_substs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> list <span class="main">⇒</span> <span class="tfree">'s</span> list <span class="main">⇒</span> <span class="tfree">'s</span> list"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊙s</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">σs</span></span></span> <span class="keyword1"><span class="free">⊙s</span></span> <span class="free"><span class="bound"><span class="entity">τs</span></span></span> <span class="main">=</span> map2 <span class="free">comp_subst</span> <span class="free"><span class="bound"><span class="entity">σs</span></span></span> <span class="free"><span class="bound"><span class="entity">τs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_atms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅as</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="keyword1"><span class="free">⋅as</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_atmss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅ass</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">AAA</span></span></span> <span class="keyword1"><span class="free">⋅ass</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">AA</span><span class="main">.</span> <span class="bound">AA</span> <span class="keyword1">⋅as</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">AAA</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_atm_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅al</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="keyword1"><span class="free">⋅al</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_atm_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> multiset"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅am</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="keyword1"><span class="free">⋅am</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">subst_atm_mset_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset list <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> multiset list"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅aml</span>"</span> 67<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">AAA</span></span></span> <span class="keyword1"><span class="free">⋅aml</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">AA</span><span class="main">.</span> <span class="bound">AA</span> <span class="keyword1">⋅am</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">AAA</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">subst_atm_mset_lists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset list <span class="main">⇒</span> <span class="tfree">'s</span> list <span class="main">⇒</span> <span class="tfree">'a</span> multiset list"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅⋅aml</span>"</span> 67<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="keyword1"><span class="free">⋅⋅aml</span></span> <span class="free"><span class="bound"><span class="entity">σs</span></span></span> <span class="main">=</span> map2 <span class="keyword1">(⋅am)</span> <span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="free"><span class="bound"><span class="entity">σs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_lit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> literal"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅l</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1"><span class="free">⋅l</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> map_literal <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atm_of_subst_lit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atm_of <span class="main">(</span><span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> atm_of <span class="free">L</span> <span class="keyword1">⋅a</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_cls</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main"><span class="free">⋅</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅l</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_clss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅cs</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="keyword1"><span class="free">⋅cs</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_cls_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause list <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> clause list"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅cl</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="keyword1"><span class="free">⋅cl</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_cls_lists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause list <span class="main">⇒</span> <span class="tfree">'s</span> list <span class="main">⇒</span> <span class="tfree">'a</span> clause list"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅⋅cl</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="keyword1"><span class="free">⋅⋅cl</span></span> <span class="free"><span class="bound"><span class="entity">σs</span></span></span> <span class="main">=</span> map2 <span class="main">(⋅)</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="free"><span class="bound"><span class="entity">σs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_cls_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause multiset <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> clause multiset"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅cm</span>"</span> 67<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">CC</span></span></span> <span class="keyword1"><span class="free">⋅cm</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_add_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">L</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> add_mset <span class="main">(</span><span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_mset_add_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">C</span> <span class="free">CC</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span> <span class="main">=</span> add_mset <span class="main">(</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">CC</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">generalizes_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generalizes_atm</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">⋅a</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strictly_generalizes_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strictly_generalizes_atm</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟷</span> generalizes_atm <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> <span class="main">¬</span> generalizes_atm <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">generalizes_lit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal <span class="main">⇒</span> <span class="tfree">'a</span> literal <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generalizes_lit</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">⋅l</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strictly_generalizes_lit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal <span class="main">⇒</span> <span class="tfree">'a</span> literal <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strictly_generalizes_lit</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟷</span> generalizes_lit <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> <span class="main">¬</span> generalizes_lit <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">generalizes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generalizes</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strictly_generalizes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strictly_generalizes</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⟷</span> generalizes <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∧</span> <span class="main">¬</span> generalizes <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subsumes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subsumes</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strictly_subsumes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strictly_subsumes</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⟷</span> subsumes <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∧</span> <span class="main">¬</span> subsumes <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">variants</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">variants</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⟷</span> generalizes <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∧</span> generalizes <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_renaming</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_renaming</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⊙</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free">id_subst</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_renaming_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_renaming_list</span> <span class="free"><span class="bound"><span class="entity">σs</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">σs</span></span></span><span class="main">.</span> is_renaming <span class="bound">σ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_renaming</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_renaming</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">τ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⊙</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free">id_subst</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ground_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ground_atm</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">⋅a</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ground_atms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ground_atms</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">.</span> is_ground_atm <span class="bound">A</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ground_atm_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ground_atm_list</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">.</span> is_ground_atm <span class="bound">A</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ground_atm_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ground_atm_mset</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">⟶</span> is_ground_atm <span class="bound">A</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ground_lit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ground_lit</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">⟷</span> is_ground_atm <span class="main">(</span>atm_of <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ground_cls</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ground_cls</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟶</span> is_ground_lit <span class="bound">L</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ground_clss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ground_clss</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span><span class="main">.</span> is_ground_cls <span class="bound">C</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ground_cls_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ground_cls_list</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">CC</span></span></span><span class="main">.</span> is_ground_cls <span class="bound">C</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ground_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ground_subst</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">.</span> is_ground_atm <span class="main">(</span><span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ground_subst_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ground_subst_list</span> <span class="free"><span class="bound"><span class="entity">σs</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">σs</span></span></span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">grounding_of_cls</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">grounding_of_cls</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">grounding_of_clss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">grounding_of_clss</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span><span class="main">.</span> grounding_of_cls <span class="bound">C</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_unifier</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_unifier</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">⟷</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="keyword1">⋅as</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_unifiers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_unifiers</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">AAA</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">AA</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">AAA</span></span></span><span class="main">.</span> is_unifier <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">AA</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_mgu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_mgu</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">AAA</span></span></span> <span class="main">⟷</span> is_unifiers <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">AAA</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> is_unifiers <span class="bound">τ</span> <span class="free"><span class="bound"><span class="entity">AAA</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">γ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⊙</span> <span class="bound">γ</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">var_disjoint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">var_disjoint</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">⟷</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">σs</span><span class="main">.</span> length <span class="bound">σs</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="main">⋅</span> <span class="bound">σs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">S</span> <span class="main">⋅</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution Lemmas›</span></span>

<span class="keyword1"><span class="command">locale</span></span> substitution <span class="main">=</span> substitution_ops <span class="quoted"><span class="free">subst_atm</span></span> <span class="quoted"><span class="free">id_subst</span></span> <span class="quoted"><span class="free">comp_subst</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">subst_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">id_subst</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">comp_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">renamings_apart</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause list <span class="main">⇒</span> <span class="tfree">'s</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">atm_of_atms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    subst_atm_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    subst_atm_comp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⋅a</span> <span class="main">(</span><span class="free">σ</span> <span class="main">⊙</span> <span class="free">τ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="keyword1">⋅a</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    subst_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">=</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    make_ground_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="main">(</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> is_ground_subst <span class="bound">τ</span> <span class="main">∧</span><span class="free">C</span> <span class="main">⋅</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wf_strictly_generalizes_atm<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP strictly_generalizes_atm"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    renamings_apart_length<span class="main">:</span>  <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">renamings_apart</span> <span class="free">Cs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">Cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    renamings_apart_renaming<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">renamings_apart</span> <span class="free">Cs</span><span class="main">)</span> <span class="main">⟹</span> is_renaming <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    renamings_apart_var_disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"var_disjoint <span class="main">(</span><span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="main">(</span><span class="free">renamings_apart</span> <span class="free">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    atm_of_atms_subst<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">As</span> <span class="bound">Bs</span><span class="main">.</span> <span class="free">atm_of_atms</span> <span class="bound">As</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">atm_of_atms</span> <span class="bound">Bs</span> <span class="main">⟷</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="bound">As</span> <span class="main">=</span> <span class="bound">Bs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_ext_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="free">τ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">=</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subst_ext<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Identity Substitution›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> id_subst_comp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">id_subst</span> <span class="main">⊙</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subst_ext<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_subst_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">⊙</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subst_ext<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> id_subst_comp_substs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>length <span class="free">σs</span><span class="main">)</span> <span class="free">id_subst</span> <span class="keyword1">⊙s</span> <span class="free">σs</span> <span class="main">=</span> <span class="free">σs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_substs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">σs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_substs_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σs</span> <span class="keyword1">⊙s</span> replicate <span class="main">(</span>length <span class="free">σs</span><span class="main">)</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">σs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_substs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">σs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atms_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AA</span> <span class="keyword1">⋅as</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">AA</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atmss_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AAA</span> <span class="keyword1">⋅ass</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">AAA</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atmss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_list_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">As</span> <span class="keyword1">⋅al</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">As</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AA</span> <span class="keyword1">⋅am</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">AA</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_list_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AAs</span> <span class="keyword1">⋅aml</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">AAs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_lists_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AAs</span> <span class="keyword1">⋅⋅aml</span> replicate <span class="main">(</span>length <span class="free">AAs</span><span class="main">)</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">AAs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">AAs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_lit_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> literal.map_ident<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⋅</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_clss_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="keyword1">⋅cs</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">CC</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_list_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_lists_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> replicate <span class="main">(</span>length <span class="free">Cs</span><span class="main">)</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_mset_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="keyword1">⋅cm</span> <span class="free">id_subst</span> <span class="main">=</span> <span class="free">CC</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Associativity of Composition›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_subst_assoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">⊙</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⊙</span> <span class="free">γ</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">⊙</span> <span class="free">τ</span> <span class="main">⊙</span> <span class="free">γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subst_ext<span class="main">)</span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Compatibility of Substitution and Composition›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atms_comp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AA</span> <span class="keyword1">⋅as</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">AA</span> <span class="keyword1">⋅as</span> <span class="free">τ</span> <span class="keyword1">⋅as</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atmss_comp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AAA</span> <span class="keyword1">⋅ass</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">AAA</span> <span class="keyword1">⋅ass</span> <span class="free">τ</span> <span class="keyword1">⋅ass</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atmss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_list_comp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">As</span> <span class="keyword1">⋅al</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">As</span> <span class="keyword1">⋅al</span> <span class="free">τ</span> <span class="keyword1">⋅al</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_comp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AA</span> <span class="keyword1">⋅am</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">AA</span> <span class="keyword1">⋅am</span> <span class="free">τ</span> <span class="keyword1">⋅am</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_list_comp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AAs</span> <span class="keyword1">⋅aml</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">AAs</span> <span class="keyword1">⋅aml</span> <span class="free">τ</span><span class="main">)</span> <span class="keyword1">⋅aml</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_lists_comp_substs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AAs</span> <span class="keyword1">⋅⋅aml</span> <span class="main">(</span><span class="free">τs</span> <span class="keyword1">⊙s</span> <span class="free">σs</span><span class="main">)</span> <span class="main">=</span> <span class="free">AAs</span> <span class="keyword1">⋅⋅aml</span> <span class="free">τs</span> <span class="keyword1">⋅⋅aml</span> <span class="free">σs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_lists_def comp_substs_def map_zip_map map_zip_map2 map_zip_assoc
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_lit_comp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="keyword1">⋅l</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">τ</span> <span class="keyword1">⋅l</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> literal.map_comp o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_comp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_clsscomp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="keyword1">⋅cs</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">CC</span> <span class="keyword1">⋅cs</span> <span class="free">τ</span> <span class="keyword1">⋅cs</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_list_comp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">τ</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_lists_comp_substs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="main">(</span><span class="free">τs</span> <span class="keyword1">⊙s</span> <span class="free">σs</span><span class="main">)</span> <span class="main">=</span> <span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">τs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">σs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def comp_substs_def map_zip_map map_zip_map2 map_zip_assoc
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_mset_comp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="keyword1">⋅cm</span> <span class="main">(</span><span class="free">τ</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">CC</span> <span class="keyword1">⋅cm</span> <span class="free">τ</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹``Commutativity'' of Membership and Substitution›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Melem_subst_atm_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">AA</span> <span class="keyword1">⋅am</span> <span class="free">σ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈#</span> <span class="free">AA</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="bound">B</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Melem_subst_cls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">L</span> <span class="main">=</span> <span class="bound">M</span> <span class="keyword1">⋅l</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Melem_subst_cls_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AA</span> <span class="main">∈#</span> <span class="free">CC</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">BB</span><span class="main">.</span> <span class="bound">BB</span> <span class="main">∈#</span> <span class="free">CC</span> <span class="main">∧</span> <span class="free">AA</span> <span class="main">=</span> <span class="bound">BB</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Signs and Substitutions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_lit_is_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_neg <span class="main">(</span><span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> is_neg <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_lit_is_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_pos <span class="main">(</span><span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> is_pos <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_minus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> <span class="free">L</span><span class="main">)</span> <span class="keyword1">⋅l</span> <span class="free">μ</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="free">L</span>  <span class="keyword1">⋅l</span> <span class="free">μ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> literal.map_sel subst_lit_def uminus_literal_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution on Literal(s)›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eql_neg_lit_eql_atm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Neg <span class="free">A'</span> <span class="keyword1">⋅l</span> <span class="free">η</span><span class="main">)</span> <span class="main">=</span> Neg <span class="free">A</span> <span class="main">⟷</span> <span class="free">A'</span> <span class="keyword1">⋅a</span> <span class="free">η</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lit_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eql_pos_lit_eql_atm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pos <span class="free">A'</span> <span class="keyword1">⋅l</span> <span class="free">η</span><span class="main">)</span> <span class="main">=</span> Pos <span class="free">A</span> <span class="main">⟷</span> <span class="free">A'</span> <span class="keyword1">⋅a</span> <span class="free">η</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lit_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_negs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>negs <span class="free">AA</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> negs <span class="main">(</span><span class="free">AA</span> <span class="keyword1">⋅am</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def subst_lit_def subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_poss<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poss <span class="free">AA</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> poss <span class="main">(</span><span class="free">AA</span> <span class="keyword1">⋅am</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def subst_lit_def subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> atms_of_subst_atms<span class="main">:</span> <span class="quoted"><span class="quoted">"atms_of <span class="free">C</span> <span class="keyword1">⋅as</span> <span class="free">σ</span> <span class="main">=</span> atms_of <span class="main">(</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atms_of <span class="main">(</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span>image_mset atm_of <span class="main">(</span>image_mset <span class="main">(</span>map_literal <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def subst_atms_def subst_lit_def atms_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> set_mset <span class="main">(</span>image_mset <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>image_mset atm_of <span class="free">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">meson</span> literal.map_sel<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"atms_of <span class="free">C</span> <span class="keyword1">⋅as</span> <span class="free">σ</span> <span class="main">=</span> atms_of <span class="main">(</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_atms_def atms_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_image_Neg_is_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">σ</span> <span class="main">∈</span> Neg <span class="main">`</span> <span class="free">AA</span> <span class="main">⟹</span> is_neg <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bex_imageD literal.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> literal.map_disc_iff subst_lit_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_lit_in_negs_subst_is_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">σ</span> <span class="main">∈#</span> <span class="main">(</span>negs <span class="free">AA</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">⟹</span> is_neg <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_lit_in_negs_is_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">σ</span> <span class="main">∈#</span> negs <span class="free">AA</span> <span class="main">⟹</span> is_neg <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution on Empty›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atms_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="keyword1">⋅as</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atmss_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="keyword1">⋅ass</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atmss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_substs_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σs</span> <span class="keyword1">⊙s</span> <span class="free">ηs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">σs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">ηs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_substs_def map2_empty_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_list_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1">⋅al</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="keyword1">⋅am</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_list_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1">⋅aml</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_lists_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1">⋅⋅aml</span> <span class="free">σs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_clss_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="keyword1">⋅cs</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_list_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_lists_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1">⋅⋅cl</span> <span class="free">σs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_scls_mset_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atms_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AA</span> <span class="keyword1">⋅as</span> <span class="free">η</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">AA</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atmss_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AAA</span> <span class="keyword1">⋅ass</span> <span class="free">η</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">AAA</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atmss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_list_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">As</span> <span class="keyword1">⋅al</span> <span class="free">η</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">As</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AA</span> <span class="keyword1">⋅am</span> <span class="free">η</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="free">AA</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_list_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AAs</span> <span class="keyword1">⋅aml</span> <span class="free">η</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">AAs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_lists_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AAs</span> <span class="keyword1">⋅⋅aml</span> <span class="free">ηs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">AAs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">ηs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> map2_empty_iff subst_atm_mset_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⋅</span> <span class="free">η</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_clss_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="keyword1">⋅cs</span> <span class="free">η</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">CC</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_list_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">η</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">Cs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_lists_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">ηs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">Cs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">ηs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> map2_empty_iff subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_mset_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="keyword1">⋅cm</span> <span class="free">η</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="free">CC</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution on a Union›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atms_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">AA</span> <span class="main">∪</span> <span class="free">BB</span><span class="main">)</span> <span class="keyword1">⋅as</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">AA</span> <span class="keyword1">⋅as</span> <span class="free">σ</span> <span class="main">∪</span> <span class="free">BB</span> <span class="keyword1">⋅as</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atmss_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">AAA</span> <span class="main">∪</span> <span class="free">BBB</span><span class="main">)</span> <span class="keyword1">⋅ass</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">AAA</span> <span class="keyword1">⋅ass</span> <span class="free">σ</span> <span class="main">∪</span> <span class="free">BBB</span> <span class="keyword1">⋅ass</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atmss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_list_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">As</span> <span class="main">@</span> <span class="free">Bs</span><span class="main">)</span> <span class="keyword1">⋅al</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">As</span> <span class="keyword1">⋅al</span> <span class="free">σ</span> <span class="main">@</span> <span class="free">Bs</span> <span class="keyword1">⋅al</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">AA</span> <span class="main">+</span> <span class="free">BB</span><span class="main">)</span> <span class="keyword1">⋅am</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">AA</span> <span class="keyword1">⋅am</span> <span class="free">σ</span> <span class="main">+</span> <span class="free">BB</span> <span class="keyword1">⋅am</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_list_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">AAs</span> <span class="main">@</span> <span class="free">BBs</span><span class="main">)</span> <span class="keyword1">⋅aml</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">AAs</span> <span class="keyword1">⋅aml</span> <span class="free">σ</span> <span class="main">@</span> <span class="free">BBs</span> <span class="keyword1">⋅aml</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">+</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_clss_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="free">DD</span><span class="main">)</span> <span class="keyword1">⋅cs</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">CC</span> <span class="keyword1">⋅cs</span> <span class="free">σ</span> <span class="main">∪</span> <span class="free">DD</span> <span class="keyword1">⋅cs</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_list_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Cs</span> <span class="main">@</span> <span class="free">Ds</span><span class="main">)</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span> <span class="main">@</span> <span class="free">Ds</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_lists_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">Cs</span> <span class="main">=</span> length <span class="free">σs</span> <span class="main">⟹</span> length <span class="free">Cs'</span> <span class="main">=</span> length <span class="free">σs'</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">Cs</span> <span class="main">@</span> <span class="free">Cs'</span><span class="main">)</span> <span class="keyword1">⋅⋅cl</span> <span class="main">(</span><span class="free">σs</span> <span class="main">@</span> <span class="free">σs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">σs</span> <span class="main">@</span> <span class="free">Cs'</span> <span class="keyword1">⋅⋅cl</span> <span class="free">σs'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_mset_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">CC</span> <span class="main">+</span> <span class="free">DD</span><span class="main">)</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">CC</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span> <span class="main">+</span> <span class="free">DD</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution on a Singleton›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atms_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="keyword1">⋅as</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atmss_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">AA</span><span class="main">}</span> <span class="keyword1">⋅ass</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{</span><span class="free">AA</span> <span class="keyword1">⋅as</span> <span class="free">σ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atmss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_list_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="keyword1">⋅al</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">[</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">A</span><span class="main">#}</span> <span class="keyword1">⋅am</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{#</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">AA</span><span class="main">]</span> <span class="keyword1">⋅aml</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">[</span><span class="free">AA</span> <span class="keyword1">⋅am</span> <span class="free">σ</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">L</span><span class="main">#}</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{#</span><span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">σ</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_clss_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">C</span><span class="main">}</span> <span class="keyword1">⋅cs</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_list_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">[</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_lists_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">C</span><span class="main">]</span> <span class="keyword1">⋅⋅cl</span> <span class="main">[</span><span class="free">σ</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_mset_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">C</span><span class="main">#}</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{#</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Cons</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_list_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">#</span> <span class="free">As</span><span class="main">)</span> <span class="keyword1">⋅al</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">#</span> <span class="free">As</span> <span class="keyword1">⋅al</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_list_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">#</span> <span class="free">As</span><span class="main">)</span> <span class="keyword1">⋅aml</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">⋅am</span> <span class="free">σ</span> <span class="main">#</span> <span class="free">As</span> <span class="keyword1">⋅aml</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_lists_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span> <span class="main">#</span> <span class="free">Cs</span><span class="main">)</span> <span class="keyword1">⋅⋅aml</span> <span class="main">(</span><span class="free">σ</span> <span class="main">#</span> <span class="free">σs</span><span class="main">)</span> <span class="main">=</span> <span class="free">C</span> <span class="keyword1">⋅am</span> <span class="free">σ</span> <span class="main">#</span> <span class="free">Cs</span> <span class="keyword1">⋅⋅aml</span> <span class="free">σs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_list_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span> <span class="main">#</span> <span class="free">Cs</span><span class="main">)</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">#</span> <span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_lists_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span> <span class="main">#</span> <span class="free">Cs</span><span class="main">)</span> <span class="keyword1">⋅⋅cl</span> <span class="main">(</span><span class="free">σ</span> <span class="main">#</span> <span class="free">σs</span><span class="main">)</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">#</span> <span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">σs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">tl</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_list_tl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span><span class="free">As</span> <span class="keyword1">⋅al</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> tl <span class="free">As</span> <span class="keyword1">⋅al</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">As</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_list_tl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span><span class="free">AAs</span> <span class="keyword1">⋅aml</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> tl <span class="free">AAs</span> <span class="keyword1">⋅aml</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">AAs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_list_tl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span><span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> tl <span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_lists_tl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">Cs</span> <span class="main">=</span> length <span class="free">σs</span> <span class="main">⟹</span> tl <span class="main">(</span><span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">σs</span><span class="main">)</span> <span class="main">=</span> tl <span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> tl <span class="free">σs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Cs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">σs</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">nth</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_substs_nth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">τs</span> <span class="main">=</span> length <span class="free">σs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">τs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">τs</span> <span class="keyword1">⊙s</span> <span class="free">σs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">τs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊙</span> <span class="main">(</span><span class="free">σs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_substs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_list_nth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">As</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">As</span> <span class="keyword1">⋅al</span> <span class="free">τ</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">As</span> <span class="main">!</span> <span class="free">i</span> <span class="keyword1">⋅a</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_list_def <span class="keyword1"><span class="command">using</span></span> less_Suc_eq_0_disj nth_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_list_nth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">AAs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">AAs</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">AAs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="keyword1">⋅am</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_lists_nth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">AAs</span> <span class="main">=</span> length <span class="free">σs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">AAs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">AAs</span> <span class="keyword1">⋅⋅aml</span> <span class="free">σs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">AAs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="keyword1">⋅am</span> <span class="main">(</span><span class="free">σs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_list_nth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">Cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">τ</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">Cs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_list_def <span class="keyword1"><span class="command">using</span></span> less_Suc_eq_0_disj nth_map <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_lists_nth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">Cs</span> <span class="main">=</span> length <span class="free">σs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">Cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">σs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">Cs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">σs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution on Various Other Functions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_clss_image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"image <span class="free">f</span> <span class="free">X</span> <span class="keyword1">⋅cs</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_mset_image_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span> <span class="free">X</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{#</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_subst_atm_list_subst_atm_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="free">As</span> <span class="keyword1">⋅al</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span><span class="free">As</span><span class="main">)</span> <span class="keyword1">⋅am</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_list_def subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_subst_cls_list_subst_cls_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mset <span class="free">Cs</span><span class="main">)</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_mset_def subst_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_subst_cls_list_subst_cls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">η</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="free">Cs</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_mset_subst_cls_mset_subst_clss<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">CC</span> <span class="keyword1">⋅cm</span> <span class="free">μ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set_mset <span class="free">CC</span><span class="main">)</span> <span class="keyword1">⋅cs</span> <span class="free">μ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_cls_mset_def subst_clss_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Neg_Melem_subst_atm_subst_cls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> Neg <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Melem_subst_cls eql_neg_lit_eql_atm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Pos_Melem_subst_atm_subst_cls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> Pos <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Melem_subst_cls eql_pos_lit_eql_atm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_atms_of_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> atms_of <span class="free">C</span> <span class="main">⟹</span> <span class="free">B</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atms_of_subst_atms image_iff subst_atms_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Renamings›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_id_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">id_subst</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_renaming_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renamingD<span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">σ</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A1</span> <span class="bound">A2</span><span class="main">.</span> <span class="bound">A1</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">=</span> <span class="bound">A2</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">⟷</span> <span class="bound">A1</span> <span class="main">=</span> <span class="bound">A2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_renaming_def subst_atm_comp_subst subst_atm_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_renaming_cancel_r<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">⊙</span> inv_renaming <span class="free">r</span> <span class="main">=</span> <span class="free">id_subst</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_renaming_def is_renaming_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> someI_ex<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_renaming_cancel_r_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_renaming_list <span class="free">rs</span> <span class="main">⟹</span> <span class="free">rs</span> <span class="keyword1">⊙s</span> map inv_renaming <span class="free">rs</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">rs</span><span class="main">)</span> <span class="free">id_subst</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_renaming_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_substs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Nil_comp_substs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1">⊙s</span> <span class="free">s</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> comp_substs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_substs_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">⊙s</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> comp_substs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_idempotent_id_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">⊙</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">=</span> <span class="free">id_subst</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_subst_assoc comp_subst_id_subst inv_renaming_cancel_r<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_left_id_subst_right_id_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_renaming <span class="free">r</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊙</span> <span class="free">r</span> <span class="main">=</span> <span class="free">id_subst</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">⊙</span> <span class="free">s</span> <span class="main">=</span> <span class="free">id_subst</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_subst_assoc comp_subst_id_subst is_renaming_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">r1</span> <span class="main">⟹</span> is_renaming <span class="free">r2</span> <span class="main">⟹</span> is_renaming <span class="main">(</span><span class="free">r1</span> <span class="main">⊙</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_renaming_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_subst_assoc comp_subst_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_inv_renaming_cancel_atm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">ρ</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">ρ</span> <span class="keyword1">⋅a</span> inv_renaming <span class="free">ρ</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r subst_atm_comp_subst subst_atm_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_inv_renaming_cancel_atms<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">ρ</span> <span class="main">⟹</span> <span class="free">AA</span> <span class="keyword1">⋅as</span> <span class="free">ρ</span> <span class="keyword1">⋅as</span> inv_renaming <span class="free">ρ</span> <span class="main">=</span> <span class="free">AA</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r subst_atms_comp_subst subst_atms_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_inv_renaming_cancel_atmss<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">ρ</span> <span class="main">⟹</span> <span class="free">AAA</span> <span class="keyword1">⋅ass</span> <span class="free">ρ</span> <span class="keyword1">⋅ass</span> inv_renaming <span class="free">ρ</span> <span class="main">=</span> <span class="free">AAA</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r subst_atmss_comp_subst subst_atmss_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_inv_renaming_cancel_atm_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">ρ</span> <span class="main">⟹</span> <span class="free">As</span> <span class="keyword1">⋅al</span> <span class="free">ρ</span> <span class="keyword1">⋅al</span> inv_renaming <span class="free">ρ</span> <span class="main">=</span> <span class="free">As</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r subst_atm_list_comp_subst subst_atm_list_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_inv_renaming_cancel_atm_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">ρ</span> <span class="main">⟹</span> <span class="free">AA</span> <span class="keyword1">⋅am</span> <span class="free">ρ</span> <span class="keyword1">⋅am</span> inv_renaming <span class="free">ρ</span> <span class="main">=</span> <span class="free">AA</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r subst_atm_mset_comp_subst subst_atm_mset_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_inv_renaming_cancel_atm_mset_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">ρ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">AAs</span> <span class="keyword1">⋅aml</span> <span class="free">ρ</span><span class="main">)</span> <span class="keyword1">⋅aml</span> inv_renaming <span class="free">ρ</span> <span class="main">=</span> <span class="free">AAs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r subst_atm_mset_list_comp_subst subst_atm_mset_list_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_list_inv_renaming_cancel_atm_mset_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">AAs</span> <span class="main">=</span> length <span class="free">ρs</span> <span class="main">⟹</span> is_renaming_list <span class="free">ρs</span> <span class="main">⟹</span> <span class="free">AAs</span> <span class="keyword1">⋅⋅aml</span> <span class="free">ρs</span> <span class="keyword1">⋅⋅aml</span> map inv_renaming <span class="free">ρs</span> <span class="main">=</span> <span class="free">AAs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r_list subst_atm_mset_lists_comp_substs
      subst_atm_mset_lists_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_inv_renaming_cancel_lit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">ρ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">ρ</span><span class="main">)</span> <span class="keyword1">⋅l</span> inv_renaming <span class="free">ρ</span> <span class="main">=</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r subst_lit_comp_subst subst_lit_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_inv_renaming_cancel_cls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="free">ρ</span> <span class="main">⟹</span> <span class="free">C</span>  <span class="main">⋅</span> <span class="free">ρ</span> <span class="main">⋅</span> inv_renaming <span class="free">ρ</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r subst_cls_comp_subst subst_cls_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_inv_renaming_cancel_clss<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_renaming <span class="free">ρ</span> <span class="main">⟹</span> <span class="free">CC</span> <span class="keyword1">⋅cs</span> <span class="free">ρ</span> <span class="keyword1">⋅cs</span> inv_renaming <span class="free">ρ</span> <span class="main">=</span> <span class="free">CC</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r subst_clss_id_subst subst_clsscomp_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_inv_renaming_cancel_cls_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_renaming <span class="free">ρ</span> <span class="main">⟹</span> <span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">ρ</span> <span class="keyword1">⋅cl</span> inv_renaming <span class="free">ρ</span> <span class="main">=</span> <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r subst_cls_list_comp_subst subst_cls_list_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_list_inv_renaming_cancel_cls_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">Cs</span> <span class="main">=</span> length <span class="free">ρs</span> <span class="main">⟹</span> is_renaming_list <span class="free">ρs</span> <span class="main">⟹</span> <span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">ρs</span> <span class="keyword1">⋅⋅cl</span> map inv_renaming <span class="free">ρs</span> <span class="main">=</span> <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r_list subst_cls_lists_comp_substs subst_cls_lists_id_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_renaming_inv_renaming_cancel_cls_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_renaming <span class="free">ρ</span> <span class="main">⟹</span> <span class="free">CC</span> <span class="keyword1">⋅cm</span> <span class="free">ρ</span> <span class="keyword1">⋅cm</span> inv_renaming <span class="free">ρ</span> <span class="main">=</span> <span class="free">CC</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_renaming_cancel_r subst_cls_mset_comp_subst subst_cls_mset_id_subst<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">C</span> <span class="main">⊆</span> set_mset <span class="free">D</span> <span class="main">⟹</span> set_mset <span class="main">(</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊆</span> set_mset <span class="main">(</span><span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_mono_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆#</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊆#</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_subset_eq_exists_conv subst_cls_union<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_subset_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⊂#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊂#</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_mset_subset_mono<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Size after Substitution›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> size <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_list_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">As</span> <span class="keyword1">⋅al</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> length <span class="free">As</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> length_subst_atm_mset_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">AAs</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span> <span class="main">=</span> length <span class="free">AAs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_atm_mset_lists_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">AAs</span> <span class="keyword1">⋅⋅aml</span> <span class="free">σs</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span>length <span class="free">AAs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">σs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_list_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> length <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_substs_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">τs</span> <span class="keyword1">⊙s</span> <span class="free">σs</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span>length <span class="free">τs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">σs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> comp_substs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_lists_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">σs</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span>length <span class="free">Cs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">σs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Variable Disjointness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> var_disjoint_clauses<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"var_disjoint <span class="free">Cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σs</span><span class="main">.</span> length <span class="bound">σs</span> <span class="main">=</span> length <span class="free">Cs</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> <span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="bound">σs</span> <span class="main">=</span> <span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> list"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">σs</span> <span class="main">=</span> length <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆#</span> <span class="free">Cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="main">⋅</span> <span class="skolem">σs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">S</span> <span class="main">⋅</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> var_disjoint_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">Cs</span><span class="main">.</span> <span class="main">(</span><span class="free">Cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">σs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">Cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">σs</span> <span class="main">=</span> <span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> <span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">σs</span> <span class="main">=</span> <span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="bound">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Ground Expressions and Substitutions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_ground_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> make_ground_subst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ground_cls_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_cls_list_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_ground_cls_list <span class="main">(</span><span class="free">C</span> <span class="main">#</span> <span class="free">Cs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>is_ground_cls <span class="free">C</span> <span class="main">∧</span> is_ground_cls_list <span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Ground union›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_atms_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atms <span class="main">(</span><span class="free">AA</span> <span class="main">∪</span> <span class="free">BB</span><span class="main">)</span> <span class="main">⟷</span> is_ground_atms <span class="free">AA</span> <span class="main">∧</span> is_ground_atms <span class="free">BB</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_atms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_atm_mset_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_ground_atm_mset <span class="main">(</span><span class="free">AA</span> <span class="main">+</span> <span class="free">BB</span><span class="main">)</span> <span class="main">⟷</span> is_ground_atm_mset <span class="free">AA</span> <span class="main">∧</span> is_ground_atm_mset <span class="free">BB</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_cls_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span> <span class="main">⟷</span> is_ground_cls <span class="free">C</span> <span class="main">∧</span> is_ground_cls <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_clss_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_ground_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="free">DD</span><span class="main">)</span> <span class="main">⟷</span> is_ground_clss <span class="free">CC</span> <span class="main">∧</span> is_ground_clss <span class="free">DD</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_cls_list_is_ground_cls_sum_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_ground_cls_list <span class="free">Cs</span> <span class="main">⟹</span> is_ground_cls <span class="main">(</span>sum_list <span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_mset_sum_list2 is_ground_cls_def is_ground_cls_list_def<span class="main">)</span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Grounding monotonicity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_cls_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆#</span> <span class="free">D</span> <span class="main">⟹</span> is_ground_cls <span class="free">D</span> <span class="main">⟹</span> is_ground_cls <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_mset_mono subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_clss_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="main">⊆</span> <span class="free">DD</span> <span class="main">⟹</span> is_ground_clss <span class="free">DD</span> <span class="main">⟹</span> is_ground_clss <span class="free">CC</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> grounding_of_clss_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="main">⊆</span> <span class="free">DD</span> <span class="main">⟹</span> grounding_of_clss <span class="free">CC</span> <span class="main">⊆</span> grounding_of_clss <span class="free">DD</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_subseteq_mset_is_ground_cls_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sum_list <span class="free">Cs</span> <span class="main">⊆#</span> sum_list <span class="free">Ds</span> <span class="main">⟹</span> is_ground_cls_list <span class="free">Ds</span> <span class="main">⟹</span> is_ground_cls_list <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_mset_sum_list is_ground_cls_def is_ground_cls_list_is_ground_cls_sum_list
      is_ground_cls_mono is_ground_cls_list_def<span class="main">)</span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Substituting on ground expression preserves ground›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_comp_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">σ</span> <span class="main">⟹</span> is_ground_subst <span class="main">(</span><span class="free">τ</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_subst_def is_ground_atm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_subst_ground_atm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">σ</span> <span class="main">⟹</span> is_ground_atm <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ground_subst_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_subst_ground_lit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">σ</span> <span class="main">⟹</span> is_ground_lit <span class="main">(</span><span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_lit_def subst_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_subst_ground_cls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">σ</span> <span class="main">⟹</span> is_ground_cls <span class="main">(</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_subst_ground_clss<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">σ</span> <span class="main">⟹</span> is_ground_clss <span class="main">(</span><span class="free">CC</span> <span class="keyword1">⋅cs</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_clss_def subst_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_subst_ground_cls_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">σ</span> <span class="main">⟹</span> is_ground_cls_list <span class="main">(</span><span class="free">Cs</span> <span class="keyword1">⋅cl</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_list_def subst_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_subst_ground_cls_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span> <span class="main">∈</span> set <span class="free">σs</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span> <span class="main">⟹</span> is_ground_cls_list <span class="main">(</span><span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">σs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_list_def subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_cls_eq_grounding_of_cls_subset_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"grounding_of_cls <span class="free">C</span> <span class="main">⊆</span> grounding_of_cls <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Cσ'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cσ'</span> <span class="main">∈</span> grounding_of_cls <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    Cσ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⋅</span> <span class="skolem">σ'</span> <span class="main">=</span> <span class="skolem">Cσ'</span>"</span></span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⋅</span> <span class="skolem">σ'</span> <span class="main">=</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="skolem">σ'</span> <span class="main">∧</span> is_ground_subst <span class="main">(</span><span class="free">σ</span> <span class="main">⊙</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cσ'</span> <span class="main">∈</span> grounding_of_cls <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_cls_def <span class="keyword1"><span class="command">using</span></span> Cσ'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Substituting on ground expression has no effect›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_subst_atm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_atm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_subst_atms<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atms <span class="free">AA</span> <span class="main">⟹</span> <span class="free">AA</span> <span class="keyword1">⋅as</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">AA</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_atms_def subst_atms_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_subst_atm_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atm_mset <span class="free">AA</span> <span class="main">⟹</span> <span class="free">AA</span> <span class="keyword1">⋅am</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">AA</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_atm_mset_def subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_subst_atm_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atm_list <span class="free">As</span> <span class="main">⟹</span> <span class="free">As</span> <span class="keyword1">⋅al</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">As</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_atm_list_def subst_atm_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_subst_atm_list_member<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_ground_atm_list <span class="free">As</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">As</span> <span class="main">⟹</span> <span class="free">As</span> <span class="main">!</span> <span class="free">i</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">As</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_atm_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_subst_lit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_lit <span class="free">L</span> <span class="main">⟹</span> <span class="free">L</span> <span class="keyword1">⋅l</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_lit_def subst_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_subst_cls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">C</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_def subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_subst_clss<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_clss <span class="free">CC</span> <span class="main">⟹</span> <span class="free">CC</span> <span class="keyword1">⋅cs</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">CC</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_clss_def subst_clss_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_subst_cls_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">P</span> <span class="main">=</span> length <span class="free">Cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_ground_cls_list <span class="free">Cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">P</span> <span class="main">=</span> <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ground_cls_list_def is_ground_subst_cls min.idem nth_equalityI nth_mem
      subst_cls_lists_nth subst_cls_lists_length<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_subst_lit_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_lit <span class="free">L</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">L</span> <span class="main">=</span> <span class="free">L</span> <span class="keyword1">⋅l</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_ground_atm_def is_ground_lit_def subst_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_subst_cls_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">C</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⋅</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ex_ground_subst ground_subst_ground_cls is_ground_subst_cls<span class="main">)</span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Members of ground expressions are ground›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_cls_as_atms<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">C</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> atms_of <span class="free">C</span><span class="main">.</span> is_ground_atm <span class="bound">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_of_def is_ground_cls_def is_ground_lit_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_cls_imp_is_ground_lit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> is_ground_cls <span class="free">C</span> <span class="main">⟹</span> is_ground_lit <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ground_cls_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_cls_imp_is_ground_atm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> atms_of <span class="free">C</span> <span class="main">⟹</span> is_ground_cls <span class="free">C</span> <span class="main">⟹</span> is_ground_atm <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ground_cls_as_atms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_cls_is_ground_atms_atms_of<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">C</span> <span class="main">⟹</span> is_ground_atms <span class="main">(</span>atms_of <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ground_cls_imp_is_ground_atm is_ground_atms_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> grounding_ground<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> grounding_of_clss <span class="free">M</span> <span class="main">⟹</span> is_ground_cls <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_subset_eq_grounding_of_clss_is_ground_cls<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> <span class="free">CC</span> <span class="main">⟹</span> <span class="free">CC</span> <span class="main">⊆</span> grounding_of_clss <span class="free">DD</span> <span class="main">⟹</span> is_ground_cls <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ground_cls_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> grounding_of_cls_ground<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">C</span> <span class="main">⟹</span> grounding_of_cls <span class="free">C</span> <span class="main">=</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ex_ground_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> grounding_of_cls_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"grounding_of_cls <span class="main">{#}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{#}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> grounding_of_cls_ground<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> union_grounding_of_cls_ground<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_clss <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>grounding_of_cls <span class="main">`</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> grounding_ground grounding_of_clss_def is_ground_clss_def<span class="main">)</span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Grounding idempotence›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> grounding_of_grounding_of_cls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∈</span> grounding_of_cls <span class="free">D</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">∈</span> grounding_of_cls <span class="free">C</span> <span class="main">⟹</span> <span class="free">E</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Subsumption›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subsumes_empty_left<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="main">{#}</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subsumes_def subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_subsumes_empty_left<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strictly_subsumes <span class="main">{#}</span> <span class="free">C</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def subsumes_def subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Unifiers›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_le_one_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> card <span class="free">X</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_unifier_subst_atm_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">AA</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_unifier <span class="free">σ</span> <span class="free">AA</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">AA</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">∈</span> <span class="free">AA</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">B</span> <span class="keyword1">⋅a</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_unifier_def subst_atms_def card_le_one_alt<span class="main">[</span><span class="operator">OF</span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> equals0D imageI insert_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_unifier_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">AA</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_unifier <span class="free">σ</span> <span class="free">AA</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="free">AA</span><span class="main">.</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">AA</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">=</span> <span class="bound">B</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_unifier_def subst_atms_def card_le_one_alt<span class="main">[</span><span class="operator">OF</span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> empty_iff insert_iff insert_image<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_unifiers_subst_atm_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">AA</span>"</span></span> <span class="quoted"><span class="quoted">"is_unifiers <span class="free">σ</span> <span class="free">AAA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">AA</span> <span class="main">∈</span> <span class="free">AAA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">AA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> <span class="free">AA</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">B</span> <span class="keyword1">⋅a</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms is_unifiers_def is_unifier_subst_atm_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> is_unifiers_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_unifiers <span class="free">σ</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="free">As</span> <span class="free">Bs</span><span class="main">)</span> <span class="keyword1">⋅ass</span> <span class="free">η</span><span class="main">)</span> <span class="main">⟷</span>
   is_unifiers <span class="main">(</span><span class="free">η</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="free">As</span> <span class="free">Bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_unifiers_def is_unifier_def subst_atmss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Most General Unifier›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_mgu_is_unifiers<span class="main">:</span> <span class="quoted"><span class="quoted">"is_mgu <span class="free">σ</span> <span class="free">AAA</span> <span class="main">⟹</span> is_unifiers <span class="free">σ</span> <span class="free">AAA</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_mgu_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_mgu_is_most_general<span class="main">:</span> <span class="quoted"><span class="quoted">"is_mgu <span class="free">σ</span> <span class="free">AAA</span> <span class="main">⟹</span> is_unifiers <span class="free">τ</span> <span class="free">AAA</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">γ</span><span class="main">.</span> <span class="free">τ</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">⊙</span> <span class="bound">γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_mgu_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_unifiers_is_unifier<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unifiers <span class="free">σ</span> <span class="free">AAA</span> <span class="main">⟹</span> <span class="free">AA</span> <span class="main">∈</span> <span class="free">AAA</span> <span class="main">⟹</span> is_unifier <span class="free">σ</span> <span class="free">AA</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_unifiers_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Generalization and Subsumption›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> variants_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"variants <span class="free">D</span> <span class="free">D'</span> <span class="main">⟷</span> variants <span class="free">D'</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> variants_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> variants_iff_subsumes<span class="main">:</span> <span class="quoted"><span class="quoted">"variants <span class="free">C</span> <span class="free">D</span> <span class="main">⟷</span> subsumes <span class="free">C</span> <span class="free">D</span> <span class="main">∧</span> subsumes <span class="free">D</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"variants <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subsumes <span class="free">C</span> <span class="free">D</span> <span class="main">∧</span> subsumes <span class="free">D</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> variants_def generalizes_def subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_mset.order.refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="free">C</span> <span class="free">D</span> <span class="main">∧</span> subsumes <span class="free">D</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="free">C</span> <span class="main">=</span> size <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym size_mset_mono size_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"variants <span class="free">C</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub <span class="keyword1"><span class="command">unfolding</span></span> subsumes_def variants_def generalizes_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leD mset_subset_size size_mset_mono size_subst
        subset_mset.order.not_eq_order_implies_strict<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_strictly_generalizes<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP strictly_generalizes"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C_at</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> strictly_generalizes <span class="main">(</span><span class="bound">C_at</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">C_at</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C_at</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      sg_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> strictly_generalizes <span class="main">(</span><span class="skolem">C_at</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">C_at</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> size <span class="main">(</span><span class="skolem">C_at</span> <span class="main">0</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> sz_C<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">C_at</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> sg_C<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> strictly_generalizes_def generalizes_def subst_cls_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> size_image_mset<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ_at</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      C_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> image_mset <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="skolem">σ_at</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">C_at</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">C_at</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sg_C<span class="main">[</span><span class="operator">unfolded</span> strictly_generalizes_def generalizes_def subst_cls_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Ls_at</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> literal list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">Ls_at</span> <span class="main">=</span> rec_nat <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">Ls</span><span class="main">.</span> mset <span class="bound">Ls</span> <span class="main">=</span> <span class="skolem">C_at</span> <span class="main">0</span><span class="main">)</span>
         <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">Lsi</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">Ls</span><span class="main">.</span> mset <span class="bound">Ls</span> <span class="main">=</span> <span class="skolem">C_at</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="skolem">σ_at</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">Ls</span> <span class="main">=</span> <span class="bound">Lsi</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span>
      Ls_at_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ls_at</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">Ls</span><span class="main">.</span> mset <span class="bound">Ls</span> <span class="main">=</span> <span class="skolem">C_at</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      Ls_at_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">Ls_at</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">Ls</span><span class="main">.</span> mset <span class="bound">Ls</span> <span class="main">=</span> <span class="skolem">C_at</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="skolem">σ_at</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">Ls</span> <span class="main">=</span> <span class="skolem">Ls_at</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Ls_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> mset_Lt_at_0<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="skolem">Ls_at</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">C_at</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Ls_at_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> list_of_mset_exi<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="skolem">Ls_at</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">C_at</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="skolem">σ_at</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ls_at</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ls_at</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ls_at_Suc<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">metis</span> C_σ image_mset_of_subset_list mset_Lt_at_0<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Suc
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> Ls_at_Suc<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> C_σ image_mset_of_subset_list<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> mset_Ls <span class="main">=</span> this<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> Ls_σ <span class="main">=</span> this<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">]</span>

    <span class="keyword1"><span class="command">have</span></span> len_Ls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> length <span class="main">(</span><span class="skolem">Ls_at</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_Ls mset_Lt_at_0 not0_implies_Suc size_mset sz_C<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> is_pos_Ls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">⟹</span> is_pos <span class="main">(</span><span class="skolem">Ls_at</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟷</span> is_pos <span class="main">(</span><span class="skolem">Ls_at</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ls_σ len_Ls <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> literal.map_disc_iff nth_map subst_lit_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> Ls_τ_strict_lit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">τ</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ls_at</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">Ls_at</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> C_σ mset_Ls Ls_σ mset_map sg_C generalizes_def strictly_generalizes_def
          subst_cls_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> Ls_τ_strict_tm<span class="main">:</span>
      <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">⋅a</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">∘</span> atm_of<span class="main">)</span> <span class="main">(</span><span class="skolem">Ls_at</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> map atm_of <span class="main">(</span><span class="skolem">Ls_at</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">τ</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
        j_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        j_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ls_at</span> <span class="skolem">i</span> <span class="main">!</span> <span class="skolem">j</span> <span class="keyword1">⋅l</span> <span class="skolem">τ</span> <span class="main">≠</span> <span class="skolem">Ls_at</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Ls_τ_strict_lit<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">τ</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> len_Ls
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> length_map list_eq_iff_nth_eq nth_map<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atm_of <span class="main">(</span><span class="skolem">Ls_at</span> <span class="skolem">i</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">⋅a</span> <span class="skolem">τ</span> <span class="main">≠</span> atm_of <span class="main">(</span><span class="skolem">Ls_at</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> j_τ is_pos_Ls<span class="main">[</span><span class="operator">OF</span> j_lt<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_guards<span class="main"><span class="main">)</span></span> literal.expand literal.map_disc_iff literal.map_sel subst_lit_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> j_lt len_Ls <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_map o_apply<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tm_at</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">tm_at</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">atm_of_atms</span> <span class="main">(</span>map atm_of <span class="main">(</span><span class="skolem">Ls_at</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> generalizes_atm <span class="main">(</span><span class="skolem">tm_at</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">tm_at</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tm_at_def generalizes_atm_def atm_of_atms_subst
      <span class="keyword1"><span class="command">using</span></span> Ls_σ<span class="main">[</span><span class="operator">THEN</span> arg_cong<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"map atm_of"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> generalizes_atm <span class="main">(</span><span class="skolem">tm_at</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">tm_at</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tm_at_def generalizes_atm_def atm_of_atms_subst <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ls_τ_strict_tm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> strictly_generalizes_atm <span class="main">(</span><span class="skolem">tm_at</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">tm_at</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> strictly_generalizes_atm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> wf_strictly_generalizes_atm<span class="main">[</span><span class="operator">unfolded</span> wfP_def wf_iff_no_infinite_down_chain<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span>strictly_generalizes <span class="main">::</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wfP_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_iff_no_infinite_down_chain<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strict_subset_subst_strictly_subsumes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⋅</span> <span class="free">η</span> <span class="main">⊂#</span> <span class="free">D</span> <span class="main">⟹</span> strictly_subsumes <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leD mset_subset_size size_mset_mono size_subst strictly_subsumes_def
      subset_mset.dual_order.strict_implies_order substitution_ops.subsumes_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> generalizes_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"generalizes <span class="free">C</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> generalizes_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">id_subst</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> generalizes_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"generalizes <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> generalizes <span class="free">D</span> <span class="free">E</span> <span class="main">⟹</span> generalizes <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> generalizes_def <span class="keyword1"><span class="command">using</span></span> subst_cls_comp_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> subsumes_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="free">C</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">id_subst</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subsumes_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> subsumes <span class="free">D</span> <span class="free">E</span> <span class="main">⟹</span> subsumes <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subsumes_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> subset_mset.order.trans subst_cls_comp_subst subst_cls_mono_mset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_generalizes_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> strictly_generalizes <span class="free">C</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strictly_generalizes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_generalizes_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"strictly_generalizes <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> <span class="main">¬</span> strictly_generalizes <span class="free">D</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strictly_generalizes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_generalizes_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strictly_generalizes <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> strictly_generalizes <span class="free">D</span> <span class="free">E</span> <span class="main">⟹</span> strictly_generalizes <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strictly_generalizes_def <span class="keyword1"><span class="command">using</span></span> generalizes_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_subsumes_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> strictly_subsumes <span class="free">C</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_subsumes_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"strictly_subsumes <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> <span class="main">¬</span> strictly_subsumes <span class="free">D</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_subsumes_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strictly_subsumes <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> strictly_subsumes <span class="free">D</span> <span class="free">E</span> <span class="main">⟹</span> strictly_subsumes <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def <span class="keyword1"><span class="command">using</span></span> subsumes_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_strictly_subsumes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊂#</span> <span class="free">D</span> <span class="main">⟹</span> strictly_subsumes <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strict_subset_subst_strictly_subsumes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">id_subst</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_generalizes_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"strictly_generalizes <span class="free">D'</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">D'</span> <span class="main">≠</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strictly_generalizes_def generalizes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_subsumes_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"strictly_subsumes <span class="free">D'</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">D'</span> <span class="main">≠</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_subsumes_has_minimum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> <span class="main">∀</span><span class="bound">D</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> <span class="main">¬</span> strictly_subsumes <span class="bound">D</span> <span class="bound">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> <span class="main">∀</span><span class="bound">D</span><span class="main">∈</span><span class="free">CC</span><span class="main">.</span> <span class="main">¬</span> strictly_subsumes <span class="bound">D</span> <span class="bound">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> <span class="main">∃</span><span class="bound">D</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> strictly_subsumes <span class="bound">D</span> <span class="bound">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    f_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span> <span class="main">∧</span> strictly_subsumes <span class="main">(</span><span class="skolem">f</span> <span class="bound">C</span><span class="main">)</span> <span class="bound">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    C_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> <span class="free">CC</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">c</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="skolem">C</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> incc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">CC</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c_def f_p C_p<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> strictly_subsumes <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> incc f_p <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> size <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> size <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> size_mset_mono size_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lte<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>size <span class="main">∘</span> <span class="skolem">c</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">(</span>size <span class="main">∘</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">l'</span></span> <span class="main">≥</span> <span class="bound">l</span><span class="main">.</span> size <span class="main">(</span><span class="skolem">c</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>Suc <span class="bound">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f_Suc_decr_eventually_const comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    l_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">l'</span></span> <span class="main">≥</span> <span class="skolem">l</span><span class="main">.</span> size <span class="main">(</span><span class="skolem">c</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>Suc <span class="bound">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">l'</span></span> <span class="main">≥</span> <span class="skolem">l</span><span class="main">.</span> strictly_generalizes <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>Suc <span class="bound">l'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">l'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps <span class="keyword1"><span class="command">unfolding</span></span> strictly_generalizes_def generalizes_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> size_subst less_irrefl strictly_subsumes_def mset_subset_size subset_mset_def
        subsumes_def strictly_subsumes_neq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> strictly_generalizes <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> strictly_generalizes_def generalizes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> strictly_generalizes <span class="main">(</span><span class="bound">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">c</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">l</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> wf_strictly_generalizes
      wf_iff_no_infinite_down_chain<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> strictly_generalizes <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> wfP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_strictly_subsumes<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP strictly_subsumes"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strictly_subsumes_has_minimum <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> equals0D wfP_eq_minimal<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> variants_imp_exists_substitution<span class="main">:</span> <span class="quoted"><span class="quoted">"variants <span class="free">D</span> <span class="free">D'</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">D'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> variants_iff_subsumes subsumes_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> strictly_subsumes_def subset_mset_def strict_subset_subst_strictly_subsumes subsumes_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_subsumes_variants<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strictly_subsumes <span class="free">E</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"variants <span class="free">D</span> <span class="free">D'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strictly_subsumes <span class="free">E</span> <span class="free">D'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    σ_σ'_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="free">D'</span> <span class="main">∧</span> <span class="free">D'</span> <span class="main">⋅</span> <span class="skolem">σ'</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> variants_imp_exists_substitution variants_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">⋅</span> <span class="skolem">σ''</span> <span class="main">⊆#</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">⋅</span> <span class="skolem">σ''</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⊆#</span> <span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_cls_mono_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">σ''</span> <span class="main">⊙</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">⊆#</span> <span class="free">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> σ_σ'_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">σ</span><span class="main">.</span> <span class="free">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">⊆#</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">σ</span><span class="main">.</span> <span class="free">D'</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">⊆#</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ'''</span><span class="main">.</span> <span class="free">D'</span> <span class="main">⋅</span> <span class="bound">σ'''</span> <span class="main">⊆#</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">D'</span> <span class="main">⋅</span> <span class="skolem">σ'''</span> <span class="main">⊆#</span> <span class="free">E</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">⊙</span> <span class="skolem">σ'''</span><span class="main">)</span> <span class="main">⊆#</span> <span class="free">E</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> σ_σ'_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> neg_strictly_subsumes_variants<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> strictly_subsumes <span class="free">E</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"variants <span class="free">D</span> <span class="free">D'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> strictly_subsumes <span class="free">E</span> <span class="free">D'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms strictly_subsumes_variants variants_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Most General Unifiers›</span></span>

<span class="keyword1"><span class="command">locale</span></span> mgu <span class="main">=</span> substitution <span class="quoted"><span class="free">subst_atm</span></span> <span class="quoted"><span class="free">id_subst</span></span> <span class="quoted"><span class="free">comp_subst</span></span> <span class="quoted"><span class="free">renamings_apart</span></span> <span class="quoted"><span class="free">atm_of_atms</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">subst_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">id_subst</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">comp_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">atm_of_atms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">renamings_apart</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal multiset list <span class="main">⇒</span> <span class="tfree">'s</span> list"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">mgu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'s</span> option"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    mgu_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">AAA</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">AA</span> <span class="main">∈</span> <span class="free">AAA</span><span class="main">.</span> finite <span class="bound">AA</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">mgu</span> <span class="free">AAA</span> <span class="main">=</span> Some <span class="free">σ</span> <span class="main">⟹</span> is_mgu <span class="free">σ</span> <span class="free">AAA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    mgu_complete<span class="main">:</span>
      <span class="quoted"><span class="quoted">"finite <span class="free">AAA</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">AA</span> <span class="main">∈</span> <span class="free">AAA</span><span class="main">.</span> finite <span class="bound">AA</span><span class="main">)</span> <span class="main">⟹</span> is_unifiers <span class="free">σ</span> <span class="free">AAA</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> <span class="free">mgu</span> <span class="free">AAA</span> <span class="main">=</span> Some <span class="bound">τ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> is_unifiers_mgu <span class="main">=</span> mgu_sound<span class="main">[</span><span class="operator">unfolded</span> is_mgu_def<span class="main">,</span> <span class="operator">THEN</span> conjunct1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> is_mgu_most_general <span class="main">=</span> mgu_sound<span class="main">[</span><span class="operator">unfolded</span> is_mgu_def<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> mgu_unifier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    aslen<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">As</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    aaslen<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">AAs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    mgu<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">σ</span> <span class="main">=</span> <span class="free">mgu</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="free">As</span> <span class="free">AAs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    a_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">AAs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">As</span> <span class="main">!</span> <span class="free">i</span> <span class="keyword1">⋅a</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> mgu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_mgu <span class="free">σ</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="free">As</span> <span class="free">AAs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mgu_sound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_unifiers <span class="free">σ</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="free">As</span> <span class="free">AAs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_mgu_is_unifiers <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_unifier <span class="free">σ</span> <span class="main">(</span>set_mset <span class="main">(</span>add_mset <span class="main">(</span><span class="free">As</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">AAs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_lt aslen aaslen <span class="keyword1"><span class="command">unfolding</span></span> is_unifiers_def is_unifier_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> length_zip min.idem nth_mem nth_zip prod.case set_mset_add_mset_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> aslen aaslen a_in is_unifier_subst_atm_eqI
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_set_mset insertCI set_mset_add_mset_insert<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Inference_System">
<div class="head">
<h1>Theory Inference_System</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Refutational Inference Systems
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2017
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Refutational Inference Systems›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Inference_System
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Herbrand_Interpretation.html">Herbrand_Interpretation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory gathers results from Section 2.4 (``Refutational Theorem Proving''), 3 (``Standard
Resolution''), and 4.2 (``Counterexample-Reducing Inference Systems'') of Bachmair and Ganzinger's
chapter.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Inferences have one distinguished main premise, any number of side premises, and a conclusion.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> inference <span class="main">=</span>
  Infer <span class="main">(</span><span class="free"><span class="entity">side_prems_of</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause multiset"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">main_prem_of</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">concl_of</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">prems_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> inference <span class="main">⇒</span> <span class="tfree">'a</span> clause multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prems_of</span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="main">≡</span> side_prems_of <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="main">+</span> <span class="main">{#</span>main_prem_of <span class="free"><span class="bound"><span class="entity">γ</span></span></span><span class="main">#}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">concls_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> inference set <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">concls_of</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">≡</span> concl_of <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">infer_from</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> inference <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">infer_from</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="main">⟷</span> set_mset <span class="main">(</span>prems_of <span class="free"><span class="bound"><span class="entity">γ</span></span></span><span class="main">)</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> inference_system <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> inference set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inferences_from</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> inference set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inferences_from</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">γ</span><span class="main">.</span> <span class="bound">γ</span> <span class="main">∈</span> <span class="free">Γ</span> <span class="main">∧</span> infer_from <span class="free"><span class="bound"><span class="entity">CC</span></span></span> <span class="bound">γ</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inferences_between</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> inference set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inferences_between</span> <span class="free"><span class="bound"><span class="entity">CC</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">γ</span><span class="main">.</span> <span class="bound">γ</span> <span class="main">∈</span> <span class="free">Γ</span> <span class="main">∧</span> infer_from <span class="main">(</span><span class="free"><span class="bound"><span class="entity">CC</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">)</span> <span class="bound">γ</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∈#</span> prems_of <span class="bound">γ</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inferences_from_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="main">⊆</span> <span class="free">DD</span> <span class="main">⟹</span> inferences_from <span class="free">CC</span> <span class="main">⊆</span> inferences_from <span class="free">DD</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inferences_from_def infer_from_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">saturated</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">saturated</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⟷</span> concls_of <span class="main">(</span>inferences_from <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> saturatedD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    satur<span class="main">:</span> <span class="quoted"><span class="quoted">"saturated <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    inf<span class="main">:</span> <span class="quoted"><span class="quoted">"Infer <span class="free">CC</span> <span class="free">D</span> <span class="free">E</span> <span class="main">∈</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cc_subs_n<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">CC</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_in_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∈</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Infer <span class="free">CC</span> <span class="free">D</span> <span class="free">E</span> <span class="main">∈</span> inferences_from <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inferences_from_def infer_from_def <span class="keyword1"><span class="command">using</span></span> inf cc_subs_n d_in_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∈</span> concls_of <span class="main">(</span>inferences_from <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inference.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∈</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> satur <span class="keyword1"><span class="command">unfolding</span></span> saturated_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Satisfiability preservation is a weaker requirement than soundness.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> sat_preserving_inference_system <span class="main">=</span> inference_system <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Γ_sat_preserving<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfiable <span class="free">N</span> <span class="main">⟹</span> satisfiable <span class="main">(</span><span class="free">N</span> <span class="main">∪</span> concls_of <span class="main">(</span>inferences_from <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> sound_inference_system <span class="main">=</span> inference_system <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Γ_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"Infer <span class="free">CC</span> <span class="free">D</span> <span class="free">E</span> <span class="main">∈</span> <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="free">CC</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">E</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Γ_sat_preserving<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sat_n<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfiable <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span><span class="free">N</span> <span class="main">∪</span> concls_of <span class="main">(</span>inferences_from <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="keyword1">⊨s</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sat_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">CC</span> <span class="bound">D</span> <span class="bound">E</span><span class="main">.</span> Infer <span class="bound">CC</span> <span class="bound">D</span> <span class="bound">E</span> <span class="main">∈</span> <span class="free">Γ</span> <span class="main">⟹</span> set_mset <span class="bound">CC</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">⟹</span> <span class="bound">D</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> <span class="skolem">I</span> <span class="main">⊨</span> <span class="bound">E</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Γ_sound <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def true_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">γ</span><span class="main">.</span> <span class="bound">γ</span> <span class="main">∈</span> <span class="free">Γ</span> <span class="main">⟹</span> infer_from <span class="free">N</span> <span class="bound">γ</span> <span class="main">⟹</span> <span class="skolem">I</span> <span class="main">⊨</span> concl_of <span class="bound">γ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> infer_from_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">γ</span></span><span class="main">)</span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="keyword1">⊨s</span> concls_of <span class="main">(</span>inferences_from <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inferences_from_def image_def true_clss_def infer_from_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="keyword1">⊨s</span> <span class="free">N</span> <span class="main">∪</span> concls_of <span class="main">(</span>inferences_from <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sat_preserving_inference_system
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">erule</span> Γ_sat_preserving<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> reductive_inference_system <span class="main">=</span> inference_system <span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wellorder<span class="main">)</span> inference set"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Γ_reductive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">∈</span> <span class="free">Γ</span> <span class="main">⟹</span> concl_of <span class="free">γ</span> <span class="main">&lt;</span> main_prem_of <span class="free">γ</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refutational Completeness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Refutational completeness can be established once and for all for counterexample-reducing inference
systems. The material formalized here draws from both the general framework of Section 4.2 and the
concrete instances of Section 3.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> counterex_reducing_inference_system <span class="main">=</span>
  inference_system <span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wellorder<span class="main">)</span> inference set"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> interp"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Γ_counterex_reducing<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∉</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">I_of</span> <span class="free">N</span> <span class="main">⊨</span> <span class="free">D</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">I_of</span> <span class="free">N</span> <span class="main">⊨</span> <span class="bound">C</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">≤</span> <span class="bound">C</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">∃</span><span class="bound">CC</span> <span class="bound">E</span><span class="main">.</span> set_mset <span class="bound">CC</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">∧</span> <span class="free">I_of</span> <span class="free">N</span> <span class="keyword1">⊨m</span> <span class="bound">CC</span> <span class="main">∧</span> Infer <span class="bound">CC</span> <span class="free">D</span> <span class="bound">E</span> <span class="main">∈</span> <span class="free">Γ</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">I_of</span> <span class="free">N</span> <span class="main">⊨</span> <span class="bound">E</span> <span class="main">∧</span> <span class="bound">E</span> <span class="main">&lt;</span> <span class="free">D</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_min_counterex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wellorder<span class="main">)</span> clause set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">N</span><span class="main">.</span> <span class="main">¬</span> <span class="free">I</span> <span class="main">⊨</span> <span class="bound">C</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">D</span> <span class="main">∈</span> <span class="free">N</span><span class="main">.</span> <span class="bound">D</span> <span class="main">&lt;</span> <span class="bound">C</span> <span class="main">⟶</span> <span class="free">I</span> <span class="main">⊨</span> <span class="bound">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I</span> <span class="main">⊨</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">C</span></span> <span class="main">∈</span> <span class="free">N</span><span class="main">.</span> <span class="main">¬</span> <span class="free">I</span> <span class="main">⊨</span> <span class="bound">C</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_eq_minimal<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> wf_less_multiset c_in<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Theorem 4.4 (generalizes Theorems 3.9 and 3.16) *)</span>

<span class="keyword1"><span class="command">theorem</span></span> saturated_model<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    satur<span class="main">:</span> <span class="quoted"><span class="quoted">"saturated <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ec_ni_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∉</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I_of</span> <span class="free">N</span> <span class="keyword1">⊨s</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I_of</span> <span class="free">N</span> <span class="keyword1">⊨s</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      d_in_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      d_cex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I_of</span> <span class="free">N</span> <span class="main">⊨</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      d_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> <span class="bound">C</span> <span class="main">&lt;</span> <span class="skolem">D</span> <span class="main">⟹</span> <span class="free">I_of</span> <span class="free">N</span> <span class="main">⊨</span> <span class="bound">C</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ex_min_counterex<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">CC</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      cc_subs_n<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">CC</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      inf_e<span class="main">:</span> <span class="quoted"><span class="quoted">"Infer <span class="skolem">CC</span> <span class="skolem">D</span> <span class="skolem">E</span> <span class="main">∈</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      e_cex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I_of</span> <span class="free">N</span> <span class="main">⊨</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      e_lt_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">&lt;</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Γ_counterex_reducing<span class="main">[</span><span class="operator">OF</span> ec_ni_n<span class="main">]</span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> cc_subs_n inf_e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d_in_n satur <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> saturatedD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> e_cex e_lt_d d_min not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">satx</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Cf. Corollary 3.10:
›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> saturated_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"saturated <span class="free">N</span> <span class="main">⟹</span> <span class="main">¬</span> satisfiable <span class="free">N</span> <span class="main">⟹</span> <span class="main">{#}</span> <span class="main">∈</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> saturated_model <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Compactness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Bachmair and Ganzinger claim that compactness follows from refutational completeness but leave the
proof to the readers' imagination. Our proof relies on an inductive definition of saturation in
terms of a base set of clauses.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> inference_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">saturate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">CC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∈</span> <span class="free">CC</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∈</span> <span class="free">saturate</span> <span class="free">CC</span>"</span></span>
<span class="main">|</span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"Infer <span class="free"><span class="bound"><span class="entity">CC'</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∈</span> <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">C'</span><span class="main">.</span> <span class="bound">C'</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">CC'</span></span></span> <span class="main">⟹</span> <span class="bound">C'</span> <span class="main">∈</span> <span class="free">saturate</span> <span class="free">CC</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∈</span> <span class="free">saturate</span> <span class="free">CC</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∈</span> <span class="free">saturate</span> <span class="free">CC</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> saturate_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> saturate <span class="free">CC</span> <span class="main">⟹</span> <span class="free">CC</span> <span class="main">⊆</span> <span class="free">DD</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">∈</span> saturate <span class="free">DD</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> saturate.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> saturate.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> saturated_saturate<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"saturated <span class="main">(</span>saturate <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> saturated_def inferences_from_def infer_from_def image_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span> <span class="main">(</span><span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> saturate.step<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> saturate_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> saturate <span class="free">CC</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">DD</span><span class="main">.</span> <span class="bound">DD</span> <span class="main">⊆</span> <span class="free">CC</span> <span class="main">∧</span> finite <span class="bound">DD</span> <span class="main">∧</span> <span class="free">C</span> <span class="main">∈</span> saturate <span class="bound">DD</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> saturate.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">C</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">CC</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="skolem">C</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> saturate <span class="main">{</span><span class="skolem">C</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> saturate.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">CC'</span> <span class="skolem">D</span> <span class="skolem">E</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">DD_of</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈#</span> <span class="skolem">CC'</span> <span class="main">⟹</span> <span class="skolem">DD_of</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">CC</span> <span class="main">∧</span> finite <span class="main">(</span><span class="skolem">DD_of</span> <span class="bound">C</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">C</span> <span class="main">∈</span> saturate <span class="main">(</span><span class="skolem">DD_of</span> <span class="bound">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> set_mset <span class="skolem">CC'</span><span class="main">.</span> <span class="skolem">DD_of</span> <span class="bound">C</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">CC</span>"</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> set_mset <span class="skolem">CC'</span><span class="main">.</span> <span class="skolem">DD_of</span> <span class="bound">C</span><span class="main">)</span> <span class="main">∧</span> set_mset <span class="skolem">CC'</span> <span class="main">⊆</span> saturate <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> set_mset <span class="skolem">CC'</span><span class="main">.</span> <span class="skolem">DD_of</span> <span class="bound">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> saturate_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">DD</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    d_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">DD</span> <span class="main">⊆</span> <span class="free">CC</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">DD</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> in_sat_d<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">CC'</span> <span class="main">⊆</span> saturate <span class="skolem">DD</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">EE</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    e_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">EE</span> <span class="main">⊆</span> <span class="free">CC</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">EE</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> in_sat_ee<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> saturate <span class="skolem">EE</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">DD</span> <span class="main">∪</span> <span class="skolem">EE</span> <span class="main">⊆</span> <span class="free">CC</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d_sub e_sub step<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">DD</span> <span class="main">∪</span> <span class="skolem">EE</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d_fin e_fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> saturate <span class="main">(</span><span class="skolem">DD</span> <span class="main">∪</span> <span class="skolem">EE</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_sat_d in_sat_ee step.hyps<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inference_system.saturate.step saturate_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> sound_inference_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> saturate_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> saturate <span class="free">CC</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">CC</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> saturate.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> true_cls_mset_def true_clss_def Γ_sound<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> sat_preserving_inference_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This result surely holds, but we have yet to prove it. The challenge is: Every time a new clause is
introduced, we also get a new interpretation (by the definition of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sat_preserving_inference_system›</span></span></span></span>). But the interpretation we want here is then the one that
exists "at the limit". Maybe we can use compactness to prove it.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> saturate_sat_preserving<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfiable <span class="free">CC</span> <span class="main">⟹</span> satisfiable <span class="main">(</span>saturate <span class="free">CC</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> sound_counterex_reducing_inference_system <span class="main">=</span>
  counterex_reducing_inference_system <span class="main">+</span> sound_inference_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Compactness of clausal logic is stated as Theorem 3.12 for the case of unordered ground resolution.
The proof below is a generalization to any sound counterexample-reducing inference system. The
actual theorem will become available once the locale has been instantiated with a concrete inference
system.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> clausal_logic_compact<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wellorder<span class="main">)</span> clause set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="free">N</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">DD</span></span> <span class="main">⊆</span> <span class="free">N</span><span class="main">.</span> finite <span class="bound">DD</span> <span class="main">∧</span> <span class="main">¬</span> satisfiable <span class="bound">DD</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> saturate <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> saturated_complete saturated_saturate saturate.base <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">DD</span></span> <span class="main">⊆</span> <span class="free">N</span><span class="main">.</span> finite <span class="bound">DD</span> <span class="main">∧</span> <span class="main">{#}</span> <span class="main">∈</span> saturate <span class="bound">DD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> saturate_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">DD</span></span> <span class="main">⊆</span> <span class="free">N</span><span class="main">.</span> finite <span class="bound">DD</span> <span class="main">∧</span> <span class="main">¬</span> satisfiable <span class="bound">DD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> saturate_sound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">DD</span></span> <span class="main">⊆</span> <span class="free">N</span><span class="main">.</span> finite <span class="bound">DD</span> <span class="main">∧</span> <span class="main">¬</span> satisfiable <span class="bound">DD</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> true_clss_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ground_Resolution_Model">
<div class="head">
<h1>Theory Ground_Resolution_Model</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Candidate Models for Ground Resolution
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Candidate Models for Ground Resolution›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ground_Resolution_Model
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Herbrand_Interpretation.html">Herbrand_Interpretation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The proofs of refutational completeness for the two resolution inference systems presented in
Section 3 (``Standard Resolution'') of Bachmair and Ganzinger's chapter share mostly the same
candidate model construction. The literal selection capability needed for the second system is
ignored by the first one, by taking <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as instantiation for the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span>
parameter.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> selection <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    S_selects_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">C</span> <span class="main">⊆#</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    S_selects_neg_lits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈#</span> <span class="free">S</span> <span class="free">C</span> <span class="main">⟹</span> is_neg <span class="free">L</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ground_resolution_with_selection <span class="main">=</span> selection <span class="quoted"><span class="free">S</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wellorder<span class="main">)</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following commands corresponds to Definition 3.14, which generalizes Definition 3.1.
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>production C›</span></span></span></span> is denoted $\varepsilon_C$ in the chapter; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>interp C›</span></span></span></span> is denoted
$I_C$; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Interp C›</span></span></span></span> is denoted $I^C$; and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Interp_N›</span></span></span></span> is denoted $I_N$. The mutually
recursive definition from the chapter is massaged to simplify the termination argument. The
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>production_unfold›</span></span></span></span> lemma below gives the intended characterization.
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">production</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> interp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">production</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span>
   <span class="main">{</span><span class="bound">A</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∈</span> <span class="free">N</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> Max_mset <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> Pos <span class="bound">A</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">D</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free">production</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∧</span> <span class="free">S</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">{#}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"termination"</span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> production.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> interp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interp</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">D</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">.</span> production <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> production_unfold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"production <span class="free">C</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">.</span> <span class="free">C</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">∧</span> <span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> Max_mset <span class="free">C</span> <span class="main">=</span> Pos <span class="bound">A</span> <span class="main">∧</span> <span class="main">¬</span> interp <span class="free">C</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">S</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{#}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> interp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> production.simps<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">productive</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">productive</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≡</span> production <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">produces</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">produces</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> production <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> producesD<span class="main">:</span> <span class="quoted"><span class="quoted">"produces <span class="free">C</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">∧</span> <span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> Pos <span class="free">A</span> <span class="main">=</span> Max_mset <span class="free">C</span> <span class="main">∧</span> <span class="main">¬</span> interp <span class="free">C</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">S</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> production_unfold <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Interp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> interp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Interp</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> interp <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∪</span> production <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_subseteq_Interp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interp <span class="free">C</span> <span class="main">⊆</span> Interp <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Interp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Interp_as_UNION<span class="main">:</span> <span class="quoted"><span class="quoted">"Interp <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">D</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">≤</span> <span class="free">C</span><span class="main">}</span><span class="main">.</span> production <span class="bound">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Interp_def interp_def less_eq_multiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> productive_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"productive <span class="free">C</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> production_unfold <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> productive_imp_produces_Max_literal<span class="main">:</span> <span class="quoted"><span class="quoted">"productive <span class="free">C</span> <span class="main">⟹</span> produces <span class="free">C</span> <span class="main">(</span>atm_of <span class="main">(</span>Max_mset <span class="free">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> production_unfold <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> atm_of_Max_lit<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> productive_imp_produces_Max_atom<span class="main">:</span> <span class="quoted"><span class="quoted">"productive <span class="free">C</span> <span class="main">⟹</span> produces <span class="free">C</span> <span class="main">(</span>Max <span class="main">(</span>atms_of <span class="free">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def Max_atm_of_set_mset_commute<span class="main">[</span><span class="operator">OF</span> productive_not_empty<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> productive_imp_produces_Max_literal<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> produces_imp_Max_literal<span class="main">:</span> <span class="quoted"><span class="quoted">"produces <span class="free">C</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> atm_of <span class="main">(</span>Max_mset <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> productive_imp_produces_Max_literal <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> produces_imp_Max_atom<span class="main">:</span> <span class="quoted"><span class="quoted">"produces <span class="free">C</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> Max <span class="main">(</span>atms_of <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> producesD produces_imp_Max_literal <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> produces_imp_Pos_in_lits<span class="main">:</span> <span class="quoted"><span class="quoted">"produces <span class="free">C</span> <span class="free">A</span> <span class="main">⟹</span> Pos <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> producesD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> productive_in_N<span class="main">:</span> <span class="quoted"><span class="quoted">"productive <span class="free">C</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">∈</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> production_unfold <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> produces_imp_atms_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"produces <span class="free">C</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">∈</span> atms_of <span class="free">C</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">≤</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Max.coboundedI produces_imp_Max_atom <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> produces_imp_neg_notin_lits<span class="main">:</span> <span class="quoted"><span class="quoted">"produces <span class="free">C</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">¬</span> Neg <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_Max_imp_neg_notin producesD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_eq_imp_interp_subseteq_interp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> interp <span class="free">C</span> <span class="main">⊆</span> interp <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> interp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> order.strict_trans2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_eq_imp_interp_subseteq_Interp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> interp <span class="free">C</span> <span class="main">⊆</span> Interp <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Interp_def <span class="keyword1"><span class="command">using</span></span> less_eq_imp_interp_subseteq_interp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> less_imp_production_subseteq_interp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">&lt;</span> <span class="free">D</span> <span class="main">⟹</span> production <span class="free">C</span> <span class="main">⊆</span> interp <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> interp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> less_eq_imp_production_subseteq_Interp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> production <span class="free">C</span> <span class="main">⊆</span> Interp <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Interp_def <span class="keyword1"><span class="command">using</span></span> less_imp_production_subseteq_interp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_imp_less_or_eq le_supI1 sup_ge2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_imp_Interp_subseteq_interp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">&lt;</span> <span class="free">D</span> <span class="main">⟹</span> Interp <span class="free">C</span> <span class="main">⊆</span> interp <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Interp_def less_eq_imp_interp_subseteq_interp less_imp_production_subseteq_interp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_eq_imp_Interp_subseteq_Interp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> Interp <span class="free">C</span> <span class="main">⊆</span> Interp <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Interp_def less_eq_imp_interp_subseteq_Interp less_eq_imp_production_subseteq_Interp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> not_Interp_to_interp_imp_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> Interp <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> interp <span class="free">D</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">&lt;</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_eq_imp_interp_subseteq_Interp not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> not_interp_to_interp_imp_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> interp <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> interp <span class="free">D</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">&lt;</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_eq_imp_interp_subseteq_interp not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> not_Interp_to_Interp_imp_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> Interp <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> Interp <span class="free">D</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">&lt;</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_eq_imp_Interp_subseteq_Interp not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> not_interp_to_Interp_imp_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> interp <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> Interp <span class="free">D</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">≤</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_imp_Interp_subseteq_interp not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">INTERP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">INTERP</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">N</span><span class="main">.</span> production <span class="bound">C</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_subseteq_INTERP<span class="main">:</span> <span class="quoted"><span class="quoted">"interp <span class="free">C</span> <span class="main">⊆</span> INTERP"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> interp_def INTERP_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> production_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> production_subseteq_INTERP<span class="main">:</span> <span class="quoted"><span class="quoted">"production <span class="free">C</span> <span class="main">⊆</span> INTERP"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> INTERP_def <span class="keyword1"><span class="command">using</span></span> production_unfold <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Interp_subseteq_INTERP<span class="main">:</span> <span class="quoted"><span class="quoted">"Interp <span class="free">C</span> <span class="main">⊆</span> INTERP"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Interp_def interp_subseteq_INTERP production_subseteq_INTERP<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> produces_imp_in_interp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a_in_c<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"produces <span class="free">D</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> interp <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Interp_def Max_pos_neg_less_multiset UnCI a_in_c d
      not_interp_to_Interp_imp_le not_less producesD singletonI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_notin_Interp_not_produce<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∉</span> Interp <span class="free">D</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> <span class="main">¬</span> produces <span class="free">D''</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_eq_imp_interp_subseteq_Interp produces_imp_in_interp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> in_production_imp_produces<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> production <span class="free">C</span> <span class="main">⟹</span> produces <span class="free">C</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> productive_imp_produces_Max_atom <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> not_produces_imp_notin_production<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> produces <span class="free">C</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∉</span> production <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> in_production_imp_produces <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> not_produces_imp_notin_interp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">D</span><span class="main">.</span> <span class="main">¬</span> produces <span class="bound">D</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∉</span> interp <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> interp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_production_imp_produces<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The results below corresponds to Lemma 3.4.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Interp_imp_general<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    c_le_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_lt_d'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">&lt;</span> <span class="free">D'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c_at_d<span class="main">:</span> <span class="quoted"><span class="quoted">"Interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    subs<span class="main">:</span> <span class="quoted"><span class="quoted">"interp <span class="free">D'</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> production <span class="bound">C</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> production <span class="bound">C</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span><span class="main">.</span> Pos <span class="bound">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">∈</span> Interp <span class="free">D</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_in_c<span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="skolem">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a_at_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> Interp <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> a_at_d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> interp <span class="free">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d_lt_d' less_imp_Interp_subseteq_interp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> subs a_in_c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> contra_subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_in_c<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="skolem">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> Interp <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_at_d <span class="keyword1"><span class="command">unfolding</span></span> true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D''</span><span class="main">.</span> <span class="main">¬</span> produces <span class="bound">D''</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_le_d neg_notin_Interp_not_produce <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> a_in_c subs not_produces_imp_notin_production <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Interp_imp_interp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">&lt;</span> <span class="free">D'</span> <span class="main">⟹</span> Interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⟹</span> interp <span class="free">D'</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> interp_def Interp_imp_general <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Interp_imp_Interp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">≤</span> <span class="free">D'</span> <span class="main">⟹</span> Interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⟹</span> Interp <span class="free">D'</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Interp_as_UNION interp_subseteq_Interp Interp_imp_general <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym_conv2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Interp_imp_INTERP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> Interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⟹</span> INTERP <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> INTERP_def interp_subseteq_INTERP Interp_imp_general<span class="main">[</span><span class="operator">OF</span> _ le_multiset_right_total<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_imp_general<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    c_le_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_le_d'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">≤</span> <span class="free">D'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c_at_d<span class="main">:</span> <span class="quoted"><span class="quoted">"interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    subs<span class="main">:</span> <span class="quoted"><span class="quoted">"interp <span class="free">D'</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> production <span class="bound">C</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> production <span class="bound">C</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span><span class="main">.</span> Pos <span class="bound">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">∈</span> interp <span class="free">D</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_in_c<span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="skolem">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a_at_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> interp <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> a_at_d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> interp <span class="free">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d_le_d' less_eq_imp_interp_subseteq_interp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> subs a_in_c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> contra_subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_in_c<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="skolem">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> interp <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_at_d <span class="keyword1"><span class="command">unfolding</span></span> true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D''</span><span class="main">.</span> <span class="main">¬</span> produces <span class="bound">D''</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_le_d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> produces_imp_in_interp less_eq_imp_interp_subseteq_interp<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> a_in_c subs not_produces_imp_notin_production <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interp_imp_interp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">≤</span> <span class="free">D'</span> <span class="main">⟹</span> interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⟹</span> interp <span class="free">D'</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> interp_def interp_imp_general <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_imp_Interp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">≤</span> <span class="free">D'</span> <span class="main">⟹</span> interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⟹</span> Interp <span class="free">D'</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Interp_as_UNION interp_subseteq_Interp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D'</span></span><span class="main">]</span> interp_imp_general <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_imp_INTERP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⟹</span> INTERP <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> INTERP_def interp_subseteq_INTERP interp_imp_general linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> productive_imp_not_interp<span class="main">:</span> <span class="quoted"><span class="quoted">"productive <span class="free">C</span> <span class="main">⟹</span> <span class="main">¬</span> interp <span class="free">C</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> production_unfold <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This corresponds to Lemma 3.3:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> productive_imp_Interp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"productive <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Interp <span class="free">C</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"produces <span class="free">C</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms productive_imp_produces_Max_atom <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a_in_c<span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="skolem">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> produces_imp_Pos_in_lits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> Interp <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a less_eq_imp_production_subseteq_Interp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> productive_imp_INTERP<span class="main">:</span> <span class="quoted"><span class="quoted">"productive <span class="free">C</span> <span class="main">⟹</span> INTERP <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_imp_Interp Interp_imp_INTERP<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This corresponds to Lemma 3.5:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_pos_imp_Interp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Max_mset <span class="free">C</span> <span class="main">=</span> Pos <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Interp <span class="free">C</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"productive <span class="free">C</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_imp_Interp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp <span class="free">C</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> production_unfold <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Interp_def <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following results correspond to Lemma 3.6:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_atm_imp_Interp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    c_in_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pos_in<span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    max_atm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> Max <span class="main">(</span>atms_of <span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s_c_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Interp <span class="free">C</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pos_in pos_neg_in_imp_true <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max_mset <span class="free">C</span> <span class="main">=</span> Pos <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> max_atm <span class="keyword1"><span class="command">using</span></span> Max_in_lits Max_lit_eq_pos_or_neg_Max_atm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ne c_in_n s_c_e <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max_pos_imp_Interp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_Interp_imp_general<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    d'_le_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D'</span> <span class="main">≤</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    in_n_or_max_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D'</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">∧</span> <span class="free">S</span> <span class="free">D'</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∨</span> Max <span class="main">(</span>atms_of <span class="free">D'</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>atms_of <span class="free">D</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d'_at_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">D'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_lt_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">&lt;</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    subs<span class="main">:</span> <span class="quoted"><span class="quoted">"interp <span class="free">C</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> production <span class="bound">C</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> production <span class="bound">C</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">D'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> cc_blw_d'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> production <span class="bound">C</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">D'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Interp <span class="free">D</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> production <span class="bound">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less_imp_Interp_subseteq_interp d_lt_c subs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_in_d'<span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="skolem">A</span> <span class="main">∈#</span> <span class="free">D'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a_blw_cc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> production <span class="bound">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cc_blw_d' d'_at_d false_to_true_imp_ex_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> a_in_d' <span class="keyword1"><span class="command">have</span></span> a_at_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> Interp <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d'_at_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">from</span></span> a_blw_cc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span> prod_c'<span class="main">:</span> <span class="quoted"><span class="quoted">"production <span class="skolem">C'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">A</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_production_imp_produces<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> max_c'<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>atms_of <span class="skolem">C'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod_c' productive_imp_produces_Max_atom <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> leq_dc'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">≤</span> <span class="skolem">C'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_at_d d'_at_d prod_c' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Interp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> not_interp_to_Interp_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D'</span> <span class="main">≤</span> <span class="skolem">C'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d'_le_d order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> max_d'<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>atms_of <span class="free">D'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_in_d' max_c' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pos_lit_in_atms_of le_multiset_Max_in_imp_Max<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">D'</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">∧</span> <span class="free">S</span> <span class="free">D'</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Interp <span class="free">D'</span> <span class="main">⊨</span> <span class="free">D'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a_in_d' max_d' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max_atm_imp_Interp<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">D'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> d'_le_d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Interp_imp_Interp <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_multiset_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> d'_at_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">satx</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>atms_of <span class="free">D'</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>atms_of <span class="free">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> max_d' leq_dc' max_c' d'_le_d
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_imp_less_or_eq le_multiset_empty_right less_eq_Max_atms_of less_imp_not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> in_n_or_max_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">satx</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">satx</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_Interp_imp_not_interp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">D'</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">D'</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">∧</span> <span class="free">S</span> <span class="free">D'</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∨</span> Max <span class="main">(</span>atms_of <span class="free">D'</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>atms_of <span class="free">D</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> Interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">D'</span> <span class="main">⟹</span>
   <span class="free">D</span> <span class="main">&lt;</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">¬</span> interp <span class="free">C</span> <span class="main">⊨</span> <span class="free">D'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> interp_def not_Interp_imp_general <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> not_Interp_imp_not_Interp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">D'</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">D'</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">∧</span> <span class="free">S</span> <span class="free">D'</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∨</span> Max <span class="main">(</span>atms_of <span class="free">D'</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>atms_of <span class="free">D</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> Interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">D'</span> <span class="main">⟹</span>
   <span class="free">D</span> <span class="main">&lt;</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">¬</span> Interp <span class="free">C</span> <span class="main">⊨</span> <span class="free">D'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Interp_as_UNION interp_subseteq_Interp not_Interp_imp_general <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> not_Interp_imp_not_INTERP<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">D'</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">D'</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">∧</span> <span class="free">S</span> <span class="free">D'</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∨</span> Max <span class="main">(</span>atms_of <span class="free">D'</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>atms_of <span class="free">D</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> Interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">D'</span> <span class="main">⟹</span>
   <span class="main">¬</span> INTERP <span class="main">⊨</span> <span class="free">D'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> INTERP_def interp_subseteq_INTERP not_Interp_imp_general<span class="main">[</span><span class="operator">OF</span> _ _ _ le_multiset_right_total<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Lemma 3.7 is a problem child. It is stated below but not proved; instead, a counterexample is
displayed. This is not much of a problem, because it is not invoked in the rest of the chapter.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="free">D</span> <span class="main">⟹</span> Interp <span class="bound">D'</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="main">{</span><span class="free">D</span><span class="main">,</span> <span class="free">C</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">{#</span>Pos <span class="free">A</span><span class="main">#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="free">D</span> <span class="main">⟹</span> Interp <span class="bound">D'</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> interp <span class="free">D</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">unfolding</span></span> d c interp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Unordered_Ground_Resolution">
<div class="head">
<h1>Theory Unordered_Ground_Resolution</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Ground Unordered Resolution Calculus
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2017
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Ground Unordered Resolution Calculus›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Unordered_Ground_Resolution
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Inference_System.html">Inference_System</a> <a href="Ground_Resolution_Model.html">Ground_Resolution_Model</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Unordered ground resolution is one of the two inference systems studied in Section 3 (``Standard
Resolution'') of Bachmair and Ganzinger's chapter.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inference Rule›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Unordered ground resolution consists of a single rule, called <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>unord_resolve›</span></span></span></span> below, which is
sound and counterexample-reducing.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ground_resolution_without_selection
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ground_resolution_with_selection <span class="keyword2"><span class="keyword">where</span></span> S <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">unord_resolve</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unord_resolve</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">+</span> replicate_mset <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Pos <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>add_mset <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unord_resolve_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"unord_resolve <span class="free">C</span> <span class="free">D</span> <span class="free">E</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unord_resolve.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following result corresponds to Theorem 3.8, except that the conclusion is strengthened slightly
to make it fit better with the counterexample-reducing inference system framework.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> unord_resolve_counterex_reducing<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ec_ni_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∉</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c_in_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c_cex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="bound">D</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">≤</span> <span class="bound">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">D</span> <span class="free">E</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="free">N</span>"</span></span>
    <span class="quoted"><span class="quoted">"INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="free">D</span>"</span></span>
    <span class="quoted"><span class="quoted">"productive <span class="free">N</span> <span class="free">D</span>"</span></span>
    <span class="quoted"><span class="quoted">"unord_resolve <span class="free">D</span> <span class="free">C</span> <span class="free">E</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="free">E</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">&lt;</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> c_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_in_n ec_ni_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> atms_of <span class="free">C</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">=</span> Max <span class="main">(</span>atms_of <span class="free">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_ne <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_in_lits atm_of_Max_lit atm_of_lit_in_atms_of<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span><span class="main">.</span> Neg <span class="bound">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_ne c_in_n c_cex c_min Max_in_lits Max_lit_eq_pos_or_neg_Max_atm  max_pos_imp_Interp
      Interp_imp_INTERP <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> neg_a_in_c<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="skolem">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> add_mset <span class="main">(</span>Neg <span class="skolem">A</span><span class="main">)</span> <span class="skolem">C'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert_DiffM <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> INTERP <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> neg_a_in_c c_cex<span class="main">[</span><span class="operator">unfolded</span> true_cls_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> d0<span class="main">:</span> <span class="quoted"><span class="quoted">"produces <span class="free">N</span> <span class="skolem">D</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> INTERP_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UN_E not_produces_imp_notin_production<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> prod_d<span class="main">:</span> <span class="quoted"><span class="quoted">"productive <span class="free">N</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> d0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> d_in_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> productive_in_N <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> d_true<span class="main">:</span> <span class="quoted"><span class="quoted">"INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_d productive_imp_INTERP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">AAA</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">D'</span> <span class="main">+</span> <span class="skolem">AAA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">L</span> <span class="main">∈#</span> <span class="skolem">D</span><span class="main">.</span> <span class="bound">L</span> <span class="main">≠</span> Pos <span class="skolem">A</span><span class="main">#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AAA</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">L</span> <span class="main">∈#</span> <span class="skolem">D</span><span class="main">.</span> <span class="bound">L</span> <span class="main">=</span> Pos <span class="skolem">A</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multiset_partition union_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> d'_subs<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">D'</span> <span class="main">⊆</span> set_mset <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> d' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Neg <span class="skolem">A</span> <span class="main">∈#</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> produces_imp_neg_notin_lits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neg_a_ni_d'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Neg <span class="skolem">A</span> <span class="main">∈#</span> <span class="skolem">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d'_subs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> a_ni_d'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> atms_of <span class="skolem">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d' neg_a_ni_d' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> atm_imp_pos_or_neg_lit<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">AAA</span> <span class="main">=</span> replicate_mset <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>Pos <span class="skolem">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> aa d0 not0_implies_Suc produces_imp_Pos_in_lits<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_eq_replicate_mset <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> replicate_mset_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"unord_resolve <span class="skolem">D</span> <span class="free">C</span> <span class="main">(</span><span class="skolem">D'</span> <span class="main">+</span> <span class="skolem">C'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> c d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> unord_resolve.intros<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> d'_le_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">≤</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> a_max_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Max <span class="main">(</span>atms_of <span class="skolem">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d0 productive_imp_produces_Max_atom <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> Max <span class="main">(</span>atms_of <span class="skolem">D'</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d'_le_d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_eq_Max_atms_of<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> Max <span class="main">(</span>atms_of <span class="skolem">D'</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_ni_d' Max_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> atms_empty_iff_empty<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> max_d'_lt_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> Max <span class="main">(</span>atms_of <span class="skolem">D'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dual_order.strict_iff_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> interp <span class="free">N</span> <span class="skolem">D</span> <span class="main">⊨</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d0 productive_imp_not_interp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Interp <span class="free">N</span> <span class="skolem">D</span> <span class="main">⊨</span> <span class="skolem">D'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> d0 d' Interp_def true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> true_lit_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> not_gr_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="skolem">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_max_d d'_le_d max_d'_lt_a not_Interp_imp_not_INTERP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="skolem">C'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_cex <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> e_cex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="skolem">D'</span> <span class="main">+</span> <span class="skolem">C'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> atms_of <span class="skolem">D'</span> <span class="main">⟹</span> <span class="bound">B</span> <span class="main">≤</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d0 d'_subs contra_subsetD lits_subseteq_imp_atms_subseteq produces_imp_atms_leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈#</span> <span class="skolem">D'</span> <span class="main">⟹</span> <span class="bound">L</span> <span class="main">&lt;</span> Neg <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> neg_a_ni_d' antisym_conv1 atms_less_eq_imp_lit_less_eq_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lt_cex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">+</span> <span class="skolem">C'</span> <span class="main">&lt;</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add.commute <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c less_multiset<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>Neg <span class="skolem">A</span><span class="main">#}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> d_in_n d_true prod_d res_e e_cex lt_cex <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inference System›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Theorem 3.9 and Corollary 3.10 are subsumed in the counterexample-reducing inference system
framework, which is instantiated below.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unord_Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> inference set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unord_Γ</span> <span class="main">=</span> <span class="main">{</span>Infer <span class="main">{#</span><span class="bound">C</span><span class="main">#}</span> <span class="bound">D</span> <span class="bound">E</span> <span class="main">|</span> <span class="bound">C</span> <span class="bound">D</span> <span class="bound">E</span><span class="main">.</span> unord_resolve <span class="bound">C</span> <span class="bound">D</span> <span class="bound">E</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> unord_Γ_sound_counterex_reducing<span class="main">?</span><span class="main">:</span>
  sound_counterex_reducing_inference_system <span class="quoted">unord_Γ</span> <span class="quoted">INTERP</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">D</span> <span class="skolem">E</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">N</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">::</span> wellorder<span class="main">)</span> clause set"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∉</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="skolem">N</span> <span class="main">⊨</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">⟹</span> <span class="main">¬</span> INTERP <span class="skolem">N</span> <span class="main">⊨</span> <span class="bound">C</span> <span class="main">⟹</span> <span class="skolem">D</span> <span class="main">≤</span> <span class="bound">C</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    c_in_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c_true<span class="main">:</span> <span class="quoted"><span class="quoted">"INTERP <span class="skolem">N</span> <span class="main">⊨</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"unord_resolve <span class="skolem">C</span> <span class="skolem">D</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    e_cex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="skolem">N</span> <span class="main">⊨</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    e_lt_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">&lt;</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unord_resolve_counterex_reducing <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> c_in_n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">{#</span><span class="skolem">C</span><span class="main">#}</span> <span class="main">⊆</span> <span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Infer <span class="main">{#</span><span class="skolem">C</span><span class="main">#}</span> <span class="skolem">D</span> <span class="skolem">E</span> <span class="main">∈</span> unord_Γ"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> unord_Γ_def <span class="keyword1"><span class="command">using</span></span> res_e <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">CC</span> <span class="bound">E</span><span class="main">.</span> set_mset <span class="bound">CC</span> <span class="main">⊆</span> <span class="skolem">N</span> <span class="main">∧</span> INTERP <span class="skolem">N</span> <span class="keyword1">⊨m</span> <span class="bound">CC</span> <span class="main">∧</span> Infer <span class="bound">CC</span> <span class="skolem">D</span> <span class="bound">E</span> <span class="main">∈</span> unord_Γ <span class="main">∧</span> <span class="main">¬</span> INTERP <span class="skolem">N</span> <span class="main">⊨</span> <span class="bound">E</span> <span class="main">∧</span> <span class="bound">E</span> <span class="main">&lt;</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_in_n c_true e_cex e_lt_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">CC</span> <span class="skolem">D</span> <span class="skolem">E</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> interp"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Infer <span class="skolem">CC</span> <span class="skolem">D</span> <span class="skolem">E</span> <span class="main">∈</span> unord_Γ"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="keyword1">⊨m</span> <span class="skolem">CC</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊨</span> <span class="skolem">D</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊨</span> <span class="skolem">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unord_Γ_def true_cls_mset_def<span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> unord_resolve_sound<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> clausal_logic_compact <span class="main">=</span> unord_Γ_sound_counterex_reducing.clausal_logic_compact

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Theorem 3.12, compactness of clausal logic, has finally been derived for a concrete inference
system:
›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> clausal_logic_compact <span class="main">=</span> ground_resolution_without_selection.clausal_logic_compact

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ordered_Ground_Resolution">
<div class="head">
<h1>Theory Ordered_Ground_Resolution</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Ground Ordered Resolution Calculus with Selection
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2016, 2017
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Ground Ordered Resolution Calculus with Selection›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ordered_Ground_Resolution
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Inference_System.html">Inference_System</a> <a href="Ground_Resolution_Model.html">Ground_Resolution_Model</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Ordered ground resolution with selection is the second inference system studied in Section~3
(``Standard Resolution'') of Bachmair and Ganzinger's chapter.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inference Rule›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Ordered ground resolution consists of a single rule, called <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ord_resolve›</span></span></span></span> below. Like
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>unord_resolve›</span></span></span></span>, the rule is sound and counterexample-reducing. In addition, it is reductive.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ground_resolution_with_selection
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following inductive definition corresponds to Figure 2.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">maximal_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> literal multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">maximal_wrt</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">DA</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">DA</span></span></span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> Max <span class="main">(</span>atms_of <span class="free"><span class="bound"><span class="entity">DA</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strictly_maximal_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> literal multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strictly_maximal_wrt</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">CA</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> atms_of <span class="free"><span class="bound"><span class="entity">CA</span></span></span><span class="main">.</span> <span class="bound">B</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">eligible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  eligible<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="free"><span class="bound"><span class="entity">DA</span></span></span> <span class="main">=</span> negs <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">S</span> <span class="free"><span class="bound"><span class="entity">DA</span></span></span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> maximal_wrt <span class="main">(</span><span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">DA</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">eligible</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="free"><span class="bound"><span class="entity">DA</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="free">DA</span> <span class="main">=</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span> <span class="main">∨</span> <span class="free">S</span> <span class="free">DA</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∧</span> length <span class="free">As</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> maximal_wrt <span class="main">(</span><span class="free">As</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="free">DA</span><span class="main">)</span> <span class="main">⟷</span>
    eligible <span class="free">As</span> <span class="free">DA</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eligible.intros ground_resolution_with_selection.eligible.cases ground_resolution_with_selection_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">ord_resolve</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause list <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> multiset list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  ord_resolve<span class="main">:</span>
    <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">CAs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
     length <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
     length <span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
     length <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
     <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">CAs</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span>
     eligible <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> strictly_maximal_wrt <span class="main">(</span><span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">CAs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">ord_resolve</span> <span class="free"><span class="bound"><span class="entity">CAs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cc_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> mset <span class="free">CAs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">DA</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> res_e
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ord_resolve.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ord_resolve <span class="skolem">n</span> <span class="skolem">Cs</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> DA <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> e <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas_len <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cs_len <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    as_len <span class="main">=</span> this<span class="main">(</span>6<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas <span class="main">=</span> this<span class="main">(</span>8<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> aas_ne <span class="main">=</span> this<span class="main">(</span>9<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> a_eq <span class="main">=</span> this<span class="main">(</span>10<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> set <span class="free">As</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I</span> <span class="main">⊨</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d_true DA <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      a_in_aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      a_false<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">As</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cas_len as_len <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I</span> <span class="main">⊨</span> poss <span class="main">(</span><span class="free">AAs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_false a_eq aas_ne a_in_aa <span class="keyword1"><span class="command">unfolding</span></span> true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">CAs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_in_aa cc_true <span class="keyword1"><span class="command">unfolding</span></span> true_cls_mset_def <span class="keyword1"><span class="command">using</span></span> cas_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="skolem">Cs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cas a_in_aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> a_in_aa cs_len <span class="keyword1"><span class="command">unfolding</span></span> e true_cls_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_Union_mset_iff nth_mem_mset union_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> filter_neg_atm_of_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>Neg <span class="main">(</span>atm_of <span class="bound">L</span><span class="main">)</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈#</span> <span class="free">S</span> <span class="free">C</span><span class="main">#}</span> <span class="main">=</span> <span class="free">S</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_selects_neg_lits<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This corresponds to Lemma 3.13:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_reductive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ord_resolve <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">&lt;</span> <span class="free">DA</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ord_resolve.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ord_resolve <span class="skolem">n</span> <span class="skolem">Cs</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> DA <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> e <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas_len <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cs_len <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    ai_len <span class="main">=</span> this<span class="main">(</span>6<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> nz <span class="main">=</span> this<span class="main">(</span>7<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas <span class="main">=</span> this<span class="main">(</span>8<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> maxim <span class="main">=</span> this<span class="main">(</span>12<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> nz ai_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> True e DA <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">max_A_of_Cs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">max_A_of_Cs</span> <span class="main">=</span> Max <span class="main">(</span>atms_of <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span>
      mc_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">max_A_of_Cs</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      mc_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">B</span> <span class="main">≤</span> <span class="skolem">max_A_of_Cs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> max_A_of_Cs_def False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C_max</span> <span class="main">∈</span> set <span class="skolem">Cs</span><span class="main">.</span> <span class="skolem">max_A_of_Cs</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="bound">C_max</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atm_imp_pos_or_neg_lit in_Union_mset_iff neg_lit_in_atms_of pos_lit_in_atms_of
          set_mset_mset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">max_i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      cm_in_cas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">max_i</span> <span class="main">&lt;</span> length <span class="free">CAs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      mc_in_cm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">max_A_of_Cs</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="skolem">Cs</span> <span class="main">!</span> <span class="skolem">max_i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">CAs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cas_len cs_len in_set_conv_nth<span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">CA_max</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CA_max</span> <span class="main">=</span> <span class="free">CAs</span> <span class="main">!</span> <span class="skolem">max_i</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A_max</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A_max</span> <span class="main">=</span> <span class="free">As</span> <span class="main">!</span> <span class="skolem">max_i</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C_max</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C_max</span> <span class="main">=</span> <span class="skolem">Cs</span> <span class="main">!</span> <span class="skolem">max_i</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> mc_lt_ma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">max_A_of_Cs</span> <span class="main">&lt;</span> <span class="skolem">A_max</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> maxim cm_in_cas mc_in_cm cas_len <span class="keyword1"><span class="command">unfolding</span></span> strictly_maximal_wrt_def A_max_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ucas_ne_neg_aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">≠</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mc_in mc_max mc_lt_ma cm_in_cas cas_len ai_len <span class="keyword1"><span class="command">unfolding</span></span> A_max_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atms_of_negs nth_mem set_mset_mset leD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> ucas_lt_ma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">B</span> <span class="main">&lt;</span> <span class="skolem">A_max</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mc_max mc_lt_ma <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Neg <span class="skolem">A_max</span> <span class="main">∈#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ucas_lt_ma neg_lit_in_atms_of<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A_max</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Neg <span class="skolem">A_max</span> <span class="main">∈#</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cm_in_cas cas_len ai_len A_max_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">&lt;</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> atms_less_eq_imp_lit_less_eq_neg count_greater_zero_iff
          count_inI le_imp_less_or_eq less_imp_not_less not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> e DA <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This corresponds to Theorem 3.15:
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ord_resolve_counterex_reducing<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ec_ni_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∉</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_in_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">DA</span> <span class="main">∈</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_cex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="free">DA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="bound">C</span> <span class="main">⟹</span> <span class="free">DA</span> <span class="main">≤</span> <span class="bound">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">CAs</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">E</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"set <span class="free">CAs</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span>
    <span class="quoted"><span class="quoted">"INTERP <span class="free">N</span> <span class="keyword1">⊨m</span> mset <span class="free">CAs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">CA</span><span class="main">.</span> <span class="bound">CA</span> <span class="main">∈</span> set <span class="free">CAs</span> <span class="main">⟹</span> productive <span class="free">N</span> <span class="bound">CA</span>"</span></span>
    <span class="quoted"><span class="quoted">"ord_resolve <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">E</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="free">E</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">&lt;</span> <span class="free">DA</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> d_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">DA</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d_in_n ec_ni_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">As</span><span class="main">.</span> <span class="bound">As</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> negs <span class="main">(</span>mset <span class="bound">As</span><span class="main">)</span> <span class="main">≤#</span> <span class="free">DA</span> <span class="main">∧</span> eligible <span class="bound">As</span> <span class="free">DA</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">DA</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> s_d_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">DA</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Max <span class="main">(</span>atms_of <span class="free">DA</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">As</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">A</span><span class="main">]</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="free">DA</span><span class="main">-</span><span class="main">{#</span>Neg <span class="skolem">A</span> <span class="main">#}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> na_in_d<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="skolem">A</span> <span class="main">∈#</span> <span class="free">DA</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">using</span></span> s_d_e d_ne d_in_n d_cex d_min
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_in_lits Max_lit_eq_pos_or_neg_Max_atm max_pos_imp_Interp Interp_imp_INTERP<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> das<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">DA</span> <span class="main">=</span> <span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> D_def As_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> na_in_d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span> <span class="main">⊆#</span> <span class="free">DA</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> As_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">As</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> Max <span class="main">(</span>atms_of <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A_def As_def das <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eligible <span class="skolem">As</span> <span class="free">DA</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eligible s_d_e As_def das maximal_wrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> As_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> s_d_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">DA</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">As</span> <span class="main">=</span> list_of_mset <span class="main">{#</span>atm_of <span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈#</span> <span class="free">S</span> <span class="free">DA</span><span class="main">#}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="free">DA</span> <span class="main">-</span> negs <span class="main">{#</span>atm_of <span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈#</span> <span class="free">S</span> <span class="free">DA</span><span class="main">#}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">As</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> As_def <span class="keyword1"><span class="command">using</span></span> s_d_e
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_is_empty_iff list_of_mset_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> da_sub_as<span class="main">:</span> <span class="quoted"><span class="quoted">"negs <span class="main">{#</span>atm_of <span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈#</span> <span class="free">S</span> <span class="free">DA</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">DA</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> S_selects_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_neg_atm_of_S<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span> <span class="main">⊆#</span> <span class="free">DA</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> As_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> das<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">DA</span> <span class="main">=</span> <span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> da_sub_as <span class="keyword1"><span class="command">unfolding</span></span> D_def As_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">DA</span> <span class="main">=</span> negs <span class="main">{#</span>atm_of <span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈#</span> <span class="free">S</span> <span class="free">DA</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_neg_atm_of_S<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">DA</span> <span class="main">=</span> negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> As_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eligible <span class="skolem">As</span> <span class="free">DA</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> das <span class="keyword1"><span class="command">using</span></span> eligible <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    as_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">As</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    negs_as_le_d<span class="main">:</span> <span class="quoted"><span class="quoted">"negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span> <span class="main">≤#</span> <span class="free">DA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s_d<span class="main">:</span> <span class="quoted"><span class="quoted">"eligible <span class="skolem">As</span> <span class="free">DA</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="free">DA</span> <span class="main">-</span> negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">As</span> <span class="main">⊆</span> INTERP <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d_cex negs_as_le_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> prod_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span><span class="main">.</span> <span class="main">∃</span><span class="bound">D</span><span class="main">.</span> produces <span class="free">N</span> <span class="bound">D</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> INTERP_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> INTERP_def subsetCE UN_E not_produces_imp_notin_production<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">D</span><span class="main">.</span> produces <span class="free">N</span> <span class="bound">D</span> <span class="bound">A</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ec_ni_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_in_N<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">D</span><span class="main">.</span> produces <span class="free">N</span> <span class="bound">D</span> <span class="bound">A</span> <span class="main">⟷</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">CA_of</span></span> <span class="keyword2"><span class="keyword">where</span></span> c_of0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> produces <span class="free">N</span> <span class="main">(</span><span class="skolem">CA_of</span> <span class="bound">A</span><span class="main">)</span> <span class="bound">A</span> <span class="main">⟷</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> prod_c0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span><span class="main">.</span> produces <span class="free">N</span> <span class="main">(</span><span class="skolem">CA_of</span> <span class="bound">A</span><span class="main">)</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C_of</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="skolem">C_of</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">L</span> <span class="main">∈#</span> <span class="skolem">CA_of</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">L</span> <span class="main">≠</span> Pos <span class="bound">A</span><span class="main">#}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Aj_of</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="skolem">Aj_of</span> <span class="bound">A</span> <span class="main">=</span> image_mset atm_of <span class="main">{#</span><span class="bound">L</span> <span class="main">∈#</span> <span class="skolem">CA_of</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">L</span> <span class="main">=</span> Pos <span class="bound">A</span><span class="main">#}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> pospos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">LL</span> <span class="bound">A</span><span class="main">.</span> <span class="main">{#</span>Pos <span class="main">(</span>atm_of <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">{#</span><span class="bound">L</span> <span class="main">∈#</span> <span class="bound">LL</span><span class="main">.</span> <span class="bound">L</span> <span class="main">=</span> Pos <span class="bound">A</span><span class="main">#}</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">L</span> <span class="main">∈#</span> <span class="bound">LL</span><span class="main">.</span> <span class="bound">L</span> <span class="main">=</span> Pos <span class="bound">A</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_filter_cong literal.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> multiset.map_ident<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ca_of_c_of_aj_of<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="skolem">CA_of</span> <span class="bound">A</span> <span class="main">=</span> <span class="skolem">C_of</span> <span class="bound">A</span> <span class="main">+</span> poss <span class="main">(</span><span class="skolem">Aj_of</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pospos<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">CA_of</span> <span class="main">_</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_of_def Aj_of_def<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">As</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> map <span class="skolem">C_of</span> <span class="skolem">As</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">AAs</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">AAs</span> <span class="main">=</span> map <span class="skolem">Aj_of</span> <span class="skolem">As</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">CAs</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal multiset list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">CAs</span> <span class="main">=</span> map <span class="skolem">CA_of</span> <span class="skolem">As</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> m_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span> <span class="main">⟹</span> <span class="skolem">Aj_of</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Aj_of_def <span class="keyword1"><span class="command">using</span></span> prod_c0 produces_imp_Pos_in_lits
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> filter_mset_empty_conv image_mset_is_empty_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> prod_c<span class="main">:</span> <span class="quoted"><span class="quoted">"productive <span class="free">N</span> <span class="skolem">CA</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> ca_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CA</span> <span class="main">∈</span> set <span class="skolem">CAs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">CA</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">CAs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CAs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">CA</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ca_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"production <span class="free">N</span> <span class="main">(</span><span class="skolem">CA_of</span> <span class="main">(</span><span class="skolem">As</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">As</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i_p CAs_def prod_c0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"productive <span class="free">N</span> <span class="skolem">CA</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i_p CAs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cs_subs_n<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">CAs</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> productive_in_N <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cs_true<span class="main">:</span> <span class="quoted"><span class="quoted">"INTERP <span class="free">N</span> <span class="keyword1">⊨m</span> mset <span class="skolem">CAs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> true_cls_mset_def <span class="keyword1"><span class="command">using</span></span> prod_c productive_imp_INTERP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span> <span class="main">⟹</span> <span class="main">¬</span> Neg <span class="bound">A</span> <span class="main">∈#</span> <span class="skolem">CA_of</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_c0 produces_imp_neg_notin_lits <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a_ni_c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span> <span class="main">⟹</span> <span class="bound">A</span> <span class="main">∉</span> atms_of <span class="main">(</span><span class="skolem">C_of</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> C_of_def <span class="keyword1"><span class="command">using</span></span> atm_imp_pos_or_neg_lit <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> c'_le_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="skolem">C_of</span> <span class="bound">A</span> <span class="main">≤</span> <span class="skolem">CA_of</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> C_of_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_eq_imp_le_multiset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a_max_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span> <span class="main">⟹</span> <span class="bound">A</span> <span class="main">=</span> Max <span class="main">(</span>atms_of <span class="main">(</span><span class="skolem">CA_of</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_c0 productive_imp_produces_Max_atom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span> <span class="main">⟹</span> <span class="skolem">C_of</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> Max <span class="main">(</span>atms_of <span class="main">(</span><span class="skolem">C_of</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c'_le_c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_Max_atms_of<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span> <span class="main">⟹</span> <span class="skolem">C_of</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> Max <span class="main">(</span>atms_of <span class="main">(</span><span class="skolem">C_of</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_ni_c' Max_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> atms_empty_iff_empty finite_atms_of<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> max_c'_lt_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span> <span class="main">⟹</span> <span class="skolem">C_of</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> Max <span class="main">(</span>atms_of <span class="main">(</span><span class="skolem">C_of</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order.strict_iff_order<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> le_cs_as<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">CAs</span> <span class="main">=</span> length <span class="skolem">As</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> CAs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">CAs</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_cs_as n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Cs</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cs_def n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">AAs</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AAs_def n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">As</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> as_ne n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">AAs</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span> <span class="main">∈#</span> <span class="skolem">AAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AAs_def Aj_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">B</span><span class="main">.</span> production <span class="free">N</span> <span class="main">(</span><span class="skolem">CA_of</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">B</span> <span class="main">∈#</span> <span class="skolem">CA_of</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">B</span> <span class="main">≠</span> Pos <span class="bound">x</span> <span class="main">⟹</span> atm_of <span class="bound">B</span> <span class="main">&lt;</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atm_of_lit_in_atms_of insert_not_empty le_imp_less_or_eq Pos_atm_of_iff
        Neg_atm_of_iff pos_neg_in_imp_true produces_imp_Pos_in_lits produces_imp_atms_leq
        productive_imp_not_interp<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>set <span class="skolem">As</span> <span class="main">⟹</span> <span class="bound">B</span> <span class="main">∈#</span> <span class="skolem">CA_of</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="bound">B</span> <span class="main">≠</span> Pos <span class="bound">A</span> <span class="main">⟹</span> atm_of <span class="bound">B</span> <span class="main">&lt;</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_c0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">AAs</span> <span class="main">⟶</span> <span class="skolem">AAs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> AAs_def <span class="keyword1"><span class="command">using</span></span> m_nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="skolem">CAs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">Cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="skolem">AAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> CAs_def Cs_def AAs_def <span class="keyword1"><span class="command">using</span></span> ca_of_c_of_aj_of <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="skolem">AAs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">AAs</span><span class="main">.</span> <span class="skolem">AAs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">{#}</span>›</span></span> calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="main">∈#</span> <span class="skolem">AAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">AAs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="main">∈#</span> <span class="skolem">AAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eligible <span class="skolem">As</span> <span class="free">DA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eligible <span class="skolem">As</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D_def negs_as_le_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">AAs</span> <span class="main">⟹</span> strictly_maximal_wrt <span class="main">(</span><span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">Cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_of_def Cs_def <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span> <span class="bound">B</span><span class="main">.</span> <span class="main">⟦</span>production <span class="free">N</span> <span class="main">(</span><span class="skolem">CA_of</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">;</span> <span class="bound">B</span> <span class="main">∈#</span> <span class="skolem">CA_of</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">B</span> <span class="main">≠</span> Pos <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> atm_of <span class="bound">B</span> <span class="main">&lt;</span> <span class="bound">x</span>›</span></span> atms_of_def calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> n_def prod_c0 strictly_maximal_wrt_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> strictly_maximal_wrt <span class="main">(</span><span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">AAs</span> <span class="main">⟹</span> strictly_maximal_wrt <span class="main">(</span><span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">CA</span> <span class="main">∈</span> set <span class="skolem">CAs</span><span class="main">.</span> <span class="free">S</span> <span class="bound">CA</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_c producesD productive_imp_produces_Max_literal <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">CA</span><span class="main">∈</span>set <span class="skolem">CAs</span><span class="main">.</span> <span class="free">S</span> <span class="bound">CA</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">CA</span><span class="main">∈</span>set <span class="skolem">CAs</span><span class="main">.</span> <span class="free">S</span> <span class="bound">CA</span> <span class="main">=</span> <span class="main">{#}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="skolem">CAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">CAs</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve <span class="skolem">CAs</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span><span class="main">)</span> <span class="skolem">AAs</span> <span class="skolem">As</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ord_resolve <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span> <span class="main">⟹</span> <span class="main">¬</span> interp <span class="free">N</span> <span class="main">(</span><span class="skolem">CA_of</span> <span class="bound">A</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">CA_of</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_c0 producesD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span> <span class="main">⟹</span> <span class="main">¬</span> Interp <span class="free">N</span> <span class="main">(</span><span class="skolem">CA_of</span> <span class="bound">A</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">C_of</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prod_c0 C_of_def Interp_def true_cls_def <span class="keyword1"><span class="command">using</span></span> true_lit_def not_gr_zero prod_c0
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c'_at_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="skolem">As</span> <span class="main">⟹</span> <span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="skolem">C_of</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_max_c c'_le_c max_c'_lt_a not_Interp_imp_not_INTERP <span class="keyword1"><span class="command">unfolding</span></span> true_cls_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> true_cls_def true_cls_empty<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Cs_def true_cls_def <span class="keyword1"><span class="command">using</span></span> c'_at_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d_cex <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> D_def add_diff_cancel_right' negs_as_le_d subset_mset.add_diff_assoc2
        true_cls_def union_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> e_cex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">CAs</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cs_subs_n<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"INTERP <span class="free">N</span> <span class="keyword1">⊨m</span> mset <span class="skolem">CAs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cs_true<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">CA</span><span class="main">.</span> <span class="bound">CA</span> <span class="main">∈</span> set <span class="skolem">CAs</span> <span class="main">⟹</span> productive <span class="free">N</span> <span class="bound">CA</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_c<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ord_resolve <span class="skolem">CAs</span> <span class="free">DA</span> <span class="skolem">AAs</span> <span class="skolem">As</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D_def negs_as_le_d res_e <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="free">N</span> <span class="main">⊨</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e_cex <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span> <span class="main">&lt;</span> <span class="free">DA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>4<span class="main">)</span> ord_resolve_reductive <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_atms_of_concl_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ord_resolve <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atms_of <span class="free">E</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> set <span class="free">CAs</span><span class="main">.</span> atms_of <span class="bound">C</span><span class="main">)</span> <span class="main">∪</span> atms_of <span class="free">DA</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ord_resolve.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ord_resolve <span class="skolem">n</span> <span class="skolem">Cs</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> DA <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> e <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas_len <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cs_len <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas <span class="main">=</span> this<span class="main">(</span>8<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> set_mset <span class="main">(</span><span class="skolem">Cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> set_mset <span class="main">(</span><span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cas <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="skolem">Cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free">CAs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cas cas_len mset_subset_eq_add_left nth_mem_mset sum_mset.remove union_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> set <span class="skolem">Cs</span><span class="main">.</span> <span class="bound">C</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free">CAs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cs_len in_set_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set_mset <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free">CAs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">meson</span> in_mset_sum_list2 mset_subset_eqD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atms_of <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> atms_of <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free">CAs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> lits_subseteq_imp_atms_subseteq mset_subset_eqD subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atms_of <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free">CAs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">CA</span> <span class="main">∈</span> set <span class="free">CAs</span><span class="main">.</span> atms_of <span class="bound">CA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> in_mset_sum_list2 atm_imp_pos_or_neg_lit neg_lit_in_atms_of pos_lit_in_atms_of<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> in_mset_sum_list atm_imp_pos_or_neg_lit neg_lit_in_atms_of pos_lit_in_atms_of<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atms_of <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">CA</span> <span class="main">∈</span> set <span class="free">CAs</span><span class="main">.</span> atms_of <span class="bound">CA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atms_of <span class="skolem">D</span> <span class="main">⊆</span> atms_of <span class="free">DA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> DA <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inference System›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Theorem 3.16 is subsumed in the counterexample-reducing inference system framework, which is
instantiated below. Unlike its unordered cousin, ordered resolution is additionally a reductive
inference system.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ord_Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> inference set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ord_Γ</span> <span class="main">=</span> <span class="main">{</span>Infer <span class="main">(</span>mset <span class="bound">CAs</span><span class="main">)</span> <span class="bound">DA</span> <span class="bound">E</span> <span class="main">|</span> <span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span> <span class="bound">E</span><span class="main">.</span> ord_resolve <span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span> <span class="bound">E</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ord_Γ_sound_counterex_reducing<span class="main">?</span><span class="main">:</span>
  sound_counterex_reducing_inference_system <span class="quoted"><span class="quoted">"ground_resolution_with_selection.ord_Γ <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"ground_resolution_with_selection.INTERP <span class="free">S</span>"</span></span> <span class="main">+</span>
  reductive_inference_system <span class="quoted"><span class="quoted">"ground_resolution_with_selection.ord_Γ <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">N</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">DA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∉</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">DA</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="skolem">N</span> <span class="main">⊨</span> <span class="skolem">DA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">⟹</span> <span class="main">¬</span> INTERP <span class="skolem">N</span> <span class="main">⊨</span> <span class="bound">C</span> <span class="main">⟹</span> <span class="skolem">DA</span> <span class="main">≤</span> <span class="bound">C</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">CAs</span></span> <span class="skolem"><span class="skolem">AAs</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    dd_sset_n<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">CAs</span> <span class="main">⊆</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    dd_true<span class="main">:</span> <span class="quoted"><span class="quoted">"INTERP <span class="skolem">N</span> <span class="keyword1">⊨m</span> mset <span class="skolem">CAs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve <span class="skolem">CAs</span> <span class="skolem">DA</span> <span class="skolem">AAs</span> <span class="skolem">As</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    e_cex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> INTERP <span class="skolem">N</span> <span class="main">⊨</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    e_lt_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">&lt;</span> <span class="skolem">DA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ord_resolve_counterex_reducing<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">N</span></span> <span class="quoted"><span class="skolem">DA</span></span> <span class="quoted"><span class="skolem">thesis</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Infer <span class="main">(</span>mset <span class="skolem">CAs</span><span class="main">)</span> <span class="skolem">DA</span> <span class="skolem">E</span> <span class="main">∈</span> ord_Γ"</span></span>
    <span class="keyword1"><span class="command">using</span></span> res_e <span class="keyword1"><span class="command">unfolding</span></span> ord_Γ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">CC</span> <span class="bound">E</span><span class="main">.</span> set_mset <span class="bound">CC</span> <span class="main">⊆</span> <span class="skolem">N</span> <span class="main">∧</span> INTERP <span class="skolem">N</span> <span class="keyword1">⊨m</span> <span class="bound">CC</span> <span class="main">∧</span> Infer <span class="bound">CC</span> <span class="skolem">DA</span> <span class="bound">E</span> <span class="main">∈</span> ord_Γ
    <span class="main">∧</span> <span class="main">¬</span> INTERP <span class="skolem">N</span> <span class="main">⊨</span> <span class="bound">E</span> <span class="main">∧</span> <span class="bound">E</span> <span class="main">&lt;</span> <span class="skolem">DA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dd_sset_n dd_true e_cex e_lt_c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_mset_mset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ord_Γ_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ord_resolve_sound ord_resolve_reductive<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> clausal_logic_compact <span class="main">=</span> ord_Γ_sound_counterex_reducing.clausal_logic_compact

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A second proof of Theorem 3.12, compactness of clausal logic:
›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> clausal_logic_compact <span class="main">=</span> ground_resolution_with_selection.clausal_logic_compact

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Proving_Process">
<div class="head">
<h1>Theory Proving_Process</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Theorem Proving Processes
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2017
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Theorem Proving Processes›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Proving_Process
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Unordered_Ground_Resolution.html">Unordered_Ground_Resolution</a> <a href="Lazy_List_Chain.html">Lazy_List_Chain</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This material corresponds to Section 4.1 (``Theorem Proving Processes'') of Bachmair and Ganzinger's
chapter.

The locale assumptions below capture conditions R1 to R3 of Definition 4.1.
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Rf›</span></span></span></span> denotes $\mathcal{R}_{\mathcal{F}}$; <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Ri›</span></span></span></span> denotes $\mathcal{R}_{\mathcal{I}}$.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> redundancy_criterion <span class="main">=</span> inference_system <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">Rf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">Ri</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> inference set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    Ri_subset_Γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ri</span> <span class="free">N</span> <span class="main">⊆</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Rf_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">⊆</span> <span class="free">N'</span> <span class="main">⟹</span> <span class="free">Rf</span> <span class="free">N</span> <span class="main">⊆</span> <span class="free">Rf</span> <span class="free">N'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Ri_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">⊆</span> <span class="free">N'</span> <span class="main">⟹</span> <span class="free">Ri</span> <span class="free">N</span> <span class="main">⊆</span> <span class="free">Ri</span> <span class="free">N'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Rf_indep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N'</span> <span class="main">⊆</span> <span class="free">Rf</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">Rf</span> <span class="free">N</span> <span class="main">⊆</span> <span class="free">Rf</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">N'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Ri_indep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N'</span> <span class="main">⊆</span> <span class="free">Rf</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">Ri</span> <span class="free">N</span> <span class="main">⊆</span> <span class="free">Ri</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">N'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Rf_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">Rf</span> <span class="free">N</span><span class="main">)</span> <span class="main">⟹</span> satisfiable <span class="free">N</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">saturated_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">saturated_upto</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⟷</span> inferences_from <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">-</span> <span class="free">Rf</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ri</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="quoted">"<span class="entity">derive</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> clause set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">▹</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  deduction_deletion<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⊆</span> concls_of <span class="main">(</span>inferences_from <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⊆</span> <span class="free">Rf</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derive_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">▹</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">N</span> <span class="main">⊆</span> <span class="free">M</span> <span class="main">∪</span> concls_of <span class="main">(</span>inferences_from <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Diff_subset_conv derive.cases<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> sat_preserving_redundancy_criterion <span class="main">=</span>
  sat_preserving_inference_system <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wellorder<span class="main">)</span> inference set"</span></span> <span class="main">+</span> redundancy_criterion
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> deriv_sat_preserving<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(▹)</span> <span class="free">Ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    sat_n0<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>lhd <span class="free">Ns</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> len_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="free">Ns</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deriv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">Ns</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">DD</span>
    <span class="keyword3"><span class="command">assume</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">DD</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sset_lun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">DD</span> <span class="main">⊆</span> Sup_llist <span class="free">Ns</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      dd_sset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">DD</span> <span class="main">⊆</span> Sup_upto_llist <span class="free">Ns</span> <span class="main">(</span>enat <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_Sup_llist_imp_Sup_upto_llist <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>Sup_upto_llist <span class="free">Ns</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> len_ns sat_n0
        <span class="keyword1"><span class="command">unfolding</span></span> Sup_upto_llist_def true_clss_def lhd_conv_lnth<span class="main">[</span><span class="operator">OF</span> chain_not_lnull<span class="main"><span class="main">[</span></span><span class="operator">OF</span> deriv<span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">≥</span> llength <span class="free">Ns</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup_upto_llist <span class="free">Ns</span> <span class="main">(</span>enat <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> Sup_upto_llist <span class="free">Ns</span> <span class="main">(</span>enat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Sup_upto_llist_def <span class="keyword1"><span class="command">using</span></span> le_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lnth <span class="free">Ns</span> <span class="skolem">k</span> <span class="main">▹</span> lnth <span class="free">Ns</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> deriv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chain_lnth_rel<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lnth <span class="free">Ns</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">⊆</span> lnth <span class="free">Ns</span> <span class="skolem">k</span> <span class="main">∪</span> concls_of <span class="main">(</span>inferences_from <span class="main">(</span>lnth <span class="free">Ns</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> derive_subset<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lnth <span class="free">Ns</span> <span class="skolem">k</span> <span class="main">⊆</span> Sup_upto_llist <span class="free">Ns</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Sup_upto_llist_def <span class="keyword1"><span class="command">using</span></span> False Suc_ile_eq linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lnth <span class="free">Ns</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
          <span class="main">⊆</span> Sup_upto_llist <span class="free">Ns</span> <span class="skolem">k</span> <span class="main">∪</span> concls_of <span class="main">(</span>inferences_from <span class="main">(</span>Sup_upto_llist <span class="free">Ns</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> UnCI UnE image_Un inferences_from_mono le_iff_sup<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup_upto_llist <span class="free">Ns</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> Sup_upto_llist <span class="free">Ns</span> <span class="skolem">k</span> <span class="main">∪</span> lnth <span class="free">Ns</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Sup_upto_llist_def <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> le_SucE<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>Sup_upto_llist <span class="free">Ns</span> <span class="skolem">k</span> <span class="main">∪</span> concls_of <span class="main">(</span>inferences_from <span class="main">(</span>Sup_upto_llist <span class="free">Ns</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc Γ_sat_preserving <span class="keyword1"><span class="command">unfolding</span></span> sat_preserving_inference_system_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_sup true_clss_union<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfiable <span class="skolem">DD</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dd_sset <span class="keyword1"><span class="command">unfolding</span></span> Sup_upto_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> true_clss_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_resolution_without_selection.clausal_logic_compact<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This corresponds to Lemma 4.2:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(▹)</span> <span class="free">Ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    Rf_Sup_subset_Rf_Liminf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Rf</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Ri_Sup_subset_Ri_Liminf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ri</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ri</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    sat_limit_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span> <span class="main">⟷</span> satisfiable <span class="main">(</span>lhd <span class="free">Ns</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span>
      c_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> lnth <span class="free">Ns</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      c_ni<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∉</span> <span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      j'<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">j</span> <span class="main">&lt;</span> llength <span class="free">Ns</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> c_ni <span class="keyword1"><span class="command">have</span></span> c_ni'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">Ns</span> <span class="main">⟹</span> <span class="skolem">C</span> <span class="main">∉</span> <span class="free">Rf</span> <span class="main">(</span>lnth <span class="free">Ns</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Rf_mono lnth_subset_Sup_llist Sup_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> contra_subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> lnth <span class="free">Ns</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j j'
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> c_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="skolem">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">k</span> <span class="main">&lt;</span> llength <span class="free">Ns</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> Suc_ile_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dual_order.strict_implies_order<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> c_in_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> lnth <span class="free">Ns</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"lnth <span class="free">Ns</span> <span class="skolem">k</span> <span class="main">▹</span> lnth <span class="free">Ns</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc.prems deriv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chain_lnth_rel<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> c_in_k c_ni' Suc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc c_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lu_ll<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_llist <span class="free">Ns</span> <span class="main">-</span> <span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span> <span class="main">⊆</span> Liminf_llist <span class="free">Ns</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Sup_llist_def Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> rf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span> <span class="main">-</span> <span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Rf</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lu_ll Rf_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ri<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ri</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span> <span class="main">-</span> <span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ri</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lu_ll Ri_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Rf</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rf Rf_indep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ri</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ri</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ri Ri_indep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span> <span class="main">⟷</span> satisfiable <span class="main">(</span>lhd <span class="free">Ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>lhd <span class="free">Ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> deriv deriv_sat_preserving <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> true_clss_mono<span class="main">[</span><span class="operator">OF</span> Liminf_llist_subset_Sup_llist<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>Sup_llist <span class="free">Ns</span> <span class="main">-</span> <span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> true_clss_mono<span class="main">[</span><span class="operator">OF</span> lu_ll<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Rf_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span>lhd <span class="free">Ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> deriv true_clss_mono lhd_subset_Sup_llist chain_not_lnull <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(▹)</span> <span class="free">Ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    Rf_limit_Sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Rf</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span> <span class="main">=</span> <span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Ri_limit_Sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ri</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ri</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Rf_Sup_subset_Rf_Liminf Rf_mono Ri_Sup_subset_Ri_Liminf Ri_mono
      Liminf_llist_subset_Sup_llist subset_antisym<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The assumption below corresponds to condition R4 of Definition 4.1.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> effective_redundancy_criterion <span class="main">=</span> redundancy_criterion <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Ri_effective<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">∈</span> <span class="free">Γ</span> <span class="main">⟹</span> concl_of <span class="free">γ</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">∪</span> <span class="free">Rf</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">γ</span> <span class="main">∈</span> <span class="free">Ri</span> <span class="free">N</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fair_clss_seq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set llist <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fair_clss_seq</span> <span class="free"><span class="bound"><span class="entity">Ns</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">N'</span> <span class="main">=</span> Liminf_llist <span class="free"><span class="bound"><span class="entity">Ns</span></span></span> <span class="main">-</span> <span class="free">Rf</span> <span class="main">(</span>Liminf_llist <span class="free"><span class="bound"><span class="entity">Ns</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
     concls_of <span class="main">(</span>inferences_from <span class="bound">N'</span> <span class="main">-</span> <span class="free">Ri</span> <span class="bound">N'</span><span class="main">)</span> <span class="main">⊆</span> Sup_llist <span class="free"><span class="bound"><span class="entity">Ns</span></span></span> <span class="main">∪</span> <span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free"><span class="bound"><span class="entity">Ns</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> sat_preserving_effective_redundancy_criterion <span class="main">=</span>
  sat_preserving_inference_system <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wellorder<span class="main">)</span> inference set"</span></span> <span class="main">+</span>
  effective_redundancy_criterion
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sat_preserving_redundancy_criterion
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The result below corresponds to Theorem 4.3.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> fair_derive_saturated_upto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(▹)</span> <span class="free">Ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair_clss_seq <span class="free">Ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"saturated_upto <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> saturated_upto_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">γ</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Liminf_llist <span class="free">Ns</span> <span class="main">-</span> <span class="free">Rf</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> inferences_from <span class="var">?N'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> <span class="free">Ri</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> <span class="free">Ri</span> <span class="var">?N'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Ri_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concls_of <span class="main">(</span>inferences_from <span class="var">?N'</span> <span class="main">-</span> <span class="free">Ri</span> <span class="var">?N'</span><span class="main">)</span> <span class="main">⊆</span> Sup_llist <span class="free">Ns</span> <span class="main">∪</span> <span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fair <span class="keyword1"><span class="command">unfolding</span></span> fair_clss_seq_def Let_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concl_of <span class="skolem">γ</span> <span class="main">∈</span> Sup_llist <span class="free">Ns</span> <span class="main">∪</span> <span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False γ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"concl_of <span class="skolem">γ</span> <span class="main">∈</span> Sup_llist <span class="free">Ns</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> <span class="free">Ri</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> γ Ri_effective inferences_from_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> <span class="free">Ri</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> deriv Ri_Sup_subset_Ri_Liminf <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"concl_of <span class="skolem">γ</span> <span class="main">∈</span> <span class="free">Rf</span> <span class="main">(</span>Sup_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concl_of <span class="skolem">γ</span> <span class="main">∈</span> <span class="free">Rf</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> deriv Rf_Sup_subset_Rf_Liminf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> <span class="free">Ri</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> γ Ri_effective inferences_from_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> <span class="free">Ri</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This corresponds to the trivial redundancy criterion defined on page 36 of
Section 4.1.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> trivial_redundancy_criterion <span class="main">=</span> inference_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Rf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Rf</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ri</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> inference set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ri</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">γ</span><span class="main">.</span> <span class="bound">γ</span> <span class="main">∈</span> <span class="free">Γ</span> <span class="main">∧</span> concl_of <span class="bound">γ</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> effective_redundancy_criterion <span class="quoted"><span class="free">Γ</span></span> <span class="quoted">Rf</span> <span class="quoted">Ri</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Rf_def Ri_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> saturated_upto_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"saturated_upto <span class="free">N</span> <span class="main">⟷</span> concls_of <span class="main">(</span>inferences_from <span class="free">N</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> saturated_upto_def inferences_from_def Rf_def Ri_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following lemmas corresponds to the standard extension of a redundancy criterion defined on
page 38 of Section 4.1.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> redundancy_criterion_standard_extension<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊆</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"redundancy_criterion <span class="free">Γ</span> <span class="free">Rf</span> <span class="free">Ri</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"redundancy_criterion <span class="free">Γ'</span> <span class="free">Rf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> <span class="free">Ri</span> <span class="bound">N</span> <span class="main">∪</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">-</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> redundancy_criterion_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_subsetD<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>5<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">sat</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> redundancy_criterion_standard_extension_saturated_upto_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊆</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"redundancy_criterion <span class="free">Γ</span> <span class="free">Rf</span> <span class="free">Ri</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"redundancy_criterion.saturated_upto <span class="free">Γ</span> <span class="free">Rf</span> <span class="free">Ri</span> <span class="free">M</span> <span class="main">⟷</span>
    redundancy_criterion.saturated_upto <span class="free">Γ'</span> <span class="free">Rf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> <span class="free">Ri</span> <span class="bound">N</span> <span class="main">∪</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">-</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms redundancy_criterion.saturated_upto_def redundancy_criterion.saturated_upto_def
    redundancy_criterion_standard_extension
  <span class="keyword1"><span class="command">unfolding</span></span> inference_system.inferences_from_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> redundancy_criterion_standard_extension_effective<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊆</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"effective_redundancy_criterion <span class="free">Γ</span> <span class="free">Rf</span> <span class="free">Ri</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"effective_redundancy_criterion <span class="free">Γ'</span> <span class="free">Rf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> <span class="free">Ri</span> <span class="bound">N</span> <span class="main">∪</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">-</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms redundancy_criterion_standard_extension<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> effective_redundancy_criterion_def effective_redundancy_criterion_axioms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> redundancy_criterion_standard_extension_fair_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊆</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"effective_redundancy_criterion <span class="free">Γ</span> <span class="free">Rf</span> <span class="free">Ri</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"effective_redundancy_criterion.fair_clss_seq <span class="free">Γ'</span> <span class="free">Rf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> <span class="free">Ri</span> <span class="bound">N</span> <span class="main">∪</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">-</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="free">Ns</span> <span class="main">⟷</span>
    effective_redundancy_criterion.fair_clss_seq <span class="free">Γ</span> <span class="free">Rf</span> <span class="free">Ri</span> <span class="free">Ns</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms redundancy_criterion_standard_extension_effective<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Γ'</span></span> <span class="quoted"><span class="free">Rf</span></span> <span class="quoted"><span class="free">Ri</span></span><span class="main">]</span>
    effective_redundancy_criterion.fair_clss_seq_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Rf</span></span> <span class="quoted"><span class="free">Ri</span></span> <span class="quoted"><span class="free">Ns</span></span><span class="main">]</span>
    effective_redundancy_criterion.fair_clss_seq_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ'</span></span> <span class="quoted"><span class="free">Rf</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> <span class="free">Ri</span> <span class="bound">N</span> <span class="main">∪</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">-</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">Ns</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> inference_system.inferences_from_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> redundancy_criterion_standard_extension_fair_derive_saturated_upto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    subs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊆</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    red<span class="main">:</span> <span class="quoted"><span class="quoted">"redundancy_criterion <span class="free">Γ</span> <span class="free">Rf</span> <span class="free">Ri</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    red'<span class="main">:</span> <span class="quoted"><span class="quoted">"sat_preserving_effective_redundancy_criterion <span class="free">Γ'</span> <span class="free">Rf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> <span class="free">Ri</span> <span class="bound">N</span> <span class="main">∪</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">-</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span>redundancy_criterion.derive <span class="free">Γ'</span> <span class="free">Rf</span><span class="main">)</span> <span class="free">Ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fair<span class="main">:</span> <span class="quoted"><span class="quoted">"effective_redundancy_criterion.fair_clss_seq <span class="free">Γ'</span> <span class="free">Rf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> <span class="free">Ri</span> <span class="bound">N</span> <span class="main">∪</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">-</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="free">Ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"redundancy_criterion.saturated_upto <span class="free">Γ</span> <span class="free">Rf</span> <span class="free">Ri</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"redundancy_criterion.saturated_upto <span class="free">Γ'</span> <span class="free">Rf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> <span class="free">Ri</span> <span class="bound">N</span> <span class="main">∪</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">-</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Liminf_llist <span class="free">Ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sat_preserving_effective_redundancy_criterion.fair_derive_saturated_upto
        <span class="main"><span class="main">[</span></span><span class="operator">OF</span> red' deriv fair<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> redundancy_criterion_standard_extension_saturated_upto_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> subs red<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Standard_Redundancy">
<div class="head">
<h1>Theory Standard_Redundancy</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Standard Redundancy Criterion
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2017
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Standard Redundancy Criterion›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Standard_Redundancy
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Proving_Process.html">Proving_Process</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This material is based on Section 4.2.2 (``The Standard Redundancy Criterion'') of Bachmair and
Ganzinger's chapter.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> standard_redundancy_criterion <span class="main">=</span>
  inference_system <span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wellorder<span class="main">)</span> inference set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">redundant_infer</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> inference <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">redundant_infer</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="main">⟷</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">DD</span><span class="main">.</span> set_mset <span class="bound">DD</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">DD</span> <span class="main">+</span> side_prems_of <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> concl_of <span class="free"><span class="bound"><span class="entity">γ</span></span></span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈#</span> <span class="bound">DD</span> <span class="main">⟶</span> <span class="bound">D</span> <span class="main">&lt;</span> main_prem_of <span class="free"><span class="bound"><span class="entity">γ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Rf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Rf</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">C</span><span class="main">.</span> <span class="main">∃</span><span class="bound">DD</span><span class="main">.</span> set_mset <span class="bound">DD</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">DD</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="bound">C</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈#</span> <span class="bound">DD</span> <span class="main">⟶</span> <span class="bound">D</span> <span class="main">&lt;</span> <span class="bound">C</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ri</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> inference set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ri</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">γ</span></span> <span class="main">∈</span> <span class="free">Γ</span><span class="main">.</span> redundant_infer <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="bound">γ</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tautology_Rf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> Rf <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">{#}</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="main">{#}</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">C</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈#</span> <span class="main">{#}</span> <span class="main">⟶</span> <span class="bound">D</span> <span class="main">&lt;</span> <span class="free">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> Rf <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Rf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tautology_redundant_infer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    pos<span class="main">:</span> <span class="quoted"><span class="quoted">"Pos <span class="free">A</span> <span class="main">∈#</span> concl_of <span class="free">ι</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neg<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free">A</span> <span class="main">∈#</span> concl_of <span class="free">ι</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"redundant_infer <span class="free">N</span> <span class="free">ι</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff empty_subsetI neg pos pos_neg_in_imp_true redundant_infer_def set_mset_empty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> contradiction_Rf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> Rf <span class="free">N</span> <span class="main">=</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="main">{#}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Rf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following results correspond to Lemma 4.5. The lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>wlog_non_Rf›</span></span></span></span> generalizes the core of
the argument.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Rf_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">⊆</span> <span class="free">N'</span> <span class="main">⟹</span> Rf <span class="free">N</span> <span class="main">⊆</span> Rf <span class="free">N'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Rf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wlog_non_Rf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">DD</span><span class="main">.</span> set_mset <span class="bound">DD</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">DD</span> <span class="main">+</span> <span class="free">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">E</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈#</span> <span class="bound">DD</span> <span class="main">⟶</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">DD</span><span class="main">.</span> set_mset <span class="bound">DD</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">DD</span> <span class="main">+</span> <span class="free">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">E</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈#</span> <span class="bound">DD</span> <span class="main">⟶</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ex <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">DD0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    dd0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">DD0</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">DD</span><span class="main">.</span> set_mset <span class="bound">DD</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">DD</span> <span class="main">+</span> <span class="free">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">E</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈#</span> <span class="bound">DD</span> <span class="main">⟶</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="free">D</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">DD</span><span class="main">.</span> set_mset <span class="bound">DD</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">DD</span> <span class="main">+</span> <span class="free">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">E</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈#</span> <span class="bound">DD</span> <span class="main">⟶</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="free">D</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">DD'</span><span class="main">.</span> set_mset <span class="bound">DD'</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">DD'</span> <span class="main">+</span> <span class="free">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">E</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈#</span> <span class="bound">DD'</span> <span class="main">⟶</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="free">D</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="bound">DD</span> <span class="main">≤</span> <span class="bound">DD'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_eq_minimal<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> wf_less_multiset dd0<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> not_le<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">DD</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    dd_subs_n<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">DD</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ddcc_imp_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="skolem">DD</span> <span class="main">+</span> <span class="free">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    dd_lt_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈#</span> <span class="skolem">DD</span> <span class="main">⟶</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">DD'</span><span class="main">.</span> set_mset <span class="bound">DD'</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">DD'</span> <span class="main">+</span> <span class="free">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">E</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈#</span> <span class="bound">DD'</span> <span class="main">⟶</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="free">D</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="skolem">DD</span> <span class="main">≤</span> <span class="bound">DD'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Da</span><span class="main">.</span> <span class="bound">Da</span> <span class="main">∈#</span> <span class="skolem">DD</span> <span class="main">⟶</span> <span class="bound">Da</span> <span class="main">∉</span> Rf <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Da</span>
    <span class="keyword3"><span class="command">assume</span></span>
      da_in_dd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Da</span> <span class="main">∈#</span> <span class="skolem">DD</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      da_rf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Da</span> <span class="main">∈</span> Rf <span class="free">N</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> da_rf <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">DD'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      dd'_subs_n<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">DD'</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      dd'_imp_da<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="skolem">DD'</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="skolem">Da</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      dd'_lt_da<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈#</span> <span class="skolem">DD'</span> <span class="main">⟶</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="skolem">Da</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Rf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">DDa</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">DDa</span> <span class="main">=</span> <span class="skolem">DD</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">Da</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">DD'</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">DDa</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> DDa_def <span class="keyword1"><span class="command">using</span></span> dd_subs_n dd'_subs_n
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> contra_subsetD in_diffD subsetI union_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="skolem">DDa</span> <span class="main">+</span> <span class="free">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">E</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dd'_imp_da ddcc_imp_e da_in_dd <span class="keyword1"><span class="command">unfolding</span></span> DDa_def true_cls_mset_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_remove1_mset_neq union_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈#</span> <span class="skolem">DDa</span> <span class="main">⟶</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dd_lt_d dd'_lt_da da_in_dd <span class="keyword1"><span class="command">unfolding</span></span> DDa_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_DiffM2 order.strict_trans union_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">DDa</span> <span class="main">&lt;</span> <span class="skolem">DD</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> DDa_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> da_in_dd dd'_lt_da mset_lt_single_right_iff single_subset_iff union_le_diff_plus<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> d_min <span class="keyword1"><span class="command">unfolding</span></span> less_eq_multiset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> dd_subs_n ddcc_imp_e dd_lt_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Rf_imp_ex_non_Rf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> Rf <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">CC</span><span class="main">.</span> set_mset <span class="bound">CC</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">C</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="bound">C'</span> <span class="main">∈#</span> <span class="bound">CC</span> <span class="main">⟶</span> <span class="bound">C'</span> <span class="main">&lt;</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Rf_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wlog_non_Rf<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Rf_subs_Rf_diff_Rf<span class="main">:</span> <span class="quoted"><span class="quoted">"Rf <span class="free">N</span> <span class="main">⊆</span> Rf <span class="main">(</span><span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span>
  <span class="keyword3"><span class="command">assume</span></span> c_rf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> Rf <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">CC</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    cc_subs<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">CC</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cc_imp_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="skolem">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cc_lt_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="bound">C'</span> <span class="main">∈#</span> <span class="skolem">CC</span> <span class="main">⟶</span> <span class="bound">C'</span> <span class="main">&lt;</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Rf_imp_ex_non_Rf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈#</span> <span class="skolem">CC</span> <span class="main">⟶</span> <span class="bound">D</span> <span class="main">∉</span> Rf <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cc_subs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cc_nr<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">DD</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈#</span> <span class="skolem">CC</span> <span class="main">⟹</span> set_mset <span class="bound">DD</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">DD</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="bound">C</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈#</span> <span class="bound">DD</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">D</span> <span class="main">&lt;</span> <span class="bound">C</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Rf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">CC</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cc_subs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">CC</span> <span class="main">⊆</span>
    <span class="free">N</span> <span class="main">-</span> <span class="main">{</span><span class="bound">C</span><span class="main">.</span> <span class="main">∃</span><span class="bound">DD</span><span class="main">.</span> set_mset <span class="bound">DD</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">DD</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="bound">C</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈#</span> <span class="bound">DD</span> <span class="main">⟶</span> <span class="bound">D</span> <span class="main">&lt;</span> <span class="bound">C</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cc_nr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> Rf <span class="main">(</span><span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cc_imp_c cc_lt_c <span class="keyword1"><span class="command">unfolding</span></span> Rf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Rf_eq_Rf_diff_Rf<span class="main">:</span> <span class="quoted"><span class="quoted">"Rf <span class="free">N</span> <span class="main">=</span> Rf <span class="main">(</span><span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_subset Rf_mono Rf_subs_Rf_diff_Rf subset_antisym<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following results correspond to Lemma 4.6.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Ri_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">⊆</span> <span class="free">N'</span> <span class="main">⟹</span> Ri <span class="free">N</span> <span class="main">⊆</span> Ri <span class="free">N'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Ri_def redundant_infer_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Ri_subs_Ri_diff_Rf<span class="main">:</span> <span class="quoted"><span class="quoted">"Ri <span class="free">N</span> <span class="main">⊆</span> Ri <span class="main">(</span><span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">γ</span>
  <span class="keyword3"><span class="command">assume</span></span> γ_ri<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> Ri <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">CC</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">=</span> Infer <span class="skolem">CC</span> <span class="skolem">D</span> <span class="skolem">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">γ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CC</span> <span class="main">=</span> side_prems_of <span class="skolem">γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> main_prem_of <span class="skolem">γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> concl_of <span class="skolem">γ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> γ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">DD</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"set_mset <span class="skolem">DD</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="skolem">DD</span> <span class="main">+</span> <span class="skolem">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈#</span> <span class="skolem">DD</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">&lt;</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> γ_ri <span class="keyword1"><span class="command">unfolding</span></span> Ri_def redundant_infer_def cc d e <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">DD'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"set_mset <span class="skolem">DD'</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="skolem">DD'</span> <span class="main">+</span> <span class="skolem">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈#</span> <span class="skolem">DD'</span> <span class="main">⟶</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wlog_non_Rf <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> Ri <span class="main">(</span><span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> γ_ri <span class="keyword1"><span class="command">unfolding</span></span> Ri_def redundant_infer_def d cc e <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Ri_eq_Ri_diff_Rf<span class="main">:</span> <span class="quoted"><span class="quoted">"Ri <span class="free">N</span> <span class="main">=</span> Ri <span class="main">(</span><span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_subset Ri_mono Ri_subs_Ri_diff_Rf subset_antisym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Ri_subset_Γ<span class="main">:</span> <span class="quoted"><span class="quoted">"Ri <span class="free">N</span> <span class="main">⊆</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Ri_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Rf_indep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N'</span> <span class="main">⊆</span> Rf <span class="free">N</span> <span class="main">⟹</span> Rf <span class="free">N</span> <span class="main">⊆</span> Rf <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">N'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_cancel Diff_eq_empty_iff Diff_mono Rf_eq_Rf_diff_Rf Rf_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Ri_indep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N'</span> <span class="main">⊆</span> Rf <span class="free">N</span> <span class="main">⟹</span> Ri <span class="free">N</span> <span class="main">⊆</span> Ri <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">N'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_mono Ri_eq_Ri_diff_Rf Ri_mono order_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Rf_model<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> Rf <span class="main">(</span><span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Rf_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> true_cls_mset_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> assms subset_eq true_clss_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> Rf <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Rf_subs_Rf_diff_Rf true_clss_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_Diff_cancel true_clss_union<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Rf_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfiable <span class="main">(</span><span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span><span class="main">)</span> <span class="main">⟹</span> satisfiable <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rf_model<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following corresponds to Theorem 4.7:
›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> redundancy_criterion <span class="quoted"><span class="free">Γ</span></span> <span class="quoted">Rf</span> <span class="quoted">Ri</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">rule</span> Ri_subset_Γ<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">elim</span> Rf_mono Ri_mono Rf_indep Ri_indep Rf_sat<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> standard_redundancy_criterion_reductive <span class="main">=</span>
  standard_redundancy_criterion <span class="main">+</span> reductive_inference_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following corresponds to Theorem 4.8:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Ri_effective<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    in_γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">∈</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    concl_of_in_n_un_rf_n<span class="main">:</span> <span class="quoted"><span class="quoted">"concl_of <span class="free">γ</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">∪</span> Rf <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">∈</span> Ri <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">CC</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">=</span> Infer <span class="skolem">CC</span> <span class="skolem">D</span> <span class="skolem">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">γ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CC</span> <span class="main">=</span> side_prems_of <span class="free">γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> main_prem_of <span class="free">γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> concl_of <span class="free">γ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> γ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> e_in_n_un_rf_n <span class="main">=</span> concl_of_in_n_un_rf_n<span class="main">[</span><span class="operator">folded</span> e<span class="main">]</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">&lt;</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Γ_reductive e d in_γ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"set_mset <span class="main">{#</span><span class="skolem">E</span><span class="main">#}</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="main">{#</span><span class="skolem">E</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈#</span> <span class="main">{#</span><span class="skolem">E</span><span class="main">#}</span> <span class="main">⟶</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"redundant_infer <span class="free">N</span> <span class="free">γ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> redundant_infer_def cc d e <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> Rf <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">DD</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      dd_sset<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">DD</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      dd_imp_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="skolem">DD</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      dd_lt_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="bound">C'</span> <span class="main">∈#</span> <span class="skolem">DD</span> <span class="main">⟶</span> <span class="bound">C'</span> <span class="main">&lt;</span> <span class="skolem">E</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Rf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> dd_lt_e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Da</span><span class="main">.</span> <span class="bound">Da</span> <span class="main">∈#</span> <span class="skolem">DD</span> <span class="main">⟶</span> <span class="bound">Da</span> <span class="main">&lt;</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d e in_γ Γ_reductive less_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"redundant_infer <span class="free">N</span> <span class="free">γ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> redundant_infer_def dd_sset dd_imp_e cc d e <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">∈</span> Ri <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_γ e_in_n_un_rf_n <span class="keyword1"><span class="command">unfolding</span></span> Ri_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> effective_redundancy_criterion <span class="quoted"><span class="free">Γ</span></span> <span class="quoted">Rf</span> <span class="quoted">Ri</span>
  <span class="keyword1"><span class="command">unfolding</span></span> effective_redundancy_criterion_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI redundancy_criterion_axioms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Ri_effective<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> contradiction_Rf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> Ri <span class="free">N</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Ri_def redundant_infer_def <span class="keyword1"><span class="command">using</span></span> Γ_reductive le_multiset_empty_right
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">{#}</span><span class="main">#}</span>"</span></span><span class="main"><span class="main">]</span></span> le_multiset_empty_left<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> standard_redundancy_criterion_counterex_reducing <span class="main">=</span>
  standard_redundancy_criterion <span class="main">+</span> counterex_reducing_inference_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following result corresponds to Theorem 4.9.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> saturated_upto_complete_if<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    satur<span class="main">:</span> <span class="quoted"><span class="quoted">"saturated_upto <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> ec_ni_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∉</span> <span class="free">N</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">-</span> Rf <span class="free">N</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ec_ni_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∉</span> <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">using</span></span> ec_ni_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I_of</span> <span class="skolem">M</span> <span class="keyword1">⊨s</span> <span class="skolem">M</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I_of</span> <span class="skolem">M</span> <span class="keyword1">⊨s</span> <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      d_in_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> <span class="skolem">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      d_cex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I_of</span> <span class="skolem">M</span> <span class="main">⊨</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      d_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈</span> <span class="skolem">M</span> <span class="main">⟹</span> <span class="bound">C</span> <span class="main">&lt;</span> <span class="skolem">D</span> <span class="main">⟹</span> <span class="free">I_of</span> <span class="skolem">M</span> <span class="main">⊨</span> <span class="bound">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_min_counterex <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="skolem"><span class="skolem">CC</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">=</span> Infer <span class="skolem">CC</span> <span class="skolem">D</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cc_subs_m<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">CC</span> <span class="main">⊆</span> <span class="skolem">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cc_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I_of</span> <span class="skolem">M</span> <span class="keyword1">⊨m</span> <span class="skolem">CC</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      γ_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      e_cex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I_of</span> <span class="skolem">M</span> <span class="main">⊨</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      e_lt_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">&lt;</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Γ_counterex_reducing<span class="main">[</span><span class="operator">OF</span> ec_ni_m<span class="main">]</span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> cc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CC</span> <span class="main">=</span> side_prems_of <span class="skolem">γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> main_prem_of <span class="skolem">γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> concl_of <span class="skolem">γ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> γ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> Ri <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> satur<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> saturated_upto_def inferences_from_def infer_from_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_in d_in_m cc_subs_m cc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> d<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> M_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> Ri <span class="skolem">M</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">using</span></span> Ri_indep <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">DD</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      dd_subs_m<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">DD</span> <span class="main">⊆</span> <span class="skolem">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      dd_cc_imp_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="skolem">DD</span> <span class="main">+</span> <span class="skolem">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      dd_lt_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈#</span> <span class="skolem">DD</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">&lt;</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Ri_def redundant_infer_def cc d e <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> dd_subs_m dd_lt_d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I_of</span> <span class="skolem">M</span> <span class="keyword1">⊨m</span> <span class="skolem">DD</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d_min <span class="keyword1"><span class="command">unfolding</span></span> true_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> contra_subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I_of</span> <span class="skolem">M</span> <span class="main">⊨</span> <span class="skolem">E</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dd_cc_imp_d cc_true <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> e_cex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I_of</span> <span class="skolem">M</span> <span class="keyword1">⊨s</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M_def Rf_model <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> unsat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> saturated_upto_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"saturated_upto <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="free">N</span> <span class="main">⟷</span> <span class="main">{#}</span> <span class="main">∈</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms saturated_upto_complete_if true_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FO_Ordered_Resolution">
<div class="head">
<h1>Theory FO_Ordered_Resolution</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       First-Order Ordered Resolution Calculus with Selection
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2016, 2017
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Author:      Sophie Tourret &lt;stourret at mpi-inf.mpg.de&gt;, 2020
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹First-Order Ordered Resolution Calculus with Selection›</span></span>

<span class="keyword1"><span class="command">theory</span></span> FO_Ordered_Resolution
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Abstract_Substitution.html">Abstract_Substitution</a> <a href="Ordered_Ground_Resolution.html">Ordered_Ground_Resolution</a> <a href="Standard_Redundancy.html">Standard_Redundancy</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This material is based on Section 4.3 (``A Simple Resolution Prover for First-Order Clauses'') of
Bachmair and Ganzinger's chapter. Specifically, it formalizes the ordered resolution calculus for
first-order standard clauses presented in Figure 4 and its related lemmas and theorems, including
soundness and Lemma 4.12 (the lifting lemma).

The following corresponds to pages 41--42 of Section 4.3, until Figure 5 and its explanation.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> FO_resolution <span class="main">=</span> mgu <span class="quoted"><span class="free">subst_atm</span></span> <span class="quoted"><span class="free">id_subst</span></span> <span class="quoted"><span class="free">comp_subst</span></span> <span class="quoted"><span class="free">atm_of_atms</span></span> <span class="quoted"><span class="free">renamings_apart</span></span> <span class="quoted"><span class="free">mgu</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">subst_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">id_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">comp_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">renamings_apart</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal multiset list <span class="main">⇒</span> <span class="tfree">'s</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">atm_of_atms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">mgu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'s</span> option"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">less_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    less_atm_stable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">less_atm</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">less_atm</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    less_atm_ground<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="free">A</span> <span class="main">⟹</span> is_ground_atm <span class="free">B</span> <span class="main">⟹</span> <span class="free">less_atm</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">&lt;</span> <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Library›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Bex_cartesian_product<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">xy</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xy</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> eql_map_neg_lit_eql_atm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span>map Neg <span class="free">As'</span><span class="main">)</span> <span class="main">=</span> map Neg <span class="free">As</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span> <span class="main">=</span> <span class="free">As</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">As'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">As</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> instance_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span> <span class="main">=</span> <span class="free">SDA'</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">As'</span><span class="main">.</span> negs <span class="main">(</span>mset <span class="bound">As'</span><span class="main">)</span> <span class="main">=</span> <span class="free">SDA'</span> <span class="main">∧</span> <span class="bound">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span> <span class="main">=</span> <span class="free">As</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> negL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">L</span> <span class="main">∈#</span> <span class="free">SDA'</span><span class="main">.</span> is_neg <span class="bound">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Melem_subst_cls subst_lit_in_negs_is_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="free">η</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈#</span> <span class="free">SDA'</span><span class="main">#}</span> <span class="main">=</span> mset <span class="main">(</span>map Neg <span class="free">As</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">NAs'</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="free">η</span><span class="main">)</span> <span class="bound">NAs'</span> <span class="main">=</span> map Neg <span class="free">As</span> <span class="main">∧</span> mset <span class="bound">NAs'</span> <span class="main">=</span> <span class="free">SDA'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> image_mset_of_subset_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="free">η</span>"</span></span> <span class="quoted"><span class="free">SDA'</span></span> <span class="quoted"><span class="quoted">"map Neg <span class="free">As</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">As'</span></span> <span class="keyword2"><span class="keyword">where</span></span> As'_p<span class="main">:</span>
    <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span>map Neg <span class="skolem">As'</span><span class="main">)</span> <span class="main">=</span> map Neg <span class="free">As</span> <span class="main">∧</span> mset <span class="main">(</span>map Neg <span class="skolem">As'</span><span class="main">)</span> <span class="main">=</span> <span class="free">SDA'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Neg_atm_of_iff negL ex_map_conv set_mset_mset<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negs <span class="main">(</span>mset <span class="skolem">As'</span><span class="main">)</span> <span class="main">=</span> <span class="free">SDA'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> As'_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span>map Neg <span class="skolem">As'</span><span class="main">)</span> <span class="main">=</span> map Neg <span class="free">As</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> As'_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span> <span class="main">=</span> <span class="free">As</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eql_map_neg_lit_eql_atm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map2_add_mset_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">AAs'</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">As'</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map2 add_mset <span class="main">(</span><span class="free">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span><span class="free">AAs'</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span> <span class="main">=</span> map2 add_mset <span class="free">As'</span> <span class="free">AAs'</span> <span class="keyword1">⋅aml</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">AAs'</span></span> <span class="quoted"><span class="free">As'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map2 add_mset <span class="main">(</span>tl <span class="main">(</span><span class="skolem">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span><span class="skolem">AAs'</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map2 add_mset <span class="main">(</span>tl <span class="skolem">As'</span><span class="main">)</span> <span class="main">(</span>tl <span class="skolem">AAs'</span><span class="main">)</span> <span class="keyword1">⋅aml</span> <span class="free">η</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> Succ<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">AAs'</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>tl <span class="main">(</span><span class="skolem">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>tl <span class="main">(</span><span class="skolem">AAs'</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map2 add_mset <span class="main">(</span>tl <span class="main">(</span><span class="skolem">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span><span class="skolem">AAs'</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>map2 add_mset <span class="main">(</span>tl <span class="skolem">As'</span><span class="main">)</span> <span class="main">(</span>tl <span class="skolem">AAs'</span><span class="main">)</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> tl <span class="main">(</span>map2 add_mset <span class="main">(</span> <span class="main">(</span><span class="skolem">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">AAs'</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span>
    tl <span class="main">(</span>map2 add_mset <span class="main">(</span><span class="skolem">As'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AAs'</span><span class="main">)</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> Succ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map2_tl map_tl subst_atm_mset_list_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subst_atm_list_tl<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> nn<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map2 add_mset <span class="main">(</span><span class="main">(</span><span class="skolem">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">AAs'</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>map2 add_mset <span class="main">(</span><span class="skolem">As'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AAs'</span><span class="main">)</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Succ Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span>
    map2 add_mset <span class="main">(</span><span class="skolem">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AAs'</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>map2 add_mset <span class="skolem">As'</span> <span class="skolem">AAs'</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_atm_mset_list_def gr0_conv_Suc subst_atm_mset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="main">(</span>hd <span class="skolem">As'</span> <span class="keyword1">⋅a</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span>hd <span class="skolem">AAs'</span> <span class="keyword1">⋅am</span> <span class="free">η</span><span class="main">)</span> <span class="main">=</span> add_mset <span class="main">(</span>hd <span class="skolem">As'</span><span class="main">)</span> <span class="main">(</span>hd <span class="skolem">AAs'</span><span class="main">)</span> <span class="keyword1">⋅am</span> <span class="free">η</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map2 add_mset <span class="main">(</span><span class="skolem">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AAs'</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span>  <span class="main">=</span> <span class="main">(</span>map2 add_mset <span class="main">(</span><span class="skolem">As'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AAs'</span><span class="main">)</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Succ<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subst_atm_mset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span>map2 add_mset <span class="main">(</span><span class="skolem">As'</span> <span class="keyword1">⋅al</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AAs'</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span>
    <span class="main">(</span>map2 add_mset <span class="main">(</span><span class="skolem">As'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AAs'</span><span class="main">)</span> <span class="keyword1">⋅aml</span> <span class="free">η</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nn list_eq_iff_nth_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Calculus›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following corresponds to Figure 4.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">maximal_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> literal multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">maximal_wrt</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> atms_of <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="main">¬</span> <span class="free">less_atm</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">B</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strictly_maximal_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> literal multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strictly_maximal_wrt</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> atms_of <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> <span class="bound">B</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">less_atm</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">B</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_maximal_wrt_maximal_wrt<span class="main">:</span> <span class="quoted"><span class="quoted">"strictly_maximal_wrt <span class="free">A</span> <span class="free">C</span> <span class="main">⟹</span> maximal_wrt <span class="free">A</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> maximal_wrt_def strictly_maximal_wrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> maximal_wrt_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"maximal_wrt <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟹</span> maximal_wrt <span class="free">A</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> maximal_wrt_def <span class="keyword1"><span class="command">using</span></span> in_atms_of_subst less_atm_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_maximal_wrt_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strictly_maximal_wrt <span class="main">(</span><span class="free">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟹</span> strictly_maximal_wrt <span class="free">A</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strictly_maximal_wrt_def <span class="keyword1"><span class="command">using</span></span> in_atms_of_subst less_atm_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">eligible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  eligible<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free"><span class="bound"><span class="entity">DA</span></span></span> <span class="main">=</span> negs <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="free">S</span> <span class="free"><span class="bound"><span class="entity">DA</span></span></span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> maximal_wrt <span class="main">(</span><span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">!</span> <span class="main">0</span> <span class="keyword1">⋅a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">DA</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">eligible</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="free"><span class="bound"><span class="entity">DA</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">ord_resolve</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause list <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> multiset list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  ord_resolve<span class="main">:</span>
    <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">CAs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
     length <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
     length <span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
     length <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
     <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">CAs</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">⟹</span>
     Some <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="free">mgu</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="free"><span class="bound"><span class="entity">AAs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
     eligible <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> strictly_maximal_wrt <span class="main">(</span><span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">CAs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">ord_resolve</span> <span class="free"><span class="bound"><span class="entity">CAs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">ord_resolve_rename</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause list <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> multiset list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> clause <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  ord_resolve_rename<span class="main">:</span>
    <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">CAs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
     length <span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
     length <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> poss <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">CAs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span>
     negs <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">DA</span></span></span> <span class="main">⟹</span>
     <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> hd <span class="main">(</span><span class="free">renamings_apart</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">DA</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">CAs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free"><span class="bound"><span class="entity">ρs</span></span></span> <span class="main">=</span> tl <span class="main">(</span><span class="free">renamings_apart</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">DA</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">CAs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
     ord_resolve <span class="main">(</span><span class="free"><span class="bound"><span class="entity">CAs</span></span></span> <span class="keyword1">⋅⋅cl</span> <span class="free"><span class="bound"><span class="entity">ρs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">DA</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="keyword1">⋅⋅aml</span> <span class="free"><span class="bound"><span class="entity">ρs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="keyword1">⋅al</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">⟹</span>
     <span class="free">ord_resolve_rename</span> <span class="free"><span class="bound"><span class="entity">CAs</span></span></span> <span class="free"><span class="bound"><span class="entity">DA</span></span></span> <span class="free"><span class="bound"><span class="entity">AAs</span></span></span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_empty_main_prem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ord_resolve <span class="free">Cs</span> <span class="main">{#}</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ord_resolve.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_rename_empty_main_prem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ord_resolve_rename <span class="free">Cs</span> <span class="main">{#}</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ord_resolve_empty_main_prem ord_resolve_rename.simps<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Soundness is not discussed in the chapter, but it is an important property.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_ground_inst_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cc_inst_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> mset <span class="free">CAs</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span> <span class="keyword1">⋅cm</span> <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_inst_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">DA</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ground_subst_η<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">η</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">E</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> res_e
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ord_resolve.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ord_resolve <span class="skolem">n</span> <span class="skolem">Cs</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> da <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> e <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas_len <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cs_len <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    aas_len <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> as_len <span class="main">=</span> this<span class="main">(</span>6<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas <span class="main">=</span> this<span class="main">(</span>8<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> mgu <span class="main">=</span> this<span class="main">(</span>10<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    len <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">CAs</span> <span class="main">=</span> length <span class="free">As</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as_len cas_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="main">(</span><span class="free">σ</span> <span class="main">⊙</span> <span class="free">η</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_subst_η <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_ground_comp_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cc_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> mset <span class="free">CAs</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span> <span class="keyword1">⋅cm</span> <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">DA</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cc_inst_true d_inst_true <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> mgu <span class="keyword1"><span class="command">have</span></span> unif<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span><span class="main">∈#</span><span class="free">AAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">As</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅a</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mgu_unifier as_len aas_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">E</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> set <span class="free">As</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="keyword1">⋅a</span> <span class="free">η</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I</span> <span class="main">⊨</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> true_cls_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="skolem">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d_true da <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_in_aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">CAs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a_false<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">As</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="keyword1">⋅a</span> <span class="free">η</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> da len <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≡</span> <span class="skolem">Cs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">BB</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">BB</span> <span class="main">≡</span> <span class="free">AAs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> c_cf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free">CAs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">using</span></span> a_in_aa cas cas_len
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_subset_eq_Union_mset mset_subset_eq_add_left subset_mset.order.trans<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> c_in_cc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">+</span> poss <span class="skolem">BB</span> <span class="main">∈#</span> mset <span class="free">CAs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C_def BB_def a_in_aa cas_len in_set_conv_nth cas <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈#</span> <span class="skolem">BB</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="keyword1">⋅a</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="free">As</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">⋅a</span> <span class="free">σ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> unif a_in_aa cas_len <span class="keyword1"><span class="command">unfolding</span></span> BB_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I</span> <span class="main">⊨</span> poss <span class="skolem">BB</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_false <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> true_cls_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">+</span> poss <span class="skolem">BB</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c_in_cc cc_true true_cls_mset_true_cls<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">CAs</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span> <span class="keyword1">⋅cm</span> <span class="free">η</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="skolem">C</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> e subst_cls_union <span class="keyword1"><span class="command">using</span></span> c_cf' C_def a_in_aa cas_len cs_len
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mset_subset_eq_add_left nth_mem_mset set_mset_mono sum_mset.remove true_cls_mono subst_cls_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The previous lemma is not only used to prove soundness, but also the following lemma which is
used to prove Lemma 4.10.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_rename_ground_inst_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"ord_resolve_rename <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ρs</span> <span class="main">=</span> tl <span class="main">(</span><span class="free">renamings_apart</span> <span class="main">(</span><span class="free">DA</span> <span class="main">#</span> <span class="free">CAs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">=</span> hd <span class="main">(</span><span class="free">renamings_apart</span> <span class="main">(</span><span class="free">DA</span> <span class="main">#</span> <span class="free">CAs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> <span class="main">(</span>mset <span class="main">(</span><span class="free">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">ρs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span> <span class="keyword1">⋅cm</span> <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">DA</span> <span class="main">⋅</span> <span class="free">ρ</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">η</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">E</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ord_resolve_rename.cases<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ord_resolve_ground_inst_sound<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Here follows the soundness theorem for the resolution rule.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ord_resolve_sound<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span>
   res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   cc_d_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="main">(</span>mset <span class="free">CAs</span> <span class="main">+</span> <span class="main">{#</span><span class="free">DA</span><span class="main">#}</span><span class="main">)</span> <span class="keyword1">⋅cm</span> <span class="bound">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   ground_subst_η<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">η</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">E</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> res_e <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> ord_resolve.cases›</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ord_resolve <span class="skolem">n</span> <span class="skolem">Cs</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> da <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> e <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas_len <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cs_len <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> aas_len <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> as_len <span class="main">=</span> this<span class="main">(</span>6<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas <span class="main">=</span> this<span class="main">(</span>8<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> mgu <span class="main">=</span> this<span class="main">(</span>10<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ground_subst_σ_η<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="main">(</span><span class="free">σ</span> <span class="main">⊙</span> <span class="free">η</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_subst_η <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_ground_comp_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cas_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> mset <span class="free">CAs</span> <span class="keyword1">⋅cm</span> <span class="free">σ</span> <span class="keyword1">⋅cm</span> <span class="free">η</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cc_d_true ground_subst_σ_η <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> da_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">DA</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cc_d_true ground_subst_σ_η <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">E</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ord_resolve_ground_inst_sound<span class="main">[</span><span class="operator">OF</span> res_e cas_true da_true<span class="main">]</span> ground_subst_η <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⋅</span> <span class="bound">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">η</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⋅</span> <span class="free">ρ</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms is_ground_comp_subst subst_cls_comp_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_sound_scl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">P</span> <span class="main">=</span> length <span class="free">CAs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    true_cas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨m</span> mset <span class="free">CAs</span> <span class="keyword1">⋅cm</span> <span class="bound">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ground_subst_η<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">η</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨m</span> mset <span class="main">(</span><span class="free">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">⋅cm</span> <span class="free">η</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> true_cas <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">CA</span><span class="main">.</span> <span class="bound">CA</span><span class="main">∈#</span> mset <span class="free">CAs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊨</span> <span class="bound">CA</span> <span class="main">⋅</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> true_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">CAs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">I</span> <span class="main">⊨</span> <span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> true_cp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">CAs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span> <span class="main">⟶</span> <span class="free">I</span> <span class="main">⊨</span> <span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="free">P</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="bound">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_sound len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">CA</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CA</span> <span class="main">∈#</span> mset <span class="main">(</span><span class="free">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      i_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CA</span> <span class="main">=</span> <span class="main">(</span><span class="free">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="free">P</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_mset_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span> <span class="main">⟶</span> <span class="free">I</span> <span class="main">⊨</span> <span class="skolem">CA</span> <span class="main">⋅</span> <span class="bound">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> true_cp <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_lists_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> true_cls_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Here follows the soundness theorem for the resolution rule with renaming.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_rename_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve_rename <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cc_d_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="main">(</span><span class="main">(</span>mset <span class="free">CAs</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="free">DA</span><span class="main">#}</span><span class="main">)</span> <span class="keyword1">⋅cm</span> <span class="bound">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ground_subst_η<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">η</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">E</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> res_e
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ord_resolve_rename.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ord_resolve_rename <span class="skolem">n</span> <span class="skolem">ρ</span> <span class="skolem">ρs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ρs <span class="main">=</span> this<span class="main">(</span>7<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> res <span class="main">=</span> this<span class="main">(</span>8<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ρs</span> <span class="main">=</span> length <span class="free">CAs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ρs renamings_apart_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨m</span> <span class="main">(</span>mset <span class="main">(</span><span class="free">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="free">DA</span> <span class="main">⋅</span> <span class="skolem">ρ</span><span class="main">#}</span><span class="main">)</span> <span class="keyword1">⋅cm</span> <span class="bound">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_sound_scl<span class="main">[</span><span class="operator">OF</span> len<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> subst_sound cc_d_true <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊨</span> <span class="free">E</span> <span class="main">⋅</span> <span class="free">η</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_subst_η ord_resolve_sound<span class="main">[</span><span class="operator">OF</span> res<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Other Basic Properties›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"ord_resolve <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"ord_resolve <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ'</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="free">σ'</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="free">E'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ord_resolve.cases<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> ord_resolve.cases<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ord_resolve_ord_resolve <span class="skolem">CAs</span> <span class="skolem">n</span> <span class="skolem">Cs</span> <span class="skolem">AAs</span> <span class="skolem">As</span> <span class="skolem">σ''</span> <span class="skolem">DA</span> <span class="skolem">CAs'</span> <span class="skolem">n'</span> <span class="skolem">Cs'</span> <span class="skolem">AAs'</span> <span class="skolem">As'</span> <span class="skolem">σ'''</span> <span class="skolem">DA'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> this<span class="main">(</span>1-17<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> res' <span class="main">=</span> this<span class="main">(</span>18-34<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="free">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> res<span class="main">(</span>3-5<span class="main">,</span>14<span class="main">)</span> res'<span class="main">(</span>3-5<span class="main">,</span>14<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.inject<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> <span class="skolem">Cs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> res<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>7<span class="main">,</span>8<span class="main">,</span>12<span class="main">)</span> res'<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>7<span class="main">,</span>8<span class="main">,</span>12<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_right_imp_eq nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">DA</span> <span class="main">=</span> <span class="skolem">DA'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> res<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> res'<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> <span class="free">E'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> res<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> res'<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_rename_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"ord_resolve_rename <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"ord_resolve_rename <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ'</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="free">σ'</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="free">E'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ord_resolve_rename.simps <span class="keyword1"><span class="command">using</span></span> ord_resolve_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_max_side_prems<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span> <span class="main">⟹</span> length <span class="free">CAs</span> <span class="main">≤</span> size <span class="free">DA</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ord_resolve.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_rename_max_side_prems<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ord_resolve_rename <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span> <span class="main">⟹</span> length <span class="free">CAs</span> <span class="main">≤</span> size <span class="free">DA</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> ord_resolve_rename.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> ord_resolve_max_side_prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> renamings_apart_length<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inference System›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ord_FO_Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> inference set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ord_FO_Γ</span> <span class="main">=</span> <span class="main">{</span>Infer <span class="main">(</span>mset <span class="bound">CAs</span><span class="main">)</span> <span class="bound">DA</span> <span class="bound">E</span> <span class="main">|</span> <span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span> <span class="bound">σ</span> <span class="bound">E</span><span class="main">.</span> ord_resolve_rename <span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span> <span class="bound">σ</span> <span class="bound">E</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> ord_FO_resolution<span class="main">:</span> inference_system <span class="quoted">ord_FO_Γ</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_ord_FO_resolution_inferences_between<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin_cc<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">CC</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>ord_FO_resolution.inferences_between <span class="free">CC</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?CCC</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">all_AA</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">all_AA</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">D</span> <span class="main">∈</span> <span class="var">?CCC</span><span class="main">.</span> atms_of <span class="bound">D</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">max_ary</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">max_ary</span> <span class="main">=</span> Max <span class="main">(</span>size <span class="main">`</span> <span class="var">?CCC</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">CAS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CAS</span> <span class="main">=</span> <span class="main">{</span><span class="bound">CAs</span><span class="main">.</span> <span class="bound">CAs</span> <span class="main">∈</span> lists <span class="var">?CCC</span> <span class="main">∧</span> length <span class="bound">CAs</span> <span class="main">≤</span> <span class="skolem">max_ary</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">AS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AS</span> <span class="main">=</span> <span class="main">{</span><span class="bound">As</span><span class="main">.</span> <span class="bound">As</span> <span class="main">∈</span> lists <span class="skolem">all_AA</span> <span class="main">∧</span> length <span class="bound">As</span> <span class="main">≤</span> <span class="skolem">max_ary</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">AAS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AAS</span> <span class="main">=</span> <span class="main">{</span><span class="bound">AAs</span><span class="main">.</span> <span class="bound">AAs</span> <span class="main">∈</span> lists <span class="main">(</span>mset <span class="main">`</span> <span class="skolem">AS</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">AAs</span> <span class="main">≤</span> <span class="skolem">max_ary</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> all_AA_def max_ary_def CAS_def AS_def AAS_def

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?infer_of</span></span></span> <span class="main">=</span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span><span class="main">.</span> Infer <span class="main">(</span>mset <span class="bound">CAs</span><span class="main">)</span> <span class="bound">DA</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">E</span><span class="main">.</span> <span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> ord_resolve_rename <span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span> <span class="bound">σ</span> <span class="bound">E</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">γ</span> <span class="main">|</span> <span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span> <span class="bound">σ</span> <span class="bound">E</span> <span class="bound">γ</span><span class="main">.</span> <span class="bound">γ</span> <span class="main">=</span> Infer <span class="main">(</span>mset <span class="bound">CAs</span><span class="main">)</span> <span class="bound">DA</span> <span class="bound">E</span>
    <span class="main">∧</span> ord_resolve_rename <span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span> <span class="bound">σ</span> <span class="bound">E</span> <span class="main">∧</span> infer_from <span class="var">?CCC</span> <span class="bound">γ</span> <span class="main">∧</span> <span class="free">C</span> <span class="main">∈#</span> prems_of <span class="bound">γ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Infer <span class="main">(</span>mset <span class="bound">CAs</span><span class="main">)</span> <span class="bound">DA</span> <span class="bound">E</span> <span class="main">|</span> <span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span> <span class="bound">σ</span> <span class="bound">E</span><span class="main">.</span>
    ord_resolve_rename <span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span> <span class="bound">σ</span> <span class="bound">E</span> <span class="main">∧</span> set <span class="bound">CAs</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">DA</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?CCC</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?infer_of</span> <span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span> <span class="main">|</span> <span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span><span class="main">.</span> <span class="bound">CAs</span> <span class="main">∈</span> <span class="skolem">CAS</span> <span class="main">∧</span> <span class="bound">DA</span> <span class="main">∈</span> <span class="var">?CCC</span> <span class="main">∧</span> <span class="bound">AAs</span> <span class="main">∈</span> <span class="skolem">AAS</span> <span class="main">∧</span> <span class="bound">As</span> <span class="main">∈</span> <span class="skolem">AS</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?W</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">CAS</span> <span class="main">×</span> <span class="var">?CCC</span> <span class="main">×</span> <span class="skolem">AAS</span> <span class="main">×</span> <span class="skolem">AS</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> fin_w<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?W</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> defs <span class="keyword1"><span class="command">using</span></span> fin_cc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_lists_length_le lists_eq_set<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Z</span> <span class="main">⊆</span> <span class="var">?Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> infer_from_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">CAs</span> <span class="skolem">DA</span> <span class="skolem">AAs</span> <span class="skolem">As</span> <span class="skolem">σ</span> <span class="skolem">E</span>
      <span class="keyword3"><span class="command">assume</span></span>
        res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve_rename <span class="skolem">CAs</span> <span class="skolem">DA</span> <span class="skolem">AAs</span> <span class="skolem">As</span> <span class="skolem">σ</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        da_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">DA</span> <span class="main">∈</span> <span class="var">?CCC</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        cas_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">CAs</span> <span class="main">⊆</span> <span class="var">?CCC</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">E</span><span class="main">.</span> <span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> ord_resolve_rename <span class="skolem">CAs</span> <span class="skolem">DA</span> <span class="skolem">AAs</span> <span class="skolem">As</span> <span class="bound">σ</span> <span class="bound">E</span><span class="main">)</span>
        <span class="main">∧</span> <span class="skolem">CAs</span> <span class="main">∈</span> <span class="skolem">CAS</span> <span class="main">∧</span> <span class="skolem">AAs</span> <span class="main">∈</span> <span class="skolem">AAS</span> <span class="main">∧</span> <span class="skolem">As</span> <span class="main">∈</span> <span class="skolem">AS</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">∧</span> <span class="var">?cas</span> <span class="main">∧</span> <span class="var">?aas</span> <span class="main">∧</span> <span class="var">?as</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> res_e ord_resolve_rename_unique <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> the_equality<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?cas</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> CAS_def max_ary_def <span class="keyword1"><span class="command">using</span></span> cas_sub
            ord_resolve_rename_max_side_prems<span class="main">[</span><span class="operator">OF</span> res_e<span class="main">]</span> da_in fin_cc
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_ge_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?aas</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> res_e
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ord_resolve_rename.cases<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ord_resolve_rename <span class="skolem">n</span> <span class="skolem">ρ</span> <span class="skolem">ρs</span><span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> len_cas <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> len_aas <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> len_as <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
            aas_sub <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> as_sub <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> res_e' <span class="main">=</span> this<span class="main">(</span>8<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> AAS_def
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AAs</span> <span class="main">∈</span> lists <span class="main">(</span>mset <span class="main">`</span> <span class="skolem">AS</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> AS_def image_def
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">AA</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">∈</span> set <span class="skolem">AAs</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
                i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
                aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">=</span> <span class="skolem">AAs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth len_aas<span class="main">)</span>

              <span class="keyword1"><span class="command">have</span></span> casi_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CAs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="var">?CCC</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> i_lt len_cas cas_sub nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

              <span class="keyword1"><span class="command">have</span></span> pos_aa_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"poss <span class="skolem">AA</span> <span class="main">⊆#</span> <span class="skolem">CAs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> aa aas_sub i_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">AA</span> <span class="main">⊆</span> atms_of <span class="main">(</span><span class="skolem">CAs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atms_of_poss lits_subseteq_imp_atms_subseteq set_mset_mono<span class="main">)</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> aa_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="skolem">all_AA</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> all_AA_def <span class="keyword1"><span class="command">using</span></span> casi_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> aa_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">AA</span> <span class="main">⊆</span> <span class="skolem">all_AA</span>"</span></span>
                <span class="keyword1"><span class="command">.</span></span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">AA</span> <span class="main">=</span> size <span class="main">(</span>poss <span class="skolem">AA</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> size <span class="main">(</span><span class="skolem">CAs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> size_mset_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pos_aa_sub<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">max_ary</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> max_ary_def <span class="keyword1"><span class="command">using</span></span> fin_cc casi_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> sz_aa<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">AA</span> <span class="main">≤</span> <span class="skolem">max_ary</span>"</span></span>
                <span class="keyword1"><span class="command">.</span></span>

              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?As'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sorted_list_of_multiset <span class="skolem">AA</span>"</span></span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?As'</span> <span class="main">∈</span> lists <span class="skolem">all_AA</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> aa_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?As'</span> <span class="main">≤</span> <span class="skolem">max_ary</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> sz_aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">=</span> mset <span class="var">?As'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xa</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">∈</span> lists <span class="skolem">all_AA</span> <span class="main">∧</span> length <span class="bound">xa</span> <span class="main">≤</span> <span class="skolem">max_ary</span> <span class="main">∧</span> <span class="skolem">AA</span> <span class="main">=</span> mset <span class="bound">xa</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">AAs</span> <span class="main">=</span> length <span class="skolem">As</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> len_aas len_as <span class="keyword1"><span class="command">..</span></span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> size <span class="skolem">DA</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> as_sub size_mset_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">max_ary</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> max_ary_def <span class="keyword1"><span class="command">using</span></span> fin_cc da_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">AAs</span> <span class="main">≤</span> <span class="skolem">max_ary</span>"</span></span>
              <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?as</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> AS_def
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">As</span> <span class="main">⊆</span> atms_of <span class="skolem">DA</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> res_e<span class="main">[</span><span class="operator">simplified</span> ord_resolve_rename.simps<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atms_of_negs lits_subseteq_imp_atms_subseteq set_mset_mono set_mset_mset<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="skolem">all_AA</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> all_AA_def <span class="keyword1"><span class="command">using</span></span> da_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">As</span> <span class="main">∈</span> lists <span class="skolem">all_AA</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> lists_eq_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">As</span> <span class="main">≤</span> size <span class="skolem">DA</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> res_e<span class="main">[</span><span class="operator">simplified</span> ord_resolve_rename.simps<span class="main">]</span>
              ord_resolve_rename_max_side_prems<span class="main">[</span><span class="operator">OF</span> res_e<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">DA</span> <span class="main">≤</span> <span class="skolem">max_ary</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> max_ary_def <span class="keyword1"><span class="command">using</span></span> fin_cc da_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">As</span> <span class="main">≤</span> <span class="skolem">max_ary</span>"</span></span>
            <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">CAs</span><span class="main">,</span> <span class="bound">DA</span><span class="main">,</span> <span class="bound">AAs</span><span class="main">,</span> <span class="bound">As</span><span class="main">)</span><span class="main">.</span> <span class="var">?infer_of</span> <span class="bound">CAs</span> <span class="bound">DA</span> <span class="bound">AAs</span> <span class="bound">As</span><span class="main">)</span> <span class="main">`</span> <span class="var">?W</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_def Bex_cartesian_product <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inference_system.inferences_between_def ord_FO_Γ_def mem_Collect_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_imageI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> fin_w<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ord_FO_resolution_inferences_between_empty_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ord_FO_resolution.inferences_between <span class="main">{}</span> <span class="main">{#}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ord_FO_resolution.inferences_between_def inference_system.inferences_between_def
    infer_from_def ord_FO_Γ_def
  <span class="keyword1"><span class="command">using</span></span> ord_resolve_rename_empty_main_prem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lifting›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following corresponds to the passage between Lemmas 4.11 and 4.12.
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> select<span class="main">:</span> <span class="quoted"><span class="quoted">"selection <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> selection
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> select<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S_M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal multiset <span class="main">⇒</span> <span class="tfree">'a</span> literal multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S_M</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∈</span> grounding_of_clss <span class="free">M</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">C'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">D</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="bound">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">∧</span> <span class="bound">C'</span> <span class="main">=</span> <span class="free">S</span> <span class="bound">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">∧</span> is_ground_subst <span class="bound">σ</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="free">S</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_M_grounding_of_clss<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> grounding_of_clss <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">D</span> <span class="free">σ</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∧</span> <span class="free">C</span> <span class="main">=</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">∧</span> S_M <span class="free">C</span> <span class="main">=</span> <span class="free">S</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">∧</span> is_ground_subst <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> S_M_def eqTrueI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> if_True<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C'</span> <span class="bound">D</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∧</span> <span class="free">C</span> <span class="main">=</span> <span class="bound">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">∧</span> <span class="bound">C'</span> <span class="main">=</span> <span class="free">S</span> <span class="bound">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">∧</span> is_ground_subst <span class="bound">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> grounding_of_clss_def grounding_of_cls_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_M_not_grounding_of_clss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∉</span> grounding_of_clss <span class="free">M</span> <span class="main">⟹</span> S_M <span class="free">C</span> <span class="main">=</span> <span class="free">S</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S_M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> S_M_selects_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"S_M <span class="free">C</span> <span class="main">⊆#</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_M_grounding_of_clss S_M_not_grounding_of_clss S_selects_subseteq subst_cls_mono_mset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> S_M_selects_neg_lits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∈#</span> S_M <span class="free">C</span> <span class="main">⟹</span> is_neg <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Melem_subst_cls S_M_grounding_of_clss S_M_not_grounding_of_clss S_selects_neg_lits
      subst_lit_is_neg<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following corresponds to Lemma 4.12:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ground_resolvent_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    gr_cas<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls_list <span class="free">CAs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gr_da<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">DA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve <span class="free">S</span> <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free">CAs</span><span class="main">)</span> <span class="main">+</span> <span class="free">DA</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> res_e
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ord_resolve.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ord_resolve <span class="skolem">n</span> <span class="skolem">Cs</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> da <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> e <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas_len <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cs_len <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> aas_len <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> as_len <span class="main">=</span> this<span class="main">(</span>6<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas <span class="main">=</span> this<span class="main">(</span>8<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> mgu <span class="main">=</span> this<span class="main">(</span>10<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cs_sub_cas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free">CAs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subseteq_list_Union_mset cas_len cs_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cs_sub_cas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="free">CAs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subseteq_list_Union_mset cas_len cs_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gr_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls_list <span class="skolem">Cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gr_cas <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> d_sub_da<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">⊆#</span> <span class="free">DA</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> da<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gr_d<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gr_da is_ground_cls_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gr_cs gr_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cs_sub_cas d_sub_da <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_mset.add_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_obtain_clauses<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span><span class="main">)</span> <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    select<span class="main">:</span> <span class="quoted"><span class="quoted">"selection <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    grounding<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">DA</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">CAs</span> <span class="main">⊆</span> grounding_of_clss <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    n<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">CAs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">DA</span> <span class="main">=</span> <span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">Cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="free">AAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Cs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">AAs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">DA0</span> <span class="free">η0</span> <span class="free">CAs0</span> <span class="free">ηs0</span> <span class="free">As0</span> <span class="free">AAs0</span> <span class="free">D0</span> <span class="free">Cs0</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">CAs0</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">ηs0</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">DA0</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">DA0</span> <span class="main">⋅</span> <span class="free">η0</span> <span class="main">=</span> <span class="free">DA</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">DA0</span> <span class="main">⋅</span> <span class="free">η0</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="free">DA</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">CA0</span> <span class="main">∈</span> set <span class="free">CAs0</span><span class="main">.</span> <span class="bound">CA0</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">CAs0</span> <span class="keyword1">⋅⋅cl</span> <span class="free">ηs0</span> <span class="main">=</span> <span class="free">CAs</span>"</span></span>
    <span class="quoted"><span class="quoted">"map <span class="free">S</span> <span class="free">CAs0</span> <span class="keyword1">⋅⋅cl</span> <span class="free">ηs0</span> <span class="main">=</span> map <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span><span class="main">)</span> <span class="free">CAs</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">η0</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_ground_subst_list <span class="free">ηs0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">As0</span>  <span class="keyword1">⋅al</span> <span class="free">η0</span> <span class="main">=</span> <span class="free">As</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">AAs0</span> <span class="keyword1">⋅⋅aml</span> <span class="free">ηs0</span> <span class="main">=</span> <span class="free">AAs</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">As0</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D0</span> <span class="main">⋅</span> <span class="free">η0</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">DA0</span> <span class="main">=</span> <span class="free">D0</span> <span class="main">+</span> <span class="main">(</span>negs <span class="main">(</span>mset <span class="free">As0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> negs <span class="main">(</span>mset <span class="free">As0</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="free">DA0</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">Cs0</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Cs0</span> <span class="keyword1">⋅⋅cl</span> <span class="free">ηs0</span> <span class="main">=</span> <span class="free">Cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="free">CAs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">Cs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="free">AAs0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">AAs0</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> res_e
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ord_resolve.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ord_resolve <span class="skolem">n_twin</span> <span class="skolem">Cs_twins</span> <span class="skolem">D_twin</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> da <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> e <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas <span class="main">=</span> this<span class="main">(</span>8<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> mgu <span class="main">=</span> this<span class="main">(</span>10<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> eligible <span class="main">=</span> this<span class="main">(</span>11<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ord_resolve <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n_twin</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D_twin</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs_twins</span> <span class="main">=</span> <span class="free">Cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c cas n calculation<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">Cs_twins</span> <span class="main">=</span> <span class="skolem">n_twin</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cs_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">Cs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> aas_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">AAs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> as_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">As</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> da<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">DA</span> <span class="main">=</span> <span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eligible<span class="main">:</span> <span class="quoted"><span class="quoted">"eligible <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span><span class="main">)</span> <span class="free">σ</span> <span class="free">As</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">Cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="free">AAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ord_resolve <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">CAs</span> <span class="main">=</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">Cs</span> <span class="main">=</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">AAs</span> <span class="main">=</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">As</span> <span class="main">=</span> <span class="free">n</span>›</span></span>

  <span class="keyword1"><span class="command">interpret</span></span> S<span class="main">:</span> selection <span class="quoted"><span class="free">S</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> select<span class="main">)</span>

  <span class="comment1">― ‹Obtain FO side premises›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">CA</span> <span class="main">∈</span> set <span class="free">CAs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">CA0</span> <span class="bound">ηc0</span><span class="main">.</span> <span class="bound">CA0</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∧</span> <span class="bound">CA0</span> <span class="main">⋅</span> <span class="bound">ηc0</span> <span class="main">=</span> <span class="bound">CA</span> <span class="main">∧</span> <span class="free">S</span> <span class="bound">CA0</span> <span class="main">⋅</span> <span class="bound">ηc0</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="bound">CA</span> <span class="main">∧</span> is_ground_subst <span class="bound">ηc0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> grounding S_M_grounding_of_clss select <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> le_supE subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">CA0</span> <span class="bound">ηc0</span><span class="main">.</span> <span class="bound">CA0</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∧</span> <span class="bound">CA0</span> <span class="main">⋅</span> <span class="bound">ηc0</span> <span class="main">=</span> <span class="main">(</span><span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">S</span> <span class="bound">CA0</span> <span class="main">⋅</span> <span class="bound">ηc0</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> is_ground_subst <span class="bound">ηc0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ηs0f</span></span> <span class="skolem"><span class="skolem">CAs0f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_p<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="skolem">CAs0f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">CAs0f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">ηs0f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="skolem">CAs0f</span> <span class="bound">i</span><span class="main">)</span>  <span class="main">⋅</span> <span class="main">(</span><span class="skolem">ηs0f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> is_ground_subst <span class="main">(</span><span class="skolem">ηs0f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ηs0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ηs0</span> <span class="main">=</span> map <span class="skolem">ηs0f</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">CAs0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">CAs0</span> <span class="main">=</span> map <span class="skolem">CAs0f</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">CAs0</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ηs0_def CAs0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">CAs0</span> <span class="main">=</span> <span class="free">n</span>›</span></span> n

  <span class="comment1">― ‹The properties we need of the FO side premises›</span>
  <span class="keyword1"><span class="command">have</span></span> CAs0_in_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">CA0</span> <span class="main">∈</span> set <span class="skolem">CAs0</span><span class="main">.</span> <span class="bound">CA0</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> CAs0_def <span class="keyword1"><span class="command">using</span></span> f_p<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> CAs0_to_CAs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CAs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">CAs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> CAs0_def ηs0_def <span class="keyword1"><span class="command">using</span></span> f_p<span class="main">(</span>2<span class="main">)</span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> SCAs0_to_SMCAs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">S</span> <span class="skolem">CAs0</span><span class="main">)</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0</span> <span class="main">=</span> map <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span><span class="main">)</span> <span class="free">CAs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> CAs0_def ηs0_def <span class="keyword1"><span class="command">using</span></span> f_p<span class="main">(</span>3<span class="main">)</span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sub_ground<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ηc0</span> <span class="main">∈</span> set <span class="skolem">ηs0</span><span class="main">.</span> is_ground_subst <span class="bound">ηc0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ηs0_def <span class="keyword1"><span class="command">using</span></span> f_p n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ground_subst_list <span class="skolem">ηs0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">unfolding</span></span> is_ground_subst_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹Split side premises CAs0 into Cs0 and AAs0›</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AAs0</span></span> <span class="skolem"><span class="skolem">Cs0</span></span> <span class="keyword2"><span class="keyword">where</span></span> AAs0_Cs0_p<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="skolem">AAs0</span> <span class="keyword1">⋅⋅aml</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">AAs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Cs0</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">Cs</span>"</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="skolem">CAs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">Cs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="skolem">AAs0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">AAs0</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">AA0</span><span class="main">.</span> <span class="bound">AA0</span> <span class="keyword1">⋅am</span> <span class="skolem">ηs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">AAs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> poss <span class="bound">AA0</span> <span class="main">⊆#</span> <span class="skolem">CAs0</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CAs0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">⋅</span> <span class="skolem">ηs0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">CAs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">CAs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">CAs</span>›</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poss <span class="main">(</span><span class="free">AAs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊆#</span> <span class="free">CAs</span> <span class="main">!</span><span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> cas <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">poss_AA0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        nn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">poss_AA0</span> <span class="main">⋅</span> <span class="skolem">ηs0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> poss <span class="main">(</span><span class="free">AAs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">poss_AA0</span> <span class="main">⊆#</span> <span class="skolem">CAs0</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cas image_mset_of_subset <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">L</span> <span class="main">∈#</span> <span class="skolem">poss_AA0</span><span class="main">.</span> is_pos <span class="bound">L</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> subst_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Melem_subst_cls imageE literal.disc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
            literal.map_disc_iff set_image_mset subst_cls_def subst_lit_def<span class="main">)</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">AA0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">AA0</span> <span class="main">=</span> image_mset atm_of <span class="skolem">poss_AA0</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> na<span class="main">:</span> <span class="quoted"><span class="quoted">"poss <span class="skolem">AA0</span> <span class="main">=</span> <span class="skolem">poss_AA0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">unfolding</span></span> AA0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AA0</span> <span class="keyword1">⋅am</span> <span class="skolem">ηs0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">AAs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> literal.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> multiset.inj_map_strong subst_cls_poss<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poss <span class="skolem">AA0</span> <span class="main">⊆#</span> <span class="skolem">CAs0</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> na nn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">AA0</span><span class="main">.</span> <span class="bound">AA0</span> <span class="keyword1">⋅am</span> <span class="skolem">ηs0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">AAs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∧</span> poss <span class="bound">AA0</span> <span class="main">⊆#</span> <span class="skolem">CAs0</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AAs0f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      AAs0f_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="skolem">AAs0f</span> <span class="bound">i</span> <span class="keyword1">⋅am</span> <span class="skolem">ηs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">AAs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span>poss <span class="main">(</span><span class="skolem">AAs0f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">CAs0</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">AAs0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AAs0</span> <span class="main">=</span> map <span class="skolem">AAs0f</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">AAs0</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> n <span class="quoted"><span class="quoted">‹length <span class="skolem">AAs0</span> <span class="main">=</span> <span class="free">n</span>›</span></span>

    <span class="keyword1"><span class="command">from</span></span> AAs0_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="skolem">AAs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅am</span> <span class="skolem">ηs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">AAs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> AAs0f_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> AAs0_AAs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AAs0</span> <span class="keyword1">⋅⋅aml</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">AAs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> AAs0_def <span class="keyword1"><span class="command">have</span></span> AAs0_in_CAs0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> poss <span class="main">(</span><span class="skolem">AAs0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">CAs0</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> AAs0f_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">Cs0</span> <span class="main">=</span> map2 <span class="main">(-)</span> <span class="skolem">CAs0</span> <span class="main">(</span>map poss <span class="skolem">AAs0</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Cs0</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cs0_def n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> n <span class="quoted"><span class="quoted">‹length <span class="skolem">Cs0</span> <span class="main">=</span> <span class="free">n</span>›</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="skolem">CAs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">Cs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="skolem">AAs0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> AAs0_in_CAs0 Cs0_def n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">Cs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">CAs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">CAs</span>›</span></span> AAs0_AAs cas n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> that
        <span class="quoted"><span class="quoted">‹<span class="skolem">AAs0</span> <span class="keyword1">⋅⋅aml</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">AAs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Cs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">Cs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="skolem">CAs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">Cs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="skolem">AAs0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹length <span class="skolem">AAs0</span> <span class="main">=</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">Cs0</span> <span class="main">=</span> <span class="free">n</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Obtain FO main premise›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">DA0</span> <span class="bound">η0</span><span class="main">.</span> <span class="bound">DA0</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∧</span> <span class="free">DA</span> <span class="main">=</span> <span class="bound">DA0</span> <span class="main">⋅</span> <span class="bound">η0</span> <span class="main">∧</span> <span class="free">S</span> <span class="bound">DA0</span> <span class="main">⋅</span> <span class="bound">η0</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="free">DA</span> <span class="main">∧</span> is_ground_subst <span class="bound">η0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> grounding S_M_grounding_of_clss select <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_supE singletonI subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">DA0</span></span> <span class="skolem"><span class="skolem">η0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    DA0_η0_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">DA0</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∧</span> <span class="free">DA</span> <span class="main">=</span> <span class="skolem">DA0</span> <span class="main">⋅</span> <span class="skolem">η0</span> <span class="main">∧</span> <span class="free">S</span> <span class="skolem">DA0</span> <span class="main">⋅</span> <span class="skolem">η0</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="free">DA</span> <span class="main">∧</span> is_ground_subst <span class="skolem">η0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹The properties we need of the FO main premise›</span>
  <span class="keyword1"><span class="command">have</span></span> DA0_in_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">DA0</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> DA0_η0_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> DA0_to_DA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">DA0</span> <span class="main">⋅</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">DA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> DA0_η0_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> SDA0_to_SMDA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">DA0</span> <span class="main">⋅</span> <span class="skolem">η0</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="free">DA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> DA0_η0_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">η0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> DA0_η0_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹Split main premise DA0 into D0 and As0›</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D0</span></span> <span class="skolem"><span class="skolem">As0</span></span> <span class="keyword2"><span class="keyword">where</span></span> D0As0_p<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="skolem">As0</span>  <span class="keyword1">⋅al</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">As</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">As0</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D0</span> <span class="main">⋅</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">DA0</span> <span class="main">=</span> <span class="skolem">D0</span> <span class="main">+</span> <span class="main">(</span>negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∧</span> length <span class="free">As</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>
        <span class="main">∧</span> maximal_wrt <span class="main">(</span><span class="free">As</span> <span class="main">!</span> <span class="main">0</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">As</span> <span class="main">=</span> <span class="main">{#</span><span class="free">As</span> <span class="main">!</span> <span class="main">0</span><span class="main">#}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span>Neg <span class="main">(</span><span class="free">As</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">#}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹mset <span class="free">As</span> <span class="main">=</span> <span class="main">{#</span><span class="free">As</span> <span class="main">!</span> <span class="main">0</span><span class="main">#}</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">DA</span> <span class="main">=</span> <span class="free">D</span> <span class="main">+</span> <span class="main">{#</span>Neg <span class="main">(</span><span class="free">As</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">#}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> da <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∈#</span> <span class="skolem">DA0</span> <span class="main">∧</span> <span class="skolem">L</span> <span class="keyword1">⋅l</span> <span class="skolem">η0</span> <span class="main">=</span> Neg <span class="main">(</span><span class="free">As</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> DA0_to_DA <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Melem_subst_cls mset_subset_eq_add_right single_subset_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Neg <span class="main">(</span>atm_of <span class="skolem">L</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">DA0</span> <span class="main">∧</span> Neg <span class="main">(</span>atm_of <span class="skolem">L</span><span class="main">)</span> <span class="keyword1">⋅l</span> <span class="skolem">η0</span> <span class="main">=</span> Neg <span class="main">(</span><span class="free">As</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Neg_atm_of_iff literal.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subst_lit_is_pos<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>atm_of <span class="skolem">L</span><span class="main">]</span> <span class="keyword1">⋅al</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">As</span> <span class="main">∧</span> negs <span class="main">(</span>mset <span class="main">[</span>atm_of <span class="skolem">L</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">DA0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> as subst_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">As0</span><span class="main">.</span> <span class="bound">As0</span> <span class="keyword1">⋅al</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">As</span> <span class="main">∧</span> negs <span class="main">(</span>mset <span class="bound">As0</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">DA0</span>
        <span class="main">∧</span> <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟶</span> negs <span class="main">(</span>mset <span class="bound">As0</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0</span> <span class="main">⋅</span> <span class="skolem">η0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> da <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="skolem">DA0</span> <span class="main">⋅</span> <span class="skolem">η0</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="free">DA</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">As0</span><span class="main">.</span> negs <span class="main">(</span>mset <span class="bound">As0</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0</span> <span class="main">∧</span> <span class="bound">As0</span> <span class="keyword1">⋅al</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">As</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> instance_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">As</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">DA0</span>"</span></span> <span class="quoted"><span class="skolem">η0</span></span><span class="main">]</span> S.S_selects_neg_lits <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">As0</span><span class="main">.</span> <span class="bound">As0</span> <span class="keyword1">⋅al</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">As</span> <span class="main">∧</span> negs <span class="main">(</span>mset <span class="bound">As0</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">DA0</span>
        <span class="main">∧</span> <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟶</span> negs <span class="main">(</span>mset <span class="bound">As0</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S.S_selects_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">As0</span><span class="main">.</span> <span class="bound">As0</span> <span class="keyword1">⋅al</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">As</span> <span class="main">∧</span> <span class="main">(</span>negs <span class="main">(</span>mset <span class="bound">As0</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">DA0</span>
      <span class="main">∧</span> <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟶</span> negs <span class="main">(</span>mset <span class="bound">As0</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eligible <span class="keyword1"><span class="command">unfolding</span></span> eligible.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">As0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      As0_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">As0</span> <span class="keyword1">⋅al</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">As</span> <span class="main">∧</span> negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">DA0</span>
      <span class="main">∧</span> <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟶</span> negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">As0</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> as_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> n this

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">As0</span> <span class="keyword1">⋅al</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">As</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> As0_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">D0</span> <span class="main">=</span> <span class="skolem">DA0</span> <span class="main">-</span> negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">DA0</span> <span class="main">=</span> <span class="skolem">D0</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> As0_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D0</span> <span class="main">⋅</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> DA0_to_DA da As0_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> As0_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="skolem">As0</span> <span class="keyword1">⋅al</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">As</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D0</span> <span class="main">⋅</span> <span class="skolem">η0</span><span class="main">=</span> <span class="free">D</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">DA0</span> <span class="main">=</span> <span class="skolem">D0</span> <span class="main">+</span>  <span class="main">(</span>negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">As0</span> <span class="main">=</span> <span class="free">n</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">OF</span> n<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> DA0_in_M  DA0_to_DA SDA0_to_SMDA CAs0_in_M CAs0_to_CAs SCAs0_to_SMCAs
        <span class="quoted"><span class="quoted">‹is_ground_subst <span class="skolem">η0</span>›</span></span> <span class="quoted"><span class="quoted">‹is_ground_subst_list <span class="skolem">ηs0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">As0</span>  <span class="keyword1">⋅al</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">As</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">AAs0</span> <span class="keyword1">⋅⋅aml</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">AAs</span>›</span></span>
        <span class="quoted"><span class="quoted">‹length <span class="skolem">As0</span> <span class="main">=</span> <span class="free">n</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">D0</span> <span class="main">⋅</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">D</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">DA0</span> <span class="main">=</span> <span class="skolem">D0</span> <span class="main">+</span> <span class="main">(</span>negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span><span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0</span>›</span></span>
        <span class="quoted"><span class="quoted">‹length <span class="skolem">Cs0</span> <span class="main">=</span> <span class="free">n</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">Cs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">Cs</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="skolem">CAs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">Cs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="skolem">AAs0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹length <span class="skolem">AAs0</span> <span class="main">=</span> <span class="free">n</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ord_resolve_rename_lifting<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    sel_stable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ</span> <span class="bound">C</span><span class="main">.</span> is_renaming <span class="bound">ρ</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span><span class="bound">C</span> <span class="main">⋅</span> <span class="bound">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="bound">C</span> <span class="main">⋅</span> <span class="bound">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    res_e<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span><span class="main">)</span> <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">σ</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    select<span class="main">:</span> <span class="quoted"><span class="quoted">"selection <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    grounding<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">DA</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">CAs</span> <span class="main">⊆</span> grounding_of_clss <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ηs</span> <span class="free">η</span> <span class="free">η2</span> <span class="free">CAs0</span> <span class="free">DA0</span> <span class="free">AAs0</span> <span class="free">As0</span> <span class="free">E0</span> <span class="free">τ</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">η</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_ground_subst_list <span class="free">ηs</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">η2</span>"</span></span>
    <span class="quoted"><span class="quoted">"ord_resolve_rename <span class="free">S</span> <span class="free">CAs0</span> <span class="free">DA0</span> <span class="free">AAs0</span> <span class="free">As0</span> <span class="free">τ</span> <span class="free">E0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">CAs0</span> <span class="keyword1">⋅⋅cl</span> <span class="free">ηs</span> <span class="main">=</span> <span class="free">CAs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">DA0</span> <span class="main">⋅</span> <span class="free">η</span> <span class="main">=</span> <span class="free">DA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E0</span> <span class="main">⋅</span> <span class="free">η2</span> <span class="main">=</span> <span class="free">E</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">DA0</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">CAs0</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">CAs0</span> <span class="main">=</span> length <span class="free">CAs</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">ηs</span> <span class="main">=</span> length <span class="free">CAs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> res_e
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ord_resolve.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ord_resolve <span class="skolem">n</span> <span class="skolem">Cs</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> da <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> e <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas_len <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cs_len <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    aas_len <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> as_len <span class="main">=</span> this<span class="main">(</span>6<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> nz <span class="main">=</span> this<span class="main">(</span>7<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cas <span class="main">=</span> this<span class="main">(</span>8<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    aas_not_empt <span class="main">=</span> this<span class="main">(</span>9<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> mgu <span class="main">=</span> this<span class="main">(</span>10<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> eligible <span class="main">=</span> this<span class="main">(</span>11<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> str_max <span class="main">=</span> this<span class="main">(</span>12<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    sel_empt <span class="main">=</span> this<span class="main">(</span>13<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> sel_ren_list_inv<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρs</span> <span class="bound">Cs</span><span class="main">.</span> length <span class="bound">ρs</span> <span class="main">=</span> length <span class="bound">Cs</span> <span class="main">⟹</span> is_renaming_list <span class="bound">ρs</span> <span class="main">⟹</span> map <span class="free">S</span> <span class="main">(</span><span class="bound">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="bound">ρs</span><span class="main">)</span> <span class="main">=</span> map <span class="free">S</span> <span class="bound">Cs</span> <span class="keyword1">⋅⋅cl</span> <span class="bound">ρs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sel_stable <span class="keyword1"><span class="command">unfolding</span></span> is_renaming_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">CAs</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">Cs</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">AAs</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">As</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span>

  <span class="keyword1"><span class="command">interpret</span></span> S<span class="main">:</span> selection <span class="quoted"><span class="free">S</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> select<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">DA0</span></span> <span class="skolem"><span class="skolem">η0</span></span> <span class="skolem"><span class="skolem">CAs0</span></span> <span class="skolem"><span class="skolem">ηs0</span></span> <span class="skolem"><span class="skolem">As0</span></span> <span class="skolem"><span class="skolem">AAs0</span></span> <span class="skolem"><span class="skolem">D0</span></span> <span class="skolem"><span class="skolem">Cs0</span></span> <span class="keyword2"><span class="keyword">where</span></span> as0<span class="main">:</span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">CAs0</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">ηs0</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">DA0</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">DA0</span> <span class="main">⋅</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">DA</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">DA0</span> <span class="main">⋅</span> <span class="skolem">η0</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="free">DA</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">CA0</span> <span class="main">∈</span> set <span class="skolem">CAs0</span><span class="main">.</span> <span class="bound">CA0</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">CAs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">CAs</span>"</span></span>
    <span class="quoted"><span class="quoted">"map <span class="free">S</span> <span class="skolem">CAs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0</span> <span class="main">=</span> map <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span><span class="main">)</span> <span class="free">CAs</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">η0</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_ground_subst_list <span class="skolem">ηs0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">As0</span> <span class="keyword1">⋅al</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">As</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">AAs0</span> <span class="keyword1">⋅⋅aml</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">AAs</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">As0</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">D0</span> <span class="main">⋅</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">DA0</span> <span class="main">=</span> <span class="skolem">D0</span> <span class="main">+</span> <span class="main">(</span>negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">Cs0</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">Cs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="skolem">Cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="skolem">CAs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">Cs0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="skolem">AAs0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">AAs0</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ord_resolve_obtain_clauses<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">CAs</span></span> <span class="quoted"><span class="free">DA</span></span><span class="main">,</span> <span class="operator">OF</span> res_e select grounding n<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">DA</span> <span class="main">=</span> <span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">Cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="free">AAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">Cs</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">AAs</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">thesis</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">CAs0</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ηs0</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">As0</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">AAs0</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">Cs0</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> n

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">renamings_apart</span> <span class="main">(</span><span class="skolem">DA0</span> <span class="main">#</span> <span class="skolem">CAs0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n renamings_apart_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> this n

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">=</span> hd <span class="main">(</span><span class="free">renamings_apart</span> <span class="main">(</span><span class="skolem">DA0</span> <span class="main">#</span> <span class="skolem">CAs0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ρs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ρs</span> <span class="main">=</span> tl <span class="main">(</span><span class="free">renamings_apart</span> <span class="main">(</span><span class="skolem">DA0</span> <span class="main">#</span> <span class="skolem">CAs0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">DA0'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">DA0'</span> <span class="main">=</span> <span class="skolem">DA0</span> <span class="main">⋅</span> <span class="skolem">ρ</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D0'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">D0'</span> <span class="main">=</span> <span class="skolem">D0</span> <span class="main">⋅</span> <span class="skolem">ρ</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">As0'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">As0'</span> <span class="main">=</span> <span class="skolem">As0</span> <span class="keyword1">⋅al</span> <span class="skolem">ρ</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">CAs0'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">CAs0'</span> <span class="main">=</span> <span class="skolem">CAs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs0'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">Cs0'</span> <span class="main">=</span> <span class="skolem">Cs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">AAs0'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">AAs0'</span> <span class="main">=</span> <span class="skolem">AAs0</span> <span class="keyword1">⋅⋅aml</span> <span class="skolem">ρs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">η0'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">η0'</span> <span class="main">=</span> inv_renaming <span class="skolem">ρ</span> <span class="main">⊙</span> <span class="skolem">η0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ηs0'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ηs0'</span> <span class="main">=</span> map inv_renaming <span class="skolem">ρs</span> <span class="keyword1">⊙s</span> <span class="skolem">ηs0</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> renames_DA0<span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> renamings_apart_length renamings_apart_renaming <span class="keyword1"><span class="command">unfolding</span></span> ρ_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_greater_0_conv list.exhaust_sel list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> renames_CAs0<span class="main">:</span> <span class="quoted"><span class="quoted">"is_renaming_list <span class="skolem">ρs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> renamings_apart_length renamings_apart_renaming <span class="keyword1"><span class="command">unfolding</span></span> ρs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_renaming_list_def length_greater_0_conv list.set_sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ρs</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ρs_def <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> n <span class="quoted"><span class="quoted">‹length <span class="skolem">ρs</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">As0'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> As0'_def <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">CAs0'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>1<span class="main">)</span> n <span class="keyword1"><span class="command">unfolding</span></span> CAs0'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Cs0'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Cs0'_def <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">AAs0'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> AAs0'_def <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ηs0'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>2<span class="main">)</span> n <span class="keyword1"><span class="command">unfolding</span></span> ηs0'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">CAs0'</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ηs0'</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">As0'</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">AAs0'</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">Cs0'</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> n

  <span class="keyword1"><span class="command">have</span></span> DA0'_DA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">DA0'</span> <span class="main">⋅</span> <span class="skolem">η0'</span> <span class="main">=</span> <span class="free">DA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> η0'_def DA0'_def <span class="keyword1"><span class="command">using</span></span> renames_DA0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> D0'_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D0'</span> <span class="main">⋅</span> <span class="skolem">η0'</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>14<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> η0'_def D0'_def <span class="keyword1"><span class="command">using</span></span> renames_DA0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> As0'_As<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η0'</span> <span class="main">=</span> <span class="free">As</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>11<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> η0'_def As0'_def <span class="keyword1"><span class="command">using</span></span> renames_DA0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">DA0'</span> <span class="main">⋅</span> <span class="skolem">η0'</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="free">DA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> η0'_def DA0'_def <span class="keyword1"><span class="command">using</span></span> renames_DA0 sel_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> CAs0'_CAs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CAs0'</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0'</span> <span class="main">=</span> <span class="free">CAs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> CAs0'_def ηs0'_def <span class="keyword1"><span class="command">using</span></span> renames_CAs0 n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Cs0'_Cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs0'</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0'</span> <span class="main">=</span> <span class="skolem">Cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>18<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Cs0'_def ηs0'_def <span class="keyword1"><span class="command">using</span></span> renames_CAs0 n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> AAs0'_AAs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AAs0'</span> <span class="keyword1">⋅⋅aml</span> <span class="skolem">ηs0'</span> <span class="main">=</span> <span class="free">AAs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>12<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ηs0'_def AAs0'_def <span class="keyword1"><span class="command">using</span></span> renames_CAs0 <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="free">S</span> <span class="skolem">CAs0'</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0'</span> <span class="main">=</span> map <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span><span class="main">)</span> <span class="free">CAs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> CAs0'_def ηs0'_def <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>8<span class="main">)</span> n renames_CAs0 sel_ren_list_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> DA0'_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">DA0'</span> <span class="main">=</span> <span class="skolem">D0'</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As0'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>15<span class="main">)</span> DA0'_def D0'_def As0'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D0'_subset_DA0'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D0'</span> <span class="main">⊆#</span> <span class="skolem">DA0'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> DA0'_split <span class="keyword1"><span class="command">have</span></span> negs_As0'_subset_DA0'<span class="main">:</span> <span class="quoted"><span class="quoted">"negs <span class="main">(</span>mset <span class="skolem">As0'</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">DA0'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> CAs0'_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">Cs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="skolem">AAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>19<span class="main">)</span> CAs0'_def Cs0'_def AAs0'_def n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">Cs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⊆#</span> <span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> CAs0'_split <span class="keyword1"><span class="command">have</span></span> poss_AAs0'_subset_CAs0'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> poss <span class="main">(</span><span class="skolem">AAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> AAs0'_in_atms_of_CAs0'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span><span class="main">∈#</span><span class="skolem">AAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atm_iff_pos_or_neg_lit<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> as0'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> negs <span class="main">(</span>mset <span class="skolem">As0'</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">ρ</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0</span> <span class="main">⋅</span> <span class="skolem">ρ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>16<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ρ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negs <span class="main">(</span>mset <span class="skolem">As0'</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="skolem">DA0'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>  As0'_def DA0'_def <span class="keyword1"><span class="command">using</span></span> sel_stable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ρ</span></span> <span class="quoted"><span class="skolem">DA0</span></span><span class="main">]</span> renames_DA0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> vd<span class="main">:</span> <span class="quoted"><span class="quoted">"var_disjoint <span class="main">(</span><span class="skolem">DA0'</span> <span class="main">#</span> <span class="skolem">CAs0'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> DA0'_def CAs0'_def <span class="keyword1"><span class="command">using</span></span> renamings_apart_var_disjoint
    <span class="keyword1"><span class="command">unfolding</span></span> ρ_def ρs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_greater_0_conv list.exhaust_sel n<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> substitution.subst_cls_lists_Cons
        substitution_axioms zero_less_Suc<span class="main">)</span>

  <span class="comment1">― ‹Introduce ground substitution›</span>
  <span class="keyword1"><span class="command">from</span></span> vd DA0'_DA CAs0'_CAs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">η</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆#</span> <span class="main">(</span><span class="skolem">DA0'</span> <span class="main">#</span> <span class="skolem">CAs0'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">η0'</span><span class="main">#</span><span class="skolem">ηs0'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">S</span> <span class="main">⋅</span> <span class="bound">η</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> var_disjoint_def <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">η</span></span> <span class="keyword2"><span class="keyword">where</span></span> η_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆#</span> <span class="main">(</span><span class="skolem">DA0'</span> <span class="main">#</span> <span class="skolem">CAs0'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">η0'</span><span class="main">#</span><span class="skolem">ηs0'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">S</span> <span class="main">⋅</span> <span class="skolem">η</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> η_p_lit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">∈#</span> <span class="main">(</span><span class="skolem">DA0'</span> <span class="main">#</span> <span class="skolem">CAs0'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="main">(</span><span class="skolem">η0'</span><span class="main">#</span><span class="skolem">ηs0'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">L</span> <span class="keyword1">⋅l</span> <span class="skolem">η</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∈#</span> <span class="main">(</span><span class="skolem">DA0'</span> <span class="main">#</span> <span class="skolem">CAs0'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆#</span> <span class="main">(</span><span class="skolem">DA0'</span> <span class="main">#</span> <span class="skolem">CAs0'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">η0'</span> <span class="main">#</span> <span class="skolem">ηs0'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">S</span> <span class="main">⋅</span> <span class="skolem">η</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> η_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="skolem">L</span> <span class="main">#}</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">η0'</span> <span class="main">#</span> <span class="skolem">ηs0'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">{#</span> <span class="skolem">L</span> <span class="main">#}</span> <span class="main">⋅</span> <span class="skolem">η</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> single_subset_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="keyword1">⋅l</span> <span class="main">(</span><span class="skolem">η0'</span> <span class="main">#</span> <span class="skolem">ηs0'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">L</span> <span class="keyword1">⋅l</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> η_p_atm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="main">(</span><span class="skolem">DA0'</span> <span class="main">#</span> <span class="skolem">CAs0'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="main">(</span><span class="skolem">η0'</span><span class="main">#</span><span class="skolem">ηs0'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="skolem">η</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="main">(</span><span class="skolem">DA0'</span> <span class="main">#</span> <span class="skolem">CAs0'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> L_p<span class="main">:</span> <span class="quoted"><span class="quoted">"atm_of <span class="skolem">L</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">∧</span> <span class="skolem">L</span> <span class="main">∈#</span> <span class="main">(</span><span class="skolem">DA0'</span> <span class="main">#</span> <span class="skolem">CAs0'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="keyword1">⋅l</span> <span class="main">(</span><span class="skolem">η0'</span><span class="main">#</span><span class="skolem">ηs0'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">L</span> <span class="keyword1">⋅l</span> <span class="skolem">η</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> η_p_lit a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="keyword1">⋅a</span> <span class="main">(</span><span class="skolem">η0'</span> <span class="main">#</span> <span class="skolem">ηs0'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">A</span> <span class="keyword1">⋅a</span> <span class="skolem">η</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L_p <span class="keyword1"><span class="command">unfolding</span></span> subst_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">L</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> DA0'_DA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">DA0'</span> <span class="main">⋅</span> <span class="skolem">η</span> <span class="main">=</span> <span class="free">DA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> DA0'_DA η_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D0'</span> <span class="main">⋅</span> <span class="skolem">η</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> η_p D0'_D n D0'_subset_DA0' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span> <span class="main">=</span> <span class="free">As</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> length <span class="free">As</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>length <span class="main">(</span><span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">As</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> A_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> atms_of <span class="skolem">DA0'</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="skolem">η0'</span> <span class="main">=</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="skolem">η</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> η_p_atm n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">As0'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> atms_of <span class="skolem">DA0'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> negs_As0'_subset_DA0' <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def
        <span class="keyword1"><span class="command">using</span></span> a n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">As0'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">⋅a</span> <span class="skolem">η0'</span> <span class="main">=</span> <span class="skolem">As0'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">⋅a</span> <span class="skolem">η</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> A_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">As</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> As0'_As <span class="quoted"><span class="quoted">‹length <span class="skolem">As0'</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">interpret</span></span> selection
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> select<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">DA0'</span> <span class="main">⋅</span> <span class="skolem">η</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="free">DA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="skolem">DA0'</span> <span class="main">⋅</span> <span class="skolem">η0'</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="free">DA</span>›</span></span> η_p S.S_selects_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> η_p <span class="keyword1"><span class="command">have</span></span> η_p_CAs0'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">ηs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">CAs0'</span><span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">η</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CAs0'</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0'</span> <span class="main">=</span> <span class="skolem">CAs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> CAs0'_η_fo_CAs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CAs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span> <span class="main">=</span> <span class="free">CAs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> CAs0'_CAs η_p n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> η_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">ηs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">S</span> <span class="main">(</span><span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">η</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S.S_selects_subseteq n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="free">S</span> <span class="skolem">CAs0'</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0'</span> <span class="main">=</span> map <span class="free">S</span> <span class="skolem">CAs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> SCAs0'_η_fo_SMCAs<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">S</span> <span class="skolem">CAs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span> <span class="main">=</span> map <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span><span class="main">)</span> <span class="free">CAs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map <span class="free">S</span> <span class="skolem">CAs0'</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0'</span> <span class="main">=</span> map <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span><span class="main">)</span> <span class="free">CAs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span> <span class="main">=</span> <span class="skolem">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">Cs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">Cs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>length <span class="main">(</span><span class="skolem">Cs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">Cs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">Cs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">Cs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Cs0'</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">Cs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cs0'_Cs a n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> η_p_CAs0'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆#</span> <span class="skolem">CAs0'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="main">⋅</span> <span class="skolem">ηs0'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">S</span> <span class="main">⋅</span> <span class="skolem">η</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> η_p a <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs0'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">⋅</span> <span class="skolem">ηs0'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Cs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> η_p_CAs0' <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">Cs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⊆#</span> <span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span>›</span></span> a n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Cs0'</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Cs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> "</span></span>
        <span class="keyword1"><span class="command">using</span></span> a n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Cs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">Cs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> AAs0'_AAs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AAs0'</span> <span class="keyword1">⋅aml</span> <span class="skolem">η</span> <span class="main">=</span> <span class="free">AAs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">AAs0'</span> <span class="keyword1">⋅aml</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> length <span class="free">AAs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>length <span class="main">(</span><span class="skolem">AAs0'</span> <span class="keyword1">⋅aml</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">AAs0'</span> <span class="keyword1">⋅aml</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">AAs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">AAs0'</span> <span class="keyword1">⋅aml</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="main">(</span><span class="skolem">DA0'</span> <span class="main">#</span> <span class="skolem">CAs0'</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="main">(</span><span class="skolem">η0'</span> <span class="main">#</span> <span class="skolem">ηs0'</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">i</span> <span class="main">=</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="skolem">η</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> η_p_atm n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="skolem">CAs0'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="skolem">ηs0'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">A</span> <span class="keyword1">⋅a</span> <span class="skolem">η</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> AAs_CAs0'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈#</span> <span class="skolem">AAs0'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> atms_of <span class="main">(</span><span class="skolem">CAs0'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AAs0'_in_atms_of_CAs0' <span class="keyword1"><span class="command">unfolding</span></span> atms_of_def
        <span class="keyword1"><span class="command">using</span></span> a n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AAs0'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">⋅am</span>  <span class="skolem">ηs0'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">AAs0'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">⋅am</span> <span class="skolem">η</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_def <span class="keyword1"><span class="command">using</span></span> A_eq <span class="keyword1"><span class="command">unfolding</span></span> subst_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AAs0'</span> <span class="keyword1">⋅aml</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">AAs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> AAs0'_AAs <span class="quoted"><span class="quoted">‹length <span class="skolem">AAs0'</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ηs0'</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Obtain MGU and substitution›</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τφ<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Some <span class="skolem">τ</span> <span class="main">=</span> <span class="free">mgu</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="skolem">As0'</span> <span class="skolem">AAs0'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">⊙</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="skolem">η</span> <span class="main">⊙</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> uu<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unifiers <span class="free">σ</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="main">(</span><span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AAs0'</span> <span class="keyword1">⋅aml</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mgu mgu_sound is_mgu_def <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">AAs0'</span> <span class="keyword1">⋅aml</span> <span class="skolem">η</span> <span class="main">=</span> <span class="free">AAs</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span> <span class="main">=</span> <span class="free">As</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ησuni<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unifiers <span class="main">(</span><span class="skolem">η</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="skolem">As0'</span> <span class="skolem">AAs0'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="skolem">As0'</span> <span class="skolem">AAs0'</span> <span class="keyword1">⋅aml</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span>
        set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="skolem">As0'</span> <span class="skolem">AAs0'</span><span class="main">)</span> <span class="keyword1">⋅ass</span> <span class="skolem">η</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> subst_atmss_def subst_atm_mset_list_def <span class="keyword1"><span class="command">using</span></span> subst_atm_mset_def subst_atms_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image subst_atm_mset_def subst_atms_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_unifiers <span class="free">σ</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="skolem">As0'</span> <span class="skolem">AAs0'</span><span class="main">)</span> <span class="keyword1">⋅ass</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> uu <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n map2_add_mset_map<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> is_unifiers_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      τ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="skolem">τ</span> <span class="main">=</span> <span class="free">mgu</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="skolem">As0'</span> <span class="skolem">AAs0'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mgu_complete
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> List.finite_set finite_imageI finite_set_mset image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">⊙</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="skolem">η</span> <span class="main">⊙</span> <span class="free">σ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> finite_set ησuni finite_imageI finite_set_mset image_iff
          mgu_sound set_mset_mset substitution_ops.is_mgu_def<span class="main">)</span> <span class="comment1">(* should be simpler *)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Lifting eligibility›</span>
  <span class="keyword1"><span class="command">have</span></span> eligible0'<span class="main">:</span> <span class="quoted"><span class="quoted">"eligible <span class="free">S</span> <span class="skolem">τ</span> <span class="skolem">As0'</span> <span class="main">(</span><span class="skolem">D0'</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As0'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span> <span class="main">∨</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∧</span>
      length <span class="free">As</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> maximal_wrt <span class="main">(</span><span class="free">As</span> <span class="main">!</span> <span class="main">0</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eligible <span class="keyword1"><span class="command">unfolding</span></span> eligible.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span><span class="skolem">D0'</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As0'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> negs <span class="main">(</span>mset <span class="skolem">As0'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> as0' DA0'_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> eligible.simps<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∧</span> length <span class="free">As</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span>
        maximal_wrt <span class="main">(</span><span class="free">As</span> <span class="main">!</span> <span class="main">0</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span><span class="skolem">D0'</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As0'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D0'</span> <span class="main">⋅</span> <span class="skolem">η</span> <span class="main">=</span> <span class="skolem">D</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span> <span class="main">=</span> <span class="free">As</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">(</span><span class="skolem">DA0'</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">η</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">DA</span><span class="main">)</span>›</span></span>
          da DA0'_split subst_cls_empty_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">As0'</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span> <span class="main">=</span> <span class="free">As</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maximal_wrt <span class="main">(</span><span class="skolem">As0'</span> <span class="main">!</span> <span class="main">0</span> <span class="keyword1">⋅a</span> <span class="main">(</span><span class="skolem">τ</span> <span class="main">⊙</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">D0'</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As0'</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">τ</span> <span class="main">⊙</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span> <span class="main">=</span> <span class="free">As</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D0'</span> <span class="main">⋅</span> <span class="skolem">η</span> <span class="main">=</span> <span class="skolem">D</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> l τφ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maximal_wrt <span class="main">(</span><span class="skolem">As0'</span> <span class="main">!</span> <span class="main">0</span> <span class="keyword1">⋅a</span> <span class="skolem">τ</span> <span class="keyword1">⋅a</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">D0'</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As0'</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">τ</span> <span class="main">⋅</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maximal_wrt <span class="main">(</span><span class="skolem">As0'</span> <span class="main">!</span> <span class="main">0</span> <span class="keyword1">⋅a</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">D0'</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As0'</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> maximal_wrt_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> eligible.simps<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Lifting maximality›</span>
  <span class="keyword1"><span class="command">have</span></span> maximality<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> strictly_maximal_wrt <span class="main">(</span><span class="skolem">As0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅a</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Cs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span>
    <span class="comment1">(* Reformulate in list notation? *)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> str_max <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> strictly_maximal_wrt <span class="main">(</span><span class="main">(</span><span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅a</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">Cs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">As0'</span> <span class="keyword1">⋅al</span> <span class="skolem">η</span> <span class="main">=</span> <span class="free">As</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">Cs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span> <span class="main">=</span> <span class="skolem">Cs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> strictly_maximal_wrt <span class="main">(</span><span class="skolem">As0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅a</span> <span class="main">(</span><span class="skolem">τ</span> <span class="main">⊙</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Cs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">τ</span> <span class="main">⊙</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n τφ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> strictly_maximal_wrt <span class="main">(</span><span class="skolem">As0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅a</span> <span class="skolem">τ</span> <span class="keyword1">⋅a</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Cs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="skolem">τ</span> <span class="main">⋅</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> strictly_maximal_wrt <span class="main">(</span><span class="skolem">As0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅a</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Cs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> strictly_maximal_wrt_subst τφ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Lifting nothing being selected›</span>
  <span class="keyword1"><span class="command">have</span></span> nothing_selected<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span>map <span class="free">S</span> <span class="skolem">CAs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> map <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span><span class="main">)</span> <span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹map <span class="free">S</span> <span class="skolem">CAs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span> <span class="main">=</span> map <span class="main">(</span>S_M <span class="free">S</span> <span class="free">M</span><span class="main">)</span> <span class="free">CAs</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">η</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>  <span class="main">⋅</span> <span class="skolem">η</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sel_empt <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span>  <span class="free">S</span> <span class="main">(</span><span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">η</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="free">M</span> <span class="main">(</span><span class="free">CAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subst_cls_empty_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Lifting AAs0's non-emptiness›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="skolem">AAs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n aas_not_empt <span class="quoted"><span class="quoted">‹<span class="skolem">AAs0'</span> <span class="keyword1">⋅aml</span> <span class="skolem">η</span> <span class="main">=</span> <span class="free">AAs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹Resolve the lifted clauses›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">E0'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">E0'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs0'</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D0'</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">τ</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> res_e0'<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve <span class="free">S</span> <span class="skolem">CAs0'</span> <span class="skolem">DA0'</span> <span class="skolem">AAs0'</span> <span class="skolem">As0'</span> <span class="skolem">τ</span> <span class="skolem">E0'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ord_resolve.intros<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">CAs0'</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">Cs0'</span></span> <span class="quoted"><span class="skolem">AAs0'</span></span> <span class="quoted"><span class="skolem">As0'</span></span> <span class="quoted"><span class="skolem">τ</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="skolem">D0'</span></span><span class="main">,</span>
      <span class="operator">OF</span> _ _ _ _ _ _ <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="skolem">AAs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">{#}</span>›</span></span> τφ<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eligible0'
        <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> strictly_maximal_wrt <span class="main">(</span><span class="skolem">As0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅a</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Cs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="skolem">τ</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> E0'_def <span class="keyword1"><span class="command">using</span></span> DA0'_split n <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">CAs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">Cs0'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">+</span> poss <span class="main">(</span><span class="skolem">AAs0'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="comment1">― ‹Prove resolvent instantiates to ground resolvent›</span>
  <span class="keyword1"><span class="command">have</span></span> e0'φe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E0'</span> <span class="main">⋅</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E0'</span> <span class="main">⋅</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs0'</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D0'</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">τ</span> <span class="main">⊙</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> E0'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs0'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D0'</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">η</span> <span class="main">⊙</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> τφ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="skolem">Cs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Cs0'</span> <span class="keyword1">⋅cl</span> <span class="skolem">η</span> <span class="main">=</span> <span class="skolem">Cs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D0'</span> <span class="main">⋅</span> <span class="skolem">η</span> <span class="main">=</span> <span class="skolem">D</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">E</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> e0'φe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E0'</span> <span class="main">⋅</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="free">E</span>"</span></span>
      <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Replace <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">φ</span></span><span class="antiquote">}</span></span> with a true ground substitution›</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">η2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    ground_η2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">η2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E0'</span> <span class="main">⋅</span> <span class="skolem">η2</span> <span class="main">=</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ground_cls_list <span class="free">CAs</span>"</span></span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">DA</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> grounding grounding_ground <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">E</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> res_e ground_resolvent_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_ground_cls_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span>
      <span class="keyword1"><span class="command">using</span></span> that e0'φe make_ground_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">CAs0</span> <span class="main">=</span> length <span class="free">CAs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ηs0</span> <span class="main">=</span> length <span class="free">CAs</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹Wrap up the proof›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ord_resolve <span class="free">S</span> <span class="main">(</span><span class="skolem">CAs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">DA0</span> <span class="main">⋅</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AAs0</span> <span class="keyword1">⋅⋅aml</span> <span class="skolem">ρs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">As0</span> <span class="keyword1">⋅al</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">τ</span> <span class="skolem">E0'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> res_e0' As0'_def ρ_def AAs0'_def ρs_def DA0'_def ρ_def CAs0'_def ρs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> poss <span class="main">(</span><span class="skolem">AAs0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">CAs0</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as0<span class="main">(</span>19<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negs <span class="main">(</span>mset <span class="skolem">As0</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">DA0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.as0<span class="main">(</span>15<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ord_resolve_rename <span class="free">S</span> <span class="skolem">CAs0</span> <span class="skolem">DA0</span> <span class="skolem">AAs0</span> <span class="skolem">As0</span> <span class="skolem">τ</span> <span class="skolem">E0'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ord_resolve_rename<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">CAs0</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">AAs0</span></span> <span class="quoted"><span class="skolem">As0</span></span> <span class="quoted"><span class="skolem">DA0</span></span> <span class="quoted"><span class="skolem">ρ</span></span> <span class="quoted"><span class="skolem">ρs</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="skolem">τ</span></span> <span class="quoted"><span class="skolem">E0'</span></span><span class="main">]</span> ρ_def ρs_def n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">η0</span></span> <span class="quoted"><span class="skolem">ηs0</span></span> <span class="quoted"><span class="skolem">η2</span></span> <span class="quoted"><span class="skolem">CAs0</span></span> <span class="quoted"><span class="skolem">DA0</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹is_ground_subst <span class="skolem">η0</span>›</span></span> <span class="quoted"><span class="quoted">‹is_ground_subst_list <span class="skolem">ηs0</span>›</span></span>
      <span class="quoted"><span class="quoted">‹is_ground_subst <span class="skolem">η2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">CAs0</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs0</span> <span class="main">=</span> <span class="free">CAs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">DA0</span> <span class="main">⋅</span> <span class="skolem">η0</span> <span class="main">=</span> <span class="free">DA</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">E0'</span> <span class="main">⋅</span> <span class="skolem">η2</span> <span class="main">=</span> <span class="free">E</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">DA0</span> <span class="main">∈</span> <span class="free">M</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">CA</span> <span class="main">∈</span> set <span class="skolem">CAs0</span><span class="main">.</span> <span class="bound">CA</span> <span class="main">∈</span> <span class="free">M</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">CAs0</span> <span class="main">=</span> length <span class="free">CAs</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ηs0</span> <span class="main">=</span> length <span class="free">CAs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ground_ord_resolve_ground<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    select<span class="main">:</span> <span class="quoted"><span class="quoted">"selection <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    CAs_p<span class="main">:</span> <span class="quoted"><span class="quoted">"ground_resolution_with_selection.ord_resolve <span class="free">S</span> <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ground_cas<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls_list <span class="free">CAs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ground_da<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">DA</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">E</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"atms_of <span class="free">E</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">CA</span> <span class="main">∈</span> set <span class="free">CAs</span><span class="main">.</span> atms_of <span class="bound">CA</span><span class="main">)</span> <span class="main">∪</span> atms_of <span class="free">DA</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_resolution_with_selection.ord_resolve_atms_of_concl_subset<span class="main">[</span><span class="operator">OF</span> _ CAs_p<span class="main">]</span>
      ground_resolution_with_selection.intro<span class="main">[</span><span class="operator">OF</span> select<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> literal"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∈#</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atm_of <span class="skolem">L</span> <span class="main">∈</span> atms_of <span class="free">E</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atm_of_lit_in_atms_of<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="main">(</span>atm_of <span class="skolem">L</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a1 ground_cas ground_da is_ground_cls_imp_is_ground_atm is_ground_cls_list_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_def is_ground_lit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ground_ord_resolve_imp_ord_resolve<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ground_da<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_ground_cls <span class="free">DA</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ground_cas<span class="main">:</span> <span class="quoted"><span class="quoted">‹is_ground_cls_list <span class="free">CAs</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gr<span class="main">:</span> <span class="quoted"><span class="quoted">"ground_resolution_with_selection <span class="free">S_G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gr_res<span class="main">:</span> <span class="quoted"><span class="quoted">‹ground_resolution_with_selection.ord_resolve <span class="free">S_G</span> <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="free">E</span>›</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> ord_resolve <span class="free">S_G</span> <span class="free">CAs</span> <span class="free">DA</span> <span class="free">AAs</span> <span class="free">As</span> <span class="bound">σ</span> <span class="free">E</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ground_resolution_with_selection.ord_resolve.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gr gr_res<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">CAs</span> <span class="skolem">n</span> <span class="skolem">Cs</span> <span class="skolem">AAs</span> <span class="skolem">As</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> cas <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> da <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> aas <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> as <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> e <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    cas_len <span class="main">=</span> this<span class="main">(</span>6<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cs_len <span class="main">=</span> this<span class="main">(</span>7<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> aas_len <span class="main">=</span> this<span class="main">(</span>8<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> as_len <span class="main">=</span> this<span class="main">(</span>9<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    nz <span class="main">=</span> this<span class="main">(</span>10<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> casi <span class="main">=</span> this<span class="main">(</span>11<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> aas_not_empt <span class="main">=</span> this<span class="main">(</span>12<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> as_aas <span class="main">=</span> this<span class="main">(</span>13<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    eligibility <span class="main">=</span> this<span class="main">(</span>14<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> str_max <span class="main">=</span> this<span class="main">(</span>15<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> sel_empt <span class="main">=</span> this<span class="main">(</span>16<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> len_aas_len_as<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">AAs</span> <span class="main">=</span> length <span class="skolem">As</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> aas_len as_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> as_aas <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="main">∈#</span> add_mset <span class="main">(</span><span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> card <span class="main">(</span>set_mset <span class="main">(</span>add_mset <span class="main">(</span><span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_the_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">AAs</span><span class="main">.</span> card <span class="main">(</span>set_mset <span class="main">(</span>add_mset <span class="main">(</span><span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AAs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> aas_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">AA</span> <span class="main">∈</span> set <span class="main">(</span>map2 add_mset <span class="skolem">As</span> <span class="skolem">AAs</span><span class="main">)</span><span class="main">.</span> card <span class="main">(</span>set_mset <span class="bound">AA</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_map2_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">AAs</span></span> <span class="quoted"><span class="skolem">As</span></span> <span class="quoted">add_mset</span><span class="main">,</span> <span class="operator">OF</span> len_aas_len_as<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_unifiers <span class="free">id_subst</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="skolem">As</span> <span class="skolem">AAs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_unifiers_def is_unifier_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="skolem">As</span> <span class="skolem">AAs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">AA</span> <span class="main">∈</span> set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="skolem">As</span> <span class="skolem">AAs</span><span class="main">)</span><span class="main">.</span> finite <span class="bound">AA</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    σ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="skolem">σ</span> <span class="main">=</span> <span class="free">mgu</span> <span class="main">(</span>set_mset <span class="main">`</span> set <span class="main">(</span>map2 add_mset <span class="skolem">As</span> <span class="skolem">AAs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mgu_complete <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> ground_elig<span class="main">:</span> <span class="quoted"><span class="quoted">"ground_resolution_with_selection.eligible <span class="free">S_G</span> <span class="skolem">As</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eligibility <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ground_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> is_ground_cls <span class="main">(</span><span class="skolem">Cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cas cas_len cs_len casi ground_cas nth_mem <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> ground_set_as<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atms <span class="main">(</span>set <span class="skolem">As</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> da ground_da <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atms_of_negs is_ground_cls_is_ground_atms_atms_of
        is_ground_cls_union set_mset_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ground_mset_as<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atm_mset <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_ground_atm_mset_def is_ground_atms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ground_as<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atm_list <span class="skolem">As</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_set_as is_ground_atm_list_def is_ground_atms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ground_d<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_da da <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> as_len nz <span class="keyword1"><span class="command">have</span></span> atms<span class="main">:</span>
    <span class="quoted"><span class="quoted">"atms_of <span class="skolem">D</span> <span class="main">∪</span> set <span class="skolem">As</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>atms_of <span class="skolem">D</span> <span class="main">∪</span> set <span class="skolem">As</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>atms_of <span class="skolem">D</span> <span class="main">∪</span> set <span class="skolem">As</span><span class="main">)</span> <span class="main">∈</span> atms_of <span class="skolem">D</span> <span class="main">∪</span> set <span class="skolem">As</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_ground_Max<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_atm <span class="main">(</span>Max <span class="main">(</span>atms_of <span class="skolem">D</span> <span class="main">∪</span> set <span class="skolem">As</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_d ground_mset_as is_ground_cls_imp_is_ground_atm
    <span class="keyword1"><span class="command">unfolding</span></span> is_ground_atm_mset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maximal_wrt <span class="main">(</span>Max <span class="main">(</span>atms_of <span class="skolem">D</span> <span class="main">∪</span> set <span class="skolem">As</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> maximal_wrt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> atms Max_less_iff UnCI ground_d ground_set_as infinite_growing
        is_ground_Max is_ground_atms_def is_ground_cls_imp_is_ground_atm less_atm_ground<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"Max <span class="main">(</span>atms_of <span class="skolem">D</span> <span class="main">∪</span> set <span class="skolem">As</span><span class="main">)</span> <span class="keyword1">⋅a</span> <span class="skolem">σ</span> <span class="main">=</span> Max <span class="main">(</span>atms_of <span class="skolem">D</span> <span class="main">∪</span> set <span class="skolem">As</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As</span> <span class="keyword1">⋅am</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_elig is_ground_Max ground_mset_as ground_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> fo_elig<span class="main">:</span> <span class="quoted"><span class="quoted">"eligible <span class="free">S_G</span> <span class="skolem">σ</span> <span class="skolem">As</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">+</span> negs <span class="main">(</span>mset <span class="skolem">As</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_elig <span class="keyword1"><span class="command">unfolding</span></span> ground_resolution_with_selection.eligible.simps<span class="main">[</span><span class="operator">OF</span> gr<span class="main">]</span>
      ground_resolution_with_selection.maximal_wrt_def<span class="main">[</span><span class="operator">OF</span> gr<span class="main">]</span> eligible.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> strictly_maximal_wrt <span class="main">(</span><span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> str_max<span class="main">[</span><span class="operator">unfolded</span> ground_resolution_with_selection.strictly_maximal_wrt_def<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gr<span class="main"><span class="main">]</span></span><span class="main">]</span>
      ground_as<span class="main">[</span><span class="operator">unfolded</span> is_ground_atm_list_def<span class="main">]</span> ground_cs as_len less_atm_ground
    <span class="keyword1"><span class="command">unfolding</span></span> strictly_maximal_wrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_ground_cls_as_atms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> strictly_maximal_wrt <span class="main">(</span><span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅a</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ground_as ground_cs as_len<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> ground_e<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_d ground_cs cs_len <span class="keyword1"><span class="command">unfolding</span></span> e is_ground_cls_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> in_mset_sum_list2 in_set_conv_nth<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cas da aas as e ground_e ord_resolve.intros<span class="main">[</span><span class="operator">OF</span> cas_len cs_len aas_len as_len nz casi
        aas_not_empt σ_p fo_elig ll sel_empt<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FO_Ordered_Resolution_Prover">
<div class="head">
<h1>Theory FO_Ordered_Resolution_Prover</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       An Ordered Resolution Prover for First-Order Clauses
    Author:      Anders Schlichtkrull &lt;andschl at dtu.dk&gt;, 2016, 2017
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2014, 2017
    Author:      Dmitriy Traytel &lt;traytel at inf.ethz.ch&gt;, 2014
    Maintainer:  Anders Schlichtkrull &lt;andschl at dtu.dk&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹An Ordered Resolution Prover for First-Order Clauses›</span></span>

<span class="keyword1"><span class="command">theory</span></span> FO_Ordered_Resolution_Prover
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="FO_Ordered_Resolution.html">FO_Ordered_Resolution</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This material is based on Section 4.3 (``A Simple Resolution Prover for First-Order Clauses'') of
Bachmair and Ganzinger's chapter. Specifically, it formalizes the RP prover defined in Figure 5 and
its related lemmas and theorems, including Lemmas 4.10 and 4.11 and Theorem 4.13 (completeness).
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_least</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_least</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n'</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">n'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> least_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> is_least <span class="free">P</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exists_least_iff <span class="keyword1"><span class="command">unfolding</span></span> is_least_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following corresponds to page 42 and 43 of Section 4.3, from the explanation of RP to
Lemma 4.10.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">×</span> <span class="tfree">'a</span> clause set <span class="main">×</span> <span class="tfree">'a</span> clause set"</span></span>

<span class="keyword1"><span class="command">locale</span></span> FO_resolution_prover <span class="main">=</span>
  FO_resolution <span class="quoted"><span class="free">subst_atm</span></span> <span class="quoted"><span class="free">id_subst</span></span> <span class="quoted"><span class="free">comp_subst</span></span> <span class="quoted"><span class="free">renamings_apart</span></span> <span class="quoted"><span class="free">atm_of_atms</span></span> <span class="quoted"><span class="free">mgu</span></span> <span class="quoted"><span class="free">less_atm</span></span> <span class="main">+</span>
  selection <span class="quoted"><span class="free">S</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wellorder<span class="main">)</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">subst_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">id_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">comp_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">renamings_apart</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause list <span class="main">⇒</span> <span class="tfree">'s</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">atm_of_atms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">mgu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'s</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">less_atm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    sel_stable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ</span> <span class="bound">C</span><span class="main">.</span> is_renaming <span class="bound">ρ</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span><span class="bound">C</span> <span class="main">⋅</span> <span class="bound">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="bound">C</span> <span class="main">⋅</span> <span class="bound">ρ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">N_of_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">N_of_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P_of_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P_of_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>O›</span></span></span></span> denotes relation composition in Isabelle, so the formalization uses <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Q›</span></span></span></span> instead.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Q_of_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q_of_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">clss_of_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clss_of_state</span> <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">≡</span> N_of_state <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">∪</span> P_of_state <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">∪</span> Q_of_state <span class="free"><span class="bound"><span class="entity">St</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">grounding_of_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> clause set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">grounding_of_state</span> <span class="free"><span class="bound"><span class="entity">St</span></span></span> <span class="main">≡</span> grounding_of_clss <span class="main">(</span>clss_of_state <span class="free"><span class="bound"><span class="entity">St</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> ord_FO_resolution<span class="main">:</span> inference_system <span class="quoted"><span class="quoted">"ord_FO_Γ <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following inductive predicate formalizes the resolution prover in Figure 5.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">RP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↝</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  tautology_deletion<span class="main">:</span> <span class="quoted"><span class="quoted">"Neg <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span> Pos <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> forward_subsumption<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span> subsumes <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> backward_subsumption_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⟹</span> strictly_subsumes <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> backward_subsumption_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⟹</span> strictly_subsumes <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> forward_reduction<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L'</span></span></span><span class="main">#}</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">L'</span></span></span> <span class="keyword1">⋅l</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">#}</span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> backward_reduction_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L'</span></span></span><span class="main">#}</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⟹</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">L'</span></span></span> <span class="keyword1">⋅l</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">#}</span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> backward_reduction_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L'</span></span></span><span class="main">#}</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">⟹</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">L'</span></span></span> <span class="keyword1">⋅l</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">#}</span><span class="main">}</span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> clause_processing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> inference_computation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> concls_of <span class="main">(</span>ord_FO_resolution.inferences_between <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> final_RP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="free">Q</span><span class="main">)</span> <span class="main">↝</span> <span class="free">St</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> RP.cases<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Sup_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state llist <span class="main">⇒</span> <span class="tfree">'a</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Sup_state</span> <span class="free"><span class="bound"><span class="entity">Sts</span></span></span> <span class="main">=</span>
   <span class="main">(</span>Sup_llist <span class="main">(</span>lmap N_of_state <span class="free"><span class="bound"><span class="entity">Sts</span></span></span><span class="main">)</span><span class="main">,</span> Sup_llist <span class="main">(</span>lmap P_of_state <span class="free"><span class="bound"><span class="entity">Sts</span></span></span><span class="main">)</span><span class="main">,</span>
    Sup_llist <span class="main">(</span>lmap Q_of_state <span class="free"><span class="bound"><span class="entity">Sts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Liminf_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state llist <span class="main">⇒</span> <span class="tfree">'a</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Liminf_state</span> <span class="free"><span class="bound"><span class="entity">Sts</span></span></span> <span class="main">=</span>
   <span class="main">(</span>Liminf_llist <span class="main">(</span>lmap N_of_state <span class="free"><span class="bound"><span class="entity">Sts</span></span></span><span class="main">)</span><span class="main">,</span> Liminf_llist <span class="main">(</span>lmap P_of_state <span class="free"><span class="bound"><span class="entity">Sts</span></span></span><span class="main">)</span><span class="main">,</span>
    Liminf_llist <span class="main">(</span>lmap Q_of_state <span class="free"><span class="bound"><span class="entity">Sts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Sts</span> <span class="free">Sts'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state llist"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Sts<span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">Sts</span>"</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">Sts'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="free">Sts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="free">Sts'</span>"</span></span> <span class="quoted"><span class="quoted">"llast <span class="free">Sts'</span> <span class="main">=</span> llast <span class="free">Sts</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  N_of_Liminf_state_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"N_of_state <span class="main">(</span>Liminf_state <span class="free">Sts'</span><span class="main">)</span> <span class="main">=</span> N_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  P_of_Liminf_state_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"P_of_state <span class="main">(</span>Liminf_state <span class="free">Sts'</span><span class="main">)</span> <span class="main">=</span> P_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  Q_of_Liminf_state_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts'</span><span class="main">)</span> <span class="main">=</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Sts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Liminf_state_def lfinite_Liminf_llist llast_lmap<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_state_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"Liminf_state <span class="free">Sts'</span> <span class="main">=</span> Liminf_state <span class="free">Sts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> N_of_Liminf_state_fin P_of_Liminf_state_fin Q_of_Liminf_state_fin
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Liminf_state_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Sts</span> <span class="free">Sts'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state llist"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Sts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lfinite <span class="free">Sts</span>"</span></span> <span class="quoted"><span class="quoted">"emb <span class="free">Sts</span> <span class="free">Sts'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  N_of_Liminf_state_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"N_of_state <span class="main">(</span>Liminf_state <span class="free">Sts'</span><span class="main">)</span> <span class="main">⊆</span> N_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  P_of_Liminf_state_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"P_of_state <span class="main">(</span>Liminf_state <span class="free">Sts'</span><span class="main">)</span> <span class="main">⊆</span> P_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  Q_of_Liminf_state_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts'</span><span class="main">)</span> <span class="main">⊆</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Sts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Liminf_state_def emb_Liminf_llist_infinite emb_lmap<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> clss_of_Liminf_state_inf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"clss_of_state <span class="main">(</span>Liminf_state <span class="free">Sts'</span><span class="main">)</span> <span class="main">⊆</span> clss_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> N_of_Liminf_state_inf P_of_Liminf_state_inf Q_of_Liminf_state_inf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fair_state_seq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state llist <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fair_state_seq</span> <span class="free"><span class="bound"><span class="entity">Sts</span></span></span> <span class="main">⟷</span> N_of_state <span class="main">(</span>Liminf_state <span class="free"><span class="bound"><span class="entity">Sts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> P_of_state <span class="main">(</span>Liminf_state <span class="free"><span class="bound"><span class="entity">Sts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following formalizes Lemma 4.10.
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Sts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state llist"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S_Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause <span class="main">⇒</span> <span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S_Q</span> <span class="main">=</span> S_M <span class="free">S</span> <span class="main">(</span>Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> sq<span class="main">:</span> selection <span class="quoted">S_Q</span>
  <span class="keyword1"><span class="command">unfolding</span></span> S_Q_def <span class="keyword1"><span class="command">using</span></span> S_M_selects_subseteq S_M_selects_neg_lits selection_axioms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> gr<span class="main">:</span> ground_resolution_with_selection <span class="quoted">S_Q</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">interpretation</span></span> sr<span class="main">:</span> standard_redundancy_criterion_reductive <span class="quoted">gr.ord_Γ</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">interpretation</span></span> sr<span class="main">:</span> standard_redundancy_criterion_counterex_reducing <span class="quoted">gr.ord_Γ</span>
  <span class="quoted"><span class="quoted">"ground_resolution_with_selection.INTERP S_Q"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The extension of ordered resolution mentioned in 4.10. We let it consist of all sound rules.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ground_sound_Γ</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> inference set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ground_sound_Γ</span> <span class="main">=</span> <span class="main">{</span>Infer <span class="bound">CC</span> <span class="bound">D</span> <span class="bound">E</span> <span class="main">|</span> <span class="bound">CC</span> <span class="bound">D</span> <span class="bound">E</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">CC</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="bound">D</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="bound">E</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We prove that we indeed defined an extension.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gd_ord_Γ_ngd_ord_Γ<span class="main">:</span> <span class="quoted"><span class="quoted">"gr.ord_Γ <span class="main">⊆</span> ground_sound_Γ"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ground_sound_Γ_def <span class="keyword1"><span class="command">using</span></span> gr.ord_Γ_def gr.ord_resolve_sound <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sound_ground_sound_Γ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound_inference_system ground_sound_Γ"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sound_inference_system_def ground_sound_Γ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_preserving_ground_sound_Γ<span class="main">:</span> <span class="quoted"><span class="quoted">"sat_preserving_inference_system ground_sound_Γ"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sound_ground_sound_Γ sat_preserving_inference_system.intro
    sound_inference_system.Γ_sat_preserving <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sr_ext_Ri</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set <span class="main">⇒</span> <span class="tfree">'a</span> inference set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sr_ext_Ri</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> sr.Ri <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∪</span> <span class="main">(</span>ground_sound_Γ <span class="main">-</span> gr.ord_Γ<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> sr_ext<span class="main">:</span>
  sat_preserving_redundancy_criterion <span class="quoted">ground_sound_Γ</span> <span class="quoted">sr.Rf</span> <span class="quoted">sr_ext_Ri</span>
  <span class="keyword1"><span class="command">unfolding</span></span> sat_preserving_redundancy_criterion_def sr_ext_Ri_def
  <span class="keyword1"><span class="command">using</span></span> sat_preserving_ground_sound_Γ redundancy_criterion_standard_extension gd_ord_Γ_ngd_ord_Γ
    sr.redundancy_criterion_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> strict_subset_subsumption_redundant_clause<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊂#</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ground_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> sr.Rf <span class="main">(</span>grounding_of_cls <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sub <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> true_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">&gt;</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_imp_less_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">∈</span> grounding_of_cls <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_σ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> mem_Collect_eq substitution_ops.grounding_of_cls_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">{#</span><span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">#}</span> <span class="main">⊆</span> grounding_of_cls <span class="free">D</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="main">{#</span><span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">#}</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">C</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">D'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈#</span> <span class="main">{#</span><span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">#}</span> <span class="main">⟶</span> <span class="bound">D'</span> <span class="main">&lt;</span> <span class="free">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sr.Rf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strict_subset_subsumption_redundant_clss<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊂#</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"is_ground_subst <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="free">CC</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> sr.Rf <span class="main">(</span>grounding_of_clss <span class="free">CC</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> sr.Rf <span class="main">(</span>grounding_of_cls <span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> strict_subset_subsumption_redundant_clause assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> sr.Rf_mono sup_ge1 SUP_absorb contra_subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strict_subset_subsumption_grounding_redundant_clss<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    Dσ_subset_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊂#</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D_in_St<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="free">CC</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"grounding_of_cls <span class="free">C</span> <span class="main">⊆</span> sr.Rf <span class="main">(</span>grounding_of_clss <span class="free">CC</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Cμ</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cμ</span> <span class="main">∈</span> grounding_of_cls <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    μ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Cμ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">∧</span> is_ground_subst <span class="skolem">μ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> DσμCμ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">⊂#</span> <span class="free">C</span> <span class="main">⋅</span> <span class="skolem">μ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Dσ_subset_C subst_subset_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cμ</span> <span class="main">∈</span> sr.Rf <span class="main">(</span>grounding_of_clss <span class="free">CC</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> μ_p strict_subset_subsumption_redundant_clss<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">⊙</span> <span class="skolem">μ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⋅</span> <span class="skolem">μ</span>"</span></span><span class="main">]</span> D_in_St <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derive_if_remove_subsumed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> clss_of_state <span class="free">St</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"subsumes <span class="free">D</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sr_ext.derive <span class="main">(</span>grounding_of_state <span class="free">St</span> <span class="main">∪</span> grounding_of_cls <span class="free">C</span><span class="main">)</span> <span class="main">(</span>grounding_of_state <span class="free">St</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∨</span> <span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⊂#</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subsumes_def subset_mset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∨</span> <span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⊂#</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_mset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"grounding_of_cls <span class="free">C</span> <span class="main">⊆</span> grounding_of_cls <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subst_cls_eq_grounding_of_cls_subset_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>grounding_of_state <span class="free">St</span> <span class="main">∪</span> grounding_of_cls <span class="free">C</span><span class="main">)</span> <span class="main">=</span> grounding_of_state <span class="free">St</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sr_ext.derive.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⊂#</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"grounding_of_cls <span class="free">C</span> <span class="main">⊆</span> sr.Rf <span class="main">(</span>grounding_of_state <span class="free">St</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> strict_subset_subsumption_grounding_redundant_clss assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sr_ext.derive.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reduction_in_concls_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Cμ</span> <span class="main">∈</span> grounding_of_cls <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L'</span><span class="main">#}</span> <span class="main">∈</span> <span class="free">CC</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">L</span> <span class="main">=</span> <span class="free">L'</span> <span class="keyword1">⋅l</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊆#</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Cμ</span> <span class="main">∈</span> concls_of <span class="main">(</span>sr_ext.inferences_from <span class="main">(</span>grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    μ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Cμ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">∧</span> is_ground_subst <span class="skolem">μ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">=</span> Infer <span class="main">{#</span><span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">μ</span><span class="main">#}</span> <span class="main">(</span><span class="main">(</span><span class="free">D</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L'</span><span class="main">#}</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">⋅</span> <span class="skolem">μ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L'</span><span class="main">#}</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">∈</span> grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def grounding_of_cls_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> UN_I<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">D</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="main"><span class="main"><span class="main">{#</span></span></span><span class="free"><span class="free"><span class="free">L'</span></span></span><span class="main"><span class="main"><span class="main">#}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> μ_p is_ground_comp_subst mem_Collect_eq subst_cls_comp_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">∈</span> grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> μ_p <span class="keyword1"><span class="command">unfolding</span></span>  grounding_of_clss_def grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">+</span> <span class="main">{#</span><span class="main">-</span> <span class="main">(</span><span class="free">L</span>  <span class="keyword1">⋅l</span> <span class="skolem">μ</span><span class="main">)</span><span class="main">#}</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">C</span>  <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span>  <span class="keyword1">⋅l</span> <span class="skolem">μ</span><span class="main">#}</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">+</span> <span class="free">C</span> <span class="main">⋅</span> <span class="skolem">μ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L'</span><span class="main">#}</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">+</span> <span class="free">C</span> <span class="main">⋅</span> <span class="skolem">μ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_add_single subst_cls_add_mset subst_cls_union subst_minus<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">D</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L'</span><span class="main">#}</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⋅</span> <span class="skolem">μ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> subset_mset.le_iff_add subst_cls_union true_cls_union<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="main">{#</span><span class="main">(</span><span class="free">D</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L'</span><span class="main">#}</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span><span class="main">#}</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="free">C</span> <span class="main">⋅</span> <span class="skolem">μ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> true_cls_mset_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> sr_ext.inferences_from <span class="main">(</span>grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sr_ext.inferences_from_def <span class="keyword1"><span class="command">unfolding</span></span> ground_sound_Γ_def infer_from_def γ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">∈</span> concls_of <span class="main">(</span>sr_ext.inferences_from <span class="main">(</span>grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> image_iff <span class="keyword1"><span class="command">unfolding</span></span> γ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Cμ</span> <span class="main">∈</span> concls_of <span class="main">(</span>sr_ext.inferences_from <span class="main">(</span>grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> μ_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reduction_derivable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L'</span><span class="main">#}</span> <span class="main">∈</span> <span class="free">CC</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">L</span> <span class="main">=</span> <span class="free">L'</span> <span class="keyword1">⋅l</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊆#</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sr_ext.derive <span class="main">(</span>grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">}</span><span class="main">)</span>
    <span class="main">⊆</span> concls_of <span class="main">(</span>sr_ext.inferences_from <span class="main">(</span>grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_in_concls_of <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"grounding_of_cls <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">)</span> <span class="main">⊆</span> sr.Rf <span class="main">(</span>grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> strict_subset_subsumption_grounding_redundant_clss<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"<span class="free">id_subst</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span><span class="main">)</span>
    <span class="main">⊆</span> sr.Rf <span class="main">(</span>grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"sr_ext.derive <span class="main">(</span>grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sr_ext.derive.intros<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"grounding_of_clss <span class="main">(</span><span class="free">CC</span> <span class="main">∪</span> <span class="main">{</span><span class="free">C</span> <span class="main">+</span> <span class="main">{#</span><span class="free">L</span><span class="main">#}</span><span class="main">}</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following corresponds the part of Lemma 4.10 that states we have a theorem proving process:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RP_ground_derive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">St</span> <span class="main">↝</span> <span class="free">St'</span> <span class="main">⟹</span> sr_ext.derive <span class="main">(</span>grounding_of_state <span class="free">St</span><span class="main">)</span> <span class="main">(</span>grounding_of_state <span class="free">St'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> RP.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tautology_deletion <span class="skolem">A</span> <span class="skolem">C</span> <span class="skolem">N</span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Cσ</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cσ</span> <span class="main">∈</span> grounding_of_cls <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">Cσ</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">⋅</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Neg <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">⋅a</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">Cσ</span> <span class="main">∧</span> Pos <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">⋅a</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">∈#</span> <span class="skolem">Cσ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tautology_deletion Neg_Melem_subst_atm_subst_cls Pos_Melem_subst_atm_subst_cls <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cσ</span> <span class="main">∈</span> sr.Rf <span class="main">(</span>grounding_of_state <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sr.tautology_Rf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"grounding_of_state <span class="main">(</span><span class="skolem">N</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">-</span> grounding_of_state <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span>
    <span class="main">⊆</span> sr.Rf <span class="main">(</span>grounding_of_state <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"grounding_of_state <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">-</span> grounding_of_state <span class="main">(</span><span class="skolem">N</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sr_ext.derive.intros<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"grounding_of_state <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"grounding_of_state <span class="main">(</span><span class="skolem">N</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>forward_subsumption <span class="skolem">D</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">C</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> derive_if_remove_subsumed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">D</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_commute sup_left_commute<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>backward_subsumption_P <span class="skolem">D</span> <span class="skolem">N</span> <span class="skolem">C</span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> derive_if_remove_subsumed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">D</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> strictly_subsumes_def
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_commute sup_left_commute<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>backward_subsumption_Q <span class="skolem">D</span> <span class="skolem">N</span> <span class="skolem">C</span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> derive_if_remove_subsumed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">D</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> strictly_subsumes_def
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_commute sup_left_commute<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>forward_reduction <span class="skolem">D</span> <span class="skolem">L'</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">L</span> <span class="skolem">σ</span> <span class="skolem">C</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_derivable<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">∪</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="skolem">Q</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>backward_reduction_P <span class="skolem">D</span> <span class="skolem">L'</span> <span class="skolem">N</span> <span class="skolem">L</span> <span class="skolem">σ</span> <span class="skolem">C</span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_derivable<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">∪</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="skolem">Q</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>backward_reduction_Q <span class="skolem">D</span> <span class="skolem">L'</span> <span class="skolem">N</span> <span class="skolem">L</span> <span class="skolem">σ</span> <span class="skolem">C</span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_derivable<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">∪</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="skolem">Q</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>clause_processing <span class="skolem">N</span> <span class="skolem">C</span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sr_ext.derive.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>inference_computation <span class="skolem">N</span> <span class="skolem">Q</span> <span class="skolem">C</span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Eμ</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Eμ</span> <span class="main">∈</span> grounding_of_clss <span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μ</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      E_μ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Eμ</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">∧</span> <span class="skolem">E</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">∧</span> is_ground_subst <span class="skolem">μ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> E_concl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> concls_of <span class="main">(</span>ord_FO_resolution.inferences_between <span class="skolem">Q</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inference_computation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      γ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> ord_FO_Γ <span class="free">S</span> <span class="main">∧</span> infer_from <span class="main">(</span><span class="skolem">Q</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">)</span> <span class="skolem">γ</span> <span class="main">∧</span> <span class="skolem">C</span> <span class="main">∈#</span> prems_of <span class="skolem">γ</span> <span class="main">∧</span> concl_of <span class="skolem">γ</span> <span class="main">=</span> <span class="skolem">E</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ord_FO_resolution.inferences_between_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">CC</span></span> <span class="skolem"><span class="skolem">CAs</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">AAs</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      γ_p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">=</span> Infer <span class="skolem">CC</span> <span class="skolem">D</span> <span class="skolem">E</span> <span class="main">∧</span> ord_resolve_rename <span class="free">S</span> <span class="skolem">CAs</span> <span class="skolem">D</span> <span class="skolem">AAs</span> <span class="skolem">As</span> <span class="skolem">σ</span> <span class="skolem">E</span> <span class="main">∧</span> mset <span class="skolem">CAs</span> <span class="main">=</span> <span class="skolem">CC</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ord_FO_Γ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">=</span> hd <span class="main">(</span><span class="free">renamings_apart</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">#</span> <span class="skolem">CAs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ρs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ρs</span> <span class="main">=</span> tl <span class="main">(</span><span class="free">renamings_apart</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">#</span> <span class="skolem">CAs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">γ_ground</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">γ_ground</span> <span class="main">=</span> Infer <span class="main">(</span>mset <span class="main">(</span><span class="skolem">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span><span class="main">)</span> <span class="keyword1">⋅cm</span> <span class="skolem">σ</span> <span class="keyword1">⋅cm</span> <span class="skolem">μ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⋅</span> <span class="skolem">ρ</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">E</span> <span class="main">⋅</span> <span class="skolem">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> mset <span class="main">(</span><span class="skolem">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span><span class="main">)</span> <span class="keyword1">⋅cm</span> <span class="skolem">σ</span> <span class="keyword1">⋅cm</span> <span class="skolem">μ</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="skolem">D</span> <span class="main">⋅</span> <span class="skolem">ρ</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="skolem">E</span> <span class="main">⋅</span> <span class="skolem">μ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ord_resolve_rename_ground_inst_sound<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">μ</span></span><span class="main">]</span> ρ_def ρs_def E_μ_p γ_p2
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ_ground</span> <span class="main">∈</span> <span class="main">{</span>Infer <span class="bound">cc</span> <span class="bound">d</span> <span class="bound">e</span> <span class="main">|</span> <span class="bound">cc</span> <span class="bound">d</span> <span class="bound">e</span><span class="main">.</span> <span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="keyword1">⊨m</span> <span class="bound">cc</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="bound">d</span> <span class="main">⟶</span> <span class="bound">I</span> <span class="main">⊨</span> <span class="bound">e</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> γ_ground_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>prems_of <span class="skolem">γ_ground</span><span class="main">)</span> <span class="main">⊆</span> grounding_of_state <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">∨</span> <span class="skolem">D</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> γ_ground_def <span class="keyword1"><span class="command">using</span></span> E_μ_p γ_p2 γ_p <span class="keyword1"><span class="command">unfolding</span></span> infer_from_def
        <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">⋅</span> <span class="skolem">ρ</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">∈</span> grounding_of_cls <span class="skolem">C</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">Q</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">⋅</span> <span class="skolem">ρ</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">∈</span> grounding_of_cls <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> E_μ_p
        <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_cls_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> is_ground_comp_subst mem_Collect_eq subst_cls_comp_subst<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span> <span class="main">⋅</span> <span class="skolem">ρ</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">∈</span> grounding_of_cls <span class="skolem">C</span> <span class="main">∨</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">⋅</span> <span class="skolem">ρ</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">∈</span> grounding_of_cls <span class="bound">x</span><span class="main">)</span> <span class="main">∨</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">Q</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">⋅</span> <span class="skolem">ρ</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">∈</span> grounding_of_cls <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span> <span class="keyword1">⋅cl</span> <span class="skolem">σ</span> <span class="keyword1">⋅cl</span> <span class="skolem">μ</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="skolem">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span> <span class="keyword1">⋅cl</span> <span class="skolem">σ</span> <span class="keyword1">⋅cl</span> <span class="skolem">μ</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span>
        <span class="main">{</span><span class="skolem">C</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span> <span class="main">∪</span>
        <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">.</span> <span class="main">{</span><span class="bound">C</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span> <span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> <span class="main">{</span><span class="bound">C</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span> <span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span> <span class="keyword1">⋅cl</span> <span class="skolem">σ</span> <span class="keyword1">⋅cl</span> <span class="skolem">μ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">CAs</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ρs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CAs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">Q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> γ_p2 γ_p <span class="keyword1"><span class="command">unfolding</span></span> infer_from_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Un_subset_iff inference.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_mset_union
              sup_commute nth_mem_mset subsetCE<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span> <span class="keyword1">⋅cl</span> <span class="skolem">σ</span> <span class="keyword1">⋅cl</span> <span class="skolem">μ</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span>
          <span class="main">{</span><span class="skolem">C</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span> <span class="main">∨</span>
          <span class="main">(</span><span class="main">(</span><span class="skolem">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span> <span class="keyword1">⋅cl</span> <span class="skolem">σ</span> <span class="keyword1">⋅cl</span> <span class="skolem">μ</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="main">{</span><span class="bound">C</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span><span class="main">)</span> <span class="main">∨</span>
          <span class="main">(</span><span class="skolem">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span> <span class="keyword1">⋅cl</span> <span class="skolem">σ</span> <span class="keyword1">⋅cl</span> <span class="skolem">μ</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="skolem">Q</span><span class="main">.</span> <span class="main">{</span><span class="bound">C</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span> <span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> E_μ_p γ_p2 γ_p
          <span class="keyword1"><span class="command">unfolding</span></span> γ_ground_def infer_from_def grounding_of_clss_def grounding_of_cls_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">CAs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Set.CollectI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ρs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊙</span> <span class="skolem">σ</span> <span class="main">⊙</span> <span class="skolem">μ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> ρs_def <span class="keyword1"><span class="command">using</span></span> renamings_apart_length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CAs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> UN_I<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Set.CollectI<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ρs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊙</span> <span class="skolem">σ</span> <span class="main">⊙</span> <span class="skolem">μ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> ρs_def <span class="keyword1"><span class="command">using</span></span> renamings_apart_length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span> <span class="keyword1">⋅cl</span> <span class="skolem">σ</span> <span class="keyword1">⋅cl</span> <span class="skolem">μ</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">C</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span> <span class="main">∪</span>
          <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">.</span> <span class="main">{</span><span class="bound">C</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="skolem">Q</span><span class="main">.</span> <span class="main">{</span><span class="bound">C</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈#</span> mset <span class="main">(</span><span class="skolem">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span> <span class="keyword1">⋅cl</span> <span class="skolem">σ</span> <span class="keyword1">⋅cl</span> <span class="skolem">μ</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">C</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span> <span class="main">∪</span>
        <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">.</span> <span class="main">{</span><span class="bound">C</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">C</span> <span class="main">∈</span> <span class="skolem">Q</span><span class="main">.</span> <span class="main">{</span><span class="bound">C</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">|</span><span class="bound">σ</span><span class="main">.</span> is_ground_subst <span class="bound">σ</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> in_set_conv_nth set_mset_mset<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>mset <span class="main">(</span><span class="skolem">CAs</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ρs</span><span class="main">)</span> <span class="keyword1">⋅cm</span> <span class="skolem">σ</span> <span class="keyword1">⋅cm</span> <span class="skolem">μ</span><span class="main">)</span> <span class="main">⊆</span>
        grounding_of_cls <span class="skolem">C</span> <span class="main">∪</span> grounding_of_clss <span class="skolem">P</span> <span class="main">∪</span> grounding_of_clss <span class="skolem">Q</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_cls_def grounding_of_clss_def
        <span class="keyword1"><span class="command">using</span></span> mset_subst_cls_list_subst_cls_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> γ_ground_def grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">⋅</span> <span class="skolem">μ</span> <span class="main">∈</span> concls_of <span class="main">(</span>sr_ext.inferences_from <span class="main">(</span>grounding_of_state <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sr_ext.inferences_from_def inference_system.inferences_from_def ground_sound_Γ_def
        infer_from_def
      <span class="keyword1"><span class="command">using</span></span> γ_ground_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_eqI inference.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Eμ</span> <span class="main">∈</span> concls_of <span class="main">(</span>sr_ext.inferences_from <span class="main">(</span>grounding_of_state <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E_μ_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"grounding_of_state <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> grounding_of_state <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span>
    <span class="main">⊆</span> concls_of <span class="main">(</span>sr_ext.inferences_from <span class="main">(</span>grounding_of_state <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"grounding_of_state <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">-</span> grounding_of_state <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sr_ext.derive.intros<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>grounding_of_state <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span>grounding_of_state <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C</span><span class="main">}</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A useful consequence:
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> RP_model<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">St</span> <span class="main">↝</span> <span class="free">St'</span> <span class="main">⟹</span> <span class="free">I</span> <span class="keyword1">⊨s</span> grounding_of_state <span class="free">St'</span> <span class="main">⟷</span> <span class="free">I</span> <span class="keyword1">⊨s</span> grounding_of_state <span class="free">St</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">drule</span> RP_ground_derive<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> sr_ext.derive.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">hypsubst</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span>
    <span class="var"><span class="quoted"><span class="var">?gSt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"grounding_of_state <span class="free">St</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="var"><span class="quoted"><span class="var">?gSt'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"grounding_of_state <span class="free">St'</span>"</span></span>

  <span class="keyword3"><span class="command">assume</span></span>
    deduct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gSt'</span> <span class="main">-</span> <span class="var">?gSt</span> <span class="main">⊆</span> concls_of <span class="main">(</span>sr_ext.inferences_from <span class="var">?gSt</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="var">?concls</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    delete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gSt</span> <span class="main">-</span> <span class="var">?gSt'</span> <span class="main">⊆</span> sr.Rf <span class="var">?gSt'</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="var">?gSt'</span> <span class="main">⟷</span> <span class="free">I</span> <span class="keyword1">⊨s</span> <span class="var">?gSt</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="var">?gSt</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="var">?concls</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ground_sound_Γ_def inference_system.inferences_from_def true_clss_def
        true_cls_mset_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def infer_from_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="var">?gSt'</span> <span class="main">-</span> <span class="var">?gSt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> deduct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> true_clss_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="var">?gSt'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bef <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> aft<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="var">?gSt'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="var">?gSt'</span> <span class="main">∪</span> sr.Rf <span class="var">?gSt'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sr.Rf_model<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> Diff_eq_empty_iff Diff_subset Un_Diff aft
          standard_redundancy_criterion.Rf_mono sup_bot.right_neutral sup_ge1 true_clss_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> sr.Rf <span class="var">?gSt'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> true_clss_union <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="var">?gSt</span> <span class="main">-</span> <span class="var">?gSt'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> delete <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> true_clss_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="keyword1">⊨s</span> <span class="var">?gSt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> aft <span class="keyword1"><span class="command">unfolding</span></span> true_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Another formulation of the part of Lemma 4.10 that states we have a theorem proving process:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ground_derive_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(↝)</span> <span class="free">Sts</span> <span class="main">⟹</span> chain sr_ext.derive <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> RP_ground_derive <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chain_lmap<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(↝)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following is used prove to Lemma 4.11:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Sup_llist_grounding_of_state_ground<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> Sup_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span>
    <span class="main">∧</span> <span class="free">C</span> <span class="main">∈</span> lnth <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Sup_llist_imp_exists_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Liminf_grounding_of_state_ground<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span> <span class="main">⟹</span> is_ground_cls <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Liminf_llist_subset_Sup_llist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lmap grounding_of_state <span class="free">Sts</span>"</span></span><span class="main">]</span>
    Sup_llist_grounding_of_state_ground
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> in_Sup_llist_in_Sup_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> Sup_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="bound">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    i_p<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">∧</span> <span class="free">C</span> <span class="main">∈</span> lnth <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Sup_llist_imp_exists_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_p <span class="keyword1"><span class="command">unfolding</span></span> Sup_state_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnCI UnE contra_subsetD N_of_state.simps P_of_state.simps
        Q_of_state.simps llength_lmap lnth_lmap lnth_subset_Sup_llist<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  N_of_state_Liminf<span class="main">:</span> <span class="quoted"><span class="quoted">"N_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span> <span class="main">=</span> Liminf_llist <span class="main">(</span>lmap N_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  P_of_state_Liminf<span class="main">:</span> <span class="quoted"><span class="quoted">"P_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span> <span class="main">=</span> Liminf_llist <span class="main">(</span>lmap P_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Liminf_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_removed_from_N<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    d_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair_state_seq <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    i_Sts<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">D</span> <span class="main">∈</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span> <span class="free">D</span> <span class="main">∉</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">l</span>
    <span class="main">∧</span> enat <span class="main">(</span>Suc <span class="bound">l</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">l</span> <span class="main">⟹</span> enat <span class="skolem">l</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">∈</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span>
    <span class="keyword1"><span class="command">using</span></span> d_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> a Suc_ile_eq le_SucE less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap N_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">using</span></span> i_Sts <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> fair <span class="keyword1"><span class="command">unfolding</span></span> fair_state_seq_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N_of_state_Liminf<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_removed_from_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    d_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair_state_seq <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    i_Sts<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">D</span> <span class="main">∈</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span> <span class="free">D</span> <span class="main">∉</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">l</span>
    <span class="main">∧</span> enat <span class="main">(</span>Suc <span class="bound">l</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">l</span> <span class="main">⟹</span> enat <span class="skolem">l</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">∈</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span>
    <span class="keyword1"><span class="command">using</span></span> d_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> a Suc_ile_eq le_SucE less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap P_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">using</span></span> i_Sts <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> fair <span class="keyword1"><span class="command">unfolding</span></span> fair_state_seq_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_of_state_Liminf<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> instance_if_subsumed_and_in_limit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(↝)</span> <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Gs</span> <span class="main">=</span> lmap grounding_of_state <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> Liminf_llist <span class="free">Gs</span> <span class="main">-</span> sr.Rf <span class="main">(</span>Liminf_llist <span class="free">Gs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span> <span class="quoted"><span class="quoted">"subsumes <span class="free">D</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="bound">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Qs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ground_C<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">using</span></span> Liminf_grounding_of_state_ground ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> derivns<span class="main">:</span> <span class="quoted"><span class="quoted">"chain sr_ext.derive <span class="free">Gs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_derive_chain deriv ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">σ</span><span class="main">.</span> <span class="free">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> d<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ_proto</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">τ_proto</span> <span class="main">⊆#</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subsumes_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      τ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">τ</span> <span class="main">⊆#</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="skolem">τ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ground_C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ground_cls_mono make_ground_subst subset_mset.order_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> subsub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">τ</span> <span class="main">⊂#</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subset_mset.le_imp_less_or_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">τ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> τ_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> sr.Rf <span class="main">(</span>grounding_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> strict_subset_subsumption_redundant_clss <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> sr.Rf <span class="main">(</span>Sup_llist <span class="free">Gs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d ns <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> contra_subsetD llength_lmap lnth_lmap lnth_subset_Sup_llist sr.Rf_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> sr.Rf <span class="main">(</span>Liminf_llist <span class="free">Gs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ns <span class="keyword1"><span class="command">using</span></span> local.sr_ext.Rf_limit_Sup derivns ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> make_ground_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> from_Q_to_Q_inf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(↝)</span> <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair_state_seq <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Gs</span> <span class="main">=</span> lmap grounding_of_state <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> Liminf_llist <span class="free">Gs</span> <span class="main">-</span> sr.Rf <span class="main">(</span>Liminf_llist <span class="free">Gs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span> <span class="quoted"><span class="quoted">"subsumes <span class="free">D</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">E</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> <span class="main">(</span>clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> subsumes <span class="bound">E</span> <span class="free">C</span><span class="main">}</span><span class="main">.</span>
      <span class="main">¬</span> strictly_subsumes <span class="bound">E</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Qs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ground_C<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">using</span></span> Liminf_grounding_of_state_ground ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> derivns<span class="main">:</span> <span class="quoted"><span class="quoted">"chain sr_ext.derive <span class="free">Gs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_derive_chain deriv ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="bound">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> instance_if_subsumed_and_in_limit<span class="main">[</span><span class="operator">OF</span> deriv<span class="main">]</span> c d <span class="keyword1"><span class="command">unfolding</span></span> ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> in_Sts_in_Sts_Suc<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">l</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> enat <span class="main">(</span>Suc <span class="bound">l</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟶</span> <span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">l</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
    <span class="keyword3"><span class="command">assume</span></span>
      len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      llen<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      d_in_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lnth <span class="free">Sts</span> <span class="skolem">l</span> <span class="main">↝</span> lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> llen deriv chain_lnth_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> RP.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>backward_subsumption_Q <span class="skolem">D'</span> <span class="skolem">N</span> <span class="skolem">D_removed</span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D_removed</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D_subsumes</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          D_subsumes_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D_subsumes</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">∧</span> strictly_subsumes <span class="skolem">D_subsumes</span> <span class="free">D</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> backward_subsumption_Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> D_subsumes_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subsumes <span class="skolem">D_subsumes</span> <span class="free">C</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> d subsumes_trans <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> backward_subsumption_Q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D_subsumes</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> D_subsumes_p llen
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> UnI1 N_of_state.simps llength_lmap lnth_lmap lnth_subset_Sup_llist
              rev_subsetD Sup_state_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> d_least <span class="keyword1"><span class="command">unfolding</span></span> subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> d_in_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>backward_reduction_Q <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">N</span> <span class="skolem">L</span> <span class="skolem">σ</span> <span class="skolem">D'</span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">L</span><span class="main">#}</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D'_p<span class="main">:</span> <span class="quoted"><span class="quoted">"strictly_subsumes <span class="skolem">D'</span> <span class="free">D</span> <span class="main">∧</span> <span class="skolem">D'</span> <span class="main">∈</span> <span class="var">?Ps</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> subset_strictly_subsumes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">D'</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> backward_reduction_Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subc<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="skolem">D'</span> <span class="free">C</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> d<span class="main">(</span>3<span class="main">)</span> subsumes_trans <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> D'_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> llen <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> UnI1 P_of_state.simps llength_lmap lnth_lmap
              lnth_subset_Sup_llist subsetCE sup_ge2 Sup_state_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> d_least D'_p subc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> backward_reduction_Q d_in_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> d_in_q <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> D_in_Sts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D_in_Sts_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> l_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> enat<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_i enat
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> d<span class="main">(</span>1<span class="main">)</span> in_Sts_in_Sts_Suc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_ile_eq add_Suc_right add_diff_cancel_left' le_SucE
            le_Suc_ex less_imp_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_i enat in_Sts_in_Sts_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">⟹</span> enat <span class="skolem">x</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> d<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x'
      <span class="keyword1"><span class="command">using</span></span> d<span class="main">(</span>1<span class="main">)</span> D_in_Sts_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="skolem">x'</span>›</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less_eq_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap Q_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> from_P_to_Q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(↝)</span> <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair_state_seq <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Gs</span> <span class="main">=</span> lmap grounding_of_state <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> Liminf_llist <span class="free">Gs</span> <span class="main">-</span> sr.Rf <span class="main">(</span>Liminf_llist <span class="free">Gs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span> <span class="quoted"><span class="quoted">"subsumes <span class="free">D</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">E</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> <span class="main">(</span>clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> subsumes <span class="bound">E</span> <span class="free">C</span><span class="main">}</span><span class="main">.</span>
      <span class="main">¬</span> strictly_subsumes <span class="bound">E</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span> enat <span class="bound">l</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Qs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ground_C<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">using</span></span> Liminf_grounding_of_state_ground ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> derivns<span class="main">:</span> <span class="quoted"><span class="quoted">"chain sr_ext.derive <span class="free">Gs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_derive_chain deriv ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="bound">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> instance_if_subsumed_and_in_limit<span class="main">[</span><span class="operator">OF</span> deriv<span class="main">]</span> ns c d <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    l_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∧</span> <span class="free">D</span> <span class="main">∉</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">≤</span> <span class="skolem">l</span>
      <span class="main">∧</span> enat <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fair <span class="keyword1"><span class="command">using</span></span> eventually_removed_from_P d <span class="keyword1"><span class="command">unfolding</span></span> ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_Gs<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Gs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> l_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lnth <span class="free">Sts</span> <span class="skolem">l</span> <span class="main">↝</span> lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deriv <span class="keyword1"><span class="command">using</span></span> chain_lnth_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> RP.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>backward_subsumption_P <span class="skolem">D'</span> <span class="skolem">N</span> <span class="skolem">D_twin</span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> lrhs <span class="main">=</span> this<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> D'_p <span class="main">=</span> this<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> twins<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D_twin</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ns</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ns</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">P</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">D_twin</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> D'_p <span class="main">=</span> D'_p<span class="main">[</span><span class="operator">unfolded</span> twins<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subc<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="skolem">D'</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def subsumes_def <span class="keyword1"><span class="command">using</span></span> σ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_cls_comp_subst subst_cls_mono_mset<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> D'_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> twins<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> l_p
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> UnI1 N_of_state.simps llength_lmap lnth_lmap lnth_subset_Sup_llist
          subsetCE Sup_state_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> d_least D'_p subc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>backward_reduction_P <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">N</span> <span class="skolem">L</span> <span class="skolem">σ</span> <span class="skolem">D'</span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> twins<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">L</span><span class="main">#}</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ns</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ns</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">D'</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">D'</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">L</span><span class="main">#}</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D'_p<span class="main">:</span> <span class="quoted"><span class="quoted">"strictly_subsumes <span class="skolem">D'</span> <span class="free">D</span> <span class="main">∧</span> <span class="skolem">D'</span> <span class="main">∈</span> <span class="var">?Ps</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subset_strictly_subsumes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">D'</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subc<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="skolem">D'</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d<span class="main">(</span>3<span class="main">)</span> subsumes_trans <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> D'_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> UnI1 P_of_state.simps llength_lmap lnth_lmap
          lnth_subset_Sup_llist subsetCE sup_ge2 Sup_state_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> d_least D'_p subc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>inference_computation <span class="skolem">N</span> <span class="skolem">Q</span> <span class="skolem">D_twin</span> <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> twins<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D_twin</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">D_twin</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Q</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">D_twin</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> d σ l_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> l_p <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> from_N_to_P_or_Q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(↝)</span> <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair_state_seq <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Gs</span> <span class="main">=</span> lmap grounding_of_state <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> Liminf_llist <span class="free">Gs</span> <span class="main">-</span> sr.Rf <span class="main">(</span>Liminf_llist <span class="free">Gs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span> <span class="quoted"><span class="quoted">"subsumes <span class="free">D</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">E</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> <span class="main">(</span>clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> subsumes <span class="bound">E</span> <span class="free">C</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> strictly_subsumes <span class="bound">E</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span> <span class="bound">D'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∪</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span>
    enat <span class="bound">l</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">E</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> <span class="main">(</span>clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> subsumes <span class="bound">E</span> <span class="free">C</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> strictly_subsumes <span class="bound">E</span> <span class="bound">D'</span><span class="main">)</span> <span class="main">∧</span>
    <span class="bound">D'</span> <span class="main">⋅</span> <span class="bound">σ'</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="bound">σ'</span> <span class="main">∧</span> subsumes <span class="bound">D'</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Qs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ground_C<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">using</span></span> Liminf_grounding_of_state_ground ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> derivns<span class="main">:</span> <span class="quoted"><span class="quoted">"chain sr_ext.derive <span class="free">Gs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_derive_chain deriv ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="bound">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> instance_if_subsumed_and_in_limit<span class="main">[</span><span class="operator">OF</span> deriv<span class="main">]</span> ns c d <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> c <span class="keyword1"><span class="command">have</span></span> no_taut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span><span class="main">.</span> Pos <span class="bound">A</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">∧</span> Neg <span class="bound">A</span> <span class="main">∈#</span> <span class="free">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sr.tautology_Rf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">D</span> <span class="main">∈</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">l</span><span class="main">)</span>
    <span class="main">∧</span> <span class="free">D</span> <span class="main">∉</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">∧</span> enat <span class="main">(</span>Suc <span class="bound">l</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fair <span class="keyword1"><span class="command">using</span></span> eventually_removed_from_N d <span class="keyword1"><span class="command">unfolding</span></span> ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    l_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∧</span> <span class="free">D</span> <span class="main">∉</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">≤</span> <span class="skolem">l</span>
      <span class="main">∧</span> enat <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_Gs<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">Gs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> l_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lnth <span class="free">Sts</span> <span class="skolem">l</span> <span class="main">↝</span> lnth <span class="free">Sts</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deriv <span class="keyword1"><span class="command">using</span></span> chain_lnth_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> RP.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tautology_deletion <span class="skolem">A</span> <span class="skolem">D_twin</span> <span class="skolem">N</span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D_twin</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pos <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">⋅a</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">∧</span> Neg <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">⋅a</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">∈#</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tautology_deletion<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> σ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Melem_subst_cls eql_neg_lit_eql_atm eql_pos_lit_eql_atm<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> no_taut <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>forward_subsumption <span class="skolem">D'</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">D_twin</span> <span class="skolem">N</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> lrhs <span class="main">=</span> this<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> D'_p <span class="main">=</span> this<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> twins<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D_twin</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ns</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ns</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">N</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">D_twin</span><span class="main">}</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">P</span> "</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> D'_p <span class="main">=</span> D'_p<span class="main">[</span><span class="operator">unfolded</span> twins<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> D'_p<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> subs<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="skolem">D'</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subsumes_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> twins D'_p l_p <span class="keyword1"><span class="command">unfolding</span></span> Sup_state_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> contra_subsetD llength_lmap lnth_lmap lnth_subset_Sup_llist<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> strictly_subsumes <span class="skolem">D'</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d_least <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subsumes <span class="free">D</span> <span class="skolem">D'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def <span class="keyword1"><span class="command">using</span></span> D'_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"variants <span class="free">D</span> <span class="skolem">D'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D'_p <span class="keyword1"><span class="command">unfolding</span></span> variants_iff_subsumes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mini<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">E</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">E</span></span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span><span class="main">.</span> subsumes <span class="bound">E</span> <span class="free">C</span><span class="main">}</span><span class="main">.</span>
      <span class="main">¬</span> strictly_subsumes <span class="bound">E</span> <span class="skolem">D'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d_least D'_p neg_strictly_subsumes_variants<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="skolem">D'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> <span class="skolem">D'</span> <span class="main">⋅</span> <span class="bound">σ'</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> σ variants_imp_exists_substitution variants_sym <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_cls_comp_subst<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> <span class="skolem">D'</span> <span class="main">⋅</span> <span class="bound">σ'</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="bound">σ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ground_C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> make_ground_subst refl<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      σ'_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">⋅</span> <span class="skolem">σ'</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="skolem">σ'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> D'_p twins l_p subs mini σ'_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>forward_reduction <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">L</span> <span class="skolem">σ</span> <span class="skolem">D'</span> <span class="skolem">N</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> twins<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">L</span><span class="main">#}</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ns</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">N</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">D'</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ns</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">N</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">D'</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">L</span><span class="main">#}</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">P</span> "</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D'_p<span class="main">:</span> <span class="quoted"><span class="quoted">"strictly_subsumes <span class="skolem">D'</span> <span class="free">D</span> <span class="main">∧</span> <span class="skolem">D'</span> <span class="main">∈</span> <span class="var">?Ns</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subset_strictly_subsumes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">D'</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subc<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="skolem">D'</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d<span class="main">(</span>3<span class="main">)</span> subsumes_trans <span class="keyword1"><span class="command">unfolding</span></span> strictly_subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> D'_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> UnI1 N_of_state.simps llength_lmap lnth_lmap
          lnth_subset_Sup_llist subsetCE Sup_state_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> d_least D'_p subc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>clause_processing <span class="skolem">N</span> <span class="skolem">D_twin</span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> twins<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">D_twin</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ns</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Ns</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">N</span> <span class="main">∪</span> <span class="main">{</span><span class="free">D</span><span class="main">}</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">∪</span> <span class="main">{</span><span class="free">D</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> d σ l_p d_least <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> l_p <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_in_Qinf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(↝)</span> <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"subsumes <span class="free">D</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">E</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> <span class="main">(</span>clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> subsumes <span class="bound">E</span> <span class="free">C</span><span class="main">}</span><span class="main">.</span>
       <span class="main">¬</span> strictly_subsumes <span class="bound">E</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair_state_seq <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Gs</span> <span class="main">=</span> lmap grounding_of_state <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> Liminf_llist <span class="free">Gs</span> <span class="main">-</span> sr.Rf <span class="main">(</span>Liminf_llist <span class="free">Gs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ground_C<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">D'</span> <span class="main">⋅</span> <span class="bound">σ'</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="bound">σ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Qs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> D_p <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    i_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="var">?Ns</span> <span class="skolem">i</span> <span class="main">∨</span> <span class="free">D</span> <span class="main">∈</span> <span class="var">?Ps</span> <span class="skolem">i</span> <span class="main">∨</span> <span class="free">D</span> <span class="main">∈</span> <span class="var">?Qs</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Sup_state_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Sup_llist_imp_exists_index llength_lmap lnth_lmap<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> derivns<span class="main">:</span> <span class="quoted"><span class="quoted">"chain sr_ext.derive <span class="free">Gs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_derive_chain deriv ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">D</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> is_ground_subst <span class="bound">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> instance_if_subsumed_and_in_limit<span class="main">[</span><span class="operator">OF</span> deriv ns c<span class="main">]</span> D_p i_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="var">?Ns</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> D'_p<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">∈</span> <span class="var">?Ps</span> <span class="skolem">l</span> <span class="main">∪</span> <span class="var">?Qs</span> <span class="skolem">l</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">⋅</span> <span class="skolem">σ'</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
      <span class="quoted"><span class="quoted">"enat <span class="skolem">l</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
      <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">σ'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">E</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> <span class="main">(</span>clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> subsumes <span class="bound">E</span> <span class="free">C</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> strictly_subsumes <span class="bound">E</span> <span class="skolem">D'</span>"</span></span>
      <span class="quoted"><span class="quoted">"subsumes <span class="skolem">D'</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> from_N_to_P_or_Q deriv fair ns c i_p<span class="main">(</span>1<span class="main">)</span> D_p<span class="main">(</span>2<span class="main">)</span> D_p<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      l'_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">∈</span> <span class="var">?Qs</span> <span class="skolem">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> from_P_to_Q<span class="main">[</span><span class="operator">OF</span> deriv fair ns c _ D'_p<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> D'_p<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> D'_p<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> from_Q_to_Q_inf<span class="main">[</span><span class="operator">OF</span> deriv fair ns c _ l'_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> D'_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> D'_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="var">?Ps</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      l'_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="var">?Qs</span> <span class="skolem">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> from_P_to_Q<span class="main">[</span><span class="operator">OF</span> deriv fair ns c a i_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> D_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> D_p<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> from_Q_to_Q_inf<span class="main">[</span><span class="operator">OF</span> deriv fair ns c l'_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> l'_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> D_p<span class="main">(</span>3<span class="main">)</span> σ<span class="main">(</span>1<span class="main">)</span> σ<span class="main">(</span>2<span class="main">)</span> D_p<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> D_p σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="var">?Qs</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> from_Q_to_Q_inf<span class="main">[</span><span class="operator">OF</span> deriv fair ns c a i_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> σ D_p<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> D_p σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> i_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following corresponds to Lemma 4.11:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fair_imp_Liminf_minus_Rf_subset_ground_Liminf_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(↝)</span> <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair_state_seq <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Gs</span> <span class="main">=</span> lmap grounding_of_state <span class="free">Sts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Liminf_llist <span class="free">Gs</span> <span class="main">-</span> sr.Rf <span class="main">(</span>Liminf_llist <span class="free">Gs</span><span class="main">)</span>
    <span class="main">⊆</span> grounding_of_clss <span class="main">(</span>Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Qs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> SQinf<span class="main">:</span> <span class="quoted"><span class="quoted">"clss_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span> <span class="main">=</span> Liminf_llist <span class="main">(</span>lmap Q_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fair <span class="keyword1"><span class="command">unfolding</span></span> fair_state_seq_def Liminf_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span>
  <span class="keyword3"><span class="command">assume</span></span> C_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> Liminf_llist <span class="free">Gs</span> <span class="main">-</span> sr.Rf <span class="main">(</span>Liminf_llist <span class="free">Gs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> Sup_llist <span class="free">Gs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Liminf_llist_subset_Sup_llist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Gs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D_proto</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">D_proto</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span> <span class="main">∧</span> subsumes <span class="skolem">D_proto</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_Sup_llist_in_Sup_state <span class="keyword1"><span class="command">unfolding</span></span> ns subsumes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    D_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"subsumes <span class="skolem">D</span> <span class="skolem">C</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">E</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span> <span class="main">∧</span> subsumes <span class="bound">E</span> <span class="skolem">C</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> strictly_subsumes <span class="bound">E</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> strictly_subsumes_has_minimum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">E</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Sup_state <span class="free">Sts</span><span class="main">)</span> <span class="main">∧</span> subsumes <span class="bound">E</span> <span class="skolem">C</span><span class="main">}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> ground_C<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C_p <span class="keyword1"><span class="command">using</span></span> Liminf_grounding_of_state_ground ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D'</span> <span class="bound">σ'</span><span class="main">.</span> <span class="bound">D'</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">D'</span> <span class="main">⋅</span> <span class="bound">σ'</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">∧</span> is_ground_subst <span class="bound">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_in_Qinf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">D</span></span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="free">Gs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> D_p<span class="main">(</span>1-3<span class="main">)</span> deriv fair ns C_p ground_C <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    D'_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">D'</span> <span class="main">⋅</span> <span class="skolem">σ'</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">∧</span> is_ground_subst <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> grounding_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def grounding_of_cls_def <span class="keyword1"><span class="command">using</span></span> D'_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> grounding_of_clss <span class="main">(</span>Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> SQinf fair fair_state_seq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following corresponds to (one direction of) Theorem 4.13:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subseteq_Liminf_state_eventually_always<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">CC</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">CC</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">CC</span> <span class="main">⊆</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j'</span></span> <span class="main">≥</span> enat <span class="bound">j</span><span class="main">.</span> <span class="bound">j'</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟶</span> <span class="free">CC</span> <span class="main">⊆</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j'</span></span> <span class="main">≥</span> enat <span class="bound">j</span><span class="main">.</span> <span class="bound">j'</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_state_def Liminf_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    f_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">C</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j'</span></span> <span class="main">≥</span> enat <span class="main">(</span><span class="skolem">f</span> <span class="bound">C</span><span class="main">)</span><span class="main">.</span> <span class="bound">j'</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Max <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="free">CC</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">j</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">using</span></span> f_p assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> Max_in assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_imageI imageE image_is_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C</span> <span class="bound">j'</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈</span> <span class="free">CC</span> <span class="main">⟶</span> enat <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">j'</span> <span class="main">⟶</span> <span class="bound">j'</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">j'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">j'</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> <span class="free">CC</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">j</span> <span class="main">≤</span> enat <span class="skolem">j'</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">j'</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">C</span> <span class="main">≤</span> <span class="skolem">j'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Max.bounded_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f_p a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> empty_clause_in_Q_of_Liminf_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(↝)</span> <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair_state_seq <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    empty_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Gs</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set llist"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Gs</span> <span class="main">=</span> lmap grounding_of_state <span class="free">Sts</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> empty_in <span class="keyword1"><span class="command">have</span></span> in_Liminf_not_Rf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> Liminf_llist <span class="skolem">Gs</span> <span class="main">-</span> sr.Rf <span class="main">(</span>Liminf_llist <span class="skolem">Gs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ns sr.Rf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> grounding_of_clss <span class="main">(</span>Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fair_imp_Liminf_minus_Rf_subset_ground_Liminf_state<span class="main">[</span><span class="operator">OF</span> deriv fair ns<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> grounding_of_state_Liminf_state_subseteq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"grounding_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span> <span class="main">⊆</span> Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> grounding_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    D_σ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">⋅</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap N_of_state <span class="free">Sts</span><span class="main">)</span>
    <span class="main">∨</span> <span class="skolem">D</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap P_of_state <span class="free">Sts</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">D</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap Q_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap grounding_of_clss <span class="main">(</span>lmap N_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∨</span> <span class="skolem">C</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap grounding_of_clss <span class="main">(</span>lmap P_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∨</span> <span class="skolem">C</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap grounding_of_clss <span class="main">(</span>lmap Q_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def grounding_of_clss_def grounding_of_cls_def
    <span class="keyword1"><span class="command">using</span></span> D_σ_p
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> D_σ_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> D_σ_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> D_σ_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> RP_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(↝)</span> <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="main">(</span>grounding_of_state <span class="main">(</span>lhd <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> grounding_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ex_ground_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> grounding_of_state_Liminf_state_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="main">(</span>Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> true_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="main">(</span>lhd <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sr_ext.sat_limit_iff ground_derive_chain deriv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> chain_not_lnull deriv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> RP_saturated_if_fair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(↝)</span> <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair_state_seq <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    empty_Q0<span class="main">:</span> <span class="quoted"><span class="quoted">"Q_of_state <span class="main">(</span>lhd <span class="free">Sts</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sr.saturated_upto <span class="main">(</span>Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Gs</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> clause set llist"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Gs</span> <span class="main">=</span> lmap grounding_of_state <span class="free">Sts</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> grounding_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> N_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> P_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Qs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ground_ns_in_ground_limit_st<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Liminf_llist <span class="skolem">Gs</span> <span class="main">-</span> sr.Rf <span class="main">(</span>Liminf_llist <span class="skolem">Gs</span><span class="main">)</span> <span class="main">⊆</span> grounding_of_clss <span class="main">(</span>Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fair deriv fair_imp_Liminf_minus_Rf_subset_ground_Liminf_state ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> derivns<span class="main">:</span> <span class="quoted"><span class="quoted">"chain sr_ext.derive <span class="skolem">Gs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ground_derive_chain deriv ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> inference"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> γ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> gr.ord_Γ"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?CC</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"side_prems_of <span class="skolem">γ</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?DA</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"main_prem_of <span class="skolem">γ</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?E</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"concl_of <span class="skolem">γ</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="var">?CC</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?DA</span><span class="main">}</span>
      <span class="main">⊆</span> Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span>
        <span class="main">-</span> sr.Rf <span class="main">(</span>Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> ground_ground_Liminf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_clss <span class="main">(</span>Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Liminf_grounding_of_state_ground <span class="keyword1"><span class="command">unfolding</span></span> is_ground_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> ground_cc<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_clss <span class="main">(</span>set_mset <span class="var">?CC</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a ground_ground_Liminf is_ground_clss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> ground_da<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls <span class="var">?DA</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a grounding_ground singletonI ground_ground_Liminf
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Liminf_grounding_of_state_ground<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> γ_p <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">CAs</span></span> <span class="skolem"><span class="skolem">AAs</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      CAs_p<span class="main">:</span> <span class="quoted"><span class="quoted">"gr.ord_resolve <span class="skolem">CAs</span> <span class="var">?DA</span> <span class="skolem">AAs</span> <span class="skolem">As</span> <span class="var">?E</span> <span class="main">∧</span> mset <span class="skolem">CAs</span> <span class="main">=</span> <span class="var">?CC</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gr.ord_Γ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> DA_CAs_in_ground_Liminf<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?DA</span><span class="main">}</span> <span class="main">∪</span> set <span class="skolem">CAs</span> <span class="main">⊆</span> grounding_of_clss <span class="main">(</span>Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a CAs_p fair <span class="keyword1"><span class="command">unfolding</span></span> fair_state_seq_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Un_empty_left ground_ns_in_ground_limit_st a ns set_mset_mset
          subset_trans sup_commute<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ground_cas<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ground_cls_list <span class="skolem">CAs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> CAs_p <span class="keyword1"><span class="command">unfolding</span></span> is_ground_cls_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> ord_resolve S_Q <span class="skolem">CAs</span> <span class="var">?DA</span> <span class="skolem">AAs</span> <span class="skolem">As</span> <span class="bound">σ</span> <span class="var">?E</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ground_ord_resolve_imp_ord_resolve<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ground_da ground_cas
            gr.ground_resolution_with_selection_axioms CAs_p<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      σ_p<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_resolve S_Q <span class="skolem">CAs</span> <span class="var">?DA</span> <span class="skolem">AAs</span> <span class="skolem">As</span> <span class="skolem">σ</span> <span class="var">?E</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ηs'</span></span> <span class="skolem"><span class="skolem">η'</span></span> <span class="skolem"><span class="skolem">η2'</span></span> <span class="skolem"><span class="skolem">CAs'</span></span> <span class="skolem"><span class="skolem">DA'</span></span> <span class="skolem"><span class="skolem">AAs'</span></span> <span class="skolem"><span class="skolem">As'</span></span> <span class="skolem"><span class="skolem">τ'</span></span> <span class="skolem"><span class="skolem">E'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s_p<span class="main">:</span>
      <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">η'</span>"</span></span>
      <span class="quoted"><span class="quoted">"is_ground_subst_list <span class="skolem">ηs'</span>"</span></span>
      <span class="quoted"><span class="quoted">"is_ground_subst <span class="skolem">η2'</span>"</span></span>
      <span class="quoted"><span class="quoted">"ord_resolve_rename <span class="free">S</span> <span class="skolem">CAs'</span> <span class="skolem">DA'</span> <span class="skolem">AAs'</span> <span class="skolem">As'</span> <span class="skolem">τ'</span> <span class="skolem">E'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">CAs'</span> <span class="keyword1">⋅⋅cl</span> <span class="skolem">ηs'</span> <span class="main">=</span> <span class="skolem">CAs</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">DA'</span> <span class="main">⋅</span> <span class="skolem">η'</span> <span class="main">=</span> <span class="var">?DA</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">⋅</span> <span class="skolem">η2'</span> <span class="main">=</span> <span class="var">?E</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">DA'</span><span class="main">}</span> <span class="main">∪</span> set <span class="skolem">CAs'</span> <span class="main">⊆</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ord_resolve_rename_lifting<span class="main">[</span><span class="operator">OF</span> sel_stable<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">CAs</span></span> <span class="var"><span class="quoted"><span class="var">?DA</span></span></span><span class="main">]</span>
        σ_p<span class="main">[</span><span class="operator">unfolded</span> S_Q_def<span class="main">]</span> selection_axioms DA_CAs_in_ground_Liminf <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">∧</span> <span class="main">(</span>set <span class="skolem">CAs'</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">DA'</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?Qs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Liminf_llist_def
      <span class="keyword1"><span class="command">using</span></span> subseteq_Liminf_state_eventually_always<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">DA'</span><span class="main">}</span> <span class="main">∪</span> set <span class="skolem">CAs'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      j_p<span class="main">:</span> <span class="quoted"><span class="quoted">"is_least <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">∧</span> set <span class="skolem">CAs'</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">DA'</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?Qs</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> least_exists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> enat <span class="bound">j</span> <span class="main">&lt;</span> llength <span class="free">Sts</span> <span class="main">∧</span> set <span class="skolem">CAs'</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">DA'</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?Qs</span> <span class="bound">j</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_p'<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">j</span> <span class="main">&lt;</span> llength <span class="free">Sts</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">CAs'</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">DA'</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?Qs</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_least_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> jn0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> empty_Q0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bot_eq_sup_iff gr_implies_not_zero insert_not_empty llength_lnull
          lnth_0_conv_lhd sup.orderE<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_adds_CAs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> set <span class="skolem">CAs'</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">DA'</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?Qs</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">CAs'</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">DA'</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?Qs</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_p <span class="keyword1"><span class="command">unfolding</span></span> is_least_def
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> One_nat_def Suc_diff_Suc Suc_ile_eq diff_diff_cancel diff_zero
          less_imp_le less_one neq0_conv zero_less_diff<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> j_p'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lnth <span class="free">Sts</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">↝</span> lnth <span class="free">Sts</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_p'<span class="main">(</span>1<span class="main">)</span> jn0 deriv chain_lnth_rel<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_p<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="var">?Ns</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?Ps</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?Ps</span> <span class="skolem">j</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C'</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?Qs</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?Qs</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">C'</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?Ns</span> <span class="skolem">j</span> <span class="main">=</span> concls_of <span class="main">(</span>ord_FO_resolution.inferences_between <span class="main">(</span><span class="var">?Qs</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">C'</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">∈</span> set <span class="skolem">CAs'</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">DA'</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">∉</span> <span class="var">?Qs</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_adds_CAs' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> RP.cases<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">∈</span> <span class="var">?Ns</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">∈</span> concls_of <span class="main">(</span>ord_FO_resolution.inferences_between <span class="main">(</span>Q_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">C'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> infer_from_def ord_FO_Γ_def inference_system.inferences_between_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Infer <span class="main">(</span>mset <span class="skolem">CAs'</span><span class="main">)</span> <span class="skolem">DA'</span> <span class="skolem">E'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> infer_from_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ord_resolve_rename.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s_p<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> s_p<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> C'_p<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span> j_p'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">force</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> C'_p<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">∈</span> clss_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_p' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="main">∈</span> grounding_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s_p<span class="main">(</span>7<span class="main">)</span> s_p<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> grounding_of_clss_def grounding_of_cls_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> sr.Ri <span class="main">(</span>grounding_of_state <span class="main">(</span>lnth <span class="free">Sts</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sr.Ri_effective γ_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> sr_ext_Ri <span class="main">(</span><span class="var">?N</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sr_ext_Ri_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> sr_ext_Ri <span class="main">(</span>Sup_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_p' contra_subsetD llength_lmap lnth_lmap lnth_subset_Sup_llist sr_ext.Ri_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> sr_ext_Ri <span class="main">(</span>Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sr_ext.Ri_limit_Sup<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Gs</span></span><span class="main">]</span> derivns ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sr_ext.saturated_upto <span class="main">(</span>Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sr_ext.saturated_upto_def sr_ext.inferences_from_def infer_from_def sr_ext_Ri_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> gd_ord_Γ_ngd_ord_Γ sr.redundancy_criterion_axioms
      redundancy_criterion_standard_extension_saturated_upto_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted">gr.ord_Γ</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> sr_ext_Ri_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> RP_complete_if_fair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(↝)</span> <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair_state_seq <span class="free">Sts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    empty_Q0<span class="main">:</span> <span class="quoted"><span class="quoted">"Q_of_state <span class="main">(</span>lhd <span class="free">Sts</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="main">(</span>grounding_of_state <span class="main">(</span>lhd <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> Q_of_state <span class="main">(</span>Liminf_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> satisfiable <span class="main">(</span>Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unsat sr_ext.sat_limit_iff<span class="main">[</span><span class="operator">OF</span> ground_derive_chain<span class="main">]</span> chain_not_lnull deriv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sr.saturated_upto <span class="main">(</span>Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RP_saturated_if_fair<span class="main"><span class="main">[</span></span><span class="operator">OF</span> deriv fair empty_Q0<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> Liminf_llist <span class="main">(</span>lmap grounding_of_state <span class="free">Sts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sr.saturated_upto_complete_if <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> empty_clause_in_Q_of_Liminf_state<span class="main">[</span><span class="operator">OF</span> deriv fair<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>