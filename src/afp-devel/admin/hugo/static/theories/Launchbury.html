<div id="AList-Utils">
<div class="head">
<h1>Theory AList-Utils</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"AList-Utils"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/AList.html">HOL-Library.AList</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">declare</span></span> implies_True_equals <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> False_implies_equals<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We want to have <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>delete›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>update›</span></span></span></span> back in the namespace.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">delete</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="main">≡</span> AList.delete"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">update</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">update</span> <span class="main">≡</span> AList.update"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">restrictA</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">restrictA</span> <span class="main">≡</span> AList.restrict"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">clearjunk</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">clearjunk</span> <span class="main">≡</span> AList.clearjunk"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> restrict_eq <span class="main">=</span> AList.restrict_eq
  <span class="keyword2"><span class="keyword">and</span></span> delete_eq <span class="main">=</span> AList.delete_eq

<span class="keyword1"><span class="command">lemma</span></span> restrictA_append<span class="main">:</span> <span class="quoted"><span class="quoted">"restrictA <span class="free">S</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> restrictA <span class="free">S</span> <span class="free">a</span> <span class="main">@</span> restrictA <span class="free">S</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filter_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_restrictA_le<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>restrictA <span class="free">S</span> <span class="free">a</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_filter_le restrict_eq<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The domain of an associative list›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">domA</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">domA</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> domA_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"domA <span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> domA <span class="free">a</span> <span class="main">∪</span> domA <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"domA <span class="main">(</span><span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">v</span> <span class="main">(</span>domA <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"domA <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>fst <span class="free">p</span><span class="main">)</span> <span class="main">(</span>domA <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"domA <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domA_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> domA_from_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">h</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> domA <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">h</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_domA<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domA_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> domA_delete<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"domA <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> domA <span class="free">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> domA_restrictA<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"domA <span class="main">(</span>restrictA <span class="free">S</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> domA <span class="free">Γ</span> <span class="main">∩</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> delete_not_domA<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span> <span class="main">⟹</span>  delete <span class="free">x</span> <span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> deleted_not_domA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_map_of_conv_domA<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="main">(</span>map_of <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> domA_map_of_Some_the<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span> <span class="main">⟹</span> map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> domA_clearjunk<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="main">(</span>clearjunk <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> domA_def <span class="keyword1"><span class="command">using</span></span> dom_clearjunk<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> the_map_option_domA<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span> <span class="main">⟹</span> the <span class="main">(</span>map_option <span class="free">f</span> <span class="main">(</span>map_of <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_domAD<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dom_map_of_conv_domA <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> restrictA_noop<span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> restrictA <span class="free">S</span> <span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> restrictA_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="free">m1</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">V'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">m1</span> <span class="main">=</span> <span class="free">m2</span> <span class="main">⟹</span> restrictA <span class="free">V</span> <span class="free">m1</span> <span class="main">=</span> restrictA <span class="free">V'</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m2</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Other lemmas about associative lists›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delete_set_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_of <span class="free">l</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> None<span class="main">)</span> <span class="main">=</span> map_of <span class="main">(</span>delete <span class="free">x</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">l</span> <span class="skolem">ls</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">l</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_size_delete<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size_list size <span class="main">(</span>delete <span class="free">x</span> <span class="free">l</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="main">(</span>size_list size <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> delete_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"delete <span class="free">x</span> <span class="main">(</span><span class="free">l1</span> <span class="main">@</span> <span class="free">l2</span><span class="main">)</span> <span class="main">=</span> delete <span class="free">x</span> <span class="free">l1</span> <span class="main">@</span> delete <span class="free">x</span> <span class="free">l2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> AList.delete_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_delete_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> map_of <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_delete_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">xa</span> <span class="main">=</span> Some <span class="free">e</span> <span class="main">⟷</span> <span class="main">(</span>map_of <span class="free">Γ</span> <span class="free">xa</span> <span class="main">=</span> Some <span class="free">e</span><span class="main">)</span> <span class="main">∧</span> <span class="free">xa</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delete_conv fun_upd_same map_of_delete option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_domA<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">(</span>map_of <span class="free">Δ</span> <span class="main">++</span> map_of <span class="free">Γ</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> map_of <span class="free">Γ</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">(</span>map_of <span class="free">Δ</span> <span class="main">++</span> map_of <span class="free">Γ</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> map_of <span class="free">Δ</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> dom_map_of_conv_domA map_add_dom_app_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> dom_map_of_conv_domA map_add_dom_app_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_delete_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>delete <span class="free">k</span> <span class="free">al</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">al</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_delete_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="main">(</span>delete <span class="free">k</span> <span class="free">al</span><span class="main">)</span> <span class="main">⊆</span> snd <span class="main">`</span> set <span class="free">al</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_eq<span class="main">)</span>

<span class="comment1">(*
lemma ran_map_cong[fundef_cong]:
  "⟦ list_all2 (λ x y. fst x = fst y ∧ f1 (fst x) (snd x) = f2 (fst y) (snd y)) m1 m2 ⟧
      ⟹ map_ran f1 m1 = map_ran f2 m2"    
  by (induction rule: list_all2_induct) auto
*)</span>
<span class="keyword1"><span class="command">lemma</span></span> map_ran_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">m1</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">;</span> <span class="free">m1</span> <span class="main">=</span> <span class="free">m2</span> <span class="main">⟧</span>
      <span class="main">⟹</span> map_ran <span class="free">f1</span> <span class="free">m1</span> <span class="main">=</span> map_ran <span class="free">f2</span> <span class="free">m2</span>"</span></span>    
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m2</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> domA_map_ran<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="main">(</span>map_ran <span class="free">f</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> domA <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> domA_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dom_map_ran<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_ran_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_ran <span class="free">f</span> <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> delete <span class="free">x</span> <span class="main">(</span>map_ran <span class="free">f</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>  <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_ran_restrictA<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_ran <span class="free">f</span> <span class="main">(</span>restrictA <span class="free">V</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> restrictA <span class="free">V</span> <span class="main">(</span>map_ran <span class="free">f</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>  <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_ran_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_ran <span class="free">f</span> <span class="main">(</span><span class="free">Γ</span><span class="main">@</span><span class="free">Δ</span><span class="main">)</span> <span class="main">=</span> map_ran <span class="free">f</span> <span class="free">Γ</span> <span class="main">@</span> map_ran <span class="free">f</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>  <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax for map comprehensions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mapCollect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mapCollect</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
 <span class="quoted">"_MapCollect"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> pttrn <span class="main">=&gt;</span> pttrn <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span> <span class="main">=&gt;</span> <span class="tfree">'c</span> set"</span></span>    <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">{</span>_ <span class="keyword1">|</span><span class="keyword3">/</span>_<span class="keyword3">/</span><span class="keyword1">↦</span><span class="keyword3">/</span>_<span class="keyword3">/</span><span class="keyword1">∈</span><span class="keyword3">/</span>_<span class="keyword3">/</span><span class="keyword1">}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">{</span><span class="free">e</span> <span class="main">|</span> <span class="free">k</span><span class="main">↦</span><span class="free">v</span> <span class="main">∈</span> <span class="free">m</span><span class="main">}</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> mapCollect <span class="main">(</span><span class="main">λ</span><span class="free">k</span> <span class="free">v</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span> <span class="free">m</span>"</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCollect_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">k</span> <span class="main">↦</span> <span class="bound">v</span> <span class="main">∈</span> Map.empty<span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mapCollect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCollect_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> Map.empty <span class="main">⟹</span> <span class="main">{</span><span class="free">e</span> <span class="main">|</span> <span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span><span class="free">m</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mapCollect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCollect_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">.</span> <span class="free">m1</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">m1</span> <span class="main">=</span> <span class="free">m2</span> <span class="main">⟹</span> mapCollect <span class="free">f1</span> <span class="free">m1</span> <span class="main">=</span> mapCollect <span class="free">f2</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mapCollect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCollectE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">k</span> <span class="main">↦</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">k</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapCollect_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCollectI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="free">v</span> <span class="main">∈</span> <span class="main">{</span><span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">k</span> <span class="main">↦</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapCollect_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> ball_mapCollect<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">k</span> <span class="main">↦</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">.</span> <span class="free">m</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapCollect_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_mapCollect<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">`</span> <span class="main">{</span><span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">k</span> <span class="main">↦</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">m</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span> <span class="main">|</span> <span class="bound">k</span> <span class="main">↦</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapCollect_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCollect_map_upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mapCollect <span class="free">f</span> <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">k</span><span class="main">↦</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">f</span> <span class="free">k</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>mapCollect <span class="free">f</span> <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mapCollect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mapCollectFilter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span>bool <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mapCollectFilter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">{</span>snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span> <span class="main">|</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
 <span class="quoted">"_MapCollectFilter"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> pttrn <span class="main">⇒</span> pttrn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'c</span> set"</span></span>    <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">{</span>_ <span class="keyword1">|</span><span class="keyword3">/</span>_<span class="keyword3">/</span><span class="keyword1">↦</span><span class="keyword3">/</span>_<span class="keyword3">/</span><span class="keyword1">∈</span><span class="keyword3">/</span>_<span class="keyword3">/</span><span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword1">}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">{</span><span class="free">e</span> <span class="main">|</span> <span class="free">k</span><span class="main">↦</span><span class="free">v</span> <span class="main">∈</span> <span class="free">m</span> <span class="main">.</span> <span class="free">P</span> <span class="main">}</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> mapCollectFilter <span class="main">(</span><span class="main">λ</span><span class="free">k</span> <span class="free">v</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span>"</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCollectFilter_const_False<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">e</span> <span class="main">|</span> <span class="bound">k</span><span class="main">↦</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">m</span> <span class="main">.</span> False <span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mapCollect_def mapCollectFilter_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCollectFilter_const_True<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">e</span> <span class="main">|</span> <span class="bound">k</span><span class="main">↦</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">m</span> <span class="main">.</span> True <span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">e</span> <span class="main">|</span> <span class="bound">k</span><span class="main">↦</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mapCollect_def mapCollectFilter_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="HOLCF-Join">
<div class="head">
<h1>Theory HOLCF-Join</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"HOLCF-Join"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOLCF/HOLCF.html">HOLCF</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Binary Joins and compatibility›</span></span>

<span class="keyword1"><span class="command">context</span></span> cpo
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊔</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⊔</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="bound">z</span> <span class="keyword1">then</span> lub <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">}</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compatible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">compatible</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="bound">z</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compatibleI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span> <span class="main">⊑</span> <span class="bound">a</span> <span class="main">;</span> <span class="free">y</span> <span class="main">⊑</span> <span class="bound">a</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⊑</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_lubI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> compatible_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_joinI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span> <span class="main">⊑</span> <span class="bound">a</span> <span class="main">;</span> <span class="free">y</span> <span class="main">⊑</span> <span class="bound">a</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⊑</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_lubI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> join_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lub_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_join_and_compatible<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span> <span class="main">⊑</span> <span class="bound">a</span> <span class="main">;</span> <span class="free">y</span> <span class="main">⊑</span> <span class="bound">a</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⊑</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compatibleI is_joinI assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compatible_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> compatible <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> compatible_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compatible_sym_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> compatible <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> compatible_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_above1<span class="main">:</span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> compatible_def join_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_lubD1 is_ub_insert lub_eqI<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> join_above2<span class="main">:</span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> compatible_def join_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_lubD1 is_ub_insert lub_eqI<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> larger_is_join1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> join_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> doubleton_eq_iff lub_bin<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> larger_is_join2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> join_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_lub_bin lub_bin<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_self<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> join_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_commute<span class="main">:</span>  <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⊔</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> compatible_def <span class="keyword1"><span class="command">unfolding</span></span> join_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lub_is_join<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> join_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lub_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compatible_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compatibleI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_refl below_refl<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">c</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⊑</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊔</span> <span class="free">b</span> <span class="main">⊑</span> <span class="free">c</span> <span class="main">⊔</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">c</span><span class="main">,</span> <span class="free">d</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> compatible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⊑</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below.r_trans is_lubD1 is_ub_insert<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_lub_below_iff is_lub_singleton is_ub_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">c</span><span class="main">,</span> <span class="free">d</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊔</span> <span class="free">b</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊔</span> <span class="free">d</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lub_is_join<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> join_above1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> join_above2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> compatible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lub_is_join<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_lubD1 is_ub_insert<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> compatible_above1<span class="main">:</span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> compatible_above2<span class="main">:</span> <span class="quoted"><span class="quoted">"compatible <span class="free">y</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> compatible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lub_is_join<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_lubD1 is_ub_insert<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span>  <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"compatible <span class="free">y</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below.r_refl compatibleI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> compatible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">⊑</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_lub_below_iff is_ub_empty is_ub_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lub_is_join<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_below_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">a</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊑</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms below_trans cpo_class.join_above1 cpo_class.join_above2 join_below<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_assoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">y</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_joinI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> below_refl join_above1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> join_above2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> join_above2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rev_below_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_above1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rev_below_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_above2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> join_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> compatible_refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> compatible_above1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> join_self<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_bottom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="main">⊥</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">⊔</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_joinI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compatible_adm2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> compatible <span class="free">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> admI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span>  compatible <span class="free">x</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> compatible <span class="free">x</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> compatibleI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊔</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a a below_refl chainE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊔</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> admD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ c2<span class="main"><span class="main">]</span></span> join_above1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊔</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> admD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ c<span class="main"><span class="main">]</span></span> below_lub<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c2 join_above2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> a<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊔</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lub_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">⊑</span> <span class="skolem">a</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_ub_thelub<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">a</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compatible_adm1<span class="main">:</span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> compatible <span class="bound">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> compatible_sym_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> compatible_adm2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_cont1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> compatible <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compat compat chainE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span><span class="main"><span class="main">]</span></span> below_refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_joinI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lub_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span> c join_above1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compat<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_lub<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c join_above2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compat<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lub_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compat<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> lub_below_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_cont2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> compatible <span class="free">x</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compat compat below_refl chainE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_joinI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_lub<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c join_above1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compat<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lub_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span> c join_above2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compat<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lub_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compat<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> lub_below_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_cont12<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">Z</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> compatible <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> <span class="free">Z</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span>  <span class="main">⊔</span> <span class="free">Z</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> <span class="free">Z</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">j</span><span class="main">.</span> <span class="free">Z</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> join_cont1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span> admD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compatible_adm2 <span class="quoted"><span class="quoted">‹chain <span class="free">Z</span>›</span></span> compat<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span> <span class="main">⊔</span> <span class="free">Z</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> join_cont2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Z</span>›</span></span> compat<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span> <span class="main">⊔</span> <span class="free">Z</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diag_lub<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> chainI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> join_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compat compat chainE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span><span class="main"><span class="main">]</span></span> below_refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> chainI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> join_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compat compat below_refl chainE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="free">Z</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> pcpo
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> bot_compatible<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="main">⊥</span>"</span></span> <span class="quoted"><span class="quoted">"compatible <span class="main">⊥</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compatible_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_commute is_lub_bin minimal<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="HOLCF-Join-Classes">
<div class="head">
<h1>Theory HOLCF-Join-Classes</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"HOLCF-Join-Classes"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="HOLCF-Join.html">HOLCF-Join</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">class</span></span> Finite_Join_cpo <span class="main">=</span> cpo <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_compatible<span class="main">:</span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> join_mono <span class="main">=</span> join_mono<span class="main">[</span><span class="operator">OF</span> all_compatible all_compatible <span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> join_above1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> all_compatible<span class="main">[</span><span class="operator">THEN</span> join_above1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> join_above2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> all_compatible<span class="main">[</span><span class="operator">THEN</span> join_above2<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> join_below<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> all_compatible<span class="main">[</span><span class="operator">THEN</span> join_below<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> join_below_iff <span class="main">=</span> all_compatible<span class="main">[</span><span class="operator">THEN</span> join_below_iff<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> join_assoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> join_assoc<span class="main">[</span><span class="operator">OF</span> all_compatible all_compatible all_compatible<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> join_comm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> all_compatible<span class="main">[</span><span class="operator">THEN</span> join_commute<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> join_lc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">z</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> join_assoc join_comm<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> join_cont'<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_compatible join_cont1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_cont1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Finite_Join_cpo"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> contI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monofunI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> below_refl join_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_imp_below<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_cont'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_cont2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Finite_Join_cpo"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> join_comm<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> join_cont1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_cont<span class="main">[</span><span class="operator">cont2cont</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> cont <span class="free">g</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont2cont_case_prod<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">g</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">p</span></span> <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">⊔</span></span> <span class="bound"><span class="bound">y</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> join_cont2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cont2cont_Pair<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">Finite_Join_cpo</span><span class="main">)</span> <span class="quoted">Finite_Join_cpo</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fun_join</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> f g <span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fun_join<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fun_join_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> beta_cfun<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span> cont2cont_lambda cont2cont_fun<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> compatibleI exI conjI strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> fun_join<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">y</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_below_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⊑</span> fun_join<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">y</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_below_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⊑</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fun_join<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">y</span> <span class="main">⊑</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_below_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"cfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">cpo</span><span class="main">,</span> <span class="quoted">Finite_Join_cpo</span><span class="main">)</span> <span class="quoted">Finite_Join_cpo</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">cfun_join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfun_join</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> f g  x<span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="main">⋅</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="bound">g</span> <span class="main">⋅</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cfun_join<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">g</span><span class="main">⋅</span><span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cfun_join_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> beta_cfun<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span> cont2cont_lambda cont2cont_fun<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> compatibleI exI conjI strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> cfun_join<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">y</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_below_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⊑</span> cfun_join<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">y</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_below_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⊑</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"cfun_join<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">y</span> <span class="main">⊑</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_below_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bot_lub<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">&lt;&lt;|</span> <span class="main">⊥</span> <span class="main">⟷</span>  <span class="free">S</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">⊥</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_lubD1 is_ubD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_lubI is_ubI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compatible_up<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compatible <span class="main">(</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">)</span> <span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> compatible <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"compatible <span class="main">(</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">)</span> <span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> z'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">,</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="skolem">z'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> compatible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="main">{</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">,</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> up<span class="main">⋅</span><span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z'</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_lub_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> up_below<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> compatible_def<span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"compatible <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> compatible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="main">{</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">,</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">}</span> <span class="main">&lt;&lt;|</span> up<span class="main">⋅</span><span class="skolem">z</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> is_lub_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_up_less_UU upE up_below<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"compatible <span class="main">(</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">)</span> <span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> compatible_def<span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">instance</span></span> u <span class="main">::</span> <span class="main">(</span><span class="quoted">Finite_Join_cpo</span><span class="main">)</span> <span class="quoted">Finite_Join_cpo</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compatible <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_compatible<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">class</span></span> is_unit <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">unit</span></span></span> <span class="keyword2"><span class="keyword">assumes</span></span> is_unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">unit</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> unit <span class="main">::</span> <span class="quoted">is_unit</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"unit <span class="main">≡</span> <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> lift <span class="main">::</span> <span class="main">(</span><span class="quoted">is_unit</span><span class="main">)</span> <span class="quoted">Finite_Join_cpo</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lift"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compatible <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_compatible<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> is_unit<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> is_unit<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">Finite_Join_cpo</span><span class="main">,</span> <span class="quoted">Finite_Join_cpo</span><span class="main">)</span> <span class="quoted">Finite_Join_cpo</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">x</span> <span class="main">⊔</span> fst <span class="skolem">y</span><span class="main">,</span> snd <span class="skolem">x</span> <span class="main">⊔</span> snd <span class="skolem">y</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compatible <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> compatibleI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> <span class="var">?z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⊑</span> <span class="var">?z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> <span class="skolem">z'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⊑</span> <span class="skolem">z'</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">⊑</span> <span class="skolem">z'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_join<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span>Finite_Join_cpo"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">x</span> <span class="main">⊔</span> fst <span class="free">y</span><span class="main">,</span> snd <span class="free">x</span> <span class="main">⊔</span> snd <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_joinI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span>Finite_Join_cpo"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> fst_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">x</span> <span class="main">⊔</span> fst <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> snd_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">x</span> <span class="main">⊔</span> snd <span class="free">y</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> prod_join <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_meet_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊔</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊔</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊔</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_joinI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_below_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fun_upd_meet_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊔</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span>  <span class="main">⊔</span> <span class="free">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cfun_meet_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊔</span> <span class="free">g</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊔</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free">f</span> <span class="main">⋅</span> <span class="bound">x</span> <span class="main">⊔</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_joinI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_below_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cfun_join_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">f</span><span class="main">⋅</span><span class="free">y</span> <span class="main">⊑</span> <span class="free">f</span><span class="main">⋅</span><span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> join_below monofun_cfun_arg join_above1 join_above2<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> join_self_below<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⊔</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊔</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊔</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Join_cpo<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> join_above2 larger_is_join1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> join_above1 larger_is_join2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> join_above2 larger_is_join1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> join_above1 larger_is_join2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> join_above1 join_above2 below_antisym larger_is_join1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> join_above2 join_above1 below_antisym larger_is_join2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_bottom_iff<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">∧</span> <span class="main">(</span><span class="free">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>Finite_Join_cpo<span class="main">,</span>pcpo<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_compatible join_bottom<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> join_comm join_idem<span class="main">)</span>

<span class="keyword1"><span class="command">class</span></span> Join_cpo <span class="main">=</span> cpo <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> exists_lub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">S</span> <span class="main">&lt;&lt;|</span> <span class="bound">u</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> Join_cpo
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">subclass</span></span> Finite_Join_cpo
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command">unfolding</span></span> compatible_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exists_lub<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> below_lubI<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Join_cpo"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊑</span> lub <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exists_lub is_ub_thelub_ex<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lub_belowI<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Join_cpo"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">⊑</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> lub <span class="free">S</span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exists_lub is_lub_thelub_ex is_ub_def<span class="main">)</span>

<span class="comment1">(* subclass (in Join_cpo)  pcpo *)</span>
<span class="keyword1"><span class="command">instance</span></span> Join_cpo <span class="main">⊆</span> pcpo
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"lub <span class="main"><span class="main">{}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lub_empty_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lub <span class="main">{}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⊥</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Join_cpo<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lub_eqI<span class="main">)</span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> lub_insert<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Join_cpo"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lub <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⊔</span> lub <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lub_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_above2<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_below_iff is_ub_def is_lub_def<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Env">
<div class="head">
<h1>Theory Env</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Env
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="HOLCF-Join-Classes.html">HOLCF-Join-Classes</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">default_sort</span></span> <span class="quoted">type</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Our type for environments is a function with a pcpo as the co-domain; this theory collects
related definitions.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The domain of a pcpo-valued function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">edom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span> <span class="main">⇒</span> <span class="tfree">'value</span><span class="main">::</span>pcpo<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'key</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">edom</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">⊥</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bot_edom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">⊥</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bot_edom2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">.</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> edomIff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">∈</span> edom <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> edom_iff2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="free">a</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span> <span class="main">∉</span> edom <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> edom_empty_iff_bot<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="free">m</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_bottom_iff bot_edom edomIff empty_iff fun_belowI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_not_edom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> edom <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span>edomIff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_edom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> edom <span class="free">m</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span>edomIff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> edom_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">⟹</span> edom <span class="free">x</span> <span class="main">⊆</span> edom <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> edom_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> below_bottom_iff fun_belowD<span class="main">)</span>
  

<span class="keyword1"><span class="command">lemma</span></span> edom_subset_adm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">ae'</span><span class="main">.</span> edom <span class="bound">ae'</span> <span class="main">⊆</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> admI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> edom_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">back</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> lub_fun<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> lub_eq_bottom_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ch2ch_fun<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> not_all
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command">unfolding</span></span> edom_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Updates›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> edom_fun_upd_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> insert <span class="free">x</span> <span class="main">(</span>edom <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> fun_upd_same<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> fun_upd_other<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Restriction›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">env_restr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>pcpo<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">env_restr</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">env_restr_rev</span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">f|`</span>"</span>  110<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">env_restr_rev</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> env_restr <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> env_restr_rev <span class="main">(</span><span class="quoted">"_<span class="keyword1">|⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟷</span> edom <span class="free">m</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def env_restr_def lambda_strict<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def env_restr_def lambda_strict<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">lemmas</span></span> env_restr_empty <span class="main">=</span> iffD2<span class="main">[</span><span class="operator">OF</span> env_restr_empty_iff<span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_env_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">m</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_env_restr_not_there<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span>env_restr <span class="free">S</span> <span class="free">m</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_env_restr_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">then</span> <span class="free">m</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_eqD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fun_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_belowI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_belowI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_belowD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">m<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fun_belowD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_env_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">f|`</span> <span class="free">d2</span> <span class="keyword1">f|`</span> <span class="free">d1</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="free">d1</span> <span class="main">∩</span> <span class="free">d2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_env_restr_subset<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="main">⊆</span> <span class="free">d2</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">f|`</span> <span class="free">d2</span> <span class="keyword1">f|`</span> <span class="free">d1</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">f|`</span> <span class="free">d1</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_absorb2 env_restr_env_restr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_useless<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="free">m</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_UNIV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">f|`</span> UNIV <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_useless<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_fun_upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">m1</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xa</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_fun_upd_other<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">m1</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xa</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_eq_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S'</span> <span class="main">=</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> env_restr_env_restr le_iff_inf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_below_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S'</span> <span class="main">⊑</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_belowI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_belowD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> edom_env<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> edom <span class="free">m</span> <span class="main">∩</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> edom_def env_restr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_below_self<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_below_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S1</span> <span class="main">⊑</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S1</span> <span class="main">⟹</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S2</span> <span class="main">⊑</span> <span class="free">m3</span> <span class="keyword1">f|`</span> <span class="free">S2</span> <span class="main">⟹</span> <span class="free">m1</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="free">S1</span> <span class="main">∩</span> <span class="free">S2</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">m3</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="free">S1</span> <span class="main">∩</span> <span class="free">S2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_belowI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_belowD <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_cont<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>env_restr <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont2cont_lambda<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> env_restr_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span> cont_fun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">⊑</span> <span class="free">m2</span> <span class="main">⟹</span>  <span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> env_restr_belowI fun_belowD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_mono2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S2</span> <span class="main">⊆</span> <span class="free">S1</span>  <span class="main">⟹</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S2</span> <span class="main">⊑</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> env_restr_below_self env_restr_env_restr_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> cont_compose<span class="main">[</span><span class="operator">OF</span> env_restr_cont<span class="main">,</span> <span class="operator">cont2cont</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> edom <span class="free">m</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">∩</span> <span class="free">S'</span> <span class="main">∪</span> <span class="main">-</span><span class="free">S</span> <span class="main">∩</span> <span class="main">-</span><span class="free">S'</span><span class="main">)</span>  <span class="main">⟹</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq edom_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Deleting›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">env_delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>pcpo<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">env_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_env_delete<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> env_delete <span class="free">x</span> <span class="free">m</span> <span class="free">x'</span> <span class="main">=</span> <span class="free">m</span> <span class="free">x'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_delete_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_env_delete_None<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="free">m</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_delete_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> edom_env_delete<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"edom <span class="main">(</span>env_delete <span class="free">x</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> edom <span class="free">m</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_delete_def edom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> edom_env_delete_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"edom <span class="main">(</span>env_delete <span class="free">x</span> <span class="free">m</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_fun_upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> env_delete <span class="free">x</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_delete_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_fun_upd2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>env_delete <span class="free">x</span> <span class="free">m</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_delete_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_fun_upd3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> env_delete <span class="free">x</span> <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>env_delete <span class="free">x</span> <span class="free">m</span><span class="main">)</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_delete_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_noop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> edom <span class="free">m</span> <span class="main">⟹</span> env_delete <span class="free">x</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_delete_def edom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_upd_env_delete<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> edom <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">(</span>env_delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_env_delete_other<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> env_delete <span class="free">x</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lookup_env_delete<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_restr<span class="main">:</span> <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> below_env_deleteI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">⊑</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">⊑</span> env_delete <span class="free">x</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> env_delete_def env_delete_restr env_restr_mono fun_upd_triv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_below_cong<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">e1</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">e2</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"env_delete <span class="free">v</span> <span class="free">e1</span> <span class="free">x</span> <span class="main">⊑</span> env_delete <span class="free">v</span> <span class="free">e2</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> env_delete_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_env_restr_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="main">(</span>env_restr <span class="free">S</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> env_restr <span class="free">S</span> <span class="main">(</span>env_delete <span class="free">x</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> env_delete_def env_restr_fun_upd env_restr_fun_upd_other fun_upd_triv lookup_env_restr_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">⊑</span> <span class="free">m'</span> <span class="main">⟹</span> env_delete <span class="free">x</span> <span class="free">m</span> <span class="main">⊑</span> env_delete <span class="free">x</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> env_delete_restr
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_mono<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> env_delete_below_arg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="free">m</span> <span class="main">⊑</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> env_delete_restr
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_below_self<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Merging of two functions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We'd like to have some nice syntax for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"override_on"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">override_on_syn</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">++⇘</span>_<span class="keyword1">⇙</span> _"</span> <span class="main">[</span>100<span class="main">,</span> 0<span class="main">,</span> 100<span class="main">]</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f1</span></span></span> ++<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">S</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">≡</span> override_on <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> override_on_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊥</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">m</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="main">⊥</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def env_restr_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> edom_override_on<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">m1</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">m2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>edom <span class="free">m1</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>edom <span class="free">m2</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def edom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_override_on_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m1</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">m2</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">then</span> <span class="free">m2</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">m1</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> override_on_upd_swap<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">z</span><span class="main">)</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">ρ'</span> <span class="main">=</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">ρ'</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def  edom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> override_on_upd<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">ρ</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">ρ'</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span></sub><span class="hidden">⇙</span> <span class="free">ρ'</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def  edom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m1</span> ++<span class="hidden">⇘</span><sub><span class="free">S2</span></sub><span class="hidden">⇙</span> <span class="free">m2</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span> ++<span class="hidden">⇘</span><sub><span class="free">S2</span></sub><span class="hidden">⇙</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def  edom_def env_restr_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_add<span class="main">:</span> <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="main">(</span><span class="free">m1</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">m2</span><span class="main">)</span> <span class="main">=</span> env_delete <span class="free">x</span> <span class="free">m1</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span></sub><span class="hidden">⇙</span> env_delete <span class="free">x</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def  edom_def env_restr_def env_delete_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Environments with binary joins›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> edom_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">f</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">g</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>Finite_Join_cpo<span class="main">,</span>pcpo<span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> edom <span class="free">f</span> <span class="main">∪</span> edom <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> edom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="main">(</span><span class="free">f</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">g</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>Finite_Join_cpo<span class="main">,</span>pcpo<span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> env_delete <span class="free">x</span> <span class="free">f</span> <span class="main">⊔</span> env_delete <span class="free">x</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> env_delete_def fun_upd_meet_simp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_join<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>Finite_Join_cpo<span class="main">,</span>pcpo<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m1</span> <span class="main">⊔</span> <span class="free">m2</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_join2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>Finite_Join_cpo<span class="main">,</span>pcpo<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊔</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S'</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">S'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_env_restr_UNIV<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>Finite_Join_cpo<span class="main">,</span>pcpo<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S1</span> <span class="main">∪</span> <span class="free">S2</span> <span class="main">=</span> UNIV <span class="main">⟹</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S1</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S2</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>Finite_Join_cpo<span class="main">,</span>pcpo<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊔</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_join2 Compl_partition<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_below_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">m'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">m'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">⊑</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ComplI fun_below_iff lookup_env_restr<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Singleton environments›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">esing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>pcpo<span class="main">}</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">esing</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> a<span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span> <span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">⊥</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> esing_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esing <span class="free">x</span> <span class="main">⋅</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> esing_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> esing_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>esing <span class="free">x</span> <span class="main">⋅</span> <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span>esing <span class="free">x</span> <span class="main">⋅</span> <span class="free">n</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> esing_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> esing_eq_up_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>esing <span class="free">x</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free">a'</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_below_iff esing_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> esing_below_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esing <span class="free">x</span> <span class="main">⋅</span> <span class="free">a</span> <span class="main">⊑</span> <span class="free">ae</span>  <span class="main">⟷</span> <span class="free">a</span> <span class="main">⊑</span> <span class="free">ae</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_below_iff esing_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> edom_esing_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>esing <span class="free">x</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> edom_def esing_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> edom_esing_up<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>esing <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span>up <span class="main">⋅</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> edom_def esing_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_esing<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="main">(</span>esing <span class="free">x</span> <span class="main">⋅</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> env_delete_def esing_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_esing<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> esing <span class="free">x</span><span class="main">⋅</span><span class="free">v</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> esing <span class="free">x</span><span class="main">⋅</span><span class="free">v</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> env_restr_useless <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_esing_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_esing2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> esing <span class="free">x</span><span class="main">⋅</span><span class="free">v</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_esing_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> esing_eq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"esing <span class="free">x</span><span class="main">⋅</span><span class="free">v</span> <span class="main">=</span> esing <span class="free">x</span><span class="main">⋅</span><span class="free">v'</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> esing_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pointwise">
<div class="head">
<h1>Theory Pointwise</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Pointwise <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Lifting a relation to a function.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pointwise</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pointwise</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pointwiseI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">m'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> pointwise <span class="free">P</span> <span class="free">m</span> <span class="free">m'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pointwise_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="HOLCF-Utils">
<div class="head">
<h1>Theory HOLCF-Utils</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"HOLCF-Utils"</span>
  <span class="keyword2"><span class="keyword">imports</span></span>  <a href="../../HOL/HOLCF/HOLCF.html">HOLCF</a> <a href="Pointwise.html">Pointwise</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">default_sort</span></span> <span class="quoted">type</span>

<span class="keyword1"><span class="command">lemmas</span></span> cont_fun<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> cont2cont_fun<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> cont_compose2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> cont <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">c</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cont_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>
            cont2cont_fun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
            cont2cont_lambda<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pointwise_adm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>pcpo <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>pcpo <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span> <span class="bound">m</span><span class="main">.</span> pointwise <span class="free">P</span> <span class="main">(</span>fst <span class="bound">m</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> admI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">Y</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> pointwiseI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> admD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> adm_subst<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">p</span></span> <span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span>fst <span class="bound"><span class="bound">p</span></span> <span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">,</span></span> snd <span class="bound"><span class="bound">p</span></span> <span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span></span> <span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> _ assms<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> pointwise_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cfun_beta_Pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"csplit<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> a b <span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> beta_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont2cont_LAM'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont2cont_fun<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> prod_cont_iff
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> fun_upd_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ρ1</span> <span class="main">⊑</span> <span class="free">ρ2</span> <span class="main">⟹</span> <span class="free">v1</span> <span class="main">⊑</span> <span class="free">v2</span> <span class="main">⟹</span> <span class="free">ρ1</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v1</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ρ2</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xa</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>fun_belowD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fun_upd_cont<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">cont2cont</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>pcpo<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cont2cont_lambda<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_upd_belowI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">z</span> <span class="main">.</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">ρ</span> <span class="bound">z</span> <span class="main">⊑</span> <span class="free">ρ'</span> <span class="bound">z</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">ρ'</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xa</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> cont_if_else_above<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"adm <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"cont <span class="var">?I</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> contI2 monofunI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">x</span> <span class="main">⊑</span> <span class="var">?I</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont2monofunE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont2monofunE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont2monofunE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chain <span class="skolem">Y</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">.</span> <span class="var">?I</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ch_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> below_refl cont2contlubE<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?I</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span> adm_def assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> True ch_f <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">Y</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≥</span> <span class="skolem">j</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> chain_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> is_ub_thelub<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lub_range_shift<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cont2contlubE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> chain_shift<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="var">?I</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="var">?I</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lub_range_shift<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">.</span> <span class="var">?I</span> <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">up2option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>cpo<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span> <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">up2option</span> Ibottom <span class="main">=</span> None"</span></span>
  <span class="main">|</span>     <span class="quoted"><span class="quoted">"<span class="free">up2option</span> <span class="main">(</span>Iup <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> up2option_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"up2option <span class="main">⊥</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"up2option <span class="main">(</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> up_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont_Iup inst_up_pcpo<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">option2up</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>cpo<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">option2up</span> None <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="main">|</span>     <span class="quoted"><span class="quoted">"<span class="free">option2up</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> up<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> option2up_up2option<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"option2up <span class="main">(</span>up2option <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> up2option_option2up<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"up2option <span class="main">(</span>option2up <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> adm_subst2<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> cont <span class="free">g</span> <span class="main">⟹</span> adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> admI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
      cont2contlubE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="main">]</span></span>  cont2contlubE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">g</span></span><span class="main"><span class="main">]</span></span>
      cont2contlubE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">snd</span><span class="main"><span class="main">]</span></span>  cont2contlubE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">fst</span><span class="main"><span class="main">]</span></span>
      <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Composition of fun and cfun›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cont2cont_comp <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> cont <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> comp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cont2cont_lambda<span class="main">)</span>
     <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span>  <span class="quoted"><span class="quoted">‹cont <span class="free">g</span>›</span></span> <span class="quoted"><span class="quoted">‹cont <span class="free">f</span>›</span></span> cont_compose2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont2cont_fun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> cont2cont_fun<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cfun_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>pcpo <span class="main">→</span> <span class="tfree">'b</span><span class="main">::</span>pcpo<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">cfun_comp</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> f ρ<span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">f</span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span> <span class="main">∘</span> <span class="bound">ρ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cfun_comp<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>cfun_comp<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">ρ</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">f</span><span class="main">⋅</span><span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cfun_comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cfun_comp_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cfun_comp<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">ρ</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span><span class="main">⋅</span><span class="main">(</span><span class="free">ρ</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cfun_comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fix_eq_fix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="main">(</span>fix<span class="main">⋅</span><span class="free">g</span><span class="main">)</span> <span class="main">⊑</span> fix<span class="main">⋅</span><span class="free">g</span> <span class="main">⟹</span> <span class="free">g</span><span class="main">⋅</span><span class="main">(</span>fix<span class="main">⋅</span><span class="free">f</span><span class="main">)</span> <span class="main">⊑</span> fix<span class="main">⋅</span><span class="free">f</span> <span class="main">⟹</span> fix<span class="main">⋅</span><span class="free">f</span> <span class="main">=</span> fix<span class="main">⋅</span><span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fix_least_below below_antisym<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Additional transitivity rules›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
These collect side-conditions of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"cont <span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, so the usual way to discharge them
is to write <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span>[source] <span class="raw_text"><span class="raw_text">"by this (intro cont2cont)+"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at the end.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> below_trans_cong<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">f</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">⟹</span> cont <span class="free">f</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊑</span> <span class="free">f</span> <span class="free">y</span> "</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_trans cont2monofunE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_bot_below_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_bottom_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_bot_below_trans_cong<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span> <span class="main">⟹</span> cont <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_bottom_iff cont2monofunE<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="EvalHeap">
<div class="head">
<h1>Theory EvalHeap</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"EvalHeap"</span>
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="AList-Utils.html">AList-Utils</a>"</span> <a href="Env.html">Env</a> <a href="../Nominal2/Nominal2.html">Nominal2.Nominal2</a> <span class="quoted">"<a href="HOLCF-Utils.html">HOLCF-Utils</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Conversion from heaps to environments›</span></span> 

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">evalHeap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">×</span> <span class="tfree">'exp</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'exp</span> <span class="main">⇒</span> <span class="tfree">'value</span><span class="main">::</span><span class="main">{</span>pure<span class="main">,</span>pcpo<span class="main">}</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'value</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">evalHeap</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">evalHeap</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">eval</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">evalHeap</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">eval</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">eval</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cont2cont_evalHeap<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">e</span> <span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">h</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="main">λ</span><span class="bound">ρ</span><span class="main">.</span> <span class="free">eval</span> <span class="bound">ρ</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="main">λ</span> <span class="bound">ρ</span><span class="main">.</span> evalHeap <span class="free">h</span> <span class="main">(</span><span class="free">eval</span> <span class="bound">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">h</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> evalHeap_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> evalHeap <span class="free">h</span> <span class="free">eval</span> <span class="main">=</span> evalHeap <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">eval</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fun_upd_eqvt  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> edom_evalHeap_subset<span class="main">:</span><span class="quoted"><span class="quoted">"edom <span class="main">(</span>evalHeap <span class="free">h</span> <span class="free">eval</span><span class="main">)</span> <span class="main">⊆</span> domA <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">eval</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evalHeap.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_fun_upd_subset<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> evalHeap_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">heap1</span> <span class="main">=</span> <span class="free">heap2</span> <span class="main">;</span>  <span class="main">(</span><span class="main">⋀</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">heap2</span> <span class="main">⟹</span> <span class="free">eval1</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">eval2</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟧</span>
    <span class="main">⟹</span>  evalHeap <span class="free">heap1</span> <span class="free">eval1</span> <span class="main">=</span> evalHeap <span class="free">heap2</span> <span class="free">eval2</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">heap2</span></span> <span class="quoted"><span class="free">eval2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">heap1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evalHeap.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lookupEvalHeap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> domA <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>evalHeap <span class="free">h</span> <span class="free">f</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">h</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evalHeap.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lookupEvalHeap'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>evalHeap <span class="free">Γ</span> <span class="free">f</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="free">f</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evalHeap.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lookupEvalHeap_other<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>evalHeap <span class="free">Γ</span> <span class="free">f</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evalHeap.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_evalHeap_noop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"domA <span class="free">h</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> env_restr <span class="free">S</span> <span class="main">(</span>evalHeap <span class="free">h</span> <span class="free">eval</span><span class="main">)</span> <span class="main">=</span> evalHeap <span class="free">h</span> <span class="free">eval</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookupEvalHeap <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lookupEvalHeap_other<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_evalHeap_same<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"env_restr <span class="main">(</span>domA <span class="free">h</span><span class="main">)</span> <span class="main">(</span>evalHeap <span class="free">h</span> <span class="free">eval</span><span class="main">)</span> <span class="main">=</span> evalHeap <span class="free">h</span> <span class="free">eval</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_evalHeap_noop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> evalHeap_cong'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="free">heap</span> <span class="main">⟹</span> <span class="free">eval1</span> <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">heap</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">eval2</span> <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">heap</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span>
    <span class="main">⟹</span>  evalHeap <span class="free">heap</span> <span class="free">eval1</span> <span class="main">=</span> evalHeap <span class="free">heap</span> <span class="free">eval2</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> domA <span class="free">heap</span>"</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookupEvalHeap<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lookupEvalHeapNotAppend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>evalHeap <span class="main">(</span><span class="free">Γ</span><span class="main">@</span><span class="free">h</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> evalHeap <span class="free">h</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> evalHeap_delete<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"evalHeap <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">eval</span> <span class="main">=</span> env_delete <span class="free">x</span> <span class="main">(</span>evalHeap <span class="free">Γ</span> <span class="free">eval</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> evalHeap_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span> <span class="main">⟹</span>
  evalHeap <span class="free">Γ</span> <span class="free">eval</span> <span class="main">⊑</span> evalHeap <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">eval</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xa</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xa</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Reordering lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> evalHeap_reorder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="main">=</span> map_of <span class="free">Δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalHeap <span class="free">Γ</span> <span class="free">h</span> <span class="main">=</span> evalHeap <span class="free">Δ</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">=</span> domA <span class="free">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_map_of_conv_domA<span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"evalHeap <span class="free">Γ</span> <span class="free">h</span> <span class="skolem">x</span> <span class="main">=</span> evalHeap <span class="free">Δ</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> *
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookupEvalHeap<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> evalHeap_reorder_head<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalHeap <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e1</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">e2</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">)</span> <span class="free">eval</span> <span class="main">=</span> evalHeap <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">e2</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e1</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">)</span> <span class="free">eval</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> evalHeap_reorder<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_twist<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> evalHeap_reorder_head_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalHeap <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">@</span><span class="free">Δ</span><span class="main">)</span> <span class="free">eval</span> <span class="main">=</span> evalHeap <span class="main">(</span><span class="free">Γ</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="free">eval</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> evalHeap_reorder<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> assms dom_map_of_conv_domA map_add_upd_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> evalHeap_subst_exp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free">e</span> <span class="main">=</span> <span class="free">eval</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evalHeap <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">)</span> <span class="free">eval</span> <span class="main">=</span> evalHeap <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e'</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">)</span> <span class="free">eval</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Nominal-Utils">
<div class="head">
<h1>Theory Nominal-Utils</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Nominal-Utils"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Nominal2/Nominal2.html">Nominal2.Nominal2</a> <span class="quoted">"<a href="../../HOL/HOL-Library/AList.html">HOL-Library.AList</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas helping with equivariance proofs›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perm_rel_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">π</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">r</span> <span class="main">(</span><span class="bound">π</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">π</span> <span class="main">∙</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">r</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> perm_rel_lemma2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">π</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">(</span><span class="bound">π</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">π</span> <span class="main">∙</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">r</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_eqvtI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">p</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_at_apply<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eqvt_at <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> assms eqvt_at_def permute_fun_def permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_at_apply'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eqvt_at <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> assms eqvt_at_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_at_apply''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eqvt_at <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> assms eqvt_at_def permute_fun_def permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> size_list_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> size_list <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> size_list <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_pure<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Cons
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_pure<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Freshness via equivariance›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_fresh_cong1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">f</span> <span class="free">x</span> "</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fresh_fun_eqvt_app<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eqvtI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_reflection<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> permute_fun_def permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_fresh_cong2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fresh1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">f</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eqvt
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fresh1 fresh2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fresh_fun_eqvt_app<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_fresh_star_cong1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fresh1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_def eqvt_fresh_cong1 assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_fresh_star_cong2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fresh1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">f</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_def eqvt_fresh_cong2 assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_fresh_cong3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fresh1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eqvt <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eqvt
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fresh1 fresh2 fresh3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fresh_fun_eqvt_app<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_fresh_star_cong3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fresh1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fresh3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_def eqvt_fresh_cong3 assms<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Additional simplification rules›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_self_fresh<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">x</span> <span class="main">⟷</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_at_base<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_star_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="free">x</span> <span class="main">}</span> <span class="main">♯*</span> <span class="free">e</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Additional equivariance lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">x</span> <span class="free">π</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">π</span> <span class="main">∙</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">f</span> <span class="free">x</span> "</span></span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> <span class="free">f</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> range_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> range <span class="free">Y</span> <span class="main">=</span> range <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> image_eqvt UNIV_eqvt <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_option_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> case_option <span class="free">d</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> case_option <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supp_option_eqvt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"supp <span class="main">(</span>case_option <span class="free">d</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">d</span> <span class="main">∪</span> supp <span class="free">f</span> <span class="main">∪</span> supp <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Some <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> Un_iff subsetCE supp_fun_app<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> funpow_eqvt<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>pt<span class="main">)</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">^^</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">n</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">perm_simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> delete_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> AList.delete <span class="free">x</span> <span class="free">Γ</span> <span class="main">=</span> AList.delete <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> AList.restrict <span class="free">S</span> <span class="free">Γ</span> <span class="main">=</span> AList.restrict <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> AList.restrict_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">lemma</span></span> supp_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"supp <span class="main">(</span>AList.restrict <span class="free">S</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">Γ</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Pair supp_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> clearjunk_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> AList.clearjunk <span class="free">Γ</span> <span class="main">=</span> AList.clearjunk <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> clearjunk.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_ran_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> map_ran <span class="free">f</span> <span class="free">Γ</span> <span class="main">=</span> map_ran <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_perm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dom_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> dom_perm_rev<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">eqvt</span><span class="main">]</span> <span class="main">=</span> dom_perm<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> ran_perm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>ran <span class="free">f</span><span class="main">)</span> <span class="main">=</span> ran <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ran_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="free">m1</span> <span class="main">++</span> <span class="free">m2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">m1</span><span class="main">)</span> <span class="main">++</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">m2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_add_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> map_of <span class="free">l</span> <span class="main">=</span> map_of <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">perm_simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> concat_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> concat <span class="free">l</span> <span class="main">=</span> concat <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eqvt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tranclp_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> tranclp <span class="free">P</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> tranclp <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> tranclp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> rtranclp <span class="free">P</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> rtranclp <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> rtranclp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">lemma</span></span> Set_filter_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> Set.filter <span class="free">P</span> <span class="free">S</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Set.filter_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_eqvt'<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> Sigma <span class="main">=</span> Sigma"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> permute_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> permute_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sigma_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">perm_simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_self<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> override_on_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>override_on <span class="free">m1</span> <span class="free">m2</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> override_on <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">m1</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">m2</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> card_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>card <span class="free">S</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_insert_if mem_permute_iff permute_pure<span class="main">)</span>

<span class="comment1">(* Helper lemmas provided by Christian Urban *)</span>

<span class="keyword1"><span class="command">lemma</span></span> Projl_permute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> Inl <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="main">(</span>Sum_Type.projl <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sum_Type.projl <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Projr_permute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> Inr <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="main">(</span>Sum_Type.projr <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sum_Type.projr <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Freshness lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_list_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_not_fresh<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">L</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span>atom <span class="free">x</span> <span class="main">♯</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_list_elem not_self_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_fresh_star<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> pure<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def pure_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supp_set_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">L</span> <span class="main">⟹</span> supp <span class="free">x</span> <span class="main">⊆</span> supp <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_supp_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">L</span> <span class="main">⊆</span> set <span class="free">L2</span> <span class="main">⟹</span> supp <span class="free">L</span> <span class="main">⊆</span> supp <span class="free">L2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Cons supp_Nil <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>supp_set_mem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_star_at_base<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> at_base"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">♯*</span> <span class="free">x</span> <span class="main">⟷</span> atom <span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_at_base<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fresh_star_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Freshness and support for subsets of variables›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supp_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">B</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>fs set<span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> supp <span class="free">A</span> <span class="main">⊆</span> supp <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> infinite_super subset_Un_eq supp_of_finite_union<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">B</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="free">B</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>at_base set<span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">♯</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>supp_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_star_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">B</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">B</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>at_base set<span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">♯*</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_def fresh_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_star_set_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">B</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>at_base list<span class="main">)</span> <span class="main">⟹</span> set <span class="free">A</span> <span class="main">⊆</span> set <span class="free">B</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">♯*</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_set fresh_star_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_set<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The set of free variables of an expression›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>pt <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>at_base set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> atom <span class="bound">v</span> <span class="main">∈</span> supp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_eqvt<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span> <span class="main">=</span> fv <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def supp_Nil<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fv_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">x</span> <span class="main">∪</span> fv <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def supp_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fv_Pair<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">x</span> <span class="main">∪</span> fv <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def supp_Pair<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fv_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">x</span> <span class="main">∪</span> fv <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def supp_append<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fv_at_base<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="free">a</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>at_base<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def supp_at_base<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fv_pure<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>pure<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def pure_supp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_set_at_base<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">l</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> at_base<span class="main">)</span> list<span class="main">)</span> <span class="main">=</span> set <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> flip_not_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> fv <span class="free">x</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∉</span> fv <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> flip_def fresh_def fv_def mem_Collect_eq swap_fresh_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_not_fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∉</span> fv <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_def fresh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fv <span class="free">e</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⟹</span>  atom <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>at_base<span class="main">)</span><span class="main">)</span> <span class="main">♯</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⟷</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_def fresh_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_finite_set_at_base<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fv <span class="main">(</span><span class="free">e</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>fs<span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>at_base<span class="main">)</span> set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_supp<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>atom <span class="main">-`</span> supp <span class="free">e</span> <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_vimageI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>atom <span class="main">-`</span> supp <span class="free">e</span>  <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">=</span> fv <span class="free">e</span>"</span></span>   <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fv_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>fs <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>at_base list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fv_list</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">l</span><span class="main">.</span> set <span class="bound">l</span> <span class="main">=</span> fv <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_fv_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fv_list <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>at_base<span class="main">)</span> set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fv <span class="free">e</span> <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_fv<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> finite_list<span class="main">[</span><span class="operator">OF</span> finite_fv<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fv_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_fv_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="main">(</span>fv_list <span class="free">e</span> <span class="main">::</span> <span class="tfree">'b</span><span class="main">::</span>at_base list<span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">♯</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">::</span> <span class="tfree">'b</span><span class="main">::</span>at_base set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="main">(</span>fv_list <span class="free">e</span> <span class="main">::</span> <span class="tfree">'b</span><span class="main">::</span>at_base list<span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">♯</span> set <span class="main">(</span>fv_list <span class="free">e</span> <span class="main">::</span> <span class="tfree">'b</span><span class="main">::</span>at_base list<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fresh_set<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">♯</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">::</span> <span class="tfree">'b</span><span class="main">::</span>at_base set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Other useful lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pure_permute_id<span class="main">:</span> <span class="quoted"><span class="quoted">"permute <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>pure<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_pure<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supp_set_elem_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>fs<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> supp <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> supp <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms supp_of_finite_sets
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> fresh_star_Cons <span class="main">=</span> fresh_star_list<span class="main">(</span>2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_permute_set<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">S</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">-</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_permute_iff permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flip_set_both_not_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x'</span> <span class="main">↔</span> <span class="free">x</span><span class="main">)</span> <span class="main">∙</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> permute_set_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> assms flip_at_base_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_atom<span class="main">:</span> <span class="quoted"><span class="quoted">"inj atom"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atom_eq_iff injI<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> image_Int<span class="main">[</span><span class="operator">OF</span> inj_atom<span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_uncurry<span class="main">:</span> <span class="quoted"><span class="quoted">"eqvt <span class="free">f</span> <span class="main">⟹</span> eqvt <span class="main">(</span>case_prod <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eqvt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> supp_fun_app_eqvt2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"eqvt <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">x</span> <span class="main">∪</span> supp <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> supp_fun_app_eqvt<span class="main">[</span><span class="operator">OF</span> eqvt_uncurry <span class="main"><span class="main">[</span></span><span class="operator">OF</span> a<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>case_prod <span class="free">f</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Pair<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supp_fun_app_eqvt3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"eqvt <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="free">x</span> <span class="main">∪</span> supp <span class="free">y</span> <span class="main">∪</span> supp <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> supp_fun_app_eqvt2<span class="main">[</span><span class="operator">OF</span> eqvt_uncurry <span class="main"><span class="main">[</span></span><span class="operator">OF</span> a<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>case_prod <span class="free">f</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∪</span> supp <span class="free">z</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Pair<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Fighting eta-contraction *)</span>
<span class="keyword1"><span class="command">lemma</span></span> permute_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"permute <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> permute_comp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"permute <span class="free">x</span> <span class="main">∘</span> permute <span class="free">y</span> <span class="main">=</span> permute <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_permute<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>permute <span class="free">p</span><span class="main">)</span> <span class="main">=</span> permute <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_star_restrictA<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">♯*</span> AList.restrict <span class="free">V</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Cons<span class="main">)</span>

 

<span class="comment1">(* Unused. Still submit? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> Abs_lst_Nil_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[]</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>fs<span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span><span class="keyword1">]lst.</span> <span class="free">x'</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> Abs_lst_fcb2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span> <span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> as <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> bs <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">xs</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">()</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* Unused. Still submit? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> Abs_lst_Nil_eq2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>fs<span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="keyword1">]lst.</span> <span class="free">x'</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span> <span class="operator">auto</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AList-Utils-Nominal">
<div class="head">
<h1>Theory AList-Utils-Nominal</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"AList-Utils-Nominal"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="AList-Utils.html">AList-Utils</a>"</span> <span class="quoted">"<a href="Nominal-Utils.html">Nominal-Utils</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Freshness lemmas related to associative lists›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> domA_not_fresh<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span>atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Cons fresh_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_delete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> delete <span class="free">v</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_star_delete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">♯*</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">♯*</span> delete <span class="free">v</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fresh_delete <span class="keyword1"><span class="command">unfolding</span></span> fresh_star_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_delete_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fv <span class="main">(</span>delete <span class="free">v</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fresh_delete <span class="keyword1"><span class="command">unfolding</span></span> fresh_def fv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_heap_expr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_list_elem fresh_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_heap_expr'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Cons fresh_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_star_heap_expr'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">♯*</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">♯*</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_def fresh_heap_expr'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_map_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Cons fresh_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_star_map_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_map_of<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> domA_fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">⊆</span> fv <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span> <span class="main">⟹</span> fv <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_Some_fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span> <span class="main">⟹</span> fv <span class="free">e</span> <span class="main">⊆</span> fv <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domA_from_set map_of_fv_subset map_of_SomeD option.sel<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Equivariance lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> domA<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> domA <span class="free">Γ</span> <span class="main">=</span> domA <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domA_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCollect<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> mapCollect <span class="free">f</span> <span class="free">m</span> <span class="main">=</span> mapCollect <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mapCollect_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Freshness and distinctness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_distinct<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> <span class="free">S</span> <span class="main">♯*</span> <span class="free">Γ</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> domA <span class="free">Γ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">∈</span> supp <span class="free">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Cons domA_def supp_Pair supp_at_base<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> domA <span class="free">Γ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_distinct_list<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> <span class="free">S</span> <span class="main">♯*</span> <span class="free">l</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> set <span class="free">l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjoint_iff_not_equal fresh_list_elem fresh_star_def image_eqI not_self_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_distinct_fv<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> <span class="free">S</span> <span class="main">♯*</span> <span class="free">l</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> fv <span class="free">l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjoint_iff_not_equal fresh_star_def fv_not_fresh image_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pure codomains›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> domA_fv_pure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>at_base <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span>pure<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"fv <span class="free">Γ</span> <span class="main">=</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> domA_fresh_pure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>at_base <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span>pure<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span> <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span>atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> domA_fv_pure<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def fresh_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Nominal-HOLCF">
<div class="head">
<h1>Theory Nominal-HOLCF</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Nominal-HOLCF"</span>
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Nominal-Utils.html">Nominal-Utils</a>"</span> <span class="quoted">"<a href="HOLCF-Utils.html">HOLCF-Utils</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Type class of continuous permutations and variations thereof›</span></span>

<span class="keyword1"><span class="command">class</span></span> cont_pt <span class="main">=</span> 
  cpo <span class="main">+</span> 
  pt <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> perm_cont<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> cont <span class="main">(</span><span class="main">(</span>permute <span class="bound">p</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>cpo<span class="main">,</span>pt<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">class</span></span> discr_pt <span class="main">=</span> 
  discrete_cpo <span class="main">+</span> 
  pt

<span class="keyword1"><span class="command">class</span></span> pcpo_pt <span class="main">=</span> 
  cont_pt <span class="main">+</span> 
  pcpo

<span class="keyword1"><span class="command">instance</span></span> pcpo_pt <span class="main">⊆</span> cont_pt
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> perm_cont<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> discr_pt <span class="main">⊆</span> cont_pt
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cont_pt<span class="main">)</span> perm_cont_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">π</span> <span class="main">∙</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> cont2monofunE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> perm_cont<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span><span class="free"><span class="free">π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> cont2monofunE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> perm_cont<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cont_pt<span class="main">)</span> perm_below_to_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">⊑</span> <span class="main">-</span> <span class="free">π</span> <span class="main">∙</span>  <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> perm_cont_simp pt_class.permute_minus_cancel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
 
<span class="keyword1"><span class="command">lemma</span></span> perm_is_ub_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">S</span> <span class="main">&lt;|</span> <span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>cont_pt<span class="main">)</span> <span class="main">⟷</span> <span class="free">S</span> <span class="main">&lt;|</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ub_def permute_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> perm_is_ub_eqvt<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">&lt;|</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>cont_pt<span class="main">)</span> <span class="main">⟹</span> <span class="free">π</span> <span class="main">∙</span> <span class="free">S</span> <span class="main">&lt;|</span> <span class="free">π</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> perm_is_lub_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">S</span> <span class="main">&lt;&lt;|</span> <span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>cont_pt<span class="main">)</span> <span class="main">⟷</span> <span class="free">S</span> <span class="main">&lt;&lt;|</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> perm_rel_lemma<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_lubI is_lubD1 is_lubD2 perm_cont_simp perm_is_ub_simp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> perm_is_lub_eqvt<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">&lt;&lt;|</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>cont_pt<span class="main">)</span> <span class="main">==&gt;</span> <span class="free">π</span> <span class="main">∙</span> <span class="free">S</span> <span class="main">&lt;&lt;|</span> <span class="free">π</span> <span class="main">∙</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> perm_cont2cont<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">cont2cont</span><span class="main">]</span> <span class="main">=</span> cont_compose<span class="main">[</span><span class="operator">OF</span> perm_cont<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> perm_still_cont<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> cont <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> cont_pt<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">::</span> cont_pt<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> imp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="main">(</span><span class="bound">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="bound">π</span><span class="main">.</span> cont <span class="bound">f</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="bound">π</span> <span class="main">∙</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> permute_fun_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cont_compose perm_cont<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> imp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span>"</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> imp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">π</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perm_bottom<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">(</span><span class="main">⊥</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>cont_pt<span class="main">,</span>pcpo<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">⊑</span> <span class="main">-</span><span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="main">⊥</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>cont_pt<span class="main">,</span>pcpo<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">⊥</span> <span class="main">⊑</span> <span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="main">-</span><span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="main">⊥</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>cont_pt<span class="main">,</span>pcpo<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> cont2monofunE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> perm_cont<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">⊥</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⊥</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>cont_pt<span class="main">,</span>pcpo<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">(</span><span class="main">⊥</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>cont_pt<span class="main">,</span>pcpo<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bot_supp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">⊥</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> pcpo_pt<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> supp_fun_eqvt<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bot_fresh<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="main">(</span><span class="main">⊥</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> pcpo_pt<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bot_fresh_star<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯*</span> <span class="main">(</span><span class="main">⊥</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> pcpo_pt<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> below_eqvt <span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="free">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>cont_pt<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_pure<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lub_eqvt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">S</span> <span class="main">&lt;&lt;|</span> <span class="main">(</span><span class="bound">z</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>cont_pt<span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">π</span> <span class="main">∙</span> lub <span class="free">S</span> <span class="main">=</span> lub <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lub_eqI perm_is_lub_simp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chain_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>cont_pt"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">F</span> <span class="main">⟹</span> chain <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> i <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> chainE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> perm_cont_simp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> π <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">π</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_fun_app_eq permute_pure<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Instance for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> cfun<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"cfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">cont_pt</span><span class="main">,</span> <span class="quoted">cont_pt</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">::</span> <span class="tfree">'a</span>  <span class="main">→</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⋅</span> <span class="main">(</span><span class="main">-</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_cfun_def eta_cfun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_cfun_def cfun_eqI minus_add<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> permute_cfun_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"permute <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span>Abs_cfun <span class="main">(</span>permute <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">oo</span> <span class="bound">f</span> <span class="keyword1">oo</span> <span class="main">(</span>Abs_cfun <span class="main">(</span>permute <span class="main">(</span><span class="main">-</span><span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cfun_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_cfun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Cfun_app_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="free">f</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> permute_cfun_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> permute_Lam<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∙</span> <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> permute_cfun_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abs_cfun_inverse2 eqvt_lambda unpermute_def <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Abs_cfun_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> Abs_cfun<span class="main">)</span> <span class="free">f</span> <span class="main">=</span> Abs_cfun <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> permute_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permute_Lam perm_still_cont permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cfun_eqvtI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">f</span> <span class="main">⋅</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cfun_app_eqvt cfun_eqI permute_minus_cancel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ID_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> ID <span class="main">=</span> ID"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ID_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">perm_simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_cfun_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"cfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">cont_pt</span><span class="main">,</span> <span class="quoted">cont_pt</span><span class="main">)</span> <span class="quoted">cont_pt</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">subst</span> permute_cfun_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"cfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>pure<span class="main">,</span>cont_pt<span class="main">}</span>"</span></span><span class="main">,</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>pure<span class="main">,</span>cont_pt<span class="main">}</span>"</span></span><span class="main">)</span> <span class="quoted">pure</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_cfun_def permute_pure Cfun.cfun.Rep_cfun_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"cfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">cont_pt</span><span class="main">,</span> <span class="quoted">pcpo_pt</span><span class="main">)</span> <span class="quoted">pcpo_pt</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Instance for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> fun<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> permute_fun_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"permute <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span>permute <span class="free">p</span><span class="main">)</span> <span class="main">∘</span> <span class="bound">f</span> <span class="main">∘</span> <span class="main">(</span>permute <span class="main">(</span><span class="main">-</span><span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> comp_apply eqvt_lambda unpermute_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">pt</span><span class="main">,</span> <span class="quoted">cont_pt</span><span class="main">)</span> <span class="quoted">cont_pt</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont2cont_lambda<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> permute_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> perm_cont2cont<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont_fun<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fix_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> fix <span class="main">=</span> <span class="main">(</span>fix <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">→</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>cont_pt<span class="main">,</span>pcpo<span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> permute_cfun_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main"><span class="main">[</span></span><span class="operator">OF</span> adm_subst2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_self<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Instance for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> u<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="comment1">(* Everything very pure. Does this work?
instantiation u :: (cpo) pt
begin
  definition "p ∙ (x :: 'a u) = x"
  instance by standard (auto simp add: permute_u_def)
end
instance u :: (cpo) pure by standard (simp add: permute_u_def)
instance u :: (cpo) cont_pt by standard (simp add: pure_permute_id)
instance u :: (cpo) pcpo_pt ..
*)</span>


<span class="keyword1"><span class="command">instantiation</span></span> u <span class="main">::</span> <span class="main">(</span><span class="quoted">cont_pt</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> u<span class="main">)</span> <span class="main">=</span> fup<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> up<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_u_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_u_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> u <span class="main">::</span> <span class="main">(</span><span class="quoted">cont_pt</span><span class="main">)</span> <span class="quoted">cont_pt</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="comment1">(* Fighting eta contraction... *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permute <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> fup<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> up<span class="main">⋅</span><span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span> <span class="tfree">'a</span> u<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> permute_u_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> fup<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> up<span class="main">⋅</span><span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span> <span class="tfree">'a</span> u<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>permute <span class="skolem">p</span> <span class="main">::</span> <span class="tfree">'a</span> u <span class="main">⇒</span> <span class="tfree">'a</span> u<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span> u <span class="main">::</span> <span class="main">(</span><span class="quoted">cont_pt</span><span class="main">)</span> <span class="quoted">pcpo_pt</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">class</span></span> pure_cont_pt <span class="main">=</span> pure <span class="main">+</span> cont_pt

<span class="keyword1"><span class="command">instance</span></span> u <span class="main">::</span> <span class="main">(</span><span class="quoted">pure_cont_pt</span><span class="main">)</span> <span class="quoted">pure</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_u_def permute_pure<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  


<span class="keyword1"><span class="command">lemma</span></span> up_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> up <span class="main">=</span> up"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> permute_cfun_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_u_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fup_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> fup <span class="main">=</span> fup"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> permute_cfun_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> permute_cfun_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xa</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_self<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Instance for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> lift<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> lift <span class="main">::</span> <span class="main">(</span><span class="quoted">pt</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> lift<span class="main">)</span> <span class="main">=</span> case_lift <span class="main">⊥</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> Def <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_lift_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_lift_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> lift <span class="main">::</span> <span class="main">(</span><span class="quoted">pt</span><span class="main">)</span> <span class="quoted">cont_pt</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="comment1">(* Fighting eta contraction... *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permute <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> case_lift <span class="main">⊥</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> Def <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> lift<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> permute_lift_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> case_lift <span class="main">⊥</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> Def <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> lift<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>permute <span class="skolem">p</span> <span class="main">::</span> <span class="tfree">'a</span> lift <span class="main">⇒</span> <span class="tfree">'a</span> lift<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span> lift <span class="main">::</span> <span class="main">(</span><span class="quoted">pt</span><span class="main">)</span> <span class="quoted">pcpo_pt</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">instance</span></span> lift <span class="main">::</span> <span class="main">(</span><span class="quoted">pure</span><span class="main">)</span> <span class="quoted">pure</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_lift_def permute_pure<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

<span class="keyword1"><span class="command">lemma</span></span> Def_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>Def <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Def <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_lift_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> case_lift_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> case_lift <span class="free">d</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> case_lift <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_self<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Instance for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> prod<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">instance</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">cont_pt</span><span class="main">,</span> <span class="quoted">cont_pt</span><span class="main">)</span> <span class="quoted">cont_pt</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="comment1">(* Fighting eta contraction... *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permute <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> prod<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> fst <span class="bound">x</span><span class="main">,</span> <span class="skolem">p</span> <span class="main">∙</span> snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>permute <span class="skolem">p</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> prod  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> prod<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Env-HOLCF">
<div class="head">
<h1>Theory Env-HOLCF</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Env-HOLCF"</span>
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Env.html">Env</a> <span class="quoted">"<a href="HOLCF-Utils.html">HOLCF-Utils</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Continuity and pcpo-valued functions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>  override_on_belowI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">y</span> <span class="bound">a</span> <span class="main">⊑</span> <span class="free">z</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span> <span class="bound">a</span> <span class="main">⊑</span> <span class="free">z</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xa</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> override_on_cont1<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cont2cont_lambda<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> override_on_cont2<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">m</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cont2cont_lambda<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> override_on_cont2cont<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">cont2cont</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cont_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> override_on_cont1 cont_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> override_on_cont2 assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> override_on_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">x2</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>cpo<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">⊑</span> <span class="free">y2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">y1</span> <span class="main">⊑</span> <span class="free">x2</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">y2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont2monofunE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> override_on_cont1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> cont2monofunE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> override_on_cont2 assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_upd_below_env_deleteI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="free">ρ</span> <span class="main">⊑</span> env_delete <span class="free">x</span> <span class="free">ρ'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">ρ'</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fun_upd_belowI   <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_delete_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_belowD fun_upd_other<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_upd_belowI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">z</span> <span class="main">.</span> <span class="bound">z</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">ρ</span> <span class="bound">z</span> <span class="main">⊑</span> <span class="free">ρ'</span> <span class="bound">z</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_belowI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms below_bottom_iff lookup_env_restr_not_there<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_belowI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">m1</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">m2</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms env_restr_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> env_restr_below_itself<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

<span class="keyword1"><span class="command">lemma</span></span> env_restr_cont<span class="main">:</span>  <span class="quoted"><span class="quoted">"cont <span class="main">(</span>env_restr <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont2cont_lambda<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_belowD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">m2</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_belowD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="free">x</span> <span class="main">=</span> <span class="free">m2</span>  <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lookup_env_restr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_below_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S'</span> <span class="main">⊑</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">m2</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> env_restr_belowI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> env_restr_belowD<span class="main">)</span>



<span class="keyword1"><span class="command">lemma</span></span>  override_on_below_restrI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">" <span class="free">x</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">z</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">z</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> override_on_belowI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>env_restr_belowD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  fmap_below_add_restrI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">y</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">z</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fun_belowI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>env_restr_belowD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_override_on_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> env_restr_cont2cont<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">cont2cont</span><span class="main">]</span> <span class="main">=</span> cont_compose<span class="main">[</span><span class="operator">OF</span> env_restr_cont<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_cont<span class="main">:</span>  <span class="quoted"><span class="quoted">"cont <span class="main">(</span>env_delete <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont2cont_lambda<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">lemmas</span></span> env_delete_cont2cont<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">cont2cont</span><span class="main">]</span> <span class="main">=</span> cont_compose<span class="main">[</span><span class="operator">OF</span> env_delete_cont<span class="main">]</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="HasESem">
<div class="head">
<h1>Theory HasESem</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> HasESem
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Nominal-HOLCF.html">Nominal-HOLCF</a>"</span> <span class="quoted">"<a href="Env-HOLCF.html">Env-HOLCF</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A local to work abstract in the expression type and semantics.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> has_ESem <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ESem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'exp</span><span class="main">::</span>pt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">::</span>at_base <span class="main">⇒</span> <span class="tfree">'value</span><span class="main">)</span> <span class="main">→</span> <span class="tfree">'value</span><span class="main">::</span><span class="main">{</span>pure<span class="main">,</span>pcpo<span class="main">}</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ESem_syn</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟦</span> _ <span class="keyword1">⟧⇘</span>_<span class="keyword1">⇙</span>"</span>  <span class="main">[</span>0<span class="main">,</span>0<span class="main">]</span> 110<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟦</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span>⟧<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">ρ</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> <span class="free">ESem</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> has_ignore_fresh_ESem <span class="main">=</span> has_ESem <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fv_supp<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">e</span> <span class="main">=</span> atom <span class="main">`</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ESem_considers_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Iterative">
<div class="head">
<h1>Theory Iterative</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Iterative
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Env-HOLCF.html">Env-HOLCF</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A setup for defining a fixed point of mutual recursive environments iteratively
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> iterative <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>pcpo"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">→</span> <span class="tfree">'b</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ne<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">==</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ'<span class="main">.</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">e1</span> <span class="main">⋅</span> <span class="bound">ρ'</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e2</span> <span class="main">⋅</span> <span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">==</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="keyword1">Λ</span> ρ''<span class="main">.</span> <span class="bound">ρ'</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="free">e1</span> <span class="main">⋅</span> <span class="bound">ρ''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">==</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ'<span class="main">.</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="main">(</span>fix <span class="main">⋅</span> <span class="main">(</span>H <span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e2</span> <span class="main">⋅</span> <span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">==</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ'<span class="main">.</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="main">(</span>fix <span class="main">⋅</span> <span class="main">(</span>H <span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">e2</span> <span class="main">⋅</span> <span class="main">(</span>fix <span class="main">⋅</span> <span class="main">(</span>H <span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> split_x<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">y</span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">lemmas</span></span> below <span class="main">=</span> fun_belowI<span class="main">[</span><span class="operator">OF</span> split_x<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y1 <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> eq <span class="main">=</span> ext<span class="main">[</span><span class="operator">OF</span> split_x<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y1 <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span>"</span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">lemma</span></span> lookup_fix<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fix <span class="main">⋅</span> <span class="free">F</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">F</span> <span class="main">⋅</span> <span class="main">(</span>fix <span class="main">⋅</span> <span class="free">F</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> R_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span>fix <span class="main">⋅</span> R<span class="main">)</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">e1</span> <span class="main">⋅</span> <span class="main">(</span>fix <span class="main">⋅</span> <span class="main">(</span>H <span class="main">(</span>fix <span class="main">⋅</span> R<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_x<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">lemma</span></span> R'_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span>fix <span class="main">⋅</span> R'<span class="main">)</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">e1</span> <span class="main">⋅</span> <span class="main">(</span>fix <span class="main">⋅</span> <span class="main">(</span>H <span class="main">(</span>fix <span class="main">⋅</span> R'<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_x<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">lemma</span></span> HR_is_R<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fix<span class="main">⋅</span><span class="main">(</span>H <span class="main">(</span>fix <span class="main">⋅</span> R<span class="main">)</span><span class="main">)</span> <span class="main">=</span> fix <span class="main">⋅</span> R"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">lemma</span></span> HR'_is_R'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fix <span class="main">⋅</span> <span class="main">(</span>H <span class="main">(</span>fix <span class="main">⋅</span> R'<span class="main">)</span><span class="main">)</span> <span class="main">=</span> fix <span class="main">⋅</span> R'"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">lemma</span></span> H_noop<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ'</span> <span class="free">ρ''</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">e1</span> <span class="main">⋅</span> <span class="free">ρ''</span><span class="main">)</span> <span class="bound">y</span> <span class="main">⊑</span> <span class="free">ρ'</span> <span class="bound">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H <span class="free">ρ'</span> <span class="main">⋅</span> <span class="free">ρ''</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> below<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> HL_is_L<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fix <span class="main">⋅</span> <span class="main">(</span>H <span class="main">(</span>fix <span class="main">⋅</span> L<span class="main">)</span><span class="main">)</span> <span class="main">=</span> fix <span class="main">⋅</span> L"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fix <span class="main">⋅</span> <span class="main">(</span>H <span class="main">(</span>fix <span class="main">⋅</span> L<span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> fix <span class="main">⋅</span> L"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fix_least_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> H_noop<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">⋅</span> <span class="main">(</span>fix <span class="main">⋅</span> <span class="main">(</span>H <span class="main">(</span>fix <span class="main">⋅</span> L<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">e2</span> <span class="main">⋅</span> <span class="main">(</span>fix <span class="main">⋅</span> L<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monofun_cfun_arg<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fix <span class="main">⋅</span> L <span class="main">⊑</span> fix <span class="main">⋅</span> <span class="main">(</span>H <span class="main">(</span>fix <span class="main">⋅</span> L<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fix_least_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ne *<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> iterative_override_on<span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fix <span class="main">⋅</span> L <span class="main">=</span> fix <span class="main">⋅</span> R"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fix <span class="main">⋅</span> R <span class="main">⊑</span> fix <span class="main">⋅</span> L"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fix_least_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fix <span class="main">⋅</span> L <span class="main">⊑</span> fix <span class="main">⋅</span> R"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_least_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lookup_fix <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_S<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> iterative_override_on'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fix <span class="main">⋅</span> L <span class="main">=</span> fix <span class="main">⋅</span>  R'"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fix <span class="main">⋅</span> R' <span class="main">⊑</span> fix <span class="main">⋅</span> L"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fix_least_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fix <span class="main">⋅</span> L <span class="main">⊑</span> fix <span class="main">⋅</span> R'"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_least_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lookup_fix <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R'_S<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Env-Nominal">
<div class="head">
<h1>Theory Env-Nominal</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Env-Nominal"</span>
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Env.html">Env</a> <span class="quoted">"<a href="Nominal-Utils.html">Nominal-Utils</a>"</span> <span class="quoted">"<a href="Nominal-HOLCF.html">Nominal-HOLCF</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Equivariance lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> edom_perm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>pt <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>pcpo_pt<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>edom <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> edom_perm_rev<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">eqvt</span><span class="main">]</span> <span class="main">=</span> edom_perm<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_edom_perm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>at_base <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>pcpo_pt<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">∈</span> edom <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">-</span> <span class="free">p</span> <span class="main">∙</span> <span class="free">xa</span> <span class="main">∈</span> edom <span class="free">ρ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> edom_perm_rev mem_Collect_eq permute_set_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>pt <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>cont_pt<span class="main">,</span>pcpo<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">m</span> <span class="keyword1">f|`</span> <span class="free">d</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_delete_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>pt <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>cont_pt<span class="main">,</span>pcpo<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> env_delete <span class="free">x</span> <span class="free">m</span> <span class="main">=</span> env_delete <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_delete_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> esing_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>esing <span class="free">x</span><span class="main">)</span> <span class="main">=</span> esing <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> esing_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">perm_simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_cfun_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Permutation and restriction›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_perm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>at_base <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>pcpo_pt<span class="main">,</span>pure<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">p</span> <span class="main">♯*</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> permute_fun_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_pure<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> perm_supp_eq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>perm_supp_eq supp_minus_perm fresh_star_def fresh_def supp_set_elem_finite<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_perm'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>at_base <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>pcpo_pt<span class="main">,</span>pure<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">p</span> <span class="main">♯*</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span>  env_restr_perm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_flip<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>at_base <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>pcpo_pt<span class="main">,</span>pure<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x'</span> <span class="main">↔</span> <span class="free">x</span><span class="main">)</span> <span class="main">∙</span> <span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_flip_at env_restr_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eqvt_lambda flip_at_base_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> minus_flip permute_pure unpermute_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_flip'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>at_base <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>pcpo_pt<span class="main">,</span>pure<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x'</span> <span class="main">↔</span> <span class="free">x</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flip_set_both_not_in<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span>  env_restr_flip<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pure codomains›</span></span>
<span class="comment1">(*
lemma edom_fv_pure:
  fixes f :: "('a::at_base ⇒ 'b::{pcpo,pure})"
  assumes "finite (edom f)"
  shows  "fv f = edom f"
using assms
proof (induction "edom f" arbitrary: f)
  case empty
  hence "f = ⊥" unfolding edom_def by auto
  thus ?case by (auto simp add: fv_def fresh_def supp_def)
next
  case (insert x S)
  have "f = (env_delete x f)(x := f x)" by auto

  from `insert x S = edom f`  and `x ∉ S`
  have "S = edom (env_delete x f)" by auto
  hence "fv (env_delete x f) = edom (env_delete x f)" by (rule insert)
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> edom_fv_pure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>at_base <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>pcpo<span class="main">,</span>pure<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>edom <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"fv <span class="free">f</span> <span class="main">⊆</span> edom <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"edom <span class="free">f</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> edom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def fresh_def supp_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="skolem">f</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">f</span> <span class="main">⊆</span> fv <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">∪</span> fv <span class="skolem">x</span> <span class="main">∪</span> fv <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eqvt_fresh_cong3<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted">fun_upd</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"env_delete <span class="skolem">x</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> z <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> fun_upd_eqvt<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def fresh_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_def pure_fresh<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹insert <span class="skolem">x</span> <span class="skolem">S</span> <span class="main">=</span> edom <span class="skolem">f</span>›</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">S</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> edom <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> insert<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fv_pure<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹insert <span class="skolem">x</span> <span class="skolem">S</span> <span class="main">=</span> edom <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> edom <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"edom <span class="main">(</span>env_delete <span class="skolem">x</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">∪</span> fv <span class="skolem">x</span> <span class="main">∪</span> <span class="main">{}</span> <span class="main">⊆</span> edom <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">intro</span> Un_mono subset_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
lemma domA_fresh_pure:
  fixes Γ :: "('a::at_base × 'b::pure) list"
  shows  "x ∈ domA Γ ⟷ ¬(atom x ♯ Γ)"
  unfolding domA_fv_pure[symmetric]
  by (auto simp add: fv_def fresh_def)
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="HeapSemantics">
<div class="head">
<h1>Theory HeapSemantics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> HeapSemantics
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="EvalHeap.html">EvalHeap</a> <span class="quoted">"<a href="AList-Utils-Nominal.html">AList-Utils-Nominal</a>"</span> <a href="HasESem.html">HasESem</a> <a href="Iterative.html">Iterative</a> <span class="quoted">"<a href="Env-Nominal.html">Env-Nominal</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹A locale for heap semantics, abstract in the expression semantics›</span></span>

<span class="keyword1"><span class="command">context</span></span> has_ESem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">EvalHeapSem_syn</span>  <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>⟦</b></span> _ <span class="keyword1"><span class="hidden">❙</span><b>⟧</b>⇘</span>_<span class="keyword1">⇙</span>"</span>  <span class="main">[</span>0<span class="main">,</span>0<span class="main">]</span> 110<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EvalHeapSem_syn</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">≡</span> evalHeap <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">e</span>⟧<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">ρ</span></span></span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">HSem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">×</span> <span class="tfree">'exp</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'value</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'value</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HSem</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ <span class="main">.</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="bound">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="free"><span class="bound"><span class="entity">Γ</span></span></span></sub><span class="hidden">⇙</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">HSem_syn</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span> _ <span class="keyword1">⦄</span>_"</span>  <span class="main">[</span>0<span class="main">,</span>60<span class="main">]</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">⦄</span></span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">≡</span> HSem <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="free">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span><span class="free">Γ</span><span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HSem_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Induction and other lemmas about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">HSem</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_ind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"adm <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">ρ'</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span><span class="free">Γ</span><span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HSem_def'
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_ind<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> domA <span class="free">h</span> <span class="main">⟹</span> <span class="free">ρ</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">r</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="free">h</span> <span class="main">⟹</span> <span class="main">⟦</span>the <span class="main">(</span>map_of <span class="free">h</span> <span class="bound">x</span><span class="main">)</span>⟧<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="free">r</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">h</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">⊑</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_ind<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> minimal<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ρ'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> override_on_belowI<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookupEvalHeap  below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monofun_cfun_arg<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ'</span> <span class="main">⊑</span> <span class="free">r</span>›</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> h<span class="main"><span class="main">]</span></span> rho<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_bot_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="free">h</span> <span class="main">⟹</span> <span class="main">⟦</span>the <span class="main">(</span>map_of <span class="free">h</span> <span class="bound">x</span><span class="main">)</span>⟧<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="free">r</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">h</span><span class="main">⦄</span><span class="main">⊥</span> <span class="main">⊑</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> HSem_below fun_belowD minimal<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_bot_ind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"adm <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">ρ'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>⟦</b></span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> HSem_ind<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> parallel_HSem_ind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">ρ'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>fst <span class="bound">ρ'</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊥</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span>
    <span class="free">P</span> <span class="main">(</span><span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> ++<span class="hidden">⇘</span><sub>domA <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span></sub><span class="hidden">⇙</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span><span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="bound">y</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">(</span><span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> ++<span class="hidden">⇘</span><sub>domA <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span></sub><span class="hidden">⇙</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span><span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="bound">z</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⦄</span><span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⦄</span><span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HSem_def'
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="free">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span><span class="free">Γ</span><span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HSem_def'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_bot_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">⊥</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span><span class="free">Γ</span><span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">⊥</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> HSem_eq<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_HSem_other<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> domA <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">h</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="free">ρ</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> HSem_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_HSem_heap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> domA <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">h</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⟦</span> the <span class="main">(</span>map_of <span class="free">h</span> <span class="free">y</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">h</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> HSem_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookupEvalHeap<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_edom_subset<span class="main">:</span>  <span class="quoted"><span class="quoted">"edom <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⊆</span> edom <span class="free">ρ</span> <span class="main">∪</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">unfolding</span></span> edomIff
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> env_restr_override_onI<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">S2</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> env_restr <span class="free">S</span> <span class="free">ρ1</span> ++<span class="hidden">⇘</span><sub><span class="free">S2</span></sub><span class="hidden">⇙</span> <span class="free">ρ2</span> <span class="main">=</span> <span class="free">ρ1</span> ++<span class="hidden">⇘</span><sub><span class="free">S2</span></sub><span class="hidden">⇙</span> <span class="free">ρ2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_override_on_eq <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_restr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">h</span><span class="main">⦄</span><span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">h</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_HSem_ind<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> env_restr_override_onI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_restr_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ'</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">h</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">h</span><span class="main">⦄</span><span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> HSem_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_restr_cong_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">h</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ρ'</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">h</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">⊑</span> <span class="main">⦃</span><span class="free">h</span><span class="main">⦄</span><span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> HSem_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> monofun_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_reorder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="main">=</span> map_of <span class="free">Δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HSem_def' evalHeap_reorder<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> assms dom_map_of_conv_domA<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_reorder_head<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e1</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">e2</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="main">⦃</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">e2</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e1</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e1</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">e2</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">e2</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e1</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>      
    <span class="keyword1"><span class="command">unfolding</span></span> HSem_def evalHeap_reorder_head<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domA_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_reorder_head_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">@</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">Γ</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="free">Δ</span><span class="main">)</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">@</span><span class="free">Δ</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">Γ</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="free">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> HSem_def  evalHeap_reorder_head_append<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> env_restr_HSem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span> <span class="free">Γ</span> <span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span> <span class="free">Γ</span> <span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">ρ</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lookup_HSem_other<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> env_restr_HSem_noop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">∩</span> edom <span class="free">ρ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span> <span class="free">Γ</span> <span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> edom <span class="free">ρ</span> <span class="main">=</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_HSem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> env_restr_useless<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">[]</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> HSem_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_subst_exp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ρ'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e'</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parallel_HSem_ind<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms evalHeap_subst_exp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_subst_expr_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> below<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e1</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e2</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="main">⟦</span> <span class="free">e2</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e2</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e1</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">⊑</span> <span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e2</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_below<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_heap below lookup_HSem_other<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_subst_expr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> below1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e1</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e2</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="main">⟦</span> <span class="free">e2</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e2</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> below2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e2</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e1</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="main">⟦</span> <span class="free">e1</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e1</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e1</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e2</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms HSem_subst_expr_below below_antisym<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Re-calculating the semantics of the heap is idempotent›</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> HSem_redo<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span> <span class="main">@</span> <span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>edom <span class="free">ρ</span> <span class="main">∪</span> domA <span class="free">Δ</span><span class="main">)</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">Γ</span> <span class="main">@</span> <span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LHS</span> <span class="main">=</span> <span class="var">?RHS</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LHS</span> <span class="main">⊑</span> <span class="var">?RHS</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_below<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_heap fun_belowD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> env_restr_below_itself<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?RHS</span> <span class="main">⊑</span> <span class="var">?LHS</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> HSem_below<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> edom <span class="free">ρ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>lookup_not_edom<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_heap<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> delta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="free">Δ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="quoted"><span class="quoted">‹<span class="var">?LHS</span> <span class="main">⊑</span> <span class="var">?RHS</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other lookup_HSem_heap monofun_cfun_arg<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Iterative definition of the heap semantics›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iterative_HSem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="free">x</span> <span class="main">:=</span> <span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">interpret</span></span> iterative
    <span class="keyword2"><span class="keyword">where</span></span> e1 <span class="main">=</span>  <span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> ρ'<span class="main">.</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span><span class="free">Γ</span><span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> e2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> ρ'<span class="main">.</span> <span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> S <span class="main">=</span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x <span class="main">=</span> <span class="quoted"><span class="free">x</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> fix <span class="main">⋅</span> L"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HSem_def' override_on_upd ne<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fix <span class="main">⋅</span> R"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iterative_override_on<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="free">x</span> <span class="main">:=</span> <span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HSem_def'<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iterative_HSem'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="free">x</span> <span class="main">:=</span> <span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="free">x</span> <span class="main">:=</span> <span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">interpret</span></span> iterative
    <span class="keyword2"><span class="keyword">where</span></span> e1 <span class="main">=</span>  <span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> ρ'<span class="main">.</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span><span class="free">Γ</span><span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> e2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> ρ'<span class="main">.</span> <span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> S <span class="main">=</span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x <span class="main">=</span> <span class="quoted"><span class="free">x</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="free">x</span> <span class="main">:=</span> <span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fix <span class="main">⋅</span> R"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HSem_def'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fix <span class="main">⋅</span> L"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iterative_override_on<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fix <span class="main">⋅</span> R'"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iterative_override_on'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="free">x</span> <span class="main">:=</span> <span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HSem_def'<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Fresh variables on the heap are irrelevant›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_ignores_fresh_restr'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fv <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">ρ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">⟦</span> the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="bound">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="bound">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_HSem_ind<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> adm base step<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>⟦</b></span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">y</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">z</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> evalHeap_cong'<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_of_fv_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> fv <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> step
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">z</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">y</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">z</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> domA_fv_subset assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_add env_restr_evalHeap_noop<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Freshness›</span></span>

<span class="keyword1"><span class="command">context</span></span> has_ignore_fresh_ESem <span class="keyword2"><span class="keyword">begin</span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> ESem_fresh_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ'</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ'</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms ESem_considers_fv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ESem_fresh_cong_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fv <span class="free">e</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">ρ'</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ'</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ESem_fresh_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  env_restr_eq_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ESem_fresh_cong_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ρ'</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ'</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms ESem_considers_fv monofun_cfun_arg<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ESem_fresh_cong_below_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fv <span class="free">e</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">ρ'</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ'</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ESem_fresh_cong_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  env_restr_below_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ESem_ignores_fresh_restr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> <span class="free">S</span> <span class="main">♯*</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="free">e</span> <span class="main">∩</span> <span class="main">-</span> <span class="free">S</span> <span class="main">=</span> fv <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_def fresh_star_def fv_supp<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> ESem_considers_fv<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ESem_ignores_fresh_restr'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> <span class="main">(</span>edom <span class="free">ρ</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">♯*</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span>  <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span>edom <span class="free">ρ</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ESem_ignores_fresh_restr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span>edom <span class="free">ρ</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lookup_not_edom<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_ignores_fresh_restr''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fv <span class="free">Γ</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_ignores_fresh_restr'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ESem_considers_fv<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_ignores_fresh_restr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> <span class="free">S</span> <span class="main">♯*</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="free">Γ</span> <span class="main">⊆</span> <span class="main">-</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def fresh_star_def fresh_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_ignores_fresh_restr''<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_fresh_cong_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">∪</span> fv <span class="free">Γ</span><span class="main">)</span> <span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">ρ'</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">∪</span> fv <span class="free">Γ</span><span class="main">)</span> <span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ'</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> fv <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">(</span><span class="free">ρ'</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> fv <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HSem_restr_cong_below <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Diff_eq inf_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> fv <span class="free">Γ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ'</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> fv <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> HSem_ignores_fresh_restr''<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_below_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Un_upper1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_fresh_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">∪</span> fv <span class="free">Γ</span><span class="main">)</span> <span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ'</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">∪</span> fv <span class="free">Γ</span><span class="main">)</span> <span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ'</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> HSem_fresh_cong_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq_imp_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> HSem_fresh_cong_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq_imp_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Adding a fresh variable to a heap does not affect its semantics›</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> HSem_add_fresh'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> edom <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">Γ</span> <span class="main">⟹</span> <span class="main">⟦</span> <span class="bound">e</span> ⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="bound">e</span> ⟧<span class="hidden">⇘</span><sub>env_delete <span class="free">x</span> <span class="bound">ρ'</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="main">(</span><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> parallel_HSem_ind<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="free">ρ</span> <span class="main">=</span> <span class="free">ρ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> edom <span class="free">ρ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_delete_noop<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domA_not_fresh<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>⟦</b></span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">y</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">y</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> env_delete_noop <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>  subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> edom_evalHeap_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">z</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evalHeap_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> step<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_delete_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_add_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> edom <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"env_delete <span class="free">x</span> <span class="main">(</span><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> HSem_add_fresh'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">e</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fresh_heap_expr'<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fv <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def fresh_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ESem_fresh_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> env_restr_env_delete_other<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Mutual recursion with fresh variables›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_subset_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Γ</span> <span class="main">♯*</span> <span class="free">Δ</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">@</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> HSem_below<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Γ</span> <span class="main">♯*</span> the <span class="main">(</span>map_of <span class="free">Δ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_map_of<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fresh <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> domA <span class="free">Δ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_def domA_not_fresh image_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> the <span class="main">(</span>map_of <span class="free">Δ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">⦃</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="main">⦃</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_heap ESem_ignores_fresh_restr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other lookup_env_restr_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following lemma we show that the semantics of fresh variables can be be calculated
together with the presently bound variables, or separately.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Γ</span> <span class="main">♯*</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">Γ</span><span class="main">@</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> map_of_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> map_of <span class="main">(</span><span class="free">Γ</span> <span class="main">@</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> map_of <span class="main">(</span><span class="free">Γ</span> <span class="main">@</span> <span class="free">Δ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="free">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_distinct fresh IntI equals0D<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> map_of <span class="main">(</span><span class="free">Γ</span> <span class="main">@</span> <span class="free">Δ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_dom_app_simps dom_map_of_conv_domA<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> map_of <span class="main">(</span><span class="free">Γ</span> <span class="main">@</span> <span class="free">Δ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_dom_app_simps dom_map_of_conv_domA<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">⊑</span> <span class="main">⦃</span><span class="free">Γ</span><span class="main">@</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> HSem_below<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HSem_ignores_fresh_restr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fresh<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">@</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HSem_subset_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fresh<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">@</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span> <span class="main">@</span> <span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HSem_reorder<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_of_eq<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span> <span class="main">@</span> <span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_heap lookup_env_restr_eq<span class="main">)</span>

   <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="free">Δ</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fresh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_star_def domA_not_fresh<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> foo<span class="main">:</span> <span class="quoted"><span class="quoted">"edom <span class="free">ρ</span> <span class="main">∪</span> domA <span class="free">Δ</span> <span class="main">∪</span> domA <span class="free">Γ</span> <span class="main">-</span> <span class="main">(</span>edom <span class="free">ρ</span> <span class="main">∪</span> domA <span class="free">Δ</span> <span class="main">∪</span> domA <span class="free">Γ</span><span class="main">)</span> <span class="main">∩</span> <span class="main">-</span> domA <span class="free">Γ</span> <span class="main">=</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> foo2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>edom <span class="free">ρ</span> <span class="main">∪</span> domA <span class="free">Δ</span> <span class="main">-</span> <span class="main">(</span>edom <span class="free">ρ</span> <span class="main">∪</span> domA <span class="free">Δ</span><span class="main">)</span> <span class="main">∩</span> <span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span> <span class="main">⊆</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="free">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Γ</span> <span class="main">♯*</span> the <span class="main">(</span>map_of <span class="free">Δ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span>  fresh_star_map_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fresh<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> the <span class="main">(</span>map_of <span class="free">Δ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> the <span class="main">(</span>map_of <span class="free">Δ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ESem_ignores_fresh_restr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_restr_HSem<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> the <span class="main">(</span>map_of <span class="free">Δ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="main">…</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> the <span class="main">(</span>map_of <span class="free">Δ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ESem_ignores_fresh_restr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> the <span class="main">(</span>map_of <span class="free">Δ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> the <span class="main">(</span>map_of <span class="free">Δ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Γ</span><span class="main">@</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">⊑</span> <span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> HSem_below<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other lookup_HSem_heap *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Parallel induction›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_HSem_ind_different_ESem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">ρ'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>fst <span class="bound">ρ'</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊥</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="free">h</span></sub><span class="hidden">⇙</span> evalHeap <span class="free">h</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">ESem1</span> <span class="bound">e</span> <span class="main">⋅</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ρ2</span> ++<span class="hidden">⇘</span><sub>domA <span class="free">h2</span></sub><span class="hidden">⇙</span> evalHeap <span class="free">h2</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">ESem2</span> <span class="bound">e</span> <span class="main">⋅</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>has_ESem.HSem <span class="free">ESem1</span> <span class="free">h</span><span class="main">⋅</span><span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>has_ESem.HSem <span class="free">ESem2</span> <span class="free">h2</span><span class="main">⋅</span><span class="free">ρ2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> HSem1<span class="main">:</span> has_ESem <span class="quoted"><span class="free">ESem1</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> HSem2<span class="main">:</span> has_ESem <span class="quoted"><span class="free">ESem2</span></span><span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> HSem1.HSem_def' HSem2.HSem_def'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_fix_ind<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Congruence rule›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">heap2</span> <span class="main">⟹</span> <span class="free">ESem1</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">ESem2</span> <span class="bound">e</span><span class="main">)</span><span class="main">;</span> <span class="free">heap1</span> <span class="main">=</span> <span class="free">heap2</span>  <span class="main">⟧</span>
      <span class="main">⟹</span> has_ESem.HSem <span class="free">ESem1</span> <span class="free">heap1</span> <span class="main">=</span> has_ESem.HSem <span class="free">ESem2</span> <span class="free">heap2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_ESem.HSem_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span>evalHeap_cong<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Equivariance of the heap semantics›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> has_ESem.HSem <span class="free">ESem</span> <span class="free">Γ</span> <span class="main">=</span> has_ESem.HSem <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">ESem</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> has_ESem.HSem_def
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> permute_Lam<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eqvt_lambda<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cfun_app_eqvt permute_Lam<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Vars">
<div class="head">
<h1>Theory Vars</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Vars
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Nominal2/Nominal2.html">Nominal2.Nominal2</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The type of variables is abstract and provided by the Nominal package. All we know is that it is countable.
›</span></span>

<span class="keyword1"><span class="command">atom_decl</span></span> var

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Terms">
<div class="head">
<h1>Theory Terms</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Terms
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Nominal-Utils.html">Nominal-Utils</a>"</span> <a href="Vars.html">Vars</a>  <span class="quoted">"<a href="AList-Utils-Nominal.html">AList-Utils-Nominal</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Expressions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This is the main data type of the development; our minimal lambda calculus with recursive let-bindings.
It is created using the nominal\_datatype command, which creates alpha-equivalence classes.

The package does not support nested recursion, so the bindings of the let cannot simply be of type
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(var, exp) list›</span></span></span></span>. Instead, the definition of lists have to be inlined here, as the custom type
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assn›</span></span></span></span>. Later we create conversion functions between these two types, define a properly typed <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>let›</span></span></span></span> 
and redo the various lemmas in terms of that, so that afterwards, the type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assn›</span></span></span></span> is no longer
referenced.
›</span></span>

<span class="keyword1"><span class="command">nominal_datatype</span></span> exp <span class="main">=</span>
  Var <span class="quoted">var</span>
<span class="main">|</span> App <span class="quoted">exp</span> <span class="quoted">var</span>
<span class="main">|</span> LetA as<span class="main">::</span><span class="quoted">assn</span> body<span class="main">::</span><span class="quoted">exp</span> <span class="keyword2"><span class="keyword">binds</span></span> <span class="quoted"><span class="quoted">"bn <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">in</span></span> body as
<span class="main">|</span> Lam x<span class="main">::</span><span class="quoted">var</span> body<span class="main">::</span><span class="quoted">exp</span> <span class="keyword2"><span class="keyword">binds</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword">in</span></span> body  <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1">Lam</span></span> <span class="keyword1"><span class="keyword1">[</span></span>_<span class="keyword1"><span class="keyword1">].</span></span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 100<span class="main">)</span>
<span class="main">|</span> Bool <span class="quoted">bool</span>
<span class="main">|</span> IfThenElse <span class="quoted">exp</span> <span class="quoted">exp</span> <span class="quoted">exp</span>  <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3">(</span></span><span class="keyword3"><span class="keyword3">(</span></span>_<span class="keyword3"><span class="keyword3">)</span></span><span class="keyword3"><span class="keyword3">/ </span></span><span class="keyword1"><span class="keyword1">?</span></span> <span class="keyword3"><span class="keyword3">(</span></span>_<span class="keyword3"><span class="keyword3">)</span></span><span class="keyword3"><span class="keyword3">/ </span></span><span class="keyword1"><span class="keyword1">:</span></span> <span class="keyword3"><span class="keyword3">(</span></span>_<span class="keyword3"><span class="keyword3">)</span></span><span class="keyword3"><span class="keyword3">)</span></span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> assn <span class="main">=</span>
  ANil <span class="main">|</span> ACons <span class="quoted">var</span> <span class="quoted">exp</span> <span class="quoted">assn</span>
<span class="keyword2"><span class="keyword">binder</span></span>
  <span class="entity"><span class="entity">bn</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assn <span class="main">⇒</span> atom list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bn</span> ANil <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bn</span> <span class="main">(</span>ACons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>atom <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">bn</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> Terms.Var <span class="main">(</span><span class="quoted">"_"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> Terms.App <span class="main">(</span><span class="quoted">"_ _"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> Terms.Lam <span class="main">(</span><span class="quoted">"<span class="keyword1">λ</span>_<span class="keyword1">.</span> _"</span>  <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> heap <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var <span class="main">×</span> exp<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exp_assn_size_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="main">(</span>size <span class="main">::</span> exp <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">=</span> size"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exp_assn.size_eqvt<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fun_eqvtI permute_pure<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Rewriting in terms of heaps›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We now work towards using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> heap<span class="antiquote"><span class="antiquote">}</span></span></span></span> instead of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> assn<span class="antiquote"><span class="antiquote">}</span></span></span></span>. All this
could be skipped if Nominal supported nested recursion.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Conversion from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">assn</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">heap</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">nominal_function</span></span> <span class="entity">asToHeap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assn <span class="main">⇒</span> heap"</span></span> 
 <span class="keyword2"><span class="keyword">where</span></span> ANilToHeap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">asToHeap</span> ANil <span class="main">=</span> <span class="main">[]</span>"</span></span>
 <span class="main">|</span> AConsToHeap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">asToHeap</span> <span class="main">(</span>ACons <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">asToHeap</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eqvt_def asToHeap_graph_aux_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp_assn.exhaust<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">nominal_termination</span></span><span class="main">(</span>eqvt<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> asToHeap_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"eqvt asToHeap"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eqvt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_fun_def asToHeap.eqvt<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The other direction.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">heapToAssn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> assn"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">heapToAssn</span> <span class="main">[]</span> <span class="main">=</span> ANil"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">heapToAssn</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">=</span> ACons <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free">heapToAssn</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> heapToAssn.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> heapToAssn_eqvt<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> heapToAssn <span class="free">Γ</span> <span class="main">=</span>  heapToAssn <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> heapToAssn.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> heapToAssn.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bn_heapToAssn<span class="main">:</span> <span class="quoted"><span class="quoted">"bn <span class="main">(</span>heapToAssn <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> atom <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> heapToAssn.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> heapToAssn.simps exp_assn.bn_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_bn_to_atom_domA<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>bn <span class="free">as</span><span class="main">)</span> <span class="main">=</span> atom <span class="main">`</span> domA <span class="main">(</span>asToHeap <span class="free">as</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> asToHeap.induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.bn_defs<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
They are inverse to each other.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> heapToAssn_asToHeap<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"heapToAssn <span class="main">(</span>asToHeap <span class="free">as</span><span class="main">)</span> <span class="main">=</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp_assn.inducts<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main">.</span></span></span> True"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> heapToAssn.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> asToHeap_heapToAssn<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"asToHeap <span class="main">(</span>heapToAssn <span class="free">as</span><span class="main">)</span> <span class="main">=</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> heapToAssn.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> heapToAssn.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> heapToAssn_inject<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"heapToAssn <span class="free">x</span> <span class="main">=</span> heapToAssn <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> asToHeap_heapToAssn<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
They are transparent to various notions from the Nominal package.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supp_heapToAssn<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>heapToAssn <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> heapToAssn.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> heapToAssn.simps  exp_assn.supp supp_Nil supp_Cons supp_Pair sup_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supp_asToHeap<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>asToHeap <span class="free">as</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">as</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> asToHeap.induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  exp_assn.supp supp_Nil supp_Cons supp_Pair sup_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_asToHeap<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>asToHeap <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_asToHeap<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_heapToAssn<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>heapToAssn <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_heapToAssn<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>heapToAssn <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> size_list <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">.</span> size <span class="bound">e</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> heapToAssn.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> heapToAssn.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Lam_eq_same_var<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e'</span> <span class="main">⟷</span>  <span class="free">e</span> <span class="main">=</span> <span class="free">e'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> fresh_PairD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> obtain_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we define the Let constructor in the form that we actually want.›</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> HOL.Let
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Let</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Let</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> LetA <span class="main">(</span>heapToAssn <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> Let <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‹\\textrm{\\textsf{let}}›</span> _ <span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‹\\textrm{\\textsf{in}}›</span> _"</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">LetBe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var<span class="main">⇒</span>exp<span class="main">⇒</span>exp<span class="main">⇒</span>exp"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">let</span> _ <span class="keyword1">be</span> _ <span class="keyword1">in</span> _ "</span> <span class="main">[</span>100<span class="main">,</span>100<span class="main">,</span>100<span class="main">]</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">let</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">be</span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1"><span class="free">in</span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">≡</span> Let <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We rewrite all (relevant) lemmas about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">LetA</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in terms of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Let</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_Let<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> size_list <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> size <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">+</span> size <span class="free">e</span> <span class="main">+</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Let_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Let_distinct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Var <span class="free">v</span> <span class="main">≠</span> Let <span class="free">Γ</span> <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"Let <span class="free">Γ</span> <span class="free">e</span> <span class="main">≠</span> Var <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"App <span class="free">e</span> <span class="free">v</span> <span class="main">≠</span> Let <span class="free">Γ</span> <span class="free">e'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">Lam</span> <span class="main">[</span><span class="free">v</span><span class="main">].</span> <span class="free">e'</span> <span class="main">≠</span> Let <span class="free">Γ</span> <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"Let <span class="free">Γ</span> <span class="free">e</span> <span class="main">≠</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">v</span><span class="main">].</span> <span class="free">e'</span>"</span></span>
  <span class="quoted"><span class="quoted">"Let <span class="free">Γ</span> <span class="free">e'</span> <span class="main">≠</span> App <span class="free">e</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"Bool <span class="free">b</span> <span class="main">≠</span> Let <span class="free">Γ</span> <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"Let <span class="free">Γ</span> <span class="free">e</span> <span class="main">≠</span> Bool <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span> <span class="main">≠</span> Let <span class="free">Γ</span> <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"Let <span class="free">Γ</span> <span class="free">e</span> <span class="main">≠</span> <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> Let_perm_simps<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> Let <span class="free">Γ</span> <span class="free">e</span> <span class="main">=</span> Let <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Let_supp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"supp <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>supp <span class="free">e</span> <span class="main">∪</span> supp <span class="free">Γ</span><span class="main">)</span> <span class="main">-</span> atom <span class="main">`</span> <span class="main">(</span>domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Let_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.supp supp_heapToAssn bn_heapToAssn domA_def image_image<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Let_fresh<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> Let <span class="free">Γ</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">♯</span> <span class="free">e</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">Γ</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">∈</span> atom <span class="main">`</span> domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_supp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Abs_eq_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">p</span> <span class="main">∙</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">y</span> <span class="main">=</span> supp <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">y'</span> <span class="main">=</span> supp <span class="free">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="keyword1">]lst.</span> <span class="free">x</span> <span class="main">=</span> <span class="main">[</span><span class="free">a'</span><span class="keyword1">]lst.</span> <span class="free">x'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="keyword1">]lst.</span> <span class="free">y</span> <span class="main">=</span> <span class="main">[</span><span class="free">a'</span><span class="keyword1">]lst.</span> <span class="free">y'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_eq_iff alpha_lst assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Let_eq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span> <span class="main">=</span> Let <span class="free">Γ'</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> atom <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span> <span class="keyword1">]lst.</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> atom <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ'</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="free">e'</span><span class="main">,</span><span class="free">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Let_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_heapToAssn<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Abs_eq_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Pair supp_heapToAssn<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> exp_strong_exhaust<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> fs"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> Var <span class="bound">var</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">exp</span> <span class="bound">var</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> App <span class="bound">exp</span> <span class="bound">var</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">exp</span><span class="main">.</span> atom <span class="main">`</span> domA <span class="bound">Γ</span> <span class="main">♯*</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> Let <span class="bound">Γ</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">exp</span><span class="main">.</span> <span class="main">{</span>atom <span class="bound">var</span><span class="main">}</span> <span class="main">♯*</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">var</span><span class="main">].</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">=</span> Bool <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">scrut</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="bound">scrut</span> <span class="main">?</span> <span class="bound">e1</span> <span class="main">:</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>  exp_assn.strong_exhaust<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> set_bn_to_atom_domA Let_def heapToAssn_asToHeap<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
And finally the induction rules with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Let</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exp_heap_induct<span class="main">[</span><span class="operator">case_names</span> Var App Let Lam Bool IfThenElse Nil Cons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">var</span><span class="main">.</span> <span class="free">P1</span> <span class="main">(</span>Var <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">exp</span> <span class="bound">var</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>App <span class="bound">exp</span> <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">exp</span><span class="main">.</span> <span class="free">P2</span> <span class="bound">Γ</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Let <span class="bound">Γ</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">exp</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">var</span><span class="main">].</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P1</span> <span class="main">(</span>Bool <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">scrut</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">scrut</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="bound">e1</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="bound">e2</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span><span class="bound">scrut</span> <span class="main">?</span> <span class="bound">e1</span> <span class="main">:</span> <span class="bound">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">exp</span> <span class="bound">Γ</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P2</span> <span class="bound">Γ</span> <span class="main">⟹</span> <span class="free">P2</span> <span class="main">(</span><span class="main">(</span><span class="bound">var</span><span class="main">,</span> <span class="bound">exp</span><span class="main">)</span><span class="main">#</span><span class="bound">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2</span> <span class="main">(</span>asToHeap <span class="main">(</span>heapToAssn <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp_assn.inducts<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">P1</span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">λ</span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound">assn</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">.</span></span></span></span> <span class="free"><span class="free"><span class="free"><span class="free">P2</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>asToHeap <span class="bound"><span class="bound"><span class="bound"><span class="bound">assn</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span>"</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Let_def heapToAssn_asToHeap <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> asToHeap.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> asToHeap.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2</span> <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> asToHeap_heapToAssn<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exp_heap_strong_induct<span class="main">[</span><span class="operator">case_names</span> Var App Let Lam Bool IfThenElse Nil Cons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">c</span> <span class="main">(</span>Var <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">exp</span> <span class="bound">var</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="bound">c</span> <span class="main">(</span>App <span class="bound">exp</span> <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">exp</span> <span class="bound">c</span><span class="main">.</span> atom <span class="main">`</span> domA <span class="bound">Γ</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P2</span> <span class="bound">c</span> <span class="bound">Γ</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="bound">c</span> <span class="main">(</span>Let <span class="bound">Γ</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">exp</span> <span class="bound">c</span><span class="main">.</span> <span class="main">{</span>atom <span class="bound">var</span><span class="main">}</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="bound">c</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">var</span><span class="main">].</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">c</span> <span class="main">(</span>Bool <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">scrut</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">c</span> <span class="bound">scrut</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">c</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">c</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="bound">c</span> <span class="main">(</span><span class="bound">scrut</span> <span class="main">?</span> <span class="bound">e1</span> <span class="main">:</span> <span class="bound">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P2</span> <span class="bound">c</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">exp</span> <span class="bound">Γ</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P1</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P2</span> <span class="bound">c</span> <span class="bound">Γ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P2</span> <span class="bound">c</span> <span class="main">(</span><span class="main">(</span><span class="bound">var</span><span class="main">,</span><span class="bound">exp</span><span class="main">)</span><span class="main">#</span><span class="bound">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> fs"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="free">c</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2</span> <span class="free">c</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="free">c</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2</span> <span class="free">c</span> <span class="main">(</span>asToHeap <span class="main">(</span>heapToAssn <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp_assn.strong_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">P1</span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">λ</span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound">c</span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound">assn</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">.</span></span></span></span> <span class="free"><span class="free"><span class="free"><span class="free">P2</span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound">c</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>asToHeap <span class="bound"><span class="bound"><span class="bound"><span class="bound">assn</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span>"</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> set_bn_to_atom_domA Let_def heapToAssn_asToHeap <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> asToHeap.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> asToHeap.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="free">c</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2</span> <span class="free">c</span> <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> asToHeap_heapToAssn<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Nice induction rules›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
These rules can be used instead of the original induction rules, which require a separate
goal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">assn</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exp_induct<span class="main">[</span><span class="operator">case_names</span> Var App Let Lam Bool IfThenElse<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Var <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">exp</span> <span class="bound">var</span><span class="main">.</span> <span class="free">P</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>App <span class="bound">exp</span> <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">exp</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="bound">Γ</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="main">(</span>the <span class="main">(</span>map_of <span class="bound">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Let <span class="bound">Γ</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">exp</span><span class="main">.</span>  <span class="free">P</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">var</span><span class="main">].</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Bool <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">scrut</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">.</span> <span class="free">P</span> <span class="bound">scrut</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">e1</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">e2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">scrut</span> <span class="main">?</span> <span class="bound">e1</span> <span class="main">:</span> <span class="bound">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">exp</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exp_heap_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">λ</span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound">Γ</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">.</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">∀</span></span></span></span><span class="bound"><span class="bound"><span class="bound"><span class="bound">x</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">∈</span></span></span></span> domA <span class="bound"><span class="bound"><span class="bound"><span class="bound">Γ</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">.</span></span></span></span> <span class="free"><span class="free"><span class="free"><span class="free">P</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>the <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>map_of <span class="bound"><span class="bound"><span class="bound"><span class="bound">Γ</span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound">x</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span>"</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span>  exp_strong_induct_set<span class="main">[</span><span class="operator">case_names</span> Var App Let Lam Bool IfThenElse<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Var <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">exp</span> <span class="bound">var</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>App <span class="bound">exp</span> <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">exp</span> <span class="bound">c</span><span class="main">.</span>
    atom <span class="main">`</span> domA <span class="bound">Γ</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span> <span class="bound">x</span> <span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">Γ</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="bound">c</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Let <span class="bound">Γ</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">exp</span> <span class="bound">c</span><span class="main">.</span> <span class="main">{</span>atom <span class="bound">var</span><span class="main">}</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">var</span><span class="main">].</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Bool <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">scrut</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">scrut</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="bound">scrut</span> <span class="main">?</span> <span class="bound">e1</span> <span class="main">:</span> <span class="bound">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>fs<span class="main">)</span> <span class="free">exp</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exp_heap_strong_induct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">c</span></span> <span class="bound"><span class="bound">Γ</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∀</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">e</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> set <span class="bound"><span class="bound">Γ</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">c</span></span> <span class="bound"><span class="bound">e</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> split_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span>  exp_strong_induct<span class="main">[</span><span class="operator">case_names</span> Var App Let Lam Bool IfThenElse<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Var <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">exp</span> <span class="bound">var</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>App <span class="bound">exp</span> <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">exp</span> <span class="bound">c</span><span class="main">.</span>
    atom <span class="main">`</span> domA <span class="bound">Γ</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="bound">Γ</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>the <span class="main">(</span>map_of <span class="bound">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Let <span class="bound">Γ</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">exp</span> <span class="bound">c</span><span class="main">.</span> <span class="main">{</span>atom <span class="bound">var</span><span class="main">}</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">var</span><span class="main">].</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Bool <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">scrut</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">scrut</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="bound">scrut</span> <span class="main">?</span> <span class="bound">e1</span> <span class="main">:</span> <span class="bound">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>fs<span class="main">)</span> <span class="free">exp</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exp_heap_strong_induct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">c</span></span> <span class="bound"><span class="bound">Γ</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">∈</span></span> domA <span class="bound"><span class="bound">Γ</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">c</span></span> <span class="main"><span class="main">(</span></span>the <span class="main"><span class="main">(</span></span>map_of <span class="bound"><span class="bound">Γ</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Testing alpha equivalence›</span></span>
              
<span class="keyword1"><span class="command">lemma</span></span> alpha_test<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="main">(</span>Var <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff fresh_at_base pure_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alpha_test2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="free">x</span> <span class="keyword1">be</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">let</span> <span class="free">y</span> <span class="keyword1">be</span> <span class="main">(</span>Var <span class="free">y</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>Var <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Cons fresh_Nil Abs1_eq_iff fresh_Pair <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base pure_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alpha_test3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
    Let <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> Var <span class="free">y</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> Var <span class="free">x</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span>
    <span class="main">=</span>
    Let <span class="main">[</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> Var <span class="free">x</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> Var <span class="free">y</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Var <span class="free">y</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Let <span class="var">?la</span> <span class="var">?lb</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bn_heapToAssn Abs1_eq_iff fresh_Pair fresh_at_base
                Abs_swap2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?lb</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> Var <span class="free">y</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> Var <span class="free">x</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>atom <span class="free">x</span><span class="main">,</span> atom <span class="free">y</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Free variables›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_supp_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">e</span> <span class="main">=</span> atom <span class="main">`</span> <span class="main">(</span>fv <span class="main">(</span><span class="free">e</span><span class="main">::</span>exp<span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv_supp_as<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">as</span> <span class="main">=</span> atom <span class="main">`</span> <span class="main">(</span>fv <span class="main">(</span><span class="free">as</span><span class="main">::</span>assn<span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>exp_assn.inducts<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def exp_assn.supp supp_at_base pure_supp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_supp_heap<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">Γ</span><span class="main">::</span>heap<span class="main">)</span> <span class="main">=</span> atom <span class="main">`</span> <span class="main">(</span>fv <span class="free">Γ</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fv_def fv_supp_as supp_heapToAssn<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_Lam<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">e</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.supp<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fv_Var<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.supp supp_at_base pure_supp<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fv_App<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>App <span class="free">e</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.supp supp_at_base<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fv_Let<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fv <span class="free">Γ</span> <span class="main">∪</span> fv <span class="free">e</span><span class="main">)</span> <span class="main">-</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_supp exp_assn.supp supp_at_base set_bn_to_atom_domA<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fv_Bool<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>Bool <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.supp pure_supp<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fv_IfThenElse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e1</span> <span class="main">:</span> <span class="free">e2</span><span class="main">)</span>  <span class="main">=</span> fv <span class="free">scrut</span> <span class="main">∪</span> fv <span class="free">e1</span> <span class="main">∪</span> fv <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.supp<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> fv_delete_heap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span>fv <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> Var <span class="free">x</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fv_delete_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms map_of_SomeD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fv <span class="free">e</span> <span class="main">⊆</span> fv <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms domA_from_set map_of_fv_subset option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> fv <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas helping with nominal definitions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_lam_case<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x'</span><span class="main">].</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">π</span> <span class="main">.</span> supp <span class="main">(</span><span class="main">-</span><span class="bound">π</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span> <span class="main">⟹</span>
                 supp <span class="bound">π</span> <span class="main">♯*</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟹</span>
        <span class="free">F</span> <span class="main">(</span><span class="bound">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">π</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">F</span> <span class="free">e</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">e</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">F</span> <span class="free">e'</span> <span class="free">x'</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x'</span><span class="main">].</span> <span class="free">e'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span>atom <span class="free">x</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">[</span>atom <span class="free">x'</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="free">e'</span><span class="main">,</span> <span class="free">x'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>atom <span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span>  Abs_eq_iff<span class="main">(</span>3<span class="main">)</span> alpha_lst.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">♯*</span> <span class="skolem">p</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def supp_finite_set_at_base supp_Pair fv_supp_exp fv_supp_heap supp_minus_perm<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">♯*</span> <span class="skolem">p</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">♯*</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def supp_Pair fv_supp_exp<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">e</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span>  <span class="free">F</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> * **<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">F</span> <span class="free">e'</span> <span class="free">x'</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x'</span><span class="main">].</span> <span class="free">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Nice idea, but doesn't work well with extra arguments to the function

lemma eqvt_lam_case_eqvt:
  assumes "Lam [x]. e = Lam [x']. e'"
  assumes F_eqvt: "⋀ π e'. π ∙ F e x e' = F (π ∙ e) (π ∙ x) (π ∙ e')"
  assumes F_supp: "atom x ♯ F e x (Lam [x]. e)"
  shows "F e x (Lam [x]. e) = F e' x' (Lam [x']. e')"
using assms(1)
proof(rule eqvt_lam_case)
  have "eqvt F" unfolding eqvt_def by (rule, perm_simp, rule) so rry
  hence "supp (F e x (Lam [x]. e)) ⊆ supp e ∪ supp x ∪ supp (Lam [x]. e)" by (rule supp_fun_app_eqvt3)    
  with F_supp[unfolded fresh_def]
  have *: "supp (F e x (Lam [x]. e)) ⊆ supp (Lam [x]. e)" by (auto simp add: exp_assn.supp supp_at_base)

  fix π :: perm
  assume "supp π ♯* Lam [x]. e" with *
  have "supp π ♯* F e x (Lam [x]. e)" by (auto simp add: fresh_star_def fresh_def)
  hence "F e x (Lam [x]. e) = π ∙ (F e x (Lam [x]. e))" by (metis perm_supp_eq)
  also have "… =  F (π ∙ e) (π ∙ x) (π ∙ (Lam [x]. e))" by (simp add: F_eqvt)
  also have "π ∙ (Lam [x]. e) = (Lam [x]. e)" using `supp π ♯* Lam [x]. e` by (metis perm_supp_eq)
  finally show "F (π ∙ e) (π ∙ x) (Lam [x]. e) = F e x (Lam [x]. e)"..
qed
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> eqvt_let_case<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">as</span> <span class="free">body</span> <span class="main">=</span> Let <span class="free">as'</span> <span class="free">body'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">π</span> <span class="main">.</span>
    supp <span class="main">(</span><span class="main">-</span><span class="bound">π</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span>fv <span class="main">(</span>Let <span class="free">as</span> <span class="free">body</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span> <span class="main">⟹</span>
    supp <span class="bound">π</span> <span class="main">♯*</span> Let <span class="free">as</span> <span class="free">body</span> <span class="main">⟹</span>
    <span class="free">F</span> <span class="main">(</span><span class="bound">π</span> <span class="main">∙</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="bound">π</span> <span class="main">∙</span> <span class="free">body</span><span class="main">)</span> <span class="main">(</span>Let <span class="free">as</span> <span class="free">body</span><span class="main">)</span> <span class="main">=</span> <span class="free">F</span> <span class="free">as</span> <span class="free">body</span> <span class="main">(</span>Let <span class="free">as</span> <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">as</span> <span class="free">body</span> <span class="main">(</span>Let <span class="free">as</span> <span class="free">body</span><span class="main">)</span> <span class="main">=</span> <span class="free">F</span> <span class="free">as'</span> <span class="free">body'</span> <span class="main">(</span>Let <span class="free">as'</span> <span class="free">body'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> atom <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="free">body</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> atom <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="free">as'</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="free">body'</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>supp <span class="main">(</span><span class="free">body</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">-</span> atom <span class="main">`</span> domA <span class="free">as</span><span class="main">)</span> <span class="main">♯*</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">body</span> <span class="main">=</span> <span class="free">body'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∙</span> <span class="free">as</span> <span class="main">=</span> <span class="free">as'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span>  Abs_eq_iff<span class="main">(</span>3<span class="main">)</span> alpha_lst.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domA_def image_image<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">♯*</span> <span class="skolem">p</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span>fv <span class="main">(</span>Terms.Let <span class="free">as</span> <span class="free">body</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def supp_finite_set_at_base supp_Pair fv_supp_exp fv_supp_heap supp_minus_perm<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">♯*</span> <span class="skolem">p</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">♯*</span> Terms.Let <span class="free">as</span> <span class="free">body</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_def supp_Pair fv_supp_exp fv_supp_heap <span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">as</span> <span class="free">body</span> <span class="main">(</span>Let <span class="free">as</span> <span class="free">body</span><span class="main">)</span> <span class="main">=</span>  <span class="free">F</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="free">body</span><span class="main">)</span> <span class="main">(</span>Let <span class="free">as</span> <span class="free">body</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> * **<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">F</span> <span class="free">as'</span> <span class="free">body'</span> <span class="main">(</span>Let <span class="free">as'</span> <span class="free">body'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹A smart constructor for lets›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Certian program transformations might change the bound variables, possibly making it an empty list.
This smart constructor avoids the empty let in the resulting expression. Semantically, it should
not make a difference. 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SmartLet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">=&gt;</span> exp <span class="main">=&gt;</span> exp"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SmartLet</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">else</span> Let <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SmartLet_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="main">(</span>SmartLet <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> SmartLet <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SmartLet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">lemma</span></span> SmartLet_supp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"supp <span class="main">(</span>SmartLet <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>supp <span class="free">e</span> <span class="main">∪</span> supp <span class="free">Γ</span><span class="main">)</span> <span class="main">-</span> atom <span class="main">`</span> <span class="main">(</span>domA <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SmartLet_def <span class="keyword1"><span class="command">using</span></span> Let_supp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Nil<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_SmartLet<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>SmartLet <span class="free">Γ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fv <span class="free">Γ</span> <span class="main">∪</span> fv <span class="free">e</span><span class="main">)</span> <span class="main">-</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SmartLet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹A predicate for value expressions›</span></span>

<span class="keyword1"><span class="command">nominal_function</span></span> <span class="entity">isLam</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isLam</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">isLam</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">isLam</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">isLam</span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">isLam</span> <span class="main">(</span>Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">isLam</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">scrut</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> isLam_graph_aux_def eqvt_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> exp_strong_exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">nominal_termination</span></span> <span class="main">(</span>eqvt<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> isLam_Lam<span class="main">:</span> <span class="quoted"><span class="quoted">"isLam <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> isLam_obtain_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"isLam <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="free">e'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>fs<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>exp_strong_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">nominal_function</span></span> <span class="entity">isVal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isVal</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">isVal</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">isVal</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">isVal</span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">isVal</span> <span class="main">(</span>Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">isVal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">scrut</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> isVal_graph_aux_def eqvt_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> exp_strong_exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">nominal_termination</span></span> <span class="main">(</span>eqvt<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> isVal_Lam<span class="main">:</span> <span class="quoted"><span class="quoted">"isVal <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> isVal_Bool<span class="main">:</span> <span class="quoted"><span class="quoted">"isVal <span class="main">(</span>Bool <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The notion of thunks›</span></span>
<span class="comment1">(*
fun thunks :: "heap ⇒ var set" where
  "thunks [] = {}"
  | "thunks ((x,e)#Γ) = (if isLam e then {} else {x}) ∪ thunks Γ"
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">thunks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">thunks</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span> <span class="main">.</span> <span class="keyword1">case</span> map_of <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span> <span class="keyword1">of</span> Some <span class="bound">e</span> <span class="main">⇒</span> <span class="main">¬</span> isVal <span class="bound">e</span> <span class="main">|</span> None <span class="main">⇒</span> False<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> thunks_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"thunks <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> thunks_domA<span class="main">:</span> <span class="quoted"><span class="quoted">"thunks <span class="free">Γ</span> <span class="main">⊆</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> thunks_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"thunks <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> isVal <span class="free">e</span> <span class="keyword1">then</span> thunks <span class="free">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="keyword1">else</span> insert <span class="free">x</span> <span class="main">(</span>thunks <span class="free">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_def <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> thunks_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"thunks <span class="main">(</span><span class="free">Δ</span><span class="main">@</span><span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> thunks <span class="free">Δ</span> <span class="main">∪</span> <span class="main">(</span>thunks <span class="free">Γ</span> <span class="main">-</span> domA <span class="free">Δ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_def <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> thunks_delete<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"thunks <span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> thunks <span class="free">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_def <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> thunksI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span> <span class="main">⟹</span> <span class="main">¬</span> isVal <span class="free">e</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> thunks <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_def <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> thunksE<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> thunks <span class="free">Γ</span> <span class="main">⟹</span> map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span> <span class="main">⟹</span> <span class="main">¬</span> isVal <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_def <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> thunks_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="main">=</span> map_of <span class="free">Δ</span> <span class="main">⟹</span> thunks <span class="free">Γ</span> <span class="main">=</span> thunks <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> thunks_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> thunks <span class="free">Γ</span> <span class="main">=</span> thunks <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> thunks_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Non-recursive Let bindings›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonrec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nonrec</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="bound">e</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">]</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> fv <span class="bound">e</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> nonrecE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nonrec <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="free">e</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fv <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> nonrec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> nonrec_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nonrec <span class="free">Γ</span> <span class="main">⟹</span> nonrec <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> nonrecE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonrec_def fv_def fresh_def <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fresh_at_base_permute_iff fresh_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> exp_induct_rec<span class="main">[</span><span class="operator">case_names</span> Var App Let Let_nonrec Lam Bool IfThenElse<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Var <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">exp</span> <span class="bound">var</span><span class="main">.</span> <span class="free">P</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>App <span class="bound">exp</span> <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">exp</span><span class="main">.</span> <span class="main">¬</span> nonrec <span class="bound">Γ</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="bound">Γ</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="main">(</span>the <span class="main">(</span>map_of <span class="bound">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Let <span class="bound">Γ</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">e</span> <span class="bound">exp</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> fv <span class="bound">e</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">e</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="keyword1">be</span> <span class="bound">e</span> <span class="keyword1">in</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">exp</span><span class="main">.</span>  <span class="free">P</span> <span class="bound">exp</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">var</span><span class="main">].</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Bool <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">scrut</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">.</span> <span class="free">P</span> <span class="bound">scrut</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">e1</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">e2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">scrut</span> <span class="main">?</span> <span class="bound">e1</span> <span class="main">:</span> <span class="bound">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">exp</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exp_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"nonrec <span class="improper">Γ</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> nonrecE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span>  exp_strong_induct_rec<span class="main">[</span><span class="operator">case_names</span> Var App Let Let_nonrec Lam Bool IfThenElse<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Var <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">exp</span> <span class="bound">var</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>App <span class="bound">exp</span> <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">exp</span> <span class="bound">c</span><span class="main">.</span>
    atom <span class="main">`</span> domA <span class="bound">Γ</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">¬</span> nonrec <span class="bound">Γ</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domA <span class="bound">Γ</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>the <span class="main">(</span>map_of <span class="bound">Γ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Let <span class="bound">Γ</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">e</span> <span class="bound">exp</span> <span class="bound">c</span><span class="main">.</span> <span class="main">{</span>atom <span class="bound">x</span><span class="main">}</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> fv <span class="bound">e</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="keyword1">be</span> <span class="bound">e</span> <span class="keyword1">in</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">exp</span> <span class="bound">c</span><span class="main">.</span> <span class="main">{</span>atom <span class="bound">var</span><span class="main">}</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">var</span><span class="main">].</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Bool <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">scrut</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">scrut</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="bound">scrut</span> <span class="main">?</span> <span class="bound">e1</span> <span class="main">:</span> <span class="bound">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>fs<span class="main">)</span> <span class="free">exp</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exp_strong_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"nonrec <span class="improper">Γ</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> nonrecE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span>  exp_strong_induct_rec_set<span class="main">[</span><span class="operator">case_names</span> Var App Let Let_nonrec Lam Bool IfThenElse<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Var <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">exp</span> <span class="bound">var</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>App <span class="bound">exp</span> <span class="bound">var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">exp</span> <span class="bound">c</span><span class="main">.</span>
    atom <span class="main">`</span> domA <span class="bound">Γ</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">¬</span> nonrec <span class="bound">Γ</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span> <span class="bound">x</span> <span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">Γ</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="bound">c</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Let <span class="bound">Γ</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">e</span> <span class="bound">exp</span> <span class="bound">c</span><span class="main">.</span> <span class="main">{</span>atom <span class="bound">x</span><span class="main">}</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> fv <span class="bound">e</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="keyword1">be</span> <span class="bound">e</span> <span class="keyword1">in</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">var</span> <span class="bound">exp</span> <span class="bound">c</span><span class="main">.</span> <span class="main">{</span>atom <span class="bound">var</span><span class="main">}</span> <span class="main">♯*</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">exp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">var</span><span class="main">].</span> <span class="bound">exp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span>Bool <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">scrut</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">scrut</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="bound">scrut</span> <span class="main">?</span> <span class="bound">e1</span> <span class="main">:</span> <span class="bound">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>fs<span class="main">)</span> <span class="free">exp</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exp_strong_induct_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"nonrec <span class="improper">Γ</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> nonrecE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Renaming a lambda-bound variable›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> change_Lam_Variable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y'</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> atom <span class="free">y'</span> <span class="main">♯</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span>  <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span> <span class="main">=</span>  <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y'</span><span class="main">].</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">↔</span> <span class="free">y'</span><span class="main">)</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y'</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">↔</span> <span class="free">y'</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> flip_fresh_fresh<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">↔</span> <span class="free">y'</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y'</span><span class="main">].</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">↔</span> <span class="free">y'</span><span class="main">)</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e</span> <span class="main">=</span>  <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y'</span><span class="main">].</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">↔</span> <span class="free">y'</span><span class="main">)</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AbstractDenotational">
<div class="head">
<h1>Theory AbstractDenotational</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> AbstractDenotational
<span class="keyword2"><span class="keyword">imports</span></span> <a href="HeapSemantics.html">HeapSemantics</a> <a href="Terms.html">Terms</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The denotational semantics for expressions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Because we need to define two semantics later on, we are abstract in the actual domain.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> semantic_domain <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Fn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Value</span> <span class="main">→</span> <span class="tfree">'Value</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'Value</span><span class="main">::</span><span class="main">{</span>pcpo_pt<span class="main">,</span>pure<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Fn_project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Value</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'Value</span> <span class="main">→</span> <span class="tfree">'Value</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool discr <span class="main">→</span> <span class="tfree">'Value</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B_project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Value</span> <span class="main">→</span> <span class="tfree">'Value</span> <span class="main">→</span> <span class="tfree">'Value</span> <span class="main">→</span> <span class="tfree">'Value</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">tick</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Value</span> <span class="main">→</span> <span class="tfree">'Value</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">nominal_function</span></span>
  <span class="entity">ESem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'Value</span><span class="main">)</span> <span class="main">→</span> <span class="tfree">'Value</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="comment1">(*
  Restrict ρ to avoid having to demand atom x ♯ ρ *)</span>
 <span class="quoted"><span class="quoted">"<span class="free">ESem</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="free">tick</span><span class="main">⋅</span><span class="main">(</span><span class="free">Fn</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="free">ESem</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="bound">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">(*
  Do not use ⟦ Var x ⟧<span class="hidden">⇘</span><sub>ρ</sub><span class="hidden">⇙</span>  in the rule for App; it costs an additional
  resource and makes the adequacy proof difficult. *)</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ESem</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="free">tick</span><span class="main">⋅</span><span class="main">(</span><span class="free">Fn_project</span><span class="main">⋅</span><span class="main">(</span><span class="free">ESem</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ρ</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ESem</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="free">tick</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ρ</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ESem</span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="free">tick</span><span class="main">⋅</span><span class="main">(</span><span class="free">ESem</span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">⋅</span><span class="main">(</span>has_ESem.HSem <span class="free">ESem</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="bound">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ESem</span> <span class="main">(</span>Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="free">tick</span><span class="main">⋅</span><span class="main">(</span><span class="free">B</span><span class="main">⋅</span><span class="main">(</span>Discr <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ESem</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">scrut</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="free">tick</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="free">B_project</span><span class="main">⋅</span><span class="main">(</span><span class="free">ESem</span> <span class="free"><span class="bound"><span class="entity">scrut</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">ESem</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">ESem</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">⋅</span><span class="bound">ρ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
<span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The following proofs discharge technical obligations generated by the Nominal package.›</span></span>

<span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eqvt_def ESem_graph_aux_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_cfun_eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unpermute_def permute_pure<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">P</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> exp_strong_exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>

<span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">x'</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eqvt_lam_case<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="main">::</span> <span class="quoted">perm</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">-</span><span class="skolem">π</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span> <span class="skolem">v</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ESem_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="free">ESem_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_pure<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">ESem_sumC</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pemute_minus_self eqvt_at_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_perm'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ESem_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">ESem_sumC</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="free">tick</span><span class="main">⋅</span><span class="main">(</span><span class="free">Fn</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="free">ESem_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="bound">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="free">tick</span><span class="main">⋅</span><span class="main">(</span><span class="free">Fn</span><span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="free">ESem_sumC</span> <span class="skolem">e</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="bound">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>

<span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>19 <span class="skolem">as</span> <span class="skolem">body</span> <span class="skolem">as'</span> <span class="skolem">body'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>9<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eqvt_let_case<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="main">::</span> <span class="quoted">perm</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">-</span><span class="skolem">π</span><span class="main">)</span> <span class="main">♯*</span> <span class="main">(</span>fv <span class="main">(</span>Terms.Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ESem_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>has_ESem.HSem <span class="free">ESem_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>Terms.Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">=</span> <span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="free">ESem_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>has_ESem.HSem <span class="free">ESem_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>Terms.Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permute_pure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="free">ESem_sumC</span><span class="main">)</span> <span class="skolem">body</span><span class="main">⋅</span><span class="main">(</span>has_ESem.HSem <span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="free">ESem_sumC</span><span class="main">)</span> <span class="skolem">as</span><span class="main">⋅</span><span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>Terms.Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pemute_minus_self<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="free">ESem_sumC</span><span class="main">)</span> <span class="skolem">body</span> <span class="main">=</span> <span class="free">ESem_sumC</span> <span class="skolem">body</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eqvt_at_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹eqvt_at <span class="free">ESem_sumC</span> <span class="skolem">body</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_ESem.HSem <span class="main">(</span><span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="free">ESem_sumC</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> has_ESem.HSem  <span class="free">ESem_sumC</span> <span class="skolem">as</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eqvt_at_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_perm'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ESem_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>has_ESem.HSem <span class="free">ESem_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">ESem_sumC</span> <span class="skolem">body</span><span class="main">⋅</span><span class="main">(</span>has_ESem.HSem <span class="free">ESem_sumC</span> <span class="skolem">as</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="free">tick</span><span class="main">⋅</span><span class="main">(</span><span class="free">ESem_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">body</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>has_ESem.HSem <span class="free">ESem_sumC</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">as</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">Λ</span> ρ<span class="main">.</span> <span class="free">tick</span><span class="main">⋅</span><span class="main">(</span><span class="free">ESem_sumC</span> <span class="skolem">body</span><span class="main">⋅</span><span class="main">(</span>has_ESem.HSem <span class="free">ESem_sumC</span> <span class="skolem">as</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="comment1">(* [eqvt] attributes do not survive instantiation, so we pass (no_eqvt) here. We don't need it
   anyways… *)</span>
<span class="keyword1"><span class="command">nominal_termination</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semantic_domain<span class="main">)</span> <span class="main">(</span>no_eqvt<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">sublocale</span></span> has_ESem <span class="quoted">ESem</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">notation</span></span> ESem_syn <span class="main">(</span><span class="quoted">"<span class="keyword1">⟦</span> _ <span class="keyword1">⟧⇘</span>_<span class="keyword1">⇙</span>"</span>  <span class="main">[</span>60<span class="main">,</span>60<span class="main">]</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> EvalHeapSem_syn  <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>⟦</b></span> _ <span class="keyword1"><span class="hidden">❙</span><b>⟧</b>⇘</span>_<span class="keyword1">⇙</span>"</span>  <span class="main">[</span>0<span class="main">,</span>0<span class="main">]</span> 110<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> HSem_syn <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>_"</span>  <span class="main">[</span>60<span class="main">,</span>60<span class="main">]</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">AHSem_bot</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>"</span>  <span class="main">[</span>60<span class="main">]</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main">≡</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⦄</span><span class="main">⊥</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Substitution">
<div class="head">
<h1>Theory Substitution</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Substitution
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Terms.html">Terms</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Defining a substitution function on terms turned out to be slightly tricky.›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">subst_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> var <span class="main">⇒</span> var"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">::v=</span>_<span class="keyword1">]</span>"</span> <span class="main">[</span>1000<span class="main">,</span>100<span class="main">,</span>100<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1"><span class="free">::v=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">nominal_function</span></span>  <span class="main">(</span>default <span class="quoted"><span class="quoted">"case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Inl undefined<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Inr undefined<span class="main">)</span>"</span></span><span class="main">,</span>
                  invariant <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">Γ</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">=</span> Inr <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∧</span> atom <span class="main">`</span> domA <span class="bound">Γ</span> <span class="main">♯*</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> atom <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>Sum_Type.projr <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> atom <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">Γ</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> var <span class="main">⇒</span> var <span class="main">⇒</span> exp"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">::=</span>_<span class="keyword1">]</span>"</span> <span class="main">[</span>1000<span class="main">,</span>100<span class="main">,</span>100<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">subst_heap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> var <span class="main">⇒</span> var <span class="main">⇒</span> heap"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">::h=</span>_<span class="keyword1">]</span>"</span> <span class="main">[</span>1000<span class="main">,</span>100<span class="main">,</span>100<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">::v=</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> App <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">::v=</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">♯*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Let <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1"><span class="free">::h=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">body</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> 
 <span class="main">|</span> <span class="quoted"><span class="quoted">"atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">::=</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">scrut</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">scrut</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1"><span class="free">::h=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1"><span class="free">::h=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span><span class="main">#</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1"><span class="free">::h=</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>

<span class="keyword1"><span class="command">have</span></span> eqvt_at_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">e</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">.</span> eqvt_at <span class="free">subst_subst_heap_sumC</span> <span class="main">(</span>Inl <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> eqvt_at <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="free">subst</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def subst_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Projl_permute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">_</span></span></span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_subst_heap_sumC_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> THE_default_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"Ex1 <span class="main">(</span><span class="free">subst_subst_heap_graph</span> <span class="main">(</span>Inl <span class="main">(</span><span class="improper">e</span><span class="main">,</span> <span class="improper">y</span><span class="main">,</span> <span class="improper">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_subst_heap_graph.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Sum_Type.projl <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> the1_equality<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.sel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Sum_Type.projl <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> the1_equality<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.sel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Sum_Type.projl <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> the1_equality<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.sel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Sum_Type.projl <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> the1_equality<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.sel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Sum_Type.projl <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> the1_equality<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.sel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Sum_Type.projl <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> the1_equality<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.sel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Inr_not_Inl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Inr_not_Inl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">perm_simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">have</span></span> eqvt_at_subst_heap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Γ</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">.</span> eqvt_at <span class="free">subst_subst_heap_sumC</span> <span class="main">(</span>Inr <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> eqvt_at <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="free">subst_heap</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def subst_heap_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Projr_permute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">_</span></span></span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_subst_heap_sumC_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> THE_default_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"Ex1 <span class="main">(</span><span class="free">subst_subst_heap_graph</span> <span class="main">(</span>Inr <span class="main">(</span><span class="improper">Γ</span><span class="main">,</span> <span class="improper">y</span><span class="main">,</span> <span class="improper">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_subst_heap_graph.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> Inr_not_Inl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Sum_Type.projr <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> the1_equality<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.sel<span class="main">)</span>
  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Sum_Type.projr <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> the1_equality<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.sel<span class="main">)</span>
  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">perm_simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">{</span></span>
<span class="comment1">(* Equivariance of the graph *)</span>
<span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eqvt_def subst_subst_heap_graph_aux_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* The invariant *)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_subst_heap_graph.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.bn_defs fresh_star_insert<span class="main">)</span>

<span class="comment1">(* Exhaustiveness *)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">P</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">a</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="skolem">P</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fields <span class="skolem">a1</span> <span class="skolem">a2</span> <span class="skolem">a3</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword1"><span class="command">using</span></span> Inl prems
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> y <span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">a1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c <span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">a3</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exp_strong_exhaust<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">a</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="skolem">P</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fields <span class="skolem">a1</span> <span class="skolem">a2</span> <span class="skolem">a3</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword1"><span class="command">using</span></span> Inr prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> heapToAssn.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>19 <span class="skolem">e</span> <span class="skolem">y2</span> <span class="skolem">z2</span> <span class="skolem">Γ</span> <span class="skolem">e2</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">as2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> eqvt_at_subst<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> eqvt_at_subst_heap<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> meta_eq_to_obj_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subst_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> fun_eq_iff<span class="main"><span class="main">]</span></span>
    meta_eq_to_obj_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subst_heap_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> fun_eq_iff<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="comment1">(* No _sum any more at this point! *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_fresh_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span>
    c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
    as <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> atom <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
    bs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> atom <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">e2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
    f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="main">.</span> <span class="main">[</span><span class="bound">a</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="free">subst</span> <span class="main">(</span>fst <span class="bound">b</span><span class="main">)</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">,</span> <span class="free">subst_heap</span> <span class="main">(</span>snd <span class="bound">b</span><span class="main">)</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Abs_lst_fcb2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq fresh_Pair fresh_star_def Abs_fresh_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> domA_def image_image image_set<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> domA_def image_image image_set<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair perm_supp_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair perm_supp_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>25 <span class="skolem">x2</span> <span class="skolem">y2</span> <span class="skolem">z2</span> <span class="skolem">e2</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">e</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> eqvt_at_subst<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Abs_fresh_iff meta_eq_to_obj_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subst_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> fun_eq_iff<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="comment1">(* No _sum any more at this point! *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x2</span> <span class="main">↔</span> <span class="improper">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="improper">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">nominal_termination</span></span> <span class="main">(</span>eqvt<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted">True</span> <span class="keyword2"><span class="keyword">and</span></span> bn_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="main">(</span>subst_heap <span class="free">Γ</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> domA <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subst_subst_heap.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_assn.bn_defs fresh_star_insert<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> subst_noop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span><span class="main">=</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subst_subst_heap.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fresh_star_Pair exp_assn.bn_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_is_fresh<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">z</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">e</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">z</span><span class="main">]</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>
 <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Γ</span> <span class="main">♯*</span> <span class="free">y</span> <span class="main">⟹</span> atom <span class="free">y</span> <span class="main">♯</span> <span class="free">Γ</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span><span class="free">z</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">z</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subst_subst_heap.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fresh_at_base fresh_star_Pair fresh_star_insert fresh_Nil fresh_Cons pure_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
 subst_pres_fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="free">z</span> <span class="main">⟹</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">z</span><span class="main">]</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>
 <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span> <span class="main">⟹</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="free">y</span> <span class="keyword1">::h=</span> <span class="free">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">z</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subst_subst_heap.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fresh_star_Pair exp_assn.bn_defs fresh_Cons fresh_Nil pure_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_fresh_noop<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> subst_heap_fresh_noop<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span> <span class="main">⟹</span>  <span class="free">Γ</span><span class="main">[</span><span class="free">x</span> <span class="keyword1">::h=</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span>  <span class="quoted"><span class="free">e</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>exp_heap_strong_induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_Pair fresh_at_base fresh_Cons <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supp_subst_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>supp <span class="free">e</span> <span class="main">-</span> <span class="main">{</span>atom <span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> atom <span class="free">y</span> <span class="main">∈</span> supp <span class="free">e</span> <span class="keyword1">then</span> <span class="main">{</span>atom <span class="free">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Γ</span> <span class="main">♯*</span> <span class="free">y</span> <span class="main">⟹</span> supp <span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>supp <span class="free">Γ</span> <span class="main">-</span> <span class="main">{</span>atom <span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> atom <span class="free">y</span> <span class="main">∈</span> supp <span class="free">Γ</span> <span class="keyword1">then</span> <span class="main">{</span>atom <span class="free">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span>  <span class="quoted"><span class="free">e</span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>exp_heap_strong_induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_Pair supp_Nil supp_Cons supp_Pair fresh_Cons exp_assn.supp Let_supp supp_at_base pure_supp <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supp_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>supp <span class="free">e</span> <span class="main">-</span> <span class="main">{</span>atom <span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>atom <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> supp_subst_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_subst_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">y</span> <span class="main">∈</span> fv <span class="free">e</span> <span class="keyword1">then</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Γ</span> <span class="main">♯*</span> <span class="free">y</span> <span class="main">⟹</span> fv <span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fv <span class="free">Γ</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">y</span> <span class="main">∈</span> fv <span class="free">Γ</span> <span class="keyword1">then</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span>  <span class="quoted"><span class="free">e</span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>exp_heap_strong_induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_Pair supp_Nil supp_Cons supp_Pair fresh_Cons exp_assn.supp Let_supp supp_at_base <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_subst_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fv_subst_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_subst_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> fv <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> fv <span class="free">e</span> <span class="main">∩</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_subst_int2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">∩</span> fv <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="main">∩</span> fv <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_swap_same<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span> <span class="main">⟹</span>  <span class="main">(</span><span class="free">x</span> <span class="main">↔</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span> <span class="main">⟹</span> atom <span class="main">`</span>domA <span class="free">Γ</span> <span class="main">♯*</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">↔</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span><span class="main">[</span><span class="free">y</span> <span class="keyword1">::h=</span> <span class="free">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span>  <span class="quoted"><span class="free">e</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>exp_heap_strong_induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair fresh_star_at_base fresh_Cons pure_fresh permute_pure <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_subst_back<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span> <span class="main">⟹</span>  <span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">e</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span> <span class="main">⟹</span> atom <span class="main">`</span>domA <span class="free">Γ</span> <span class="main">♯*</span> <span class="free">y</span>  <span class="main">⟹</span> <span class="free">Γ</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span><span class="free">x</span><span class="main">]</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">nominal_induct</span>  <span class="quoted"><span class="free">e</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>exp_heap_strong_induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair fresh_star_at_base fresh_star_Cons fresh_Cons  exp_assn.bn_defs <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exp_assn.eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_heap_delete<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="keyword1">::h=</span> <span class="free">z</span><span class="main">]</span> <span class="main">=</span> delete <span class="free">x</span> <span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="free">y</span> <span class="keyword1">::h=</span> <span class="free">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_nil_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">[</span><span class="free">x</span> <span class="keyword1">::h=</span> <span class="free">z</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">Γ</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_SmartLet<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Γ</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">z</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>SmartLet <span class="free">Γ</span> <span class="free">body</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">z</span><span class="main">]</span> <span class="main">=</span> SmartLet <span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="free">y</span> <span class="keyword1">::h=</span> <span class="free">z</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">body</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SmartLet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_let_be<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"atom <span class="free">x'</span>  <span class="main">♯</span> <span class="free">y</span> <span class="main">⟹</span> atom <span class="free">x'</span> <span class="main">♯</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">let</span> <span class="free">x'</span> <span class="keyword1">be</span> <span class="free">e</span> <span class="keyword1">in</span> <span class="free">exp</span> <span class="main">)</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="free">x'</span> <span class="keyword1">be</span> <span class="free">e</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span> <span class="keyword1">in</span> <span class="free">exp</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> isLam_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"isLam <span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> isLam <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp_strong_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> isVal_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"isVal <span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> isVal <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp_strong_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> thunks_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"thunks <span class="free">Γ</span><span class="main">[</span><span class="free">y</span><span class="keyword1">::h=</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> thunks <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> thunks_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> map_option <span class="main">(</span><span class="main">λ</span> <span class="bound">e</span> <span class="main">.</span> <span class="bound">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>map_of <span class="free">Γ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCollect_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">e</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span>map_of <span class="free">Γ</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">e</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span> <span class="main">|</span> <span class="bound">k</span><span class="main">↦</span><span class="bound">v</span><span class="main">∈</span>map_of <span class="free">Γ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_eq_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">x'</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="free">Δ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">e'</span> <span class="bound">Γ'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="free">x'</span><span class="main">,</span><span class="bound">e'</span><span class="main">)</span><span class="main">#</span><span class="bound">Γ'</span> <span class="main">∧</span> <span class="bound">e'</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">e</span> <span class="main">∧</span> <span class="bound">Γ'</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nonrec_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="free">Γ</span> <span class="main">♯*</span> <span class="free">x</span> <span class="main">⟹</span> atom <span class="main">`</span> domA <span class="free">Γ</span> <span class="main">♯*</span> <span class="free">y</span> <span class="main">⟹</span> nonrec <span class="free">Γ</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span> <span class="main">⟷</span> nonrec <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonrec_def  fresh_star_def subst_eq_Cons fv_subst_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abstract-Denotational-Props">
<div class="head">
<h1>Theory Abstract-Denotational-Props</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Abstract-Denotational-Props"</span>
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="AbstractDenotational.html">AbstractDenotational</a> <a href="Substitution.html">Substitution</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> semantic_domain
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The semantics ignores fresh variables›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ESem_considers_fv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">e</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>exp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Var
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">S</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">S</span> <span class="main">∩</span> insert <span class="bound">x</span> <span class="bound">S</span> <span class="main">=</span> <span class="bound">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">case</span></span> App
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> App<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">scrut</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fv <span class="skolem">scrut</span> <span class="main">∩</span> <span class="main">(</span>fv <span class="skolem">scrut</span> <span class="main">∪</span> fv <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> fv <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fv <span class="skolem">scrut</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fv <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> <span class="main">(</span>fv <span class="skolem">scrut</span> <span class="main">∪</span> fv <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> fv <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fv <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fv <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="main">(</span>fv <span class="skolem">scrut</span> <span class="main">∪</span> fv <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> fv <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fv <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> IfThenElse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> IfThenElse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> IfThenElse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">e</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="skolem">e</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span><span class="skolem">e</span>⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="skolem">as</span> <span class="main">∪</span> fv <span class="skolem">e</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> Let<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">as</span> <span class="main">⊆</span> fv <span class="skolem">as</span> <span class="main">∪</span> fv <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inf_sup_ord<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="skolem">as</span> <span class="main">∪</span> fv <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="skolem">as</span> <span class="main">∪</span> fv <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_ignores_fresh_restr'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Let<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="main">(</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="skolem">as</span> <span class="main">∪</span> fv <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="skolem">as</span> <span class="main">∪</span> fv <span class="skolem">e</span> <span class="main">-</span> domA <span class="skolem">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_restr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">sublocale</span></span> has_ignore_fresh_ESem <span class="quoted">ESem</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> fv_supp_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ESem_considers_fv'<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Nicer equations for ESem, without freshness requirements›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ESem_Lam<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">tick</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">Fn</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> fv <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> fv <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub>env_delete <span class="free">x</span> <span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ESem_fresh_cong<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">tick</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">Fn</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">tick</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">Fn</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">e</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> fv <span class="free">e</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span>  ESem_considers_fv<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">tick</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">Fn</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">f|`</span> fv <span class="free">e</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> *<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">tick</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">Fn</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span>  ESem_considers_fv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">declare</span></span> ESem.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> ESem_Let<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Let <span class="free">as</span> <span class="free">body</span>⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">tick</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">⟦</span><span class="free">body</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">as</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Let <span class="free">as</span> <span class="free">body</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">tick</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">⟦</span><span class="free">body</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">as</span><span class="main">⦄</span><span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>Let <span class="free">as</span> <span class="free">body</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">as</span><span class="main">⦄</span><span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> fv<span class="main">(</span>Let <span class="free">as</span> <span class="free">body</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">as</span><span class="main">⦄</span><span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">as</span> <span class="main">∪</span> fv <span class="free">body</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_restr_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="free">as</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="free">as</span> <span class="main">∪</span> fv <span class="free">body</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_ignores_fresh_restr'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ ESem_considers_fv<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">body</span>⟧<span class="hidden">⇘</span><sub><span class="main">…</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span><span class="free">body</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">as</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ESem_fresh_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_env_restr_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">declare</span></span> ESem.simps<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Denotation of Substitution›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ESem_subst_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="free">x</span> <span class="main">=</span> <span class="free">ρ</span> <span class="free">y</span> <span class="main">⟹</span>  <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span> <span class="free">y</span><span class="main">]</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="free">x</span> <span class="main">=</span> <span class="free">ρ</span> <span class="free">y</span>  <span class="main">⟹</span>  <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>⟦</b></span> <span class="free">as</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span> <span class="free">as</span><span class="main">[</span><span class="free">x</span><span class="keyword1">::h=</span><span class="free">y</span><span class="main">]</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">e</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>exp_heap_strong_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Var <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> App
  <span class="keyword1"><span class="command">from</span></span> App<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> App<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> App<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">exp</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹atom <span class="main">`</span> domA <span class="skolem">as</span> <span class="main">♯*</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹atom <span class="main">`</span> domA <span class="skolem">as</span>  <span class="main">♯*</span> <span class="skolem">y</span>›</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> domA <span class="skolem">as</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_star_at_base imageI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"domA <span class="main">(</span><span class="skolem">as</span><span class="main">[</span><span class="skolem">x</span><span class="keyword1">::h=</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> domA <span class="skolem">as</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bn_subst<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">ρ</span> <span class="skolem">y</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">as</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> domA <span class="skolem">as</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="skolem">exp</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span><span class="skolem">exp</span><span class="main">[</span><span class="skolem">x</span><span class="main">::=</span><span class="skolem">y</span><span class="main">]</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">ρ</span> <span class="skolem">y</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">ρ</span> <span class="main">=</span> <span class="main">⦃</span><span class="skolem">as</span><span class="main">[</span><span class="skolem">x</span><span class="keyword1">::h=</span><span class="skolem">y</span><span class="main">]</span><span class="main">⦄</span><span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">as</span><span class="main">[</span><span class="skolem">x</span><span class="keyword1">::h=</span><span class="skolem">y</span><span class="main">]</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_HSem_ind<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> adm_lemmas <span class="dynamic"><span class="dynamic">cont2cont</span></span> cont2cont_fun<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Let<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">as</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> domA <span class="skolem">as</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Let<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">var</span> <span class="skolem">exp</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">ρ</span> <span class="skolem">y</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ρ</span><span class="main">(</span><span class="skolem">var</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ρ</span><span class="main">(</span><span class="skolem">var</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Lam<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">exp</span>⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span><span class="main">(</span><span class="skolem">var</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span><span class="skolem">exp</span><span class="main">[</span><span class="skolem">x</span><span class="main">::=</span><span class="skolem">y</span><span class="main">]</span>⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span><span class="main">(</span><span class="skolem">var</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Lam<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Lam<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> IfThenElse
  <span class="keyword1"><span class="command">from</span></span> IfThenElse<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> IfThenElse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> IfThenElse<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> IfThenElse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> IfThenElse<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> IfThenElse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> Cons<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ESem_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">σ</span> <span class="free">y</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span> <span class="free">y</span><span class="main">]</span> ⟧<span class="hidden">⇘</span><sub><span class="free">σ</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fv <span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span><span class="free">y</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_def supp_subst supp_at_base <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_subst<span class="main"><span class="main">]</span></span><span class="main">)</span> 

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">σ</span> <span class="free">y</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span> <span class="free">y</span><span class="main">]</span> ⟧<span class="hidden">⇘</span><sub><span class="free">σ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">σ</span> <span class="free">y</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ESem_subst_same<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span><span class="main">[</span><span class="free">x</span><span class="main">::=</span> <span class="free">y</span><span class="main">]</span> ⟧<span class="hidden">⇘</span><sub><span class="free">σ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ESem_fresh_cong<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Value">
<div class="head">
<h1>Theory Value</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Value"</span>
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOLCF/HOLCF.html">HOLCF</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The semantic domain for values and environments›</span></span>

<span class="keyword1"><span class="command">domain</span></span> Value <span class="main">=</span> Fn <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> <span class="quoted"><span class="quoted">"Value <span class="main">→</span> Value"</span></span><span class="main">)</span> <span class="main">|</span> B <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> <span class="quoted"><span class="quoted">"bool discr"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fixrec</span></span> <span class="entity">Fn_project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">→</span> Value <span class="main">→</span> Value"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fn_project</span><span class="main">⋅</span><span class="main">(</span>Fn<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Fn_project_abbr</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↓Fn</span>"</span> 55<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">↓Fn</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> Fn_project<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="keyword1">↓Fn</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>B<span class="main">⋅</span><span class="free">b</span><span class="main">)</span> <span class="keyword1">↓Fn</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fixrec_simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fixrec</span></span> <span class="entity">B_project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">→</span> Value <span class="main">→</span> Value <span class="main">→</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">B_project</span><span class="main">⋅</span><span class="main">(</span>B<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">db</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> undiscr <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"B_project<span class="main">⋅</span><span class="main">(</span>B<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"B_project<span class="main">⋅</span><span class="main">⊥</span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"B_project<span class="main">⋅</span><span class="main">(</span>Fn<span class="main">⋅</span><span class="free">f</span><span class="main">)</span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A chain in the domain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">Value</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is either always bottom, or eventually <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Fn"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of another
chain
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Value_chainE<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> bot B Fn<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main">.</span> <span class="main">⊥</span><span class="main">)</span>"</span></span> <span class="main">|</span>
          <span class="free">n</span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> B<span class="main">⋅</span><span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
          <span class="free">n</span> <span class="free">Y'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> Fn<span class="main">⋅</span><span class="main">(</span><span class="free">Y'</span> <span class="main">(</span><span class="bound">m</span><span class="main">-</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">Y'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main">.</span> <span class="main">⊥</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">m</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> <span class="bound">m</span> <span class="main">≥</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exE<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> ex_has_least_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">⟶</span> <span class="free">Y</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> <span class="free">Y</span> <span class="skolem">n</span> <span class="main">=</span> Fn<span class="main">⋅</span><span class="bound">f</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="free">Y</span> <span class="skolem">n</span> <span class="main">=</span> B<span class="main">⋅</span><span class="bound">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Value.exhaust<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> <span class="free">Y</span> <span class="skolem">n</span> <span class="main">=</span> Fn<span class="main">⋅</span><span class="bound">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="skolem">n</span> <span class="main">=</span> Fn <span class="main">⋅</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="skolem">n</span> <span class="main">⊑</span> <span class="free">Y</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chain_mono le_add2<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Y</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="free">Y</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Fn <span class="main">⋅</span> <span class="bound">g</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Value.dist_les<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Value.exhaust below_bottom_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Fn <span class="main">⋅</span> <span class="main">(</span><span class="skolem">Y'</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> Fn<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y'</span> <span class="main">(</span><span class="bound">m</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="main">_</span>›</span></span> Y' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_inverse add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"chain <span class="skolem">Y'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>chainI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> chainE  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Value.inverts<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Y'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Value.inverts<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="free">Y</span> <span class="skolem">n</span> <span class="main">=</span> B<span class="main">⋅</span><span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="skolem">n</span> <span class="main">=</span> B<span class="main">⋅</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹chain <span class="free">Y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="skolem">n</span> <span class="main">⊑</span> <span class="free">Y</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chain_mono le_add2<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Y</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> B<span class="main">⋅</span><span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Value.dist_les<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Value.exhaust Value.inverts<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> below_bottom_iff discrete_cpo<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span>  Y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> B<span class="main">⋅</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> B<span class="main">⋅</span><span class="skolem">b</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="main">_</span>›</span></span> Y' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_inverse add.commute<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Value-Nominal">
<div class="head">
<h1>Theory Value-Nominal</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Value-Nominal"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Value.html">Value</a> <span class="quoted">"<a href="Nominal-Utils.html">Nominal-Utils</a>"</span> <span class="quoted">"<a href="Nominal-HOLCF.html">Nominal-HOLCF</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Values are pure, i.e. contain no variables.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Value <span class="main">::</span> <span class="quoted">pure</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">::</span>Value<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_Value_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> Value <span class="main">::</span> <span class="quoted">pcpo_pt</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pure_permute_id<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Denotational">
<div class="head">
<h1>Theory Denotational</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Denotational
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Abstract-Denotational-Props.html">Abstract-Denotational-Props</a>"</span> <span class="quoted">"<a href="Value-Nominal.html">Value-Nominal</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This is the actual denotational semantics as found in \cite{launchbury}.
›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> semantic_domain <span class="quoted">Fn</span> <span class="quoted">Fn_project</span> <span class="quoted">B</span> <span class="quoted">B_project</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">notation</span></span> ESem_syn <span class="main">(</span><span class="quoted">"<span class="keyword1">⟦</span> _ <span class="keyword1">⟧⇘</span>_<span class="keyword1">⇙</span>"</span>  <span class="main">[</span>60<span class="main">,</span>60<span class="main">]</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> EvalHeapSem_syn  <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>⟦</b></span> _ <span class="keyword1"><span class="hidden">❙</span><b>⟧</b>⇘</span>_<span class="keyword1">⇙</span>"</span>  <span class="main">[</span>0<span class="main">,</span>0<span class="main">]</span> 110<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> HSem_syn <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>_"</span>  <span class="main">[</span>60<span class="main">,</span>60<span class="main">]</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> AHSem_bot <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>"</span>  <span class="main">[</span>60<span class="main">]</span> 60<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ESem_simps_as_defined<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span>  Fn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> <span class="main">(</span>fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> App <span class="free">e</span> <span class="free">x</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>    <span class="main">=</span>  <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="keyword1">↓Fn</span> <span class="free">ρ</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Var <span class="free">x</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>      <span class="main">=</span>  <span class="free">ρ</span>  <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Bool <span class="free">b</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>     <span class="main">=</span>  B<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> B_project<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span> <span class="free">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Let <span class="free">Γ</span> <span class="free">body</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span><span class="free">body</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">(</span><span class="free">ρ</span> <span class="keyword1">f|`</span> fv <span class="main">(</span>Let <span class="free">Γ</span> <span class="free">body</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ESem_Lam ESem_Let <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ESem.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> <span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> ESem_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span>  Fn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> App <span class="free">e</span> <span class="free">x</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>    <span class="main">=</span>  <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="keyword1">↓Fn</span> <span class="free">ρ</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Var <span class="free">x</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>      <span class="main">=</span>  <span class="free">ρ</span>  <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Bool <span class="free">b</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>     <span class="main">=</span>  B<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> B_project<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span> <span class="free">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Let <span class="free">Γ</span> <span class="free">body</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span><span class="free">body</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Excluded from the document, as these are unused in the current development.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Replacing subexpressions by variables›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_subst_var_app<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">n</span> <span class="main">♯</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="main">(</span>Var <span class="free">n</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="free">e</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> HSem_subst_expr<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="free">e</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Var <span class="free">n</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="free">e</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="free">e</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="free">e</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> HSem_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> App <span class="main">(</span>Var <span class="free">n</span><span class="main">)</span> <span class="free">y</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="free">e</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="main">⟦</span> App <span class="free">e</span> <span class="free">y</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="free">e</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Var <span class="free">n</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="main">(</span>Var <span class="free">n</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="main">(</span>Var <span class="free">n</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="main">(</span>Var <span class="free">n</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> HSem_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> App <span class="free">e</span> <span class="free">y</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="main">(</span>Var <span class="free">n</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="main">⟦</span> App <span class="main">(</span>Var <span class="free">n</span><span class="main">)</span> <span class="free">y</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> App <span class="main">(</span>Var <span class="free">n</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HSem_subst_var_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">n</span> <span class="main">♯</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> Var <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> <span class="main">=</span> <span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> HSem_subst_expr<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fresh <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Var <span class="free">n</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> HSem_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Var <span class="free">n</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Var <span class="free">n</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> Var <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> Var <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> Var <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> HSem_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> Var <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="main">⟦</span> Var <span class="free">n</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> Var <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Launchbury">
<div class="head">
<h1>Theory Launchbury</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Launchbury
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Terms.html">Terms</a> <a href="Substitution.html">Substitution</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The natural semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the semantics as in \cite{launchbury}, with two differences:
\begin{itemize}
\item Explicit freshness requirements for bound variables in the application and the Let rule.
\item An additional parameter that stores variables that have to be avoided, but do not occur
in the judgement otherwise, follwing \cite{sestoft}.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">reds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> exp <span class="main">⇒</span> var list <span class="main">⇒</span> heap <span class="main">⇒</span> exp <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">:</span> _ <span class="keyword1">⇓⇘</span>_<span class="keyword1">⇙</span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>50<span class="main">,</span>50<span class="main">,</span>50<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  Lambda<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> ⇓<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">L</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> 
 <span class="main">|</span> Application<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> ⇓<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">L</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">].</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> ⇓<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">L</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>
  <span class="main">⟧</span>  <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">:</span></span> App <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> ⇓<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">L</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span> 
 <span class="main">|</span> Variable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    map_of <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span> delete <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> ⇓<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">L</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>
  <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">:</span></span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> ⇓<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">L</span></span></span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
 <span class="main">|</span> Let<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    atom <span class="main">`</span> domA <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">♯*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> ⇓<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">L</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>
  <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">:</span></span> Let <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> ⇓<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">L</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
 <span class="main">|</span> Bool<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">:</span></span> Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span> ⇓<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">L</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">:</span></span> Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
 <span class="main">|</span> IfThenElse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">scrut</span></span></span> ⇓<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">L</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span>Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> ⇓<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">L</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>
  <span class="main">⟧</span>  <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">scrut</span></span></span> <span class="main">?</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> ⇓<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">L</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>

<span class="keyword1"><span class="command">equivariance</span></span> <span class="quoted">reds</span>

<span class="keyword1"><span class="command">nominal_inductive</span></span> reds
  <span class="keyword2"><span class="keyword">avoids</span></span> Application<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Example evaluations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_test<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">:</span> <span class="main">(</span>Let <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> Var <span class="free">y</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">)</span> ⇓<span class="hidden">⇘</span><sub><span class="main">[]</span></sub><span class="hidden">⇙</span> <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> Var <span class="free">y</span><span class="main">)</span><span class="main">]</span> <span class="main">:</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> Var <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Lambda Application Variable Let
 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_Cons fresh_Nil fresh_star_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_test2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span><span class="main">[]</span> <span class="main">:</span> <span class="main">(</span>Let <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> Var <span class="free">y</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>App <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> ⇓<span class="hidden">⇘</span><sub><span class="main">[]</span></sub><span class="hidden">⇙</span> <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> Var <span class="free">y</span><span class="main">)</span><span class="main">]</span> <span class="main">:</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> Var <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Lambda Application Variable Let <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_at_base fresh_Cons fresh_Nil fresh_star_def pure_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Better introduction rules›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This variant do not require freshness.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reds_ApplicationI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">:</span> <span class="free">e'</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Θ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> App <span class="free">e</span> <span class="free">x</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Θ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">y'</span> <span class="main">♯</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">L</span><span class="main">,</span> <span class="free">Δ</span><span class="main">,</span> <span class="free">Θ</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> obtain_fresh<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">].</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y'</span> <span class="main">↔</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹atom <span class="skolem">y'</span> <span class="main">♯</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff fresh_Pair fresh_at_base<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y'</span> <span class="main">↔</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">e'</span><span class="main">)</span><span class="main">[</span><span class="skolem">y'</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">e'</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">y'</span> <span class="main">♯</span> <span class="free">e'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹atom <span class="skolem">y'</span> <span class="main">♯</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True subst_swap_same  subst_subst_back<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y'</span> <span class="main">↔</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹atom <span class="free">y</span> <span class="main">♯</span> <span class="main">_</span>›</span></span>  <span class="quoted"><span class="quoted">‹atom <span class="skolem">y'</span> <span class="main">♯</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flip_fresh_fresh fresh_Pair fresh_at_base<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y'</span> <span class="main">↔</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">e'</span><span class="main">)</span><span class="main">[</span><span class="skolem">y'</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y'</span> <span class="main">↔</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">e'</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">e'</span><span class="main">[</span><span class="free">y</span><span class="main">::=</span><span class="free">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹atom <span class="free">y</span> <span class="main">♯</span> <span class="main">_</span>›</span></span>  <span class="quoted"><span class="quoted">‹atom <span class="skolem">y'</span> <span class="main">♯</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flip_fresh_fresh fresh_Pair fresh_at_base subst_pres_fresh<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">y'</span> <span class="main">♯</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">L</span><span class="main">,</span> <span class="free">Δ</span><span class="main">,</span> <span class="free">Θ</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹atom <span class="skolem">y'</span> <span class="main">♯</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this assms<span class="main">[</span><span class="operator">folded</span> a b<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reds_SmartLet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    atom <span class="main">`</span> domA <span class="free">Δ</span> <span class="main">♯*</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">L</span><span class="main">)</span><span class="main">;</span>
    <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">:</span> <span class="free">body</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Θ</span> <span class="main">:</span> <span class="free">z</span>
  <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">Γ</span> <span class="main">:</span> SmartLet <span class="free">Δ</span> <span class="free">body</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Θ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> SmartLet_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reds.Let<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A single rule for values
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> reds_isValI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"isVal <span class="free">z</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">:</span> <span class="free">z</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Γ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>isVal.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reds.intros<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of the semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Heap entries are never removed.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reds_doesnt_forget<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span> <span class="main">⟹</span> domA <span class="free">Γ</span> <span class="main">⊆</span> domA <span class="free">Δ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reds.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Live variables are not added to the heap.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reds_avoids_live'<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>domA <span class="free">Δ</span> <span class="main">-</span> domA <span class="free">Γ</span><span class="main">)</span> <span class="main">∩</span> set <span class="free">L</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>reds.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_domAD fresh_distinct_list <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reds_avoids_live<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span><span class="main">;</span>
   <span class="free">x</span> <span class="main">∈</span> set <span class="free">L</span><span class="main">;</span>
   <span class="free">x</span> <span class="main">∉</span> domA <span class="free">Γ</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> domA <span class="free">Δ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> reds_avoids_live' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Fresh variables either stay fresh or are added to the heap.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reds_fresh<span class="main">:</span><span class="quoted"><span class="quoted">" <span class="main">⟦</span> <span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span><span class="main">;</span>
   atom <span class="main">(</span><span class="free">x</span><span class="main">::</span>var<span class="main">)</span> <span class="main">♯</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span>
  <span class="main">⟧</span> <span class="main">⟹</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>domA <span class="free">Δ</span> <span class="main">-</span> set <span class="free">L</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reds.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lambda <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Application <span class="skolem">y</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">x'</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">Θ</span> <span class="skolem">z</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span><span class="main">)</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> domA <span class="skolem">Δ</span> <span class="main">-</span> set <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">L</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="skolem">e'</span><span class="main">[</span><span class="skolem">y</span> <span class="main">::=</span> <span class="skolem">x'</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Application.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subst_pres_fresh <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Application.hyps<span class="main">(</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="skolem">Δ</span> <span class="main">-</span> set <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">L</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> reds_doesnt_forget<span class="main">[</span><span class="operator">OF</span> Application.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>

<span class="keyword3"><span class="command">case</span></span><span class="main">(</span>Variable <span class="skolem">Γ</span> <span class="skolem">v</span> <span class="skolem">e</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Variable.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fresh_delete<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> delete <span class="skolem">v</span> <span class="skolem">Γ</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Variable.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domA_from_set map_of_SomeD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fresh_map_of<span class="main">[</span><span class="operator">OF</span> this  <span class="quoted"><span class="quoted">‹atom <span class="free">x</span> <span class="main">♯</span> <span class="skolem">Γ</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> the <span class="main">(</span>map_of <span class="skolem">Γ</span> <span class="skolem">v</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> domA <span class="skolem">Δ</span> <span class="main">-</span> set <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">L</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> Variable.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹atom <span class="free">x</span> <span class="main">♯</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_Cons fresh_at_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>

<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bool <span class="skolem">Γ</span> <span class="skolem">b</span> <span class="skolem">L</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>

<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">Γ</span> <span class="skolem">scrut</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">b</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Θ</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> IfThenElse.hyps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> Bool <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> IfThenElse.hyps<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="skolem">Δ</span> <span class="main">-</span> set <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> reds_doesnt_forget<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Δ</span> <span class="main">:</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">L</span></sub><span class="hidden">⇙</span> <span class="skolem">Θ</span> <span class="main">:</span> <span class="skolem">z</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>

<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">Γ</span> <span class="skolem">L</span> <span class="skolem">body</span> <span class="skolem">Θ</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="skolem">Δ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Let.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>      
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Let.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Let.prems <span class="quoted"><span class="quoted">‹atom <span class="free">x</span> <span class="main">♯</span> <span class="skolem">Δ</span>›</span></span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="skolem">L</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Let<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fresh_PairD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fresh_star_def image_eqI set_not_fresh<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> reds_doesnt_forget<span class="main">[</span><span class="operator">OF</span> Let.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reds_fresh_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span><span class="main">;</span>
   <span class="free">x</span> <span class="main">∈</span> fv <span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span> <span class="main">∉</span> domA <span class="free">Δ</span> <span class="main">∨</span>  <span class="free">x</span> <span class="main">∈</span> set <span class="free">L</span><span class="main">)</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> fv <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> reds_fresh
<span class="keyword1"><span class="command">unfolding</span></span> fv_def fresh_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> new_free_vars_on_heap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">-</span> domA <span class="free">Δ</span> <span class="main">⊆</span> fv <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">-</span> domA <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> reds_fresh_fv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> reds_doesnt_forget<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> reds_pres_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">L</span> <span class="main">∪</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">L</span> <span class="main">∪</span> domA <span class="free">Δ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> new_free_vars_on_heap<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Reducing the set of variables to avoid is always possible.
›</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> reds_smaller_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span><span class="main">;</span>
   set <span class="free">L'</span> <span class="main">⊆</span> set <span class="free">L</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L'</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">nominal_induct</span> <span class="quasi_keyword">avoiding</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reds.strong_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lambda <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">L</span> <span class="skolem">L'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds.Lambda<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Application <span class="skolem">y</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">xa</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">Θ</span> <span class="skolem">z</span> <span class="skolem">e'</span> <span class="skolem">L'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Application.hyps<span class="main">(</span>10<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Application.prems<span class="main">]</span> Application.hyps<span class="main">(</span>12<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Application.prems<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds_ApplicationI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Variable <span class="skolem">Γ</span> <span class="skolem">xa</span> <span class="skolem">e</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">z</span> <span class="skolem">L'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">xa</span> <span class="main">#</span> <span class="skolem">L'</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="skolem">xa</span> <span class="main">#</span> <span class="skolem">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Variable.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds.Variable<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Variable<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Variable.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bool <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">Γ</span> <span class="skolem">scrut</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">b</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Θ</span> <span class="skolem">z</span> <span class="skolem">L'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>  reds.IfThenElse<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">Γ</span>  <span class="skolem">L</span> <span class="skolem">body</span> <span class="skolem">Θ</span> <span class="skolem">z</span> <span class="skolem">L'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">L'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Let<span class="main">(</span>1-3<span class="main">)</span> Let.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair  fresh_star_set_subset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds.Let<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Let.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> Let.prems<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Things are evaluated to a lambda expression, and the variable can be freely chose.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> result_evaluated<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span> <span class="main">⟹</span> isVal <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">L</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>reds.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> reds_doesnt_forget<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> result_evaluated_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="free">e'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span> <span class="free">e'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>fs<span class="main">)</span>"</span></span> <span class="main">|</span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> Bool <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isVal <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> result_evaluated<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">y</span> <span class="bound">e'</span><span class="main">.</span> <span class="free">z</span> <span class="main">=</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="bound">y</span><span class="main">].</span> <span class="bound">e'</span> <span class="main">∧</span> atom <span class="bound">y</span> <span class="main">♯</span> <span class="free">c</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="free">z</span> <span class="main">=</span> Bool <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>exp_strong_induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CorrectnessOriginal">
<div class="head">
<h1>Theory CorrectnessOriginal</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CorrectnessOriginal
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Denotational.html">Denotational</a> <a href="Launchbury.html">Launchbury</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This is the main correctness theorem, Theorem 2 from \cite{launchbury}.
›</span></span>

<span class="comment1">(* Another possible invariant seems to be: "edom ρ - domA Γ ⊆ set L" *)</span>

<span class="keyword1"><span class="command">theorem</span></span> correctness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">L</span> <span class="main">∪</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span><span class="free">v</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">nominal_induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>reds.strong_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Lambda
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Application <span class="skolem">y</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">Θ</span> <span class="skolem">v</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Gamma_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Γ</span> <span class="main">⊆</span> domA <span class="skolem">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds_doesnt_forget<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Application.hyps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">hence</span></span> prem1<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> reds_pres_closed<span class="main">[</span><span class="operator">OF</span> Application.hyps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> prem1<span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> reds_doesnt_forget<span class="main">[</span><span class="operator">OF</span> Application.hyps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">e'</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> prem2<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> Application.hyps<span class="main">(</span>10<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prem1<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">ρ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">x</span>  <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span>›</span></span> reds_avoids_live<span class="main">[</span><span class="operator">OF</span> Application.hyps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹% nice proof start›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> App <span class="skolem">e</span> <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="keyword1">↓Fn</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="keyword1">↓Fn</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Application.hyps<span class="main">(</span>9<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prem1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="keyword1">↓Fn</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> *<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>Fn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> z<span class="main">.</span> <span class="main">⟦</span> <span class="skolem">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">(</span><span class="skolem">y</span> <span class="main">:=</span> <span class="bound">z</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">↓Fn</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟦</span> <span class="skolem">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">(</span><span class="skolem">y</span> <span class="main">:=</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟦</span> <span class="skolem">e'</span><span class="main">[</span><span class="skolem">y</span> <span class="main">::=</span> <span class="skolem">x</span><span class="main">]</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ESem_subst<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Θ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Application.hyps<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> App <span class="skolem">e</span> <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Θ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹% nice proof end›</span></span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Θ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Application.hyps<span class="main">(</span>10<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prem1<span class="main">]</span>
          env_restr_eq_subset<span class="main">[</span><span class="operator">OF</span> Gamma_subset Application.hyps<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem2<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Variable <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domA_from_set map_of_SomeD<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"delete <span class="skolem">x</span> <span class="skolem">Γ</span>"</span></span>

  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds_avoids_live<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Variable.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="var">?Γ</span> <span class="main">⊆</span> domA <span class="skolem">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds_doesnt_forget<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Variable.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?new</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Δ</span> <span class="main">-</span> domA <span class="skolem">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="var">?Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">⊆</span> fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fv_delete_heap<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="var">?Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">L</span><span class="main">)</span> <span class="main">∪</span> domA <span class="var">?Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="var">?Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">-</span> domA <span class="var">?Γ</span> <span class="main">⊆</span> <span class="main">-</span> <span class="var">?new</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reds_avoids_live'<span class="main">[</span><span class="operator">OF</span> Variable.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Γ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">-</span><span class="var">?new</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span> <span class="main">=</span> <span class="main">⦃</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="var">?Γ</span><span class="main">⦄</span><span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_reorder<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_of_delete_insert<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> Variable<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ρ</span> ++<span class="hidden">⇘</span><sub><span class="main">(</span>domA <span class="var">?Γ</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="main">⦃</span><span class="var">?Γ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="main">⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iterative_HSem<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ρ</span> ++<span class="hidden">⇘</span><sub><span class="main">(</span>domA <span class="var">?Γ</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="main">⦃</span><span class="var">?Γ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="main">⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="var">?Γ</span><span class="main">⦄</span><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iterative_HSem'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span><span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="var">?new</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">...</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="var">?new</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="skolem">Δ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="main">⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="var">?new</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_fix_ind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="keyword1"><span class="keyword1">f|`</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">-</span></span> <span class="var"><span class="var">?new</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">y</span></span> <span class="keyword1"><span class="keyword1">f|`</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">-</span></span> <span class="var"><span class="var">?new</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">σ</span> <span class="skolem">σ'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="var">?Γ</span><span class="main">⦄</span><span class="skolem">σ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="var">?Γ</span><span class="main">⦄</span><span class="skolem">σ'</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="var">?Γ</span><span class="main">⦄</span><span class="skolem">σ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="var">?Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="var">?Γ</span><span class="main">⦄</span><span class="skolem">σ'</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="var">?Γ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fv_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ESem_fresh_cong HSem_fresh_cong  env_restr_eq_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 3<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> trans<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Variable<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem<span class="main"><span class="main">]</span></span><span class="main">]</span> trans<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Variable<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="var">?Γ</span><span class="main">⦄</span><span class="skolem">σ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">σ'</span></sub><span class="hidden">⇙</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="var">?Γ</span><span class="main">⦄</span><span class="skolem">σ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="var">?Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">σ'</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="var">?Γ</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> subset
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_override_on_eq  lookup_env_restr_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> env_restr_eqD <span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="skolem">Δ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="main">⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span><span class="var">?new</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iterative_HSem'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Δ</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span><span class="var">?new</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iterative_HSem<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Δ</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> le<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_eq_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹domA <span class="skolem">Γ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">-</span><span class="var">?new</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Var <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> Var <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> env_restr_eqD<span class="main">[</span><span class="operator">OF</span> le<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_heap<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Var <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bool <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">Γ</span> <span class="skolem">scrut</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">b</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Θ</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Gamma_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Γ</span> <span class="main">⊆</span> domA <span class="skolem">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds_doesnt_forget<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IfThenElse.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>

  <span class="keyword3"><span class="command">case</span></span> 1

  <span class="keyword1"><span class="command">hence</span></span> prem1<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prem2<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="var">?e</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fv <span class="var">?e</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> set <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_free_vars_on_heap<span class="main">[</span><span class="operator">OF</span> IfThenElse.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Gamma_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> B_project<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span> <span class="skolem">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> B_project<span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span> Bool <span class="skolem">b</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> IfThenElse.hyps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prem1<span class="main">]</span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟦</span> <span class="var">?e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟦</span> <span class="var">?e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ESem_fresh_cong_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹fv <span class="var">?e</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> set <span class="skolem">L</span>›</span></span> env_restr_eqI<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> set <span class="skolem">L</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> IfThenElse.hyps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prem1<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">x</span>  <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> set <span class="skolem">L</span>›</span></span> reds_avoids_live<span class="main">[</span><span class="operator">OF</span> IfThenElse.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Θ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> IfThenElse.hyps<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prem2<span class="main">]</span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">thm</span></span> env_restr_eq_subset
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Θ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IfThenElse.hyps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prem1<span class="main">]</span>
          env_restr_eq_subset<span class="main">[</span><span class="operator">OF</span> Gamma_subset IfThenElse.hyps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem2<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">Γ</span> <span class="skolem">L</span> <span class="skolem">body</span> <span class="skolem">Δ</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> domA  <span class="skolem">as</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">a</span> <span class="main">♯</span> <span class="skolem">Γ</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fresh_star_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domA_not_fresh<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this

  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">body</span><span class="main">)</span> <span class="main">-</span> domA <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">⊆</span>  fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span> <span class="main">-</span> domA <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">body</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">as</span> <span class="main">♯*</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Let<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_bn_to_atom_domA<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Let <span class="skolem">as</span> <span class="skolem">body</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⟦</span> <span class="skolem">body</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟦</span> <span class="skolem">body</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HSem_merge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> domA <span class="skolem">as</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other lookup_env_restr_eq *<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HSem_merge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_eq_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Let.hyps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Mono-Nat-Fun">
<div class="head">
<h1>Theory Mono-Nat-Fun</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Mono-Nat-Fun"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Infinite_Set.html">HOL-Library.Infinite_Set</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following lemma proves that a monotonous function from and to the natural numbers is either eventually
constant or unbounded.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nat_mono_characterization<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="main">.</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">m</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">m</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">m</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span> <span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">f</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> Max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">n</span> <span class="main">=</span> Max <span class="main">(</span>range <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mono <span class="free">f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> monoD<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">m</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Max <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> True rangeI<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">m</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_nat_iff_unbounded_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="C">
<div class="head">
<h1>Theory C</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> C
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOLCF/HOLCF.html">HOLCF</a> <span class="quoted">"<a href="Mono-Nat-Fun.html">Mono-Nat-Fun</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">default_sort</span></span> <span class="quoted">cpo</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The initial solution to the domain equation $C = C_\bot$, i.e. the completion of the natural numbers.
›</span></span>

<span class="keyword1"><span class="command">domain</span></span> C <span class="main">=</span> C <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> <span class="quoted"><span class="quoted">"C"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> below_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Cinf</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">C<span class="hidden">⇧</span><sup>∞</sup></span></span> <span class="main">=</span> fix<span class="main">⋅</span>C"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> C_Cinf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"C<span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cinf_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fix_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Cpow</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">C⇗</span>_<span class="keyword1">⇖</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"C<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">n</span></span></span></sup><span class="hidden">⇖</span> <span class="main">≡</span> iterate <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">⋅</span>C<span class="main">⋅</span><span class="main">⊥</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> C_below_C<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>C<span class="hidden">⇗</span><sup><span class="free">i</span></sup><span class="hidden">⇖</span> <span class="main">⊑</span> C<span class="hidden">⇗</span><sup><span class="free">j</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> below_Cinf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⊑</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> C_Cinf monofun_cfun_arg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> C_eq_Cinf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"C<span class="hidden">⇗</span><sup><span class="free">i</span></sup><span class="hidden">⇖</span> <span class="main">≠</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> C_below_C Suc_n_not_le_n below_Cinf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Cinf_eq_C<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> C <span class="main">⋅</span> <span class="free">r</span> <span class="main">⟷</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> C.injects C_Cinf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> C_eq_C<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>C<span class="hidden">⇗</span><sup><span class="free">i</span></sup><span class="hidden">⇖</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="free">j</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> C_below_C le_antisym le_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> case_of_C_below<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">r</span> <span class="keyword1">of</span> C<span class="main">⋅</span><span class="bound">y</span> <span class="main">⇒</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> C_case_below<span class="main">:</span> <span class="quoted"><span class="quoted">"C_case <span class="main">⋅</span> <span class="free">f</span> <span class="main">⊑</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cfun_belowI C.case_rews<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> below_C monofun_cfun_arg<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> C_case_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"C_case <span class="main">⋅</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_bottom_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> C_case_below<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> C_case_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r'</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> C<span class="main">⋅</span><span class="bound">r'</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">r'</span> <span class="main">=</span> <span class="free">g</span><span class="main">⋅</span><span class="bound">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"C_case<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">r</span> <span class="main">=</span> C_case<span class="main">⋅</span><span class="free">g</span><span class="main">⋅</span><span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> C_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> C_take <span class="skolem">m</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span> "</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> C.finite_induct<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="main">0</span></sup><span class="hidden">⇖</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">⊥</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">r</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> C<span class="main">⋅</span><span class="skolem">r</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iterate_Suc <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iterate_Suc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">m</span><span class="main">.</span> C_take <span class="bound">m</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="skolem">f</span> <span class="bound">m</span></sup><span class="hidden">⇖</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span> <span class="bound">m</span><span class="main">.</span> C<span class="hidden">⇗</span><sup><span class="skolem">f</span> <span class="bound">m</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ch2ch_Rep_cfunL<span class="main">[</span><span class="operator">OF</span> C.chain_take<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">,</span> <span class="operator">unfolded</span> take<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mono <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_iff_le_Suc chain_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>chainE<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">m</span><span class="main">.</span> C<span class="hidden">⇗</span><sup><span class="skolem">f</span> <span class="bound">m</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> take C.reach lub_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹mono <span class="skolem">f</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> nat_mono_characterization<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">m</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="bound">m</span> <span class="main">==&gt;</span> <span class="skolem">f</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">m</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max_in_chain <span class="skolem">n</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">m</span><span class="main">.</span> C<span class="hidden">⇗</span><sup><span class="skolem">f</span> <span class="bound">m</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> max_in_chainI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> n<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span> <span class="bound">m</span><span class="main">.</span> C<span class="hidden">⇗</span><sup><span class="skolem">f</span> <span class="bound">m</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="skolem">f</span> <span class="skolem">n</span></sup><span class="hidden">⇖</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span>  maxinch_is_thelub<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="main">_</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> C<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span> <span class="main">⊑</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> below_lub<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span> <span class="bound">n</span><span class="main">.</span> C<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">r</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lub_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> chain_iterate<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⊑</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cinf_def fix_def2<span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> below_Cinf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> C_case_Cinf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"C_case <span class="main">⋅</span> <span class="free">f</span> <span class="main">⋅</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">f</span> <span class="main">⋅</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Cinf_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CValue">
<div class="head">
<h1>Theory CValue</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CValue
<span class="keyword2"><span class="keyword">imports</span></span> <a href="C.html">C</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">domain</span></span> CValue
  <span class="main">=</span> CFn <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>C <span class="main">→</span> CValue<span class="main">)</span> <span class="main">→</span> <span class="main">(</span>C <span class="main">→</span> CValue<span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="main">|</span> CB <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> <span class="quoted"><span class="quoted">"bool discr"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fixrec</span></span> <span class="entity">CFn_project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CValue <span class="main">→</span> <span class="main">(</span>C <span class="main">→</span> CValue<span class="main">)</span> <span class="main">→</span> <span class="main">(</span>C <span class="main">→</span> CValue<span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CFn_project</span><span class="main">⋅</span><span class="main">(</span>CFn<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">CFn_project_abbr</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↓CFn</span>"</span> 55<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">↓CFn</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> CFn_project<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CFn_project_strict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="keyword1">↓CFn</span> <span class="free">v</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"CB<span class="main">⋅</span><span class="free">b</span> <span class="keyword1">↓CFn</span> <span class="free">v</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fixrec_simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CB_below<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"CB<span class="main">⋅</span><span class="free">b</span> <span class="main">⊑</span> <span class="free">v</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">=</span> CB<span class="main">⋅</span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fixrec</span></span> <span class="entity">CB_project</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"CValue <span class="main">→</span> CValue <span class="main">→</span> CValue <span class="main">→</span> CValue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CB_project</span><span class="main">⋅</span><span class="main">(</span>CB<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">db</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> undiscr <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"CB_project<span class="main">⋅</span><span class="main">(</span>CB<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"CB_project<span class="main">⋅</span><span class="main">⊥</span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"CB_project<span class="main">⋅</span><span class="main">(</span>CFn<span class="main">⋅</span><span class="free">f</span><span class="main">)</span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CB_project_not_bot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CB_project<span class="main">⋅</span><span class="free">scrut</span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⋅</span><span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="free">scrut</span> <span class="main">=</span> CB<span class="main">⋅</span><span class="main">(</span>Discr <span class="bound">b</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≠</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">scrut</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> CB_project.simps CValue.injects<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> discr.exhaust undiscr_Discr<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹HOLCF provides us <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> CValue_take<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>::›</span></span></span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typeof</span></span> <span class="quoted"><span class="quoted">CValue_take</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>;
we want a similar function for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"C <span class="main"><span class="main">→</span></span> CValue"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">C_to_CValue_take</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>C <span class="main">→</span> CValue<span class="main">)</span> <span class="main">→</span> <span class="main">(</span>C <span class="main">→</span> CValue<span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C_to_CValue_take</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> cfun_map<span class="main">⋅</span>ID<span class="main">⋅</span><span class="main">(</span>CValue_take <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> C_to_CValue_chain_take<span class="main">:</span> <span class="quoted"><span class="quoted">"chain C_to_CValue_take"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chainI cfun_belowI chainE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> CValue.chain_take<span class="main"><span class="main">]</span></span> monofun_cfun_fun<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> C_to_CValue_reach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span> <span class="bound">n</span><span class="main">.</span> C_to_CValue_take <span class="bound">n</span><span class="main">⋅</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>  cfun_eqI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> contlub_cfun_fun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ch2ch_Rep_cfunL<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> C_to_CValue_chain_take<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>  CValue.reach<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CValue-Nominal">
<div class="head">
<h1>Theory CValue-Nominal</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"CValue-Nominal"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="CValue.html">CValue</a> <span class="quoted">"<a href="Nominal-Utils.html">Nominal-Utils</a>"</span> <span class="quoted">"<a href="Nominal-HOLCF.html">Nominal-HOLCF</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> C <span class="main">::</span> <span class="quoted">pure</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">::</span>C<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_C_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">instance</span></span> C <span class="main">::</span> <span class="quoted">pcpo_pt</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pure_permute_id<span class="main">)</span>


<span class="keyword1"><span class="command">instantiation</span></span> CValue <span class="main">::</span> <span class="quoted">pure</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∙</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">::</span>CValue<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_CValue_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> CValue <span class="main">::</span> <span class="quoted">pcpo_pt</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pure_permute_id<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="HOLCF-Meet">
<div class="head">
<h1>Theory HOLCF-Meet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"HOLCF-Meet"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOLCF/HOLCF.html">HOLCF</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines the $\sqcap$ operator on HOLCF domains, and introduces a type class for domains
where all finite meets exist.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Towards meets: Lower bounds›</span></span>

<span class="keyword1"><span class="command">context</span></span> po
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_lb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;|</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">&gt;|</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊑</span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_lbI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">!!</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">==&gt;</span> <span class="free">l</span> <span class="main">⊑</span> <span class="bound">x</span><span class="main">)</span> <span class="main">==&gt;</span> <span class="free">S</span> <span class="main">&gt;|</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_lb_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_lbD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span><span class="free">S</span> <span class="main">&gt;|</span> <span class="free">l</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">l</span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_lb_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_lb_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">&gt;|</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_lb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_lb_insert <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">&gt;|</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">&gt;|</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_lb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_lb_downward<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span><span class="free">S</span> <span class="main">&gt;|</span> <span class="free">l</span><span class="main">;</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">l</span><span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">S</span> <span class="main">&gt;|</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_lb_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> below_trans<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Greatest lower bounds›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_glb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;&gt;|</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">&gt;&gt;|</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">&gt;|</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">&gt;|</span> <span class="bound">u</span> <span class="main">--&gt;</span> <span class="bound">u</span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">glb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⨅</span>_"</span> <span class="main">[</span>60<span class="main">]</span>60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">glb</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">&gt;&gt;|</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Access to the definition as inference rule›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_glbD1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">&gt;&gt;|</span> <span class="free">x</span> <span class="main">==&gt;</span> <span class="free">S</span> <span class="main">&gt;|</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_glb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_glbD2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span><span class="free">S</span> <span class="main">&gt;&gt;|</span> <span class="free">x</span><span class="main">;</span> <span class="free">S</span> <span class="main">&gt;|</span> <span class="free">u</span><span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">u</span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_glb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> po<span class="main">)</span> is_glbI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span><span class="free">S</span> <span class="main">&gt;|</span> <span class="free">x</span><span class="main">;</span> <span class="main">!!</span><span class="bound">u</span><span class="main">.</span> <span class="free">S</span> <span class="main">&gt;|</span> <span class="bound">u</span> <span class="main">==&gt;</span> <span class="bound">u</span> <span class="main">⊑</span> <span class="free">x</span><span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">S</span> <span class="main">&gt;&gt;|</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_glb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_glb_above_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">&gt;&gt;|</span> <span class="free">x</span> <span class="main">==&gt;</span> <span class="free">u</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">S</span> <span class="main">&gt;|</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_glb_def is_lb_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_trans<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹glbs are unique›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_glb_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span><span class="free">S</span> <span class="main">&gt;&gt;|</span> <span class="free">x</span><span class="main">;</span> <span class="free">S</span> <span class="main">&gt;&gt;|</span> <span class="free">y</span><span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_glb_def is_lb_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> below_antisym<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹technical lemmas about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">glb</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">is_glb</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_glb_glb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&gt;&gt;|</span> <span class="free">x</span> <span class="main">==&gt;</span> <span class="free">M</span> <span class="main">&gt;&gt;|</span> glb <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> glb_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> theI <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ is_glb_unique<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> glb_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&gt;&gt;|</span> <span class="free">l</span> <span class="main">==&gt;</span> glb <span class="free">M</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_glb_unique <span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_glb_glb<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_glb_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">&gt;&gt;|</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_glb_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> glb_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"glb <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_glb_singleton <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> glb_eqI<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_glb_bin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">==&gt;</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">&gt;&gt;|</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_glb_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> glb_bin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">==&gt;</span> glb <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_glb_bin <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> glb_eqI<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_glb_maximal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span><span class="free">S</span> <span class="main">&gt;|</span> <span class="free">x</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">S</span> <span class="main">&gt;&gt;|</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> is_glbI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> is_lbD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> glb_maximal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span><span class="free">S</span> <span class="main">&gt;|</span> <span class="free">x</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">|]</span> <span class="main">==&gt;</span> glb <span class="free">S</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_glb_maximal <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> glb_eqI<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> glb_above<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">&gt;&gt;|</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊑</span> glb <span class="free">S</span> <span class="main">⟷</span> <span class="free">S</span> <span class="main">&gt;|</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> glb_eqI is_glb_above_iff<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpo<span class="main">)</span> Meet_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">&gt;&gt;|</span> <span class="free">l</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">l</span><span class="main">}</span> <span class="main">&gt;&gt;|</span> <span class="free">l2</span> <span class="main">⟹</span> insert <span class="free">x</span> <span class="free">S</span> <span class="main">&gt;&gt;|</span> <span class="free">l2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_glbI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> is_glb_above_iff is_glb_def is_lb_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_glb_above_iff is_glb_def is_glb_singleton is_lb_insert<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Binary, hence finite meets.›</span></span>

<span class="keyword1"><span class="command">class</span></span> Finite_Meet_cpo <span class="main">=</span> cpo <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> binary_meet_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟶</span> <span class="bound">z</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">⟶</span> <span class="bound">z</span> <span class="main">⊑</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> binary_meet_exists'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">&gt;&gt;|</span> <span class="bound">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> binary_meet_exists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_glb_def is_lb_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> finite_meet_exists<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">S</span> <span class="main">&gt;&gt;|</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> notE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">F</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> is_glb_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Meet_insert binary_meet_exists'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">meet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>cpo <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊓</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⊓</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">}</span> <span class="main">&gt;&gt;|</span> <span class="bound">z</span> <span class="keyword1">then</span> glb <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">}</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> meet_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Meet_cpo<span class="main">)</span> <span class="main">⊓</span> <span class="free">y</span> <span class="main">=</span> glb <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> meet_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> binary_meet_exists'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> meet_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Meet_cpo<span class="main">)</span> <span class="main">⊓</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⊓</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> meet_def' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> meet_bot1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>Finite_Meet_cpo<span class="main">,</span>pcpo<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⊥</span> <span class="main">⊓</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> meet_def' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> minimal po_class.glb_bin<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> meet_bot2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>Finite_Meet_cpo<span class="main">,</span>pcpo<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> meet_bot1 meet_comm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> meet_below1<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Finite_Meet_cpo"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> meet_def' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms binary_meet_exists' below_trans glb_eqI is_glbD1 is_lb_insert<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> meet_below2<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Finite_Meet_cpo"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> meet_def' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms binary_meet_exists' below_trans glb_eqI is_glbD1 is_lb_insert<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> meet_above_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Finite_Meet_cpo"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">z</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">⊑</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">&gt;&gt;|</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> binary_meet_exists'<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> meet_def' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> glb_above<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> below_meet<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Finite_Meet_cpo"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms glb_bin meet_def'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> below_meet2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Finite_Meet_cpo"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms below_meet meet_comm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> meet_aboveI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Finite_Meet_cpo"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> meet_above_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_meetI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Finite_Meet_cpo"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⊑</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">;</span> <span class="bound">a</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms below_antisym meet_above_iff below_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> meet_assoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Meet_cpo<span class="main">)</span> <span class="main">⊓</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊓</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⊓</span> <span class="main">(</span><span class="free">y</span> <span class="main">⊓</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_meetI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> below_refl meet_above_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> below_refl meet_below2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> meet_above_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> meet_self<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⊓</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Meet_cpo<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_refl is_meetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>Finite_Meet_cpo<span class="main">)</span> <span class="main">⊓</span> <span class="main">(</span><span class="free">r</span> <span class="main">⊓</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">⊓</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_refl is_meetI meet_below1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> meet_monofun1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Finite_Meet_cpo"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"monofun <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">⊓</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monofunI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> meet_above_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chain_meet1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> Finite_Meet_cpo"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span> <span class="main">⊓</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> meet_above_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chainI chainE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">class</span></span> cont_binary_meet <span class="main">=</span> Finite_Meet_cpo <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> meet_cont'<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊓</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">i</span> <span class="main">⊓</span> <span class="free">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> meet_cont1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> cont_binary_meet"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">⊓</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contI2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> meet_monofun1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> meet_cont'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> meet_cont2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> cont_binary_meet"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> meet_comm<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> meet_cont1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> meet_cont<span class="main">[</span><span class="operator">cont2cont</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> cont <span class="free">g</span> <span class="main">⟹</span> cont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">⊓</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>cont_binary_meet<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cont2cont_case_prod<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">g</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">p</span></span> <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">⊓</span></span> <span class="bound"><span class="bound">y</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> meet_cont1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> meet_cont2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cont2cont_Pair<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="C-Meet">
<div class="head">
<h1>Theory C-Meet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"C-Meet"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="C.html">C</a> <span class="quoted">"<a href="HOLCF-Meet.html">HOLCF-Meet</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> C <span class="main">::</span> <span class="quoted">Finite_Meet_cpo</span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">fixrec</span></span> <span class="entity">C_meet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"C <span class="main">→</span> C <span class="main">→</span> C"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C_meet</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> C<span class="main">⋅</span><span class="main">(</span><span class="free">C_meet</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"C_meet<span class="main">⋅</span><span class="main">⊥</span><span class="main">⋅</span><span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="quoted"><span class="quoted">"C_meet<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fixrec_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fixrec_simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>  

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> exI conjI strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span> <span class="main">⊑</span> C_meet<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">⊑</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">⊑</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>C.take_induct<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>C_take <span class="skolem">n</span><span class="main">⋅</span><span class="skolem">t</span> <span class="main">⊑</span> C_meet<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>C_take <span class="skolem">n</span><span class="main">⋅</span><span class="skolem">t</span> <span class="main">⊑</span> <span class="skolem">x</span> <span class="main">∧</span> C_take <span class="skolem">n</span><span class="main">⋅</span><span class="skolem">t</span> <span class="main">⊑</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_induct<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">t</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> C.nchotomy<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> C.nchotomy<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> C.nchotomy<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"C_meet<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">y</span> <span class="main">⊑</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"C_meet<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">y</span> <span class="main">⊑</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">⊑</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">⊑</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">⊑</span> C_meet<span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> C_meet_is_meet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">z</span> <span class="main">⊑</span> C_meet<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">z</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">⊑</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>C.take_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>C_take <span class="skolem">n</span><span class="main">⋅</span><span class="free">z</span> <span class="main">⊑</span> C_meet<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>C_take <span class="skolem">n</span><span class="main">⋅</span><span class="free">z</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">∧</span> C_take <span class="skolem">n</span><span class="main">⋅</span><span class="free">z</span> <span class="main">⊑</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">z</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfun_below_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span> C <span class="main">::</span> <span class="quoted">cont_binary_meet</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊓</span> <span class="bound">y</span> <span class="main">=</span> C_meet<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C_meet_is_meet
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_meetI<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ch2ch_Rep_cfunR contlub_cfun_arg contlub_cfun_fun<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"C<span class="main">⋅</span><span class="free">r</span> <span class="main">⊓</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_meetI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> below_C<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⊓</span> C<span class="main">⋅</span><span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_meetI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> below_C<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"C<span class="main">⋅</span><span class="free">r</span> <span class="main">⊓</span> C<span class="main">⋅</span><span class="free">r'</span> <span class="main">=</span> C<span class="main">⋅</span><span class="main">(</span><span class="free">r</span> <span class="main">⊓</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_meetI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> below_refl meet_below1 monofun_cfun_arg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> below_refl meet_below2 monofun_cfun_arg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> meet_above_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="C-restr">
<div class="head">
<h1>Theory C-restr</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"C-restr"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="C.html">C</a> <span class="quoted">"<a href="C-Meet.html">C-Meet</a>"</span> <span class="quoted">"<a href="HOLCF-Utils.html">HOLCF-Utils</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The demand of a $C$-function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The demand is the least amount of resources required to produce a non-bottom element,
if at all.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">demand</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>C <span class="main">→</span> <span class="tfree">'a</span><span class="main">::</span>pcpo<span class="main">)</span> <span class="main">⇒</span> C"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">demand</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="keyword1">then</span> C<span class="hidden">⇗</span><sup><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span>C<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span> <span class="main">≠</span> <span class="main">⊥</span><span class="main">)</span></sup><span class="hidden">⇖</span> <span class="keyword1">else</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Because of continuity, a non-bottom value can always be obtained with finite resources.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_resources_suffice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span>C<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span><span class="main">⋅</span><span class="main">(</span>C<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⊑</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lub_below<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ch2ch_Rep_cfunR<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> chain_iterate<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cinf_def fix_def2 contlub_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> chain_iterate<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Because of monotonicity, a non-bottom value can always be obtained with more resources.
›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> more_resources_suffice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="free">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⊑</span> <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="free">r'</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> monofun_cfun_arg<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>  f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> infinite_resources_suffice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="free">r</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> more_resources_suffice<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ below_Cinf<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> demand_suffices<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="main">(</span>demand <span class="free">f</span><span class="main">)</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms demand_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_resources_suffice<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> LeastI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_bot_demand<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="free">r</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟷</span> demand <span class="free">f</span> <span class="main">≠</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">∧</span> demand <span class="free">f</span> <span class="main">⊑</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="free">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span> <span class="main">≠</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">∧</span> demand <span class="free">f</span> <span class="main">⊑</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>C_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Least_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> demand_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> infinite_resources_suffice<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span> <span class="main">≠</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>  <span class="main">∧</span> demand <span class="free">f</span> <span class="main">⊑</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Least_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> demand_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> infinite_resources_suffice<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="main">(</span>demand <span class="free">f</span><span class="main">)</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> demand_suffices<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span> <span class="main">⊑</span> <span class="free">r</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="free">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> more_resources_suffice<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> infinity_bot_demand<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟷</span> demand <span class="free">f</span> <span class="main">=</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_Cinf not_bot_demand<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> demand_suffices'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="free">n</span></sup><span class="hidden">⇖</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="main">(</span>demand <span class="free">f</span><span class="main">)</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> C_eq_Cinf assms demand_suffices infinity_bot_demand<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> demand_Suc_Least<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span> <span class="main">≠</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="main">(</span>Suc <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span><span class="main">⋅</span>C<span class="hidden">⇗</span><sup>Suc <span class="bound">n</span></sup><span class="hidden">⇖</span> <span class="main">≠</span> <span class="main">⊥</span><span class="main">)</span><span class="main">)</span></sup><span class="hidden">⇖</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span><span class="main">⋅</span>C<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span> <span class="main">≠</span> <span class="main">⊥</span><span class="main">)</span></sup><span class="hidden">⇖</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> demand_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span>C<span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>  demand_suffices'<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span><span class="main">⋅</span>C<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span> <span class="main">≠</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span><span class="main">⋅</span>C<span class="hidden">⇗</span><sup>Suc <span class="bound">n</span></sup><span class="hidden">⇖</span> <span class="main">≠</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Least_Suc<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> demand_C_case<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"demand <span class="main">(</span>C_case<span class="main">⋅</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> C <span class="main">⋅</span> <span class="main">(</span>demand <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"demand <span class="main">(</span>C_case<span class="main">⋅</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"C_case<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> infinity_bot_demand<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> infinity_bot_demand<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"demand <span class="main">(</span>C_case<span class="main">⋅</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup>Suc <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span>C_case<span class="main">⋅</span><span class="free">f</span><span class="main">)</span><span class="main">⋅</span>C<span class="hidden">⇗</span><sup>Suc <span class="bound">n</span></sup><span class="hidden">⇖</span> <span class="main">≠</span> <span class="main">⊥</span><span class="main">)</span></sup><span class="hidden">⇖</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> demand_Suc_Least<span class="main"><span class="main">[</span></span><span class="operator">OF</span> C.case_rews<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> C<span class="main">⋅</span>C<span class="hidden">⇗</span><sup><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span><span class="main">⋅</span>C<span class="hidden">⇗</span><sup><span class="bound">n</span></sup><span class="hidden">⇖</span> <span class="main">≠</span> <span class="main">⊥</span></sup><span class="hidden">⇖</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> C<span class="main">⋅</span><span class="main">(</span>demand  <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">unfolding</span></span> demand_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> demand_contravariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊑</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"demand <span class="free">g</span> <span class="main">⊑</span> demand <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>C_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span> <span class="main">=</span> C<span class="hidden">⇗</span><sup><span class="skolem">n</span></sup><span class="hidden">⇖</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="main">(</span>demand <span class="free">f</span><span class="main">)</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> demand_suffices'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> monofun_cfun_fun<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">⋅</span><span class="main">(</span>demand <span class="free">f</span><span class="main">)</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"demand <span class="free">g</span> <span class="main">⊑</span> demand <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> not_bot_demand <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Restricting functions with domain C›</span></span>

<span class="keyword1"><span class="command">fixrec</span></span> <span class="entity">C_restr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"C <span class="main">→</span> <span class="main">(</span>C <span class="main">→</span> <span class="tfree">'a</span><span class="main">::</span>pcpo<span class="main">)</span> <span class="main">→</span> <span class="main">(</span>C <span class="main">→</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C_restr</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⊓</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">C_restr_syn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>C <span class="main">→</span> <span class="tfree">'a</span><span class="main">::</span>pcpo<span class="main">)</span> <span class="main">⇒</span> C <span class="main">⇒</span> <span class="main">(</span>C <span class="main">→</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="main">(</span> <span class="quoted">"_<span class="keyword1">|⇘</span>_<span class="keyword1">⇙</span>"</span> <span class="main">[</span>111<span class="main">,</span>110<span class="main">]</span> 110<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span>|<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">r</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> C_restr<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">f</span>|<span class="hidden">⇘</span><sub><span class="main">⊥</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword1"><span class="command">lemma</span></span> C_restr_C_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span>|<span class="hidden">⇘</span><sub><span class="free">r'</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">v</span>|<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">r'</span> <span class="main">⊓</span> <span class="free">r</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> C_restr_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">g</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">⊑</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="free">r'</span> <span class="main">=</span> <span class="free">g</span><span class="main">⋅</span><span class="free">r'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> C_restr.simps assms below_refl is_meetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> C_restr_eq_lower<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">g</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">⊑</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span>|<span class="hidden">⇘</span><sub><span class="free">r'</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">g</span>|<span class="hidden">⇘</span><sub><span class="free">r'</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> C_restr_C_restr assms below_refl is_meetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> C_restr_below<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_refl meet_below2 monofun_cfun_arg<span class="main">)</span>
  

<span class="keyword1"><span class="command">lemma</span></span> C_restr_below_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">⊑</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">⋅</span> <span class="bound">r'</span> <span class="main">⊑</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="free">g</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_refl meet_below1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> C_restr_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">⊑</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">⋅</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">g</span> <span class="main">⋅</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">g</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> below_antisym C_restr_below_cong <span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> C_restr_C_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">⊑</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">⋅</span> <span class="main">(</span>C<span class="main">⋅</span><span class="bound">r'</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">⋅</span> <span class="main">(</span>C<span class="main">⋅</span><span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">=</span><span class="free">g</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">⟹</span> <span class="free">f</span>|<span class="hidden">⇘</span><sub>C<span class="main">⋅</span><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">g</span>|<span class="hidden">⇘</span><sub>C<span class="main">⋅</span><span class="free">r</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">r'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> C_restr_C_case<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>C_case<span class="main">⋅</span><span class="free">f</span><span class="main">)</span>|<span class="hidden">⇘</span><sub>C<span class="main">⋅</span><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> C_case<span class="main">⋅</span><span class="main">(</span><span class="free">f</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> C_restr_bot_demand<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"C<span class="main">⋅</span><span class="free">r</span> <span class="main">⊑</span> demand <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="main">(</span><span class="free">r</span> <span class="main">⊓</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⊑</span> C <span class="main">⋅</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_C<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">note</span></span> assms
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="main">(</span><span class="free">r</span> <span class="main">⊓</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">r</span> <span class="main">⊓</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> not_bot_demand <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span> <span class="main">⊑</span> <span class="free">r</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_refl meet_below1 below_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>below_antisym<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> demand <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span> <span class="main">=</span> <span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"demand <span class="free">f</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>C_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iterate_Suc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iterate_Suc<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="main">(</span><span class="free">r</span> <span class="main">⊓</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_bot_demand<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">⋅</span><span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Restricting maps of C-ranged functions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">env_C_restr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"C <span class="main">→</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">::</span>type <span class="main">⇒</span> <span class="main">(</span>C <span class="main">→</span> <span class="tfree">'a</span><span class="main">::</span>pcpo<span class="main">)</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="main">(</span>C <span class="main">→</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">env_C_restr</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> r f<span class="main">.</span>  cfun_comp<span class="main">⋅</span><span class="main">(</span>C_restr<span class="main">⋅</span><span class="bound">r</span><span class="main">)</span><span class="main">⋅</span><span class="bound">f</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">env_C_restr_syn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">::</span>type <span class="main">⇒</span> <span class="main">(</span>C <span class="main">→</span> <span class="tfree">'a</span><span class="main">::</span>pcpo<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> C <span class="main">⇒</span>  <span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="main">(</span>C <span class="main">→</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span> <span class="quoted">"_<span class="keyword1">|<span class="hidden">⇧</span><sup>∘</sup>⇘</span>_<span class="keyword1">⇙</span>"</span> <span class="main">[</span>111<span class="main">,</span>110<span class="main">]</span> 110<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">r</span></span></span></sub><span class="hidden">⇙</span> <span class="main">≡</span> env_C_restr<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> env_C_restr_upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="free">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> env_C_restr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> env_C_restr_lookup<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="free">ρ</span> <span class="free">v</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> env_C_restr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> env_C_restr_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊥</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> env_C_restr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> env_C_restr_restr_below<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_belowI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_C_restr_env_C_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="free">r'</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">v</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">r'</span> <span class="main">⊓</span> <span class="free">r</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> env_C_restr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> env_C_restr_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">⊑</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">g</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> env_C_restr_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> C_restr_cong<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ResourcedDenotational">
<div class="head">
<h1>Theory ResourcedDenotational</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ResourcedDenotational
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Abstract-Denotational-Props.html">Abstract-Denotational-Props</a>"</span> <span class="quoted">"<a href="CValue-Nominal.html">CValue-Nominal</a>"</span> <span class="quoted">"<a href="C-restr.html">C-restr</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> CEnv <span class="main">=</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> <span class="main">(</span>C <span class="main">→</span> CValue<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> semantic_domain
  <span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> f <span class="main">.</span> <span class="keyword1">Λ</span> r<span class="main">.</span> CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">⋅</span><span class="main">(</span><span class="bound">v</span><span class="main">)</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="bound">r</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> x y<span class="main">.</span> <span class="main">(</span><span class="keyword1">Λ</span> r<span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">r</span> <span class="keyword1">↓CFn</span> <span class="bound">y</span>|<span class="hidden">⇘</span><sub><span class="bound">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> b r<span class="main">.</span> CB<span class="main">⋅</span><span class="bound">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">Λ</span> scrut v1 v2 r<span class="main">.</span> CB_project<span class="main">⋅</span><span class="main">(</span><span class="bound">scrut</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">v1</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">v2</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"C_case"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">notation</span></span> ESem_syn <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒩⟦</span> _ <span class="keyword1">⟧⇘</span>_<span class="keyword1">⇙</span>"</span>  <span class="main">[</span>60<span class="main">,</span>60<span class="main">]</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> EvalHeapSem_syn  <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>𝒩</b>⟦</span> _ <span class="keyword1"><span class="hidden">❙</span><b>⟧</b>⇘</span>_<span class="keyword1">⇙</span>"</span>  <span class="main">[</span>0<span class="main">,</span>0<span class="main">]</span> 110<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> HSem_syn <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒩⦃</span>_<span class="keyword1">⦄</span>_"</span>  <span class="main">[</span>60<span class="main">,</span>60<span class="main">]</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> AHSem_bot <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒩⦃</span>_<span class="keyword1">⦄</span>"</span>  <span class="main">[</span>60<span class="main">]</span> 60<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Here we re-state the simplification rules, cleaned up by beta-reducing the locale parameters.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CESem_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="main">(</span>C<span class="main">⋅</span>r<span class="main">)</span><span class="main">.</span> CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="bound">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> App <span class="free">e</span> <span class="free">x</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>     <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="main">(</span>C<span class="main">⋅</span>r<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="bound">r</span> <span class="keyword1">↓CFn</span> <span class="free">ρ</span> <span class="free">x</span>|<span class="hidden">⇘</span><sub><span class="bound">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> Var <span class="free">x</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>       <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="main">(</span>C<span class="main">⋅</span>r<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">ρ</span>  <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> Bool <span class="free">b</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>      <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="main">(</span>C<span class="main">⋅</span>r<span class="main">)</span><span class="main">.</span> CB<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="main">(</span>C<span class="main">⋅</span>r<span class="main">)</span><span class="main">.</span> CB_project<span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> Let <span class="free">as</span> <span class="free">body</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="main">(</span>C <span class="main">⋅</span> r<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">body</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">as</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">⋅</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eta_cfun<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> CESem_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">σ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp_strong_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> CHSem_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⦃</span> <span class="free">Γ</span> <span class="main">⦄</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_heap lookup_HSem_other<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Sometimes we do not care much about the resource usage and just want a simpler formula.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CESem_simps_no_tick<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span> <span class="main">⊑</span> CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> App <span class="free">e</span> <span class="free">x</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span>    <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span> <span class="keyword1">↓CFn</span> <span class="free">ρ</span> <span class="free">x</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> Var <span class="free">x</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>         <span class="main">⊑</span> <span class="free">ρ</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="main">(</span><span class="free">scrut</span> <span class="main">?</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span> <span class="main">⊑</span> CB_project<span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> Let <span class="free">as</span> <span class="free">body</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span>   <span class="main">⊑</span>  <span class="keyword1">𝒩⟦</span><span class="free">body</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">as</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monofun_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_C<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monofun_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_C<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monofun_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_C<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monofun_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_C<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monofun_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> below_C<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> CELam_no_restr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span> <span class="main">⊑</span> CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span> <span class="main">⊑</span> CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CESem_simps_no_tick<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span> monofun_LAM below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> C_restr_below<span class="main"><span class="main">]</span></span> monofun_cfun_arg below_refl fun_upd_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CEApp_no_restr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> App <span class="free">e</span> <span class="free">x</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span>    <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span> <span class="keyword1">↓CFn</span> <span class="free">ρ</span> <span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> App <span class="free">e</span> <span class="free">x</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span>  <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span> <span class="keyword1">↓CFn</span> <span class="free">ρ</span> <span class="free">x</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CESem_simps_no_tick<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="free">x</span>|<span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="free">ρ</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_below<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="CorrectnessResourced">
<div class="head">
<h1>Theory CorrectnessResourced</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CorrectnessResourced
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="ResourcedDenotational.html">ResourcedDenotational</a> <a href="Launchbury.html">Launchbury</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> correctness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">L</span> <span class="main">∪</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⟦</span><span class="free">z</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="free">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">nominal_induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>reds.strong_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Lambda
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Application <span class="skolem">y</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">x</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">Θ</span> <span class="skolem">z</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Gamma_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Γ</span> <span class="main">⊆</span> domA <span class="skolem">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds_doesnt_forget<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Application.hyps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">hence</span></span> prem1<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> reds_pres_closed<span class="main">[</span><span class="operator">OF</span> Application.hyps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> prem1<span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> reds_doesnt_forget<span class="main">[</span><span class="operator">OF</span> Application.hyps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">e'</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> prem2<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> fun_belowD<span class="main">[</span><span class="operator">OF</span> Application.hyps<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem1<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ1 <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span>›</span></span> reds_avoids_live<span class="main">[</span><span class="operator">OF</span> Application.hyps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> App <span class="skolem">e</span> <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="keyword1">↓CFn</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CEApp_no_restr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Application.hyps<span class="main">(</span>9<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prem1<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span>›</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">⊑</span> <span class="main">(</span>CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">(</span><span class="skolem">y</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CELam_no_restr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">(</span><span class="skolem">y</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">↓CFn</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">(</span><span class="skolem">y</span> <span class="main">:=</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e'</span><span class="main">[</span><span class="skolem">y</span> <span class="main">::=</span> <span class="skolem">x</span><span class="main">]</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ESem_subst<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="keyword1">𝒩⟦</span> <span class="skolem">z</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Θ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Application.hyps<span class="main">(</span>12<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prem2<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> App <span class="skolem">e</span> <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">z</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Θ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main">)</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="skolem">Γ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Θ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span>  <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Application.hyps<span class="main">(</span>10<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prem1<span class="main">]</span>
          env_restr_below_subset<span class="main">[</span><span class="operator">OF</span> Gamma_subset Application.hyps<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem2<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Variable <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domA_from_set map_of_SomeD<span class="main">)</span>

  <span class="keyword3"><span class="command">case</span></span> 2

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds_avoids_live<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Variable.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">⊆</span> domA <span class="skolem">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds_doesnt_forget<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Variable.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?new</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Δ</span> <span class="main">-</span> domA <span class="skolem">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">⊆</span> fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fv_delete_heap<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">e</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">L</span><span class="main">)</span> <span class="main">∪</span> domA <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">-</span> domA <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">-</span> <span class="var">?new</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reds_avoids_live'<span class="main">[</span><span class="operator">OF</span> Variable.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Γ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">-</span><span class="var">?new</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span> <span class="main">=</span> <span class="keyword1">𝒩⦃</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_reorder<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_of_delete_insert<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> Variable<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ρ</span> ++<span class="hidden">⇘</span><sub><span class="main">(</span>domA <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iterative_HSem<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ρ</span> ++<span class="hidden">⇘</span><sub><span class="main">(</span>domA <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iterative_HSem'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span><span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="var">?new</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">...</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="var">?new</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ssubst<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> below_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="skolem">Δ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="keyword1">𝒩⟦</span> <span class="skolem">z</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span> <span class="var">?new</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_fix_ind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="keyword1"><span class="keyword1">f|`</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">-</span></span> <span class="var"><span class="var">?new</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⊑</span></span> <span class="bound"><span class="bound">y</span></span> <span class="keyword1"><span class="keyword1">f|`</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">-</span></span> <span class="var"><span class="var">?new</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">σ</span> <span class="skolem">σ'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">σ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">σ'</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">σ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">σ'</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fv_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ESem_fresh_cong_below HSem_fresh_cong_below  env_restr_below_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 3<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> below_trans<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Variable<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem<span class="main"><span class="main">]</span></span><span class="main">]</span> below_trans<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Variable<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">σ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⟦</span> <span class="skolem">z</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">σ'</span></sub><span class="hidden">⇙</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">σ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">σ'</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="main">(</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> subset
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fun_belowI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_override_on_eq  lookup_env_restr_eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> env_restr_belowD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">ρ'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="skolem">Δ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="bound">ρ'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="keyword1">𝒩⟦</span> <span class="skolem">z</span> ⟧<span class="hidden">⇘</span><sub><span class="bound">ρ'</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span><span class="var">?new</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iterative_HSem'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Δ</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span>  <span class="keyword1">f|`</span> <span class="main">(</span><span class="main">-</span><span class="var">?new</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iterative_HSem<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Δ</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> le<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_below_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹domA <span class="skolem">Γ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">-</span><span class="var">?new</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> Var <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CESem_simps_no_tick<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fun_belowD<span class="main">[</span><span class="operator">OF</span> le<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">𝒩⟦</span> <span class="skolem">z</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_heap<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> Var <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⟦</span> <span class="skolem">z</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bool <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">Γ</span> <span class="skolem">scrut</span> <span class="skolem">L</span> <span class="skolem">Δ</span> <span class="skolem">b</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Θ</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Gamma_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="skolem">Γ</span> <span class="main">⊆</span> domA <span class="skolem">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds_doesnt_forget<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IfThenElse.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>

  <span class="keyword3"><span class="command">case</span></span> 1

  <span class="keyword1"><span class="command">hence</span></span> prem1<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Γ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prem2<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="var">?e</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span> domA <span class="skolem">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fv <span class="var">?e</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> set <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_free_vars_on_heap<span class="main">[</span><span class="operator">OF</span> IfThenElse.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Gamma_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">⊑</span> CB_project<span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CESem_simps_no_tick<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> CB_project<span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> Bool <span class="skolem">b</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun_fun monofun_cfun_arg  IfThenElse.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="var">?e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="var">?e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> monofun_cfun_fun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ESem_fresh_cong_below_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹fv <span class="var">?e</span> <span class="main">⊆</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> set <span class="skolem">L</span>›</span></span> Env.env_restr_belowI<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> set <span class="skolem">L</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> IfThenElse.hyps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prem1<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowD<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> domA <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span> <span class="main">∪</span> set <span class="skolem">L</span>›</span></span> reds_avoids_live<span class="main">[</span><span class="operator">OF</span> IfThenElse.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">z</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Θ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun_fun monofun_cfun_arg IfThenElse.hyps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">z</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Θ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="skolem">Γ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Θ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span>  <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IfThenElse.hyps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prem1<span class="main">]</span>
          env_restr_below_subset<span class="main">[</span><span class="operator">OF</span> Gamma_subset IfThenElse.hyps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem2<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> below_trans<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">Γ</span> <span class="skolem">L</span> <span class="skolem">body</span> <span class="skolem">Δ</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"domA <span class="skolem">as</span> <span class="main">∩</span> domA <span class="skolem">Γ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Let.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fresh_distinct<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">body</span><span class="main">)</span> <span class="main">-</span> domA <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> Let <span class="skolem">as</span> <span class="skolem">body</span><span class="main">)</span> <span class="main">-</span> domA <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">body</span><span class="main">)</span>  <span class="main">⊆</span> set <span class="skolem">L</span> <span class="main">∪</span>  domA <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">as</span> <span class="main">♯*</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Let<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_bn_to_atom_domA<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> Let <span class="skolem">as</span> <span class="skolem">body</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⟦</span> <span class="skolem">body</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CESem_simps_no_tick<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="keyword1">𝒩⟦</span> <span class="skolem">body</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HSem_merge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span>  <span class="keyword1">𝒩⟦</span> <span class="skolem">z</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">f|`</span> <span class="main">(</span>domA <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> env_restr_HSem<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_merge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_below_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Let.hyps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prem<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="skolem">Γ</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">corollary</span></span> correctness_empty_env<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">L</span></sub><span class="hidden">⇙</span> <span class="free">Δ</span> <span class="main">:</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⟦</span><span class="free">z</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Δ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span> <span class="main">⊑</span> <span class="keyword1">𝒩⦃</span><span class="free">Δ</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">L</span> <span class="main">∪</span>  domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> corr <span class="main">=</span> correctness<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> this<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊥</span></span>"</span></span></span><span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⟦</span> <span class="free">z</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Δ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> corr<span class="main">(</span>1<span class="main">)</span><span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> env_restr_useless<span class="main">[</span><span class="operator">OF</span> HSem_edom_subset<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ρ1 <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="free">Δ</span><span class="main">⦄</span><span class="main">)</span> <span class="keyword1">f|`</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> corr<span class="main">(</span>2<span class="main">)</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="keyword1">𝒩⦃</span><span class="free">Δ</span><span class="main">⦄</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_restr_below_itself<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span> <span class="main">⊑</span> <span class="keyword1">𝒩⦃</span><span class="free">Δ</span><span class="main">⦄</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ResourcedAdequacy">
<div class="head">
<h1>Theory ResourcedAdequacy</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ResourcedAdequacy
<span class="keyword2"><span class="keyword">imports</span></span> <a href="ResourcedDenotational.html">ResourcedDenotational</a> <a href="Launchbury.html">Launchbury</a> <span class="quoted">"<a href="AList-Utils.html">AList-Utils</a>"</span> <a href="CorrectnessResourced.html">CorrectnessResourced</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> demand_not_0<span class="main">:</span> <span class="quoted"><span class="quoted">"demand <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"demand <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> demand_suffices'<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The semantics of an expression, given only <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> resources, will only use values from the
environment with less resources.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> restr_can_restrict_env<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub>C<span class="main">⋅</span><span class="free">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub>C<span class="main">⋅</span><span class="free">r</span></sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_C_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">⊑</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> Var <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">⋅</span><span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ρ</span> <span class="skolem">x</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">⊑</span> <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">𝒩⟦</span> Var <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> Var <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> Var <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r'</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> C_restr_C_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">⊑</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_C below_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="skolem">r'</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="skolem">r'</span></sub><span class="hidden">⇙</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> C_restr_eq_lower<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Lam <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="skolem">r</span>›</span></span> <span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_C_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">⊑</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_C below_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> App<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> App <span class="skolem">e</span> <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> App <span class="skolem">e</span> <span class="skolem">x</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">⊑</span> <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bool <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">scrut</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_C_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">⊑</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_C below_trans<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IfThenElse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IfThenElse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IfThenElse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">⊑</span> <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">Γ</span> <span class="skolem">e</span><span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The lemma, lifted to heaps›</span></span>
  <span class="keyword1"><span class="command">have</span></span> restr_can_restrict_env_heap <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="bound">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="bound">r</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="bound">r</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> has_ESem.parallel_HSem_ind<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted">CEnv</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">r</span> <span class="main">::</span> <span class="quoted">C</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ<span class="hidden">⇩</span><sub>1</sub></span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="skolem">ρ<span class="hidden">⇩</span><sub>2</sub></span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span>"</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="skolem">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="keyword1"><span class="hidden">❙</span><b>𝒩</b>⟦</span> <span class="skolem">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ<span class="hidden">⇩</span><sub>1</sub></span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> ++<span class="hidden">⇘</span><sub>domA <span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="keyword1"><span class="hidden">❙</span><b>𝒩</b>⟦</span> <span class="skolem">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ<span class="hidden">⇩</span><sub>2</sub></span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> env_C_restr_cong<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">r'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">⊑</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_C below_trans<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="keyword1"><span class="hidden">❙</span><b>𝒩</b>⟦</span> <span class="skolem">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ<span class="hidden">⇩</span><sub>1</sub></span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="skolem">x</span><span class="main">⋅</span><span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> ++<span class="hidden">⇘</span><sub>domA <span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="keyword1"><span class="hidden">❙</span><b>𝒩</b>⟦</span> <span class="skolem">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ<span class="hidden">⇩</span><sub>2</sub></span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="skolem">x</span><span class="main">⋅</span><span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> the <span class="main">(</span>map_of <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ<span class="hidden">⇩</span><sub>1</sub></span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> the <span class="main">(</span>map_of <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ<span class="hidden">⇩</span><sub>1</sub></span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Let<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> True<span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="skolem">r</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> the <span class="main">(</span>map_of <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ<span class="hidden">⇩</span><sub>2</sub></span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ<span class="hidden">⇩</span><sub>1</sub></span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="skolem">ρ<span class="hidden">⇩</span><sub>2</sub></span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span>›</span></span><span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>   <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> the <span class="main">(</span>map_of <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ<span class="hidden">⇩</span><sub>2</sub></span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Let<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> True<span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="skolem">r</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookupEvalHeap<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">⊑</span> <span class="skolem">r</span>›</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_C_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">⊑</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> below_C below_trans<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="main">(</span><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> restr_can_restrict_env_heap<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> C_restr_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Let<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">⊑</span> C<span class="main">⋅</span><span class="skolem">r</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> Let <span class="skolem">Γ</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> Let <span class="skolem">Γ</span> <span class="skolem">e</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">⊑</span> <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> can_restrict_env<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="free">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> restr_can_restrict_env below_refl<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
When an expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> terminates, then we can remove such an expression from the heap and it
still terminates. This is the crucial trick to handle black-holing in the resourced semantics.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_BH<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r'</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r'</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"C<span class="main">⋅</span><span class="skolem">r</span> <span class="main">=</span> demand <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> demand_not_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"demand <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span>  assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"C<span class="main">⋅</span><span class="skolem">r</span> <span class="main">⊑</span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r not_bot_demand <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.sel<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff dom_map_of_conv_domA not_Some_eq<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ub</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ub</span> <span class="main">=</span> <span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span>"</span></span> <span class="comment1">― ‹An upper bound for the induction›</span>

  <span class="keyword1"><span class="command">have</span></span> heaps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⦃</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">⦄</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span> <span class="main">⊑</span> <span class="skolem">ub</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> HSem_bot_ind<span class="main">)</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⦃</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">⦄</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">⊑</span> <span class="skolem">ub</span>"</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>𝒩</b>⟦</span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⦃</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">⦄</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fun_belowI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>𝒩</b>⟦</span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">⦄</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>𝒩</b>⟦</span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookupEvalHeap<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ub</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span> <span class="main">⊑</span> <span class="skolem">ub</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun_arg<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="free">e</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> ub_def<span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span>  C_restr_bot_demand<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq_imp_below<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">⦄</span><span class="main">)</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True<span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="skolem">y</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="skolem">y</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span>|<span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_eq_lower<span class="main"><span class="main">[</span></span><span class="operator">OF</span> restr_can_restrict_env below_C<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="keyword1">𝒩⟦</span> the <span class="main">(</span>map_of <span class="free">Γ</span> <span class="skolem">y</span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_below<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⦃</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">⦄</span>›</span></span>
          <span class="keyword1"><span class="command">finally</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> domA <span class="free">Γ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="free">x</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookupEvalHeap lookup_HSem_heap<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span> <span class="main">⊑</span> <span class="skolem">ub</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>𝒩</b>⟦</span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>𝒩</b>⟦</span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ub</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cont2monofunE<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">ub</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ub_def HSem_bot_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">finally</span></span>     
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>𝒩</b>⟦</span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">ub</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> demand_suffices<span class="main"><span class="main">[</span></span><span class="operator">OF</span> infinite_resources_suffice<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span><span class="main">)</span>|<span class="hidden">⇧</span><sup>∘</sup><span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> can_restrict_env<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>C<span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun_arg monofun_cfun_fun heaps <span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span>delete <span class="free">x</span> <span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹C<span class="main">⋅</span><span class="skolem">r</span> <span class="main">⊑</span> <span class="free">r'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monofun_cfun_arg<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The semantics is continuous, so we can apply induction here:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> resourced_adequacy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="free">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Δ</span> <span class="bound">v</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="bound">Δ</span> <span class="main">:</span> <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> C.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> adm bot step<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> bot
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>exp_strong_exhaust<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">Γ</span></span><span class="main"><span class="main">,</span></span><span class="skolem"><span class="skolem">S</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> Var App Let Lam Bool IfThenElse<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>map_of <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> step.prems<span class="main">[</span><span class="operator">unfolded</span> Var<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ccontr <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_other<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="var">?e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> domA_map_of_Some_the<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> step.prems<span class="main">[</span><span class="operator">unfolded</span> Var<span class="main">]</span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="var">?e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> domA <span class="skolem">Γ</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="var">?e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_HSem_heap  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> app_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="var">?e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span>delete <span class="skolem">x</span> <span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_BH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="var">?e</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> step.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"delete <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="main">:</span> <span class="var">?e</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Δ</span> <span class="main">:</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span> <span class="main">#</span>  <span class="skolem">Δ</span> <span class="main">:</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Variable<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Var <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">e'</span> <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="skolem">S</span> <span class="main">∪</span> fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> finite_list<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">S'</span> <span class="main">=</span> set <span class="skolem">S</span> <span class="main">∪</span> fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>

    <span class="keyword1"><span class="command">from</span></span> step.prems<span class="main">[</span><span class="operator">unfolded</span> App<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e'</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="keyword1">↓CFn</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="main">)</span> <span class="skolem">x</span>|<span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> app_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="skolem">e'</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> step.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> lhs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> <span class="skolem">e'</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S'</span></sub><span class="hidden">⇙</span> <span class="skolem">Δ</span> <span class="main">:</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">S'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> correctness_empty_env<span class="main">[</span><span class="operator">OF</span> lhs' this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> correct1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span><span class="skolem">e'</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⟦</span><span class="skolem">v</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span> <span class="main">⊑</span> <span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> prem
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="keyword1">↓CFn</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="main">)</span> <span class="skolem">x</span>|<span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> not_bot_below_trans<span class="main">)</span><span class="main">(</span><span class="operator">intro</span> correct1 monofun_cfun_fun  monofun_cfun_arg<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> result_evaluated<span class="main">[</span><span class="operator">OF</span> lhs'<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isLam <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> isVal.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">e''</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> isLam_obtain_fresh<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> lhs'
    <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> <span class="skolem">e'</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S'</span></sub><span class="hidden">⇙</span> <span class="skolem">Δ</span> <span class="main">:</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="keyword1">↓CFn</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="main">)</span> <span class="skolem">x</span>|<span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="main">)</span> <span class="skolem">x</span>|<span class="hidden">⇘</span><sub><span class="skolem">r</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C_restr_below<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span> <span class="skolem">e''</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">⊑</span> CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> v<span class="main">.</span> <span class="keyword1">𝒩⟦</span><span class="skolem">e''</span>⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="main">)</span><span class="main">(</span><span class="skolem">y</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CELam_no_restr<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span> <span class="keyword1">↓CFn</span> <span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="skolem">e''</span>⟧<span class="hidden">⇘</span><sub><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="main">)</span><span class="main">(</span><span class="skolem">y</span> <span class="main">:=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="skolem">e''</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ESem_subst<span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">cont2cont</span></span> cont_fun<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Θ</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">:</span> <span class="skolem">e''</span><span class="main">[</span><span class="skolem">y</span><span class="main">::=</span><span class="skolem">x</span><span class="main">]</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S'</span></sub><span class="hidden">⇙</span> <span class="skolem">Θ</span> <span class="main">:</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> App <span class="skolem">e'</span> <span class="skolem">x</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S'</span></sub><span class="hidden">⇙</span> <span class="skolem">Θ</span> <span class="main">:</span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds_ApplicationI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lhs rhs<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> App <span class="skolem">e'</span> <span class="skolem">x</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Θ</span> <span class="main">:</span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> reds_smaller_L<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> S' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> App <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">v</span> <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">v</span><span class="main">].</span> <span class="skolem">e'</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Γ</span> <span class="main">:</span> <span class="keyword1">Lam</span> <span class="main">[</span><span class="skolem">v</span><span class="main">].</span> <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Lam <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bool <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> Bool <span class="skolem">b</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Γ</span> <span class="main">:</span> Bool <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Bool <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">scrut</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> step.prems<span class="main">[</span><span class="operator">unfolded</span> IfThenElse<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"CB_project<span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> app_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      is_CB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">=</span> CB<span class="main">⋅</span><span class="main">(</span>Discr <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> not_bot2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> CB_project_not_bot <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="skolem">S</span> <span class="main">∪</span> fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> finite_list<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">S'</span> <span class="main">=</span> set <span class="skolem">S</span> <span class="main">∪</span> fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>


    <span class="keyword1"><span class="command">from</span></span> is_CB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> step.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> lhs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> <span class="skolem">scrut</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S'</span></sub><span class="hidden">⇙</span> <span class="skolem">Δ</span> <span class="main">:</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isVal <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> result_evaluated<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">scrut</span><span class="main">)</span> <span class="main">⊆</span> set <span class="skolem">S'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> correctness_empty_env<span class="main">[</span><span class="operator">OF</span> lhs' this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> correct1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⟦</span><span class="skolem">scrut</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span> <span class="main">⊑</span> <span class="keyword1">𝒩⟦</span><span class="skolem">v</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> correct2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span> <span class="main">⊑</span> <span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> correct1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">⊑</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monofun_cfun_fun<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> is_CB
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">v</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">=</span> CB<span class="main">⋅</span><span class="main">(</span>Discr <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹isVal <span class="skolem">v</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Bool <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> isVal.cases<span class="main">)</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">r</span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">from</span></span> not_bot2 <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span> <span class="main">⊑</span> <span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> not_bot_below_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ monofun_cfun_fun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monofun_cfun_arg<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> step.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Θ</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">:</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S'</span></sub><span class="hidden">⇙</span> <span class="skolem">Θ</span> <span class="main">:</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">from</span></span> lhs'<span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">]</span> rhs
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S'</span></sub><span class="hidden">⇙</span> <span class="skolem">Θ</span> <span class="main">:</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> <span class="main">(</span><span class="skolem">scrut</span> <span class="main">?</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Θ</span> <span class="main">:</span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> reds_smaller_L<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> S' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> IfThenElse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">Δ</span> <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> step.prems<span class="main">[</span><span class="operator">unfolded</span> Let<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="skolem">e'</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span>  <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> app_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">`</span> domA <span class="skolem">Δ</span> <span class="main">♯*</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Let<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span><span class="main">⦄</span><span class="keyword1">𝒩⦃</span><span class="skolem">Γ</span><span class="main">⦄</span> <span class="main">=</span> <span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">⦄</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HSem_merge<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="skolem">e'</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">r</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Θ</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span> <span class="main">:</span> <span class="skolem">e'</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Θ</span> <span class="main">:</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">:</span> Let <span class="skolem">Δ</span> <span class="skolem">e'</span> ⇓<span class="hidden">⇘</span><sub><span class="skolem">S</span></sub><span class="hidden">⇙</span> <span class="skolem">Θ</span> <span class="main">:</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reds.Let<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Let<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Let <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ValueSimilarity">
<div class="head">
<h1>Theory ValueSimilarity</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ValueSimilarity
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Value.html">Value</a> <a href="CValue.html">CValue</a> <a href="Pointwise.html">Pointwise</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory formalizes Section 3 of \cite{functionspaces}. Their domain $D$ is our type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">Value</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
their domain $E$ is our type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">CValue</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and $A$ corresponds to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>C <span class="main"><span class="main">→</span></span> CValue<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

In our case, the construction of the domains was taken care of by the HOLCF package
(\cite{holcf}), so where \cite{functionspaces} refers to elements of the domain approximations
$D_n$ resp. $E_n$, these are just elements of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">Value</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> resp. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">CValue</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> here. Therefore the
\emph{n-injection} $\phi_n^E \colon E_n \to E$ is the identity here.

The projections correspond to the take-functions generated by the HOLCF package:
\begin{alignstar}
\psi_n^E &amp;\colon E \to E_n &amp;\text{ corresponds to }&amp;&amp;<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">CValue_take</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>::›</span></span></span></span>&amp;<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typeof</span></span> <span class="quoted"><span class="quoted">"CValue_take <span class="main"><span class="main">::</span></span> nat <span class="main"><span class="main">⇒</span></span> CValue <span class="main"><span class="main">→</span></span> CValue"</span></span> <span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
\psi_n^A &amp;\colon A \to A_n &amp;\text{ corresponds to }&amp;&amp;<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">C_to_CValue_take</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>::›</span></span></span></span>&amp;<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typeof</span></span> <span class="quoted"><span class="quoted">"C_to_CValue_take <span class="main"><span class="main">::</span></span> nat <span class="main"><span class="main">⇒</span></span> <span class="main"><span class="main">(</span></span>C <span class="main"><span class="main">→</span></span> CValue<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">→</span></span> <span class="main"><span class="main">(</span></span>C <span class="main"><span class="main">→</span></span> CValue<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
\psi_n^D &amp;\colon D \to D_n &amp;\text{ corresponds to }&amp;&amp;<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Value_take</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>::›</span></span></span></span>&amp;<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typeof</span></span> <span class="quoted"><span class="quoted">Value_take</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\end{alignstar}

The syntactic overloading of $e(a)(c)$ to mean either $\mathrm{ |mathsf{Ap}}_{E_n}^|bot$ or $\mathrm{ |mathsf{AP}}_{E}^|bot$
turns into our non-overloaded <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>_ ↓CFn _›</span></span></span></span><span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>::›</span></span></span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typeof</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(↓CFn)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
To have our presentation closer to \cite{functionspaces}, we introduce some notation:
›</span></span>

<span class="keyword1"><span class="command">notation</span></span> Value_take <span class="main">(</span><span class="quoted">"<span class="keyword1">ψ<span class="hidden">⇧</span><sup>D</sup>⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> C_to_CValue_take <span class="main">(</span><span class="quoted">"<span class="keyword1">ψ<span class="hidden">⇧</span><sup>A</sup>⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> CValue_take <span class="main">(</span><span class="quoted">"<span class="keyword1">ψ<span class="hidden">⇧</span><sup>E</sup>⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹A note about section 2.3›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Section 2.3 of  \cite{functionspaces} contains equations (2) and (3) which do not hold in general.
We demonstrate that fact here using our corresponding definition, but the counter-example carries
over to the original formulation. Lemma (2) is a generalisation of (3) to the resourced semantics,
so the counter-example for (3) is the simpler and more educating:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> counter_example<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">"Equation (3)"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">d</span> <span class="bound">d'</span><span class="main">.</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="bound">d</span> <span class="keyword1">↓Fn</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">=</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub>Suc <span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="bound">d</span> <span class="keyword1">↓Fn</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="bound">d'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Fn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> e<span class="main">.</span> <span class="main">(</span><span class="bound">e</span> <span class="keyword1">↓Fn</span> <span class="main">⊥</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">=</span> Fn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> <span class="main">_</span><span class="main">.</span> Fn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> <span class="main">_</span><span class="main">.</span> <span class="main">⊥</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> <span class="main">_</span><span class="main">.</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">d</span> <span class="keyword1">↓Fn</span> <span class="skolem">d'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def d'_def n_def cfun_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub>Suc <span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">d</span> <span class="keyword1">↓Fn</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">d'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"Equation (3)"</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def d'_def n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
For completeness, and to avoid making false assertions, the counter-example to equation (2):
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> counter_example2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">"Equation (2)"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">e</span> <span class="bound">a</span> <span class="bound">c</span><span class="main">.</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="bound">e</span> <span class="keyword1">↓CFn</span> <span class="bound">a</span><span class="main">)</span><span class="main">⋅</span><span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub>Suc <span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="bound">e</span> <span class="keyword1">↓CFn</span> ψ<span class="hidden">⇧</span><sup>A</sup><span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">⋅</span><span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> e r<span class="main">.</span> <span class="main">(</span><span class="bound">e</span><span class="main">⋅</span><span class="bound">r</span> <span class="keyword1">↓CFn</span> <span class="main">⊥</span><span class="main">)</span><span class="main">⋅</span><span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"C <span class="main">→</span> CValue"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="main">_</span> <span class="main">.</span> CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> <span class="main">_</span> <span class="main">_</span><span class="main">.</span> CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> <span class="main">_</span> <span class="main">_</span><span class="main">.</span> <span class="main">⊥</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted">C</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"CFn<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> <span class="main">_</span> <span class="main">_</span><span class="main">.</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="main">(</span><span class="skolem">e</span> <span class="keyword1">↓CFn</span> <span class="skolem">a</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_def a_def n_def cfun_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub>Suc <span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">e</span> <span class="keyword1">↓CFn</span> ψ<span class="hidden">⇧</span><sup>A</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"Equation (2)"</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_def a_def n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A suitable substitute for the lemma can be found in 4.3.5 (1) in \cite{fullabstraction},
which in our setting becomes the following (note the extra invocation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Value_take <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on
the left hand side):
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted">"Abramsky 4,3,5 (1)"</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="free">d</span> <span class="keyword1">↓Fn</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">d'</span><span class="main">)</span> <span class="main">=</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub>Suc <span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">d</span> <span class="keyword1">↓Fn</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">d'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Value.take_take<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The problematic equations are used in the proof of the only-if direction of proposition 9 in
\cite{functionspaces}. It can be fixed by applying take-induction, which inserts the
extra call to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Value_take <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the right spot.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Working with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">Value</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">CValue</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Combined case distinguishing and induction rules.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> value_CValue_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="main">|</span>
  <span class="free">f</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Fn<span class="main">⋅</span><span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="main">|</span>
  <span class="free">g</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> CFn<span class="main">⋅</span><span class="free">g</span>"</span></span> <span class="main">|</span>
  <span class="free">f</span> <span class="free">g</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Fn<span class="main">⋅</span><span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> CFn <span class="main">⋅</span> <span class="free">g</span>"</span></span> <span class="main">|</span>
  <span class="free">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> B<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="main">|</span>
  <span class="free">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">g</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> B<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> CFn<span class="main">⋅</span><span class="free">g</span>"</span></span> <span class="main">|</span>
  <span class="free">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> B<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> CB<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="free">f</span> <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Fn<span class="main">⋅</span><span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> CB<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> CB<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> CValue.exhaust Discr_undiscr Value.exhaust<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Value_CValue_take_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span>case_prod <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">x</span><span class="main">)</span> <span class="main">(</span>ψ<span class="hidden">⇧</span><sup>A</sup><span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="free">P</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">x</span><span class="main">,</span> ψ<span class="hidden">⇧</span><sup>A</sup><span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> admD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹adm <span class="main">(</span>case_prod <span class="free">P</span><span class="main">)</span>›</span></span> ch2ch_Pair<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ch2ch_Rep_cfunL<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Value.chain_take<span class="main"><span class="main">]</span></span> ch2ch_Rep_cfunL<span class="main"><span class="main">[</span></span><span class="operator">OF</span> C_to_CValue_chain_take<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_Pair<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ch2ch_Rep_cfunL<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Value.chain_take<span class="main"><span class="main"><span class="main">]</span></span></span> ch2ch_Rep_cfunL<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> C_to_CValue_chain_take<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
                  Value.reach C_to_CValue_reach<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Restricted similarity is defined recursively›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The base case›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">similar'_base</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> CValue <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  bot_similar'_base<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">similar'_base</span> <span class="main">⊥</span> <span class="main">⊥</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"similar'_base <span class="free">x</span> <span class="free">y</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The inductive case›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">similar'_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Value <span class="main">⇒</span> CValue <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> Value <span class="main">⇒</span> CValue <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">where</span></span>
  bot_similar'_step<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">similar'_step</span> <span class="free">s</span> <span class="main">⊥</span> <span class="main">⊥</span>"</span></span> <span class="main">|</span>
  bool_similar'_step<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">similar'_step</span> <span class="free">s</span> <span class="main">(</span>B<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>CB<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Fun_similar'_step<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">⋅</span><span class="bound">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">similar'_step</span> <span class="free">s</span> <span class="main">(</span>Fn<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>CFn<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"similar'_step <span class="free">s</span> <span class="free">x</span> <span class="main">⊥</span>"</span></span>
   <span class="quoted"><span class="quoted">"similar'_step <span class="free">s</span> <span class="main">⊥</span> <span class="free">y</span>"</span></span>
   <span class="quoted"><span class="quoted">"similar'_step <span class="free">s</span> <span class="main">(</span>B<span class="main">⋅</span><span class="free">f</span><span class="main">)</span> <span class="main">(</span>CB<span class="main">⋅</span><span class="free">g</span><span class="main">)</span>"</span></span>
   <span class="quoted"><span class="quoted">"similar'_step <span class="free">s</span> <span class="main">(</span>Fn<span class="main">⋅</span><span class="free">f</span><span class="main">)</span> <span class="main">(</span>CFn<span class="main">⋅</span><span class="free">g</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We now create the restricted similarity relation, by primitive recursion over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

This cannot be done using an inductive definition, as it would not be monotone.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">similar'</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">similar'</span> <span class="main">0</span> <span class="main">=</span> similar'_base"</span></span> <span class="main">|</span>
 <span class="quoted"><span class="quoted">"<span class="free">similar'</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> similar'_step <span class="main">(</span><span class="free">similar'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> similar'.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">similar'_syn</span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">◃▹⇘</span>_<span class="keyword1">⇙</span> _"</span> <span class="main">[</span>50<span class="main">,</span>50<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">similar'_syn</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> similar' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_botI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> similar'.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_FnI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span>  <span class="bound">x</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="bound">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⟹</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">x</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">g</span><span class="main">⋅</span><span class="bound">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fn<span class="main">⋅</span><span class="free">f</span> ◃▹<span class="hidden">⇘</span><sub>Suc <span class="free">n</span></sub><span class="hidden">⇙</span> CFn<span class="main">⋅</span><span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> similar'.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_FnE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Fn<span class="main">⋅</span><span class="free">f</span> ◃▹<span class="hidden">⇘</span><sub>Suc <span class="free">n</span></sub><span class="hidden">⇙</span> CFn<span class="main">⋅</span><span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span>  <span class="bound">x</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="bound">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⟹</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">x</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">g</span><span class="main">⋅</span><span class="bound">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> similar'.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bot_or_not_bot'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> similar'.simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> similar'_base.cases similar'_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_bot<span class="main">[</span><span class="operator">elim_format</span><span class="main">,</span> <span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⊥</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">y</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bot_or_not_bot'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_typed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> B<span class="main">⋅</span><span class="free">b</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> CFn<span class="main">⋅</span><span class="free">g</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> Fn<span class="main">⋅</span><span class="free">f</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> CB<span class="main">⋅</span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> similar'.simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> similar'_base.cases similar'_step.cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_bool<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"B<span class="main">⋅</span><span class="free">b<span class="hidden">⇩</span><sub>1</sub></span> ◃▹<span class="hidden">⇘</span><sub>Suc <span class="free">n</span></sub><span class="hidden">⇙</span> CB<span class="main">⋅</span><span class="free">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟷</span> <span class="free">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> similar'.simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> similar'_base.cases similar'_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Moving up and down the similarity relations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
These correspond to Lemma 7 in |cite{functionspaces}.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_down<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> ◃▹<span class="hidden">⇘</span><sub>Suc <span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">e</span> <span class="main">⟹</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">d</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> similar'_up<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">e</span> <span class="main">⟹</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">d</span> ◃▹<span class="hidden">⇘</span><sub>Suc <span class="free">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">with</span></span>  Suc
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>value_CValue_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">with</span></span> Suc
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>value_CValue_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A generalisation of the above, doing multiple steps at once.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_up_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">d</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">e</span> <span class="main">⟹</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">d</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">m</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dec_induct <span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> similar'_up <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Value.take_take CValue.take_take min_absorb2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_down_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">d</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">m</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="free">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">e</span> <span class="main">⟹</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">d</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inc_induct <span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> similar'_down <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Value.take_take CValue.take_take min_absorb1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">e</span> <span class="main">⟹</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">d</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> similar'_up<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> similar'_down<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Value.take_take CValue.take_take<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Admissibility›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A technical prerequisite for induction is admissibility of the predicate, i.e.\ that the predicate
holds for the limit of a chain, given that it holds for all elements.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_base_adm<span class="main">:</span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> similar'_base <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> admI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">Y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main">.</span> <span class="main">⊥</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust fst_eqD inst_prod_pcpo similar'_base.simps snd_eqD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_step_adm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> similar'_step <span class="free">s</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> admI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">Y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ch2ch_fst<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Value_chainE<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> bot
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> split_beta<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">⊥</span><span class="main">,</span> <span class="main">⊥</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>B <span class="skolem">n</span> <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> B<span class="main">⋅</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute not_add_less1<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>B<span class="main">⋅</span><span class="skolem">b</span><span class="main">,</span> CB<span class="main">⋅</span><span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">+</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> similar'_step.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv old.prod.exhaust snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"similar'_step <span class="free">s</span> <span class="main">(</span>fst <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_range_shift<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chain <span class="skolem">Y'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> Fn<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y'</span> <span class="main">(</span><span class="bound">m</span><span class="main">-</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> Y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Fn<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y'</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' not_add_less2<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> split_beta<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">g'</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> CFn<span class="main">⋅</span><span class="bound">g'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">+</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> similar'_step.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y''</span></span> <span class="keyword2"><span class="keyword">where</span></span> Y''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> CFn<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y''</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span> <span class="main">⊑</span> <span class="skolem">Y</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> po_class.chain_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⊑</span> <span class="skolem">Y</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="skolem">Y''</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> chainI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> CValue.inverts<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> Y''<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> snd_monofun<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> *<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"similar'_step <span class="free">s</span> <span class="main">(</span>Fn<span class="main">⋅</span><span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Y'</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CFn <span class="main">⋅</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y''</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Fun_similar'_step<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>2<span class="main">)</span> Y' Y''
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> similar'_step <span class="free">s</span> <span class="main">(</span>Fn<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y'</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CFn<span class="main">⋅</span><span class="main">(</span><span class="skolem">Y''</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">x</span> <span class="main">(</span><span class="skolem">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="skolem">Y'</span> <span class="bound">i</span><span class="main">⋅</span><span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Y''</span> <span class="bound">i</span><span class="main">⋅</span><span class="skolem">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="free">s</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="skolem">Y'</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">x</span><span class="main">,</span> <span class="main">(</span><span class="skolem">Y''</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> admD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> adm_case_prod<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span> <span class="main"><span class="main">.</span></span> <span class="free"><span class="free">s</span></span>"</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y'</span>›</span></span>  <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y''</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span><span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y'</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y''</span> <span class="bound">i</span><span class="main">)</span><span class="main">⋅</span><span class="skolem">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_Pair  ch2ch_Rep_cfunL contlub_cfun_fun  <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y'</span>›</span></span>  <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y''</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"similar'_step <span class="free">s</span> <span class="main">(</span>fst <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Y' Y''
          cont2contlubE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_fst chain_shift<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>  cont2contlubE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_snd chain_shift<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
           contlub_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y''</span>›</span></span><span class="main"><span class="main">]</span></span> contlub_cfun_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"similar'_step <span class="free">s</span> <span class="main">(</span>fst <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="main">⨆</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_range_shift<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹chain <span class="skolem">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> similar'_adm<span class="main">:</span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> snd <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> similar'.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> similar'_base_adm similar'_step_adm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> similar'_admI<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> cont <span class="free">g</span> <span class="main">⟹</span> adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> adm_subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ similar'_adm<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">f</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="free"><span class="free"><span class="free">g</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The real similarity relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This is the goal of the theory: A relation between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">Value</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">CValue</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">similar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> CValue <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">◃▹</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">◃▹</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> ◃▹<span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> similarI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">x</span> ◃▹<span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="bound">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">◃▹</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> similar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> similarE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">◃▹</span> <span class="free">y</span> <span class="main">⟹</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">x</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> similar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> similar_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">◃▹</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> similarI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> similar_bool<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"B<span class="main">⋅</span><span class="free">b</span> <span class="main">◃▹</span> CB<span class="main">⋅</span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> similarI<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
 
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">elim_format</span><span class="main">,</span> <span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">◃▹</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> similar_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">0</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">elim_format</span><span class="main">,</span> <span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">◃▹</span> CB<span class="main">⋅</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> B<span class="main">⋅</span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> similar_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main"><span class="main">0</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">elim_format</span><span class="main">,</span> <span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">◃▹</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> similar_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">0</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">elim_format</span><span class="main">,</span> <span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"B<span class="main">⋅</span><span class="free">b</span> <span class="main">◃▹</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> CB<span class="main">⋅</span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> similar_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main"><span class="main">0</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> take_similar'_similar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">x</span> <span class="main">◃▹</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> similarI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">x</span> ◃▹<span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> similar'_take<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="skolem">m</span> <span class="main">∨</span> <span class="skolem">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">x</span><span class="main">)</span> ◃▹<span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="free">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> similar'_up_le similar'_down_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> similar'_take
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_absorb2 min_absorb1 Value.take_take CValue.take_take<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bot_or_not_bot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">◃▹</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>value_CValue_cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bool_or_not_bool<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">◃▹</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> B<span class="main">⋅</span><span class="free">b</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">y</span> <span class="main">=</span> CB<span class="main">⋅</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>value_CValue_cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> slimilar_bot_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> bot bool Fn<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">◃▹</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="main">|</span>
  <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> B<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> CB<span class="main">⋅</span><span class="main">(</span>Discr <span class="free">b</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="free">f</span> <span class="free">g</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Fn<span class="main">⋅</span><span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> CFn <span class="main">⋅</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> CValue.exhaust Value.exhaust bool_or_not_bool bot_or_not_bot discr.exhaust<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> similar_adm<span class="main">:</span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">◃▹</span> snd <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> similar_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> adm_lemmas similar'_admI <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> similar_admI<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">f</span> <span class="main">⟹</span> cont <span class="free">g</span> <span class="main">⟹</span> adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">◃▹</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> adm_subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ similar_adm<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">f</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="free"><span class="free"><span class="free">g</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Having constructed the relation we can how show that it indeed is the desired relation,
relating $|bot$ with $|bot$ and functions with functions, if they take related arguments to related values.
This corresponds to Proposition 9 in |cite{functionspaces}.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> similar_nice_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">◃▹</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> B<span class="main">⋅</span><span class="main">(</span>Discr <span class="bound">b</span><span class="main">)</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> CB<span class="main">⋅</span><span class="main">(</span>Discr <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Fn<span class="main">⋅</span><span class="bound">f</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> CFn<span class="main">⋅</span><span class="bound">g</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">◃▹</span> <span class="bound">b</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⟶</span> <span class="bound">f</span><span class="main">⋅</span><span class="bound">a</span> <span class="main">◃▹</span> <span class="bound">g</span><span class="main">⋅</span><span class="bound">b</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>slimilar_bot_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> bot <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> bool <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fn <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?L</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> Fn<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">◃▹</span> <span class="bound">b</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⟶</span> <span class="skolem">f</span><span class="main">⋅</span><span class="bound">a</span> <span class="main">◃▹</span> <span class="skolem">g</span><span class="main">⋅</span><span class="bound">b</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> impI allI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">◃▹</span> <span class="skolem">b</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">⋅</span><span class="skolem">a</span> <span class="main">◃▹</span> <span class="skolem">g</span><span class="main">⋅</span><span class="skolem">b</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> similarI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">f</span><span class="main">⋅</span><span class="bound">b</span><span class="main">)</span> ◃▹<span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">g</span><span class="main">⋅</span><span class="bound">a</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> adm_case_prod similar'_admI <span class="dynamic"><span class="dynamic">cont2cont</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">f</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span> ◃▹<span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">g</span><span class="main">⋅</span><span class="skolem">b</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Value_CValue_take_induct<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹This take induction is required to avoid the wrong equation shown above.›</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>

          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">◃▹</span> <span class="skolem">b</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">a</span> ◃▹<span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">b</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> similarE<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">a</span> ◃▹<span class="hidden">⇘</span><sub>max <span class="skolem">m</span> <span class="skolem">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">b</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> similar'_up_le<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Fn<span class="main">⋅</span><span class="skolem">f</span> <span class="main">◃▹</span> CFn<span class="main">⋅</span><span class="skolem">g</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub>Suc <span class="main">(</span>max <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span>Fn<span class="main">⋅</span><span class="skolem">f</span><span class="main">)</span> ◃▹<span class="hidden">⇘</span><sub>Suc <span class="main">(</span>max <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub>Suc <span class="main">(</span>max <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span>CFn<span class="main">⋅</span><span class="skolem">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> similarE<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub>max <span class="skolem">m</span> <span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">f</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub>max <span class="skolem">m</span> <span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> ◃▹<span class="hidden">⇘</span><sub>max <span class="skolem">m</span> <span class="skolem">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub>max <span class="skolem">m</span> <span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">g</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>A</sup><span class="hidden">⇘</span><sub>max <span class="skolem">m</span> <span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>A</sup><span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">b</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">" ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub>max <span class="skolem">m</span> <span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">f</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> ◃▹<span class="hidden">⇘</span><sub>max <span class="skolem">m</span> <span class="skolem">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub>max <span class="skolem">m</span> <span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">g</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>A</sup><span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">b</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Value.take_take cfun_map_map CValue.take_take ID_def eta_cfun min_absorb2 min_absorb1<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">f</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> ◃▹<span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">g</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>A</sup><span class="hidden">⇘</span><sub><span class="skolem">m</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">b</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> similar'_down_le<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Fn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">elim</span> conjE disjE exE ssubst<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">◃▹</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"B<span class="main">⋅</span><span class="main">(</span>Discr <span class="skolem">b</span><span class="main">)</span> <span class="main">◃▹</span> CB<span class="main">⋅</span><span class="main">(</span>Discr <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span>
    <span class="keyword3"><span class="command">assume</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">◃▹</span> <span class="bound">b</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⟶</span> <span class="skolem">f</span><span class="main">⋅</span><span class="bound">a</span> <span class="main">◃▹</span> <span class="skolem">g</span><span class="main">⋅</span><span class="bound">b</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Fn<span class="main">⋅</span><span class="skolem">f</span> <span class="main">◃▹</span> CFn<span class="main">⋅</span><span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> similarI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span>Fn<span class="main">⋅</span><span class="skolem">f</span><span class="main">)</span> ◃▹<span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span>CFn<span class="main">⋅</span><span class="skolem">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> ◃▹<span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span> <span class="skolem">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">x</span> <span class="main">◃▹</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> take_similar'_similar<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">x</span><span class="main">)</span> <span class="main">◃▹</span> <span class="skolem">g</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>A</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">y</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> imp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">f</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>D</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">x</span><span class="main">)</span><span class="main">)</span> ◃▹<span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span> ψ<span class="hidden">⇧</span><sup>E</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="main">(</span><span class="skolem">g</span><span class="main">⋅</span><span class="main">(</span>ψ<span class="hidden">⇧</span><sup>A</sup><span class="hidden">⇘</span><sub><span class="skolem">n</span></sub><span class="hidden">⇙</span><span class="main">⋅</span><span class="skolem">y</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> similarE<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">with</span></span> Suc
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> similar_FnI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span>  <span class="bound">x</span> <span class="main">◃▹</span> <span class="bound">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⟹</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">x</span> <span class="main">◃▹</span> <span class="free">g</span><span class="main">⋅</span><span class="bound">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fn<span class="main">⋅</span><span class="free">f</span> <span class="main">◃▹</span> CFn<span class="main">⋅</span><span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms similar_nice_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> similar_FnD<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Fn<span class="main">⋅</span><span class="free">f</span> <span class="main">◃▹</span> CFn<span class="main">⋅</span><span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">◃▹</span> <span class="free">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="free">x</span> <span class="main">◃▹</span> <span class="free">g</span><span class="main">⋅</span><span class="free">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> similar_nice_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> similar_FnE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Fn<span class="main">⋅</span><span class="free">f</span> <span class="main">◃▹</span> CFn<span class="main">⋅</span><span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span>  <span class="bound">x</span> <span class="main">◃▹</span> <span class="bound">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⟹</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">x</span> <span class="main">◃▹</span> <span class="free">g</span><span class="main">⋅</span><span class="bound">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms similar_FnD<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The similarity relation lifted pointwise to functions.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fun_similar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>type <span class="main">⇒</span> Value<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span>C <span class="main">→</span> CValue<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">◃▹<span class="hidden">⇧</span><sup>*</sup></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fun_similar</span> <span class="main">≡</span> pointwise <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">◃▹</span> <span class="bound">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fun_similar_fmap_bottom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_similarE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">m'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">m</span>  <span class="bound">x</span><span class="main">)</span> <span class="main">◃▹</span> <span class="main">(</span><span class="free">m'</span> <span class="bound">x</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pointwise_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Denotational-Related">
<div class="head">
<h1>Theory Denotational-Related</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Denotational-Related"</span>
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Denotational.html">Denotational</a> <a href="ResourcedDenotational.html">ResourcedDenotational</a> <a href="ValueSimilarity.html">ValueSimilarity</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Given the similarity relation it is straight-forward to prove that the standard
and the resourced denotational semantics produce similar results. (Theorem 10 in
|cite{functionspaces}).
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> denotational_semantics_similar<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="free">ρ</span></sub><span class="hidden">⇙</span> <span class="main">◃▹</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="free">σ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>exp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Var <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="skolem">v</span> <span class="main">◃▹</span> <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">v</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">◃▹</span> <span class="skolem">y</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">σ</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">σ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 1 4<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="skolem">e</span>⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">◃▹</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="skolem">e</span>⟧<span class="hidden">⇘</span><sub><span class="skolem">σ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Lam.hyps<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">e</span> <span class="skolem">v</span> <span class="skolem">ρ</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> App'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="skolem">e</span>⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">◃▹</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="skolem">e</span>⟧<span class="hidden">⇘</span><sub><span class="skolem">σ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> slimilar_bot_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fn <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">σ</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="skolem">v</span> <span class="main">◃▹</span> <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Fn App' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bool <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Bool <span class="skolem">b</span>⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">◃▹</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span>Bool <span class="skolem">b</span>⟧<span class="hidden">⇘</span><sub><span class="skolem">σ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfThenElse <span class="skolem">scrut</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IfThenElse'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="skolem">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">◃▹</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">scrut</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">σ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">◃▹</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">σ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">◃▹</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">σ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> IfThenElse'<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> slimilar_bot_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>bool <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IfThenElse' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">as</span> <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">ρ</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">𝒩⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">σ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> parallel_HSem_ind_different_ESem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pointwise_adm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> similar_admI<span class="main"><span class="main">]</span></span> fun_similar_fmap_bottom<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ρ'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">σ'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> C <span class="main">→</span> CValue"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">σ'</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> ++<span class="hidden">⇘</span><sub>domA <span class="skolem">as</span></sub><span class="hidden">⇙</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span> <span class="skolem">as</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="skolem">ρ'</span></sub><span class="hidden">⇙</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">σ</span> ++<span class="hidden">⇘</span><sub>domA <span class="skolem">as</span></sub><span class="hidden">⇙</span> evalHeap <span class="skolem">as</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">𝒩⟦</span> <span class="bound">e</span> ⟧<span class="hidden">⇘</span><sub><span class="skolem">σ'</span></sub><span class="hidden">⇙</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> pointwiseI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ρ</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">σ</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_override_on_eq lookupEvalHeap <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> Let<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _  <span class="quoted"><span class="quoted">‹<span class="skolem">ρ'</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">σ'</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="skolem">e</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">ρ</span></sub><span class="hidden">⇙</span> <span class="main">◃▹</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="skolem">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="skolem">as</span><span class="main">⦄</span><span class="skolem">σ</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> evalHeap_similar<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">y</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">z</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>⟦</b></span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="bound">y</span></sub><span class="hidden">⇙</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1"><span class="hidden">❙</span><b>𝒩</b>⟦</span> <span class="free">Γ</span> <span class="hidden">❙</span><b>⟧</b><span class="hidden">⇘</span><sub><span class="bound">z</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pointwiseI<span class="main">)</span>
     <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> domA <span class="free">Γ</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookupEvalHeap denotational_semantics_similar<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> heaps_similar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parallel_HSem_ind_different_ESem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pointwise_adm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> similar_admI<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> evalHeap_similar<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Adequacy">
<div class="head">
<h1>Theory Adequacy</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Adequacy
<span class="keyword2"><span class="keyword">imports</span></span> <a href="ResourcedAdequacy.html">ResourcedAdequacy</a> <span class="quoted">"<a href="Denotational-Related.html">Denotational-Related</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> adequacy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Δ</span> <span class="bound">v</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">:</span> <span class="free">e</span> ⇓<span class="hidden">⇘</span><sub><span class="free">S</span></sub><span class="hidden">⇙</span> <span class="bound">Δ</span> <span class="main">:</span> <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span> <span class="main">◃▹<span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> heaps_similar<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="main">⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span> <span class="main">◃▹</span> <span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> denotational_semantics_similar<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> bot_or_not_bot<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝒩⟦</span><span class="free">e</span>⟧<span class="hidden">⇘</span><sub><span class="keyword1">𝒩⦃</span><span class="free">Γ</span><span class="main">⦄</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">⋅</span><span class="keyword1">C<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> resourced_adequacy<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="EverythingAdequacy">
<div class="head">
<h1>Theory EverythingAdequacy</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> EverythingAdequacy
<span class="keyword2"><span class="keyword">imports</span></span> <a href="CorrectnessOriginal.html">CorrectnessOriginal</a> <a href="Adequacy.html">Adequacy</a> <span class="quoted">"<a href="../../HOL/HOL-Library/LaTeXsugar.html">HOL-Library.LaTeXsugar</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*
notation (latex output) DenotationalUpd.ESem ("⟦_⟧<span class="hidden">⇗</span><sup>u</sup><span class="hidden">⇖</span><span class="hidden">⇘</span><sub>_</sub><span class="hidden">⇙</span>"  [60,60] 60)
notation (latex output) "Denotational-PropsUpd.HSem_syn" ("⦃_⦄<span class="hidden">⇗</span><sup>u</sup><span class="hidden">⇖</span>_"  [60,60] 60)
*)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="free">xs</span>"</span> <span class="main">&lt;=</span> <span class="quoted">"<span class="keyword1">CONST</span> set <span class="free">xs</span>"</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="free">a</span>"</span> <span class="main">&lt;=</span> <span class="quoted">"<span class="keyword1">CONST</span> atom <span class="free">a</span>"</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="free">a</span>"</span> <span class="main">&lt;=</span> <span class="quoted">"<span class="keyword1">CONST</span> image <span class="main">(</span><span class="keyword1">CONST</span> atom<span class="main">)</span> <span class="free">a</span>"</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">map_of_syntax</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>type <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>type <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">'(</span>_<span class="keyword1">,</span> _<span class="keyword1">')</span> <span class="keyword1">∈</span> _"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_of_syntax</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">≡</span> map_of <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">delete_syntax</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> var <span class="main">⇒</span> heap"</span></span> <span class="main">(</span><span class="quoted">"_\<span class="keyword1">\</span>_"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">delete_syntax</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> delete <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> domA <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‹\\textrm{\\textsf{dom}}›</span> _"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> bn <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‹\\textrm{\\textsf{dom}}›</span> _"</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">names_short</span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">show_question_marks</span> <span class="main"><span class="main">=</span></span> <span class="quasi_keyword">false</span><span class="main">]</span><span class="main">]</span>


<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main definitions and theorems›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
For your convenience, the main definitions and theorems of the present work are assembled in this section. The following 
formulas are mechanically pretty-printed versions of the statements as defined resp.\ proven in Isabelle.
Free variables are all-quantified. Some type conversion functions (like <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">set</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) are omitted.
The relations <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>♯›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>♯*›</span></span></span></span> come from the Nominal package and express freshness of the
variables on the left with regard to the expressions on the right.

\input{map.tex}
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Expressions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">var</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of variables is abstract and provided by the Nominal package. All we know about
it is that it is countably infinite.
Expressions of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">exp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are given by the following grammar:
\begin{alignatstar}{2}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \Coloneqq {}&amp; <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">Lam</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">].</span></span> <span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp;\quad&amp; \text{lambda abstraction}\\
\mid {} &amp; <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"App <span class="free"><span class="free">e</span></span> <span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp;&amp; \text{application}\\
\mid {} &amp; <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Var <span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp;&amp; \text{variable} \\
\mid {} &amp; <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Let <span class="free"><span class="free">as</span></span> <span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp;&amp; \text{recursive let}
\end{alignatstar}
In the introduction we pretty-print expressions to resemble the notation in \cite{launchbury} and omit
the constructor names <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Var</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">App</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Lam›</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Let</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In the actual theories, these are visible.
These expressions are, due to the machinery of the Nominal package, actually alpha-equivalency classes, so <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> alpha_test<span class="antiquote"><span class="antiquote">}</span></span></span></span> holds provably. This differs from Launchbury's original definition, which expects distinctly-named expressions and performs explicit alpha-renaming in the semantics.

The type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> heap<span class="antiquote"><span class="antiquote">}</span></span></span></span> is an abbreviation for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>var <span class="main"><span class="main">×</span></span> exp<span class="main"><span class="main">)</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. These are \emph{not} alpha-equivalency classes, i.e.\ we manage the bindings in heaps explicitly.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The natural semantics›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹
\newlength{\rulelen}
\setlength{\rulelen}{\linewidth}
\newlength{\rulenamelen}
\settowidth{\rulenamelen}{~{\sc Application}}
\addtolength{\rulelen}{-\rulenamelen}
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Launchbury's original semantics, extended with some technical overhead related to name binding (following \cite{sestoft}),
is defined as follows:\\
%\begin{center}
\parbox[t]{\rulelen}{\centering<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Axiom] Launchbury.reds.Lambda<span class="antiquote"><span class="antiquote">}</span></span></span></span>}~{\sc Lambda}\\[2ex]
\parbox[t]{\rulelen}{\centering<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] Launchbury.reds.Application<span class="antiquote"><span class="antiquote">}</span></span></span></span>}~{\sc Application}\\[2ex]
\parbox[t]{\rulelen}{\centering<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] Launchbury.reds.Variable<span class="antiquote"><span class="antiquote">}</span></span></span></span>}~{\sc Variable}\\[2ex]
\parbox[t]{\rulelen}{\centering<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] Launchbury.reds.Let<span class="antiquote"><span class="antiquote">}</span></span></span></span>}~{\sc Let}
%\end{center}
›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The denotational semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The value domain of the denotational semantics is the initial solution to
\[
D = [D \to D]_\bot
\]
as introduced in \cite{abramsky}. The type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">Value</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, together with the bottom value <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊥</span></span><span class="main"><span class="main">::</span></span>Value"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the
injection <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"Fn"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the projection <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"DUMMY <span class="keyword1"><span class="keyword1">↓Fn</span></span> DUMMY"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>::›</span></span></span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typeof</span></span> <span class="quoted"><span class="quoted">"Fn_project"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
is constructed as a pointed chain-complete partial order from this equation by the HOLCF package.
The type of semantic environments is  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"var <span class="main"><span class="main">⇒</span></span> Value"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The semantics of an expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span> <span class="main"><span class="main">::</span></span> exp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in an environment <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ρ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>::›</span></span></span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"var <span class="main"><span class="main">⇒</span></span> Value"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is 
written \mbox{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"Rep_cfun <span class="main"><span class="main">(</span></span>Denotational.ESem <span class="free"><span class="free">e</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">ρ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>} and defined by the following equations:
\begin{alignstar}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">lhs</span></span><span class="main"><span class="main">)</span></span> Denotational.ESem_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; = <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">rhs</span></span><span class="main"><span class="main">)</span></span> Denotational.ESem_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">lhs</span></span><span class="main"><span class="main">)</span></span> Denotational.ESem_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; = <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">rhs</span></span><span class="main"><span class="main">)</span></span> Denotational.ESem_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">lhs</span></span><span class="main"><span class="main">)</span></span> Denotational.ESem_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; = <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">rhs</span></span><span class="main"><span class="main">)</span></span> Denotational.ESem_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">lhs</span></span><span class="main"><span class="main">)</span></span> Denotational.ESem_simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; = <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">rhs</span></span><span class="main"><span class="main">)</span></span> Denotational.ESem_simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\end{alignstar}
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Denotational.EvalHeapSem_syn <span class="free"><span class="free">Γ</span></span> <span class="free"><span class="free">ρ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
maps the evaluation function over a heap, returning an environment:
\begin{alignstar}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">lhs</span></span><span class="main"><span class="main">)</span></span> lookupEvalHeap'<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">where</span></span> f <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">e</span></span><span class="main"><span class="main">.</span></span> Denotational.ESem_syn <span class="bound"><span class="bound">e</span></span> <span class="free"><span class="free">ρ</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  &amp; = <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">rhs</span></span><span class="main"><span class="main">)</span></span> lookupEvalHeap'<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">where</span></span> f <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">e</span></span><span class="main"><span class="main">.</span></span> Denotational.ESem_syn <span class="bound"><span class="bound">e</span></span> <span class="free"><span class="free">ρ</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  &amp;&amp; \text{if } <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">prem</span></span> 1<span class="main"><span class="main">)</span></span> lookupEvalHeap'<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">where</span></span> f <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">e</span></span><span class="main"><span class="main">.</span></span> Denotational.ESem_syn <span class="bound"><span class="bound">e</span></span> <span class="free"><span class="free">ρ</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">lhs</span></span><span class="main"><span class="main">)</span></span> lookupEvalHeap_other<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">where</span></span> f <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">e</span></span><span class="main"><span class="main">.</span></span> Denotational.ESem_syn <span class="bound"><span class="bound">e</span></span> <span class="free"><span class="free">ρ</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  &amp; = <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">rhs</span></span><span class="main"><span class="main">)</span></span> lookupEvalHeap_other<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">where</span></span> f <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">e</span></span><span class="main"><span class="main">.</span></span> Denotational.ESem_syn <span class="bound"><span class="bound">e</span></span> <span class="free"><span class="free">ρ</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  &amp;&amp; \text{if } <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">prem</span></span> 1<span class="main"><span class="main">)</span></span> lookupEvalHeap_other<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">where</span></span> f <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">e</span></span><span class="main"><span class="main">.</span></span> Denotational.ESem_syn <span class="bound"><span class="bound">e</span></span> <span class="free"><span class="free">ρ</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{alignstar}
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The semantics <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Rep_cfun <span class="main"><span class="main">(</span></span>Denotational.HSem <span class="free"><span class="free">Γ</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">ρ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>::›</span></span></span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"var <span class="main"><span class="main">⇒</span></span> Value"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of a
heap <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">::</span></span> heap"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>::›</span></span></span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">heap</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
in an environment <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ρ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>::›</span></span></span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"var <span class="main"><span class="main">⇒</span></span> Value"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is  defined by the recursive equation
\[ <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> "Denotational.HSem_eq"<span class="antiquote"><span class="antiquote">}</span></span></span></span> \]
where
\begin{alignstar}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">lhs</span></span><span class="main"><span class="main">)</span></span> override_on_apply_notin<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; = <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">rhs</span></span><span class="main"><span class="main">)</span></span> override_on_apply_notin<span class="antiquote"><span class="antiquote">}</span></span></span></span>  &amp;&amp; \text{if } <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">prem</span></span> 1<span class="main"><span class="main">)</span></span> override_on_apply_notin<span class="antiquote"><span class="antiquote">}</span></span></span></span> \\
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">lhs</span></span><span class="main"><span class="main">)</span></span> override_on_apply_in<span class="antiquote"><span class="antiquote">}</span></span></span></span> &amp; = <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">rhs</span></span><span class="main"><span class="main">)</span></span> override_on_apply_in<span class="antiquote"><span class="antiquote">}</span></span></span></span>  &amp;&amp; \text{if } <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">prem</span></span> 1<span class="main"><span class="main">)</span></span> override_on_apply_in<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\end{alignstar}

The semantics of the heap in the empty environment <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊥</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is abbreviated as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Denotational.AHSem_bot <span class="free"><span class="free">Γ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness and Adequacy›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The statement of correctness  reads:
If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">prem</span></span> 1<span class="main"><span class="main">)</span></span> CorrectnessOriginal.correctness<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and, as a side condition,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">prem</span></span> 2<span class="main"><span class="main">)</span></span> CorrectnessOriginal.correctness<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds,
then
\[
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">concl</span></span><span class="main"><span class="main">)</span></span> CorrectnessOriginal.correctness<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\]
›</span></span>
<span class="comment1">(*
\]
and
\[
@{thm (concl) CorrectnessOriginal.correctness(2)}.
\]
The latter is phrased slightly different than in \cite{launchbury}, which defines a partial relation
@{text "≤"} on heaps, by being more explictit on what set of variables the heaps agree.
*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The statement of adequacy reads:
\[
\text{If }
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">prem</span></span> 1<span class="main"><span class="main">)</span></span> adequacy<span class="antiquote"><span class="antiquote">}</span></span></span></span>\text{ then }<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">concl</span></span><span class="main"><span class="main">)</span></span> adequacy<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\]
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Differences to our previous work›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We have previously published \cite{breitner2013} of which the present work is a continuation. They differ in scope and focus:

\subsubsection{The treatment of $\sqcup$}

In \cite{breitner2013}, the question of the precise meaning of $\sqcup$ is discussed in detail. The
original paper is not clear about whether this operator denotes the least upper bound, or the
right-sided override operator. A lemma stated in \cite{launchbury} only holds if $\sqcup$ is the least upper bound,
but with that definition, Launchbury's Theorem 2 -- the generalized correctness theorem -- is false;
a counter-example is given in \cite{breitner2013}.

We came up with an alternative operational semantics that keeps more of the
evaluation context in the judgments and allows the correctness theorem to be proved inductively
without the problematic generalization. We proved the two operational semantics equivalent and thus
obtained the (non-generalized) correctness of Launchbury's semantics.

We also showed that if one takes $\sqcup$ to be the update operator, Theorem 2 holds and the proof
goes through as it is. Furthermore, we showed that the resulting denotational semantics are
identical for expressions, and can differ only for heaps. Therefore, the question of the precise
meaning of $\sqcup$ can be considered of little importance and for the present work we soley work
with right sided updates. We also avoid the ambiguos syntax $\sqcup$ and write
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"DUMMY ++<span class="hidden">⇘</span><sub>DUMMY</sub><span class="hidden">⇙</span> DUMMY"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> instead (the index indicates on what set the function on the right
overrides the function on the left). The alternative operational semantics is not included in this work.

\subsubsection{The types of environments}

Another difference is the choice of the type for environments, which map variables to semantics values.
A naive choice is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"var <span class="main"><span class="main">⇒</span></span> Value"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but this causes problems when defining the value semantics,
for which
\[
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> Denotational.ESem_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\]
is a defining equation. The argument on the left hand side is the representative of an equivalence class
(defined using the Nominal package), so this is only allowed if the right hand side is indeed independent
 of the actual choice of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>. This is shown most commonly and easily if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> is fresh in all the
other arguments (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"atom <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">♯</span></span> <span class="free"><span class="free">ρ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), and indeed the Nominal package allows us to specify this as a side
condition to the defining equation, which is what we did in \cite{breitner2013}.

But this convenience comes as a price: Such side-conditions are
only allowed if the argument has finite support (otherwise there might no variable fulfilling
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"atom <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">♯</span></span> <span class="free"><span class="free">ρ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). More precisely: The type of the argument must be a member of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> fs<span class="antiquote"><span class="antiquote">}</span></span></span></span> typeclass
provided by the Nominal package. The type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"var <span class="main"><span class="main">⇒</span></span> Value"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> cannot be made a member of this class,
as there obviously are elements that have infinite support. The fix here was to introduce a new type
 constructor, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fmap›</span></span></span></span>, for partial functions with finite domain. This is fine: Only functions
with finite domain matter in our formalisation.

The introduction of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fmap›</span></span></span></span> had further consequences. The main type class of the HOLCF package,
which we use to define domains and continuous functions on them, is the class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> cpo<span class="antiquote"><span class="antiquote">}</span></span></span></span>, of chain-complete
partial orders. With the usual ordering on partial functions, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(var, Value) fmap›</span></span></span></span> cannot be
a member of this class. The fix here is to use a different ordering and only let elements be compareable
that have the same domain. In our formalisation, the domain is alway known (e.g.\ all variables
bound on some heap), so this worked out.

But not without causing yet another issue: With this ordering, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(var, Value) fmap›</span></span></span></span> is a
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> cpo<span class="antiquote"><span class="antiquote">}</span></span></span></span>, but lacks a bottom element, i.e.\ now it is no <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> pcpo<span class="antiquote"><span class="antiquote">}</span></span></span></span>, and HOLCF's built-in operator
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">μ</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">f</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for expressing least fixed-points, as they occur in the semantics of heaps,
is not available. Furthermore, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊔›</span></span></span></span> is not a total function, i.e.\ defined only on a subset of
all possible arguments. The solution was a rather convoluted set of theories that formalize functions that
are continuous on a specific set, fixed-points on such sets etc.

In the present work, this problems is solved in a much more elegant way. Using a small trick we defined
the semantics functions so that
\[
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> Denotational.ESem_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\]
holds unconditionally. The actual, technical definition is
\[
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> Denotational.ESem_simps_as_defined<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\]
where the right-hand-side can be shown to be invariant of the choice of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>, as
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">∉</span></span> fv <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">Lam</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">].</span></span> <span class="free"><span class="free">e</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Once the function is defined, the equality
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> Denotational.ESem_considers_fv'<span class="antiquote"><span class="antiquote">}</span></span></span></span> can be proved. With that, the desired equation for
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">lhs</span></span><span class="main"><span class="main">)</span></span> Denotational.ESem_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> follows. The same trick is applied to the equation for
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">lhs</span></span><span class="main"><span class="main">)</span></span> Denotational.ESem_simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

This allows us to use the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"var <span class="main"><span class="main">⇒</span></span> Value"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the semantic envionments and considerably
simplifies the formalization compared to \cite{breitner2013}.

\subsubsection{No type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> assn<span class="antiquote"><span class="antiquote">}</span></span></span></span>}

The nominal package provides means to define types that are alpha-equivalence classes, and we use that
to define our type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> exp<span class="antiquote"><span class="antiquote">}</span></span></span></span>, which contains a constructor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Let <span class="free"><span class="free">binds</span></span> <span class="free"><span class="free">expr</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The desired type
of the parameter for the binding is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>var <span class="main"><span class="main">×</span></span> exp<span class="main"><span class="main">)</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but the Nominal package does not support
such nested recursion, and requires a mutual recursive definition with a custom type (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> assn<span class="antiquote"><span class="antiquote">}</span></span></span></span>)
with constructors <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ANil</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ACons</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that is isomorphic to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>var <span class="main"><span class="main">×</span></span> exp<span class="main"><span class="main">)</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
In \cite{breitner2013}, this type and conversion functions from and to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>var <span class="main"><span class="main">×</span></span> exp<span class="main"><span class="main">)</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
cluttered the whole development. In the present work we improved this by defining the type with
a ``temporary'' constructor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">LetA</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Afterwards we define conversions functions and
the desired constructor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">Let</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and re-state all lemmas produced by the Nominal package
(such as type exhaustiveness, distinctiveness of constructors and the induction rules) with that
constructor. From that point on, the development is free of the crutch <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">assn</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

In short, the notable changes in this work over \cite{breitner2013} are:
\begin{itemize}
\item We consider <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊔›</span></span></span></span> to be a right-sided update and do discuss neither the problem with
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊔›</span></span></span></span> denoting the least uppper bound, nor possible solutions.
\item This, a simpler choice for the type of semantic environments and a better definition of the type for terms, considerably simplifies the
work.
\item Most importantly, this work contains a complete and formal proof of the adequacy of Launchbury's semantics.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\subsection{Related work}

Lidia Sánchez-Gil, Mercedes Hidalgo-Herrero and Yolanda Ortega-Mallén have worked on formal aspects
of Launchbury's semantics as well.

They identified a step in his adequacy proof
relating the standard and the resourced denotational semantics that is not as trivial as it seems at
first and worked out a detailed pen-and-paper proof \cite{functionspaces}, where they first 
construct a similarity relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"DUMMY <span class="main"><span class="main">◃▹</span></span> DUMMY"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> between the standard semantic domain
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> Value<span class="antiquote"><span class="antiquote">}</span></span></span></span>) and the resourced domain (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> CValue<span class="antiquote"><span class="antiquote">}</span></span></span></span>) and show that the denotation semantics yield
similar results (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> denotational_semantics_similar<span class="antiquote"><span class="antiquote">}</span></span></span></span>), which is one step in the adequacy proof.
We formalized this (Sections \ref{sec_ValueSimilarity} and \ref{sec_Denotational-Related}), identifying
and fixing a mistake in the paper (Lemma 2.3(3) does not hold; the problem can be fixed by applying
an extra round of take-induction in the proof of Proposition 9).

Currently, they are working on completing the adequacy proof as outlined by Launchbury, i.e.\ by going
via the alternative natural semantics given in \cite{launchbury}, which differs from the semantics
above in that the application rule works with an indirection on the heap instead of a substitution
and that the variable rule has no blackholing and no update. In \cite{indirections}, they relate
the original semantics with one where indirections have been introduced. The next step, modifying
the variable rule, is under development. Once that is done they can close the loop and have
completed Launchbury's work.

This work proves the adequacy as stated by Launchbury as well, but in contrast to his proof outline no
alternative operational semantics is introduced. The problems of indirection vs. substitution and
of blackholing is solved on the denotational side instead, which turned out to be much easier than
proving the various operational semantics to be equivalent.
›</span></span>

<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>