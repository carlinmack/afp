<div id="Bernoulli">
<div class="head">
<h1>Theory Bernoulli</h1>
</div>
<pre class="source"><span class="comment1">(*  
  File:       Bernoulli.thy
  Author:     Lukas Bulwahn &lt;lukas.bulwahn-at-gmail.com&gt; 
  Author:     Manuel Eberl &lt;eberlm@in.tum.de&gt; 
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Bernoulli numbers›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Bernoulli
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> power_numeral_reduce<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">^</span> numeral <span class="free">n</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> pred_numeral <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc power_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fact_diff_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> Suc <span class="free">m</span> <span class="main">⟹</span> fact <span class="main">(</span>Suc <span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="main">(</span>Suc <span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> fact <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fact_reduce<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_binomial_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field_char_0<span class="main">)</span> <span class="main">=</span> 
             of_nat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">/</span> of_nat <span class="main">(</span>Suc <span class="free">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_fact <span class="dynamic"><span class="dynamic">divide_simps</span></span> fact_diff_Suc of_nat_diff <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> integrals_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="free">g</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">has_real_derivative</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">g</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">g</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> assms DERIV_const_ratio_const<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>field<span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> Rats_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">ℚ</span><span class="main">)</span> <span class="main">⟹</span> sum <span class="free">f</span> <span class="free">A</span> <span class="main">∈</span> <span class="main">ℚ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bernoulli Numbers and Bernoulli Polynomials›</span></span>

<span class="keyword1"><span class="command">declare</span></span> sum.cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bernoulli</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bernoulli</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bernoulli</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="numeral">2</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">bernoulli</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">declare</span></span> bernoulli.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>
  
<span class="keyword1"><span class="command">lemmas</span></span> bernoulli_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> bernoulli.simps<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> bernoulli_Suc <span class="main">=</span> bernoulli.simps<span class="main">(</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> bernoulli_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli <span class="main">1</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> bernoulli_Suc_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_Suc<span class="main">)</span>

    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The ``normal'' Bernoulli numbers are the negative Bernoulli numbers $B_n^{-}$ we just defined
  (so called because $B_1^{-} = -\frac{1}{2}$). There is also another convention, the 
  positive Bernoulli numbers $B_n^{+}$, which differ from the negative ones only in that 
  $B_1^{+} = \frac{1}{2}$. Both conventions have their justification, since a number of theorems 
  are easier to state with one than the other.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bernoulli'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bernoulli'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="keyword1">else</span> bernoulli <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> bernoulli'_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli' <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli'_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> bernoulli'_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli' <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli_conv_bernoulli'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> bernoulli <span class="free">n</span> <span class="main">=</span> bernoulli' <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli'_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> bernoulli'_conv_bernoulli<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> bernoulli' <span class="free">n</span> <span class="main">=</span> bernoulli <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli'_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> bernoulli_conv_bernoulli'_if<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> bernoulli <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="keyword1">else</span> bernoulli' <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli_in_Rats<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">∈</span> <span class="main">ℚ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Rats_sum Rats_divide<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli'_in_Rats<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli' <span class="free">n</span> <span class="main">∈</span> <span class="main">ℚ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli'_def bernoulli_in_Rats<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bernpoly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> real_algebra_1"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bernpoly</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> of_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_real <span class="main">(</span>bernoulli <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> bernpoly_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bernpoly <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_real <span class="main">(</span>bernoulli <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bernpoly <span class="free">n</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> 
          of_real <span class="main">(</span>bernoulli <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bernpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">k</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">k</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_real <span class="main">(</span>bernoulli <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_symmetric <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bernpoly <span class="free">n</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli_Suc'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="main">(</span>real <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> real <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> real <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bernoulli.simps <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> real <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> 
               <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> real <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">k</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">k</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> real <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> binomial_symmetric<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Observations on Bernoulli Polynomials›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bernpoly_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bernpoly <span class="free">n</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span>of_real <span class="main">(</span>bernoulli <span class="free">n</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_algebra_1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bernpoly <span class="free">n</span> <span class="main">0</span> <span class="main">=</span> of_real <span class="main">(</span>bernoulli <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bernpoly_def bernoulli.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> of_nat <span class="main">(</span>Suc <span class="skolem">n'</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_real <span class="main">(</span>bernoulli <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">0</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">n'</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.neutral ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{..</span><span class="skolem">n'</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>Suc <span class="skolem">n'</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> of_real <span class="main">(</span>bernoulli <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">n'</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n'</span> <span class="main">-</span> <span class="skolem">k</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bernpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_bernpoly <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_algebra_1<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bernpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> isCont_bernpoly <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"isCont <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_algebra_1<span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bernpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> has_field_derivative_bernpoly<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>bernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> 
     <span class="main">(</span>of_nat <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> bernpoly <span class="free">n</span> <span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_field<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> of_nat <span class="main">(</span>Suc <span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> 
            of_real <span class="main">(</span>bernoulli <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="keyword1">has_field_derivative</span> <span class="var">?D</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> bernpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> DERIV_cong<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_intros</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D</span> <span class="main">=</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> bernpoly <span class="free">n</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bernpoly_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> sum.cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> of_nat_binomial_Suc<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc One_nat_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> has_field_derivative_bernpoly' <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span> <span class="main">=</span>
  DERIV_chain'<span class="main">[</span><span class="operator">OF</span> _ has_field_derivative_bernpoly<span class="main">]</span>    

<span class="keyword1"><span class="command">lemma</span></span> sum_binomial_times_bernoulli<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_Suc<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> add_2_eq_Suc'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> add_2_eq_Suc add_2_eq_Suc'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  
<span class="keyword1"><span class="command">lemma</span></span> sum_binomial_times_bernoulli'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="bound">k</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> real <span class="main">(</span>Suc <span class="skolem">m</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Suc lessThan_Suc_atMost <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_binomial_times_bernoulli<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  
<span class="keyword1"><span class="command">lemma</span></span> binomial_unroll<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_unroll<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli_unroll<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> bernoulli <span class="free">n</span> <span class="main">=</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> real <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_Suc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> bernoulli_unroll_all <span class="main">=</span> binomial_unroll bernoulli_unroll sum_unroll bernpoly_def

<span class="keyword1"><span class="command">lemma</span></span> bernpoly_1_1<span class="main">:</span> <span class="quoted"><span class="quoted">"bernpoly <span class="main">1</span> <span class="main">1</span> <span class="main">=</span> of_real <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> of_real <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bernpoly <span class="main">1</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> of_real <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_unroll_all<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_real <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> *  of_real_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sum of Powers with Bernoulli Polynomials›</span></span>

<span class="comment1">(* TODO: Generalisation not possible here because mean-value theorem 
   is only available for reals *)</span>
<span class="keyword1"><span class="command">lemma</span></span> diff_bernpoly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bernpoly <span class="free">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> bernpoly <span class="free">n</span> <span class="free">x</span> <span class="main">=</span> of_nat <span class="free">n</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bernpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bernpoly <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> bernpoly <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> of_real <span class="main">(</span>real <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bernpoly_0 <span class="keyword1"><span class="command">unfolding</span></span> bernpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">0</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> of_real_sum <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sum_binomial_times_bernoulli<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> const<span class="main">:</span> <span class="quoted"><span class="quoted">"bernpoly <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> bernpoly <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">…</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> hyps'<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> bernpoly <span class="skolem">n</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> 
                  of_nat <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> bernpoly <span class="skolem">n</span> <span class="skolem">x</span> <span class="main">=</span> 
                  of_nat <span class="skolem">n</span> <span class="main">*</span> of_nat <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span>
    <span class="keyword1"><span class="command">unfolding</span></span> right_diff_distrib<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Suc<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bernpoly <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> bernpoly <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">x</span> <span class="main">-</span> of_nat <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> 
           <span class="keyword1">has_field_derivative</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">insert</span> hyps'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> integrals_eq<span class="main">[</span><span class="operator">OF</span> const this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bernpoly_of_real<span class="main">:</span> <span class="quoted"><span class="quoted">"bernpoly <span class="free">n</span> <span class="main">(</span>of_real <span class="free">x</span><span class="main">)</span> <span class="main">=</span> of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernpoly_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> bernpoly_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bernpoly <span class="free">n</span> <span class="main">1</span> <span class="main">=</span> of_real <span class="main">(</span>bernoulli <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bernpoly <span class="free">n</span> <span class="main">1</span> <span class="main">=</span> bernoulli <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernpoly_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> diff_bernpoly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_0_left bernpoly_0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bernpoly <span class="free">n</span> <span class="main">(</span>of_real <span class="main">1</span><span class="main">)</span> <span class="main">=</span> of_real <span class="main">(</span>bernoulli <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> bernpoly_of_real<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> bernpoly_1'<span class="main">:</span> <span class="quoted"><span class="quoted">"bernpoly <span class="free">n</span> <span class="main">1</span> <span class="main">=</span> of_real <span class="main">(</span>bernoulli' <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bernpoly_1_1 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span> <span class="main"><span class="main">=</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernpoly_1 bernoulli'_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> sum_of_powers<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">(</span>real <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>bernpoly <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> bernpoly <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> diff_bernpoly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">m</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span>real <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> bernpoly <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>real <span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> bernpoly <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>real <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> bernpoly <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>real <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bernpoly <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>real <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> bernpoly <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> bernpoly <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum_diff<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> bernpoly <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>real <span class="bound">k</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_divide_imp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> sum_of_powers_nat_aux<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"real <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">/</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"real <span class="free">b'</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"real <span class="free">c'</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b'</span> <span class="keyword1">div</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False 
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">c'</span><span class="main">)</span> <span class="main">=</span> real <span class="free">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> of_nat_eq_iff<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> False assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Instances for Square And Cubic Numbers›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> sum_of_squares<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="bound">k</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">6</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> of_nat_sum of_nat_power sum_of_powers<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_unroll_all <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square power_numeral_reduce<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> sum_of_squares_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="bound">k</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">6</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_of_powers_nat_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sum_of_squares<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> sum_of_cubes<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="bound">k</span> <span class="main">^</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> of_nat_sum of_nat_power sum_of_powers<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_unroll_all <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square power_numeral_reduce<span class="main">)</span>
                       
<span class="keyword1"><span class="command">corollary</span></span> sum_of_cubes_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="bound">k</span> <span class="main">^</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="keyword1">div</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_of_powers_nat_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sum_of_cubes<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Periodic_Bernpoly">
<div class="head">
<h1>Theory Periodic_Bernpoly</h1>
</div>
<pre class="source"><span class="comment1">(*  
  File:        Periodic_Bernpoly.thy
  Author:      Manuel Eberl &lt;eberlm@in.tum.de&gt; 

  Definition of the periodic Bernoulli polynomials as required for the Euler-Maclaurin 
  summation formula and Stirling's formula for the lnGamma function.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Periodic Bernoulli polynomials›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Periodic_Bernpoly
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Bernoulli.html">Bernoulli</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Periodic_Fun.html">HOL-Library.Periodic_Fun</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given the $n$-th Bernoulli polynomial $B_n(x)$, one can define the periodic function 
  $P_n(x) = B_n(x - \lfloor x\rfloor)$, which shares many of the interesting properties of 
  the Bernoulli polynomials. In particular, all $P_n(x)$ with $n\neq 1$ are continuous and 
  if $n \geq 3$, they are continuously differentiable with $P_n'(x) = n P_{n-1}(x)$ just 
  like the Bernoully polynomials themselves.

  These functions occur e.\,g.\ in the Euler--MacLaurin summation formula and Stirling's
  approximation for the logarithmic Gamma function.
›</span></span>

<span class="comment1">(* TODO Move to distribution *)</span>
<span class="keyword1"><span class="command">lemma</span></span> frac_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"frac <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac_def<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> frac_eq_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> frac <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac_eq<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> periodic_continuous_onI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> periodic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">a</span><span class="main">+</span><span class="free">p</span><span class="main">}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"continuous_on UNIV <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> continuous_on_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword1"><span class="command">interpret</span></span> f<span class="main">:</span> periodic_fun_simple <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">rule</span> periodic<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">-</span><span class="free">p</span><span class="main">..</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> continuous_on_compose<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> cont<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f.periodic_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="main">{</span><span class="free">a</span><span class="main">-</span><span class="free">p</span><span class="main">..</span><span class="free">a</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">a</span><span class="main">+</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cont
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> continuous_on_closed_Un<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">-</span><span class="free">p</span><span class="main">..</span><span class="free">a</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">a</span><span class="main">+</span><span class="free">p</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">-</span><span class="free">p</span><span class="main">..</span><span class="free">a</span><span class="main">+</span><span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">-</span><span class="free">p</span><span class="main">..</span><span class="free">a</span><span class="main">+</span><span class="free">p</span><span class="main">}</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">-</span><span class="free">p</span><span class="main">&lt;..&lt;</span><span class="free">a</span><span class="main">+</span><span class="free">p</span><span class="main">}</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_subset<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">/</span> <span class="free">p</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">/</span> <span class="free">p</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">/</span> <span class="free">p</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">*</span> <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">-</span><span class="free">p</span><span class="main">&lt;..&lt;</span><span class="free">a</span> <span class="main">+</span> <span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> cont <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isCont <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> continuous_on_eq_continuous_at<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">─</span><span class="skolem">x</span><span class="main">+</span><span class="skolem">n</span><span class="main">*</span><span class="free">p</span><span class="main">→</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span><span class="main">+</span><span class="skolem">n</span><span class="main">*</span><span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isCont_def f.periodic_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">*</span><span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">─</span><span class="skolem">x</span><span class="main">→</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span><span class="main">+</span><span class="skolem">n</span><span class="main">*</span><span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> tendsto_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">─</span><span class="skolem">x</span><span class="main">→</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f.periodic_simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> has_field_derivative_at_within_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_field_derivative</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_field_derivative</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_field_derivative</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>sup <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_field_derivative_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_sup<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sup <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> at_within_union <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> has_field_derivative_iff <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> 
  
<span class="keyword1"><span class="command">lemma</span></span> has_field_derivative_cong_ev'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>nhds <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">g</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_field_derivative</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">has_field_derivative</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">y</span> <span class="keyword1">within</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_field_derivative</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="free">g</span> <span class="keyword1">has_field_derivative</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">y</span> <span class="keyword1">within</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_field_derivative_cong_ev<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventually_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> at_within_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">at</span> <span class="free">y</span> <span class="keyword1">within</span> <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">at</span> <span class="free">y</span> <span class="keyword1">within</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> at_within_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">interpretation</span></span> frac<span class="main">:</span> periodic_fun_simple' <span class="quoted">frac</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_frac_at_right_0<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>frac <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>floor_ceiling<span class="main">,</span>order_topology<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> frac <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eventually_at_rightI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac_eq eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"frac <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_ident_at<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Lim_transform_eventually<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_frac_at_left_1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>frac <span class="main">⤏</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>at_left <span class="main">(</span><span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>floor_ceiling<span class="main">,</span>order_topology<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> frac <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>at_left <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eventually_at_leftI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac_eq eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"frac <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>at_left <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_ident_at<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Lim_transform_eventually<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_frac <span class="main">[</span><span class="operator">THEN</span> continuous_on_subset<span class="main">,</span> <span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>floor_ceiling<span class="main">,</span>order_topology<span class="main">}</span><span class="main">..&lt;</span><span class="main">1</span><span class="main">}</span> frac"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> continuous_on_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"frac <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> isCont_frac <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>floor_ceiling<span class="main">,</span>order_topology<span class="main">,</span>t2_space<span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"isCont frac <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">}</span> frac"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_frac<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> continuous_on_eq_continuous_at<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  
  
<span class="keyword1"><span class="command">lemma</span></span> has_field_derivative_frac<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">∉</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span>frac <span class="keyword1">has_field_derivative</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">-</span> of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_floor_eq<span class="main">[</span><span class="operator">OF</span> filterlim_ident assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> DERIV_cong_ev refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventually_mono <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frac_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> has_field_derivative_frac' <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span> <span class="main">=</span> 
  DERIV_chain'<span class="main">[</span><span class="operator">OF</span> _ has_field_derivative_frac<span class="main">]</span>
    
<span class="keyword1"><span class="command">lemma</span></span> continuous_on_compose_fracI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont1<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"continuous_on UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>frac <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> periodic_continuous_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>frac <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> continuous_on_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>frac <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">f</span> <span class="main">(</span>frac <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"frac <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> x False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>nhds <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eventually_nhds_in_open<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frac <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_filter frac_eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventually_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>frac <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> cont1 x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">f</span> <span class="main">(</span>frac <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>frac <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">f</span> <span class="main">(</span>frac <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Lim_transform_eventually<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> cont1 <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">f</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">1</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim frac <span class="main">(</span><span class="keyword1">at</span> <span class="main">1</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">1</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> filterlim_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frac <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">1</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_filter frac_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filterlim_ident<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>frac <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">f</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">1</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_compose<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True cont2 frac_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">0</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>frac <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac.periodic_simps<span class="main">)</span>
<span class="comment1">(* END TODO *)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pbernpoly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pbernpoly</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> bernpoly <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>frac <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pbernpoly_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pbernpoly <span class="free">n</span> <span class="main">0</span> <span class="main">=</span> bernoulli <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> pbernpoly_eq_bernpoly<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> pbernpoly <span class="free">n</span> <span class="free">x</span> <span class="main">=</span> bernpoly <span class="free">n</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def frac_eq_id<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> pbernpoly<span class="main">:</span> periodic_fun_simple' <span class="quoted"><span class="quoted">"pbernpoly <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def frac.periodic_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_pbernpoly <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="main">(</span>pbernpoly <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pbernpoly_def bernpoly_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on UNIV <span class="main">(</span>pbernpoly <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pbernpoly_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_compose_fracI<span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> n<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernpoly_0 bernpoly_1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_subset<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_pbernpoly' <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> continuous_on_compose<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> continuous_on_pbernpoly<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> isCont_pbernpoly <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> isCont <span class="main">(</span>pbernpoly <span class="free">n</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> continuous_on_pbernpoly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous_on_eq_continuous_at<span class="main">)</span>   

<span class="keyword1"><span class="command">lemma</span></span> has_field_derivative_pbernpoly_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∉</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span>pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> pbernpoly <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pbernpoly_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> of_int <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> Ints_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> pbernpoly <span class="free">n</span> <span class="free">x</span><span class="main">)</span> 
          <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">&lt;..}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_field_derivative_at_within_union<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> of_int <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span>
                  real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> bernpoly <span class="free">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> of_int <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>at_left <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span>pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> 
                            real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> pbernpoly <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>at_left <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> has_field_derivative_cong_ev' refl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">y</span> <span class="keyword1">in</span> nhds <span class="free">x</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">&lt;..&lt;</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eventually_nhds_in_open<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> nhds <span class="free">x</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">x</span><span class="main">}</span> <span class="main">⟶</span> bernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> real_of_int <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> eventually_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">-</span><span class="main">1</span><span class="main">&lt;..&lt;</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frac <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">-</span> real_of_int <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> frac_unique_iff<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> real_of_int <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pbernpoly_def bernpoly_1<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="keyword1">has_real_derivative</span> 
                      real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> pbernpoly <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>at_left <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> of_int <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span>
                  real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> bernpoly <span class="free">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> of_int <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>at_right <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span>pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> 
                            real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> pbernpoly <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>at_right <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> has_field_derivative_cong_ev' refl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">y</span> <span class="keyword1">in</span> nhds <span class="free">x</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">&lt;..&lt;</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eventually_nhds_in_open<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> nhds <span class="free">x</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">&lt;..}</span> <span class="main">⟶</span> bernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> real_of_int <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span>
                pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> eventually_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">-</span><span class="main">1</span><span class="main">&lt;..&lt;</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frac <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">-</span> real_of_int <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> frac_unique_iff<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> real_of_int <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pbernpoly_def bernpoly_1<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="keyword1">has_real_derivative</span> 
                      real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> pbernpoly <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>at_right <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>    
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">&lt;..}</span> <span class="main">=</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="main">…</span> <span class="main">=</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> at_within_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> has_field_derivative_pbernpoly_Suc' <span class="main">=</span>
  DERIV_chain'<span class="main">[</span><span class="operator">OF</span> _ has_field_derivative_pbernpoly_Suc<span class="main">]</span>    

<span class="keyword1"><span class="command">lemma</span></span> bounded_pbernpoly<span class="main">:</span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span>pbernpoly <span class="free">n</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> norm <span class="main">(</span>bernpoly <span class="free">n</span> <span class="bound">y</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span>bernpoly <span class="free">n</span> <span class="bound">x</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> continuous_attains_sup<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> norm <span class="main">(</span>bernpoly <span class="free">n</span> <span class="bound">y</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span>bernpoly <span class="free">n</span> <span class="skolem">x</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>pbernpoly <span class="free">n</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span>bernpoly <span class="free">n</span> <span class="skolem">x</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">unfolding</span></span> pbernpoly_def <span class="keyword1"><span class="command">using</span></span> frac_lt_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> x<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Bernoulli_FPS">
<div class="head">
<h1>Theory Bernoulli_FPS</h1>
</div>
<pre class="source"><span class="comment1">(*  
  File:       Bernoulli_FPS.thy
  Author:     Manuel Eberl &lt;eberlm@in.tum.de&gt; 

  Connection of Bernoulli numbers to formal power series; proof B_n = 0 for odd n &gt; 1;
  Akiyama-Tanigawa algorithm.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Connection of Bernoulli numbers to formal power series›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Bernoulli_FPS
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="Bernoulli.html">Bernoulli</a> 
    <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Computational_Algebra.html">HOL-Computational_Algebra.Computational_Algebra</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Number_Theory.html">HOL-Number_Theory.Number_Theory</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Stirling.html">HOL-Library.Stirling</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">context</span></span> factorial_semiring
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> multiplicity_prime_prime<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> prime <span class="free">q</span> <span class="main">⟹</span> multiplicity <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_multiplicity_other<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_prod_dvdI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> prime <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">dvd</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prod <span class="free">f</span> <span class="free">A</span> <span class="keyword1">dvd</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod <span class="free">f</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms nz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod_zero_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> multiplicity_le_imp_dvd<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="main">(</span>prod <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> multiplicity <span class="skolem">p</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> prod <span class="free">f</span> <span class="free">A</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> prime_dvd_prod_iff<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="main">(</span>prod <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> multiplicity <span class="skolem">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> nz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_elem_multiplicity_prod_distrib<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="skolem">x</span>›</span></span> primes_dvd_imp_eq x 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Groups_Big.sum.mono_neutral_cong_right<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiplicity_prime_prime inj_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="main">(</span>prod <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> multiplicity <span class="skolem">p</span> <span class="free">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms nz <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> x <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="skolem">x</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> multiplicity_geI<span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_dvd_imp_multiplicity_0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="comment1">(* TODO: Move? *)</span>
<span class="keyword1"><span class="command">context</span></span> semiring_gcd
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_add_dvd_right1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">b</span> <span class="main">⟹</span> gcd <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> gcd <span class="free">a</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> dvdE<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd_add_mult mult.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_add_dvd_right2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">c</span> <span class="main">⟹</span> gcd <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> gcd <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gcd_add_dvd_right1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_add_dvd_left1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">b</span> <span class="main">⟹</span> gcd <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> gcd <span class="free">c</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gcd_add_dvd_right1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_add_dvd_left2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">c</span> <span class="main">⟹</span> gcd <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> gcd <span class="free">b</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gcd_add_dvd_right2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd.commute<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> ring_gcd
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_diff_dvd_right1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">b</span> <span class="main">⟹</span> gcd <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> gcd <span class="free">a</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gcd_add_dvd_right1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">c</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_diff_dvd_right2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">c</span> <span class="main">⟹</span> gcd <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> gcd <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gcd_add_dvd_right2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">c</span>"</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_diff_dvd_left1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">b</span> <span class="main">⟹</span> gcd <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> gcd <span class="free">c</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gcd_add_dvd_left1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">c</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_diff_dvd_left2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">c</span> <span class="main">⟹</span> gcd <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> gcd <span class="free">b</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gcd_add_dvd_left2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">c</span>"</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cong_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span>int <span class="free">a</span> <span class="main">=</span> int <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_int_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Rats_int_div_natE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field_char_0<span class="main">)</span> <span class="main">∈</span> <span class="main">ℚ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> of_int <span class="free">m</span> <span class="main">/</span> of_nat <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">m</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> of_rat <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Rats_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Rat.Fract <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ab <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"nat <span class="skolem"><span class="skolem"><span class="skolem">b</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_rat_rat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_in_Ints<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">ℤ</span><span class="main">)</span> <span class="main">⟹</span> sum <span class="free">f</span> <span class="free">A</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Ints_real_of_nat_divide<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">⟹</span> real <span class="free">a</span> <span class="main">/</span> real <span class="free">b</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> product_dvd_fact<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟶</span> <span class="free">a</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">dvd</span> fact <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_strict_left_mono mult_strict_right_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> ineqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">=</span> <span class="main">∏</span><span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">dvd</span> <span class="main">∏</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ineqs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_dvd_prod_subset<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fact_prod<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_strict_left_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∏</span><span class="main">{</span><span class="numeral">2</span><span class="main">*</span><span class="free">a</span><span class="main">,</span> <span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">dvd</span> <span class="main">∏</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_dvd_prod_subset<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fact_prod<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> composite_imp_factors_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="main">(</span><span class="free">m</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="bound">k</span><span class="main">.</span> <span class="free">m</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">*</span> <span class="bound">k</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>irreducible <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> prime_elem_iff_irreducible <span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">m</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> irreducible_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> a assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This lemma describes what the numerator and denominator of a finite subseries of the
  harmonic series are when it is written as a single fraction.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sum_inverses_conv_fraction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> field"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∏</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">/</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∏</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.remove<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="main">_</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> sum_distrib_right sum_distrib_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If all terms in the subseries are primes, this fraction is automatically on lowest terms.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sum_prime_inverses_fraction_coprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> primes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> prime <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∏</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> prod_coprime_right<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="main">∏</span><span class="bound">z</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> a_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.remove<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">…</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> gcd <span class="main">(</span><span class="main">∏</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gcd_add_dvd_left2 dvd_sum dvd_prodI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> x primes inj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="main">∏</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_coprime_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> primes_coprime <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="main">∏</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> coprime_iff_gcd_eq_1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(* END TODO *)</span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the following, we will prove the correctness of the 
  Akiyama--Tanigawa algorithm~\cite{kaneko2000}, which is a simple algorithm for computing 
  Bernoulli numbers that was discovered by Akiyama and Tanigawa~\cite{aki_tani1999} essentially 
  as a by-product of their studies of the Euler--Zagier multiple zeta function. The algorithm 
  is based on a number triangle (similar to Pascal's triangle) in which the Bernoulli numbers 
  are the leftmost diagonal.

  While the algorithm itself is quite simple, proving it correct is not entirely trivial.
  We will use generating functions and Stirling numbers, mostly following the presentation by
  Kaneko~\cite{kaneko2000}.
›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following operator is a variant of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">fps_XD</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> operator where the multiplication
  is not with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">fps_X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but with an arbitrary formal power series. It is not quite clear 
  if this operator has a less ad-hoc meaning than the fashion in which we use it; it is, 
  however, very useful for proving the relationship between Stirling numbers and Bernoulli
  numbers.
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fps_notation
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fps_XD'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fps_XD'</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> fps_deriv <span class="bound">b</span><span class="main">)</span>"</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_XD' <span class="free">a</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_XD'_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_XD' <span class="free">a</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_XD'_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_fps_const <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_XD' <span class="free">a</span> <span class="main">(</span>fps_const <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_XD'_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_fps_of_nat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_XD' <span class="free">a</span> <span class="main">(</span>of_nat <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_XD'_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_fps_of_int <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_XD' <span class="free">a</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_XD'_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_fps_numeral <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_XD' <span class="free">a</span> <span class="main">(</span>numeral <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_XD'_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_add <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_XD' <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 fps<span class="main">)</span> <span class="main">=</span> fps_XD' <span class="free">a</span> <span class="free">b</span> <span class="main">+</span> fps_XD' <span class="free">a</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_XD'_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_minus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_XD' <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 fps<span class="main">)</span> <span class="main">=</span> fps_XD' <span class="free">a</span> <span class="free">b</span> <span class="main">-</span> fps_XD' <span class="free">a</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_XD'_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"fps_XD' <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">*</span> <span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 fps<span class="main">)</span> <span class="main">=</span> fps_XD' <span class="free">a</span> <span class="free">b</span> <span class="main">*</span> <span class="free">c</span> <span class="main">+</span> <span class="free">b</span> <span class="main">*</span> fps_XD' <span class="free">a</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_XD'_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_power<span class="main">:</span> <span class="quoted"><span class="quoted">"fps_XD' <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">^</span> <span class="free">n</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> idom fps<span class="main">)</span> <span class="main">=</span> of_nat <span class="free">n</span> <span class="main">*</span> <span class="free">b</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> fps_XD' <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">*</span> fps_XD' <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="free">n</span> <span class="main">*</span> <span class="free">b</span> <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> fps_XD' <span class="free">a</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_XD'_prod <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">b</span> <span class="main">*</span> <span class="main">(</span>of_nat <span class="free">n</span> <span class="main">*</span> <span class="free">b</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> fps_XD' <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mult_cancel_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power_0_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  
<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_power_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"fps_XD' <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> idom fps<span class="main">)</span> <span class="main">=</span> of_nat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span> <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> fps_XD' <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fps_XD'_power<span class="main">)</span> <span class="operator">simp_all</span>
  
<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"fps_XD' <span class="free">a</span> <span class="main">(</span>sum <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fps_XD' <span class="main">(</span><span class="free">a</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 fps<span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_XD'_funpow_affine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="free">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real fps"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_deriv <span class="free">G</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">n</span> <span class="bound">i</span><span class="main">.</span> fps_const <span class="main">(</span>real <span class="main">(</span>Stirling <span class="bound">n</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_XD' <span class="free">G</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">H</span> <span class="main">=</span> 
           <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="free">S</span> <span class="free">n</span> <span class="bound">m</span> <span class="main">*</span> <span class="free">G</span> <span class="main">^</span> <span class="bound">m</span> <span class="main">*</span> <span class="main">(</span>fps_deriv <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">H</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">H</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">m</span> <span class="main">*</span> <span class="free">G</span> <span class="main">^</span> <span class="bound">m</span> <span class="main">*</span> <span class="main">(</span>fps_deriv <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">S</span> <span class="skolem">n</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">*</span>  <span class="free">G</span> <span class="main">^</span> Suc <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>fps_deriv <span class="main">^^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">+</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="free">S</span> <span class="skolem">n</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">G</span> <span class="main">^</span> Suc <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>fps_deriv <span class="main">^^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">…</span> <span class="main">+</span> <span class="var">?S2</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.atMost_Suc_shift<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib <span class="dynamic"><span class="dynamic">algebra_simps</span></span> fps_of_nat S_def
          fps_const_add <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fps_const_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fps_const_add fps_const_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">0</span> <span class="main">+</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">{..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.atMost_shift <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">+</span> <span class="var">?S2</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> fps_XD' <span class="free">G</span> <span class="main">(</span><span class="free">S</span> <span class="skolem">n</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">G</span> <span class="main">^</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span>fps_deriv <span class="main">^^</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum.distrib <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fps_XD'_prod fps_XD'_power
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fps_XD'_prod fps_XD'_power_Suc <span class="dynamic"><span class="dynamic">algebra_simps</span></span> of_nat_diff S_def fps_XD'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>fps_XD' <span class="free">G</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.IH fps_XD'_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generating function of Stirling numbers›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Stirling_n_0<span class="main">:</span> <span class="quoted"><span class="quoted">"Stirling <span class="free">n</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The generating function of Stirling numbers w.\,r.\,t.\ their first argument:
    \[\sum_{n=0}^\infty \genfrac{\{}{\}}{0pt}{}{n}{m} \frac{x^n}{n!} = \frac{(e^x - 1)^m}{m!}\]
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Stirling_fps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real fps"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Stirling_fps</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> fps_const <span class="main">(</span><span class="main">1</span> <span class="main">/</span> fact <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
  
<span class="keyword1"><span class="command">theorem</span></span> sum_Stirling_binomial<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Stirling <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> Stirling <span class="bound">i</span> <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>Stirling <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> Stirling <span class="bound">i</span> <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> Stirling <span class="bound">i</span> <span class="skolem">m</span> <span class="main">*</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            real <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> Stirling <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">*</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>Stirling <span class="main">0</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.atLeast0_atMost_Suc_shift<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> Stirling <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">*</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                 real <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span>
                 real <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum.distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="bound">i</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.shift_bounds_cl_Suc_ivl<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="bound">i</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span>  Stirling <span class="bound">i</span> <span class="skolem">m</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> real <span class="main">(</span>Stirling <span class="main">0</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost mult_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> Stirling <span class="bound">i</span> <span class="skolem">m</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span>Stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> 
                 real <span class="skolem">m</span> <span class="main">*</span> real <span class="main">(</span>Stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>Stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Suc.IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum.distrib 
                      sum_distrib_left sum_distrib_right<span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">+</span> <span class="main">(</span>real <span class="main">(</span>Stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> real <span class="main">(</span>Stirling <span class="main">0</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>Stirling <span class="main">0</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span>
                 real <span class="main">(</span>Suc <span class="skolem">m</span> <span class="main">*</span> Stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> Stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Stirling.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">m</span> <span class="main">*</span> Stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> Stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">=</span> 
                 Stirling <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Stirling.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> of_nat_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Stirling_fps_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">m</span> <span class="main">$</span> <span class="free">n</span> <span class="main">*</span> fact <span class="free">n</span> <span class="main">=</span> fact <span class="free">m</span> <span class="main">*</span> real <span class="main">(</span>Stirling <span class="free">n</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Stirling_n_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> real fps<span class="main">)</span> <span class="main">^</span> Suc <span class="skolem">m</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">*</span> fact <span class="skolem">n</span> <span class="main">=</span> 
              fps_deriv <span class="main">(</span><span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n'</span> <span class="main">*</span> fact <span class="skolem">n'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_deriv <span class="main">(</span><span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> real fps<span class="main">)</span> <span class="main">^</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> 
                 fps_const <span class="main">(</span>real <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">*</span> fps_exp <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fps_deriv_power<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">$</span> <span class="skolem">n'</span> <span class="main">*</span> fact <span class="skolem">n'</span> <span class="main">=</span> 
      real <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">/</span> fact <span class="main">(</span><span class="skolem">n'</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> fact <span class="skolem">n'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fps_mult_left_const_nth
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_mult_nth Suc.IH sum_distrib_right <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> real fps<span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">/</span> fact <span class="main">(</span><span class="skolem">n'</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> fact <span class="skolem">n'</span> <span class="main">=</span> 
                 <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> fact <span class="skolem">n'</span> <span class="main">/</span> fact <span class="main">(</span><span class="skolem">n'</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> fact <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">n'</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_fact<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n'</span><span class="main">.</span> fact <span class="skolem">m</span> <span class="main">*</span> real <span class="main">(</span>Stirling <span class="bound">i</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">n'</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Suc.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> fact <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> 
                 <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n'</span><span class="main">.</span> real <span class="main">(</span>Stirling <span class="bound">i</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">n'</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">*</span> <span class="var">?S</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left sum_distrib_right mult_ac <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> Stirling <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_Stirling_binomial<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Stirling_fps_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"Stirling_fps <span class="free">m</span> <span class="main">$</span> <span class="free">n</span> <span class="main">=</span> Stirling <span class="free">n</span> <span class="free">m</span> <span class="main">/</span> fact <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Stirling_fps_def <span class="keyword1"><span class="command">using</span></span> Stirling_fps_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    
<span class="keyword1"><span class="command">theorem</span></span> Stirling_fps_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"Stirling_fps <span class="free">m</span> <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> Stirling <span class="bound">n</span> <span class="free">m</span> <span class="main">/</span> fact <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_eq_iff Stirling_fps_nth<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> Stirling_closed_form<span class="main">:</span>
  <span class="quoted"><span class="quoted">"real <span class="main">(</span>Stirling <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="free">k</span> <span class="keyword1">choose</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> real <span class="bound">j</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> real fps<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">^</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> of_nat <span class="main">(</span><span class="free">k</span> <span class="keyword1">choose</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> fps_exp <span class="main">1</span> <span class="main">^</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> binomial_ring <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> fps_const <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="free">k</span> <span class="keyword1">choose</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> fps_exp <span class="main">(</span>real <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_const_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fps_const_power <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> 
                  fps_const_neg <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mult_ac fps_of_nat fps_exp_power_mult
             <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fps_const_mult fps_const_power fps_const_neg<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">$</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="free">k</span> <span class="keyword1">choose</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> real <span class="bound">j</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_sum_nth sum_divide_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> fact <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="free">k</span> <span class="keyword1">choose</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> real <span class="bound">j</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> Stirling_fps_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeast0AtMost <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generating function of Bernoulli numbers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We will show that the negative and positive Bernoulli numbers are the coefficients of the
  exponential generating function $\frac{x}{e^x - 1}$ (resp. $\frac{x}{1-e^{-x}}$), i.\,e.
    \[\sum_{n=0}^\infty B_n^{-} \frac{x^n}{n!} = \frac{x}{e^x - 1}\]
    \[\sum_{n=0}^\infty B_n^{+} \frac{x^n}{n!} = \frac{x}{1 - e^{-1}}\]
›</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bernoulli_fps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> real_normed_field fps"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bernoulli_fps</span> <span class="main">=</span> fps_X <span class="main">/</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bernoulli'_fps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> real_normed_field fps"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bernoulli'_fps</span> <span class="main">=</span> fps_X <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>fps_exp <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli_fps_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli_fps <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bernoulli_fps_aux<span class="main">:</span>    <span class="quoted"><span class="quoted">"bernoulli_fps <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_field fps<span class="main">)</span> <span class="main">=</span> fps_X"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> fps_X"</span></span>  
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fps_ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> 
            <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> fact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fps_mult_nth <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>fact <span class="bound">i</span> <span class="main">*</span> fact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
                                    <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> of_real <span class="main">(</span>bernoulli <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>fact <span class="bound">i</span> <span class="main">*</span> fact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
                      of_real <span class="main">(</span>bernoulli <span class="skolem">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="skolem">n</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> sum_subtractf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.delta'<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>fact <span class="bound">i</span> <span class="main">*</span> fact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeast0AtMost lessThan_Suc_atMost <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> fact <span class="skolem">n</span> <span class="main">*</span> <span class="main">(</span>of_real <span class="main">(</span>bernoulli <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>fact <span class="bound">i</span> <span class="main">*</span> fact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> fact <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_left <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> fact <span class="skolem">n</span> <span class="main">*</span> <span class="main">(</span>of_real <span class="main">(</span>bernoulli <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>fact <span class="bound">i</span> <span class="main">*</span> fact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> of_real <span class="main">(</span>bernoulli <span class="bound">i</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_fact<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_real <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> fact <span class="skolem">n</span> <span class="main">=</span> fps_X <span class="main">$</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_binomial_times_bernoulli'<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> 
                     fps_X <span class="main">$</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bernoulli_fps <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bernoulli_fps_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> * <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bernoulli_fps <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span> fps<span class="main">)</span> <span class="main">=</span> fps_X"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">theorem</span></span> fps_nth_bernoulli_fps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fps_nth bernoulli_fps <span class="free">n</span> <span class="main">=</span> of_real <span class="main">(</span>bernoulli <span class="free">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_fps_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli'_fps_aux<span class="main">:</span>  
    <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli' <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> fps_exp <span class="main">1</span> <span class="main">*</span> fps_X"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bernoulli'_fps_aux'<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_exp <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli' <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> fps_X"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bernoulli'_fps_altdef<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"bernoulli'_fps <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli' <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_field<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli' <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> bernoulli_fps <span class="main">+</span> fps_X"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_eq_iff bernoulli'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> fps_exp <span class="main">1</span> <span class="main">*</span> fps_X"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bernoulli_fps_aux <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli' <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> 
                  fps_exp <span class="main">1</span> <span class="main">*</span> fps_X"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> fps_exp <span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_exp <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> fps_exp_add_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> mult.assoc
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_exp <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli' <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> fps_X"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mult_left_cancel<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bernoulli'_fps <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span>bernoulli' <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bernoulli'_fps_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> * <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> fps_nth_bernoulli'_fps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fps_nth bernoulli'_fps <span class="free">n</span> <span class="main">=</span> of_real <span class="main">(</span>bernoulli' <span class="free">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli'_fps_altdef<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> bernoulli_fps_conv_bernoulli'_fps<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli_fps <span class="main">=</span> bernoulli'_fps <span class="main">-</span> fps_X"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_eq_iff bernoulli'_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> bernoulli'_fps_conv_bernoulli_fps<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli'_fps <span class="main">=</span> bernoulli_fps <span class="main">+</span> fps_X"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_eq_iff bernoulli'_def<span class="main">)</span>

 
<span class="keyword1"><span class="command">theorem</span></span> bernoulli_odd_eq_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bernoulli_fps_aux <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> bernoulli_fps <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> fps_X"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> bernoulli_fps <span class="main">+</span> fps_X<span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> fps_X <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> fps_exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> fps_exp <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> fps_exp_add_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_exp <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> fps_exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> fps_exp <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> fps_exp_add_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> bernoulli_fps <span class="main">+</span> fps_X<span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> fps_exp <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                   fps_exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_X <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> fps_exp <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> bernoulli_fps <span class="main">+</span> fps_X<span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> fps_exp <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
              fps_X <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> fps_exp <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mult_cancel_left<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_compose <span class="var">?lhs</span> <span class="main">(</span><span class="main">-</span>fps_X<span class="main">)</span> <span class="main">=</span> fps_compose <span class="var">?rhs</span> <span class="main">(</span><span class="main">-</span>fps_X<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_compose <span class="var">?lhs</span> <span class="main">(</span><span class="main">-</span>fps_X<span class="main">)</span> <span class="main">=</span> 
               <span class="main">(</span><span class="main">-</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>bernoulli_fps <span class="keyword1">oo</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">+</span> fps_X<span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> fps_exp <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_compose_mult_distrib fps_compose_add_distrib
                   fps_compose_sub_distrib <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_compose <span class="var">?rhs</span> <span class="main">(</span><span class="main">-</span>fps_X<span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_compose_mult_distrib fps_compose_add_distrib fps_compose_sub_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> bernoulli_fps <span class="main">+</span> fps_X<span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> fps_exp <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
               <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="numeral">2</span> <span class="main">*</span> bernoulli_fps <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> fps_exp <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>bernoulli_fps <span class="keyword1">oo</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>bernoulli_fps <span class="main">+</span> fps_X <span class="main">::</span> real fps<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mult_cancel_right<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli_fps <span class="keyword1">oo</span> <span class="main">-</span>fps_X <span class="main">=</span> <span class="main">(</span>bernoulli_fps <span class="main">+</span> fps_X <span class="main">::</span> real fps<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mult_cancel_left<span class="main">)</span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bernoulli_fps <span class="keyword1">oo</span> <span class="main">-</span>fps_X<span class="main">)</span> <span class="main">$</span> <span class="free">n</span> <span class="main">=</span> bernoulli <span class="free">n</span> <span class="main">/</span> fact <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> **<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>fps_X <span class="main">=</span> fps_const <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">*</span> fps_X"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fps_const_neg <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fps_const_1_eq_1<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bernoulli_fps <span class="keyword1">oo</span> <span class="main">…</span><span class="main">)</span> <span class="main">$</span> <span class="free">n</span> <span class="main">=</span> <span class="main">-</span> bernoulli <span class="free">n</span> <span class="main">/</span> fact <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fps_compose_linear<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> bernoulli'_odd_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> odd <span class="free">n</span> <span class="main">⟹</span> bernoulli' <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli'_def bernoulli_odd_eq_0<span class="main">)</span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following simplification rule takes care of rewriting <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"bernoulli <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to $0$ for
  any odd numeric constant greater than $1$:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bernoulli_odd_numeral_eq_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span>numeral <span class="main">(</span>Num.Bit1 <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bernoulli_odd_eq_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ odd_numeral<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">lemma</span></span> bernoulli'_odd_numeral_eq_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli' <span class="main">(</span>numeral <span class="main">(</span>Num.Bit1 <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli'_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following explicit formula for Bernoulli numbers can also derived reasonably easily
  using the generating functions of Stirling numbers and Bernoulli numbers. The proof follows 
  an answer by Marko Riedel on the Mathematics StackExchange~\cite{riedel_mathse_2014}.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> bernoulli_altdef<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> real <span class="main">(</span><span class="bound">m</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> real <span class="bound">k</span><span class="main">^</span><span class="free">n</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> real <span class="main">(</span><span class="bound">m</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> real <span class="bound">k</span><span class="main">^</span><span class="free">n</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> real <span class="main">(</span><span class="bound">m</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> real <span class="bound">k</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_divide_distrib<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fact <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">m</span>  <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">m</span> <span class="main">$</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> sum.cong refl<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="keyword3"><span class="command">assume</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> <span class="main">{..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> real <span class="bound">k</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> 
            <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="skolem">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="skolem">m</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> real <span class="bound">k</span><span class="main">^</span><span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minus_one_power_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">*</span> <span class="main">(</span>real <span class="main">(</span>Stirling <span class="free">n</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> fact <span class="skolem">m</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Stirling_closed_form<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>Stirling <span class="free">n</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Stirling_fps <span class="skolem">m</span> <span class="main">$</span> <span class="free">n</span> <span class="main">*</span> fact <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Stirling_fps_nth<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> fact <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">$</span> <span class="free">n</span> <span class="main">*</span> fact <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Stirling_fps_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> real <span class="bound">k</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> 
                     fact <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">$</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">m</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">m</span> <span class="main">$</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span>
                fps_compose <span class="main">(</span>Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">m</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">$</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_compose_def atLeast0AtMost fps_sum_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_ln <span class="main">1</span> <span class="main">=</span> fps_X <span class="main">*</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">m</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fps_ln_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fps_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">m</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fps_ln <span class="main">1</span> <span class="main">/</span> fps_X"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fps_X_neq_zero nonzero_mult_div_cancel_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_compose <span class="main">…</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span>
               fps_compose <span class="main">(</span>fps_ln <span class="main">1</span><span class="main">)</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fps_compose_divide_distrib<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_compose <span class="main">(</span>fps_ln <span class="main">1</span><span class="main">)</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> real fps<span class="main">)</span> <span class="main">=</span> fps_X"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_ln_fps_exp_inv fps_inv_fps_exp_compose<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_X <span class="main">/</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bernoulli_fps"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_fps_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fact <span class="free">n</span> <span class="main">*</span> <span class="main">…</span> <span class="main">$</span> <span class="free">n</span> <span class="main">=</span> bernoulli <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span><span class="main">%</span>important bernoulli_conv_Stirling<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> fact <span class="bound">k</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="free">n</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> fact <span class="bound">k</span> <span class="main">/</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="free">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="bound">k</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="bound">i</span> <span class="main">^</span> <span class="free">n</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> fact <span class="skolem">k</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="free">n</span> <span class="skolem">k</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span>  <span class="main">(</span><span class="skolem">k</span> <span class="keyword1">choose</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="bound">j</span> <span class="main">^</span> <span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Stirling_closed_form sum_distrib_left sum_divide_distrib mult_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">j</span> <span class="main">*</span>  <span class="main">(</span><span class="skolem">k</span> <span class="keyword1">choose</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="bound">j</span> <span class="main">^</span> <span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> uminus_power_if <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> bernoulli <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Von Staudt--Clausen Theorem›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vonStaudt_Clausen_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">p</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="bound">m</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> cong_power_2n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">m</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">m</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">m</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span> <span class="main">^</span> <span class="skolem">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_pow fermat_theorem<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">p</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="bound">m</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="bound">m</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> int <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_sum cong_mult cong_power_2n cong_int<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> int <span class="main">1</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span>insert <span class="main">0</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">0</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms prime_gt_0_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> choose_alternating_sum<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n'_def dvd_eq_mod_eq_0<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_prime_factor two_is_prime_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
  <span class="keyword1"><span class="command">have</span></span> cong_pow_2n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">m</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n'</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_imp_coprime<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">n'</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ord <span class="free">p</span> <span class="skolem">m</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order_divides_totient<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹coprime <span class="free">p</span> <span class="skolem">m</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totient_prime<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">n'</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> ord <span class="free">p</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_dvd_modulus_nat<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="free">p</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> order_divides_expdiff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">p</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="bound">m</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="bound">m</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="bound">m</span> <span class="main">^</span> <span class="skolem">n'</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_sum cong_mult cong_pow_2n cong_int<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="bound">m</span> <span class="main">^</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="bound">m</span> <span class="main">^</span> <span class="skolem">n'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_left<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="bound">m</span> <span class="main">^</span> <span class="skolem">n'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> assms <span class="quoted"><span class="quoted">‹odd <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> uminus_power_if<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="bound">m</span> <span class="main">^</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">=</span>
            real <span class="main">(</span>Stirling <span class="skolem">n'</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> fact <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Stirling_closed_form<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Stirling <span class="skolem">n'</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The Von Staudt--Clausen theorem states that for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n &gt; 0›</span></span></span></span>,
    \[B_{2n} + \sum\limits_{p - 1\mid 2n} \frac{1}{p}\]
  is an integer.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> vonStaudt_Clausen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">+</span> <span class="var">?P</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="keyword1">if</span> prime <span class="main">(</span><span class="bound">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">m</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="keyword1">if</span> prime <span class="main">(</span><span class="bound">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">m</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="main">(</span><span class="bound">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">p</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">p</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">p</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">p</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">use</span> prime_gt_0_nat <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="var">?P</span> <span class="main">=</span>
                  <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span>of_int <span class="main">(</span>fact <span class="bound">m</span> <span class="main">*</span> Stirling <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span> <span class="bound">m</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">P</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib bernoulli_conv_Stirling sum_divide_distrib <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">.</span> of_int <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> fact <span class="bound">m</span> <span class="main">*</span> Stirling <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span> <span class="bound">m</span> <span class="main">+</span> <span class="skolem">P'</span> <span class="bound">m</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P'_def P_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_in_Ints<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">m</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">∨</span> prime <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">¬</span>prime <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">m</span> <span class="main">&gt;</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>fact <span class="skolem">m</span> <span class="main">*</span> Stirling <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span>
              real_of_int <span class="main">(</span><span class="numeral">9</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> <span class="numeral">4</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P'_def fact_numeral Stirling_closed_form power_mult
                                     atMost_nat_numeral binomial_fact zero_power<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>fact <span class="skolem">m</span> <span class="main">*</span> Stirling <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">9</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> <span class="numeral">4</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">0</span> <span class="main">^</span> <span class="free">n</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_add cong_diff cong_mult cong_pow<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="keyword1">dvd</span> int <span class="main">(</span>fact <span class="skolem">m</span> <span class="main">*</span> Stirling <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_0_iff zero_power<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">*</span> fact <span class="skolem">m</span> <span class="main">*</span> Stirling <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">P'</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">-</span><span class="main">(</span>real_of_int <span class="main">(</span>int <span class="main">(</span>fact <span class="skolem">m</span> <span class="main">*</span> Stirling <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real_of_int <span class="numeral">4</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Ints_minus of_int_divide_in_Ints dvd<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> composite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> composite composite_imp_factors_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">⟶</span> <span class="skolem">a</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">&gt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ab <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> power_less_imp_less_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> fact <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> product_dvd_fact<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> ab <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">*</span> fact <span class="skolem">m</span> <span class="main">*</span> Stirling <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">P'</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span>
              real_of_int <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">*</span> Stirling <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>real <span class="main">(</span>fact <span class="skolem">m</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> composite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Ints_mult Ints_real_of_nat_divide dvd<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> prime<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">*</span> fact <span class="skolem">m</span> <span class="main">*</span> int <span class="main">(</span>Stirling <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">choose</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> real_of_int <span class="bound">j</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Stirling_closed_form sum_divide_distrib sum_distrib_left mult_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real_of_int <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">choose</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="bound">j</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> of_int_sum <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> uminus_power_if<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">*</span> fact <span class="skolem">m</span> <span class="main">*</span> int <span class="main">(</span>Stirling <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span>
                      <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">choose</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="bound">j</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">choose</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="bound">j</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">m</span> <span class="keyword1">dvd</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vonStaudt_Clausen_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> prime <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">m</span> <span class="keyword1">dvd</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="skolem">P'</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prime <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">*</span> fact <span class="skolem">m</span> <span class="main">*</span> int <span class="main">(</span>Stirling <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">P'</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_iff_dvd_diff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="skolem">m</span> <span class="main">*</span> fact <span class="skolem">m</span> <span class="main">*</span> int <span class="main">(</span>Stirling <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">P'</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">/</span> of_int <span class="main">(</span>int <span class="main">(</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> of_int_divide_in_Ints<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Denominators of Bernoulli numbers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A consequence of the Von Staudt--Clausen theorem is that the denominator of $B_{2n}$ for $n &gt; 0$
  is precisely the product of all prime numbers <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> such that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p - 1›</span></span></span></span> divides $2n$.
  Since the denominator is obvious in all other cases, this fully characterises the denominator
  of Bernoulli numbers.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bernoulli_denom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bernoulli_denom</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="numeral">2</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> odd <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">∏</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bernoulli_num</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bernoulli_num</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">⌊</span>bernoulli <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">*</span> bernoulli_denom <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">⌋</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_bernoulli_denom_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{..</span></span></span><span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span><span class="main"><span class="main"><span class="main">*</span></span></span><span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">+</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli_denom_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"bernoulli_denom <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bernoulli_denom_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"bernoulli_denom <span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bernoulli_denom_Suc_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"bernoulli_denom <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bernoulli_denom_odd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> odd <span class="free">n</span> <span class="main">⟹</span> bernoulli_denom <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bernoulli_denom_even<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> even <span class="free">n</span> <span class="main">⟹</span> bernoulli_denom <span class="free">n</span> <span class="main">=</span> <span class="main">∏</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_denom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli_denom_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli_denom <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_denom_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod_pos<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli_denom_nonzero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli_denom <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bernoulli_denom_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli_denom_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bernoulli_denom <span class="free">n</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="numeral">2</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> odd <span class="free">n</span> <span class="keyword1">then</span> <span class="main">1</span>
        <span class="keyword1">else</span> prod_list <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>primes_upto <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> prod_list <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>primes_upto <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∏</span><span class="main">(</span>set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>primes_upto <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.distinct_set_conv_list<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>primes_upto <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">{</span><span class="bound"><span class="bound">p</span></span><span class="main">∈</span><span class="main">{..</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_primes_upto<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="main">…</span> <span class="main">=</span> bernoulli_denom <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_denom_even<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span><span class="main">%</span>important bernoulli_denom_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">int</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="main">(</span>bernoulli_denom <span class="free">m</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"bernoulli <span class="free">m</span> <span class="main">=</span> of_int <span class="free">a</span> <span class="main">/</span> of_nat <span class="main">(</span>bernoulli_denom <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"odd <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"even <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_denom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">-</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_denom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_denom_def bernoulli_odd_eq_0<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"even <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹even <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
  
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">/</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="main">(</span>int <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Rats_int_div_natE<span class="main">[</span><span class="operator">OF</span> bernoulli_in_Rats<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_bernoulli_denom_set<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> vonStaudt_Clausen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="bound">p</span><span class="main">)</span> <span class="main">=</span> of_int <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def Ints_def<span class="main">)</span>
  
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="main">∏</span><span class="main">(</span><span class="skolem">P</span><span class="main">-</span><span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">/</span> <span class="main">∏</span><span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_inverses_conv_fraction<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def prime_gt_0_nat c_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> P_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"prod real <span class="skolem">P</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_gt_0_nat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod_pos<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">∏</span><span class="skolem">P</span> <span class="main">-</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">/</span> <span class="main">∏</span><span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ab P_nz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> k <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">∏</span><span class="skolem">P</span> <span class="main">-</span> int <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="main">∏</span><span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> gcd <span class="main">(</span>int <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="main">∏</span><span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd_diff_dvd_left1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>gcd <span class="skolem">c</span> <span class="main">(</span><span class="main">∏</span><span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> gcd_int_int_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">c</span> <span class="main">(</span><span class="main">∏</span><span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_prime_inverses_fraction_coprime<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">c</span> <span class="main">(</span><span class="main">∏</span><span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">∏</span><span class="skolem">P</span> <span class="main">-</span> int <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="main">∏</span><span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> coprime_iff_gcd_eq_1<span class="main">)</span>
  
    <span class="keyword1"><span class="command">have</span></span> eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="skolem">P</span> <span class="main">=</span> bernoulli_denom <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_denom_def P_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">k</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="main"><span class="main"><span class="main">∏</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">P</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> int <span class="skolem"><span class="skolem"><span class="skolem">c</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> eq eq' coprime <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli_conv_num_denom<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">=</span> bernoulli_num <span class="free">n</span> <span class="main">/</span> bernoulli_denom <span class="free">n</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> coprime_bernoulli_num_denom<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>bernoulli_num <span class="free">n</span><span class="main">)</span> <span class="main">(</span>bernoulli_denom <span class="free">n</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="main">(</span>bernoulli_denom <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">/</span> bernoulli_denom <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bernoulli_denom_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_num_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Two obvious consequences from this are that the denominators of all odd Bernoulli numbers
  except for the first one are squarefree and multiples of 6:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> six_divides_bernoulli_denom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="numeral">6</span> <span class="keyword1">dvd</span> bernoulli_denom <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="main">{</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">}</span> <span class="keyword1">dvd</span> <span class="main">∏</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_dvd_prod_subset finite_bernoulli_denom_set<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_denom_even<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_bernoulli_denom<span class="main">:</span> <span class="quoted"><span class="quoted">"squarefree <span class="main">(</span>bernoulli_denom <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> squarefree_prod_coprime primes_coprime
           <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_denom_def squarefree_prime<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Furthermore, the denominator of $B_n$ divides $2(2^n - 1)$. This also gives us an
  upper bound on the denominators.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bernoulli_denom_dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli_denom <span class="free">n</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bernoulli_denom <span class="free">n</span> <span class="main">=</span> <span class="main">∏</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_denom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prime_prod_dvdI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_bernoulli_denom_set<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> p <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> prime_odd_nat
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_diff_nat Carmichael_divides<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Carmichael_prime<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_0_iff<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_denom_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> bernoulli_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bernoulli_denom <span class="free">n</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> one_less_power<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dvd_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bernoulli_denom_dvd<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  It can also be shown fairly easily from the von Staudt--Clausen theorem that if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is prime
  and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>2p + 1›</span></span></span></span> is not, then $B_{2p} \equiv \frac{1}{6}\ (\text{mod}\ 1)$ or, equivalently,
  the denominator of $B_{2p}$ is 6 and the numerator is of the form $6k+1$.

  This is the case e.\,g.\ for any primes of the form $3k+1$ or $5k+2$.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bernoulli_denom_prime_nonprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">6</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">[</span>bernoulli_num <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">6</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"bernoulli_denom <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">6</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_gt_0_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> P_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">{</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> bc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">dvd</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> division_decomp<span class="main">[</span><span class="operator">OF</span> q<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> bc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="free">p</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prime_nat_iff two_is_prime_nat <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> bc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_gt_0_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">q</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="free">p</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="free">p</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="skolem">q</span> <span class="main">∨</span> even <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">q</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prime_odd_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> prime_odd_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹prime <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli_denom <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">6</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> P_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bernoulli_denom_even<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">5</span> <span class="main">/</span> <span class="numeral">6</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> P_eq vonStaudt_Clausen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">5</span> <span class="main">/</span> <span class="numeral">6</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Ints_diff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">6</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"of_int <span class="skolem">a</span> <span class="main">=</span> bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">6</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> Ints_cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="skolem">a</span> <span class="main">=</span> real_of_int <span class="main">(</span>bernoulli_num <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">6</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_conv_num_denom<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bernoulli_num <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="numeral">6</span> <span class="main">*</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>bernoulli_num <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">6</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_iff_dvd_diff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Akiyama--Tanigawa algorithm›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  First, we define the Akiyama--Tanigawa number triangle as shown by Kaneko~\cite{kaneko2000}.
  We define this generically, parametrised by the first row. This makes the proofs a 
  little bit more modular.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gen_akiyama_tanigawa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen_akiyama_tanigawa</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_akiyama_tanigawa</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> 
     real <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">gen_akiyama_tanigawa</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">-</span> <span class="free">gen_akiyama_tanigawa</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> gen_akiyama_tanigawa_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gen_akiyama_tanigawa <span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The ``regular'' Akiyama--Tanigawa triangle is the one that is used for reading off
  Bernoulli numbers:
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">akiyama_tanigawa</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">akiyama_tanigawa</span> <span class="main">=</span> gen_akiyama_tanigawa <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">AT_fps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> real fps"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">AT_fps</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span>fps_X <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> Abs_fps <span class="main">(</span>gen_akiyama_tanigawa <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> AT_fps_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"AT_fps <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fps_X <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> fps_deriv <span class="main">(</span>AT_fps <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fps_ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"AT_fps <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>fps_X <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> fps_deriv <span class="main">(</span>AT_fps <span class="free">f</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AT_fps_def fps_deriv_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> AT_fps_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"AT_fps <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> fps_const <span class="main">(</span>real <span class="main">(</span>Stirling <span class="free">n</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_X <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span>fps_deriv <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">(</span>AT_fps <span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"AT_fps <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span>fps_XD' <span class="main">(</span>fps_X <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>AT_fps <span class="free">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AT_fps_Suc fps_XD'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> fps_const <span class="main">(</span>real <span class="main">(</span>Stirling <span class="free">n</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fps_X <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">m</span> <span class="main">*</span> 
                             <span class="main">(</span>fps_deriv <span class="main">^^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">(</span>AT_fps <span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fps_XD'_funpow_affine<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> AT_fps_0_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"AT_fps <span class="free">f</span> <span class="main">0</span> <span class="main">$</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span><span class="free">f</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AT_fps_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following fact corresponds to Proposition 1 in Kaneko's proof:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> gen_akiyama_tanigawa_n_0<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"gen_akiyama_tanigawa <span class="free">f</span> <span class="free">n</span> <span class="main">0</span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> fact <span class="bound">k</span> <span class="main">*</span> real <span class="main">(</span>Stirling <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span> <span class="main">=</span> gen_akiyama_tanigawa.simps
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen_akiyama_tanigawa <span class="free">f</span> <span class="free">n</span> <span class="main">0</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span>AT_fps <span class="free">f</span> <span class="free">n</span> <span class="main">$</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AT_fps_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"AT_fps <span class="free">f</span> <span class="free">n</span> <span class="main">$</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> real <span class="main">(</span>Stirling <span class="free">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span>fact <span class="bound">k</span> <span class="main">*</span> AT_fps <span class="free">f</span> <span class="main">0</span> <span class="main">$</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> AT_fps_altdef<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_sum_nth fps_nth_power_0 fps_0th_higher_deriv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> real <span class="main">(</span>Stirling <span class="free">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span>fact <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Stirling_n_0 AT_fps_0_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> fact <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span>real <span class="main">(</span>Stirling <span class="free">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
                    <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> fact <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span>real <span class="main">(</span>Stirling <span class="free">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">_</span> <span class="main">-</span> <span class="var">?S2</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_subtractf <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{..</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Stirling_n_0<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span>Suc <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_left<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span>Suc <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="main">0</span><span class="main">..</span>Suc <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">…</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.atLeast_Suc_atMost_Suc_shift<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">…</span> <span class="main">-</span> <span class="var">?S2</span> <span class="main">=</span> 
               <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">-</span><span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> fact <span class="bound">k</span> <span class="main">*</span> real <span class="main">(</span>Stirling <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_subtractf <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> fact <span class="bound">k</span> <span class="main">*</span> real <span class="main">(</span>Stirling <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_negf<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma states that for $A(x) := \sum_{k=0}^\infty a_{0,k} x^k$, we have
    \[\sum_{n=0}^\infty a_{n,0}\frac{x^n}{n!} = e^x A(1 - e^x)\]
  which correspond's to Kaneko's remark at the end of Section 2. This seems to be easier 
  to formalise than his actual proof of his Theorem 1, since his proof contains 
  an infinite sum of formal power series, and it was unclear to us how to capture this
  formally.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> gen_akiyama_tanigawa_fps<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> gen_akiyama_tanigawa <span class="free">f</span> <span class="bound">n</span> <span class="main">0</span> <span class="main">/</span> fact <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> fps_exp <span class="main">1</span> <span class="main">*</span> fps_compose <span class="main">(</span>Abs_fps <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_exp <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fps_ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>     
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_const <span class="main">(</span>fact <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> 
          <span class="main">(</span>fps_compose <span class="main">(</span>Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> gen_akiyama_tanigawa <span class="free">f</span> <span class="main">0</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_exp <span class="main">1</span><span class="main">)</span> <span class="main">*</span> fps_exp <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_exp <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">$</span> <span class="bound">m</span> <span class="main">*</span> fact <span class="skolem">n</span> <span class="main">/</span> fact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fps_mult_left_const_nth
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_times_def fps_compose_def gen_akiyama_tanigawa_n_0 sum_Stirling_binomial
                  <span class="dynamic"><span class="dynamic">field_simps</span></span> sum_distrib_left sum_distrib_right atLeast0AtMost
             <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Stirling.simps of_nat_Suc<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> fact <span class="bound">k</span> <span class="main">*</span> real <span class="main">(</span>Stirling <span class="bound">m</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">m</span> <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_exp <span class="main">1</span> <span class="main">::</span> real fps<span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span>fps_exp <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">::</span> real fps<span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> of_nat <span class="main">(</span><span class="skolem">k</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">*</span> fps_exp <span class="main">(</span>real <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> binomial_ring<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeast0AtMost power_minus' fps_exp_power_mult mult.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> fps_const <span class="main">(</span>real <span class="main">(</span><span class="skolem">k</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> fps_exp <span class="main">(</span>real <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_const_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fps_of_nat fps_const_power <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> 
                    fps_const_neg <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fps_const_mult fps_const_power fps_const_neg<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">$</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> real <span class="main">(</span><span class="skolem">k</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">*</span> real <span class="bound">i</span> <span class="main">^</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">/</span> fact <span class="skolem">m</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?S</span> <span class="main">/</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_sum_nth sum_divide_distrib <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">k</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> real <span class="bound">i</span> <span class="main">^</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minus_one_power_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">k</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> real <span class="bound">i</span> <span class="main">^</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> 
                 real <span class="main">(</span>Stirling <span class="skolem">m</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> fact <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Stirling_closed_form<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_exp <span class="main">1</span> <span class="main">::</span> real fps<span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">$</span> <span class="skolem">m</span> <span class="main">*</span> fact <span class="skolem">n</span> <span class="main">/</span> fact <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> 
                       <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> fact <span class="skolem">k</span> <span class="main">*</span> real <span class="main">(</span>Stirling <span class="skolem">m</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_fact <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> fact <span class="bound">k</span> <span class="main">*</span> 
                      real <span class="main">(</span>Stirling <span class="bound">m</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum.mono_neutral_left<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> fact <span class="bound">k</span> <span class="main">*</span> 
                      real <span class="main">(</span>Stirling <span class="bound">m</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.swap<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gen_akiyama_tanigawa <span class="free">f</span> <span class="skolem">n</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_akiyama_tanigawa_n_0 sum_Stirling_binomial sum_distrib_left sum_distrib_right
          mult.assoc atLeast0AtMost <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Stirling.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> gen_akiyama_tanigawa <span class="free">f</span> <span class="bound">n</span> <span class="main">0</span> <span class="main">/</span> fact <span class="bound">n</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span>
                  <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">*</span> <span class="main">(</span>Abs_fps <span class="free">f</span> <span class="keyword1">oo</span> <span class="main">1</span> <span class="main">-</span> fps_exp <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fps_mult_left_const_nth<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As Kaneko notes in his afore-mentioned remark, if we let $a_{0,k} = \frac{1}{k+1}$, we obtain
    \[A(z) = \sum_{k=0}^\infty \frac{x^k}{k+1} = -\frac{\ln (1 - x)}{x}\]
  and therefore
    \[\sum_{n=0}^\infty a_{n,0} \frac{x^n}{n!} = \frac{x e^x}{e^x - 1} = \frac{x}{1 - e^{-x}},\]
  which immediately gives us the connection to the positive Bernoulli numbers.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> bernoulli'_conv_akiyama_tanigawa<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli' <span class="free">n</span> <span class="main">=</span> akiyama_tanigawa <span class="free">n</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> gen_akiyama_tanigawa_fps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_ln <span class="main">1</span> <span class="main">=</span> fps_X <span class="main">*</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">n</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fps_ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_ln_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fps_ln <span class="main">1</span> <span class="main">/</span> fps_X <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="bound">n</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fps_X_neq_zero nonzero_mult_div_cancel_left<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_compose <span class="main">…</span> <span class="main">(</span><span class="main">-</span>fps_X<span class="main">)</span> <span class="main">=</span> Abs_fps <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_compose_uminus' fps_eq_iff f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="skolem">f</span> <span class="main">=</span> fps_compose <span class="main">(</span>fps_ln <span class="main">1</span> <span class="main">/</span> fps_X<span class="main">)</span> <span class="main">(</span><span class="main">-</span>fps_X<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_ln <span class="main">1</span> <span class="main">/</span> fps_X <span class="keyword1">oo</span> <span class="main">-</span> fps_X <span class="keyword1">oo</span> <span class="main">1</span> <span class="main">-</span> fps_exp <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> fps_ln <span class="main">1</span> <span class="main">/</span> fps_X <span class="keyword1">oo</span> fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fps_compose_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_compose_uminus<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>fps_ln <span class="main">1</span> <span class="keyword1">oo</span> fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fps_compose_divide_distrib<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fps_X <span class="main">/</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_ln_fps_exp_inv fps_inv_fps_exp_compose<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="skolem">f</span> <span class="keyword1">oo</span> <span class="main">1</span> <span class="main">-</span> fps_exp <span class="main">1</span> <span class="main">=</span> fps_X <span class="main">/</span> <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_exp <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_exp <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> fps_exp <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> fps_exp_add_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_exp <span class="main">1</span> <span class="main">*</span> <span class="main">(</span>fps_X <span class="main">/</span> <span class="main">…</span><span class="main">)</span> <span class="main">=</span> bernoulli'_fps"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bernoulli'_fps_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dvd_div_mult2_eq<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fps_dvd_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subdegree_leI<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> gen_akiyama_tanigawa <span class="skolem">f</span> <span class="bound">n</span> <span class="main">0</span> <span class="main">/</span> fact <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> bernoulli'_fps"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_eq_iff akiyama_tanigawa_def f_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">theorem</span></span> bernoulli_conv_akiyama_tanigawa<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">=</span> akiyama_tanigawa <span class="free">n</span> <span class="main">0</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bernoulli'_conv_akiyama_tanigawa<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_conv_bernoulli'<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Efficient code›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can now compute parts of the Akiyama--Tanigawa (and thereby Bernoulli numbers) 
  with reasonable efficiency but iterating the recurrence row by row. We essentially 
  start with some finite prefix of the zeroth row, say of length $n$, and then apply 
  the recurrence one to get a prefix of the first row of length $n - 1$ etc.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">akiyama_tanigawa_step_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real list <span class="main">⇒</span> real list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">akiyama_tanigawa_step_aux</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> 
     real <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">akiyama_tanigawa_step_aux</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">akiyama_tanigawa_step_aux</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_akiyama_tanigawa_step_aux <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>akiyama_tanigawa_step_aux <span class="free">m</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> akiyama_tanigawa_step_aux.induct<span class="main">)</span> <span class="operator">simp_all</span>
    
<span class="keyword1"><span class="command">lemma</span></span> akiyama_tanigawa_step_aux_eq_Nil_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"akiyama_tanigawa_step_aux <span class="free">m</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> length <span class="free">xs</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> length_0_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_akiyama_tanigawa_step_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟹</span> 
     akiyama_tanigawa_step_aux <span class="free">m</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> real <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">-</span> <span class="free">xs</span> <span class="main">!</span> Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> akiyama_tanigawa_step_aux.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">m</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen_akiyama_tanigawa_row</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen_akiyama_tanigawa_row</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> map <span class="main">(</span>gen_akiyama_tanigawa <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_gen_akiyama_tanigawa_row <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>gen_akiyama_tanigawa_row <span class="free">f</span> <span class="free">n</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span> <span class="main">-</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_akiyama_tanigawa_row_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_akiyama_tanigawa_row_eq_Nil_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_akiyama_tanigawa_row <span class="free">f</span> <span class="free">n</span> <span class="free">l</span> <span class="free">u</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">l</span> <span class="main">≥</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_akiyama_tanigawa_row_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> nth_gen_akiyama_tanigawa_row<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="main">-</span> <span class="free">l</span> <span class="main">⟹</span> gen_akiyama_tanigawa_row <span class="free">f</span> <span class="free">n</span> <span class="free">l</span> <span class="free">u</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> gen_akiyama_tanigawa <span class="free">f</span> <span class="free">n</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_akiyama_tanigawa_row_def add_ac<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> gen_akiyama_tanigawa_row_0 <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_akiyama_tanigawa_row <span class="free">f</span> <span class="main">0</span> <span class="free">l</span> <span class="free">u</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_akiyama_tanigawa_row_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> gen_akiyama_tanigawa_row_Suc <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_akiyama_tanigawa_row <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">l</span> <span class="free">u</span> <span class="main">=</span> 
     akiyama_tanigawa_step_aux <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">(</span>gen_akiyama_tanigawa_row <span class="free">f</span> <span class="free">n</span> <span class="free">l</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_gen_akiyama_tanigawa_row nth_akiyama_tanigawa_step_aux<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_akiyama_tanigawa_row_numeral<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_akiyama_tanigawa_row <span class="free">f</span> <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="free">l</span> <span class="free">u</span> <span class="main">=</span> 
     akiyama_tanigawa_step_aux <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">(</span>gen_akiyama_tanigawa_row <span class="free">f</span> <span class="main">(</span>pred_numeral <span class="free">n</span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc gen_akiyama_tanigawa_row_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_akiyama_tanigawa_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_akiyama_tanigawa <span class="free">f</span> <span class="free">n</span> <span class="free">k</span> <span class="main">=</span> hd <span class="main">(</span>gen_akiyama_tanigawa_row <span class="free">f</span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> hd_conv_nth<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_gen_akiyama_tanigawa_row length_0_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>   
    

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">akiyama_tanigawa_row</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">akiyama_tanigawa_row</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> map <span class="main">(</span>akiyama_tanigawa <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_akiyama_tanigawa_row <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>akiyama_tanigawa_row <span class="free">n</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span> <span class="main">-</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> akiyama_tanigawa_row_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> akiyama_tanigawa_row_eq_Nil_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"akiyama_tanigawa_row <span class="free">n</span> <span class="free">l</span> <span class="free">u</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">l</span> <span class="main">≥</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> akiyama_tanigawa_row_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> nth_akiyama_tanigawa_row<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="main">-</span> <span class="free">l</span> <span class="main">⟹</span> akiyama_tanigawa_row <span class="free">n</span> <span class="free">l</span> <span class="free">u</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> akiyama_tanigawa <span class="free">n</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> akiyama_tanigawa_row_def add_ac<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> akiyama_tanigawa_row_0 <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"akiyama_tanigawa_row <span class="main">0</span> <span class="free">l</span> <span class="free">u</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> inverse <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> akiyama_tanigawa_row_def akiyama_tanigawa_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> akiyama_tanigawa_row_Suc <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"akiyama_tanigawa_row <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">l</span> <span class="free">u</span> <span class="main">=</span> 
     akiyama_tanigawa_step_aux <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">(</span>akiyama_tanigawa_row <span class="free">n</span> <span class="free">l</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_akiyama_tanigawa_row 
                             nth_akiyama_tanigawa_step_aux akiyama_tanigawa_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> akiyama_tanigawa_row_numeral<span class="main">:</span>
  <span class="quoted"><span class="quoted">"akiyama_tanigawa_row <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="free">l</span> <span class="free">u</span> <span class="main">=</span> 
     akiyama_tanigawa_step_aux <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">(</span>akiyama_tanigawa_row <span class="main">(</span>pred_numeral <span class="free">n</span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc akiyama_tanigawa_row_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> akiyama_tanigawa_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"akiyama_tanigawa <span class="free">n</span> <span class="free">k</span> <span class="main">=</span> hd <span class="main">(</span>akiyama_tanigawa_row <span class="free">n</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> hd_conv_nth<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_akiyama_tanigawa_row length_0_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>    


<span class="keyword1"><span class="command">lemma</span></span> bernoulli_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="keyword1">if</span> odd <span class="free">n</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> akiyama_tanigawa <span class="free">n</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> odd <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_conv_akiyama_tanigawa<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_odd_eq_0<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> bernoulli'_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bernoulli' <span class="free">n</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="keyword1">else</span> <span class="keyword1">if</span> odd <span class="free">n</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> akiyama_tanigawa <span class="free">n</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli'_def bernoulli_code<span class="main">)</span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Evaluation with the simplifier is much slower than by reflection, but can still be done 
  with much better efficiency than before:
›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> eval_bernoulli <span class="main">=</span>
  akiyama_tanigawa_code akiyama_tanigawa_row_numeral
  numeral_2_eq_2 <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> akiyama_tanigawa_row_Suc upt_conv_Cons
  akiyama_tanigawa_row_0 bernoulli_code<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">n</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> eval_bernoulli' <span class="main">=</span> eval_bernoulli bernoulli'_code<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">n</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> eval_bernpoly <span class="main">=</span> 
  bernpoly_def atMost_nat_numeral power_eq_if binomial_fact fact_numeral eval_bernoulli

<span class="comment1">(* This should only take a few seconds *)</span>
<span class="keyword1"><span class="command">lemma</span></span> bernoulli_upto_20 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bernoulli <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">6</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli <span class="numeral">4</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">30</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli <span class="numeral">6</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">42</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli <span class="numeral">8</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">30</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"bernoulli <span class="numeral">10</span> <span class="main">=</span> <span class="numeral">5</span> <span class="main">/</span> <span class="numeral">66</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli <span class="numeral">12</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">691</span> <span class="main">/</span> <span class="numeral">2730</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli <span class="numeral">14</span> <span class="main">=</span> <span class="numeral">7</span> <span class="main">/</span> <span class="numeral">6</span>"</span></span>
  <span class="quoted"><span class="quoted">"bernoulli <span class="numeral">16</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="numeral">3617</span> <span class="main">/</span> <span class="numeral">510</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli <span class="numeral">18</span> <span class="main">=</span> <span class="numeral">43867</span> <span class="main">/</span> <span class="numeral">798</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli <span class="numeral">20</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="numeral">174611</span> <span class="main">/</span> <span class="numeral">330</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_bernoulli<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> bernoulli'_upto_20 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bernoulli' <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">6</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli' <span class="numeral">4</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">30</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli' <span class="numeral">6</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">42</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli' <span class="numeral">8</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">30</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"bernoulli' <span class="numeral">10</span> <span class="main">=</span> <span class="numeral">5</span> <span class="main">/</span> <span class="numeral">66</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli' <span class="numeral">12</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">691</span> <span class="main">/</span> <span class="numeral">2730</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli' <span class="numeral">14</span> <span class="main">=</span> <span class="numeral">7</span> <span class="main">/</span> <span class="numeral">6</span>"</span></span>
  <span class="quoted"><span class="quoted">"bernoulli' <span class="numeral">16</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="numeral">3617</span> <span class="main">/</span> <span class="numeral">510</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli' <span class="numeral">18</span> <span class="main">=</span> <span class="numeral">43867</span> <span class="main">/</span> <span class="numeral">798</span>"</span></span> 
  <span class="quoted"><span class="quoted">"bernoulli' <span class="numeral">20</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="numeral">174611</span> <span class="main">/</span> <span class="numeral">330</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli'_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Bernoulli_Zeta">
<div class="head">
<h1>Theory Bernoulli_Zeta</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Bernoulli numbers and the zeta function at positive integers›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Bernoulli_Zeta
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="../../HOL/HOL-Complex_Analysis/Complex_Analysis.html">HOL-Complex_Analysis.Complex_Analysis</a>"</span>
  <a href="Bernoulli_FPS.html">Bernoulli_FPS</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> joinpaths_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">+++</span> <span class="free">g</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">+++</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> linepath_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">a'</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b'</span> <span class="main">⟹</span> linepath <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> linepath <span class="free">a'</span> <span class="free">b'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The analytic continuation of the exponential generating function of the Bernoulli numbers
  is $\frac{z}{e^z - 1}$, which has simple poles at all $2ki\pi$ for $k\in\mathbb{Z}\setminus\{0\}$.
  We will need the residue at these poles:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> residue_bernoulli<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"residue <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">z</span> <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="main">(</span>exp <span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> real_of_int <span class="free">n</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">=</span> 
             <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> real_of_int <span class="free">n</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"residue <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="bound">z</span> <span class="main">^</span> <span class="free">m</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>exp <span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> real_of_int <span class="free">n</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> real_of_int <span class="free">n</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="free">m</span> <span class="main">/</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_integer_2pi<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">n</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> residue_simple_pole_deriv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">-</span></span></span><span class="main"><span class="main"><span class="main">{</span></span></span><span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> connected_open_delete_finite 
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac connected_punctured_universe<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  At positive integers greater than 1, the Riemann zeta function is simply the infinite
  sum $\zeta(n) = \sum_{k=1}^\infty k^{-n}$. For even $n$, this quantity can also be
  expressed in terms of Bernoulli numbers.

  To show this, we employ a similar strategy as in the meromorphic asymptotics approach:
  We apply the Residue Theorem to the exponential generating function of the Bernoulli numbers:
  \[\sum_{n=0}^\infty \frac{B_n}{n!} z^n = \frac{z}{e^z - 1}\]
  Recall that this function has poles at $2ki\pi$ for $k\in\mathbb{Z}\setminus\{0\}$.
  In the meromorphic asymptotics case, we integrated along a circle of radius $3i\pi$ in order
  to get the dominant singularities $2i\pi$ and $-2i\pi$. Now, however, we will not use a 
  fixed integration path, but we let the integration path become bigger and bigger. 
  Because the integrand decays relatively quickly if $n &gt; 1$, the integral vanishes in the limit 
  and we obtain not just an asymptotic formula, but an exact representation of $B_n$ as an 
  infinite sum.

  For odd $n$, we have $B_n = 0$, but for even $n$, the residues at $2ki\pi$ and $-2ki\pi$ 
  combine nicely to $2\cdot(-2k\pi)^{-n}$, and after some simplification we get the formula
  for $B_n$.

  Another difference to the meromorphic asymptotics is that we now use a rectangle instead
  of a circle as the integration path. For the asymptotics, only a big-oh bound was needed
  for the integral over one fixed integration path, and the circular path was very convenient.
  However, now we need to explicitly bound the integral for a whole sequence of integration paths
  that grow in size, and bounding $e^z - 1$ for $z$ on a circle is very tedious. On a rectangle,
  this term can be bounded much more easily. Still, we have to do this separately for all four
  edges of the rectangle, which will be a bit tedious.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> nat_even_power_sums_complex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n'</span><span class="main">)</span> <span class="main">::</span> complex<span class="main">)</span> <span class="keyword1">sums</span>
             of_real <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free">n'</span> <span class="main">*</span> bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n'</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> n' <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"even <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zeta</span></span> <span class="main">::</span> <span class="quoted">complex</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zeta</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">::</span> complex<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inverse_power_summable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> summable_Suc_iff<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">zeta</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> summable_sums_iff<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_def zeta_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="bound">k</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="bound">i</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">n</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">Suc</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> zeta_limit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="bound">k</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="bound">i</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">zeta</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="comment1">― ‹This is the exponential generating function of the Bernoulli numbers.›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">::</span>complex<span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="bound">z</span> <span class="main">/</span> <span class="main">(</span>exp <span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹We will integrate over this function, since its residue at the origin
      is the $n$-th coefficient of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">f</span></span><span class="antiquote">}</span></span>. Note that it has singularities
      at all points $2ik\pi$ for $k\in\mathbb{Z}$.›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">::</span>complex<span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">z</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="main">(</span>exp <span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹We integrate along a rectangle of width $2m$ and height $2(2m+1)\pi$
      with its centre at the origin. The benefit of the rectangular path is that
      it is easier to bound the value of the exponential appearing in the integrand.
      The horizontal lines of the rectangle are always right in the middle between 
      two adjacent singularities.›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real <span class="main">⇒</span> complex"</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> rectpath <span class="main">(</span><span class="main">-</span>real <span class="bound">m</span> <span class="main">-</span> real <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span>pi<span class="main">*</span><span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">(</span>real <span class="bound">m</span> <span class="main">+</span> real <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span>pi<span class="main">*</span><span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹This set is a convex open enclosing set the contains our path.›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">::</span>nat<span class="main">.</span> box <span class="main">(</span><span class="main">-</span><span class="main">(</span>real <span class="bound">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">m</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">*</span>pi<span class="main">*</span><span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">(</span>real <span class="bound">m</span><span class="main">+</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">m</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">*</span>pi<span class="main">*</span><span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹These are all the singularities in the enclosing inside the path
      (and also inside <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">A</span></span><span class="antiquote">}</span></span>).›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> of_int <span class="bound">n</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">-</span><span class="bound">m</span><span class="main">..</span><span class="bound">m</span><span class="main">}</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹Any singularity in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">A</span></span><span class="antiquote">}</span></span> is of the form $2ki\pi$ where $|k| \leq m$.›</span>
  <span class="keyword1"><span class="command">have</span></span> int_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span>int <span class="skolem">m</span><span class="main">..</span>int <span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="skolem">k</span> <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span>real <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">&lt;</span> real_of_int <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">∧</span> 
                        real <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">&gt;</span> real_of_int <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def in_box_complex_iff <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>real <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">&lt;</span> real_of_int <span class="skolem">k</span> <span class="main">∧</span> real_of_int <span class="skolem">k</span> <span class="main">&lt;</span> real <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>real <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> real_of_int <span class="main">(</span><span class="main">-</span>int <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> real_of_int <span class="main">(</span>int <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span><span class="main">-</span> int <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> real_of_int <span class="skolem">k</span> <span class="main">∧</span> 
                 real_of_int <span class="skolem">k</span> <span class="main">&lt;</span> real_of_int <span class="main">(</span>int <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span>int <span class="skolem">m</span><span class="main">..</span>int <span class="skolem">m</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> of_int_less_iff<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span>int <span class="skolem">m</span><span class="main">..</span>int <span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> zeros<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">-</span>int <span class="skolem">m</span><span class="main">..</span>int <span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="skolem">z</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> of_int <span class="bound">k</span> <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"exp <span class="skolem">z</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> z_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> of_int <span class="skolem">k</span> <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> exp_eq_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complex_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> int_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> zeros'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="main">(</span>exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="skolem">m</span> <span class="main">-</span> <span class="skolem">S</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">using</span></span> zeros<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>

  <span class="comment1">― ‹The singularities all lie strictly inside the integration path.›</span>
  <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="skolem">m</span> <span class="main">⊆</span> box <span class="main">(</span><span class="main">-</span>real <span class="skolem">m</span> <span class="main">-</span> real<span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span>pi<span class="main">*</span><span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">(</span>real <span class="skolem">m</span> <span class="main">+</span> real<span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span>pi<span class="main">*</span><span class="keyword1">𝗂</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span>int <span class="skolem">m</span><span class="main">..</span>int <span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="skolem">k</span> <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="main">-</span><span class="skolem">m</span> <span class="main">+</span> <span class="main">-</span>pi <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_le_less_mono mult_left_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="skolem">m</span> <span class="main">+</span> pi"</span></span>
      <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_le_less_mono mult_left_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def in_box_complex_iff <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword2"><span class="keyword">and</span></span> zeros' <span class="keyword1"><span class="command">have</span></span> holo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">holomorphic_on</span> <span class="skolem">A</span> <span class="skolem">m</span> <span class="main">-</span> <span class="skolem">S</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="comment1">― ‹The integration path lies completely inside $A$ and does not cross
      any singularities.›</span>
  <span class="keyword1"><span class="command">have</span></span> path_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"path_image <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">A</span> <span class="skolem">m</span> <span class="main">-</span> <span class="skolem">S</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path_image <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">⊆</span> cbox <span class="main">(</span><span class="main">-</span>real <span class="skolem">m</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">(</span>real <span class="skolem">m</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> γ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> path_image_rectpath_subset_cbox<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="skolem">A</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> subset_box_complex<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path_image <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">A</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path_image <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">S</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> path_image <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="skolem">k</span> <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> z<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>Im <span class="skolem">z</span><span class="main">¦</span> <span class="main">=</span> of_int <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> γ_def path_image_rectpath<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>Im <span class="skolem">z</span><span class="main">¦</span> <span class="main">=</span> of_int <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">¦</span><span class="skolem">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">*</span> pi"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k abs_mult<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">¦</span><span class="skolem">k</span><span class="main">¦</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mult_cancel_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> of_int_eq_iff<span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path_image <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">A</span> <span class="skolem">m</span> <span class="main">-</span> <span class="skolem">S</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹We now obtain a closed form for the Bernoulli numbers using the integral.›</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
              contour_integral <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">g</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">-</span>
              complex_of_real <span class="main">(</span>bernoulli <span class="skolem">n</span> <span class="main">/</span> fact <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword2"><span class="keyword">if</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="comment1">― ‹We relate the formal power series of the Bernoulli numbers to the
        corresponding complex function.›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subdegree <span class="main">(</span>fps_exp <span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> complex fps<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subdegreeI<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> expansion<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">has_fps_expansion</span> bernoulli_fps"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> f_def bernoulli_fps_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">fps_expansion_intros</span></span><span class="main">)</span>

    <span class="comment1">― ‹We use the Residue Theorem to explicitly compute the integral.›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"contour_integral <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">g</span> <span class="main">=</span>
             <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="skolem">S</span> <span class="skolem">m</span><span class="main">.</span> winding_number <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="bound">z</span> <span class="main">*</span> residue <span class="skolem">g</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Residue_theorem<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span><span class="main">-</span>real <span class="skolem">m</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">(</span>real <span class="skolem">m</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">A</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> subset_box_complex<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∉</span> <span class="skolem">A</span> <span class="skolem">m</span> <span class="main">⟶</span> winding_number <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> γ_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> winding_number_rectpath_outside allI impI<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> holo path_subset m<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> γ_def A_def S_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> convex_connected<span class="main">)</span>
    <span class="comment1">― ‹Clearly, all the winding numbers are 1›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"winding_number <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
      <span class="keyword1"><span class="command">unfolding</span></span> γ_def <span class="keyword1"><span class="command">using</span></span> subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> that m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> winding_number_rectpath<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="skolem">S</span> <span class="skolem">m</span><span class="main">.</span> winding_number <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="bound">z</span> <span class="main">*</span> residue <span class="skolem">g</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="skolem">S</span> <span class="skolem">m</span><span class="main">.</span> residue <span class="skolem">g</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">-</span>int <span class="skolem">m</span><span class="main">..</span>int <span class="skolem">m</span><span class="main">.</span> residue <span class="skolem">g</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> of_int <span class="bound">k</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span>int <span class="skolem">m</span><span class="main">..</span>int <span class="skolem">m</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">0</span> <span class="main">(</span><span class="main">{</span><span class="main">-</span>int <span class="skolem">m</span><span class="main">..</span>int <span class="skolem">m</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">…</span><span class="main">.</span> residue <span class="skolem">g</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> of_int <span class="bound">k</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                 residue <span class="skolem">g</span> <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">-</span>int <span class="skolem">m</span><span class="main">..</span><span class="skolem">m</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> residue <span class="skolem">g</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> of_int <span class="bound">k</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="operator">auto</span>
    <span class="comment1">― ‹The residue at the origin is just the $n$-th coefficient of $f$.›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"residue <span class="skolem">g</span> <span class="main">0</span> <span class="main">=</span> residue <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">z</span> <span class="main">/</span> <span class="bound">z</span> <span class="main">^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def g_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> residue_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_at_ball<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fps_nth bernoulli_fps <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> residue_fps_expansion_over_power_at_0 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> expansion<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_real <span class="main">(</span>bernoulli <span class="skolem">n</span> <span class="main">/</span> fact <span class="skolem">n</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">-</span>int <span class="skolem">m</span><span class="main">..</span><span class="skolem">m</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> residue <span class="skolem">g</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> of_int <span class="bound">k</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                 <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">-</span>int <span class="skolem">m</span><span class="main">..</span><span class="skolem">m</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_int <span class="bound">k</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> sum_divide_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> refl sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"residue <span class="skolem">g</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> of_int <span class="skolem">k</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> complex_of_real pi <span class="main">*</span> of_int <span class="skolem">k</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> residue_bernoulli<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> power_mult_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">-</span>int <span class="skolem">m</span><span class="main">..</span><span class="skolem">m</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_int <span class="bound">k</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="skolem">m</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">::</span>int<span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_int <span class="main">(</span>int <span class="bound">a</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">::</span> complex<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> snd <span class="bound"><span class="bound"><span class="bound">k</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> int <span class="main"><span class="main"><span class="main">(</span></span></span>fst <span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>nat <span class="main"><span class="main"><span class="main">¦</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">¦</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span>sgn <span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_if<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">/</span> of_nat <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.Sigma <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_right<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹The ugly part: We have to prove a bound on the integral by splitting
      it into four integrals over lines and bounding each part separately.›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> norm <span class="main">(</span>contour_integral <span class="main">(</span><span class="skolem">γ</span> <span class="bound">m</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">≤</span> 
          <span class="main">(</span><span class="main">(</span><span class="numeral">4</span> <span class="main">+</span> <span class="numeral">12</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">+</span> <span class="numeral">6</span> <span class="main">*</span> pi <span class="main">/</span> <span class="bound">m</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">m</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> sequentially"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_gt_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span>nat"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p1</span> <span class="bound">p2</span><span class="main">.</span> contour_integral <span class="main">(</span>linepath <span class="bound">p1</span> <span class="bound">p2</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p1</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="skolem"><span class="skolem">p3</span></span> <span class="skolem"><span class="skolem">p4</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">=</span> <span class="main">-</span>real <span class="skolem">m</span> <span class="main">-</span> <span class="var">?c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p2</span> <span class="main">=</span> real <span class="skolem">m</span> <span class="main">-</span> <span class="var">?c</span>"</span></span> 
                         <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p3</span> <span class="main">=</span> real <span class="skolem">m</span> <span class="main">+</span> <span class="var">?c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p4</span> <span class="main">=</span> <span class="main">-</span>real <span class="skolem">m</span> <span class="main">+</span> <span class="var">?c</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="skolem">m</span> <span class="main">=</span> linepath <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="main">+++</span> linepath <span class="skolem">p2</span> <span class="skolem">p3</span> <span class="main">+++</span> linepath <span class="skolem">p3</span> <span class="skolem">p4</span> <span class="main">+++</span> linepath <span class="skolem">p4</span> <span class="skolem">p1</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="skolem">m</span> <span class="main">=</span> <span class="var">?γ'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> γ_def rectpath_def Let_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> joinpaths_cong linepath_cong<span class="main">)</span> 
         <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p1_def p2_def p3_def p4_def complex_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> integrable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">contour_integrable_on</span> <span class="skolem">γ</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> contour_integrable_holomorphic_simple<span class="main"><span class="main">[</span></span><span class="operator">OF</span> holo _ _ path_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> γ_def A_def S_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_imp_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>contour_integral <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">=</span> norm <span class="main">(</span><span class="skolem">I</span> <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="main">+</span> <span class="skolem">I</span> <span class="skolem">p2</span> <span class="skolem">p3</span> <span class="main">+</span> <span class="skolem">I</span> <span class="skolem">p3</span> <span class="skolem">p4</span> <span class="main">+</span> <span class="skolem">I</span> <span class="skolem">p4</span> <span class="skolem">p1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> integrable<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> eq<span class="main">)</span>
                         <span class="main">(</span><span class="operator">subst</span> contour_integral_join<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> norm <span class="main">(</span><span class="skolem">I</span> <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">+</span> norm <span class="main">(</span><span class="skolem">I</span> <span class="skolem">p2</span> <span class="skolem">p3</span><span class="main">)</span> <span class="main">+</span> norm <span class="main">(</span><span class="skolem">I</span> <span class="skolem">p3</span> <span class="skolem">p4</span><span class="main">)</span> <span class="main">+</span> norm <span class="main">(</span><span class="skolem">I</span> <span class="skolem">p4</span> <span class="skolem">p1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> norm_triangle_mono order.refl<span class="main">)</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">I</span> <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> norm <span class="main">(</span><span class="skolem">p2</span> <span class="main">-</span> <span class="skolem">p1</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> <span class="var">?B1</span> <span class="main">*</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> I_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> contour_integral_bound_linepath<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> closed_segment <span class="skolem">p1</span> <span class="skolem">p2</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Re <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> z <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> closed_segment_same_Im<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p1_def p2_def complex_eq_iff a_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">m</span> <span class="main">*</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pi_ge_two <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi <span class="main">=</span> <span class="main">¦</span>Im <span class="skolem">z</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>Im <span class="skolem">z</span><span class="main">¦</span> <span class="main">≤</span> norm <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_Im_le_cmod<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">-</span>of_real <span class="main">(</span>exp <span class="skolem">a</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exp_integer_2pi_plus1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z exp_diff <span class="dynamic"><span class="dynamic">algebra_simps</span></span> exp_of_real<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> norm_minus_cancel norm_of_real <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> norm <span class="main">(</span>exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono power_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">g</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elim
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> norm_divide norm_mult norm_power mult_less_0_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> integrable<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">p2</span> <span class="main">-</span> <span class="skolem">p1</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p2_def p1_def<span class="main">)</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">I</span> <span class="skolem">p3</span> <span class="skolem">p4</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> norm <span class="main">(</span><span class="skolem">p4</span> <span class="main">-</span> <span class="skolem">p3</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> <span class="var">?B3</span> <span class="main">*</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> I_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> contour_integral_bound_linepath<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> closed_segment <span class="skolem">p3</span> <span class="skolem">p4</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Re <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> z <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> closed_segment_same_Im<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p3_def p4_def complex_eq_iff a_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">m</span> <span class="main">*</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pi_ge_two <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi <span class="main">=</span> <span class="main">¦</span>Im <span class="skolem">z</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>Im <span class="skolem">z</span><span class="main">¦</span> <span class="main">≤</span> norm <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_Im_le_cmod<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">-</span>of_real <span class="main">(</span>exp <span class="skolem">a</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exp_integer_2pi_plus1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z exp_add <span class="dynamic"><span class="dynamic">algebra_simps</span></span> exp_of_real<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> norm_minus_cancel norm_of_real <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> norm <span class="main">(</span>exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono power_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">g</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elim
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> norm_divide norm_mult norm_power mult_less_0_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> integrable<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">p4</span> <span class="main">-</span> <span class="skolem">p3</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p4_def p3_def<span class="main">)</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">I</span> <span class="skolem">p2</span> <span class="skolem">p3</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> norm <span class="main">(</span><span class="skolem">p3</span> <span class="main">-</span> <span class="skolem">p2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> <span class="var">?B2</span> <span class="main">*</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> I_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> contour_integral_bound_linepath<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> closed_segment <span class="skolem">p2</span> <span class="skolem">p3</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> Im <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> z <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> closed_segment_same_Re<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2_def p3_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> complex_eq_iff b_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> elim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> real <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> exp <span class="main">(</span>real <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exp_ge_add_one_self<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span>real <span class="skolem">m</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> norm <span class="main">(</span>exp <span class="skolem">z</span><span class="main">)</span> <span class="main">-</span> norm <span class="main">(</span><span class="main">1</span><span class="main">::</span>complex<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> norm <span class="main">(</span>exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> norm_triangle_ineq2<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z <span class="keyword2"><span class="keyword">and</span></span> abs_Re_le_cmod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> norm <span class="main">(</span>exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elim
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono power_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> z<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">g</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword2"><span class="keyword">and</span></span> elim
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def norm_mult norm_divide norm_power <span class="dynamic"><span class="dynamic">divide_simps</span></span> mult_less_0_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> integrable<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p3</span> <span class="main">-</span> <span class="skolem">p2</span> <span class="main">=</span> of_real <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span>real <span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span>pi<span class="main">)</span> <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p2_def p3_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> real <span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> norm_mult norm_of_real <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">I</span> <span class="skolem">p4</span> <span class="skolem">p1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> norm <span class="main">(</span><span class="skolem">p1</span> <span class="main">-</span> <span class="skolem">p4</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> <span class="var">?B4</span> <span class="main">*</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> I_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> contour_integral_bound_linepath<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> closed_segment <span class="skolem">p4</span> <span class="skolem">p1</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> Im <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> z <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">-</span>real <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> closed_segment_same_Re<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p1_def p4_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> b_def complex_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> elim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> real <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> exp <span class="main">(</span>real <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exp_ge_add_one_self<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span>real <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> exp_minus<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span>real <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> norm <span class="main">(</span><span class="main">1</span><span class="main">::</span>complex<span class="main">)</span> <span class="main">-</span> norm <span class="main">(</span>exp <span class="skolem">z</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> norm <span class="main">(</span>exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> norm_minus_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> norm_triangle_ineq2<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z <span class="keyword2"><span class="keyword">and</span></span> abs_Re_le_cmod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> norm <span class="main">(</span>exp <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elim
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono power_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> z<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">g</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword2"><span class="keyword">and</span></span> elim
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def norm_mult norm_divide norm_power <span class="dynamic"><span class="dynamic">divide_simps</span></span> mult_less_0_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> integrable<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">-</span> <span class="skolem">p4</span> <span class="main">=</span> <span class="main">-</span>of_real <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span>real <span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span>pi<span class="main">)</span> <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p1_def p4_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> real <span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> norm_mult norm_of_real norm_minus_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B1</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> <span class="var">?B2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span>real <span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span>pi<span class="main">)</span> <span class="main">+</span> <span class="var">?B3</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> <span class="var">?B4</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span>real <span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span>pi<span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">m</span> <span class="main">+</span> <span class="numeral">6</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">/</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">m</span> <span class="main">+</span> <span class="numeral">6</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">+</span> <span class="numeral">12</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span> <span class="main">+</span> <span class="numeral">6</span> <span class="main">*</span> pi"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="numeral">4</span> <span class="main">+</span> <span class="numeral">12</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">+</span> <span class="numeral">6</span> <span class="main">*</span> pi <span class="main">/</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">m</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cmod <span class="main">(</span>contour_integral <span class="main">(</span><span class="skolem">γ</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹It is clear that this bound goes to 0 since <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">prop</span> <span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span><span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">+</span> <span class="numeral">12</span> <span class="main">*</span> pi <span class="main">+</span> <span class="numeral">6</span> <span class="main">*</span> pi <span class="main">/</span> real <span class="bound">m</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">m</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_tendsto_divide_at_top tendsto_add tendsto_const 
          filterlim_real_sequentially filterlim_pow_at_top <span class="main"><span class="keyword3">|</span></span> <span class="operator">use</span> n <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> contour_integral <span class="main">(</span><span class="skolem">γ</span> <span class="bound">m</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_null_comparison<span class="main">)</span>

  <span class="comment1">― ‹Since the infinite sum over the residues can expressed using the
      zeta function, we have now related the Bernoulli numbers at even
      positive integers to the zeta function.›</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> contour_integral <span class="main">(</span><span class="skolem">γ</span> <span class="bound">m</span><span class="main">)</span> <span class="skolem">g</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">-</span>
             of_real <span class="main">(</span>bernoulli <span class="skolem">n</span> <span class="main">/</span> fact <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">⇢</span>
           <span class="main">0</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">-</span> 
           of_real <span class="main">(</span>bernoulli <span class="skolem">n</span> <span class="main">/</span> fact <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> * zeta_limit<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="bound">m</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="bound">k</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⇢</span> 
               <span class="main">-</span> of_real <span class="main">(</span>bernoulli <span class="skolem">n</span> <span class="main">/</span> fact <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> filterlim_cong eventually_mono <span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">::</span></span></span>nat"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">use</span> eq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="bound">m</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="bound">k</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>
                   <span class="main">⇢</span> <span class="main">-</span> of_real <span class="main">(</span>bernoulli <span class="skolem">n</span> <span class="main">/</span> fact <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>of_real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇢</span> <span class="var">?L</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="bound">m</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="bound">k</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="bound">m</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">Suc</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">n</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⇢</span> <span class="var">?L</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">sums</span> <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">n'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> power_mult_distrib power_mult power_minus'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> of_real <span class="main">(</span>bernoulli <span class="skolem">n</span> <span class="main">/</span> fact <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">…</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">=</span>
               of_real <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free">n'</span> <span class="main">*</span> bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n'</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> n_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> nat_even_power_sums_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">sums</span>
             <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free">n'</span> <span class="main">*</span> bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n'</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="keyword1">sums</span> <span class="var">?L</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> complex_of_real <span class="main">(</span><span class="var">?f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">sums</span> complex_of_real <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nat_even_power_sums_complex<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sums_of_real_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can now also easily determine the signs of Bernoulli numbers: the above formula 
  clearly shows that the signs of $B_{2n}$ alternate as $n$ increases, and we already know
  that $B_{2n+1} = 0$ for any positive $n$. A lot of other facts about the signs of
  Bernoulli numbers follow.
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> sgn_bernoulli_even<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sgn <span class="main">(</span>bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">sums</span>
             <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">*</span> bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> fact <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nat_even_power_sums_real<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> suminf_pos<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sums_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sgn <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
               <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">*</span> bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> fact <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sgn <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">*</span> sgn <span class="main">(</span>bernoulli <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sgn_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_one_power_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> bernoulli_even_nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span> <span class="main">⟹</span> bernoulli <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sgn_bernoulli_even<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> evenE<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> sgn_bernoulli<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sgn <span class="main">(</span>bernoulli <span class="free">n</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> odd <span class="free">n</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sgn_bernoulli_even <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_odd_eq_0<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> bernoulli_zero_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> odd <span class="free">n</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_even_nonzero bernoulli_odd_eq_0<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> bernoulli'_zero_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bernoulli' <span class="free">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">n</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">∧</span> odd <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli'_def bernoulli_zero_iff<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> bernoulli_pos_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟷</span> sgn <span class="main">(</span>bernoulli <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sgn_if<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> even <span class="free">n</span> <span class="main">∧</span> odd <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sgn_bernoulli<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="free">n</span> <span class="main">∧</span> odd <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> bernoulli_neg_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="numeral">4</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bernoulli <span class="free">n</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟷</span> sgn <span class="main">(</span>bernoulli <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sgn_if<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> even <span class="free">n</span> <span class="main">∧</span> even <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sgn_bernoulli<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minus_one_power_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="free">n</span> <span class="main">∧</span> even <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">⟷</span> <span class="numeral">4</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We also get the solution of the Basel problem (the sum over all squares of positive
  integers) and any `Basel-like' problem with even exponent. The case of odd exponents
  is much more complicated and no similarly nice closed form is known for these.
›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> nat_squares_sums<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">sums</span> <span class="main">(</span>pi <span class="main">^</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">6</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nat_even_power_sums_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fact_numeral<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> nat_power4_sums<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">4</span><span class="main">)</span> <span class="keyword1">sums</span> <span class="main">(</span>pi <span class="main">^</span> <span class="numeral">4</span> <span class="main">/</span> <span class="numeral">90</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nat_even_power_sums_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fact_numeral<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> nat_power6_sums<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">6</span><span class="main">)</span> <span class="keyword1">sums</span> <span class="main">(</span>pi <span class="main">^</span> <span class="numeral">6</span> <span class="main">/</span> <span class="numeral">945</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nat_even_power_sums_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">3</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fact_numeral<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> nat_power8_sums<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">8</span><span class="main">)</span> <span class="keyword1">sums</span> <span class="main">(</span>pi <span class="main">^</span> <span class="numeral">8</span> <span class="main">/</span> <span class="numeral">9450</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nat_even_power_sums_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">4</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fact_numeral<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>