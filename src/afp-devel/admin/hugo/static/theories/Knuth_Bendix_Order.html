<div id="Order_Pair">
<div class="head">
<h1>Theory Order_Pair</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Order Pairs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An order pair consists of two relations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">NS</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  is a strict order and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">NS</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> a compatible non-strict order,
  such that the combination of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">NS</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> always results in strict decrease.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Order_Pair
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Abstract-Rewriting/Relative_Rewriting.html">Abstract-Rewriting.Relative_Rewriting</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> order_simps
<span class="keyword1"><span class="command">declare</span></span> O_assoc<span class="main">[</span><span class="operator">order_simps</span><span class="main">]</span>

<span class="keyword1"><span class="command">locale</span></span> pre_order_pair <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">NS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> refl_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">NS</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans_S<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">NS</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> refl_NS_point<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> refl_NS <span class="keyword1"><span class="command">unfolding</span></span> refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> NS_O_NS<span class="main">[</span><span class="operator">order_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NS</span> <span class="keyword1">O</span> <span class="free">NS</span> <span class="main">=</span> <span class="free">NS</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">NS</span> <span class="keyword1">O</span> <span class="free">NS</span> <span class="keyword1">O</span> <span class="free">T</span> <span class="main">=</span> <span class="free">NS</span> <span class="keyword1">O</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">NS</span> <span class="keyword1">O</span> <span class="free">NS</span> <span class="main">=</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> trans_refl_imp_O_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans_NS refl_NS<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">NS</span> <span class="keyword1">O</span> <span class="free">NS</span> <span class="keyword1">O</span> <span class="free">T</span> <span class="main">=</span> <span class="free">NS</span> <span class="keyword1">O</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trancl_NS<span class="main">[</span><span class="operator">order_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NS</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans_NS <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> rtrancl_NS<span class="main">[</span><span class="operator">order_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NS</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="free">NS</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans_refl_imp_rtrancl_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans_NS refl_NS<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trancl_S<span class="main">[</span><span class="operator">order_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> S_O_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">O</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">O</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">O</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> trans_O_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans_S<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">O</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trans_S_point<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trans_S <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> trans_NS_point<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trans_NS <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> compat_pair <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="free">NS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> compat_NS_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NS</span> <span class="keyword1">O</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> compat_S_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">O</span> <span class="free">NS</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> compat_NS_S_point<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> compat_NS_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> compat_S_NS_point<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> compat_S_NS <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> S_O_rtrancl_NS<span class="main">[</span><span class="operator">order_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">O</span> <span class="free">NS</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">O</span> <span class="free">NS</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">O</span> <span class="free">NS</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> equalityI subrelI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">NS</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">NS</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> IH<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> xz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">NS</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> zy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> IH.hyps<span class="main">[</span><span class="operator">OF</span> xz<span class="main">]</span> zy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">NS</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> compat_S_NS <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">O</span> <span class="free">NS</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rtrancl_NS_O_S<span class="main">[</span><span class="operator">order_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NS</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">NS</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">NS</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> equalityI subrelI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">^^</span><span class="skolem">n</span> <span class="keyword1">O</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> IH<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> xz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> zy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span><span class="main">^^</span><span class="skolem">n</span> <span class="keyword1">O</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> relpow_Suc<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> xz IH.hyps<span class="main">[</span><span class="operator">OF</span> zy<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NS</span> <span class="keyword1">O</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> compat_NS_S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">NS</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> order_pair <span class="main">=</span> pre_order_pair <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">NS</span></span> <span class="main">+</span> compat_pair <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">NS</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="free">NS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_O_NS<span class="main">[</span><span class="operator">order_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">O</span> <span class="free">NS</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">O</span> <span class="free">NS</span> <span class="keyword1">O</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> S_O_rtrancl_NS<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> rtrancl_NS<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">lemma</span></span> NS_O_S<span class="main">[</span><span class="operator">order_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NS</span> <span class="keyword1">O</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">NS</span> <span class="keyword1">O</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="keyword1">O</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> rtrancl_NS_O_S<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> rtrancl_NS<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compat_rtrancl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">NS</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bc
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ab<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">c</span> <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> step<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> compat_S_NS_point trans_S <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> SN_ars <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SN<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="free">S</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> SN_pair <span class="main">=</span> compat_pair <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">NS</span></span> <span class="main">+</span> SN_ars <span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="free">NS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>

<span class="keyword1"><span class="command">locale</span></span> SN_order_pair <span class="main">=</span> order_pair <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">NS</span></span> <span class="main">+</span> SN_ars <span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="free">NS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> SN_order_pair <span class="main">⊆</span> SN_pair <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lexicographic_Extension">
<div class="head">
<h1>Theory Lexicographic_Extension</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lexicographic Extension›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lexicographic_Extension
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../Matrix/Utility.html">Matrix.Utility</a>
    <a href="Order_Pair.html">Order_Pair</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this theory we define the lexicographic extension of an order pair, so that it generalizes
  the existing notion <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lex_prod<span class="antiquote"><span class="antiquote">}</span></span></span></span> which is based on a single order only.

  Our main result is that this extension yields again an order pair.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lex_two</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'b</span> rel <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> rel"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">lex_two</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">b1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a2</span><span class="main">,</span> <span class="bound">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">b1</span><span class="main">,</span> <span class="bound">b2</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lex_two<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> SN_s<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> SN_s2<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SN <span class="main">(</span>lex_two <span class="free">s</span> <span class="free">ns</span> <span class="free">s2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"SN <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">from</span></span> steps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?a</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?a</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span> <span class="main">(</span><span class="var">?a</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?a</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?b</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?b</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> steps <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≥</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="var">?a</span> <span class="bound">i</span><span class="main">,</span> <span class="var">?a</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">-</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> non_strict_ending<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ compat<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> steps SN_s<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> SN_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> steps <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≥</span> <span class="skolem">j</span> <span class="main">⟹</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">i</span><span class="main">,</span> <span class="var">?b</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?b</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> steps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> SN_s2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> SN_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lex_two_compat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ns1</span> <span class="keyword1">O</span> <span class="free">s1</span> <span class="main">⊆</span> <span class="free">s1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> compat1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="keyword1">O</span> <span class="free">ns1</span> <span class="main">⊆</span> <span class="free">s1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="keyword1">O</span> <span class="free">s1</span> <span class="main">⊆</span> <span class="free">s1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ns1</span> <span class="keyword1">O</span> <span class="free">ns1</span> <span class="main">⊆</span> <span class="free">ns1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> compat2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ns2</span> <span class="keyword1">O</span> <span class="free">s2</span> <span class="main">⊆</span> <span class="free">s2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ab1</span><span class="main">,</span> <span class="free">ab2</span><span class="main">)</span> <span class="main">∈</span> lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">ns2</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ab2</span><span class="main">,</span> <span class="free">ab3</span><span class="main">)</span> <span class="main">∈</span> lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ab1</span><span class="main">,</span> <span class="free">ab3</span><span class="main">)</span> <span class="main">∈</span> lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ab1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">b1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ab2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a3</span></span> <span class="skolem"><span class="skolem">b3</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ab3</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a3</span><span class="main">,</span> <span class="skolem">b3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">note</span></span> id <span class="main">=</span> ab1 ab2 ab3
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> s1<span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">a3</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> s2<span class="main">:</span> True
      <span class="keyword1"><span class="command">from</span></span> trans1 s1 s2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">a3</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> compat1' s1 this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False 
    <span class="keyword1"><span class="command">with</span></span> ns <span class="keyword1"><span class="command">have</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">a3</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> s2<span class="main">:</span> True
      <span class="keyword1"><span class="command">from</span></span> compat1 ns<span class="main">(</span>1<span class="main">)</span> s2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> s <span class="keyword1"><span class="command">have</span></span> nss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">a3</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b2</span><span class="main">,</span> <span class="skolem">b3</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> trans1' ns<span class="main">(</span>1<span class="main">)</span> nss<span class="main">(</span>1<span class="main">)</span> compat2 ns<span class="main">(</span>2<span class="main">)</span> nss<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lex_two_compat'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ns1</span> <span class="keyword1">O</span> <span class="free">s1</span> <span class="main">⊆</span> <span class="free">s1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> compat1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="keyword1">O</span> <span class="free">ns1</span> <span class="main">⊆</span> <span class="free">s1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="keyword1">O</span> <span class="free">s1</span> <span class="main">⊆</span> <span class="free">s1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ns1</span> <span class="keyword1">O</span> <span class="free">ns1</span> <span class="main">⊆</span> <span class="free">ns1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> compat2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="keyword1">O</span> <span class="free">ns2</span> <span class="main">⊆</span> <span class="free">s2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ab1</span><span class="main">,</span> <span class="free">ab2</span><span class="main">)</span> <span class="main">∈</span> lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">s2</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ab2</span><span class="main">,</span> <span class="free">ab3</span><span class="main">)</span> <span class="main">∈</span> lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">ns2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ab1</span><span class="main">,</span> <span class="free">ab3</span><span class="main">)</span> <span class="main">∈</span> lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ab1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">b1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ab2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a3</span></span> <span class="skolem"><span class="skolem">b3</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ab3</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a3</span><span class="main">,</span> <span class="skolem">b3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">note</span></span> id <span class="main">=</span> ab1 ab2 ab3
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> s1<span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">a3</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> s2<span class="main">:</span> True
      <span class="keyword1"><span class="command">from</span></span> trans1 s1 s2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> ns <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">a3</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> compat1' s1 this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False 
    <span class="keyword1"><span class="command">with</span></span> s <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">a3</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> s2<span class="main">:</span> True
      <span class="keyword1"><span class="command">from</span></span> compat1 s<span class="main">(</span>1<span class="main">)</span> s2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> ns <span class="keyword1"><span class="command">have</span></span> nss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">a3</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b2</span><span class="main">,</span> <span class="skolem">b3</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ns2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> trans1' s<span class="main">(</span>1<span class="main">)</span> nss<span class="main">(</span>1<span class="main">)</span> compat2' s<span class="main">(</span>2<span class="main">)</span> nss<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lex_two_compat2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns1</span> <span class="keyword1">O</span> <span class="free">s1</span> <span class="main">⊆</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="keyword1">O</span> <span class="free">ns1</span> <span class="main">⊆</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="keyword1">O</span> <span class="free">s1</span> <span class="main">⊆</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns1</span> <span class="keyword1">O</span> <span class="free">ns1</span> <span class="main">⊆</span> <span class="free">ns1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns2</span> <span class="keyword1">O</span> <span class="free">s2</span> <span class="main">⊆</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">ns2</span> <span class="keyword1">O</span> lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">s2</span> <span class="main">⊆</span> lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lex_two_compat<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> relcompE<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lex_two_compat'2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns1</span> <span class="keyword1">O</span> <span class="free">s1</span> <span class="main">⊆</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="keyword1">O</span> <span class="free">ns1</span> <span class="main">⊆</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="keyword1">O</span> <span class="free">s1</span> <span class="main">⊆</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns1</span> <span class="keyword1">O</span> <span class="free">ns1</span> <span class="main">⊆</span> <span class="free">ns1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="keyword1">O</span> <span class="free">ns2</span> <span class="main">⊆</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">s2</span> <span class="keyword1">O</span> lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">ns2</span> <span class="main">⊆</span> lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lex_two_compat'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> relcompE<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lex_two_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r1<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">ns1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r2<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">ns2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"refl <span class="main">(</span>lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">ns2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> refl_onD<span class="main">[</span><span class="operator">OF</span> r1<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> refl_onD<span class="main">[</span><span class="operator">OF</span> r2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> refl_onI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lex_two_order_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"order_pair <span class="free">s1</span> <span class="free">ns1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"order_pair <span class="free">s2</span> <span class="free">ns2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order_pair <span class="main">(</span>lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">s2</span><span class="main">)</span> <span class="main">(</span>lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">ns2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> o1<span class="main">:</span> order_pair <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">ns1</span></span> <span class="keyword1"><span class="command">using</span></span> o1<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> o2<span class="main">:</span> order_pair <span class="quoted"><span class="free">s2</span></span> <span class="quoted"><span class="free">ns2</span></span> <span class="keyword1"><span class="command">using</span></span> o2<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> o1.trans_S o1.trans_NS o2.trans_S o2.trans_NS 
    o1.compat_NS_S o2.compat_NS_S o1.compat_S_NS o2.compat_S_NS
  <span class="keyword1"><span class="command">note</span></span> this <span class="main">[</span><span class="operator">unfolded</span> trans_O_iff<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> o1.refl_NS o2.refl_NS
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> lex_two_refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> trans_O_iff<span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> lex_two_compat2 lex_two_compat'2<span class="main"><span class="keyword3">;</span></span><span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lex_two_SN_order_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"SN_order_pair <span class="free">s1</span> <span class="free">ns1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"SN_order_pair <span class="free">s2</span> <span class="free">ns2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SN_order_pair <span class="main">(</span>lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">s2</span><span class="main">)</span> <span class="main">(</span>lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">ns2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> o1<span class="main">:</span> SN_order_pair <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">ns1</span></span> <span class="keyword1"><span class="command">using</span></span> o1<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> o2<span class="main">:</span> SN_order_pair <span class="quoted"><span class="free">s2</span></span> <span class="quoted"><span class="free">ns2</span></span> <span class="keyword1"><span class="command">using</span></span> o2<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> o1.trans_S o1.trans_NS o2.trans_S o2.trans_NS o1.SN o2.SN
    o1.compat_NS_S o2.compat_NS_S o1.compat_S_NS o2.compat_S_NS
  <span class="keyword1"><span class="command">note</span></span> this <span class="main">[</span><span class="operator">unfolded</span> trans_O_iff<span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> order_pair <span class="quoted"><span class="quoted">"<span class="main">(</span>lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">s2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lex_two <span class="free">s1</span> <span class="free">ns1</span> <span class="free">ns2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> lex_two_order_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> lex_two<span class="main"><span class="keyword3">;</span></span> <span class="operator">fact</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the unbounded lexicographic extension, there is no restriction on the lengths
  of the lists. Therefore it is possible to compare lists of different lengths.
  This usually results a non-terminating relation, e.g., $[1] &gt; [0, 1] &gt; [0, 0, 1] &gt; \ldots$
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lex_ext_unbounded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool <span class="main">×</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lex_ext_unbounded</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">lex_ext_unbounded</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">lex_ext_unbounded</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">lex_ext_unbounded</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">stri</span><span class="main">,</span> <span class="bound">nstri</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="bound">stri</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">nstri</span> <span class="keyword1">then</span> <span class="free">lex_ext_unbounded</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>
      <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lex_ext_unbounded_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lex_ext_unbounded <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> length <span class="free">xs</span> <span class="main">&gt;</span> length <span class="free">ys</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> length <span class="free">xs</span> <span class="main">≥</span> length <span class="free">ys</span><span class="main">)</span><span class="main">)</span>
  "</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lex</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">(</span><span class="var">?stri</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">,</span> <span class="var">?nstri</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> oCons <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> oCons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">stri</span> <span class="skolem">nstri</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">stri</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> Pair Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False        
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">nstri</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">stri</span>›</span></span> Pair Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> False Pair <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_Suc_conv ex_Suc_conv Cons f oCons<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> lex_ext_unbounded.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The lexicographic extension of an order pair takes a natural number as maximum bound.
  A decrease with lists of unequal lengths will never be successful if the length of the
  second list exceeds this bound. The bound is essential to preserve strong normalization.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lex_ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool <span class="main">×</span> bool<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">lex_ext</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">lts</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">in</span> 
      <span class="keyword1">if</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> <span class="bound">lts</span> <span class="main">∨</span> <span class="bound">lts</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">then</span> lex_ext_unbounded <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>
      <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lex_ext_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">m</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span>length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">∨</span> length <span class="free">ys</span> <span class="main">≤</span> <span class="free">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> length <span class="free">xs</span> <span class="main">&gt;</span> length <span class="free">ys</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span>length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">∨</span> length <span class="free">ys</span> <span class="main">≤</span> <span class="free">m</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> length <span class="free">xs</span> <span class="main">≥</span> length <span class="free">ys</span><span class="main">)</span><span class="main">)</span>
  "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lex_ext_unbounded_iff Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lex_ext_to_lex_ext_unbounded<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> lex_ext_unbounded <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> lex_ext_stri_imp_nstri<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">m</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">m</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lex_ext_unbounded_stri_imp_nstri<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext_unbounded <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_unbounded_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> all_nstri_imp_lex_nstri<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≥</span> length <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">∨</span> length <span class="free">ys</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">m</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> lex_ext_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">xs1</span> <span class="free">xs2</span> <span class="free">ys1</span> <span class="free">ys2</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs1</span> <span class="main">=</span> length <span class="free">ys1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">=</span> <span class="free">m2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs2</span> <span class="main">=</span> length <span class="free">ys2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ys1</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ys2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs1</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs2</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="free">ys1</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys2</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lex_ext <span class="free">f</span> <span class="free">m1</span> <span class="free">xs1</span> <span class="free">xs2</span> <span class="main">=</span> lex_ext <span class="free">g</span> <span class="free">m2</span> <span class="free">ys1</span> <span class="free">ys2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lex_ext_unbounded_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">as'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> <span class="free">bs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">as'</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">bs'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">as'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="free">as'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lex_ext_unbounded <span class="free">f</span> <span class="free">as</span> <span class="free">bs</span> <span class="main">=</span> lex_ext_unbounded <span class="free">g</span> <span class="free">as'</span> <span class="free">bs'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> assms lex_ext_unbounded_iff <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Compatibility is the key property to ensure transitivity of the order.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We prove compatibility locally, i.e., it only has to hold for elements
  of the argument lists. Locality is essential for being applicable in recursively
  defined term orders such as KBO.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lex_ext_compat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">ss</span><span class="main">;</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">;</span> <span class="bound">u</span> <span class="main">∈</span> set <span class="free">us</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span>snd <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>snd <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span>snd <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ts</span> <span class="free">us</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ss</span> <span class="free">us</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>fst <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ts</span> <span class="free">us</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ss</span> <span class="free">us</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>snd <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ts</span> <span class="free">us</span><span class="main">)</span> <span class="main">⟶</span> snd <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ss</span> <span class="free">us</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>fst <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ts</span> <span class="free">us</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ss</span> <span class="free">us</span><span class="main">)</span><span class="main">)</span>
    "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">us</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?st</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ss</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ts</span> <span class="free">us</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?su</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ss</span> <span class="free">us</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fst</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">ss</span> <span class="bound">ts</span> <span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="bound">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?snd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">ss</span> <span class="bound">ts</span> <span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="bound">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ex</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">ss</span> <span class="bound">ts</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="bound">ss</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">ts</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?snd</span> <span class="bound">ss</span> <span class="bound">ts</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?fst</span> <span class="bound">ss</span> <span class="bound">ts</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?all</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">ss</span> <span class="bound">ts</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="bound">ts</span><span class="main">.</span> <span class="var">?snd</span> <span class="bound">ss</span> <span class="bound">ts</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> lengths<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?ls</span> <span class="main">=</span> <span class="var">?lt</span> <span class="main">∨</span> <span class="var">?lt</span> <span class="main">≤</span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?lt</span> <span class="main">=</span> <span class="var">?lu</span> <span class="main">∨</span> <span class="var">?lu</span> <span class="main">≤</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="var">?ls</span> <span class="main">=</span> <span class="var">?lu</span> <span class="main">∨</span> <span class="var">?lu</span> <span class="main">≤</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lst</span> <span class="main">∧</span> <span class="var">?ltu</span> <span class="main">⟶</span> <span class="var">?lsu</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="var">?st</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="var">?tu</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> lengths <span class="keyword1"><span class="command">have</span></span> lsu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lsu</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> st <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ss</span> <span class="free">ts</span> <span class="main">∨</span> <span class="var">?all</span> <span class="free">ss</span> <span class="free">ts</span> <span class="main">∧</span> <span class="var">?lt</span> <span class="main">≤</span> <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tu <span class="keyword1"><span class="command">have</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ts</span> <span class="free">us</span> <span class="main">∨</span> <span class="var">?all</span> <span class="free">ts</span> <span class="free">us</span> <span class="main">∧</span> <span class="var">?lu</span> <span class="main">&lt;</span> <span class="var">?lt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> st <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?su</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ss</span> <span class="free">ts</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="var">?ls</span> <span class="main">∧</span> <span class="skolem">i1</span> <span class="main">&lt;</span> <span class="var">?lt</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fst1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">i1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i1</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> tu <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ts</span> <span class="free">us</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="keyword2"><span class="keyword">where</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fst2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">i2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i2</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min <span class="skolem">i1</span> <span class="skolem">i2</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> i1 i2 <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> <span class="var">?ls</span> <span class="main">∧</span> <span class="var">?i</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="var">?i</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ssi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="var">?i</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="var">?i</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> snd1 snd2 <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> j i <span class="keyword1"><span class="command">have</span></span> ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="skolem">i2</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">=</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> True fst1 snd2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">ts</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="skolem">i1</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">=</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> True snd1 fst2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ts</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i1</span> <span class="main">&lt;</span> <span class="skolem">i2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">=</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> fst1 fst2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">ts</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ts</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff lsu<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?i</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst snd i<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?all</span> <span class="free">ts</span> <span class="free">us</span> <span class="main">∧</span> <span class="var">?lu</span> <span class="main">&lt;</span> <span class="var">?lt</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> usi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">i1</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> i1 <span class="keyword1"><span class="command">have</span></span> ssi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">i1</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">i1</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> True tu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> fst1 compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i1</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i1</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> i1 True snd1 tu <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
              ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">with</span></span> fst lsu True i1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span> 
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> i1 <span class="keyword1"><span class="command">have</span></span> lus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lu</span> <span class="main">&lt;</span> <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="var">?lu</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> False i1 snd1 tu <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
              ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">with</span></span> lus lsu <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?all</span> <span class="free">ss</span> <span class="free">ts</span> <span class="main">∧</span> <span class="var">?lt</span> <span class="main">≤</span> <span class="var">?ls</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> tu
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ts</span> <span class="free">us</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> st <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="keyword2"><span class="keyword">where</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fst2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">i2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i2</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> st i2 <span class="keyword1"><span class="command">have</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?ls</span> <span class="main">∧</span> <span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ssi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> i2 st <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> fst2 compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i2</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i2</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> i2 snd2 st <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
            ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> fst lsu i2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?all</span> <span class="free">ts</span> <span class="free">us</span> <span class="main">∧</span> <span class="var">?lu</span> <span class="main">&lt;</span> <span class="var">?lt</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> st <span class="keyword1"><span class="command">have</span></span> lus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lu</span> <span class="main">&lt;</span> <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="var">?lu</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> st tu <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
            ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> lus lsu <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="var">?st</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="var">?tu</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> lengths <span class="keyword1"><span class="command">have</span></span> lsu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lsu</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> st <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ss</span> <span class="free">ts</span> <span class="main">∨</span> <span class="var">?all</span> <span class="free">ss</span> <span class="free">ts</span> <span class="main">∧</span> <span class="var">?lt</span> <span class="main">&lt;</span> <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tu <span class="keyword1"><span class="command">have</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ts</span> <span class="free">us</span> <span class="main">∨</span> <span class="var">?all</span> <span class="free">ts</span> <span class="free">us</span> <span class="main">∧</span> <span class="var">?lu</span> <span class="main">≤</span> <span class="var">?lt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> st <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?su</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ss</span> <span class="free">ts</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="var">?ls</span> <span class="main">∧</span> <span class="skolem">i1</span> <span class="main">&lt;</span> <span class="var">?lt</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fst1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">i1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i1</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> tu <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ts</span> <span class="free">us</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="keyword2"><span class="keyword">where</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fst2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">i2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i2</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min <span class="skolem">i1</span> <span class="skolem">i2</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> i1 i2 <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> <span class="var">?ls</span> <span class="main">∧</span> <span class="var">?i</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="var">?i</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ssi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="var">?i</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="var">?i</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> snd1 snd2 <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> j i <span class="keyword1"><span class="command">have</span></span> ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="skolem">i2</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">=</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> True fst1 snd2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">ts</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="skolem">i1</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">=</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> True snd1 fst2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ts</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i1</span> <span class="main">&lt;</span> <span class="skolem">i2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">=</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> fst1 fst2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">ts</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ts</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff lsu<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?i</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst snd i<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?all</span> <span class="free">ts</span> <span class="free">us</span> <span class="main">∧</span> <span class="var">?lu</span> <span class="main">≤</span> <span class="var">?lt</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> usi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">i1</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> i1 <span class="keyword1"><span class="command">have</span></span> ssi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">i1</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">i1</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> True tu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> fst1 compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i1</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i1</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> i1 True snd1 tu <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
              ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">with</span></span> fst lsu True i1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span> 
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> i1 <span class="keyword1"><span class="command">have</span></span> lus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lu</span> <span class="main">&lt;</span> <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="var">?lu</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> False i1 snd1 tu <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
              ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">with</span></span> lus lsu <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?all</span> <span class="free">ss</span> <span class="free">ts</span> <span class="main">∧</span> <span class="var">?lt</span> <span class="main">&lt;</span> <span class="var">?ls</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> tu
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ts</span> <span class="free">us</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> st <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="keyword2"><span class="keyword">where</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fst2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">i2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i2</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> st i2 <span class="keyword1"><span class="command">have</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?ls</span> <span class="main">∧</span> <span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ssi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> i2 st <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> fst2 compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i2</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i2</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> i2 snd2 st <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
            ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> fst lsu i2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?all</span> <span class="free">ts</span> <span class="free">us</span> <span class="main">∧</span> <span class="var">?lu</span> <span class="main">≤</span> <span class="var">?lt</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> st <span class="keyword1"><span class="command">have</span></span> lus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lu</span> <span class="main">&lt;</span> <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="var">?lu</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> st tu <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
            ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> lus lsu <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="var">?st</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="var">?tu</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> lengths <span class="keyword1"><span class="command">have</span></span> lsu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lsu</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> st <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ss</span> <span class="free">ts</span> <span class="main">∨</span> <span class="var">?all</span> <span class="free">ss</span> <span class="free">ts</span> <span class="main">∧</span> <span class="var">?lt</span> <span class="main">≤</span> <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tu <span class="keyword1"><span class="command">have</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ts</span> <span class="free">us</span> <span class="main">∨</span> <span class="var">?all</span> <span class="free">ts</span> <span class="free">us</span> <span class="main">∧</span> <span class="var">?lu</span> <span class="main">≤</span> <span class="var">?lt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> st <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="var">?su</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ss</span> <span class="free">ts</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="var">?ls</span> <span class="main">∧</span> <span class="skolem">i1</span> <span class="main">&lt;</span> <span class="var">?lt</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fst1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">i1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i1</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> tu <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ts</span> <span class="free">us</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="keyword2"><span class="keyword">where</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fst2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">i2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i2</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min <span class="skolem">i1</span> <span class="skolem">i2</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> i1 i2 <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> <span class="var">?ls</span> <span class="main">∧</span> <span class="var">?i</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="var">?i</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ssi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="var">?i</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="var">?i</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> snd1 snd2 <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> j i <span class="keyword1"><span class="command">have</span></span> ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="skolem">i2</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">=</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> True fst1 snd2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">ts</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="skolem">i1</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">=</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> True snd1 fst2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ts</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i1</span> <span class="main">&lt;</span> <span class="skolem">i2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">=</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> fst1 fst2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">ts</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ts</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff lsu<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?i</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst snd i<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?all</span> <span class="free">ts</span> <span class="free">us</span> <span class="main">∧</span> <span class="var">?lu</span> <span class="main">≤</span> <span class="var">?lt</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> usi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">i1</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> i1 <span class="keyword1"><span class="command">have</span></span> ssi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">i1</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">i1</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> True tu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> fst1 compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i1</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i1</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> i1 True snd1 tu <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
              ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">with</span></span> fst lsu True i1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span> 
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> i1 <span class="keyword1"><span class="command">have</span></span> lus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lu</span> <span class="main">≤</span> <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="var">?lu</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> False i1 snd1 tu <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
              ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">with</span></span> lus lsu <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?all</span> <span class="free">ss</span> <span class="free">ts</span> <span class="main">∧</span> <span class="var">?lt</span> <span class="main">≤</span> <span class="var">?ls</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> tu
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ex</span> <span class="free">ts</span> <span class="free">us</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> st <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="keyword2"><span class="keyword">where</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fst2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">i2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i2</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> st i2 <span class="keyword1"><span class="command">have</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?ls</span> <span class="main">∧</span> <span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lt</span> <span class="main">∧</span> <span class="skolem">i2</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ssi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> i2 st <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> fst2 compat<span class="main">[</span><span class="operator">OF</span> ssi tsi usi<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i2</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i2</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> i2 snd2 st <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
            ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> fst lsu i2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?all</span> <span class="free">ts</span> <span class="free">us</span> <span class="main">∧</span> <span class="var">?lu</span> <span class="main">≤</span> <span class="var">?lt</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> st <span class="keyword1"><span class="command">have</span></span> lus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lu</span> <span class="main">≤</span> <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="var">?lu</span><span class="main">.</span> <span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="var">?lu</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> st tu <span class="keyword1"><span class="command">have</span></span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">ts</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ts</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
            ssj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> compat<span class="main">[</span><span class="operator">OF</span> ssj tsj usj<span class="main">]</span> snd1 snd2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?snd</span> <span class="free">ss</span> <span class="free">us</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> lus lsu <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lex_ext_stri_imp_nstri <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lex_ext_unbounded_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ss</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ts</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="free">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">r</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ss</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ts</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="free">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">r</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>lex_ext_unbounded <span class="free">r</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span>lex_ext_unbounded <span class="free">r</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>snd <span class="main">(</span>lex_ext_unbounded <span class="free">r</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">⟶</span> snd <span class="main">(</span>lex_ext_unbounded <span class="free">r</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> S NS <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_unbounded_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lex_ext_unbounded_map_S<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ss</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ts</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="free">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">r</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ss</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ts</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="free">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">r</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> stri<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded <span class="free">r</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded <span class="free">r</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lex_ext_unbounded_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">,</span> <span class="operator">OF</span> S NS<span class="main">]</span> stri <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> lex_ext_unbounded_map_NS<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ss</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ts</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="free">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">r</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ss</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ts</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="free">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">r</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nstri<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext_unbounded <span class="free">r</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext_unbounded <span class="free">r</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lex_ext_unbounded_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">,</span> <span class="operator">OF</span> S NS<span class="main">]</span> nstri <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Strong normalization with local SN assumption›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lex_ext_SN<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">⟦</span>snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="bound">ys</span><span class="main">.</span> SN_on <span class="main">{</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">}</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span>lex_ext <span class="free">g</span> <span class="free">m</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">}</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="var">?cond</span> <span class="bound">ys</span> <span class="bound">xs</span> <span class="main">}</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="main">::</span> nat<span class="main">.</span> <span class="var">?cond</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> SN_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> m_imp_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> length <span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> length <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> lm_imp_m_or_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> length <span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">m</span> <span class="main">⟹</span> length <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">∨</span> length <span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> length <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">∨</span> length <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>length <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> length <span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?l0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?l0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> m_imp_m<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> lm_imp_m_or_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> length <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> length <span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lexgr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">.</span> fst <span class="main">(</span>lex_ext <span class="free">g</span> <span class="free">m</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lexge</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">.</span> snd <span class="main">(</span>lex_ext <span class="free">g</span> <span class="free">m</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ge</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?NS</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span><span class="free">g</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?baseSN</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="bound">ys</span><span class="main">.</span> SN_on <span class="var">?S</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?con</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">ys</span> <span class="bound">xs</span> <span class="bound">m'</span><span class="main">.</span> <span class="var">?baseSN</span> <span class="bound">ys</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">≤</span> <span class="bound">m'</span> <span class="main">∧</span> <span class="var">?lexgr</span> <span class="bound">ys</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?confn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">m'</span> <span class="bound">f</span> <span class="bound">n</span> <span class="main">.</span> <span class="var">?con</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="bound">m'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> compat <span class="keyword1"><span class="command">have</span></span> compat2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?NS</span> <span class="keyword1">O</span> <span class="var">?S</span> <span class="main">⊆</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> f len <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="var">?confn</span> <span class="skolem">m'</span> <span class="bound">f</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">m'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?confn</span> <span class="main">0</span> <span class="skolem">f</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>	
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lexgr</span> <span class="main">[]</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> confn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="var">?confn</span> <span class="main">(</span>Suc <span class="skolem">m'</span><span class="main">)</span> <span class="skolem">f</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword1"><span class="command">with</span></span> confn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?hf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> hd <span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="var">?ge</span> <span class="main">(</span><span class="var">?hf</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?hf</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?gr</span> <span class="main">(</span><span class="var">?hf</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?hf</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">from</span></span> ne<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">n</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ne<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> sn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> n sn <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ge</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">∨</span> <span class="var">?gr</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?gr</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?ge</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?gr</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?ge</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> confn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext <span class="free">g</span> <span class="free">m</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?fst</span></span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fst</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n sn lex_ext_def g lex_ext_unbounded.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?fst</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ge</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">∨</span> <span class="var">?gr</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> n sn <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ge</span> <span class="main">(</span><span class="var">?hf</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?hf</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?gr</span> <span class="main">(</span><span class="var">?hf</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?hf</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> ge <span class="keyword1"><span class="command">have</span></span> GE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="var">?hf</span> <span class="bound">n</span><span class="main">,</span> <span class="var">?hf</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?NS</span> <span class="main">∪</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> confn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> ne<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> SN_0<span class="main">:</span> <span class="quoted"><span class="quoted">"SN_on <span class="var">?S</span> <span class="main">{</span><span class="var">?hf</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> non_strict_ending<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?hf</span></span></span><span class="main">,</span> <span class="operator">OF</span> GE compat2 SN_0<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≥</span> <span class="skolem">j</span><span class="main">.</span> <span class="main">(</span><span class="var">?hf</span> <span class="bound">i</span><span class="main">,</span> <span class="var">?hf</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?NS</span> <span class="main">-</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> tl <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="var">?h</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="var">?confn</span> <span class="skolem">m'</span> <span class="skolem">h</span> <span class="bound">n</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nj</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> spec<span class="main">[</span><span class="operator">OF</span> j<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?nj</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> ge_not_gr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?hf</span> <span class="var">?nj</span><span class="main">,</span> <span class="var">?hf</span> <span class="main">(</span>Suc <span class="var">?nj</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?NS</span> <span class="main">-</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> confn<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?nj</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> old<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?confn</span> <span class="main">(</span>Suc <span class="skolem">m'</span><span class="main">)</span> <span class="skolem">f</span> <span class="var">?nj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> ne<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?nj</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="var">?nj</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="var">?nj</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ne<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="var">?nj</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> sn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span>Suc <span class="var">?nj</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span>Suc <span class="var">?nj</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> old <span class="keyword1"><span class="command">have</span></span> one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">h</span> <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> SN_on <span class="var">?S</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h n<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> old <span class="keyword1"><span class="command">have</span></span> two<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">h</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> j n h<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ge_not_gr <span class="keyword1"><span class="command">have</span></span> ge_not_gr2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n sn<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> old <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext <span class="free">g</span> <span class="free">m</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?fst</span></span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> length <span class="skolem">bs</span> <span class="main">∨</span> length <span class="skolem">bs</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_def n sn<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?fst</span>›</span></span><span class="main">[</span><span class="operator">simplified</span> n sn<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded <span class="free">g</span> <span class="skolem">as</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?fst</span></span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> length <span class="skolem">bs</span> <span class="main">∨</span> Suc <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ge_not_gr2 lex_ext_unbounded.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded <span class="free">g</span> <span class="skolem">as</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?fst</span></span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_unbounded_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> three<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lexgr</span> <span class="main">(</span><span class="skolem">h</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_def h n sn ge_not_gr2 lex_ext_unbounded.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?len</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?fst</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> one two three <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?confn</span> <span class="skolem">m'</span> <span class="skolem">h</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Strong normalization with global SN assumption is immediate consequence.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lex_ext_SN_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">⟦</span>snd <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> SN<span class="main">:</span>  <span class="quoted"><span class="quoted">"SN <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>lex_ext <span class="free">g</span> <span class="free">m</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> lex_ext_SN<span class="main">[</span><span class="operator">OF</span> compat<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="bound">ys</span><span class="main">.</span> SN_on <span class="main">{</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">g</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">}</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span>lex_ext <span class="free">g</span> <span class="free">m</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> SN <span class="keyword1"><span class="command">unfolding</span></span> SN_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty list is the least element in the lexicographic extension.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lex_ext_least_1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">m</span> <span class="free">xs</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lex_ext_least_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> fst <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">m</span> <span class="main">[]</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Preservation of totality on lists of same length.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lex_ext_unbounded_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">∨</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∨</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">t</span> <span class="bound">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ss</span> <span class="main">=</span> length <span class="free">ts</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="free">ts</span> <span class="main">∨</span> fst <span class="main">(</span>lex_ext_unbounded <span class="free">f</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∨</span> fst <span class="main">(</span>lex_ext_unbounded <span class="free">f</span> <span class="free">ts</span> <span class="free">ss</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span> 1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span> <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∨</span> fst <span class="main">(</span><span class="free">f</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2-3<span class="main">)</span> refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">t</span> <span class="skolem">t</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_unbounded.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_ext_unbounded.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> lex_ext_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">∨</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∨</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">t</span> <span class="bound">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">ss</span> <span class="main">=</span> length <span class="free">ts</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="free">ts</span> <span class="main">∨</span> fst <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∨</span> fst <span class="main">(</span>lex_ext <span class="free">f</span> <span class="free">n</span> <span class="free">ts</span> <span class="free">ss</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lex_ext_unbounded_total<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_def Let_def len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity of the lexicographic extension.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lex_ext_unbounded_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">;</span> fst <span class="main">(</span><span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">P'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">;</span> snd <span class="main">(</span><span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">P'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>lex_ext_unbounded <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span>lex_ext_unbounded <span class="free">P'</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span>snd <span class="main">(</span>lex_ext_unbounded <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟶</span> snd <span class="main">(</span>lex_ext_unbounded <span class="free">P'</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?l1</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟶</span> <span class="var">?r1</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?l2</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟶</span> <span class="var">?r2</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="skolem">x</span><span class="main"><span class="main">≡</span></span><span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lex_ext_unbounded.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> lex_ext_unbounded.simps
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>TT<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>TF<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">)</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>FT<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>FF<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> TT
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> 4<span class="main">(</span>2<span class="main">)</span> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">(</span>3<span class="main">)</span> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> TF
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">P'</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> 4<span class="main">(</span>2<span class="main">)</span> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> TF
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> 4<span class="main">(</span>2<span class="main">)</span> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> TF
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="main">)</span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> fst_conv snd_conv surj_pair<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> FF <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> FT
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">P'</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> 4<span class="main">(</span>3<span class="main">)</span> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> FT
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l1</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?r1</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FT *<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l2</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?r2</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> 4<span class="main">(</span>3<span class="main">)</span> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> FT
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>1<span class="main">)</span> <span class="main">[</span><span class="operator">OF</span> refl FT <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> FT *
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq nth_Cons_Suc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_unbounded.simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Subterm_and_Context">
<div class="head">
<h1>Theory Subterm_and_Context</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Subterms and Contexts›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define the (proper) sub- and superterm relations on first order terms,
  as well as contexts (you can think of contexts as terms with exactly one hole,
  where we can plug-in another term).
  Moreover, we establish several connections between these concepts as well as
  to other concepts such as substitutions.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Subterm_and_Context
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../First_Order_Terms/Term.html">First_Order_Terms.Term</a>
    <span class="quoted">"<a href="../Abstract-Rewriting/Abstract_Rewriting.html">Abstract-Rewriting.Abstract_Rewriting</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subterms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹superterm›</span></span> relation.›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">supteq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">×</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    refl <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">supteq</span>"</span></span> <span class="main">|</span>
    subt <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">supteq</span> <span class="main">⟹</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">supteq</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹proper superterm›</span></span> relation.›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">supt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">×</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    arg <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">supt</span>"</span></span> <span class="main">|</span>
    subt <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">supt</span> <span class="main">⟹</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">supt</span>"</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> suptp supteqp
<span class="keyword1"><span class="command">hide_fact</span></span>
  suptp.arg suptp.cases suptp.induct suptp.intros suptp.subt suptp_supt_eq
<span class="keyword1"><span class="command">hide_fact</span></span>
  supteqp.cases supteqp.induct supteqp.intros supteqp.refl supteqp.subt supteqp_supteq_eq

<span class="keyword1"><span class="command">hide_fact</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> supt.arg supt.subt supteq.refl supteq.subt


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Syntactic Sugar›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Infix syntax.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">supt_pred</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> supt"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">supteq_pred</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> supteq"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">subt_pred</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> supt_pred <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">subteq_pred</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> supteq_pred <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span>
  supt <span class="main">(</span><span class="quoted">"<span class="keyword1">{⊳}</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  supt_pred <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword1">⊳</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>56<span class="main">,</span> 56<span class="main">]</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  subt_pred <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊲</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  supteq <span class="main">(</span><span class="quoted">"<span class="keyword1">{⊵}</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  supteq_pred <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword1">⊵</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>56<span class="main">,</span> 56<span class="main">]</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  subteq_pred <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊴</span>"</span> 55<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subt</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">{⊲}</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{⊲}</span></span> <span class="main">≡</span> <span class="main">{⊳}</span><span class="main">¯</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subteq</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">{⊴}</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{⊴}</span></span> <span class="main">≡</span> <span class="main">{⊵}</span><span class="main">¯</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Quantifier syntax.›</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_All_supteq"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>idt<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> bool<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∀</span>_<span class="keyword1">⊵</span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_Ex_supteq"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>idt<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> bool<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∃</span>_<span class="keyword1">⊵</span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_All_supt"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>idt<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> bool<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∀</span>_<span class="keyword1">⊳</span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_Ex_supt"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>idt<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> bool<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∃</span>_<span class="keyword1">⊳</span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>

<span class="quoted">"_All_subteq"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>idt<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> bool<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∀</span>_<span class="keyword1">⊴</span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
<span class="quoted">"_Ex_subteq"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>idt<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> bool<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∃</span>_<span class="keyword1">⊴</span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
<span class="quoted">"_All_subt"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>idt<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> bool<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∀</span>_<span class="keyword1">⊲</span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
<span class="quoted">"_Ex_subt"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>idt<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> bool<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∃</span>_<span class="keyword1">⊲</span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>

<span class="comment1">(* for parsing *)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">∀</span><span class="free">x</span><span class="main">⊵</span><span class="free">y</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">∀</span><span class="free">x</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊵</span> <span class="free">y</span> <span class="main">⟶</span> <span class="free">P</span>"</span>
  <span class="quoted">"<span class="main">∃</span><span class="free">x</span><span class="main">⊵</span><span class="free">y</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">∃</span><span class="free">x</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊵</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">P</span>"</span>
  <span class="quoted">"<span class="main">∀</span><span class="free">x</span><span class="main">⊳</span><span class="free">y</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">∀</span><span class="free">x</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊳</span> <span class="free">y</span> <span class="main">⟶</span> <span class="free">P</span>"</span>
  <span class="quoted">"<span class="main">∃</span><span class="free">x</span><span class="main">⊳</span><span class="free">y</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">∃</span><span class="free">x</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊳</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">P</span>"</span>

<span class="quoted">"<span class="main">∀</span><span class="free">x</span><span class="main">⊴</span><span class="free">y</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">∀</span><span class="free">x</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊴</span> <span class="free">y</span> <span class="main">⟶</span> <span class="free">P</span>"</span>
<span class="quoted">"<span class="main">∃</span><span class="free">x</span><span class="main">⊴</span><span class="free">y</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">∃</span><span class="free">x</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊴</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">P</span>"</span>
<span class="quoted">"<span class="main">∀</span><span class="free">x</span><span class="main">⊲</span><span class="free">y</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">∀</span><span class="free">x</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊲</span> <span class="free">y</span> <span class="main">⟶</span> <span class="free">P</span>"</span>
<span class="quoted">"<span class="main">∃</span><span class="free">x</span><span class="main">⊲</span><span class="free">y</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">∃</span><span class="free">x</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊲</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">P</span>"</span>

<span class="comment1">(* for printing *)</span>
<span class="keyword1"><span class="command">print_translation</span></span> <span class="quoted">‹
<span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">All_binder</span> <span class="main">=</span> Mixfix.binder_name <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> All<span class="antiquote">}</span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Ex_binder</span> <span class="main">=</span> Mixfix.binder_name <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> Ex<span class="antiquote">}</span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">impl</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> "implies"<span class="antiquote">}</span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conj</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> "conj"<span class="antiquote">}</span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">supt</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> "supt_pred"<span class="antiquote">}</span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">supteq</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_syntax</span> "supteq_pred"<span class="antiquote">}</span></span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trans</span> <span class="main">=</span>
   <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="entity">All_binder</span><span class="main">,</span> <span class="entity">impl</span><span class="main">,</span> <span class="entity">supt</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"_All_supt"</span><span class="main">,</span> <span class="inner_quoted">"_All_subt"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="main">(</span><span class="entity">All_binder</span><span class="main">,</span> <span class="entity">impl</span><span class="main">,</span> <span class="entity">supteq</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"_All_supteq"</span><span class="main">,</span> <span class="inner_quoted">"_All_subteq"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="main">(</span><span class="entity">Ex_binder</span><span class="main">,</span> <span class="entity">conj</span><span class="main">,</span> <span class="entity">supt</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"_Ex_supt"</span><span class="main">,</span> <span class="inner_quoted">"_Ex_subt"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="main">(</span><span class="entity">Ex_binder</span><span class="main">,</span> <span class="entity">conj</span><span class="main">,</span> <span class="entity">supteq</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"_Ex_supteq"</span><span class="main">,</span> <span class="inner_quoted">"_Ex_subteq"</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">matches_bound</span> <span class="entity">v</span> <span class="entity">t</span> <span class="main">=</span>
     <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"_bound"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ Free <span class="main">(</span><span class="entity">v'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">v</span> <span class="main">=</span> <span class="entity">v'</span><span class="main">)</span>
              <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">contains_var</span> <span class="entity">v</span> <span class="main">=</span> Term.exists_subterm <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> Free <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">v</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk</span> <span class="entity">x</span> <span class="entity">c</span> <span class="entity">n</span> <span class="entity">P</span> <span class="main">=</span> Syntax.const <span class="entity">c</span> $ Syntax_Trans.mark_bound_body <span class="entity">x</span> $ <span class="entity">n</span> $ <span class="entity">P</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tr'</span> <span class="entity">q</span> <span class="main">=</span> <span class="main">(</span><span class="entity">q</span><span class="main">,</span>
    K <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">[</span>Const <span class="main">(</span><span class="inner_quoted">"_bound"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ Free <span class="main">(</span><span class="entity">v</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span><span class="main">,</span> Const <span class="main">(</span><span class="entity">c</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">(</span>Const <span class="main">(</span><span class="entity">d</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t</span> $ <span class="entity">u</span><span class="main">)</span> $ <span class="entity">P</span><span class="main">]</span> <span class="main">=&gt;</span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> AList.lookup <span class="main">(</span><span class="main">=</span><span class="main">)</span> <span class="entity">trans</span> <span class="main">(</span><span class="entity">q</span><span class="main">,</span> <span class="entity">c</span><span class="main">,</span> <span class="entity">d</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Match
      <span class="main">|</span> SOME <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">g</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">matches_bound</span> <span class="entity">v</span> <span class="entity">t</span> <span class="keyword1"><span class="keyword">andalso</span></span> not <span class="main">(</span><span class="entity">contains_var</span> <span class="entity">v</span> <span class="entity">u</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">mk</span> <span class="main">(</span><span class="entity">v</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> <span class="entity">l</span> <span class="entity">u</span> <span class="entity">P</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">matches_bound</span> <span class="entity">v</span> <span class="entity">u</span> <span class="keyword1"><span class="keyword">andalso</span></span> not <span class="main">(</span><span class="entity">contains_var</span> <span class="entity">v</span> <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">mk</span> <span class="main">(</span><span class="entity">v</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> <span class="entity">g</span> <span class="entity">t</span> <span class="entity">P</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Match<span class="main">)</span>
     <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Match<span class="main">)</span><span class="main">)</span><span class="main">;</span>
<span class="keyword2"><span class="keyword">in</span></span> <span class="main">[</span><span class="entity">tr'</span> <span class="entity">All_binder</span><span class="main">,</span> <span class="entity">tr'</span> <span class="entity">Ex_binder</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>
›</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Transitivity Reasoning for Subterms›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supt_trans <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⊳</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊳</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> supt.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> trans_supt<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="main">{⊳}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> supt_trans<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> supteq_trans <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⊵</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊵</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> supteq.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary lemmas about term size.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> size_simp5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set <span class="free">ss</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">⟹</span> size <span class="free">t</span> <span class="main">&lt;</span> size <span class="free">s</span> <span class="main">⟹</span> size <span class="free">t</span> <span class="main">&lt;</span> Suc <span class="main">(</span>size_list size <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_simp6<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set <span class="free">ss</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span> <span class="main">⟹</span> size <span class="free">t</span> <span class="main">≤</span> size <span class="free">s</span> <span class="main">⟹</span> size <span class="free">t</span> <span class="main">≤</span> Suc <span class="main">(</span>size_list size <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_simp1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> size <span class="free">t</span> <span class="main">&lt;</span> Suc <span class="main">(</span>size_list size <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_simp2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> size <span class="free">t</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="main">(</span>size <span class="free">s</span> <span class="main">+</span> size_list size <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_simp3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="free">x</span> <span class="main">&lt;</span> Suc <span class="main">(</span>size_list size <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_zip_leftD <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>  size_simp1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_simp4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="free">y</span> <span class="main">&lt;</span> Suc <span class="main">(</span>size_list size <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_zip_rightD <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> size_simp1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> size_simps <span class="main">=</span>
  size_simp1 size_simp2 size_simp3 size_simp4 size_simp5 size_simp6

<span class="keyword1"><span class="command">declare</span></span> size_simps <span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> supt_size<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">⟹</span> size <span class="free">s</span> <span class="main">&gt;</span> size <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> supt.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_size<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span> <span class="main">⟹</span> size <span class="free">s</span> <span class="main">≥</span> size <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> supteq.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_simps<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reflexivity and Asymmetry.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reflcl_supteq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"supteq<span class="main"><span class="hidden">⇧</span><sup>=</sup></span> <span class="main">=</span> supteq"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> trancl_supteq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"supteq<span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> supteq"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trancl_id<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> supteq_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rtrancl_supteq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"supteq<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> supteq"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trancl_reflcl<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_supteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supt_neqD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">≠</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> supt_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_Var <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> vars_term <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⊵</span> Var <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> vars_term_supteq <span class="main">=</span> supteq_Var

<span class="keyword1"><span class="command">lemma</span></span> term_not_arg <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="free">ss</span> <span class="main">∉</span> set <span class="free">ss</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">∉</span> set <span class="free">ss</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">⊳</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">≠</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> supt_neqD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supt_Fun <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> Fun <span class="free">f</span> <span class="free">ss</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="var">?t</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> set <span class="free">ss</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">⊳</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="var">?t</span> <span class="main">&gt;</span> size <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> supt_size<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">⊳</span> <span class="var">?t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="free">s</span> <span class="main">&gt;</span> size <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> supt_size<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹size <span class="var">?t</span> <span class="main">&gt;</span> size <span class="free">s</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supt_supteq_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">≠</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">≠</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> supt.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>subt <span class="skolem">s</span> <span class="skolem">ss</span> <span class="skolem">t</span> <span class="skolem">f</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊵</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> set <span class="skolem">ss</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">⊵</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">⊵</span> <span class="skolem">t</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊵</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">⊵</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">⊵</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> supteq_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> set <span class="skolem">ss</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">⊳</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">⊳</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> second<span class="main">:</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">≠</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> supt_neqD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> first <span class="keyword2"><span class="keyword">and</span></span> second <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">⊵</span> <span class="skolem">t</span> <span class="main">∧</span> Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">≠</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">≠</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supt_not_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊳</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊳</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> supt_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> supt_supteq_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supt_irrefl<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">t</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> supt_not_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> irrefl_subt<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="main">{⊲}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> irrefl_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supt_imp_supteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> supt_supteq_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supt_supteq_not_supteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="free">t</span> <span class="main">⊵</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> supt_not_sym <span class="keyword1"><span class="command">unfolding</span></span> supt_supteq_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_supt_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">∨</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supt_supteq_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_antisym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊵</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> supteq_supt_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supt_not_sym<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The subterm relation is an order on terms.›</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> subterm<span class="main">:</span> order <span class="quoted"><span class="quoted">"<span class="main">(⊴)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊲)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="main">(</span><span class="operator">rule</span> supt_supteq_not_supteq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> supteq_trans supteq_antisym supt_supteq_not_supteq<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹More transitivity rules.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> supt_supteq_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⊵</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊳</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subterm.le_less_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_supt_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⊳</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊳</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subterm.less_le_trans<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> subterm.le_less_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> subterm.less_le_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> suptE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span> <span class="main">≠</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supt_supteq_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> suptI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span>
  subterm.dual_order.not_eq_order_implies_strict

<span class="keyword1"><span class="command">lemma</span></span> supt_supteq_set_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{⊳}</span> <span class="main">=</span> <span class="main">{⊵}</span> <span class="main">-</span> Id"</span></span>
  <span class="keyword1"><span class="command">using</span></span> supt_supteq_conv <span class="main">[</span><span class="operator">to_set</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_supt_set_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{⊵}</span> <span class="main">=</span> <span class="main">{⊳}</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supt_supteq_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_imp_vars_term_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span> <span class="main">⟹</span> vars_term <span class="free">t</span> <span class="main">⊆</span> vars_term <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> supteq.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_supteq_into_supt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊵</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="free">ts</span> <span class="main">⊳</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">⊵</span> <span class="free">s</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∨</span> <span class="free">t</span> <span class="main">⊳</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> set <span class="free">ts</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊳</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> supt.subt<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> set <span class="free">ts</span>›</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The superterm relation is strongly normalizing.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> SN_supt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SN <span class="main">{⊳}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SN_iff_wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> supt_size<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supt_not_refl<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_not_supt <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_not_supt_conv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{⊵}</span> <span class="main">-</span> <span class="main">{⊳}</span> <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_subst <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊵</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> supteq.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>subt <span class="skolem">u</span> <span class="skolem">ss</span> <span class="skolem">t</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> set <span class="skolem">ss</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊵</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊵</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subst_apply_term.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊵</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> supteq_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supt_subst <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> supt.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>arg <span class="skolem">s</span> <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> subst_apply_term.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> supt.arg<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>subt <span class="skolem">u</span> <span class="skolem">ss</span> <span class="skolem">t</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> set <span class="skolem">ss</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊳</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subst_apply_term.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> supt.arg<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⊳</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> supt_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> subterm_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">s</span></span><span class="main">⊲</span><span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="main">[</span><span class="operator">case_names</span> subterm<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_measure<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">size</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> supt_size<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Contexts›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹context›</span></span> is a term containing exactly one <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹hole›</span></span>.›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>funs_ctxt<span class="main">:</span> <span class="tfree">'f</span><span class="main">,</span> vars_ctxt<span class="main">:</span> <span class="tfree">'v</span><span class="main">)</span> ctxt <span class="main">=</span>
  Hole <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">□</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span> <span class="main">|</span>
  More <span class="tfree"><span class="quoted"><span class="tfree">'f</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term list"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> ctxt"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term list"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We also say that we apply a context~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">C</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to a term~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when we
  replace the hole in a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">C</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ctxt_apply_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> ctxt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">□</span><span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>More <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss1</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">ss2</span></span></span><span class="main">)</span><span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ss1</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ss2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ctxt_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">⟨</span><span class="free">s</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">=</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ctxt_compose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> ctxt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> ctxt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> ctxt"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span>"</span> 75<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">□</span> <span class="keyword1"><span class="free">∘<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>More <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss1</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">ss2</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">∘<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> More <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1"><span class="free">∘<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ss2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> ctxt_monoid_mult<span class="main">:</span> monoid_mult <span class="quoted"><span class="quoted">"<span class="main">□</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(∘<span class="hidden">⇩</span><sub>c</sub>)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="skolem">D</span> <span class="skolem">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> ctxt"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">D</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">E</span> <span class="main">=</span> <span class="skolem">C</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="skolem">D</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">E</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">□</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">C</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">□</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ctxt <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">type</span><span class="main">)</span> <span class="quoted">monoid_mult</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">□</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(*)</span> <span class="main">=</span> <span class="keyword1">(∘<span class="hidden">⇩</span><sub>c</sub>)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ctxt_ctxt_compose <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">D</span><span class="main">)</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">C</span><span class="main">⟨</span><span class="free">D</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemmas</span></span> ctxt_ctxt <span class="main">=</span> ctxt_ctxt_compose <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Applying substitutions to contexts.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_apply_ctxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> ctxt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> gsubst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> ctxt"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span>"</span> 67<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">□</span> <span class="keyword1"><span class="free">⋅<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">□</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>More <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss1</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">ss2</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⋅<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> More <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ss1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1"><span class="free">⋅<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ss2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_apply_term_ctxt_apply_distrib <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span> <span class="main">⋅</span> <span class="free">μ</span> <span class="main">=</span> <span class="main">(</span><span class="free">C</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">μ</span><span class="main">)</span><span class="main">⟨</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">μ</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_compose_ctxt_compose_distrib <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">D</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="free">C</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">σ</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="free">D</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ctxt_compose_subst_compose_distrib <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">C</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">σ</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Connection between Contexts and the Superterm Relation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ctxt_imp_supteq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_ctxtE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>refl <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">□</span><span class="main">⟨</span><span class="skolem">s</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> refl<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>subt <span class="skolem">u</span> <span class="skolem">ss</span> <span class="skolem">t</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">C</span><span class="main">⟨</span><span class="skolem">t</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> set <span class="skolem">ss</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss1</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ss2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="skolem">ss1</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">#</span> <span class="skolem">ss2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">=</span> <span class="main">(</span>More <span class="skolem">f</span> <span class="skolem">ss1</span> <span class="skolem">C</span> <span class="skolem">ss2</span><span class="main">)</span><span class="main">⟨</span><span class="skolem">t</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">C</span><span class="main">⟨</span><span class="skolem">t</span><span class="main">⟩</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> subt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">best</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ctxt_supteq<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Hole <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>More <span class="skolem">f</span> <span class="skolem">ss1</span> <span class="skolem">D</span> <span class="skolem">ss2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> Fun <span class="skolem">f</span> <span class="main">(</span><span class="skolem">ss1</span> <span class="main">@</span> <span class="skolem">D</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span> <span class="main">#</span> <span class="skolem">ss2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> Fun <span class="main">_</span> <span class="var">?ss</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span> <span class="main">∈</span> set <span class="var">?ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">D</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> s <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_ctxt_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="bound">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supt_ctxtE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">□</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>arg <span class="skolem">s</span> <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> set <span class="skolem">ss</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss1</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ss2</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="skolem">ss1</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">ss2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"More <span class="skolem">f</span> <span class="skolem">ss1</span> <span class="main">□</span> <span class="skolem">ss2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">≠</span> <span class="main">□</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">=</span> <span class="var">?C</span><span class="main">⟨</span><span class="skolem">s</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ss<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> arg <span class="keyword1"><span class="command">by</span></span> <span class="operator">best</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>subt <span class="skolem">s</span> <span class="skolem">ss</span> <span class="skolem">t</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≠</span> <span class="main">□</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">C</span><span class="main">⟨</span><span class="skolem">t</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> set <span class="skolem">ss</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss1</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ss2</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="skolem">ss1</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">ss2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"More <span class="skolem">f</span> <span class="skolem">ss1</span> <span class="skolem">C</span> <span class="skolem">ss2</span> <span class="main">≠</span> <span class="main">□</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">=</span> <span class="main">(</span>More <span class="skolem">f</span> <span class="skolem">ss1</span> <span class="skolem">C</span> <span class="skolem">ss2</span><span class="main">)</span><span class="main">⟨</span><span class="skolem">t</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">C</span><span class="main">⟨</span><span class="skolem">t</span><span class="main">⟩</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ss<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subt<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">best</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ctxt_supt<span class="main">[</span><span class="operator">intro</span> 2<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">□</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Hole <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>More <span class="skolem">f</span> <span class="skolem">ss1</span> <span class="skolem">D</span> <span class="skolem">ss2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> Fun <span class="skolem">f</span> <span class="main">(</span><span class="skolem">ss1</span> <span class="main">@</span> <span class="skolem">D</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span> <span class="main">#</span> <span class="skolem">ss2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">ss1</span> <span class="main">@</span> <span class="skolem">D</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span> <span class="main">#</span> <span class="skolem">ss2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="skolem">D</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">D</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supt_ctxt_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">≠</span> <span class="main">□</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="bound">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="skolem">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="free">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≠</span> <span class="main">□</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="skolem">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nectxt_imp_supt_ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">□</span> <span class="main">⟹</span> <span class="free">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supt_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>Var <span class="free">x</span> <span class="main">⊳</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Var <span class="free">x</span> <span class="main">⊳</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≠</span> <span class="main">□</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Var <span class="free">x</span> <span class="main">=</span> <span class="skolem">C</span><span class="main">⟨</span><span class="free">u</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supt_const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span> <span class="main">⊳</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="main">[]</span> <span class="main">⊳</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≠</span> <span class="main">□</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="main">[]</span> <span class="main">=</span> <span class="skolem">C</span><span class="main">⟨</span><span class="free">u</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_var_imp_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free">x</span> <span class="main">⊵</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="main">=</span> Var <span class="free">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">_</span> <span class="main">=</span> <span class="var">?x</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Var <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Var <span class="free">x</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> st <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">=</span> <span class="skolem">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">best</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Var_supt <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Var <span class="free">x</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms supt_var<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Fun_supt <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="free">ts</span> <span class="main">⊳</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊵</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supt_supteq_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inj_ctxt_apply_term<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>ctxt_apply_term <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ctxt_subst_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> vars_ctxt <span class="free">C</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">τ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">C</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">σ</span> <span class="main">=</span> <span class="free">C</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>More <span class="skolem">f</span> <span class="skolem">bef</span> <span class="skolem">C</span> <span class="skolem">aft</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">bef</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t More<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> term_subst_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">aft</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t More<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> term_subst_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">σ</span> <span class="main">=</span> <span class="skolem">C</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> More <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Term_Aux">
<div class="head">
<h1>Theory Term_Aux</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliaries›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Term_Aux
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Subterm_and_Context.html">Subterm_and_Context</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This theory contains material about terms that is required for KBO, 
  but does not belong to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Subterm_and_Context.html"></a><a href="Subterm_and_Context.html">Knuth_Bendix_Order.Subterm_and_Context</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  We plan to merge this material into the theory <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="../First_Order_Terms/Term.html"></a><a href="../First_Order_Terms/Term.html">First_Order_Terms.Term</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  at some point.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The variables of a term as multiset.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">vars_term_ms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="tfree">'v</span> multiset"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">vars_term_ms</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#}</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">vars_term_ms</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="main">(</span>map <span class="free">vars_term_ms</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_term_ms_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>image_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> vars_term_ms <span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>vars_term_ms <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?V</span> <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> vars_term_ms <span class="main">(</span><span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?V</span> <span class="bound">t</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl Fun<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_term_ms_subst_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="free">s</span> <span class="main">⊆#</span> vars_term_ms <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> mset_subset_eq_exists_conv<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="free">t</span> <span class="main">=</span> vars_term_ms <span class="free">s</span> <span class="main">+</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> vars_term_ms_subst <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_mset_vars_term_ms <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>vars_term_ms <span class="free">t</span><span class="main">)</span> <span class="main">=</span> vars_term <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A term is called <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹ground›</span></span> if it does not contain any variables.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ground</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ground</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">⟷</span> False"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">ground</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="free">ground</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ground_vars_term_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ground <span class="free">t</span> <span class="main">⟷</span> vars_term <span class="free">t</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ground <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> vars_term <span class="free">t</span><span class="main">.</span> ground <span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_subst_apply<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ground <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> Var"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> term_subst_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ground_vars_term_empty<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹signature›</span></span> is a set of function symbol/arity pairs, where the arity of a function symbol,
  denotes the number of arguments it expects.
›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'f</span> sig <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> nat<span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of all function symbol/ arity pairs occurring in a term.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">funas_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="tfree">'f</span> sig"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">funas_term</span> <span class="main">(</span>Var <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">funas_term</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map <span class="free">funas_term</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> supt_imp_funas_term_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"funas_term <span class="free">t</span> <span class="main">⊆</span> funas_term <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supteq_imp_funas_term_subset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"funas_term <span class="free">t</span> <span class="main">⊆</span> funas_term <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of all function symbol/arity pairs occurring in a context.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">funas_ctxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> ctxt <span class="main">⇒</span> <span class="tfree">'f</span> sig"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">funas_ctxt</span> Hole <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">funas_ctxt</span> <span class="main">(</span>More <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss1</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">ss2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> Suc <span class="main">(</span>length <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ss1</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ss2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
     <span class="main">∪</span> <span class="free">funas_ctxt</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map funas_term <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ss1</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ss2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> funas_term_ctxt_apply <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"funas_term <span class="main">(</span><span class="free">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> funas_ctxt <span class="free">C</span> <span class="main">∪</span> funas_term <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> funas_term_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"funas_term <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> funas_term <span class="free">t</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>funas_term <span class="main">`</span> <span class="free">σ</span> <span class="main">`</span> vars_term <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> funas_ctxt_compose <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"funas_ctxt <span class="main">(</span><span class="free">C</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> funas_ctxt <span class="free">C</span> <span class="main">∪</span> funas_ctxt <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> funas_ctxt_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"funas_ctxt <span class="main">(</span><span class="free">C</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> funas_ctxt <span class="free">C</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>funas_term <span class="main">`</span> <span class="free">σ</span> <span class="main">`</span> vars_ctxt <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> funas_term_subst<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="KBO">
<div class="head">
<h1>Theory KBO</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹KBO›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Below, we formalize a variant of KBO that includes subterm coefficient functions.

  A more standard definition is obtained by setting all subterm coefficients to 1.
  For this special case it would be possible to define more efficient code-equations that
  do not have to evaluate subterm coefficients at all.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> KBO
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Lexicographic_Extension.html">Lexicographic_Extension</a>
    <a href="Term_Aux.html">Term_Aux</a>
    <a href="../Polynomial_Factorization/Missing_List.html">Polynomial_Factorization.Missing_List</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subterm Coefficient Functions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given a function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">scf</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, associating positions with subterm coefficients, and
  a list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">scf_list</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> yields an expanded list where  each
  element of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is replicated a number of times according to its subterm coefficient.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">scf_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">scf_list</span> <span class="free"><span class="bound"><span class="entity">scf</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> replicate <span class="main">(</span><span class="free"><span class="bound"><span class="entity">scf</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_scf_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="free">scf</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>scf_list <span class="free">scf</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scf_list_def set_zip set_conv_nth<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scf_list_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>scf_list <span class="free">scf</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scf_list_def set_zip<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scf_list_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"scf_list <span class="free">scf</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scf_list_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scf_list_bef_i_aft <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"scf_list <span class="free">scf</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">i</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span> <span class="main">=</span>
    scf_list <span class="free">scf</span> <span class="free">bef</span> <span class="main">@</span> replicate <span class="main">(</span><span class="free">scf</span> <span class="main">(</span>length <span class="free">bef</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">@</span>
    scf_list <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">scf</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">bef</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">aft</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> scf_list_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">aft</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">aft</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bia</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bia</span> <span class="main">=</span> <span class="free">bef</span> <span class="main">@</span> <span class="free">i</span> <span class="main">#</span> <span class="skolem">aft</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> bia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bef</span> <span class="main">@</span> <span class="free">i</span> <span class="main">#</span> <span class="skolem">aft</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">bia</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bia_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> zip<span class="main">:</span> <span class="quoted"><span class="quoted">"zip <span class="main">(</span><span class="skolem">bia</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">bia</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>
   <span class="main">=</span> zip <span class="skolem">bia</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">bia</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> length <span class="skolem">bia</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> concat<span class="main">:</span>
    <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> replicate <span class="main">(</span><span class="free">scf</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">bia</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">bia</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> length <span class="skolem">bia</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> replicate <span class="main">(</span><span class="free">scf</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">bia</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">bia</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span>
      replicate <span class="main">(</span><span class="free">scf</span> <span class="main">(</span>length <span class="skolem">bia</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bia zip concat
    <span class="keyword1"><span class="command">unfolding</span></span> bia_def snoc
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> scf_list_map <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"scf_list <span class="free">scf</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>scf_list <span class="free">scf</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scf_list_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">scf_term</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> replicates each argument a number of times according to its
  subterm coefficient function.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">scf_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">scf_term</span> <span class="free"><span class="bound"><span class="entity">scf</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">scf_term</span> <span class="free"><span class="bound"><span class="entity">scf</span></span></span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>scf_list <span class="main">(</span><span class="free"><span class="bound"><span class="entity">scf</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="free">scf_term</span> <span class="free"><span class="bound"><span class="entity">scf</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_term_scf_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_term <span class="main">(</span>scf_term <span class="free">scf</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> vars_term <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_term <span class="main">(</span>scf_term <span class="free">scf</span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>scf_list <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">.</span> vars_term <span class="main">(</span>scf_term <span class="free">scf</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">ss</span><span class="main">.</span> vars_term <span class="main">(</span>scf_term <span class="free">scf</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> scf_list_subset <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">ss</span><span class="main">.</span> vars_term <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Fun <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> scf_term_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"scf_term <span class="free">scf</span> <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> scf_term <span class="free">scf</span> <span class="free">t</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> scf_term <span class="free">scf</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="main">(</span>scf_list <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> scf_list_subset <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"scf_term <span class="free">scf</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> scf_term <span class="free">scf</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> scf_term <span class="free">scf</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Fun<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weight Functions›</span></span>

<span class="keyword1"><span class="command">locale</span></span> weight_fun <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">w0</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">scf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹weight›</span></span> of a term is computed recursively, where variables have weight <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">w0</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  and the weight of a compound term is computed by adding the weight of its root symbol
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">w</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">n</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the weighted sum where weights of arguments are multiplied
  according to their subterm coefficients.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">weight</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">weight</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">w0</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">weight</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">;</span> <span class="bound">scff</span> <span class="main">=</span> <span class="free">scf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="free">w</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">ti</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="free">weight</span> <span class="bound">ti</span> <span class="main">*</span> <span class="bound">scff</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="bound">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Alternatively, we can replicate arguments via <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> scf_list<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  The advantage is that then both <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> weight<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> scf_term<span class="antiquote"><span class="antiquote">}</span></span></span></span> are defined
  via <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> scf_list<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> weight_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"weight <span class="main">(</span>Fun <span class="free">f</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">scff</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">scff</span> <span class="main">=</span> <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span> <span class="main">::</span> nat <span class="main">⇒</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">ti</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">←</span> zip <span class="free">ts</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ts</span><span class="main">]</span><span class="main">.</span> weight <span class="bound">ti</span> <span class="main">*</span> <span class="skolem">scff</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span>
   sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="skolem">scff</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>replicate <span class="skolem">n</span> <span class="main">(</span>weight <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">*</span> weight <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scf_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def scff_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> weight.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">SCF</span> <span class="main">≡</span> scf_term <span class="free">scf</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_scf_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ts</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="free">ts</span><span class="main">)</span> <span class="main">≤</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="free">f</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> scf_list_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="skolem">ts</span><span class="main">)</span> <span class="main">≤</span>
    sum_list <span class="main">(</span>map weight <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> replicate <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">ts</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">ts</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> snoc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> snoc<span class="main">(</span>2<span class="main">)</span> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lessE<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of KBO›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The precedence is given by three parameters:

  <span class="antiquoted"><span class="antiquoted">▪</span></span> a predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">pr_strict</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for strict decrease between two function symbols,
  <span class="antiquoted"><span class="antiquoted">▪</span></span> a predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">pr_weak</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for weak decrease between two function symbols, and
  <span class="antiquoted"><span class="antiquoted">▪</span></span> a function indicating whether a symbol is least in the precedence.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> kbo <span class="main">=</span> weight_fun <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">w0</span></span> <span class="quoted"><span class="free">scf</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">w</span> <span class="free">w0</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">scf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">least</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">pr_strict</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">pr_weak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The result of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">kbo</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a pair of Booleans encoding strict/weak decrease.

  Interestingly, the bound on the lengths of the lists in the lexicographic extension is not 
  required for KBO.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">kbo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> bool <span class="main">×</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">kbo</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>vars_term_ms <span class="main">(</span>SCF <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span> weight <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≤</span> weight <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
      <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="main">(</span>weight <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">&lt;</span> weight <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
        <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
        <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
          Var <span class="bound">y</span> <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Var <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">|</span> Fun <span class="bound">g</span> <span class="bound">ts</span> <span class="main">⇒</span> <span class="bound">ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">least</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> Fun <span class="bound">f</span> <span class="bound">ss</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
            Var <span class="bound">x</span> <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
          <span class="main">|</span> Fun <span class="bound">g</span> <span class="bound">ts</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free">pr_strict</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span>
            <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
            <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">pr_weak</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span>
            <span class="keyword1">then</span> lex_ext_unbounded <span class="free">kbo</span> <span class="bound">ss</span> <span class="bound">ts</span>
            <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abbreviations for strict (S) and nonstrict (NS) KBO.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> fst <span class="main">(</span>kbo <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">NS</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> snd <span class="main">(</span>kbo <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For code-generation we do not compute the weights of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> repeatedly.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> kbo_code<span class="main">:</span> <span class="quoted"><span class="quoted">"kbo <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">wt</span> <span class="main">=</span> weight <span class="free">t</span><span class="main">;</span> <span class="bound">ws</span> <span class="main">=</span> weight <span class="free">s</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="main">(</span>vars_term_ms <span class="main">(</span>SCF <span class="free">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">wt</span> <span class="main">≤</span> <span class="bound">ws</span><span class="main">)</span>
    <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="bound">wt</span> <span class="main">&lt;</span> <span class="bound">ws</span>
      <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">s</span> <span class="keyword1">of</span>
        Var <span class="bound">y</span> <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span> Var <span class="bound">x</span> <span class="main">⇒</span> True <span class="main">|</span> Fun <span class="bound">g</span> <span class="bound">ts</span> <span class="main">⇒</span> <span class="bound">ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">least</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> Fun <span class="bound">f</span> <span class="bound">ss</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span>
          Var <span class="bound">x</span> <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
        <span class="main">|</span> Fun <span class="bound">g</span> <span class="bound">ts</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">ff</span> <span class="main">=</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span><span class="main">;</span> <span class="bound">gg</span> <span class="main">=</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span> <span class="keyword1">in</span>
          <span class="keyword1">if</span> <span class="free">pr_strict</span> <span class="bound">ff</span> <span class="bound">gg</span>
          <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span>
          <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">pr_weak</span> <span class="bound">ff</span> <span class="bound">gg</span>
            <span class="keyword1">then</span> lex_ext_unbounded kbo <span class="bound">ss</span> <span class="bound">ts</span>
            <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kbo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> kbo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> term.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> kbo.kbo_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> weight_fun.weight.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_replicate_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">⊆#</span> <span class="free">m2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="main">(</span>replicate <span class="free">n</span> <span class="free">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="main">(</span>replicate <span class="free">n</span> <span class="free">m2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="main">(</span>replicate <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="main">(</span>replicate <span class="skolem">n</span> <span class="free">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">m1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="main">(</span>replicate <span class="skolem">n</span> <span class="free">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">m2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m1</span> <span class="main">⊆#</span> <span class="free">m2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆#</span> <span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">(</span>mset <span class="main">(</span>replicate <span class="skolem">n</span> <span class="free">m2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">m2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  While the locale <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> kbo<span class="antiquote"><span class="antiquote">}</span></span></span></span> only fixes its parameters, we now demand that these
  parameters are sensible, e.g., encoding a well-founded precedence, etc.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> admissible_kbo <span class="main">=</span>
  kbo <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">w0</span></span> <span class="quoted"><span class="free">scf</span></span> <span class="quoted"><span class="free">least</span></span> <span class="quoted"><span class="free">pr_strict</span></span> <span class="quoted"><span class="free">pr_weak</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">w</span> <span class="free">w0</span> <span class="free">pr_strict</span> <span class="free">pr_weak</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">least</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'f</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">scf</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">≥</span> <span class="free">w0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w0</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> adm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">pr_weak</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">least</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">w0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">g</span><span class="main">.</span> <span class="free">w</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">w0</span> <span class="main">⟶</span> <span class="free">pr_weak</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> scf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">scf</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pr_weak_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="free">fn</span> <span class="free">fn</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pr_weak_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="free">fn</span> <span class="free">gm</span> <span class="main">⟹</span> <span class="free">pr_weak</span> <span class="free">gm</span> <span class="free">hk</span> <span class="main">⟹</span> <span class="free">pr_weak</span> <span class="free">fn</span> <span class="free">hk</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pr_strict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_strict</span> <span class="free">fn</span> <span class="free">gm</span> <span class="main">⟷</span> <span class="free">pr_weak</span> <span class="free">fn</span> <span class="free">gm</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">pr_weak</span> <span class="free">gm</span> <span class="free">fn</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pr_SN<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span><span class="main">(</span><span class="bound">fn</span><span class="main">,</span> <span class="bound">gm</span><span class="main">)</span><span class="main">.</span> <span class="free">pr_strict</span> <span class="bound">fn</span> <span class="bound">gm</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weight_w0<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="free">t</span> <span class="main">≥</span> <span class="free">w0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">with</span></span> w0<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w0</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> scf<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> scf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> scf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lessE<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> i <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bef</span></span> <span class="skolem"><span class="skolem">aft</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">bef</span> <span class="main">@</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">aft</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bef</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tsi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tsi</span> <span class="main">=</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> ts <span class="main">=</span> ts<span class="main">[</span><span class="operator">folded</span> tsi_def<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> tsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tsi</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tsi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Fun<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> w0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w0</span> <span class="main">≤</span> weight <span class="skolem">tsi</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> scf ii w0 <span class="keyword1"><span class="command">unfolding</span></span> ts
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> weight_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> weight_w0 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> w0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

<span class="keyword1"><span class="command">lemma</span></span> weight_0 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="free">t</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> weight_gt_0 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> not_S_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> S <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> weight_w0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> S_imp_NS<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> NS <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> kbo.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> S <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="skolem">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> weight <span class="skolem">t</span> <span class="main">≤</span> weight <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> S <span class="main">=</span> S w
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> w<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">t</span> <span class="main">&lt;</span> weight <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> S <span class="main">=</span> S False
    <span class="keyword1"><span class="command">from</span></span> not_S_Var<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> S
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> s<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Var s<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> Fun<span class="main">]</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lex</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lex_ext_unbounded kbo <span class="skolem">ss</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> S<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">unfolded</span> s Fun<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">∨</span> <span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span> <span class="main">∧</span> fst <span class="var">?lex</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> S s Fun <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> disj <span class="keyword1"><span class="command">have</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="var">?lex</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> False fg<span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> lex <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext kbo <span class="main">(</span>length <span class="skolem">ss</span> <span class="main">+</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> lex_ext_stri_imp_nstri<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="var">?lex</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> False fg S s Fun <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reflexivity and Irreflexivity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> NS_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="free">s</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext kbo <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="skolem">ss</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> all_nstri_imp_lex_nstri<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Fun<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> set_conv_nth<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext_unbounded kbo <span class="skolem">ss</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pr_strict_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">pr_strict</span> <span class="free">fn</span> <span class="free">fn</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pr_strict <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> S_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> S <span class="free">t</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> not_S_Var<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> pr_strict_irrefl <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">pr_strict</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded kbo <span class="skolem">ts</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"S <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_unbounded_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Fun <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity (a.k.a. Closure under Contexts)›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_mono_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"S <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">ss1</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">ss2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">ss1</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">ss2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">ss1</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">ss2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">ss1</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">ss2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="var">?ss</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="var">?ts</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> S <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="free">t</span> <span class="main">≤</span> weight <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="free">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="free">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> v'<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="var">?t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_replicate_mono<span class="main">[</span><span class="operator">OF</span> v<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> w'<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="var">?t</span> <span class="main">≤</span> weight <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_list_replicate_mono<span class="main">[</span><span class="operator">OF</span> w<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded kbo <span class="var">?ss</span> <span class="var">?ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_unbounded_iff fst_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="free"><span class="free"><span class="free">ss1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> S NS_refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> kbo.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> v' w' lex <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> S <span class="main">(</span><span class="free">C</span><span class="main">⟨</span><span class="free">s</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> kbo.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_mono_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> NS_mono_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="free">s</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NS <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">ss1</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">ss2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">ss1</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">ss2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">ss1</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">ss2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">ss1</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">ss2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="var">?ss</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="var">?ts</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> NS <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="free">t</span> <span class="main">≤</span> weight <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="free">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> v'<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="var">?t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_replicate_mono<span class="main">[</span><span class="operator">OF</span> v<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> w'<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="var">?t</span> <span class="main">≤</span> weight <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_list_replicate_mono<span class="main">[</span><span class="operator">OF</span> w<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext_unbounded kbo <span class="var">?ss</span> <span class="var">?ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_unbounded_iff snd_conv
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> disjI2 conjI allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">ss1</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">ss2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"NS <span class="main">(</span><span class="var">?ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NS NS_refl
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> length <span class="free">ss1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> kbo.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> v' w' lex <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> NS_ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> NS <span class="main">(</span><span class="free">C</span><span class="main">⟨</span><span class="free">s</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> kbo.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> NS_mono_one<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Subterm Property›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> NS_Var_imp_eq_least<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> Var <span class="free">x</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> Fun <span class="bound">f</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">least</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> weight_w0<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> kbo_supt_one<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="free">s</span> <span class="main">(</span><span class="free">t</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term<span class="main">)</span> <span class="main">⟹</span> S <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">bef</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="free">aft</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">bef</span></span> <span class="quoted"><span class="free">aft</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> NS <span class="main">=</span> this
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">bef</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">aft</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Var <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bef</span> <span class="main">&lt;</span> length <span class="var">?ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> scf<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> scf<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="var">?ss</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">bef</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lessE<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="main">(</span>Fun <span class="skolem">f</span> <span class="var">?ss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> vars_term_ms <span class="main">(</span>SCF <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def scf<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="skolem">s</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="main">(</span>Fun <span class="skolem">f</span> <span class="var">?ss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> NS <span class="keyword1"><span class="command">have</span></span> vt<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="var">?t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> vt vs <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="var">?t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="main">(</span>Fun <span class="skolem">f</span> <span class="var">?ss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_mset.order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> weight_w0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="var">?ss</span>"</span></span><span class="main">]</span> v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span> <span class="skolem">f</span> <span class="skolem">s</span> <span class="skolem">bef</span> <span class="skolem">aft</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">bef</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">aft</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> NS <span class="main">=</span> Fun<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Fun<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bef</span> <span class="main">&lt;</span> length <span class="var">?ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> scf<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> scff<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="var">?ss</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">bef</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lessE<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> scff <span class="main">=</span> scff<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="main">(</span>Fun <span class="skolem">f</span> <span class="var">?ss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> vars_term_ms <span class="main">(</span>SCF <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def scff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="skolem">s</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="main">(</span>Fun <span class="skolem">f</span> <span class="var">?ss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ws<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">s</span> <span class="main">≤</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="var">?ss</span><span class="main">)</span><span class="main">)</span> <span class="var">?ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> NS <span class="keyword1"><span class="command">have</span></span> wt<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="var">?t</span> <span class="main">≤</span> weight <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    vt<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="var">?t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ws wt <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="var">?t</span> <span class="main">≤</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="var">?ss</span><span class="main">)</span><span class="main">)</span> <span class="var">?ss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> vt vs <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="var">?t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="main">(</span>Fun <span class="skolem">f</span> <span class="var">?ss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> v'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vars_term_ms <span class="main">(</span>SCF <span class="var">?t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="main">(</span>Fun <span class="skolem">f</span> <span class="var">?ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"weight <span class="var">?t</span> <span class="main">=</span> weight <span class="main">(</span>Fun <span class="skolem">f</span> <span class="var">?ss</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> w v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> wt<span class="main">[</span><span class="operator">unfolded</span> True<span class="main">]</span> weight_gt_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="var">?ss</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> lsum<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="var">?ss</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bef</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="var">?ss</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">bef</span><span class="main">)</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">aft</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="skolem">bef</span><span class="main">)</span> <span class="main">≤</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="var">?ss</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bef</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_scf_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> scf<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> lsum<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="skolem">bef</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bef</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> weight_gt_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">bef</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bef</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="skolem">aft</span><span class="main">)</span> <span class="main">≤</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="var">?ss</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">bef</span><span class="main">)</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">aft</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_scf_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> scf<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> lsum<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="skolem">aft</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> aft<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aft</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> weight_gt_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">aft</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">aft</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> scff <span class="main">=</span> scff<span class="main">[</span><span class="operator">unfolded</span> bef aft n<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> bef aft
    <span class="keyword1"><span class="command">have</span></span> ba<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bef</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">aft</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">have</span></span> wst<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">s</span> <span class="main">=</span> weight <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> scff <span class="keyword1"><span class="command">unfolding</span></span> True<span class="main">[</span><span class="operator">unfolded</span> ba<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scf_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> w v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ba <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">note</span></span> admf <span class="main">=</span> adm<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> admf <span class="keyword1"><span class="command">have</span></span> pg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> pg False<span class="main">[</span><span class="operator">unfolded</span> pr_strict<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?g</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> pr_weak_trans<span class="main">[</span><span class="operator">OF</span> this admf<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">h</span> <span class="bound">k</span><span class="main">.</span> <span class="free">pr_weak</span> <span class="var">?g</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded kbo <span class="main">[</span><span class="skolem">s</span><span class="main">]</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Nil lex_ext_unbounded_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> pg w v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ba <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">tts</span><span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Var <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> NS_Var_imp_eq_least<span class="main">[</span><span class="operator">OF</span> NS<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> s Cons<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Fun <span class="skolem">h</span> <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> NS wst g<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span>"</span></span><span class="main">]</span> pr_strict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext_unbounded kbo <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> lex <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s0</span></span> <span class="skolem"><span class="skolem">sss</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="skolem">s0</span> <span class="main">#</span> <span class="skolem">sss</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons lex_ext_unbounded_iff snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ss</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> lex<span class="main">[</span><span class="operator">unfolded</span> ss Cons<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="skolem">s0</span> <span class="skolem">t</span> <span class="main">∨</span> NS <span class="skolem">s0</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"kbo <span class="skolem">s0</span> <span class="skolem">t</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_ext_unbounded.simps <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> kbo.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> S_imp_NS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s0</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NS <span class="skolem">s0</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">h</span></span> <span class="quoted">Nil</span> <span class="quoted"><span class="skolem">sss</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons s ss <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded kbo <span class="main">[</span><span class="skolem">s</span><span class="main">]</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons
          <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_unbounded_iff fst_conv
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> exI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> S<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> kbo.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded kbo <span class="main">[</span><span class="skolem">s</span><span class="main">]</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">note</span></span> all <span class="main">=</span> lex wst<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> S pg scff v'
        <span class="keyword1"><span class="command">note</span></span> all <span class="main">=</span> all<span class="main">[</span><span class="operator">unfolded</span> ba<span class="main">,</span> <span class="operator">unfolded</span> s ss Cons<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span>Fun <span class="skolem">f</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> weight <span class="main">(</span><span class="skolem">t</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
          <span class="keyword1"><span class="command">using</span></span> wf scff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scf_list_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ba <span class="keyword1"><span class="command">unfolding</span></span> s ss Cons
          <span class="keyword1"><span class="command">unfolding</span></span> kbo.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="main">[</span>Fun <span class="skolem">h</span> <span class="main">(</span><span class="skolem">s0</span> <span class="main">#</span> <span class="skolem">sss</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> all w <span class="keyword1"><span class="command">using</span></span> all <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_supt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> supt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊳</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"S <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> supt <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="skolem">C</span><span class="main">⟨</span><span class="free">t</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≠</span> <span class="main">□</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> s <span class="keyword1"><span class="command">using</span></span> C
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>More <span class="skolem">f</span> <span class="skolem">bef</span> <span class="skolem">C</span> <span class="skolem">aft</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">□</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> kbo_supt_one<span class="main">[</span><span class="operator">OF</span> NS_refl<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">bef</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">aft</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> kbo_supt_one<span class="main">[</span><span class="operator">OF</span> S_imp_NS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> More<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> False<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">bef</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">aft</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> NS_supteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊵</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NS <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> S_imp_NS<span class="main">[</span><span class="operator">OF</span> S_supt<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> NS_refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> subterm.le_less<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Least Elements›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> NS_all_least<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">least</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NS <span class="free">t</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">]</span> l
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Fun<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NS <span class="skolem">s</span> <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> S_imp_NS<span class="main">[</span><span class="operator">OF</span> kbo_supt_one<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted">Nil</span> <span class="quoted"><span class="skolem">ss</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">from</span></span> weight_w0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">g</span> <span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span>Fun <span class="skolem">g</span> <span class="main">[]</span><span class="main">)</span> <span class="main">≥</span> weight <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> lex_ext_least_1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext kbo <span class="main">0</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext_unbounded kbo <span class="main">[]</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> w l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> Fun Nil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> empty_le<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_S_least<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">least</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> S <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Fun
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> S<span class="main">[</span><span class="operator">unfolded</span> Fun<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> weight <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> w <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> weight <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span><span class="main">)</span> <span class="main">≤</span> <span class="free">w0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">w0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  w0<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> w Nil l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> gf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> S <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Nil
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pr_strict<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> g<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> p p2 gf S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded kbo <span class="main">[]</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Nil
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pr_strict<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_unbounded_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> scf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> scff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">scf</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lessE<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="main">(</span>
          scf_list <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">scf</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> Suc <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ss</span>
          <span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w0</span> <span class="main">+</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>replicate <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> weight <span class="skolem">s</span> <span class="main">+</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>replicate <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> weight_w0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>replicate <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> scff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">+</span> <span class="main">…</span> <span class="main">+</span> <span class="var">?e</span> <span class="main">≤</span> <span class="free">w0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ts scf_list_bef_i_aft <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w0</span> <span class="main">+</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>replicate <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">+</span> <span class="var">?e</span> <span class="main">≤</span> <span class="free">w0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> null<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="main">(</span>replicate <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> null<span class="main">(</span>2<span class="main">)</span> weight_gt_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="skolem">ss</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_scf_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> scf<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> null<span class="main">]</span> weight_gt_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">ss</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ss</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">note</span></span> scff <span class="main">=</span> scff<span class="main">[</span><span class="operator">unfolded</span> ts n<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> wg ts <span class="keyword1"><span class="command">have</span></span> wg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> adm<span class="main">[</span><span class="operator">OF</span> wg<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> S<span class="main">[</span><span class="operator">unfolded</span> Fun ts<span class="main">]</span> l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">]</span> weight_w0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> scff
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded kbo <span class="main">[]</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scf_list_def pr_strict<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_unbounded_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> NS_least_least<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">least</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">g</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> Fun <span class="bound">g</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">least</span> <span class="bound">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> NS <span class="keyword1"><span class="command">unfolding</span></span> Var <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> NS<span class="main">[</span><span class="operator">unfolded</span> Fun<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> weight <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">with</span></span> w <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> weight <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span>Fun <span class="free">f</span> <span class="main">[]</span><span class="main">)</span> <span class="main">≤</span> <span class="free">w0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">w0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  w0<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> w Nil l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> gf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> NS<span class="main">[</span><span class="operator">unfolded</span> Fun<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Nil
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pr_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">least</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> least
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> g<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span>
      <span class="keyword1"><span class="command">from</span></span> l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">h</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">w0</span> <span class="main">⟶</span> <span class="free">pr_weak</span> <span class="main">(</span><span class="skolem">h</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> pr_weak_trans p <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">h</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">w0</span> <span class="main">⟶</span> <span class="free">pr_weak</span> <span class="main">(</span><span class="skolem">h</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">g</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> Fun Nil<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> least<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> scf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> scff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">scf</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lessE<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="main">(</span>
        scf_list <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">scf</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> Suc <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ss</span>
      <span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w0</span> <span class="main">+</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>replicate <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> weight <span class="skolem">s</span> <span class="main">+</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>replicate <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> weight_w0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>replicate <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> scff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">+</span> <span class="main">…</span> <span class="main">+</span> <span class="var">?e</span> <span class="main">≤</span> <span class="free">w0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ts scf_list_bef_i_aft <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w0</span> <span class="main">+</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>replicate <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">+</span> <span class="var">?e</span> <span class="main">≤</span> <span class="free">w0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> null<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="main">(</span>replicate <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> null<span class="main">(</span>2<span class="main">)</span> weight_gt_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map weight <span class="skolem">ss</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_scf_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> scf<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> null<span class="main">]</span> weight_gt_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">ss</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ss</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> scff <span class="main">=</span> scff<span class="main">[</span><span class="operator">unfolded</span> ts n<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> wg ts <span class="keyword1"><span class="command">have</span></span> wg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> adm<span class="main">[</span><span class="operator">OF</span> wg<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> NS<span class="main">[</span><span class="operator">unfolded</span> Fun ts<span class="main">]</span> l<span class="main">[</span><span class="operator">unfolded</span> least<span class="main">]</span> weight_w0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> scff
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext_unbounded kbo <span class="main">[]</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scf_list_def pr_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_unbounded_iff snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Stability (a.k.a. Closure under Substitutions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weight_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span>
  weight <span class="free">t</span> <span class="main">+</span> sum_mset <span class="main">(</span>image_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> weight <span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="free">w0</span><span class="main">)</span> <span class="main">(</span>vars_term_ms <span class="main">(</span>SCF <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> weight_w0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"scf_list <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sts</span> <span class="main">=</span> <span class="var">?ts</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> weight <span class="main">(</span><span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="var">?ts</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> weight <span class="bound">t</span> <span class="main">+</span> sum_mset <span class="main">(</span>image_mset <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> weight <span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="free">w0</span><span class="main">)</span> <span class="main">(</span>vars_term_ms <span class="main">(</span>scf_term <span class="free">scf</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?ts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl Fun<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> scf_list_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ts</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def id<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> sts_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="skolem">sts</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weight_stable_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ws<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="free">s</span> <span class="main">≤</span> weight <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="free">s</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">≤</span> weight <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vs<span class="main">[</span><span class="operator">unfolded</span> mset_subset_eq_exists_conv<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> vt<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="free">t</span><span class="main">)</span> <span class="main">=</span> vars_term_ms <span class="main">(</span>SCF <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> weight_subst vt <span class="keyword1"><span class="command">using</span></span> ws <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weight_stable_lt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ws<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="free">s</span> <span class="main">&lt;</span> weight <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="free">s</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="free">t</span><span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">&lt;</span> weight <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vs<span class="main">[</span><span class="operator">unfolded</span> mset_subset_eq_exists_conv<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> vt<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="free">t</span><span class="main">)</span> <span class="main">=</span> vars_term_ms <span class="main">(</span>SCF <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> weight_subst vt <span class="keyword1"><span class="command">using</span></span> ws <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹KBO is stable, i.e., closed under substitutions.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> kbo_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NS <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">s</span> <span class="free">t</span> <span class="main">⟶</span> S <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> NS <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s</span> <span class="free">t</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">y</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> S <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_S_Var<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> NS_Var_imp_eq_least<span class="main">[</span><span class="operator">OF</span> Var<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Var <span class="skolem">y</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> <span class="skolem">t</span> <span class="main">=</span> Fun <span class="bound">f</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">least</span> <span class="bound">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Var <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">t</span> <span class="main">=</span> Fun <span class="skolem">f</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">least</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NS <span class="main">(</span>Var <span class="skolem">y</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Var <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> NS_refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Fun <span class="skolem">f</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">least</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> NS_all_least<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"Var <span class="skolem">y</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> not <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> NS <span class="main">=</span> Fun<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Fun<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="var">?s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">ss</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> NS <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="skolem">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">t</span> <span class="main">≤</span> weight <span class="var">?s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> weight_stable_le<span class="main">[</span><span class="operator">OF</span> w v<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> wσ<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">≤</span> weight <span class="main">(</span><span class="var">?s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> vars_term_ms_subst_mono<span class="main">[</span><span class="operator">OF</span> v<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> SCF <span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> vσ<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="main">(</span><span class="var">?s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> scf_term_subst <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"weight <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">&lt;</span> weight <span class="main">(</span><span class="var">?s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> vσ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> weight_stable_lt<span class="main">[</span><span class="operator">OF</span> _ v<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> w <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">t</span> <span class="main">=</span> weight <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> set_mset_mono<span class="main">[</span><span class="operator">OF</span> v<span class="main">,</span> <span class="operator">folded</span> s_def<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> vars_term <span class="main">(</span>SCF <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Var <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> vars_term <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vars_term_scf_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> vars_term <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> supteq_Var<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">⊳</span> Var <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s_def Fun <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> S_supt<span class="main">[</span><span class="operator">OF</span> supt_subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="main">(</span><span class="var">?s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Var <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> S_imp_NS<span class="main">[</span><span class="operator">OF</span> S<span class="main">]</span> S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> t <span class="main">=</span> this
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="main">(</span><span class="var">?s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wσ vσ <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> S S_imp_NS<span class="main">[</span><span class="operator">OF</span> S<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> prec <span class="main">=</span> this
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> v w prec <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> NS <span class="var">?s</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> vars_term_ms.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> NS <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">from</span></span> v w <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="skolem">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="var">?s</span><span class="main">)</span> <span class="main">∧</span> weight <span class="skolem">t</span> <span class="main">≤</span> weight <span class="var">?s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> weight <span class="skolem">t</span> <span class="main">&lt;</span> weight <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
            <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ts</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> IH<span class="main">[</span><span class="operator">OF</span> _ S_imp_NS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S<span class="main"><span class="main">]</span></span><span class="main">]</span> S i <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> kbo.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IH_S <span class="main">=</span> this
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
            <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ts</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="main">(</span><span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NS <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> IH<span class="main">[</span><span class="operator">OF</span> _ NS<span class="main">]</span> i <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> kbo.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IH_NS <span class="main">=</span> this
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"S <span class="var">?s</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> prec v w True <span class="keyword1"><span class="command">have</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded kbo <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> s_def t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>lex_ext_unbounded kbo <span class="var">?ss</span> <span class="var">?ts</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lex_ext_unbounded_map_S<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ lex<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> IH_NS IH_S<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> vσ wσ prec True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="main">(</span><span class="var">?s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword1"><span class="command">from</span></span> NS prec v w True <span class="keyword1"><span class="command">have</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext_unbounded kbo <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>lex_ext_unbounded kbo <span class="var">?ss</span> <span class="var">?ts</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lex_ext_unbounded_map_NS<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ lex<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> IH_S IH_NS<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> vσ wσ prec True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NS <span class="main">(</span><span class="var">?s</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"S <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> S <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">σ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> kbo_stable<span class="main">[</span><span class="operator">OF</span> S_imp_NS<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> NS_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> NS <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">σ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> kbo_stable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transitivity and Compatibility›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kbo_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">s</span> <span class="free">t</span> <span class="main">⟶</span> NS <span class="free">t</span> <span class="free">u</span> <span class="main">⟶</span> S <span class="free">s</span> <span class="free">u</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span>NS <span class="free">s</span> <span class="free">t</span> <span class="main">⟶</span> S <span class="free">t</span> <span class="free">u</span> <span class="main">⟶</span> S <span class="free">s</span> <span class="free">u</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span>NS <span class="free">s</span> <span class="free">t</span> <span class="main">⟶</span> NS <span class="free">t</span> <span class="free">u</span> <span class="main">⟶</span> NS <span class="free">s</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s</span> <span class="free">t</span> <span class="free">u</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> not_S_Var<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> nS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> S <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"NS <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> nS <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> NS_Var_imp_eq_least<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Var <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">t</span> <span class="main">=</span> Fun <span class="skolem">f</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">least</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Var <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nS <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Fun <span class="skolem">f</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">least</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Fun <span class="skolem">f</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">least</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> not_S_least<span class="main">[</span><span class="operator">OF</span> least<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> nS'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> S <span class="skolem">t</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"NS <span class="skolem">t</span> <span class="skolem">u</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> NS_least_least<span class="main">[</span><span class="operator">OF</span> least<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> t <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Fun <span class="skolem">h</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">least</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> NS_all_least<span class="main">[</span><span class="operator">OF</span> least<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">with</span></span> nS nS' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> S_imp_NS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"NS <span class="var">?s</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> S_imp_NS<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> st <span class="main">=</span> this
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vst<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="skolem">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wst<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">t</span> <span class="main">≤</span> weight <span class="var">?s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"NS <span class="skolem">t</span> <span class="skolem">u</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> S_imp_NS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> tu <span class="main">=</span> this
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vtu<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="skolem">u</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wtu<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">u</span> <span class="main">≤</span> weight <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> vst vtu <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="skolem">u</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> wst wtu <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">u</span> <span class="main">≤</span> weight <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">u</span> <span class="main">&lt;</span> weight <span class="var">?s</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> wst wtu <span class="keyword1"><span class="command">have</span></span> wst<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">t</span> <span class="main">=</span> weight <span class="var">?s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wtu<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">u</span> <span class="main">=</span> weight <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="skolem">u</span> <span class="main">=</span> weight <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">z</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> v w <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">h</span> <span class="skolem">us</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> u <span class="main">=</span> this
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> t <span class="main">=</span> this
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h</span><span class="main">,</span> length <span class="skolem">us</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> st t wst <span class="keyword1"><span class="command">have</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pr_strict<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> tu t u wtu <span class="keyword1"><span class="command">have</span></span> gh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?g</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pr_strict<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> pr_weak_trans<span class="main">[</span><span class="operator">OF</span> fg gh<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?h</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">with</span></span> w v u <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lex</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lex_ext_unbounded kbo"</span></span>
              <span class="keyword1"><span class="command">from</span></span> False fh <span class="keyword1"><span class="command">have</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?h</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pr_strict <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> pr_weak_trans<span class="main">[</span><span class="operator">OF</span> hf fg<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> hg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?h</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">from</span></span> hg <span class="keyword1"><span class="command">have</span></span> gh2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">pr_strict</span> <span class="var">?g</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pr_strict <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> pr_weak_trans<span class="main">[</span><span class="operator">OF</span> gh hf<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> gf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?g</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">from</span></span> gf <span class="keyword1"><span class="command">have</span></span> fg2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pr_strict <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> st t wst fg2 <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?lex</span> <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> tu t u wtu gh2 <span class="keyword1"><span class="command">have</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?lex</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> set <span class="skolem">ss</span>"</span></span>
                <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>NS <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">∧</span> S <span class="skolem">t</span> <span class="skolem">u</span> <span class="main">⟶</span> S <span class="skolem">s</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∧</span>
                  <span class="main">(</span>S <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">∧</span> NS <span class="skolem">t</span> <span class="skolem">u</span> <span class="main">⟶</span> S <span class="skolem">s</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∧</span>
                  <span class="main">(</span>NS <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">∧</span> NS <span class="skolem">t</span> <span class="skolem">u</span> <span class="main">⟶</span> NS <span class="skolem">s</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∧</span>
                  <span class="main">(</span>S <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">∧</span> S <span class="skolem">t</span> <span class="skolem">u</span> <span class="main">⟶</span> S <span class="skolem">s</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> S_imp_NS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span> <span class="main">+</span> length <span class="skolem">ts</span> <span class="main">+</span> length <span class="skolem">us</span>"</span></span>
              <span class="keyword1"><span class="command">note</span></span> lex <span class="main">=</span> lex_ext_compat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quoted">kbo</span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span><span class="main">,</span> <span class="operator">OF</span> IH<span class="main">]</span>
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lexb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lex_ext kbo <span class="var">?b</span>"</span></span>
              <span class="keyword1"><span class="command">note</span></span> conv <span class="main">=</span> lex_ext_def Let_def
              <span class="keyword1"><span class="command">from</span></span> st <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?lexb</span> <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">from</span></span> tu <span class="keyword1"><span class="command">have</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?lexb</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">from</span></span> lex st tu <span class="keyword1"><span class="command">have</span></span> su<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?lexb</span> <span class="skolem">ss</span> <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> su<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?lex</span> <span class="skolem">ss</span> <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">from</span></span> w v u su fh <span class="keyword1"><span class="command">have</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="var">?s</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="var">?s</span> <span class="skolem">t</span>"</span></span>
                <span class="keyword1"><span class="command">with</span></span> t wst fg fg2 <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?lex</span> <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?lexb</span> <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">from</span></span> lex st tu <span class="keyword1"><span class="command">have</span></span> su<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?lexb</span> <span class="skolem">ss</span> <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> su<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?lex</span> <span class="skolem">ss</span> <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">from</span></span> w v u su fh <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="var">?s</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> S_left <span class="main">=</span> this
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">with</span></span> t u wtu gh2 <span class="keyword1"><span class="command">have</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?lex</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?lexb</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">from</span></span> lex st tu <span class="keyword1"><span class="command">have</span></span> su<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?lexb</span> <span class="skolem">ss</span> <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> su<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?lex</span> <span class="skolem">ss</span> <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">from</span></span> w v u su fh <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="var">?s</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> S_right <span class="main">=</span> this
              <span class="keyword1"><span class="command">from</span></span> NS S_left S_right <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> t <span class="main">=</span> this
            <span class="keyword1"><span class="command">from</span></span> tu weight_w0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">least</span> <span class="skolem">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Fun <span class="skolem">h</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t u
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> NS_all_least<span class="main">[</span><span class="operator">OF</span> least<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="var">?s</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">from</span></span> not_S_Var <span class="keyword1"><span class="command">have</span></span> nS'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> S <span class="skolem">t</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"S <span class="var">?s</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">with</span></span> nS' NS <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_term_ms <span class="main">(</span>SCF <span class="skolem">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="var">?s</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> set_mset_mono<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">unfolded</span> set_mset_vars_term_ms t<span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="main">(</span>SCF <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> vars_term <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vars_term_scf_subset<span class="main">)</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">sss</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">sss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ss</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> kbo_supt_one<span class="main">[</span><span class="operator">OF</span> NS_all_least<span class="main"><span class="main">[</span></span><span class="operator">OF</span> least<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted">Nil</span> <span class="quoted"><span class="skolem">sss</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="var">?s</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ss u <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">with</span></span> NS <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> S <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> S <span class="free">s</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S_imp_NS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> kbo_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">lemma</span></span> NS_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> NS <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> NS <span class="free">s</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> kbo_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">lemma</span></span> NS_S_compat<span class="main">:</span> <span class="quoted"><span class="quoted">"NS <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> S <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> S <span class="free">s</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> kbo_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">lemma</span></span> S_NS_compat<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> NS <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> S <span class="free">s</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> kbo_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strong Normalization (a.k.a. Well-Foundedness)›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kbo_strongly_normalizing<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SN_on <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> S <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?SN</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">t</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term<span class="main">.</span> SN_on <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> S <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span> <span class="main">{</span><span class="bound">t</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">ss</span><span class="main">)</span><span class="main">.</span> weight <span class="main">(</span>Fun <span class="bound">f</span> <span class="bound">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">ss</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rel'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lex_two <span class="main">{</span><span class="main">(</span><span class="bound">fss</span><span class="main">,</span> <span class="bound">gts</span><span class="main">)</span><span class="main">.</span> <span class="var">?m1</span> <span class="bound">fss</span> <span class="main">&gt;</span> <span class="var">?m1</span> <span class="bound">gts</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">fss</span><span class="main">,</span> <span class="bound">gts</span><span class="main">)</span><span class="main">.</span> <span class="var">?m1</span> <span class="bound">fss</span> <span class="main">≥</span> <span class="var">?m1</span> <span class="bound">gts</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="bound">fss</span><span class="main">,</span> <span class="bound">gts</span><span class="main">)</span><span class="main">.</span> <span class="free">pr_strict</span> <span class="main">(</span><span class="var">?m2</span> <span class="bound">fss</span><span class="main">)</span> <span class="main">(</span><span class="var">?m2</span> <span class="bound">gts</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rel</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv_image <span class="var">?rel'</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> SN_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="var">?rel</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SN_inv_image<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> lex_two<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> SN_inv_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pr_SN<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?m2</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span>  SN_inv_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SN_nat_gt<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?m1</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> conv <span class="main">=</span> SN_on_all_reducts_SN_on_conv
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SN</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> conv<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"Var <span class="skolem">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> not_S_Var<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ss</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="var">?SN</span> <span class="bound">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">ss</span><span class="main">)</span><span class="main">.</span> set <span class="bound">ss</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="var">?SN</span> <span class="bound">s</span><span class="main">}</span> <span class="main">⟶</span> <span class="var">?SN</span> <span class="main">(</span>Fun <span class="bound">f</span> <span class="bound">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">fss</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">fss</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">fss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> SN_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SN_rel<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">fss</span><span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> fss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fss</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="skolem">ts</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m1</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">&gt;</span> <span class="var">?m1</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?m1</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">≥</span> <span class="var">?m1</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">∧</span> <span class="free">pr_strict</span> <span class="main">(</span><span class="var">?m2</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?m2</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ts</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="var">?SN</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SN</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> fss split<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> split<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fss split
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> SN_s<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ss</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="var">?SN</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?SNt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">g</span> <span class="bound">ts</span><span class="main">.</span> <span class="var">?SN</span> <span class="main">(</span>Fun <span class="bound">g</span> <span class="bound">ts</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sym</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">g</span> <span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> length <span class="bound">ts</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lex</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lex_ext kbo <span class="main">(</span>weight <span class="var">?s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lexu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lex_ext_unbounded kbo"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lex_SN</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="bound">ys</span><span class="main">.</span> <span class="var">?SN</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span><span class="var">?lex</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> lex_ext_SN<span class="main">[</span><span class="operator">of</span> <span class="quoted">kbo</span> <span class="quoted"><span class="quoted">"weight <span class="var">?s</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> NS_S_compat<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> SN<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="var">?lex_SN</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term list"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?f</span> <span class="main">(</span><span class="var">?sym</span> <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">∧</span> weight <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">≤</span> weight <span class="var">?s</span> <span class="main">∧</span> set <span class="skolem">ts</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="var">?SN</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SNt</span> <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> SN_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SN<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ts</span> <span class="skolem">g</span><span class="main">)</span>
              <span class="keyword1"><span class="command">note</span></span> inner_IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="var">?t</span> <span class="main">≤</span> weight <span class="var">?s</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> SN<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ts</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="var">?SN</span> <span class="bound">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SNt</span> <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> conv<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?t</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> S <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="var">?t</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SN</span> <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_S_Var<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> conv<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"Var <span class="skolem">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">h</span> <span class="skolem">us</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h</span><span class="main">,</span> length <span class="skolem">us</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">h</span> <span class="skolem">us</span>"</span></span>
                  <span class="keyword1"><span class="command">note</span></span> tu <span class="main">=</span> Fun<span class="main">(</span>2<span class="main">)</span>
                  <span class="keyword1"><span class="command">{</span></span>
                    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
                    <span class="keyword3"><span class="command">assume</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="skolem">us</span>"</span></span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">⊳</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">from</span></span> S_trans<span class="main">[</span><span class="operator">OF</span> tu S_supt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="var">?t</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">from</span></span> Fun<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> u this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SN</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
                  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> SNu<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">us</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span> <span class="main">.</span> <span class="var">?SN</span> <span class="bound">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span>
                  <span class="keyword1"><span class="command">from</span></span> tu <span class="keyword1"><span class="command">have</span></span> wut<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="var">?u</span> <span class="main">≤</span> weight <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?m1</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">&gt;</span> <span class="var">?m1</span> <span class="main">(</span><span class="skolem">h</span><span class="main">,</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?m1</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">≥</span> <span class="var">?m1</span> <span class="main">(</span><span class="skolem">h</span><span class="main">,</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">∧</span> <span class="free">pr_strict</span> <span class="main">(</span><span class="var">?m2</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?m2</span> <span class="main">(</span><span class="skolem">h</span><span class="main">,</span> <span class="skolem">us</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
                    <span class="keyword3"><span class="command">case</span></span> True
                    <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> True<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> split<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">next</span></span>
                    <span class="keyword3"><span class="command">case</span></span> False
                    <span class="keyword1"><span class="command">with</span></span> wut w <span class="keyword1"><span class="command">have</span></span> wut<span class="main">:</span> <span class="quoted"><span class="quoted">"weight <span class="var">?t</span> <span class="main">=</span> weight <span class="var">?u</span>"</span></span> <span class="quoted"><span class="quoted">"weight <span class="var">?s</span> <span class="main">=</span> weight <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">note</span></span> False <span class="main">=</span> False<span class="main">[</span><span class="operator">unfolded</span> split wut<span class="main">]</span>
                    <span class="keyword1"><span class="command">note</span></span> tu <span class="main">=</span> tu<span class="main">[</span><span class="operator">unfolded</span> kbo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="main">]</span></span> wut<span class="main">,</span> <span class="operator">unfolded</span> Fun term.simps<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
                    <span class="keyword1"><span class="command">from</span></span> tu <span class="keyword1"><span class="command">have</span></span> gh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?g</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pr_strict <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                    <span class="keyword1"><span class="command">from</span></span> pr_weak_trans<span class="main">[</span><span class="operator">OF</span> fg gh<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
                    <span class="keyword1"><span class="command">from</span></span> False wut fh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">pr_strict</span> <span class="var">?f</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pr_strict <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> fh <span class="keyword1"><span class="command">have</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?h</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pr_strict <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">from</span></span> pr_weak_trans<span class="main">[</span><span class="operator">OF</span> hf fg<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> hg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?h</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
                    <span class="keyword1"><span class="command">from</span></span> hg <span class="keyword1"><span class="command">have</span></span> gh2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">pr_strict</span> <span class="var">?g</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pr_strict <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">from</span></span> tu gh2 <span class="keyword1"><span class="command">have</span></span> lex<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?lexu</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                    <span class="keyword1"><span class="command">from</span></span> fh wut SNu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="var">?f</span> <span class="var">?h</span> <span class="main">∧</span> weight <span class="var">?u</span> <span class="main">≤</span> weight <span class="var">?s</span> <span class="main">∧</span> set <span class="skolem">us</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="var">?SN</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">note</span></span> inner_IH <span class="main">=</span> inner_IH<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inner_IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> split<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI ballI<span class="main">)</span>
                      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?lexu</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lex<span class="main">)</span>
                      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">≤</span> weight <span class="var">?s</span>"</span></span>
                      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">≤</span> sum_list <span class="main">(</span>map weight <span class="skolem">us</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">)</span>
                          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
                          <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">(</span>sum_list <span class="main">(</span>map weight <span class="skolem">us</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> sum_list <span class="main">(</span>map weight <span class="main">(</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> weight_gt_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span>
                            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
                        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sum_list <span class="main">(</span>map weight <span class="main">(</span>scf_list <span class="main">(</span><span class="free">scf</span> <span class="main">(</span><span class="skolem">h</span><span class="main">,</span> length <span class="skolem">us</span><span class="main">)</span><span class="main">)</span> <span class="skolem">us</span><span class="main">)</span><span class="main">)</span>"</span></span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_scf_list<span class="main"><span class="main">[</span></span><span class="operator">OF</span> scf<span class="main"><span class="main">]</span></span><span class="main">)</span>
                        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> weight <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wut <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
                      <span class="keyword1"><span class="command">qed</span></span>
                      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?lex</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lex_ext_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> SN<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">]</span> SN_s  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SN</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> split<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Fun <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_SN<span class="main">:</span> <span class="quoted"><span class="quoted">"SN <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> S <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> kbo_strongly_normalizing <span class="keyword1"><span class="command">unfolding</span></span> SN_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Ground Totality›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ground_SCF <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ground <span class="main">(</span>SCF <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ground <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="free">scf</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">xs</span><span class="main">)</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'f</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term list"</span></span> <span class="keyword1"><span class="command">using</span></span> scf <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_scf_list <span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> kbo.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_vars_term_ms<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">t</span> <span class="main">⟹</span> vars_term_ms <span class="free">t</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> nat<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pr_weak<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pr_weak</span> <span class="main">=</span> <span class="free">pr_strict</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pr_gtotal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">∨</span> <span class="free">pr_strict</span> <span class="bound">f</span> <span class="bound">g</span> <span class="main">∨</span> <span class="free">pr_strict</span> <span class="bound">g</span> <span class="bound">f</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_ground_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"funas_term <span class="free">s</span> <span class="main">⊆</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ground <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"funas_term <span class="free">t</span> <span class="main">⊆</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ground <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∨</span> S <span class="free">s</span> <span class="free">t</span> <span class="main">∨</span> S <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> IH<span class="main">:</span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> ground_vars_term_ms
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vars_term_ms <span class="main">(</span>SCF <span class="skolem">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="var">?s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>vars_term_ms <span class="main">(</span>SCF <span class="var">?s</span><span class="main">)</span> <span class="main">⊆#</span> vars_term_ms <span class="main">(</span>SCF <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ground <span class="var">?s</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹ground <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scf<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> IH<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Fun <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span> length <span class="skolem">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> IH <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?case</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> contra <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> kbo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span><span class="main"><span class="main">]</span></span> kbo.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="main">]</span></span> *<span class="main">,</span> <span class="operator">unfolded</span> t term.simps<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> pr_gtotal<span class="main">[</span><span class="operator">OF</span> f g<span class="main">]</span> contra <span class="keyword1"><span class="command">have</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">=</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">∨</span> S <span class="bound">s</span> <span class="bound">t</span> <span class="main">∨</span> S <span class="bound">t</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_zipE<span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> fg <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span> <span class="main">=</span> length <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> lex_ext_unbounded_total<span class="main">[</span><span class="operator">OF</span> IH NS_refl len<span class="main">]</span> contra fg
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Summary›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  At this point we have shown well-foundedness <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] S_SN<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  transitivity and compatibility <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] S_trans NS_trans NS_S_compat S_NS_compat<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  closure under substitutions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] S_subst NS_subst<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  closure under contexts <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] S_ctxt NS_ctxt<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  the subterm property <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] S_supt NS_supteq<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  reflexivity of the weak <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] NS_refl<span class="antiquote"><span class="antiquote">}</span></span></span></span> and irreflexivity of the strict
  part <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] S_irrefl<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  and ground-totality <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] S_ground_total<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  In particular, this allows us to show that KBO is an instance of
  strongly normalizing order pairs (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> SN_order_pair<span class="antiquote"><span class="antiquote">}</span></span></span></span>).
›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> SN_order_pair <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> S <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> NS <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> NS_refl NS_trans S_trans S_SN NS_S_compat S_NS_compat<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def trans_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>