<div id="Lib_Enum_toString">
<div class="head">
<h1>Theory Lib_Enum_toString</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Enum toString Functions›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Lib_Enum_toString
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="../IP_Addresses/Lib_List_toString.html">IP_Addresses.Lib_List_toString</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bool_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bool_toString</span> True <span class="main">=</span> <span class="inner_quoted">''True''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bool_toString</span> False <span class="main">=</span> <span class="inner_quoted">''False''</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Enum set to string›</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">enum_set_get_one</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">enum_set_get_one</span> <span class="main">[]</span>     <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">enum_set_get_one</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> <span class="free">enum_set_get_one</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Lib_Enum_toString-enum_set_get_one_empty"><span class="command">lemma</span></span> enum_set_get_one_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"enum_set_get_one <span class="free">ss</span> <span class="main">{}</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  
  <span class="keyword1" id="Lib_Enum_toString-enum_set_get_one_None"><span class="command">lemma</span></span> enum_set_get_one_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> set <span class="free">ss</span> <span class="main">⟹</span> enum_set_get_one <span class="free">ss</span> <span class="free">S</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 
  <span class="keyword1" id="Lib_Enum_toString-enum_set_get_one_Some"><span class="command">lemma</span></span> enum_set_get_one_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> set <span class="free">ss</span> <span class="main">⟹</span> enum_set_get_one <span class="free">ss</span> <span class="free">S</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">corollary</span></span> enum_set_get_one_enum_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"enum_set_get_one enum_class.enum <span class="free">S</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enum_set_get_one_Some<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ss<span class="main"><span class="main">=</span></span><span class="quoted">enum_class.enum</span><span class="main">,</span> <span class="operator">simplified</span> enum_UNIV<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Lib_Enum_toString-enum_set_get_one_Ex_Some"><span class="command">lemma</span></span> enum_set_get_one_Ex_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> set <span class="free">ss</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> enum_set_get_one <span class="free">ss</span> <span class="free">S</span> <span class="main">=</span> Some <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">corollary</span></span> enum_set_get_one_enum_Ex_Some<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> enum_set_get_one enum_class.enum <span class="free">S</span> <span class="main">=</span> Some <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enum_set_get_one_Ex_Some<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ss<span class="main"><span class="main">=</span></span><span class="quoted">enum_class.enum</span><span class="main">,</span> <span class="operator">simplified</span> enum_UNIV<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">function</span></span> <span class="entity">enum_set_to_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>enum<span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">enum_set_to_list</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span>
      <span class="keyword1">case</span> enum_set_get_one Enum.enum <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span>
                                        <span class="main">|</span>  Some <span class="bound">a</span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">#</span><span class="free">enum_set_to_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">pat_completeness</span><span class="main">)</span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">termination</span></span> <span class="quoted">enum_set_to_list</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">S</span><span class="main">)</span><span class="main">.</span> card <span class="bound">S</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_gt_0_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> enum_set_get_one_enum_Some<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"finite <span class="improper">S</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> card_Diff1_less<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="comment1">(*this definition is simpler*)</span>
  <span class="keyword1" id="Lib_Enum_toString-enum_set_to_list_simps"><span class="command">lemma</span></span> enum_set_to_list_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"enum_set_to_list <span class="free">S</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> enum_set_get_one <span class="main">(</span>Enum.enum<span class="main">)</span> <span class="free">S</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span>
                                           <span class="main">|</span>  Some <span class="bound">a</span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">#</span>enum_set_to_list <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_set_get_one_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">declare</span></span> enum_set_to_list.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

  <span class="keyword1" id="Lib_Enum_toString-enum_set_to_list"><span class="command">lemma</span></span> enum_set_to_list<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>enum_set_to_list <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> enum_set_to_list.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_set_to_list.simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> enum_set_to_list_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> enum_set_get_one_enum_Ex_Some<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> enum_set_get_one_enum_Some<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"list_toString bool_toString <span class="main">(</span>enum_set_to_list <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">''[False, True]''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="L4_Protocol">
<div class="head">
<h1>Theory L4_Protocol</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> L4_Protocol
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Lib_Enum_toString.html">../Common/Lib_Enum_toString</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Word.html">HOL-Library.Word</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Transport Layer Protocols›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> primitive_protocol <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">8</span> word"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ICMP</span> <span class="main">≡</span> <span class="main">1</span> <span class="main">::</span> <span class="numeral">8</span> word"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">TCP</span> <span class="main">≡</span> <span class="numeral">6</span> <span class="main">::</span> <span class="numeral">8</span> word"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">UDP</span> <span class="main">≡</span> <span class="numeral">17</span> <span class="main">::</span> <span class="numeral">8</span> word"</span></span>
<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="comment1">(*let's not pollute the namespace too much*)</span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">SCTP</span> <span class="main">≡</span> <span class="numeral">132</span>  <span class="main">::</span> <span class="numeral">8</span> word"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">IGMP</span> <span class="main">≡</span> <span class="numeral">2</span> <span class="main">::</span> <span class="numeral">8</span> word"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">GRE</span> <span class="main">≡</span> <span class="numeral">47</span> <span class="main">::</span> <span class="numeral">8</span> word"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ESP</span> <span class="main">≡</span> <span class="numeral">50</span> <span class="main">::</span> <span class="numeral">8</span> word"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">AH</span> <span class="main">≡</span> <span class="numeral">51</span> <span class="main">::</span> <span class="numeral">8</span> word"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">IPv6ICMP</span> <span class="main">≡</span> <span class="numeral">58</span> <span class="main">::</span> <span class="numeral">8</span> word"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(* turn http://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml into a separate file or so? *)</span>

<span class="keyword1"><span class="command">datatype</span></span> protocol <span class="main">=</span> ProtoAny <span class="main">|</span> Proto <span class="quoted"><span class="quoted">"primitive_protocol"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">match_proto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"protocol <span class="main">⇒</span> primitive_protocol <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">match_proto</span> ProtoAny <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">match_proto</span> <span class="main">(</span>Proto <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p_p</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">p_p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_proto_conjunct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"protocol <span class="main">⇒</span> protocol <span class="main">⇒</span> protocol option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_proto_conjunct</span> ProtoAny <span class="free"><span class="bound"><span class="entity">proto</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">proto</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_proto_conjunct</span> <span class="free"><span class="bound"><span class="entity">proto</span></span></span> ProtoAny <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">proto</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_proto_conjunct</span> <span class="main">(</span>Proto <span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span> <span class="main">(</span>Proto <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>Proto <span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1" id="L4_Protocol-simple_proto_conjunct_asimp"><span class="command">lemma</span></span> simple_proto_conjunct_asimp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"simple_proto_conjunct <span class="free">proto</span> ProtoAny <span class="main">=</span> Some <span class="free">proto</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">proto</span></span><span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1" id="L4_Protocol-simple_proto_conjunct_correct"><span class="command">lemma</span></span> simple_proto_conjunct_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"match_proto <span class="free">p1</span> <span class="free">pkt</span> <span class="main">∧</span> match_proto <span class="free">p2</span> <span class="free">pkt</span> <span class="main">⟷</span> 
    <span class="main">(</span><span class="keyword1">case</span> simple_proto_conjunct <span class="free">p1</span> <span class="free">p2</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">proto</span> <span class="main">⇒</span> match_proto <span class="bound">proto</span> <span class="free">pkt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p1</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p2</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="L4_Protocol-simple_proto_conjunct_Some"><span class="command">lemma</span></span> simple_proto_conjunct_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_proto_conjunct <span class="free">p1</span> <span class="free">p2</span> <span class="main">=</span> Some <span class="free">proto</span> <span class="main">⟹</span> 
    match_proto <span class="free">proto</span> <span class="free">pkt</span> <span class="main">⟷</span> match_proto <span class="free">p1</span> <span class="free">pkt</span> <span class="main">∧</span> match_proto <span class="free">p2</span> <span class="free">pkt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simple_proto_conjunct_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="L4_Protocol-simple_proto_conjunct_None"><span class="command">lemma</span></span> simple_proto_conjunct_None<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_proto_conjunct <span class="free">p1</span> <span class="free">p2</span> <span class="main">=</span> None <span class="main">⟹</span> 
    <span class="main">¬</span> <span class="main">(</span>match_proto <span class="free">p1</span> <span class="free">pkt</span> <span class="main">∧</span> match_proto <span class="free">p2</span> <span class="free">pkt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simple_proto_conjunct_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="L4_Protocol-conjunctProtoD"><span class="command">lemma</span></span> conjunctProtoD<span class="main">:</span>
    <span class="quoted"><span class="quoted">"simple_proto_conjunct <span class="free">a</span> <span class="main">(</span>Proto <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> Proto <span class="free">b</span> <span class="main">∧</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> ProtoAny <span class="main">∨</span> <span class="free">a</span> <span class="main">=</span> Proto <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1" id="L4_Protocol-conjunctProtoD2"><span class="command">lemma</span></span> conjunctProtoD2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"simple_proto_conjunct <span class="main">(</span>Proto <span class="free">b</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> Proto <span class="free">b</span> <span class="main">∧</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> ProtoAny <span class="main">∨</span> <span class="free">a</span> <span class="main">=</span> Proto <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Originally, there was a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">nat</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the protocol definition, allowing infinitely many protocols 
        This was intended behavior. We want to prevent things such as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">¬</span></span>TCP <span class="main"><span class="main">=</span></span> UDP"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
        So be careful with what you prove...›</span></span>
  <span class="keyword1" id="L4_Protocol-primitive_protocol_Ex_neq"><span class="command">lemma</span></span> primitive_protocol_Ex_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> Proto <span class="free">pi</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">≠</span> <span class="free">pi</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">pi</span>
  <span class="keyword1"><span class="command">proof</span></span>
  	<span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">pi</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="free">pi</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="L4_Protocol-protocol_Ex_neq"><span class="command">lemma</span></span> protocol_Ex_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p'</span><span class="main">.</span> Proto <span class="bound">p'</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> primitive_protocol_Ex_neq<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹TCP flags›</span></span>
  <span class="keyword1"><span class="command">datatype</span></span> tcp_flag <span class="main">=</span> TCP_SYN <span class="main">|</span> TCP_ACK <span class="main">|</span> TCP_FIN <span class="main">|</span> TCP_RST <span class="main">|</span> TCP_URG <span class="main">|</span> TCP_PSH <span class="comment1">(*| TCP_ALL | TCP_NONE*)</span>

  <span class="keyword1" id="L4_Protocol-UNIV_tcp_flag"><span class="command">lemma</span></span> UNIV_tcp_flag<span class="main">:</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">=</span> <span class="main">{</span>TCP_SYN<span class="main">,</span> TCP_ACK<span class="main">,</span> TCP_FIN<span class="main">,</span> TCP_RST<span class="main">,</span> TCP_URG<span class="main">,</span> TCP_PSH<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tcp_flag.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">instance</span></span> tcp_flag <span class="main">::</span> <span class="quoted">finite</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> UNIV_tcp_flag <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV<span class="main">::</span> tcp_flag set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"tcp_flag"</span> <span class="main">::</span> <span class="quoted">enum</span>
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">enum_tcp_flag</span></span> <span class="main">=</span> <span class="main">[</span>TCP_SYN<span class="main">,</span> TCP_ACK<span class="main">,</span> TCP_FIN<span class="main">,</span> TCP_RST<span class="main">,</span> TCP_URG<span class="main">,</span> TCP_PSH<span class="main">]</span>"</span></span>
  
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">enum_all_tcp_flag</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> TCP_SYN <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> TCP_ACK <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> TCP_FIN <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> TCP_RST <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> TCP_URG <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> TCP_PSH"</span></span>
    
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">enum_ex_tcp_flag</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> TCP_SYN <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> TCP_ACK <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> TCP_FIN <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> TCP_RST <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> TCP_URG <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> TCP_PSH"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">=</span> set <span class="main">(</span>enum_class.enum <span class="main">::</span> tcp_flag list<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UNIV_tcp_flag enum_tcp_flag_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>enum_class.enum <span class="main">::</span> tcp_flag list<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_tcp_flag_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span>enum_class.enum_all <span class="main">::</span> <span class="main">(</span>tcp_flag <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="bound">P</span> <span class="main">=</span> Ball UNIV <span class="bound">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UNIV_tcp_flag enum_all_tcp_flag_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span>enum_class.enum_ex <span class="main">::</span> <span class="main">(</span>tcp_flag <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="bound">P</span> <span class="main">=</span> Bex UNIV <span class="bound">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UNIV_tcp_flag enum_ex_tcp_flag_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹TCP Flags to String›</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">tcp_flag_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tcp_flag <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">tcp_flag_toString</span> TCP_SYN <span class="main">=</span> <span class="inner_quoted">''TCP_SYN''</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">tcp_flag_toString</span> TCP_ACK <span class="main">=</span> <span class="inner_quoted">''TCP_ACK''</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">tcp_flag_toString</span> TCP_FIN <span class="main">=</span> <span class="inner_quoted">''TCP_FIN''</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">tcp_flag_toString</span> TCP_RST <span class="main">=</span> <span class="inner_quoted">''TCP_RST''</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">tcp_flag_toString</span> TCP_URG <span class="main">=</span> <span class="inner_quoted">''TCP_URG''</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">tcp_flag_toString</span> TCP_PSH <span class="main">=</span> <span class="inner_quoted">''TCP_PSH''</span>"</span></span>


  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipt_tcp_flags_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tcp_flag set <span class="main">⇒</span> char list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ipt_tcp_flags_toString</span> <span class="free"><span class="bound"><span class="entity">flags</span></span></span> <span class="main">≡</span> list_toString tcp_flag_toString <span class="main">(</span>enum_set_to_list <span class="free"><span class="bound"><span class="entity">flags</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"ipt_tcp_flags_toString <span class="main">{</span>TCP_SYN<span class="main">,</span>TCP_SYN<span class="main">,</span>TCP_ACK<span class="main">}</span> <span class="main">=</span> <span class="inner_quoted">''[TCP_SYN, TCP_ACK]''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Simple_Packet">
<div class="head">
<h1>Theory Simple_Packet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Simple Packet›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Simple_Packet
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="L4_Protocol.html">Primitives/L4_Protocol</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Packet constants are prefixed with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>›</span></span>

  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'i</span></span><span class="main"><span class="main">::</span></span>len word"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an IP address of variable length. 32bit for IPv4, 128bit for IPv6›</span></span>

  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A simple packet with IP addresses and layer four ports.
             Also has the following phantom fields:
             Input and Output network interfaces›</span></span>

  <span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="tfree">'i</span> simple_packet <span class="main">=</span> p_iiface <span class="main">::</span> <span class="quoted">string</span>
                         p_oiface <span class="main">::</span> <span class="quoted">string</span>
                         p_src <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len word"</span></span>
                         p_dst <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len word"</span></span>
                         p_proto <span class="main">::</span> <span class="quoted">primitive_protocol</span>
                         p_sport <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">16</span> word"</span></span>
                         p_dport <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">16</span> word"</span></span>
                         p_tcp_flags <span class="main">::</span> <span class="quoted"><span class="quoted">"tcp_flag set"</span></span>
                         p_payload <span class="main">::</span> <span class="quoted">string</span>


  <span class="keyword1"><span class="command">value</span></span> <span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span> 
          p_iiface <span class="main">=</span> <span class="inner_quoted">''eth1''</span><span class="main">,</span> p_oiface <span class="main">=</span> <span class="inner_quoted">''''</span><span class="main">,</span> 
          p_src <span class="main">=</span> <span class="main">0</span><span class="main">,</span> p_dst <span class="main">=</span> <span class="main">0</span><span class="main">,</span> 
          p_proto <span class="main">=</span> TCP<span class="main">,</span> p_sport <span class="main">=</span> <span class="main">0</span><span class="main">,</span> p_dport <span class="main">=</span> <span class="main">0</span><span class="main">,</span> 
          p_tcp_flags <span class="main">=</span> <span class="main">{</span>TCP_SYN<span class="main">}</span><span class="main">,</span>
          p_payload <span class="main">=</span> <span class="inner_quoted">''arbitrary payload''</span>
         <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We suggest to use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'i</span></span><span class="main"><span class="main">,</span></span><span class="tfree"><span class="tfree">'pkt_ext</span></span><span class="main"><span class="main">)</span></span> simple_packet_scheme"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> instead of 
        <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'i</span></span> simple_packet"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> because of its extensibility which naturally 
        models any payload›</span></span>

  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_packet_unext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>len<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> simple_packet_scheme <span class="main">⇒</span> <span class="tfree">'i</span> simple_packet"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_packet_unext</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span>
      <span class="main">⦇</span>p_iiface <span class="main">=</span> p_iiface <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> p_oiface <span class="main">=</span> p_oiface <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> p_src <span class="main">=</span> p_src <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> p_dst <span class="main">=</span> p_dst <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> p_proto <span class="main">=</span> p_proto <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> 
       p_sport <span class="main">=</span> p_sport <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> p_dport <span class="main">=</span> p_dport <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> p_tcp_flags <span class="main">=</span> p_tcp_flags <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> 
       p_payload <span class="main">=</span> p_payload <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹An extended simple packet with MAC addresses and VLAN header›</span></span>
  
  <span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="tfree">'i</span> simple_packet_ext <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_packet"</span></span> <span class="main">+</span>
    p_l2type <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">16</span> word"</span></span>
    p_l2src <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">48</span> word"</span></span>
    p_l2dst <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">48</span> word"</span></span>
    p_vlanid <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">16</span> word"</span></span>
    p_vlanprio <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">16</span> word"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Firewall_Common_Decision_State">
<div class="head">
<h1>Theory Firewall_Common_Decision_State</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹The state of a firewall, abstracted only to the packet filtering outcome›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Firewall_Common_Decision_State
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> final_decision <span class="main">=</span> FinalAllow <span class="main">|</span> FinalDeny

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The state during packet processing. If undecided, there are some remaining rules to process. If
decided, there is an action which applies to the packet
›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> state <span class="main">=</span> Undecided <span class="main">|</span> Decision <span class="quoted">final_decision</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Iface">
<div class="head">
<h1>Theory Iface</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Network Interfaces›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Iface
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Char_ord.html">HOL-Library.Char_ord</a>"</span> <span class="comment1">(*WARNING: importing char ord*)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Network interfaces, e.g. \texttt{eth0}, \texttt{wlan1}, ...

iptables supports wildcard matching, e.g. \texttt{eth+} will match \texttt{eth}, \texttt{eth1}, \texttt{ethFOO}, ...
The character `+' is only a wildcard if it appears at the end.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> iface <span class="main">=</span> Iface <span class="main">(</span><span class="free"><span class="entity">iface_sel</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"string"</span></span><span class="main">)</span>  <span class="comment1">― ‹no negation supported, but wildcards›</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Just a normal lexicographical ordering on the interface strings. Used only for optimizing code.
     WARNING: not a semantic ordering.›</span></span>
<span class="comment1">(*We cannot use List_lexord because it clashed with the Word_Lib imported ordering!*)</span>
<span class="keyword1"><span class="command">instantiation</span></span> iface <span class="main">::</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity"><span class="class_parameter">less_eq_iface</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iface <span class="main">⇒</span> iface <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Iface <span class="main">[]</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>Iface <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Iface <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>Iface <span class="main">[]</span><span class="main">)</span> <span class="main">⟷</span> False"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Iface <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>Iface <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> Iface <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≤</span> Iface <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">pat_completeness</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">termination</span></span> <span class="quoted"><span class="quoted">"less_eq <span class="main">::</span> iface <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="bound">is</span><span class="main">.</span> size <span class="main">(</span>iface_sel <span class="main">(</span>fst <span class="bound">is</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> size <span class="main">(</span>iface_sel <span class="main">(</span>snd <span class="bound">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_measure<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> in_measure comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1" id="Iface-Iface_less_eq_empty"><span class="command">lemma</span></span> Iface_less_eq_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"Iface <span class="free">x</span> <span class="main">≤</span> Iface <span class="main">[]</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"Iface <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"Iface <span class="main">[]</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_iface.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1" id="Iface-less_eq_empty"><span class="command">lemma</span></span> less_eq_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"Iface <span class="main">[]</span> <span class="main">≤</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"Iface <span class="main">[]</span>"</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_iface.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1" id="Iface-iface_cons_less_eq_i"><span class="command">lemma</span></span> iface_cons_less_eq_i<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Iface <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">bs</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">q</span> <span class="bound">qs</span><span class="main">.</span> <span class="free">i</span><span class="main">=</span>Iface <span class="main">(</span><span class="bound">q</span><span class="main">#</span><span class="bound">qs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">b</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">∨</span> <span class="main">(</span>Iface <span class="free">bs</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>Iface <span class="bound">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"Iface <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_iface.induct<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity"><span class="class_parameter">less_iface</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iface <span class="main">⇒</span> iface <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Iface <span class="main">[]</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>Iface <span class="main">[]</span><span class="main">)</span> <span class="main">⟷</span> False"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Iface <span class="main">[]</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>Iface <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Iface <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>Iface <span class="main">[]</span><span class="main">)</span> <span class="main">⟷</span> False"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Iface <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>Iface <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> Iface <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">&lt;</span> Iface <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">pat_completeness</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">termination</span></span> <span class="quoted"><span class="quoted">"less <span class="main">::</span> iface <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="bound">is</span><span class="main">.</span> size <span class="main">(</span>iface_sel <span class="main">(</span>fst <span class="bound">is</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> size <span class="main">(</span>iface_sel <span class="main">(</span>snd <span class="bound">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_measure<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> in_measure comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">m</span> <span class="main">::</span> <span class="quoted">iface</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">⟷</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_iface.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">iface</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">⟹</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_iface.induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">m</span> <span class="main">::</span> <span class="quoted">iface</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span> <span class="main">⟹</span> <span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_iface.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Iface_less_eq_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">m</span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted">iface</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span> <span class="main">⟹</span> <span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">q</span> <span class="main">⟹</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">q</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_iface.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> iface_cons_less_eq_i<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">elim</span> exE conjE disjE<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> iface_cons_less_eq_i<span class="main">)</span>
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">m</span> <span class="main">::</span> <span class="quoted">iface</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span> <span class="main">∨</span> <span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_iface.induct<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ifaceAny</span> <span class="main">::</span> <span class="quoted">iface</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ifaceAny</span> <span class="main">≡</span> Iface <span class="inner_quoted">''+''</span>"</span></span>
<span class="comment1">(* there is no IfaceFalse, proof below *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If the interface name ends in a ``+'', then any interface which begins with this name will match.
  (man iptables)

Here is how iptables handles this wildcard on my system.
A packet for the loopback interface \texttt{lo} is matched by the following expressions
  <span class="antiquoted"><span class="antiquoted">▪</span></span> lo
  <span class="antiquoted"><span class="antiquoted">▪</span></span> lo+
  <span class="antiquoted"><span class="antiquoted">▪</span></span> l+
  <span class="antiquoted"><span class="antiquoted">▪</span></span> +

It is not matched by the following expressions
  <span class="antiquoted"><span class="antiquoted">▪</span></span> lo++
  <span class="antiquoted"><span class="antiquoted">▪</span></span> lo+++
  <span class="antiquoted"><span class="antiquoted">▪</span></span> lo1+
  <span class="antiquoted"><span class="antiquoted">▪</span></span> lo1

By the way: \texttt{Warning: weird characters in interface ` ' ('/' and ' ' are not allowed by the kernel).}
However, happy snowman and shell colors are fine.
›</span></span>


<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Helpers for the interface name (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">string</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)›</span></span>
    <span class="comment1">(*Do not use outside this thy! Type is really misleading.*)</span>
    <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
      argument 1: interface as in firewall rule - Wildcard support
      argument 2: interface a packet came from - No wildcard support›</span></span>
    <span class="keyword1"><span class="command">fun</span></span> <span class="entity">internal_iface_name_match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">internal_iface_name_match</span> <span class="main">[]</span>     <span class="main">[]</span>         <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">internal_iface_name_match</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="main">[]</span>         <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''+''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">internal_iface_name_match</span> <span class="main">[]</span>     <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">#</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>      <span class="main">⟷</span> False"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">internal_iface_name_match</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p_i</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">p_is</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''+''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="main">(</span>
            <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p_i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">internal_iface_name_match</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">p_is</span></span></span>
      <span class="main">)</span><span class="main">)</span>"</span></span>
    
    <span class="comment1">(*&lt;*)</span>
    <span class="comment1">― ‹Examples›</span>
      <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="inner_quoted">''lo''</span> <span class="inner_quoted">''lo''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
      <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="inner_quoted">''lo+''</span> <span class="inner_quoted">''lo''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
      <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="inner_quoted">''l+''</span> <span class="inner_quoted">''lo''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
      <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="inner_quoted">''+''</span> <span class="inner_quoted">''lo''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
      <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> internal_iface_name_match <span class="inner_quoted">''lo++''</span> <span class="inner_quoted">''lo''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
      <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> internal_iface_name_match <span class="inner_quoted">''lo+++''</span> <span class="inner_quoted">''lo''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
      <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> internal_iface_name_match <span class="inner_quoted">''lo1+''</span> <span class="inner_quoted">''lo''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
      <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> internal_iface_name_match <span class="inner_quoted">''lo1''</span> <span class="inner_quoted">''lo''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
      <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The wildcard interface name›</span></span>
      <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="inner_quoted">''+''</span> <span class="inner_quoted">''''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span> <span class="comment1">(*&gt;*)</span>
  
  
    <span class="keyword1"><span class="command">fun</span></span> <span class="entity">iface_name_is_wildcard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">iface_name_is_wildcard</span> <span class="main">[]</span> <span class="main">⟷</span> False"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">iface_name_is_wildcard</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''+''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">iface_name_is_wildcard</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">iface_name_is_wildcard</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span>"</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-iface_name_is_wildcard_alt"><span class="command">lemma</span></span> iface_name_is_wildcard_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">eth</span> <span class="main">⟷</span> <span class="free">eth</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> last <span class="free">eth</span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''+''</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">eth</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iface_name_is_wildcard.induct<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-iface_name_is_wildcard_alt'"><span class="command">lemma</span></span> iface_name_is_wildcard_alt'<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">eth</span> <span class="main">⟷</span> <span class="free">eth</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="main">(</span>rev <span class="free">eth</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''+''</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> iface_name_is_wildcard_alt <span class="keyword1"><span class="command">using</span></span> hd_rev <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-iface_name_is_wildcard_fst"><span class="command">lemma</span></span> iface_name_is_wildcard_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="free">is</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">is</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> iface_name_is_wildcard <span class="free">is</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iface_name_is_wildcard_alt<span class="main">)</span>
  
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">internal_iface_name_to_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">internal_iface_name_to_set</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span> iface_name_is_wildcard <span class="free"><span class="bound"><span class="entity">i</span></span></span>
        <span class="keyword1">then</span>
          <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span>
        <span class="keyword1">else</span>
          <span class="main">{</span><span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">@</span><span class="bound">cs</span> <span class="main">|</span> <span class="bound">cs</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span>butlast <span class="free">i</span><span class="main">)</span><span class="main">@</span><span class="bound">cs</span> <span class="main">|</span> <span class="bound">cs</span><span class="main">.</span> True<span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>butlast <span class="free">i</span><span class="main">)</span><span class="main">@</span><span class="bound">s</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNIV<span class="main">::</span>string set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-internal_iface_name_to_set"><span class="command">lemma</span></span> internal_iface_name_to_set<span class="main">:</span> <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="free">i</span> <span class="free">p_iface</span> <span class="main">⟷</span> <span class="free">p_iface</span> <span class="main">∈</span> internal_iface_name_to_set <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">p_iface</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> internal_iface_name_match.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iface_name_is_wildcard_fst<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> iface_name_is_wildcard.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.exhaust<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-internal_iface_name_to_set2"><span class="command">lemma</span></span> internal_iface_name_to_set2<span class="main">:</span> <span class="quoted"><span class="quoted">"internal_iface_name_to_set <span class="free">ifce</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> internal_iface_name_match <span class="free">ifce</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> internal_iface_name_to_set<span class="main">)</span>
      
  
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-internal_iface_name_match_refl"><span class="command">lemma</span></span> internal_iface_name_match_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="free">i</span> <span class="free">i</span>"</span></span>
     <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="skolem">j</span> <span class="main">⟹</span> internal_iface_name_match <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> internal_iface_name_match.induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
     <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Matching›</span></span>
    <span class="keyword1"><span class="command">fun</span></span> <span class="entity">match_iface</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iface <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">match_iface</span> <span class="main">(</span>Iface <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p_iface</span></span></span> <span class="main">⟷</span> internal_iface_name_match <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p_iface</span></span></span>"</span></span>
    
    <span class="comment1">― ‹Examples›</span>
      <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"  match_iface <span class="main">(</span>Iface <span class="inner_quoted">''lo''</span><span class="main">)</span>    <span class="inner_quoted">''lo''</span>"</span></span>
            <span class="quoted"><span class="quoted">"  match_iface <span class="main">(</span>Iface <span class="inner_quoted">''lo+''</span><span class="main">)</span>   <span class="inner_quoted">''lo''</span>"</span></span>
            <span class="quoted"><span class="quoted">"  match_iface <span class="main">(</span>Iface <span class="inner_quoted">''l+''</span><span class="main">)</span>    <span class="inner_quoted">''lo''</span>"</span></span>
            <span class="quoted"><span class="quoted">"  match_iface <span class="main">(</span>Iface <span class="inner_quoted">''+''</span><span class="main">)</span>     <span class="inner_quoted">''lo''</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">¬</span> match_iface <span class="main">(</span>Iface <span class="inner_quoted">''lo++''</span><span class="main">)</span>  <span class="inner_quoted">''lo''</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">¬</span> match_iface <span class="main">(</span>Iface <span class="inner_quoted">''lo+++''</span><span class="main">)</span> <span class="inner_quoted">''lo''</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">¬</span> match_iface <span class="main">(</span>Iface <span class="inner_quoted">''lo1+''</span><span class="main">)</span>  <span class="inner_quoted">''lo''</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">¬</span> match_iface <span class="main">(</span>Iface <span class="inner_quoted">''lo1''</span><span class="main">)</span>   <span class="inner_quoted">''lo''</span>"</span></span>
            <span class="quoted"><span class="quoted">"  match_iface <span class="main">(</span>Iface <span class="inner_quoted">''+''</span><span class="main">)</span>     <span class="inner_quoted">''eth0''</span>"</span></span>
            <span class="quoted"><span class="quoted">"  match_iface <span class="main">(</span>Iface <span class="inner_quoted">''+''</span><span class="main">)</span>     <span class="inner_quoted">''eth0''</span>"</span></span>
            <span class="quoted"><span class="quoted">"  match_iface <span class="main">(</span>Iface <span class="inner_quoted">''eth+''</span><span class="main">)</span>  <span class="inner_quoted">''eth0''</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">¬</span> match_iface <span class="main">(</span>Iface <span class="inner_quoted">''lo+''</span><span class="main">)</span>   <span class="inner_quoted">''eth0''</span>"</span></span>
            <span class="quoted"><span class="quoted">"  match_iface <span class="main">(</span>Iface <span class="inner_quoted">''lo+''</span><span class="main">)</span>   <span class="inner_quoted">''loX''</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">¬</span> match_iface <span class="main">(</span>Iface <span class="inner_quoted">''''</span><span class="main">)</span>      <span class="inner_quoted">''loX''</span>"</span></span>
            <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span><span class="main"><span class="keyword3">+</span></span><span class="comment1">(*&gt;*)</span>
  
    <span class="keyword1" id="Iface-match_ifaceAny"><span class="command">lemma</span></span> match_ifaceAny<span class="main">:</span> <span class="quoted"><span class="quoted">"match_iface ifaceAny <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifaceAny_def<span class="main">)</span>
    <span class="keyword1" id="Iface-match_IfaceFalse"><span class="command">lemma</span></span> match_IfaceFalse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span> <span class="bound">IfaceFalse</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> match_iface <span class="bound">IfaceFalse</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> IfaceFalse<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">IfaceFalse</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> name<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">name</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> internal_iface_name_match_refl<span class="main">)</span>
      

    <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> match_iface<span class="antiquote">}</span></span> explained by the individual cases›</span>
    <span class="keyword1" id="Iface-match_iface_case_nowildcard"><span class="command">lemma</span></span> match_iface_case_nowildcard<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> iface_name_is_wildcard <span class="free">i</span> <span class="main">⟹</span> match_iface <span class="main">(</span>Iface <span class="free">i</span><span class="main">)</span> <span class="free">p_i</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">=</span> <span class="free">p_i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">p_i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> internal_iface_name_match.induct<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iface_name_is_wildcard_alt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1" id="Iface-match_iface_case_wildcard_prefix"><span class="command">lemma</span></span> match_iface_case_wildcard_prefix<span class="main">:</span>
      <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">i</span> <span class="main">⟹</span> match_iface <span class="main">(</span>Iface <span class="free">i</span><span class="main">)</span> <span class="free">p_i</span> <span class="main">⟷</span> butlast <span class="free">i</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p_i</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">p_i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> internal_iface_name_match.induct<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iface_name_is_wildcard_alt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iface_name_is_wildcard_alt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iface_name_is_wildcard_fst<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def length_0_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> take_Cons'<span class="main">)</span>
    <span class="keyword1" id="Iface-match_iface_case_wildcard_length"><span class="command">lemma</span></span> match_iface_case_wildcard_length<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">i</span> <span class="main">⟹</span> match_iface <span class="main">(</span>Iface <span class="free">i</span><span class="main">)</span> <span class="free">p_i</span> <span class="main">⟹</span> length <span class="free">p_i</span> <span class="main">≥</span> <span class="main">(</span>length <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">p_i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> internal_iface_name_match.induct<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iface_name_is_wildcard_alt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">corollary</span></span> match_iface_case_wildcard<span class="main">:</span>
      <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">i</span> <span class="main">⟹</span> match_iface <span class="main">(</span>Iface <span class="free">i</span><span class="main">)</span> <span class="free">p_i</span> <span class="main">⟷</span> butlast <span class="free">i</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p_i</span> <span class="main">∧</span> length <span class="free">p_i</span> <span class="main">≥</span> <span class="main">(</span>length <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> match_iface_case_wildcard_length match_iface_case_wildcard_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  
    <span class="keyword1" id="Iface-match_iface_set"><span class="command">lemma</span></span> match_iface_set<span class="main">:</span> <span class="quoted"><span class="quoted">"match_iface <span class="main">(</span>Iface <span class="free">i</span><span class="main">)</span> <span class="free">p_iface</span> <span class="main">⟷</span> <span class="free">p_iface</span> <span class="main">∈</span> internal_iface_name_to_set <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> internal_iface_name_to_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">internal_iface_name_wildcard_longest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string <span class="main">⇒</span> string option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">internal_iface_name_wildcard_longest</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword1">if</span> 
          take <span class="main">(</span>min <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">=</span> take <span class="main">(</span>min <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span>
        <span class="keyword1">then</span>
          Some <span class="main">(</span><span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">)</span>
        <span class="keyword1">else</span>
          None<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"internal_iface_name_wildcard_longest <span class="inner_quoted">''eth+''</span> <span class="inner_quoted">''eth3+''</span> <span class="main">=</span> Some <span class="inner_quoted">''eth3+''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"internal_iface_name_wildcard_longest <span class="inner_quoted">''eth+''</span> <span class="inner_quoted">''e+''</span> <span class="main">=</span> Some <span class="inner_quoted">''eth+''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"internal_iface_name_wildcard_longest <span class="inner_quoted">''eth+''</span> <span class="inner_quoted">''lo''</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  
    <span class="keyword2"><span class="keyword">private</span></span>  <span class="keyword1" id="Iface-internal_iface_name_wildcard_longest_commute"><span class="command">lemma</span></span> internal_iface_name_wildcard_longest_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">i1</span> <span class="main">⟹</span> iface_name_is_wildcard <span class="free">i2</span> <span class="main">⟹</span> 
      internal_iface_name_wildcard_longest <span class="free">i1</span> <span class="free">i2</span> <span class="main">=</span> internal_iface_name_wildcard_longest <span class="free">i2</span> <span class="free">i1</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> internal_iface_name_wildcard_longest_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iface_name_is_wildcard_alt<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def append_butlast_last_id butlast_conv_take<span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> min.commute<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword2"><span class="keyword">private</span></span>  <span class="keyword1" id="Iface-internal_iface_name_wildcard_longest_refl"><span class="command">lemma</span></span> internal_iface_name_wildcard_longest_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"internal_iface_name_wildcard_longest <span class="free">i</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> internal_iface_name_wildcard_longest_def<span class="main">)</span>
  
  
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-internal_iface_name_wildcard_longest_correct"><span class="command">lemma</span></span> internal_iface_name_wildcard_longest_correct<span class="main">:</span>
      <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">i1</span> <span class="main">⟹</span> iface_name_is_wildcard <span class="free">i2</span> <span class="main">⟹</span> 
       match_iface <span class="main">(</span>Iface <span class="free">i1</span><span class="main">)</span> <span class="free">p_i</span> <span class="main">∧</span> match_iface <span class="main">(</span>Iface <span class="free">i2</span><span class="main">)</span> <span class="free">p_i</span> <span class="main">⟷</span>
       <span class="main">(</span><span class="keyword1">case</span> internal_iface_name_wildcard_longest <span class="free">i1</span> <span class="free">i2</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> match_iface <span class="main">(</span>Iface <span class="bound">x</span><span class="main">)</span> <span class="free">p_i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">i1</span>"</span></span>
         <span class="keyword2"><span class="keyword">and</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">i2</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> assm3<span class="main">:</span> <span class="quoted"><span class="quoted">"internal_iface_name_wildcard_longest <span class="free">i1</span> <span class="free">i2</span> <span class="main">=</span> None"</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>internal_iface_name_match <span class="free">i1</span> <span class="free">p_i</span> <span class="main">∧</span> internal_iface_name_match <span class="free">i2</span> <span class="free">p_i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> match_iface_case_wildcard_prefix<span class="main">[</span><span class="operator">OF</span> assm1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span>
            <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="free">i1</span> <span class="free">p_i</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">i1</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p_i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_conv_take<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> match_iface_case_wildcard_prefix<span class="main">[</span><span class="operator">OF</span> assm2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span>
            <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="free">i2</span> <span class="free">p_i</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">i2</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p_i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_conv_take<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> assm3 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>min <span class="main">(</span>length <span class="free">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">i1</span> <span class="main">≠</span> take <span class="main">(</span>min <span class="main">(</span>length <span class="free">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">i2</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> internal_iface_name_wildcard_longest_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 min.commute take_take <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> internal_iface_name_wildcard_longest_correct_None<span class="main">=</span>this
    
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
        <span class="keyword3"><span class="command">assume</span></span> assm3<span class="main">:</span> <span class="quoted"><span class="quoted">"internal_iface_name_wildcard_longest <span class="free">i1</span> <span class="free">i2</span> <span class="main">=</span> Some <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>internal_iface_name_match <span class="free">i1</span> <span class="free">p_i</span> <span class="main">∧</span> internal_iface_name_match <span class="free">i2</span> <span class="free">p_i</span><span class="main">)</span> <span class="main">⟷</span> internal_iface_name_match <span class="skolem">X</span> <span class="free">p_i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> assm3 <span class="keyword1"><span class="command">have</span></span> assm3'<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>min <span class="main">(</span>length <span class="free">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">i1</span> <span class="main">=</span> take <span class="main">(</span>min <span class="main">(</span>length <span class="free">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">i2</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> internal_iface_name_wildcard_longest_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i1</span> <span class="skolem">i2</span>
            <span class="keyword3"><span class="command">assume</span></span> iw1<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="skolem">i1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> iw2<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="skolem">i2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">i1</span> <span class="main">≤</span> length <span class="skolem">i2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
                   take_i1i2<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">i1</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">i2</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> len <span class="keyword1"><span class="command">have</span></span> len'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">i1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> length <span class="skolem">i2</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">string</span>
             <span class="keyword1"><span class="command">from</span></span> len' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> takei1<span class="main">=</span>this
        
            <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">n</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span> <span class="skolem">c</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">⟹</span> take <span class="skolem">n</span> <span class="skolem">a</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="skolem">b</span> <span class="main">⟹</span> take <span class="skolem">m</span> <span class="skolem">a</span> <span class="main">=</span> take <span class="skolem">m</span> <span class="skolem">c</span> <span class="main">⟹</span> take <span class="skolem">m</span> <span class="skolem">c</span> <span class="main">=</span> take <span class="skolem">m</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> min_absorb1 take_take<span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> takesmaller<span class="main">=</span>this
        
            <span class="keyword1"><span class="command">from</span></span> match_iface_case_wildcard_prefix<span class="main">[</span><span class="operator">OF</span> iw1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span>
                <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="skolem">i1</span> <span class="free">p_i</span> <span class="main">⟷</span> take <span class="main">(</span>length <span class="skolem">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">i1</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p_i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_conv_take<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> take <span class="main">(</span>length <span class="skolem">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">i1</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p_i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> takei1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="skolem">i1</span> <span class="free">p_i</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">i1</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p_i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">from</span></span> match_iface_case_wildcard_prefix<span class="main">[</span><span class="operator">OF</span> iw2<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span>
                <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="skolem">i2</span> <span class="free">p_i</span> <span class="main">⟷</span> take <span class="main">(</span>length <span class="skolem">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">i2</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p_i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_conv_take<span class="main">)</span>
        
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"internal_iface_name_match <span class="skolem">i2</span> <span class="free">p_i</span> <span class="main">⟹</span> internal_iface_name_match <span class="skolem">i1</span> <span class="free">p_i</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> 1 2 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> takesmaller<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>length <span class="skolem"><span class="skolem">i1</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>length <span class="skolem"><span class="skolem">i2</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i2</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p_i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> len' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> take_i1i2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> longer_iface_imp_shorter<span class="main">=</span>this
        
         <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">i1</span> <span class="main">≤</span> length <span class="free">i2</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">with</span></span> assm3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="free">i2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> internal_iface_name_wildcard_longest_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> True assm3' <span class="keyword1"><span class="command">have</span></span> take_i1i2<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">i1</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">i1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
            <span class="keyword1"><span class="command">from</span></span> longer_iface_imp_shorter<span class="main">[</span><span class="operator">OF</span> assm1 assm2 True take_i1i2<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> <span class="free">i2</span>›</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>internal_iface_name_match <span class="free">i1</span> <span class="free">p_i</span> <span class="main">∧</span> internal_iface_name_match <span class="free">i2</span> <span class="free">p_i</span><span class="main">)</span> <span class="main">⟷</span> internal_iface_name_match <span class="skolem">X</span> <span class="free">p_i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">with</span></span> assm3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="free">i1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> internal_iface_name_wildcard_longest_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> False assm3' <span class="keyword1"><span class="command">have</span></span> take_i1i2<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">i2</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> min_def min_diff<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> longer_iface_imp_shorter<span class="main">[</span><span class="operator">OF</span> assm2 assm1 _ take_i1i2<span class="main">]</span> False <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> <span class="free">i1</span>›</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>internal_iface_name_match <span class="free">i1</span> <span class="free">p_i</span> <span class="main">∧</span> internal_iface_name_match <span class="free">i2</span> <span class="free">p_i</span><span class="main">)</span> <span class="main">⟷</span> internal_iface_name_match <span class="skolem">X</span> <span class="free">p_i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> internal_iface_name_wildcard_longest_correct_Some<span class="main">=</span>this
    
      <span class="keyword1"><span class="command">from</span></span> internal_iface_name_wildcard_longest_correct_None internal_iface_name_wildcard_longest_correct_Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.split<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
    <span class="keyword1"><span class="command">fun</span></span> <span class="entity">iface_conjunct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iface <span class="main">⇒</span> iface <span class="main">⇒</span> iface option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">iface_conjunct</span> <span class="main">(</span>Iface <span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">)</span> <span class="main">(</span>Iface <span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>iface_name_is_wildcard <span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">,</span> iface_name_is_wildcard <span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="main">(</span>True<span class="main">,</span>  True<span class="main">)</span> <span class="main">⇒</span> map_option Iface  <span class="main">(</span>internal_iface_name_wildcard_longest <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span> <span class="main">|</span>
        <span class="main">(</span>True<span class="main">,</span>  False<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> match_iface <span class="main">(</span>Iface <span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>Iface <span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">|</span>
        <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> match_iface <span class="main">(</span>Iface <span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>Iface <span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">|</span>
        <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>Iface <span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span>

    
    <span class="keyword1" id="Iface-iface_conjunct_Some"><span class="command">lemma</span></span> iface_conjunct_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_conjunct <span class="free">i1</span> <span class="free">i2</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> 
          match_iface <span class="free">x</span> <span class="free">p_i</span> <span class="main">⟷</span> match_iface <span class="free">i1</span> <span class="free">p_i</span> <span class="main">∧</span> match_iface <span class="free">i2</span> <span class="free">p_i</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">i2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> i1name i2name<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="improper">i1name</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="improper"><span class="improper">i2name</span></span>"</span></span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> internal_iface_name_wildcard_longest_correct <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> match_iface.simps match_iface_case_nowildcard option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> match_iface.simps match_iface_case_nowildcard option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> match_iface.simps option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.inject<span class="main">)</span>
    <span class="keyword1" id="Iface-iface_conjunct_None"><span class="command">lemma</span></span> iface_conjunct_None<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_conjunct <span class="free">i1</span> <span class="free">i2</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span>match_iface <span class="free">i1</span> <span class="free">p_i</span> <span class="main">∧</span> match_iface <span class="free">i2</span> <span class="free">p_i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">i2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> i1name i2name<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.split_asm if_split_asm<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> internal_iface_name_wildcard_longest_correct <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> match_iface.simps match_iface_case_nowildcard<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1" id="Iface-iface_conjunct"><span class="command">lemma</span></span> iface_conjunct<span class="main">:</span> <span class="quoted"><span class="quoted">"match_iface <span class="free">i1</span> <span class="free">p_i</span> <span class="main">∧</span> match_iface <span class="free">i2</span> <span class="free">p_i</span> <span class="main">⟷</span>
           <span class="main">(</span><span class="keyword1">case</span> iface_conjunct <span class="free">i1</span> <span class="free">i2</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> match_iface <span class="bound">x</span> <span class="free">p_i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> iface_conjunct_Some iface_conjunct_None<span class="main">)</span>

    <span class="keyword1" id="Iface-match_iface_refl"><span class="command">lemma</span></span> match_iface_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"match_iface <span class="main">(</span>Iface <span class="free">x</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> internal_iface_name_match_refl<span class="main">)</span>
    <span class="keyword1" id="Iface-match_iface_eqI"><span class="command">lemma</span></span> match_iface_eqI<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Iface <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match_iface <span class="free">x</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">using</span></span> match_iface_refl <span class="keyword1"><span class="command">.</span></span>


    <span class="keyword1" id="Iface-iface_conjunct_ifaceAny"><span class="command">lemma</span></span> iface_conjunct_ifaceAny<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_conjunct ifaceAny <span class="free">i</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifaceAny_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> iname<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="improper">iname</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> internal_iface_name_wildcard_longest_def iface_name_is_wildcard_alt Suc_leI<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> internal_iface_name_match.elims<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
       
    <span class="keyword1" id="Iface-iface_conjunct_commute"><span class="command">lemma</span></span> iface_conjunct_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_conjunct <span class="free">i1</span> <span class="free">i2</span> <span class="main">=</span> iface_conjunct <span class="free">i2</span> <span class="free">i1</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i1</span></span> <span class="quoted"><span class="free">i2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iface_conjunct.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> i1 i2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="improper">i1</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="improper"><span class="improper">i2</span></span>"</span></span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> internal_iface_name_wildcard_longest_commute<span class="main">)</span>


    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">internal_iface_name_subset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">internal_iface_name_subset</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>iface_name_is_wildcard <span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">,</span> iface_name_is_wildcard <span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="main">(</span>True<span class="main">,</span>  True<span class="main">)</span> <span class="main">⇒</span> length <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">≥</span> length <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">∧</span> take <span class="main">(</span><span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">=</span> butlast <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">|</span>
        <span class="main">(</span>True<span class="main">,</span>  False<span class="main">)</span> <span class="main">⇒</span> False <span class="main">|</span>
        <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> take <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">=</span> butlast <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">|</span>
        <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span>
        <span class="main">)</span>"</span></span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-butlast_take_length_helper"><span class="command">lemma</span></span> butlast_take_length_helper<span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span><span class="quoted"><span class="quoted">"char list"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">i2</span> <span class="main">≤</span> length <span class="free">i1</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">i1</span> <span class="main">=</span> butlast <span class="free">i2</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"butlast <span class="free">i1</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">i1</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"butlast <span class="free">i2</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="comment1">(*sledgehammer spass Isar proof*)</span>
      <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"List.gen_length <span class="main">0</span> <span class="free">i2</span> <span class="main">≤</span> List.gen_length <span class="main">0</span> <span class="free">i1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_code<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> f5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span><span class="main">.</span> List.gen_length <span class="main">0</span> <span class="main">(</span><span class="bound">cs</span><span class="main">::</span>char list<span class="main">)</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">=</span> List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="bound">cs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> One_nat_def length_code length_tl<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">f</span> <span class="main">(</span><span class="skolem">nn</span> <span class="bound">f</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">nn</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">f</span> <span class="main">(</span>List.gen_length <span class="main">0</span> <span class="free">i2</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">f</span> <span class="main">(</span>List.gen_length <span class="main">0</span> <span class="free">i1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> lift_Suc_mono_le<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">nn</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">≤</span> <span class="skolem">nn</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="free">i2</span><span class="main">)</span> <span class="main">≤</span> List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="free">i1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> diff_Suc_Suc diff_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> f6<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="free">i2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="free">i1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="free">i2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> diff_le_self min.absorb1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="free">i2</span><span class="main">)</span><span class="main">)</span> <span class="free">i1</span> <span class="main">≠</span> take <span class="main">(</span>List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="free">i2</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="free">i2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> take <span class="main">(</span>List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="free">i2</span><span class="main">)</span><span class="main">)</span> <span class="free">i1</span> <span class="main">=</span> take <span class="main">(</span>List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="free">i2</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f6 f5 a3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> One_nat_def butlast_conv_take length_code take_take<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="free">i2</span><span class="main">)</span><span class="main">)</span> <span class="free">i1</span> <span class="main">=</span> take <span class="main">(</span>List.gen_length <span class="main">0</span> <span class="main">(</span>tl <span class="free">i2</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"butlast <span class="free">i2</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f5 a2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> length_code<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-internal_iface_name_subset"><span class="command">lemma</span></span> internal_iface_name_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"internal_iface_name_subset <span class="free">i1</span> <span class="free">i2</span> <span class="main">⟷</span> 
        <span class="main">{</span><span class="bound">i</span><span class="main">.</span> internal_iface_name_match <span class="free">i1</span> <span class="bound">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> internal_iface_name_match <span class="free">i2</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> internal_iface_name_subset_def
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">i1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free"><span class="free">i2</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">i1</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">i2</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">i2</span> <span class="main">≤</span> length <span class="free">i1</span> <span class="main">∧</span> take <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">i1</span> <span class="main">=</span> butlast <span class="free">i2</span><span class="main">)</span> <span class="main">⟷</span>
            <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> internal_iface_name_match <span class="free">i1</span> <span class="bound">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> internal_iface_name_match <span class="free">i2</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="keyword1"><span class="command">with</span></span> a1 a2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> x<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> p_i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span></span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> match_iface_case_wildcard_prefix<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
             <span class="keyword1"><span class="command">using</span></span> butlast_take_length_helper <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">hence</span></span> r'<span class="main">:</span> <span class="quoted"><span class="quoted">"internal_iface_name_to_set <span class="free">i1</span> <span class="main">⊆</span> internal_iface_name_to_set <span class="free">i2</span> "</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> internal_iface_name_to_set2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
            <span class="keyword1"><span class="command">have</span></span> hlp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i1</span> <span class="bound">i2</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">i1</span> <span class="main">@</span> <span class="bound">cs</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">i2</span> <span class="main">@</span> <span class="bound">cs</span><span class="main">}</span> <span class="main">⟹</span> length <span class="bound">i2</span> <span class="main">≤</span> length <span class="bound">i1</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Set.Collect_mono_iff<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">have</span></span> hlp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i1</span> <span class="bound">i2</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">i1</span> <span class="main">@</span> <span class="bound">cs</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">i2</span> <span class="main">@</span> <span class="bound">cs</span><span class="main">}</span> <span class="main">⟹</span> take <span class="main">(</span>length <span class="bound">i2</span><span class="main">)</span> <span class="bound">i1</span> <span class="main">=</span> <span class="bound">i2</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Set.Collect_mono_iff<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">from</span></span> r' a1 a2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> internal_iface_name_to_set<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> hlp1<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred diff_Suc_eq_diff_pred diff_is_0_eq iface_name_is_wildcard.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> length_greater_0_conv<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> hlp2<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def butlast_conv_take length_butlast length_take take_take<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">i1</span> <span class="main">⟹</span> <span class="main">¬</span> iface_name_is_wildcard <span class="free">i2</span> <span class="main">⟹</span>
            <span class="main">¬</span> Collect <span class="main">(</span>internal_iface_name_match <span class="free">i1</span><span class="main">)</span> <span class="main">⊆</span> Collect <span class="main">(</span>internal_iface_name_match <span class="free">i2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> internal_iface_name_match_refl match_iface_case_nowildcard <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> iface_name_is_wildcard <span class="free">i1</span> <span class="main">⟹</span> iface_name_is_wildcard <span class="free">i2</span> <span class="main">⟹</span>
            <span class="main">(</span>take <span class="main">(</span>length <span class="free">i2</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">i1</span> <span class="main">=</span> butlast <span class="free">i2</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> internal_iface_name_match <span class="free">i1</span> <span class="bound">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> internal_iface_name_match <span class="free">i2</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> match_iface_case_nowildcard match_iface_case_wildcard_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> iface_name_is_wildcard <span class="free">i1</span> <span class="main">⟹</span> <span class="main">¬</span> iface_name_is_wildcard <span class="free">i2</span> <span class="main">⟹</span>
           <span class="main">(</span><span class="free">i1</span> <span class="main">=</span> <span class="free">i2</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> internal_iface_name_match <span class="free">i1</span> <span class="bound">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> internal_iface_name_match <span class="free">i2</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> match_iface_case_nowildcard  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>
      
       
    
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">iface_subset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iface <span class="main">⇒</span> iface <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">iface_subset</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">⟷</span> internal_iface_name_subset <span class="main">(</span>iface_sel <span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">)</span> <span class="main">(</span>iface_sel <span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span>"</span></span>
    
    <span class="keyword1" id="Iface-iface_subset"><span class="command">lemma</span></span> iface_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_subset <span class="free">i1</span> <span class="free">i2</span> <span class="main">⟷</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> match_iface <span class="free">i1</span> <span class="bound">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> match_iface <span class="free">i2</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> iface_subset_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">i2</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> internal_iface_name_subset<span class="main">)</span>


    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">iface_is_wildcard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iface <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">iface_is_wildcard</span> <span class="free"><span class="bound"><span class="entity">ifce</span></span></span> <span class="main">≡</span> iface_name_is_wildcard <span class="main">(</span>iface_sel <span class="free"><span class="bound"><span class="entity">ifce</span></span></span><span class="main">)</span>"</span></span>
   
    <span class="keyword1" id="Iface-iface_is_wildcard_ifaceAny"><span class="command">lemma</span></span> iface_is_wildcard_ifaceAny<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_is_wildcard ifaceAny"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iface_is_wildcard_def ifaceAny_def<span class="main">)</span>




  <span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Enumerating Interfaces›</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_chars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"char list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">all_chars</span> <span class="main">≡</span> Enum.enum"</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-all_chars"><span class="command">lemma</span></span> all_chars<span class="main">:</span> <span class="quoted"><span class="quoted">"set all_chars <span class="main">=</span> <span class="main">(</span>UNIV<span class="main">::</span>char set<span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_chars_def enum_UNIV<span class="main">)</span>
  
    <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹we can compute this, but its horribly inefficient!›</span></span>
    <span class="comment1">(*valid chars in an interface are NOT limited to the printable ones!*)</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-strings_of_length_n"><span class="command">lemma</span></span> strings_of_length_n<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>List.n_lists <span class="free">n</span> all_chars<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">::</span>string<span class="main">.</span> length <span class="bound">s</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_chars<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> n x<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"drop <span class="main">1</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
    <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Non-wildacrd interfaces of length <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">non_wildcard_ifaces</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> string list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     <span class="quoted"><span class="quoted">"<span class="free">non_wildcard_ifaces</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> iface_name_is_wildcard <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>List.n_lists <span class="free"><span class="bound"><span class="entity">n</span></span></span> all_chars<span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Example: (any number higher than zero are probably too inefficient)›</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"non_wildcard_ifaces <span class="main">0</span> <span class="main">=</span> <span class="main">[</span><span class="inner_quoted">''''</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-non_wildcard_ifaces"><span class="command">lemma</span></span> non_wildcard_ifaces<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>non_wildcard_ifaces <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">::</span>string<span class="main">.</span> length <span class="bound">s</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> iface_name_is_wildcard <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> strings_of_length_n non_wildcard_ifaces_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>non_wildcard_ifaces <span class="free">n</span><span class="main">)</span><span class="main">.</span> internal_iface_name_to_set <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">::</span>string<span class="main">.</span> length <span class="bound">s</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> iface_name_is_wildcard <span class="bound">s</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> non_wildcard_ifaces<span class="main">)</span>
  
    <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Non-wildacrd interfaces up to length <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">non_wildcard_ifaces_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> string list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">non_wildcard_ifaces_upto</span> <span class="main">0</span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">non_wildcard_ifaces_upto</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>non_wildcard_ifaces <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="free">non_wildcard_ifaces_upto</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-non_wildcard_ifaces_upto"><span class="command">lemma</span></span> non_wildcard_ifaces_upto<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>non_wildcard_ifaces_upto <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">::</span>string<span class="main">.</span> length <span class="bound">s</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> iface_name_is_wildcard <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">using</span></span> non_wildcard_ifaces <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


  <span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Negating Interfaces›</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Iface-inv_iface_name_set"><span class="command">lemma</span></span> inv_iface_name_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span>internal_iface_name_to_set <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">if</span> iface_name_is_wildcard <span class="free">i</span>
      <span class="keyword1">then</span>
        <span class="main">{</span><span class="bound">c</span> <span class="main">|</span><span class="bound">c</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">&lt;</span> length <span class="main">(</span>butlast <span class="free">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">c</span> <span class="main">@</span> <span class="bound">cs</span> <span class="main">|</span><span class="bound">c</span> <span class="bound">cs</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">=</span> length <span class="main">(</span>butlast <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">≠</span> butlast <span class="free">i</span><span class="main">}</span>
      <span class="keyword1">else</span>
        <span class="main">{</span><span class="bound">c</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">&lt;</span> length <span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">c</span><span class="main">@</span><span class="bound">cs</span> <span class="main">|</span> <span class="bound">c</span> <span class="bound">cs</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">≥</span> length <span class="free">i</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">≠</span> <span class="free">i</span><span class="main">}</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="quoted">string</span>
        <span class="keyword1"><span class="command">have</span></span> inv_i_wildcard<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">{</span><span class="skolem">i</span><span class="main">@</span><span class="bound">cs</span> <span class="main">|</span> <span class="bound">cs</span><span class="main">.</span> True<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">&lt;</span> length <span class="skolem">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">c</span><span class="main">@</span><span class="bound">cs</span> <span class="main">|</span> <span class="bound">c</span> <span class="bound">cs</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">=</span> length <span class="skolem">i</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">≠</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Set.equalityI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Compl_anti_mono<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="skolem"><span class="skolem">i</span></span> <span class="main"><span class="main">@</span></span> <span class="bound"><span class="bound">cs</span></span> <span class="main"><span class="main">|</span></span><span class="bound"><span class="bound">cs</span></span><span class="main"><span class="main">.</span></span> True<span class="main"><span class="main">}</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">c</span></span> <span class="main"><span class="main">|</span></span> <span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">.</span></span> length <span class="bound"><span class="bound">c</span></span> <span class="main"><span class="main">&lt;</span></span> length <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">∪</span></span> <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">@</span></span><span class="bound"><span class="bound">cs</span></span> <span class="main"><span class="main">|</span></span> <span class="bound"><span class="bound">c</span></span> <span class="bound"><span class="bound">cs</span></span><span class="main"><span class="main">.</span></span> length <span class="bound"><span class="bound">c</span></span> <span class="main"><span class="main">=</span></span> length <span class="skolem"><span class="skolem">i</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">c</span></span> <span class="main"><span class="main">≠</span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> length <span class="improper">x</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">i</span><span class="main">)</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> inv_i_wildcard<span class="main">=</span>this
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="quoted">string</span>
        <span class="keyword1"><span class="command">have</span></span> inv_i_nowildcard<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">{</span><span class="skolem">i</span><span class="main">::</span>string<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">&lt;</span> length <span class="skolem">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">c</span><span class="main">@</span><span class="bound">cs</span> <span class="main">|</span> <span class="bound">c</span> <span class="bound">cs</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">≥</span> length <span class="skolem">i</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">≠</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">c</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">=</span> length <span class="skolem">i</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">≠</span> <span class="skolem">i</span><span class="main">}</span>  <span class="main">∪</span> <span class="main">{</span><span class="bound">c</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">&gt;</span> length <span class="skolem">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span><span class="main">@</span><span class="bound">cs</span> <span class="main">|</span> <span class="bound">c</span> <span class="bound">cs</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">≥</span> length <span class="skolem">i</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">≠</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">{</span><span class="skolem">i</span><span class="main">::</span>string<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span> <span class="main">|</span><span class="bound">c</span> <span class="main">.</span> <span class="bound">c</span> <span class="main">≠</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">&lt;</span> length <span class="skolem">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">c</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">=</span> length <span class="skolem">i</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">≠</span> <span class="skolem">i</span><span class="main">}</span>  <span class="main">∪</span> <span class="main">{</span><span class="bound">c</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">&gt;</span> length <span class="skolem">i</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> inv_i_nowildcard<span class="main">=</span>this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"iface_name_is_wildcard <span class="free">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> inv_i_wildcard <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> inv_i_nowildcard <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Negating is really not intuitive.
          The Interface <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted"><span class="inner_quoted">''et''</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is in the negated set of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted"><span class="inner_quoted">''eth+''</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
          And the Interface <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted"><span class="inner_quoted">''et+''</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is also in this set! This is because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted"><span class="inner_quoted">''+''</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
          is a normal interface character and not a wildcard here!
          In contrast, the set described by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted"><span class="inner_quoted">''et+''</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted"><span class="inner_quoted">''+''</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> a wildcard)
          is not a subset of the previously negated set.›</span></span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''et''</span> <span class="main">∈</span> <span class="main">-</span> <span class="main">(</span>internal_iface_name_to_set <span class="inner_quoted">''eth+''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''et+''</span> <span class="main">∈</span> <span class="main">-</span> <span class="main">(</span>internal_iface_name_to_set <span class="inner_quoted">''eth+''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''+''</span> <span class="main">∈</span> <span class="main">-</span> <span class="main">(</span>internal_iface_name_to_set <span class="inner_quoted">''eth+''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> match_iface <span class="main">(</span>Iface <span class="inner_quoted">''et+''</span><span class="main">)</span> <span class="bound">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">-</span> <span class="main">(</span>internal_iface_name_to_set <span class="inner_quoted">''eth+''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted"><span class="inner_quoted">''+''</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can appear as interface wildcard and normal interface character,
          we cannot take negate an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Iface <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that we get back <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"iface list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> which
          describe the negated interface.›</span></span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''+''</span> <span class="main">∈</span> <span class="main">-</span> <span class="main">(</span>internal_iface_name_to_set <span class="inner_quoted">''eth+''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>




  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">compress_pos_interfaces</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iface list <span class="main">⇒</span> iface option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">compress_pos_interfaces</span> <span class="main">[]</span> <span class="main">=</span> Some ifaceAny"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">compress_pos_interfaces</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">compress_pos_interfaces</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> iface_conjunct <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">i</span> <span class="main">⇒</span> <span class="free">compress_pos_interfaces</span> <span class="main">(</span><span class="bound">i</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Iface-compress_pos_interfaces_Some"><span class="command">lemma</span></span> compress_pos_interfaces_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"compress_pos_interfaces <span class="free">ifces</span> <span class="main">=</span> Some <span class="free">ifce</span> <span class="main">⟹</span> 
          match_iface <span class="free">ifce</span> <span class="free">p_i</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">∈</span> set <span class="free">ifces</span><span class="main">.</span> match_iface <span class="bound">i</span> <span class="free">p_i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ifces</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> compress_pos_interfaces.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> match_ifaceAny<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i1</span> <span class="skolem">i2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"iface_conjunct <span class="skolem">i1</span> <span class="skolem">i2</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> iface_conjunct_Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Iface-compress_pos_interfaces_None"><span class="command">lemma</span></span> compress_pos_interfaces_None<span class="main">:</span> <span class="quoted"><span class="quoted">"compress_pos_interfaces <span class="free">ifces</span> <span class="main">=</span> None <span class="main">⟹</span> 
          <span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">∈</span> set <span class="free">ifces</span><span class="main">.</span> match_iface <span class="bound">i</span> <span class="free">p_i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ifces</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> compress_pos_interfaces.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> match_ifaceAny<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i1</span> <span class="skolem">i2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"iface_conjunct <span class="skolem">i1</span> <span class="skolem">i2</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> iface_conjunct_None<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> iface_conjunct_Some<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>



  <span class="keyword1"><span class="command">declare</span></span> match_iface.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> iface_name_is_wildcard.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SimpleFw_Syntax">
<div class="head">
<h1>Theory SimpleFw_Syntax</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Simple Firewall Syntax›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SimpleFw_Syntax
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../IP_Addresses/Hs_Compat.html">IP_Addresses.Hs_Compat</a>
        <a href="Firewall_Common_Decision_State.html">Firewall_Common_Decision_State</a>
        <span class="quoted">"<a href="Iface.html">Primitives/Iface</a>"</span>
        <span class="quoted">"<a href="L4_Protocol.html">Primitives/L4_Protocol</a>"</span>
        <a href="Simple_Packet.html">Simple_Packet</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For for IP addresses of arbitrary length›</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> simple_action <span class="main">=</span> Accept <span class="main">|</span> Drop
  
  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Simple match expressions do not allow negated expressions.
        However, Most match expressions can still be transformed into simple match expressions.
        
        A negated IP address range can be represented as a set of non-negated IP ranges.
        For example <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>!8 = {0..7} ∪ {8 .. ipv4max}›</span></span></span></span>.
        Using CIDR notation (i.e. the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a.b.c.d/n›</span></span></span></span> notation), we can represent negated IP
        ranges as a set of non-negated IP ranges with only fair blowup.
        Another handy result is that the conjunction of two IP ranges in CIDR notation is 
        either the smaller of the two ranges or the empty set.
        An empty IP range cannot be represented.
        If one wants to represent the empty range, then the complete rule needs to be removed.

        The same holds for layer 4 ports.
        In addition, there exists an empty port range, e.g. <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(1,0)›</span></span></span></span>.
        The conjunction of two port ranges is again just one port range.
        
        But negation of interfaces is not supported. Since interfaces support a wildcard character,
        transforming a negated interface would either result in an infeasible blowup or requires
        knowledge about the existing interfaces (e.g. there only is eth0, eth1, wlan3, and vbox42)
        An empirical test shows that negated interfaces do not occur in our data sets.
        Negated interfaces can also be considered bad style: What is !eth0? Everything that is
        not eth0, experience shows that interfaces may come up randomly, in particular in combination 
        with virtual machines, so !eth0 might not be the desired match.
        At the moment, if an negated interface occurs which prevents translation to a simple match,
        we recommend to abstract the negated interface to unknown and remove it (upper or lower closure
        rule set) before translating to a simple match.
        The same discussion holds for negated protocols.

        Noteworthy, simple match expressions are both expressive and support conjunction:
        <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>simple-match1 ∧ simple-match2 = simple-match3›</span></span></span></span>
›</span></span>
        <span class="comment1">(*It took very long to design the simple match such that it can represent everything we need
        and that you can calculate with it. Disjunction is easy: just have two consecutive rules with the same action.
        Conjunction was a tough fight! It is needed to translate:
        common_primitive_match_to_simple_match (MatchAny e1 e2) =
          simple_match_and (common_primitive_match_to_simple_match e1) (common_primitive_match_to_simple_match e2)
        This is key to translate common_primitive_match to simple_match

        It may seem a simple enhancement to support iiface :: "iface negation_type", but then you
        can no longer form the conjunction of two simple_matches.
        *)</span>

  <span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="tfree">'i</span> simple_match <span class="main">=</span>
    iiface <span class="main">::</span> <span class="quoted"><span class="quoted">"iface"</span></span> <span class="comment1">― ‹in-interface›</span>
      <span class="comment1">(*we cannot (and don't want to) express negated interfaces*)</span>
      <span class="comment1">(*We could also drop interface wildcard support and try negated interfaces again …*)</span>
    oiface <span class="main">::</span> <span class="quoted"><span class="quoted">"iface"</span></span> <span class="comment1">― ‹out-interface›</span>
    src <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>len word <span class="main">×</span> nat<span class="main">)</span> "</span></span> <span class="comment1">― ‹source IP address›</span>
    dst <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>len word <span class="main">×</span> nat<span class="main">)</span> "</span></span> <span class="comment1">― ‹destination›</span>
    proto <span class="main">::</span> <span class="quoted"><span class="quoted">"protocol"</span></span>
    sports <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">16</span> word <span class="main">×</span> <span class="numeral">16</span> word<span class="main">)</span>"</span></span> <span class="comment1">― ‹source-port first:last›</span>
    dports <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">16</span> word <span class="main">×</span> <span class="numeral">16</span> word<span class="main">)</span>"</span></span> <span class="comment1">― ‹destination-port first:last›</span>

  
  <span class="keyword1"><span class="command">context</span></span>
    <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">typedef_overloaded</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'i</span> simple_rule <span class="main">=</span> SimpleRule <span class="main">(</span><span class="free"><span class="entity">match_sel</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> simple_match"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">action_sel</span></span><span class="main">:</span> <span class="quoted">simple_action</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Simple rule destructor. Removes the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> simple_rule"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> type, returns a tuple with the match and action.›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_rule_dtor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> simple_rule <span class="main">⇒</span> <span class="tfree">'a</span> simple_match <span class="main">×</span> simple_action"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_rule_dtor</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> SimpleRule <span class="bound">m</span> <span class="bound">a</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="SimpleFw_Syntax-simple_rule_dtor_ids"><span class="command">lemma</span></span> simple_rule_dtor_ids<span class="main">:</span>
    <span class="quoted"><span class="quoted">"uncurry SimpleRule <span class="main">∘</span> simple_rule_dtor <span class="main">=</span> id"</span></span>
    <span class="quoted"><span class="quoted">"simple_rule_dtor <span class="main">∘</span> uncurry SimpleRule <span class="main">=</span> id"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> simple_rule_dtor_def comp_def fun_eq_iff
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> simple_rule.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SimpleFw_Semantics">
<div class="head">
<h1>Theory SimpleFw_Semantics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Simple Firewall Semantics›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SimpleFw_Semantics
<span class="keyword2"><span class="keyword">imports</span></span> <a href="SimpleFw_Syntax.html">SimpleFw_Syntax</a>
        <a href="../IP_Addresses/IP_Address.html">IP_Addresses.IP_Address</a>
        <a href="../IP_Addresses/Prefix_Match.html">IP_Addresses.Prefix_Match</a>
<span class="keyword2"><span class="keyword">begin</span></span>


  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_match_ip</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>len word <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'i</span><span class="main">::</span>len word <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_match_ip</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">base</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p_ip</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">p_ip</span></span></span> <span class="main">∈</span> ipset_from_cidr <span class="free"><span class="bound"><span class="entity">base</span></span></span> <span class="free"><span class="bound"><span class="entity">len</span></span></span>"</span></span>

  <span class="keyword1" id="SimpleFw_Semantics-wordinterval_to_set_ipcidr_tuple_to_wordinterval_simple_match_ip_set"><span class="command">lemma</span></span> wordinterval_to_set_ipcidr_tuple_to_wordinterval_simple_match_ip_set<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wordinterval_to_set <span class="main">(</span>ipcidr_tuple_to_wordinterval <span class="free">ip</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> simple_match_ip <span class="free">ip</span> <span class="bound">d</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word <span class="main">×</span> nat"</span></span>
        <span class="keyword1"><span class="command">from</span></span> wordinterval_to_set_ipcidr_tuple_to_wordinterval <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> wordinterval_to_set <span class="main">(</span>ipcidr_tuple_to_wordinterval <span class="skolem">d</span><span class="main">)</span> <span class="main">⟷</span> simple_match_ip <span class="skolem">d</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹by the way, the words do not wrap around›</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="numeral">253</span><span class="main">::</span><span class="numeral">8</span> word<span class="main">)</span> <span class="main">..</span> <span class="numeral">8</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_match_port</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">16</span> word <span class="main">×</span> <span class="numeral">16</span> word<span class="main">)</span> <span class="main">⇒</span> <span class="numeral">16</span> word <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_match_port</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p_p</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">p_p</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_matches</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_match <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> simple_packet_scheme <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_matches</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span>
      <span class="main">(</span>match_iface <span class="main">(</span>iiface <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>p_iiface <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span>match_iface <span class="main">(</span>oiface <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>p_oiface <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span>simple_match_ip <span class="main">(</span>src <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>p_src <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span>simple_match_ip <span class="main">(</span>dst <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>p_dst <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span>match_proto <span class="main">(</span>proto <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>p_proto <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span>simple_match_port <span class="main">(</span>sports <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>p_sport <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span>simple_match_port <span class="main">(</span>dports <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>p_dport <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The semantics of a simple firewall: just iterate over the rules sequentially›</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_fw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> simple_packet_scheme <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_fw</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Undecided"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_fw</span> <span class="main">(</span><span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> Accept<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> simple_matches <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> Decision FinalAllow <span class="keyword1">else</span> <span class="free">simple_fw</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_fw</span> <span class="main">(</span><span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> Drop<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> simple_matches <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> Decision FinalDeny <span class="keyword1">else</span> <span class="free">simple_fw</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>
 
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_fw_alt</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_fw_alt</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Undecided"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_fw_alt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> simple_matches <span class="main">(</span>match_sel <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> 
    	<span class="main">(</span><span class="keyword1">case</span> action_sel <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> Accept <span class="main">⇒</span> Decision FinalAllow <span class="main">|</span> Drop <span class="main">⇒</span> Decision FinalDeny<span class="main">)</span> <span class="keyword1">else</span> <span class="free">simple_fw_alt</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>
 
  <span class="keyword1" id="SimpleFw_Semantics-simple_fw_alt"><span class="command">lemma</span></span> simple_fw_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_fw <span class="free">r</span> <span class="free">p</span> <span class="main">=</span> simple_fw_alt <span class="free">r</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> simple_fw.induct<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_match_any</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_match"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_match_any</span> <span class="main">≡</span> <span class="main">⦇</span>iiface<span class="main">=</span>ifaceAny<span class="main">,</span> oiface<span class="main">=</span>ifaceAny<span class="main">,</span> src<span class="main">=</span><span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> dst<span class="main">=</span><span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> proto<span class="main">=</span>ProtoAny<span class="main">,</span> sports<span class="main">=</span><span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="numeral">65535</span><span class="main">)</span><span class="main">,</span> dports<span class="main">=</span><span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="numeral">65535</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
  <span class="keyword1" id="SimpleFw_Semantics-simple_match_any"><span class="command">lemma</span></span> simple_match_any<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_matches simple_match_any <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">65535</span><span class="main">::</span><span class="numeral">16</span> word<span class="main">)</span> <span class="main">=</span> max_word"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_match_any_def ipset_from_cidr_0 match_ifaceAny *<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹we specify only one empty port range›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_match_none</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_match"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_match_none</span> <span class="main">≡</span>
      <span class="main">⦇</span>iiface<span class="main">=</span>ifaceAny<span class="main">,</span> oiface<span class="main">=</span>ifaceAny<span class="main">,</span> src<span class="main">=</span><span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> dst<span class="main">=</span><span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">,</span>
       proto<span class="main">=</span>ProtoAny<span class="main">,</span> sports<span class="main">=</span><span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> dports<span class="main">=</span><span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="numeral">65535</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
  <span class="keyword1" id="SimpleFw_Semantics-simple_match_none"><span class="command">lemma</span></span> simple_match_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> simple_matches simple_match_none <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_match_none_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">empty_match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_match <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">empty_match</span> <span class="main">⦇</span>iiface<span class="main">=</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> oiface<span class="main">=</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> src<span class="main">=</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> dst<span class="main">=</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> proto<span class="main">=</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span>
                  sports<span class="main">=</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sps1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sps2</span></span></span><span class="main">)</span><span class="main">,</span> dports<span class="main">=</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">dps1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">dps2</span></span></span><span class="main">)</span> <span class="main">⦈</span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sps1</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">sps2</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dps1</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">dps2</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="SimpleFw_Semantics-empty_match"><span class="command">lemma</span></span> empty_match<span class="main">:</span> <span class="quoted"><span class="quoted">"empty_match <span class="free">m</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">p</span><span class="main">::</span><span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>len<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> simple_packet_scheme<span class="main">)</span><span class="main">.</span> <span class="main">¬</span> simple_matches <span class="free">m</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"empty_match <span class="free">m</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">¬</span> simple_matches <span class="free">m</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">p</span><span class="main">::</span><span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>len<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> simple_packet_scheme<span class="main">)</span><span class="main">.</span> <span class="main">¬</span> simple_matches <span class="free">m</span> <span class="bound">p</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">iif</span></span> <span class="skolem"><span class="skolem">oif</span></span> <span class="skolem"><span class="skolem">sip</span></span> <span class="skolem"><span class="skolem">dip</span></span> <span class="skolem"><span class="skolem">protocol</span></span> <span class="skolem"><span class="skolem">sps1</span></span> <span class="skolem"><span class="skolem">sps2</span></span> <span class="skolem"><span class="skolem">dps1</span></span> <span class="skolem"><span class="skolem">dps2</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">⦇</span>iiface <span class="main">=</span> <span class="skolem">iif</span><span class="main">,</span> oiface <span class="main">=</span> <span class="skolem">oif</span><span class="main">,</span> src <span class="main">=</span> <span class="skolem">sip</span><span class="main">,</span> dst <span class="main">=</span> <span class="skolem">dip</span><span class="main">,</span> proto <span class="main">=</span> <span class="skolem">protocol</span><span class="main">,</span> sports <span class="main">=</span> <span class="main">(</span><span class="skolem">sps1</span><span class="main">,</span> <span class="skolem">sps2</span><span class="main">)</span><span class="main">,</span> dports <span class="main">=</span> <span class="main">(</span><span class="skolem">dps1</span><span class="main">,</span> <span class="skolem">dps2</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">force</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"empty_match <span class="free">m</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m<span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">dps1</span> <span class="main">≤</span> p_dport <span class="bound">p</span> <span class="main">⟶</span> p_sport <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">sps2</span> <span class="main">⟶</span> <span class="skolem">sps1</span> <span class="main">≤</span> p_sport <span class="bound">p</span> <span class="main">⟶</span> 
              match_proto <span class="skolem">protocol</span> <span class="main">(</span>p_proto <span class="bound">p</span><span class="main">)</span> <span class="main">⟶</span> simple_match_ip <span class="skolem">dip</span> <span class="main">(</span>p_dst <span class="bound">p</span><span class="main">)</span> <span class="main">⟶</span> simple_match_ip <span class="skolem">sip</span> <span class="main">(</span>p_src <span class="bound">p</span><span class="main">)</span> <span class="main">⟶</span>
              match_iface <span class="skolem">oif</span> <span class="main">(</span>p_oiface <span class="bound">p</span><span class="main">)</span> <span class="main">⟶</span> match_iface <span class="skolem">iif</span> <span class="main">(</span>p_iiface <span class="bound">p</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span> p_dport <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">dps2</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> assm <span class="keyword1"><span class="command">have</span></span> nomatch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">p</span><span class="main">::</span><span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>len<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> simple_packet_scheme<span class="main">)</span><span class="main">.</span> <span class="var">?x</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m<span class="main">)</span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ips</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len word <span class="main">×</span> nat"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> ipset_from_cidr <span class="skolem">a</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len word"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">n</span>
              <span class="keyword1"><span class="command">using</span></span> ipset_from_cidr_lowest <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"simple_match_ip <span class="skolem">ips</span> <span class="main">(</span>fst <span class="skolem">ips</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ips</span></span><span class="main">)</span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> ips<span class="main">=</span>this
          <span class="keyword1"><span class="command">have</span></span> proto<span class="main">:</span> <span class="quoted"><span class="quoted">"match_proto <span class="skolem">protocol</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">protocol</span> <span class="keyword1">of</span> ProtoAny <span class="main">⇒</span> TCP <span class="main">|</span> Proto <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> protocol.split<span class="main">)</span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ifce</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" match_iface <span class="skolem">ifce</span> <span class="main">(</span>iface_sel <span class="skolem">ifce</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ifce</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> match_iface_refl<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> ifaces<span class="main">=</span>this
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> simple_packet_scheme"</span></span>
            <span class="keyword1"><span class="command">from</span></span> nomatch <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> pkt1<span class="main">=</span>this
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> simple_packet_scheme"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
			  <span class="quoted"><span class="quoted">"p_iiface <span class="skolem">p</span> <span class="main">=</span> iface_sel <span class="skolem">iif</span>"</span></span>
			  <span class="quoted"><span class="quoted">"p_oiface <span class="skolem">p</span> <span class="main">=</span> iface_sel <span class="skolem">oif</span>"</span></span>
			  <span class="quoted"><span class="quoted">"p_src <span class="skolem">p</span> <span class="main">=</span> fst <span class="skolem">sip</span>"</span></span>
			  <span class="quoted"><span class="quoted">"p_dst <span class="skolem">p</span> <span class="main">=</span> fst <span class="skolem">dip</span>"</span></span>
			  <span class="quoted"><span class="quoted">"p_proto <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">protocol</span> <span class="keyword1">of</span> ProtoAny <span class="main">⇒</span> TCP <span class="main">|</span> Proto <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
			  <span class="quoted"><span class="quoted">"p_sport <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">sps1</span>"</span></span>
			  <span class="quoted"><span class="quoted">"p_dport <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">dps1</span>"</span></span>
			  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> simple_packet.select_convs<span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> pkt<span class="main">=</span>pkt1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          <span class="keyword1"><span class="command">from</span></span> pkt ips proto ifaces <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">sps1</span> <span class="main">≤</span> <span class="skolem">sps2</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="skolem">dps1</span> <span class="main">≤</span> <span class="skolem">dps2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sps2</span> <span class="main">&lt;</span> <span class="skolem">sps1</span> <span class="main">∨</span> <span class="skolem">dps2</span> <span class="main">&lt;</span> <span class="skolem">dps1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
    

  <span class="keyword1" id="SimpleFw_Semantics-nomatch"><span class="command">lemma</span></span> nomatch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> simple_matches <span class="free">m</span> <span class="free">p</span> <span class="main">⟹</span> simple_fw <span class="main">(</span>SimpleRule <span class="free">m</span> <span class="free">a</span> <span class="main">#</span> <span class="free">rs</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> simple_matches.simps<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Simple Ports›</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">simpl_ports_conjunct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">16</span> word <span class="main">×</span> <span class="numeral">16</span> word<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="numeral">16</span> word <span class="main">×</span> <span class="numeral">16</span> word<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="numeral">16</span> word <span class="main">×</span> <span class="numeral">16</span> word<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simpl_ports_conjunct</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p1s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p1e</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p2s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p2e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>max <span class="free"><span class="bound"><span class="entity">p1s</span></span></span> <span class="free"><span class="bound"><span class="entity">p2s</span></span></span><span class="main">,</span> min <span class="free"><span class="bound"><span class="entity">p1e</span></span></span> <span class="free"><span class="bound"><span class="entity">p2e</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">p1s</span><span class="main">::</span> <span class="numeral">16</span> word<span class="main">)</span> <span class="main">..</span> <span class="free">p1e</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">p2s</span> <span class="main">..</span> <span class="free">p2e</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>max <span class="free">p1s</span> <span class="free">p2s</span> <span class="main">..</span> min <span class="free">p1e</span> <span class="free">p2e</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  
  <span class="keyword1" id="SimpleFw_Semantics-simple_ports_conjunct_correct"><span class="command">lemma</span></span> simple_ports_conjunct_correct<span class="main">:</span>
    <span class="quoted"><span class="quoted">"simple_match_port <span class="free">p1</span> <span class="free">pkt</span> <span class="main">∧</span> simple_match_port <span class="free">p2</span> <span class="free">pkt</span> <span class="main">⟷</span> simple_match_port <span class="main">(</span>simpl_ports_conjunct <span class="free">p1</span> <span class="free">p2</span><span class="main">)</span> <span class="free">pkt</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">p2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1" id="SimpleFw_Semantics-simple_match_port_code"><span class="command">lemma</span></span> simple_match_port_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">:</span><span class="quoted"><span class="quoted">"simple_match_port <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="free">p_p</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">≤</span> <span class="free">p_p</span> <span class="main">∧</span> <span class="free">p_p</span> <span class="main">≤</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="SimpleFw_Semantics-simple_match_port_UNIV"><span class="command">lemma</span></span> simple_match_port_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_match_port <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="bound">p</span><span class="main">}</span> <span class="main">=</span> UNIV <span class="main">⟷</span> <span class="main">(</span><span class="free">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">=</span> max_word<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> antisym_conv <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">using</span></span> word_le_0_iff <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> word_zero_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Simple IPs›</span></span>
  <span class="keyword1" id="SimpleFw_Semantics-simple_match_ip_conjunct"><span class="command">lemma</span></span> simple_match_ip_conjunct<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ip1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len word <span class="main">×</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_match_ip <span class="free">ip1</span> <span class="free">p_ip</span> <span class="main">∧</span> simple_match_ip <span class="free">ip2</span> <span class="free">p_ip</span> <span class="main">⟷</span> 
            <span class="main">(</span><span class="keyword1">case</span> ipcidr_conjunct <span class="free">ip1</span> <span class="free">ip2</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">ipx</span> <span class="main">⇒</span> simple_match_ip <span class="bound">ipx</span> <span class="free">p_ip</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b1</span> <span class="skolem">m1</span> <span class="skolem">b2</span> <span class="skolem">m2</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"simple_match_ip <span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">m1</span><span class="main">)</span> <span class="free">p_ip</span> <span class="main">∧</span> simple_match_ip <span class="main">(</span><span class="skolem">b2</span><span class="main">,</span> <span class="skolem">m2</span><span class="main">)</span> <span class="free">p_ip</span> <span class="main">⟷</span> 
          <span class="free">p_ip</span> <span class="main">∈</span> ipset_from_cidr <span class="skolem">b1</span> <span class="skolem">m1</span> <span class="main">∩</span> ipset_from_cidr <span class="skolem">b2</span> <span class="skolem">m2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="free">p_ip</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">case</span> ipcidr_conjunct <span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">m1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b2</span><span class="main">,</span> <span class="skolem">m2</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Some <span class="main">(</span><span class="bound">bx</span><span class="main">,</span> <span class="bound">mx</span><span class="main">)</span> <span class="main">⇒</span> ipset_from_cidr <span class="bound">bx</span> <span class="bound">mx</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ipcidr_conjunct_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> ipcidr_conjunct <span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">m1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b2</span><span class="main">,</span> <span class="skolem">m2</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">ipx</span> <span class="main">⇒</span> simple_match_ip <span class="bound">ipx</span> <span class="free">p_ip</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"simple_match_ip <span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">m1</span><span class="main">)</span> <span class="free">p_ip</span> <span class="main">∧</span> simple_match_ip <span class="main">(</span><span class="skolem">b2</span><span class="main">,</span> <span class="skolem">m2</span><span class="main">)</span> <span class="free">p_ip</span> <span class="main">⟷</span> 
         <span class="main">(</span><span class="keyword1">case</span> ipcidr_conjunct <span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">m1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b2</span><span class="main">,</span> <span class="skolem">m2</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">ipx</span> <span class="main">⇒</span> simple_match_ip <span class="bound">ipx</span> <span class="free">p_ip</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
   <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ip1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">ip2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">declare</span></span> simple_matches.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Merging Simple Matches›</span></span>
  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'i</span></span><span class="main"><span class="main">::</span></span>len simple_match"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∧›</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'i</span></span><span class="main"><span class="main">::</span></span>len simple_match"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
  
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_match_and</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_match <span class="main">⇒</span> <span class="tfree">'i</span> simple_match <span class="main">⇒</span> <span class="tfree">'i</span> simple_match option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_match_and</span> <span class="main">⦇</span>iiface<span class="main">=</span><span class="free"><span class="bound"><span class="entity">iif1</span></span></span><span class="main">,</span> oiface<span class="main">=</span><span class="free"><span class="bound"><span class="entity">oif1</span></span></span><span class="main">,</span> src<span class="main">=</span><span class="free"><span class="bound"><span class="entity">sip1</span></span></span><span class="main">,</span> dst<span class="main">=</span><span class="free"><span class="bound"><span class="entity">dip1</span></span></span><span class="main">,</span> proto<span class="main">=</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">,</span> sports<span class="main">=</span><span class="free"><span class="bound"><span class="entity">sps1</span></span></span><span class="main">,</span> dports<span class="main">=</span><span class="free"><span class="bound"><span class="entity">dps1</span></span></span> <span class="main">⦈</span> 
                      <span class="main">⦇</span>iiface<span class="main">=</span><span class="free"><span class="bound"><span class="entity">iif2</span></span></span><span class="main">,</span> oiface<span class="main">=</span><span class="free"><span class="bound"><span class="entity">oif2</span></span></span><span class="main">,</span> src<span class="main">=</span><span class="free"><span class="bound"><span class="entity">sip2</span></span></span><span class="main">,</span> dst<span class="main">=</span><span class="free"><span class="bound"><span class="entity">dip2</span></span></span><span class="main">,</span> proto<span class="main">=</span><span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">,</span> sports<span class="main">=</span><span class="free"><span class="bound"><span class="entity">sps2</span></span></span><span class="main">,</span> dports<span class="main">=</span><span class="free"><span class="bound"><span class="entity">dps2</span></span></span> <span class="main">⦈</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">case</span> ipcidr_conjunct <span class="free"><span class="bound"><span class="entity">sip1</span></span></span> <span class="free"><span class="bound"><span class="entity">sip2</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">sip</span> <span class="main">⇒</span> 
      <span class="main">(</span><span class="keyword1">case</span> ipcidr_conjunct <span class="free"><span class="bound"><span class="entity">dip1</span></span></span> <span class="free"><span class="bound"><span class="entity">dip2</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">dip</span> <span class="main">⇒</span> 
      <span class="main">(</span><span class="keyword1">case</span> iface_conjunct <span class="free"><span class="bound"><span class="entity">iif1</span></span></span> <span class="free"><span class="bound"><span class="entity">iif2</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">iif</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> iface_conjunct <span class="free"><span class="bound"><span class="entity">oif1</span></span></span> <span class="free"><span class="bound"><span class="entity">oif2</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">oif</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> simple_proto_conjunct <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span>
      Some <span class="main">⦇</span>iiface<span class="main">=</span><span class="bound">iif</span><span class="main">,</span> oiface<span class="main">=</span><span class="bound">oif</span><span class="main">,</span> src<span class="main">=</span><span class="bound">sip</span><span class="main">,</span> dst<span class="main">=</span><span class="bound">dip</span><span class="main">,</span> proto<span class="main">=</span><span class="bound">p</span><span class="main">,</span>
            sports<span class="main">=</span>simpl_ports_conjunct <span class="free"><span class="bound"><span class="entity">sps1</span></span></span> <span class="free"><span class="bound"><span class="entity">sps2</span></span></span><span class="main">,</span> dports<span class="main">=</span>simpl_ports_conjunct <span class="free"><span class="bound"><span class="entity">dps1</span></span></span> <span class="free"><span class="bound"><span class="entity">dps2</span></span></span> <span class="main">⦈</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="SimpleFw_Semantics-simple_match_and_correct"><span class="command">lemma</span></span> simple_match_and_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_matches <span class="free">m1</span> <span class="free">p</span> <span class="main">∧</span> simple_matches <span class="free">m2</span> <span class="free">p</span> <span class="main">⟷</span> 
    <span class="main">(</span><span class="keyword1">case</span> simple_match_and <span class="free">m1</span> <span class="free">m2</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">m</span> <span class="main">⇒</span> simple_matches <span class="bound">m</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">iif1</span></span> <span class="skolem"><span class="skolem">oif1</span></span> <span class="skolem"><span class="skolem">sip1</span></span> <span class="skolem"><span class="skolem">dip1</span></span> <span class="skolem"><span class="skolem">p1</span></span> <span class="skolem"><span class="skolem">sps1</span></span> <span class="skolem"><span class="skolem">dps1</span></span> <span class="keyword2"><span class="keyword">where</span></span> m1<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">=</span> <span class="main">⦇</span>iiface<span class="main">=</span><span class="skolem">iif1</span><span class="main">,</span> oiface<span class="main">=</span><span class="skolem">oif1</span><span class="main">,</span> src<span class="main">=</span><span class="skolem">sip1</span><span class="main">,</span> dst<span class="main">=</span><span class="skolem">dip1</span><span class="main">,</span> proto<span class="main">=</span><span class="skolem">p1</span><span class="main">,</span> sports<span class="main">=</span><span class="skolem">sps1</span><span class="main">,</span> dports<span class="main">=</span><span class="skolem">dps1</span> <span class="main">⦈</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">iif2</span></span> <span class="skolem"><span class="skolem">oif2</span></span> <span class="skolem"><span class="skolem">sip2</span></span> <span class="skolem"><span class="skolem">dip2</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="skolem"><span class="skolem">sps2</span></span> <span class="skolem"><span class="skolem">dps2</span></span> <span class="keyword2"><span class="keyword">where</span></span> m2<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">=</span> <span class="main">⦇</span>iiface<span class="main">=</span><span class="skolem">iif2</span><span class="main">,</span> oiface<span class="main">=</span><span class="skolem">oif2</span><span class="main">,</span> src<span class="main">=</span><span class="skolem">sip2</span><span class="main">,</span> dst<span class="main">=</span><span class="skolem">dip2</span><span class="main">,</span> proto<span class="main">=</span><span class="skolem">p2</span><span class="main">,</span> sports<span class="main">=</span><span class="skolem">sps2</span><span class="main">,</span> dports<span class="main">=</span><span class="skolem">dps2</span> <span class="main">⦈</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  
      <span class="keyword1"><span class="command">have</span></span> sip_None<span class="main">:</span> <span class="quoted"><span class="quoted">"ipcidr_conjunct <span class="skolem">sip1</span> <span class="skolem">sip2</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">¬</span> simple_match_ip <span class="skolem">sip1</span> <span class="main">(</span>p_src <span class="free">p</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> simple_match_ip <span class="skolem">sip2</span> <span class="main">(</span>p_src <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> simple_match_ip_conjunct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">sip1</span></span> <span class="quoted"><span class="quoted">"p_src <span class="free">p</span>"</span></span> <span class="quoted"><span class="skolem">sip2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> dip_None<span class="main">:</span> <span class="quoted"><span class="quoted">"ipcidr_conjunct <span class="skolem">dip1</span> <span class="skolem">dip2</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">¬</span> simple_match_ip <span class="skolem">dip1</span> <span class="main">(</span>p_dst <span class="free">p</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> simple_match_ip <span class="skolem">dip2</span> <span class="main">(</span>p_dst <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> simple_match_ip_conjunct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">dip1</span></span> <span class="quoted"><span class="quoted">"p_dst <span class="free">p</span>"</span></span> <span class="quoted"><span class="skolem">dip2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> sip_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ip</span><span class="main">.</span> ipcidr_conjunct <span class="skolem">sip1</span> <span class="skolem">sip2</span> <span class="main">=</span> Some <span class="bound">ip</span> <span class="main">⟹</span>
        simple_match_ip <span class="bound">ip</span> <span class="main">(</span>p_src <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> simple_match_ip <span class="skolem">sip1</span> <span class="main">(</span>p_src <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> simple_match_ip <span class="skolem">sip2</span> <span class="main">(</span>p_src <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> simple_match_ip_conjunct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">sip1</span></span> <span class="quoted"><span class="quoted">"p_src <span class="free">p</span>"</span></span> <span class="quoted"><span class="skolem">sip2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> dip_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ip</span><span class="main">.</span> ipcidr_conjunct <span class="skolem">dip1</span> <span class="skolem">dip2</span> <span class="main">=</span> Some <span class="bound">ip</span> <span class="main">⟹</span>
        simple_match_ip <span class="bound">ip</span> <span class="main">(</span>p_dst <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> simple_match_ip <span class="skolem">dip1</span> <span class="main">(</span>p_dst <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> simple_match_ip <span class="skolem">dip2</span> <span class="main">(</span>p_dst <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> simple_match_ip_conjunct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">dip1</span></span> <span class="quoted"><span class="quoted">"p_dst <span class="free">p</span>"</span></span> <span class="quoted"><span class="skolem">dip2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword1"><span class="command">have</span></span> iiface_None<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_conjunct <span class="skolem">iif1</span> <span class="skolem">iif2</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">¬</span> match_iface <span class="skolem">iif1</span> <span class="main">(</span>p_iiface <span class="free">p</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> match_iface <span class="skolem">iif2</span> <span class="main">(</span>p_iiface <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> iface_conjunct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">iif1</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>p_iiface <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">iif2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> oiface_None<span class="main">:</span> <span class="quoted"><span class="quoted">"iface_conjunct <span class="skolem">oif1</span> <span class="skolem">oif2</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">¬</span> match_iface <span class="skolem">oif1</span> <span class="main">(</span>p_oiface <span class="free">p</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> match_iface <span class="skolem">oif2</span> <span class="main">(</span>p_oiface <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> iface_conjunct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">oif1</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>p_oiface <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">oif2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> iiface_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">iface</span><span class="main">.</span> iface_conjunct <span class="skolem">iif1</span> <span class="skolem">iif2</span> <span class="main">=</span> Some <span class="bound">iface</span> <span class="main">⟹</span> 
        match_iface <span class="bound">iface</span> <span class="main">(</span>p_iiface <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> match_iface <span class="skolem">iif1</span> <span class="main">(</span>p_iiface <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> match_iface <span class="skolem">iif2</span> <span class="main">(</span>p_iiface <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> iface_conjunct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">iif1</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>p_iiface <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">iif2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> oiface_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">iface</span><span class="main">.</span> iface_conjunct <span class="skolem">oif1</span> <span class="skolem">oif2</span> <span class="main">=</span> Some <span class="bound">iface</span> <span class="main">⟹</span> 
        match_iface <span class="bound">iface</span> <span class="main">(</span>p_oiface <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> match_iface <span class="skolem">oif1</span> <span class="main">(</span>p_oiface <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> match_iface <span class="skolem">oif2</span> <span class="main">(</span>p_oiface <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> iface_conjunct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">oif1</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>p_oiface <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">oif2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword1"><span class="command">have</span></span> proto_None<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_proto_conjunct <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">¬</span> match_proto <span class="skolem">p1</span> <span class="main">(</span>p_proto <span class="free">p</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> match_proto <span class="skolem">p2</span> <span class="main">(</span>p_proto <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> simple_proto_conjunct_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p1</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>p_proto <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">p2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> proto_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">proto</span><span class="main">.</span> simple_proto_conjunct <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="main">=</span> Some <span class="bound">proto</span> <span class="main">⟹</span>
        match_proto <span class="bound">proto</span> <span class="main">(</span>p_proto <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> match_proto <span class="skolem">p1</span> <span class="main">(</span>p_proto <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> match_proto <span class="skolem">p2</span> <span class="main">(</span>p_proto <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> simple_proto_conjunct_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p1</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>p_proto <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">p2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword1"><span class="command">have</span></span> case_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> Some <span class="bound">m</span> <span class="main">=</span> simple_match_and <span class="free">m1</span> <span class="free">m2</span> <span class="main">⟹</span>
       <span class="main">(</span>simple_matches <span class="free">m1</span> <span class="free">p</span> <span class="main">∧</span> simple_matches <span class="free">m2</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> simple_matches <span class="bound">m</span> <span class="free">p</span>"</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1 m2 simple_matches.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> simple_ports_conjunct_correct <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sip_Some dip_Some iiface_Some oiface_Some proto_Some<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> case_None<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_match_and <span class="free">m1</span> <span class="free">m2</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span>simple_matches <span class="free">m1</span> <span class="free">p</span> <span class="main">∧</span> simple_matches <span class="free">m2</span> <span class="free">p</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1 m2 simple_matches.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sip_None dip_None iiface_None oiface_None proto_None<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">from</span></span> case_Some case_None <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"simple_match_and <span class="free">m1</span> <span class="free">m2</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1" id="SimpleFw_Semantics-simple_match_and_SomeD"><span class="command">lemma</span></span> simple_match_and_SomeD<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_match_and <span class="free">m1</span> <span class="free">m2</span> <span class="main">=</span> Some <span class="free">m</span> <span class="main">⟹</span>
    simple_matches <span class="free">m</span> <span class="free">p</span> <span class="main">⟷</span> <span class="main">(</span>simple_matches <span class="free">m1</span> <span class="free">p</span> <span class="main">∧</span> simple_matches <span class="free">m2</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_match_and_correct<span class="main">)</span>
  <span class="keyword1" id="SimpleFw_Semantics-simple_match_and_NoneD"><span class="command">lemma</span></span> simple_match_and_NoneD<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_match_and <span class="free">m1</span> <span class="free">m2</span> <span class="main">=</span> None <span class="main">⟹</span>
    <span class="main">¬</span><span class="main">(</span>simple_matches <span class="free">m1</span> <span class="free">p</span> <span class="main">∧</span> simple_matches <span class="free">m2</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_match_and_correct<span class="main">)</span>
  <span class="keyword1" id="SimpleFw_Semantics-simple_matches_andD"><span class="command">lemma</span></span> simple_matches_andD<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_matches <span class="free">m1</span> <span class="free">p</span> <span class="main">⟹</span> simple_matches <span class="free">m2</span> <span class="free">p</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">m</span><span class="main">.</span> simple_match_and <span class="free">m1</span> <span class="free">m2</span> <span class="main">=</span> Some <span class="bound">m</span> <span class="main">∧</span> simple_matches <span class="bound">m</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> option.exhaust_sel simple_match_and_NoneD simple_match_and_SomeD<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Further Properties of a Simple Firewall›</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">has_default_policy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">has_default_policy</span> <span class="main">[]</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">has_default_policy</span> <span class="main">[</span><span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> simple_match_any<span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">has_default_policy</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">has_default_policy</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>"</span></span>
  
  <span class="keyword1" id="SimpleFw_Semantics-has_default_policy"><span class="command">lemma</span></span> has_default_policy<span class="main">:</span> <span class="quoted"><span class="quoted">"has_default_policy <span class="free">rs</span> <span class="main">⟹</span>
    simple_fw <span class="free">rs</span> <span class="free">p</span> <span class="main">=</span> Decision FinalAllow <span class="main">∨</span> simple_fw <span class="free">rs</span> <span class="free">p</span> <span class="main">=</span> Decision FinalDeny"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_default_policy.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">m</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_match_any<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="skolem">rs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> SimpleRule <span class="skolem">m</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1" id="SimpleFw_Semantics-has_default_policy_fst"><span class="command">lemma</span></span> has_default_policy_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"has_default_policy <span class="free">rs</span> <span class="main">⟹</span> has_default_policy <span class="main">(</span><span class="free">r</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> m a<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>


  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We can stop after a default rule (a rule which matches anything) is observed.›</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">cut_off_after_match_any</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="tfree">'i</span> simple_rule list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cut_off_after_match_any</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">cut_off_after_match_any</span> <span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> simple_match_any <span class="keyword1">then</span> <span class="main">[</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="keyword1">else</span> SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free">cut_off_after_match_any</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="SimpleFw_Semantics-cut_off_after_match_any"><span class="command">lemma</span></span> cut_off_after_match_any<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_fw <span class="main">(</span>cut_off_after_match_any <span class="free">rs</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> simple_fw.induct<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_match_any<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1" id="SimpleFw_Semantics-simple_fw_not_matches_removeAll"><span class="command">lemma</span></span> simple_fw_not_matches_removeAll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> simple_matches <span class="free">m</span> <span class="free">p</span> <span class="main">⟹</span>
    simple_fw <span class="main">(</span>removeAll <span class="main">(</span>SimpleRule <span class="free">m</span> <span class="free">a</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> simple_fw.induct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Reality check: Validity of Simple Matches›</span></span>
  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹While it is possible to construct a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>simple_fw›</span></span></span></span> expression that only matches a source
  or destination port, such a match is not meaningful, as the presence of the port information is 
  dependent on the protocol. Thus, a match for a port should always include the match for a protocol.
  Additionally, prefixes should be zero on bits beyond the prefix length.
  ›</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">valid_prefix_fw</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> valid_prefix <span class="main">(</span>uncurry PrefixMatch <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="SimpleFw_Semantics-ipcidr_conjunct_valid"><span class="command">lemma</span></span> ipcidr_conjunct_valid<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>valid_prefix_fw <span class="free">p1</span><span class="main">;</span> valid_prefix_fw <span class="free">p2</span><span class="main">;</span> ipcidr_conjunct <span class="free">p1</span> <span class="free">p2</span> <span class="main">=</span> Some <span class="free">p</span><span class="main">⟧</span> <span class="main">⟹</span> valid_prefix_fw <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> valid_prefix_fw_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">p1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">p2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipcidr_conjunct.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_match_valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>len<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> simple_match_scheme <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_match_valid</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> 
    <span class="main">(</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_match_port <span class="main">(</span>sports <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="bound">p</span><span class="main">}</span> <span class="main">≠</span> UNIV <span class="main">∨</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_match_port <span class="main">(</span>dports <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="bound">p</span><span class="main">}</span> <span class="main">≠</span> UNIV <span class="main">⟶</span>
        proto <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∈</span> Proto <span class="main">`</span><span class="main">{</span>TCP<span class="main">,</span> UDP<span class="main">,</span> L4_Protocol.SCTP<span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
    valid_prefix_fw <span class="main">(</span>src <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">∧</span> valid_prefix_fw <span class="main">(</span>dst <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span> 
  
  <span class="keyword1" id="SimpleFw_Semantics-simple_match_valid_alt"><span class="command">lemma</span></span> simple_match_valid_alt<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"simple_match_valid <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">m</span><span class="main">.</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">e</span> <span class="main">≠</span> max_word<span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="bound">c</span> <span class="main">(</span>sports <span class="bound">m</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">c</span> <span class="main">(</span>dports <span class="bound">m</span><span class="main">)</span> <span class="keyword1">then</span> proto <span class="bound">m</span> <span class="main">=</span> Proto TCP <span class="main">∨</span> proto <span class="bound">m</span> <span class="main">=</span> Proto UDP <span class="main">∨</span> proto <span class="bound">m</span> <span class="main">=</span> Proto L4_Protocol.SCTP <span class="keyword1">else</span> True<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  valid_prefix_fw <span class="main">(</span>src <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> valid_prefix_fw <span class="main">(</span>dst <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> simple_match_valid_alt_hlp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_match_port <span class="skolem">x</span> <span class="bound">p</span><span class="main">}</span> <span class="main">≠</span> UNIV <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">e</span> <span class="main">≠</span> max_word<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> simple_match_port_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> simple_match_valid_alt_hlp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_match_port <span class="skolem">x</span> <span class="bound">p</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">≤</span> <span class="bound">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff
      <span class="keyword1"><span class="command">unfolding</span></span> simple_match_valid_def Let_def
      <span class="keyword1"><span class="command">unfolding</span></span> simple_match_valid_alt_hlp1 simple_match_valid_alt_hlp2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> m<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"sports <span class="improper">m</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"dports <span class="improper">m</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"proto <span class="improper">m</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Example:›</span></span>
  <span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example_simple_match1</span> <span class="main">≡</span>
      <span class="main">⦇</span>iiface <span class="main">=</span> Iface <span class="inner_quoted">''+''</span><span class="main">,</span> oiface <span class="main">=</span> Iface <span class="inner_quoted">''+''</span><span class="main">,</span> src <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="numeral">32</span> word<span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> dst <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>
       proto <span class="main">=</span> Proto TCP<span class="main">,</span> sports <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="numeral">1024</span><span class="main">)</span><span class="main">,</span> dports <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="numeral">1024</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
  
    <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"simple_fw <span class="main">[</span>SimpleRule example_simple_match1 Drop<span class="main">]</span>
      <span class="main">⦇</span>p_iiface <span class="main">=</span> <span class="inner_quoted">''''</span><span class="main">,</span> p_oiface <span class="main">=</span> <span class="inner_quoted">''''</span><span class="main">,</span>  p_src <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="numeral">32</span> word<span class="main">)</span><span class="main">,</span> p_dst <span class="main">=</span> <span class="numeral">2</span><span class="main">,</span> p_proto <span class="main">=</span> TCP<span class="main">,</span> p_sport <span class="main">=</span> <span class="numeral">8</span><span class="main">,</span>
       p_dport <span class="main">=</span> <span class="numeral">9</span><span class="main">,</span> p_tcp_flags <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> p_payload <span class="main">=</span> <span class="inner_quoted">''''</span><span class="main">⦈</span> <span class="main">=</span>
        Decision FinalDeny"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example_simple_match2</span> <span class="main">≡</span> example_simple_match1<span class="main">⦇</span> proto <span class="main">:=</span> ProtoAny <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Thus, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>example_simple_match1›</span></span></span></span> is valid, but if we set its protocol match to any, it isn't anymore›</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"simple_match_valid example_simple_match1"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> simple_match_valid example_simple_match2"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  <span class="keyword2"><span class="keyword">end</span></span>
  
  
  <span class="keyword1" id="SimpleFw_Semantics-simple_match_and_valid"><span class="command">lemma</span></span> simple_match_and_valid<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_match"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> mv<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_match_valid <span class="free">m1</span>"</span></span> <span class="quoted"><span class="quoted">"simple_match_valid <span class="free">m2</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> mj<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_match_and <span class="free">m1</span> <span class="free">m2</span> <span class="main">=</span> Some <span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_match_valid <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> simpl_ports_conjunct_not_UNIV<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>simple_match_port <span class="skolem">x</span><span class="main">)</span> <span class="main">≠</span> UNIV <span class="main">⟹</span>
      <span class="skolem">x</span> <span class="main">=</span> simpl_ports_conjunct <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="main">⟹</span>
      Collect <span class="main">(</span>simple_match_port <span class="skolem">p1</span><span class="main">)</span> <span class="main">≠</span> UNIV <span class="main">∨</span> Collect <span class="main">(</span>simple_match_port <span class="skolem">p2</span><span class="main">)</span> <span class="main">≠</span> UNIV"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Collect_cong mem_Collect_eq simple_ports_conjunct_correct<span class="main">)</span>
  
    <span class="comment1">(* prefix validity. That's simple. *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_prefix_fw <span class="main">(</span>src <span class="free">m1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_prefix_fw <span class="main">(</span>src <span class="free">m2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_prefix_fw <span class="main">(</span>dst <span class="free">m1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_prefix_fw <span class="main">(</span>dst <span class="free">m2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mv <span class="keyword1"><span class="command">unfolding</span></span> simple_match_valid_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipcidr_conjunct <span class="main">(</span>src <span class="free">m1</span><span class="main">)</span> <span class="main">(</span>src <span class="free">m2</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>src <span class="free">m</span><span class="main">)</span>"</span></span>
                  <span class="quoted"><span class="quoted">"ipcidr_conjunct <span class="main">(</span>dst <span class="free">m1</span><span class="main">)</span> <span class="main">(</span>dst <span class="free">m2</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>dst <span class="free">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mj <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">m2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> pv<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_prefix_fw <span class="main">(</span>src <span class="free">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_prefix_fw <span class="main">(</span>dst <span class="free">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ipcidr_conjunct_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  
    <span class="comment1">(* now for the source ports… *)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nmu</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nmu</span> <span class="skolem">ps</span> <span class="main">⟷</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_match_port <span class="skolem">ps</span> <span class="bound">p</span><span class="main">}</span> <span class="main">≠</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ps</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"simpl_ports_conjunct <span class="main">(</span>sports <span class="free">m1</span><span class="main">)</span> <span class="main">(</span>sports <span class="free">m2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sports <span class="free">m</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ph1</span> sports"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> mj <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">m2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nmu</span> <span class="main">(</span>sports <span class="free">m</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">nmu</span> <span class="main">(</span>sports <span class="free">m1</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">nmu</span> <span class="main">(</span>sports <span class="free">m2</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ph2</span> sports"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> nmu_def <span class="keyword1"><span class="command">using</span></span> simpl_ports_conjunct_not_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
    <span class="comment1">(* dst ports: mutatis mutandem *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ph1</span> dports"</span></span> <span class="keyword1"><span class="command">using</span></span> mj <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">m2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> dp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ph2</span> dports"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nmu_def <span class="keyword1"><span class="command">using</span></span> simpl_ports_conjunct_not_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
    <span class="comment1">(* And an argument for the protocol. *)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">php</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">php</span> <span class="skolem">mr</span> <span class="main">⟷</span> proto <span class="skolem">mr</span> <span class="main">∈</span> Proto <span class="main">`</span> <span class="main">{</span>TCP<span class="main">,</span> UDP<span class="main">,</span> L4_Protocol.SCTP<span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">mr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> simple_match"</span></span>
    <span class="keyword1"><span class="command">have</span></span> pcj<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_proto_conjunct <span class="main">(</span>proto <span class="free">m1</span><span class="main">)</span> <span class="main">(</span>proto <span class="free">m2</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>proto <span class="free">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mj <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">m2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">php</span> <span class="free">m1</span> <span class="main">⟹</span> <span class="skolem">php</span> <span class="free">m</span>"</span></span>
             <span class="quoted"><span class="quoted">"<span class="skolem">php</span> <span class="free">m2</span> <span class="main">⟹</span> <span class="skolem">php</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> conjunctProtoD conjunctProtoD2 pcj <span class="keyword1"><span class="command">unfolding</span></span> php_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="comment1">(* Since I'm trying to trick the simplifier with these defs, I need these as explicit statements: *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mx</span><span class="main">.</span> simple_match_valid <span class="bound">mx</span> <span class="main">⟹</span> <span class="skolem">nmu</span> <span class="main">(</span>sports <span class="bound">mx</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">nmu</span> <span class="main">(</span>dports <span class="bound">mx</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">php</span> <span class="bound">mx</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nmu_def php_def simple_match_valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> mps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nmu</span> <span class="main">(</span>sports <span class="free">m1</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">php</span> <span class="free">m1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nmu</span> <span class="main">(</span>dports <span class="free">m1</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">php</span> <span class="free">m1</span>"</span></span>
               <span class="quoted"><span class="quoted">"<span class="skolem">nmu</span> <span class="main">(</span>sports <span class="free">m2</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">php</span> <span class="free">m2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nmu</span> <span class="main">(</span>dports <span class="free">m2</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">php</span> <span class="free">m2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    
    <span class="keyword1"><span class="command">have</span></span> pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nmu</span> <span class="main">(</span>sports <span class="free">m</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">nmu</span> <span class="main">(</span>dports <span class="free">m</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">php</span> <span class="free">m</span>"</span></span>
    <span class="comment1">(*  apply(intro impI)
      apply(elim disjE)
      apply(drule sp[THEN mp])
      apply(elim disjE)
      apply(drule mps)
      apply(elim p; fail) *)</span>
      <span class="keyword1"><span class="command">using</span></span> sp dp mps p <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> simple_match_valid_def
      <span class="keyword1"><span class="command">using</span></span> pv pa<span class="main">[</span><span class="operator">unfolded</span> nmu_def php_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
      
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">simple_fw_valid</span> <span class="main">≡</span> list_all <span class="main">(</span>simple_match_valid <span class="main">∘</span> match_sel<span class="main">)</span>"</span></span>



<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The simple firewall does not care about tcp flags, payload, or any other packet extensions.›</span></span>
<span class="keyword1" id="SimpleFw_Semantics-simple_matches_extended_packet"><span class="command">lemma</span></span> simple_matches_extended_packet<span class="main">:</span>
      <span class="quoted"><span class="quoted">"simple_matches <span class="free">m</span>
        <span class="main">⦇</span>p_iiface <span class="main">=</span> <span class="free">iifce</span><span class="main">,</span>
         oiface <span class="main">=</span> <span class="free">oifce</span><span class="main">,</span>
         p_src <span class="main">=</span> <span class="free">s</span><span class="main">,</span> dst <span class="main">=</span> <span class="free">d</span><span class="main">,</span>
         p_proto <span class="main">=</span> <span class="free">prot</span><span class="main">,</span>
         p_sport <span class="main">=</span> <span class="free">sport</span><span class="main">,</span> p_dport <span class="main">=</span> <span class="free">dport</span><span class="main">,</span>
         tcp_flags <span class="main">=</span> <span class="free">tcp_flags</span><span class="main">,</span> p_payload <span class="main">=</span> <span class="free">payload1</span><span class="main">⦈</span>
        <span class="main">⟷</span>
       simple_matches <span class="free">m</span>
        <span class="main">⦇</span>p_iiface <span class="main">=</span> <span class="free">iifce</span><span class="main">,</span>
         oiface <span class="main">=</span> <span class="free">oifce</span><span class="main">,</span>
         p_src <span class="main">=</span> <span class="free">s</span><span class="main">,</span> p_dst <span class="main">=</span> <span class="free">d</span><span class="main">,</span>
         p_proto <span class="main">=</span> <span class="free">prot</span><span class="main">,</span>
         p_sport <span class="main">=</span> <span class="free">sport</span><span class="main">,</span> p_dport <span class="main">=</span> <span class="free">dport</span><span class="main">,</span>
         p_tcp_flags <span class="main">=</span> <span class="free">tcp_flags2</span><span class="main">,</span> p_payload <span class="main">=</span> <span class="free">payload2</span><span class="main">,</span> <span class="main">…</span> <span class="main">=</span> <span class="free">aux</span><span class="main">⦈</span>
        "</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_matches.simps<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="List_Product_More">
<div class="head">
<h1>Theory List_Product_More</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹List Product Helpers›</span></span>
<span class="keyword1"><span class="command">theory</span></span> List_Product_More
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*TODO: this definition could also go to Main*)</span>
<span class="keyword1" id="List_Product_More-List_product_concat_map"><span class="command">lemma</span></span> List_product_concat_map<span class="main">:</span> <span class="quoted"><span class="quoted">"List.product <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all_pairs</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="List_Product_More-all_pairs_list_product"><span class="command">lemma</span></span> all_pairs_list_product<span class="main">:</span> <span class="quoted"><span class="quoted">"all_pairs <span class="free">xs</span> <span class="main">=</span> List.product <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_pairs_def List_product_concat_map<span class="main">)</span>
  
<span class="keyword1" id="List_Product_More-all_pairs"><span class="command">lemma</span></span> all_pairs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">xs</span> <span class="main">×</span> set <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>all_pairs <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_pairs_list_product<span class="main">)</span>

<span class="keyword1" id="List_Product_More-all_pairs_set"><span class="command">lemma</span></span> all_pairs_set<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>all_pairs <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">×</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_pairs_list_product<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Option_Helpers">
<div class="head">
<h1>Theory Option_Helpers</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Option to List and Option to Set›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Option_Helpers
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Those are just syntactic helpers.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">option2set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">option2set</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Some <span class="bound">s</span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">option2list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">option2list</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">s</span> <span class="main">⇒</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Option_Helpers-set_option2list"><span class="command">lemma</span></span> set_option2list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>option2list <span class="free">k</span><span class="main">)</span> <span class="main">=</span> option2set <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> option2list_def option2set_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Option_Helpers-option2list_simps"><span class="command">lemma</span></span> option2list_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"option2list <span class="main">(</span>Some <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"option2list <span class="main">(</span>None<span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> option2list_def option.simps <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Option_Helpers-option2set_None"><span class="command">lemma</span></span> option2set_None<span class="main">:</span> <span class="quoted"><span class="quoted">"option2set None <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option2set_def<span class="main">)</span>

<span class="keyword1" id="Option_Helpers-option2list_map"><span class="command">lemma</span></span> option2list_map<span class="main">:</span> <span class="quoted"><span class="quoted">"option2list <span class="main">(</span>map_option <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>option2list <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option2list_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="Option_Helpers-option2set_map"><span class="command">lemma</span></span> option2set_map<span class="main">:</span> <span class="quoted"><span class="quoted">"option2set <span class="main">(</span>map_option <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> option2set <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option2set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Generic_SimpleFw">
<div class="head">
<h1>Theory Generic_SimpleFw</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Generalize Simple Firewall›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Generic_SimpleFw
<span class="keyword2"><span class="keyword">imports</span></span> <a href="SimpleFw_Semantics.html">SimpleFw_Semantics</a> <span class="quoted">"<a href="List_Product_More.html">Common/List_Product_More</a>"</span> <span class="quoted">"<a href="Option_Helpers.html">Common/Option_Helpers</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Semantics›</span></span>
  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The semantics of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">simple_fw</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is quite close to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> List.find<span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
  The idea of the generalized <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">simple_fw</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> semantics is that you can have anything as the 
  resulting action, not only a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> simple_action<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">generalized_sfw</span>
    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>len simple_match <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'pkt_ext</span><span class="main">)</span> simple_packet_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span> simple_match <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> option"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">generalized_sfw</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> find <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">m</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> simple_matches <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Lemmas›</span></span>
  <span class="keyword1" id="Generic_SimpleFw-generalized_sfw_simps"><span class="command">lemma</span></span> generalized_sfw_simps<span class="main">:</span>
    <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">[]</span> <span class="free">p</span> <span class="main">=</span> None"</span></span>
    <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> simple_matches <span class="bound">m</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="free">a</span> <span class="keyword1">else</span> generalized_sfw <span class="free">as</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> generalized_sfw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  
  <span class="keyword1" id="Generic_SimpleFw-generalized_sfw_append"><span class="command">lemma</span></span> generalized_sfw_append<span class="main">:</span>
    <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> generalized_sfw <span class="free">a</span> <span class="free">p</span> <span class="keyword1">of</span> Some <span class="bound">x</span> <span class="main">⇒</span> Some <span class="bound">x</span>
                                                           <span class="main">|</span>  None <span class="main">⇒</span> generalized_sfw <span class="free">b</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps<span class="main">)</span>
  
  <span class="keyword1" id="Generic_SimpleFw-simple_generalized_undecided"><span class="command">lemma</span></span> simple_generalized_undecided<span class="main">:</span>
    <span class="quoted"><span class="quoted">"simple_fw <span class="free">fw</span> <span class="free">p</span> <span class="main">≠</span> Undecided <span class="main">⟹</span> generalized_sfw <span class="main">(</span>map simple_rule_dtor <span class="free">fw</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fw</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_def simple_fw_alt simple_rule_dtor_def
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits simple_action.splits simple_rule.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1" id="Generic_SimpleFw-generalized_sfwSomeD"><span class="command">lemma</span></span> generalized_sfwSomeD<span class="main">:</span> <span class="quoted"><span class="quoted">"generalized_sfw <span class="free">fw</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">d</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">d</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fw</span> <span class="main">∧</span> simple_matches <span class="free">r</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> generalized_sfw_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fw</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1" id="Generic_SimpleFw-generalized_sfw_NoneD"><span class="command">lemma</span></span> generalized_sfw_NoneD<span class="main">:</span> <span class="quoted"><span class="quoted">"generalized_sfw <span class="free">fw</span> <span class="free">p</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fw</span><span class="main">.</span> <span class="main">¬</span> simple_matches <span class="bound">a</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fw</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1" id="Generic_SimpleFw-generalized_fw_split"><span class="command">lemma</span></span> generalized_fw_split<span class="main">:</span> <span class="quoted"><span class="quoted">"generalized_sfw <span class="free">fw</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">fw1</span> <span class="bound">fw3</span><span class="main">.</span> <span class="free">fw</span> <span class="main">=</span> <span class="bound">fw1</span> <span class="main">@</span> <span class="free">r</span> <span class="main">#</span> <span class="bound">fw3</span> <span class="main">∧</span> generalized_sfw <span class="bound">fw1</span> <span class="free">p</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fw</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps generalized_sfw_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps generalized_sfw_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Generic_SimpleFw-generalized_sfw_filterD"><span class="command">lemma</span></span> generalized_sfw_filterD<span class="main">:</span>
    <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span>filter <span class="free">f</span> <span class="free">fw</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">d</span><span class="main">)</span> <span class="main">⟹</span> simple_matches <span class="free">r</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fw</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1" id="Generic_SimpleFw-generalized_sfw_mapsnd"><span class="command">lemma</span></span> generalized_sfw_mapsnd<span class="main">:</span>
    <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span>map <span class="main">(</span>apsnd <span class="free">f</span><span class="main">)</span> <span class="free">fw</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> map_option <span class="main">(</span>apsnd <span class="free">f</span><span class="main">)</span> <span class="main">(</span>generalized_sfw <span class="free">fw</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fw</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Equality with the Simple Firewall›</span></span>

  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A matching action of the simple firewall directly corresponds to a filtering decision›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_action_to_decision</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"simple_action <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_action_to_decision</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span> Accept <span class="main">⇒</span> Decision FinalAllow
                                          <span class="main">|</span>   Drop <span class="main">⇒</span> Decision FinalDeny"</span></span>
  
  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> simple_fw<span class="antiquote"><span class="antiquote">}</span></span></span></span> and the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> generalized_sfw<span class="antiquote"><span class="antiquote">}</span></span></span></span> are equal, if the state is translated appropriately.›</span></span>
  <span class="keyword1" id="Generic_SimpleFw-simple_fw_iff_generalized_fw"><span class="command">lemma</span></span> simple_fw_iff_generalized_fw<span class="main">:</span>
    <span class="quoted"><span class="quoted">"simple_fw <span class="free">fw</span> <span class="free">p</span> <span class="main">=</span> simple_action_to_decision <span class="free">a</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> generalized_sfw <span class="main">(</span>map simple_rule_dtor <span class="free">fw</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fw</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps simple_rule_dtor_def simple_fw_alt simple_action_to_decision_def
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> simple_rule.splits if_splits simple_action.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1" id="Generic_SimpleFw-simple_fw_iff_generalized_fw_accept"><span class="command">lemma</span></span> simple_fw_iff_generalized_fw_accept<span class="main">:</span>
    <span class="quoted"><span class="quoted">"simple_fw <span class="free">fw</span> <span class="free">p</span> <span class="main">=</span> Decision FinalAllow <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> generalized_sfw <span class="main">(</span>map simple_rule_dtor <span class="free">fw</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> Accept<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> simple_fw_iff_generalized_fw<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">simple_action.Accept</span><span class="main"><span class="main">,</span></span>
                                         <span class="operator">unfolded</span> simple_action_to_decision_def simple_action.simps<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1" id="Generic_SimpleFw-simple_fw_iff_generalized_fw_drop"><span class="command">lemma</span></span> simple_fw_iff_generalized_fw_drop<span class="main">:</span>
    <span class="quoted"><span class="quoted">"simple_fw <span class="free">fw</span> <span class="free">p</span> <span class="main">=</span> Decision FinalDeny <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> generalized_sfw <span class="main">(</span>map simple_rule_dtor <span class="free">fw</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> Drop<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> simple_fw_iff_generalized_fw<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">simple_action.Drop</span><span class="main"><span class="main">,</span></span>
                                         <span class="operator">unfolded</span> simple_action_to_decision_def simple_action.simps<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Joining two firewalls, i.e. a packet is send through both sequentially.›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">generalized_fw_join</span>
    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>len simple_match <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span> simple_match <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span> simple_match <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">generalized_fw_join</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">≡</span> <span class="main">[</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>m1<span class="main">,</span>a<span class="main">)</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">,</span> <span class="main">(</span>m2<span class="main">,</span>b<span class="main">)</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">,</span> u <span class="main">←</span> option2list <span class="main">(</span>simple_match_and <span class="bound">m1</span> <span class="bound">m2</span><span class="main">)</span><span class="main">]</span>"</span></span>
  
  <span class="keyword1" id="Generic_SimpleFw-generalized_fw_join_1_Nil"><span class="command">lemma</span></span> generalized_fw_join_1_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"generalized_fw_join <span class="main">[]</span> <span class="free">f2</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> generalized_fw_join_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f2</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1" id="Generic_SimpleFw-generalized_fw_join_2_Nil"><span class="command">lemma</span></span> generalized_fw_join_2_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"generalized_fw_join <span class="free">f1</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> generalized_fw_join_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f1</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1" id="Generic_SimpleFw-generalized_fw_join_cons_1"><span class="command">lemma</span></span> generalized_fw_join_cons_1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"generalized_fw_join <span class="main">(</span><span class="main">(</span><span class="free">am</span><span class="main">,</span><span class="free">ad</span><span class="main">)</span> <span class="main">#</span> <span class="free">l1</span><span class="main">)</span> <span class="free">l2</span> <span class="main">=</span>
      <span class="main">[</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="main">(</span><span class="free">ad</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>m2<span class="main">,</span>b<span class="main">)</span> <span class="main">←</span> <span class="free">l2</span><span class="main">,</span> u <span class="main">←</span> option2list <span class="main">(</span>simple_match_and <span class="free">am</span> <span class="bound">m2</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> generalized_fw_join <span class="free">l1</span> <span class="free">l2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> generalized_fw_join_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  
  <span class="keyword1" id="Generic_SimpleFw-generalized_fw_join_1_nomatch"><span class="command">lemma</span></span> generalized_fw_join_1_nomatch<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> simple_matches <span class="free">am</span> <span class="free">p</span> <span class="main">⟹</span>
      generalized_sfw <span class="main">[</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="main">(</span><span class="free">ad</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>m2<span class="main">,</span>b<span class="main">)</span> <span class="main">←</span> <span class="free">l2</span><span class="main">,</span> u <span class="main">←</span> option2list <span class="main">(</span>simple_match_and <span class="free">am</span> <span class="bound">m2</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps generalized_sfw_append option2list_def simple_match_and_SomeD
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    
  <span class="keyword1" id="Generic_SimpleFw-generalized_fw_join_2_nomatch"><span class="command">lemma</span></span> generalized_fw_join_2_nomatch<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> simple_matches <span class="free">bm</span> <span class="free">p</span> <span class="main">⟹</span>
      generalized_sfw <span class="main">(</span>generalized_fw_join <span class="free">as</span> <span class="main">(</span><span class="main">(</span><span class="free">bm</span><span class="main">,</span> <span class="free">bd</span><span class="main">)</span> <span class="main">#</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> generalized_sfw <span class="main">(</span>generalized_fw_join <span class="free">as</span> <span class="free">bs</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> Cons.IH<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">am</span></span> <span class="skolem"><span class="skolem">ad</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">am</span><span class="main">,</span> <span class="skolem">ad</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">m2</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="skolem">ad</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>option2list <span class="main">(</span>simple_match_and <span class="skolem">am</span> <span class="bound">m2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">bm</span><span class="main">,</span> <span class="free">bd</span><span class="main">)</span> <span class="main">#</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> 
      generalized_sfw <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">m2</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="skolem">ad</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>option2list <span class="main">(</span>simple_match_and <span class="skolem">am</span> <span class="bound">m2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> list.map prod.simps
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"simple_match_and <span class="skolem">am</span> <span class="free">bm</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option2list_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> simple_match_and_SomeD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> option2list_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> concat.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps Cons.prems<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> a
      <span class="keyword1"><span class="command">unfolding</span></span> generalized_fw_join_cons_1
      <span class="keyword1"><span class="command">unfolding</span></span> generalized_sfw_append
      <span class="keyword1"><span class="command">unfolding</span></span> mIH
      <span class="keyword1"><span class="command">unfolding</span></span> *
      <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_fw_join_def<span class="main">)</span>
  
  <span class="keyword1" id="Generic_SimpleFw-generalized_fw_joinI"><span class="command">lemma</span></span> generalized_fw_joinI<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>generalized_sfw <span class="free">f1</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r1</span><span class="main">,</span><span class="free">d1</span><span class="main">)</span><span class="main">;</span> generalized_sfw <span class="free">f2</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r2</span><span class="main">,</span><span class="free">d2</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
       generalized_sfw <span class="main">(</span>generalized_fw_join <span class="free">f1</span> <span class="free">f2</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span>simple_match_and <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span><span class="main">,</span> <span class="free">d1</span><span class="main">,</span><span class="free">d2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f1</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">am</span></span> <span class="skolem"><span class="skolem">ad</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Pair <span class="skolem">am</span> <span class="skolem">ad</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"simple_matches <span class="skolem">am</span> <span class="free">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> dra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="main">=</span> <span class="skolem">ad</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="main">=</span> <span class="skolem">am</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> a dra
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f2</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bm</span></span> <span class="skolem"><span class="skolem">bd</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> Pair <span class="skolem">bm</span> <span class="skolem">bd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"simple_matches <span class="skolem">bm</span> <span class="free">p</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">hence</span></span> drb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d2</span> <span class="main">=</span> <span class="skolem">bd</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r2</span> <span class="main">=</span> <span class="skolem">bm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> True <span class="quoted"><span class="quoted">‹simple_matches <span class="skolem">am</span> <span class="free">p</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ruc</span></span> <span class="keyword2"><span class="keyword">where</span></span> sma<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
            <span class="quoted"><span class="quoted">"simple_match_and <span class="skolem">am</span> <span class="skolem">bm</span> <span class="main">=</span> Some <span class="skolem">ruc</span>"</span></span> <span class="quoted"><span class="quoted">"simple_matches <span class="skolem">ruc</span> <span class="free">p</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> simple_match_and_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">am</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">bm</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> b
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_fw_join_def option2list_def generalized_sfw_simps drb<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> bd<span class="main">:</span>
            <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> generalized_sfw <span class="skolem">bs</span> <span class="free">p</span>"</span></span>
            <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r2</span><span class="main">,</span> <span class="free">d2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps<span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> Cons.IH<span class="main">[</span><span class="operator">OF</span> bd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> bd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> mIH<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> b
            <span class="keyword1"><span class="command">using</span></span> generalized_fw_join_2_nomatch<span class="main">[</span><span class="operator">OF</span> False<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">am</span><span class="main">,</span> <span class="skolem">ad</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="skolem">bd</span></span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps generalized_fw_join_def<span class="main">)</span>
        <span class="comment1">(*and empty_concat: "concat (map (λx. []) ms) = []" by simp*)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False 
      <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> generalized_sfw <span class="skolem">as</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generalized_sfw <span class="skolem">as</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r1</span><span class="main">,</span> <span class="free">d1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> Cons.IH<span class="main">[</span><span class="operator">OF</span> this Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mIH<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> a
        <span class="keyword1"><span class="command">unfolding</span></span> generalized_fw_join_cons_1
        <span class="keyword1"><span class="command">unfolding</span></span> generalized_sfw_append
        <span class="keyword1"><span class="command">unfolding</span></span> generalized_fw_join_1_nomatch<span class="main">[</span><span class="operator">OF</span> False<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">ad</span></span> <span class="quoted"><span class="free">f2</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_fw_join_def generalized_sfw_simps<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
  
  
  
  <span class="comment1">(* The structure is nearly the same as with generalized_fw_joinI, so it should be possible to show 
     it in one proof. But I felt like this is the better way *)</span>
  <span class="keyword1" id="Generic_SimpleFw-generalized_fw_joinD"><span class="command">lemma</span></span> generalized_fw_joinD<span class="main">:</span>
    <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span>generalized_fw_join <span class="free">f1</span> <span class="free">f2</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">d1</span><span class="main">,</span><span class="free">d2</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">r1</span> <span class="bound">r2</span><span class="main">.</span> generalized_sfw <span class="free">f1</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r1</span><span class="main">,</span><span class="free">d1</span><span class="main">)</span> <span class="main">∧</span> generalized_sfw <span class="free">f2</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r2</span><span class="main">,</span><span class="free">d2</span><span class="main">)</span> <span class="main">∧</span> Some <span class="free">u</span> <span class="main">=</span> simple_match_and <span class="bound">r1</span> <span class="bound">r2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f1</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">am</span></span> <span class="skolem"><span class="skolem">ad</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Pair <span class="skolem">am</span> <span class="skolem">ad</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"simple_matches <span class="skolem">am</span> <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r2</span><span class="main">.</span> generalized_sfw <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">am</span><span class="main">,</span> <span class="free">d1</span><span class="main">)</span> <span class="main">∧</span> generalized_sfw <span class="free">f2</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r2</span><span class="main">,</span> <span class="free">d2</span><span class="main">)</span> <span class="main">∧</span> Some <span class="free">u</span> <span class="main">=</span> simple_match_and <span class="skolem">am</span> <span class="bound">r2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f2</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bm</span></span> <span class="skolem"><span class="skolem">bd</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> Pair <span class="skolem">bm</span> <span class="skolem">bd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"simple_matches <span class="skolem">bm</span> <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹simple_matches <span class="skolem">am</span> <span class="free">p</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="comment1">(* u' = u, but I don't need that yet. *)</span> 
            <span class="keyword2"><span class="keyword">where</span></span> sma<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_match_and <span class="skolem">am</span> <span class="skolem">bm</span> <span class="main">=</span> Some <span class="skolem">u'</span> <span class="main">∧</span> simple_matches <span class="skolem">u'</span> <span class="free">p</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> simple_match_and_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">am</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">bm</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">am</span><span class="main">,</span> <span class="free">d1</span><span class="main">)</span> <span class="main">∧</span> generalized_sfw <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">bm</span><span class="main">,</span> <span class="free">d2</span><span class="main">)</span> <span class="main">∧</span> Some <span class="free">u</span> <span class="main">=</span> simple_match_and <span class="skolem">am</span> <span class="skolem">bm</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons.prems True <span class="quoted"><span class="quoted">‹simple_matches <span class="skolem">am</span> <span class="free">p</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_fw_join_def generalized_sfw_append sma generalized_sfw_simps<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span>generalized_fw_join <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">d1</span><span class="main">,</span> <span class="free">d2</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">unfolding</span></span> b <span class="keyword1"><span class="command">unfolding</span></span> generalized_fw_join_2_nomatch<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">note</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> generalized_sfw <span class="skolem">bs</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span>generalized_fw_join <span class="skolem">as</span> <span class="free">f2</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">d1</span><span class="main">,</span> <span class="free">d2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_fw_join_cons_1 generalized_sfw_append generalized_fw_join_1_nomatch<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generalized_sfw <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> generalized_sfw <span class="skolem">as</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_fw_join_def generalized_sfw_simps<span class="main">)</span>
  
  
  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We imagine two firewalls are positioned directly after each other.
        The first one has ruleset rs1 installed, the second one has ruleset rs2 installed.
        A packet needs to pass both firewalls.›</span></span>
  
  <span class="keyword1"><span class="command">theorem</span></span> simple_fw_join<span class="main">:</span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">rule_translate</span> <span class="main">≡</span>
      map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> SimpleRule <span class="bound">u</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> Accept <span class="main">∧</span> <span class="bound">b</span> <span class="main">=</span> Accept <span class="keyword1">then</span> Accept <span class="keyword1">else</span> Drop<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"simple_fw <span class="free">rs1</span> <span class="free">p</span> <span class="main">=</span> Decision FinalAllow <span class="main">∧</span> simple_fw <span class="free">rs2</span> <span class="free">p</span> <span class="main">=</span> Decision FinalAllow <span class="main">⟷</span>
      simple_fw <span class="main">(</span><span class="free">rule_translate</span> <span class="main">(</span>generalized_fw_join <span class="main">(</span>map simple_rule_dtor <span class="free">rs1</span><span class="main">)</span> <span class="main">(</span>map simple_rule_dtor <span class="free">rs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Decision FinalAllow"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> hlp1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"simple_rule_dtor <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> SimpleRule <span class="bound">u</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> Accept <span class="main">∧</span> <span class="bound">b</span> <span class="main">=</span> Accept <span class="keyword1">then</span> Accept <span class="keyword1">else</span> Drop<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        apsnd <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> Accept <span class="main">∧</span> <span class="bound">b</span> <span class="main">=</span> Accept <span class="keyword1">then</span> Accept <span class="keyword1">else</span> Drop<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff comp_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_rule_dtor_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> simple_fw_iff_generalized_fw_accept
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> generalized_fw_joinI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hlp1 rule_translate_def generalized_sfw_mapsnd <span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hlp1 generalized_sfw_mapsnd rule_translate_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> generalized_fw_joinD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  
  
  <span class="keyword1"><span class="command">theorem</span></span> simple_fw_join2<span class="main">:</span>
    <span class="comment1">― ‹translates a <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"(match, action1, action2)"</span><span class="antiquote">}</span></span> tuple of the joined generalized
       firewall to a <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list"</span><span class="antiquote">}</span></span>. The two actions are translated such
       that you only get <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Accept<span class="antiquote">}</span></span> if both actions are <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Accept<span class="antiquote">}</span></span>›</span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_simple_rule_list</span> <span class="main">≡</span> map <span class="main">(</span>apsnd <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> Accept <span class="main">⇒</span> <span class="bound">b</span>
                                                                 <span class="main">|</span>  Drop <span class="main">⇒</span> Drop<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_fw <span class="free">rs1</span> <span class="free">p</span> <span class="main">=</span> Decision FinalAllow <span class="main">∧</span> simple_fw <span class="free">rs2</span> <span class="free">p</span> <span class="main">=</span> Decision FinalAllow <span class="main">⟷</span>
           <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span>generalized_sfw <span class="main">(</span><span class="free">to_simple_rule_list</span>
            <span class="main">(</span>generalized_fw_join <span class="main">(</span>map simple_rule_dtor <span class="free">rs1</span><span class="main">)</span> <span class="main">(</span>map simple_rule_dtor <span class="free">rs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">m</span><span class="main">,</span> Accept<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> simple_fw_iff_generalized_fw_accept
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> generalized_fw_joinI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_simple_rule_list_def generalized_sfw_mapsnd<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_simple_rule_list_def generalized_sfw_mapsnd<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> generalized_fw_joinD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits simple_action.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1" id="Generic_SimpleFw-generalized_fw_join_1_1"><span class="command">lemma</span></span> generalized_fw_join_1_1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"generalized_fw_join <span class="main">[</span><span class="main">(</span><span class="free">m1</span><span class="main">,</span><span class="free">d1</span><span class="main">)</span><span class="main">]</span> <span class="free">fw2</span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">m2</span><span class="main">,</span><span class="bound">d2</span><span class="main">)</span><span class="main">.</span> <span class="main">(@)</span> <span class="main">(</span><span class="keyword1">case</span> simple_match_and <span class="free">m1</span> <span class="bound">m2</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">mu</span> <span class="main">⇒</span> <span class="main">[</span><span class="main">(</span><span class="bound">mu</span><span class="main">,</span><span class="free">d1</span><span class="main">,</span><span class="bound">d2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">fw2</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> concat_map_foldr<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(@)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'y</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">l</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_fw_join_cons_1 option2list_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> concat_map_foldr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> list.map  prod.case_distrib option.case_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1" id="Generic_SimpleFw-generalized_sfw_2_join_None"><span class="command">lemma</span></span> generalized_sfw_2_join_None<span class="main">:</span>
    <span class="quoted"><span class="quoted">"generalized_sfw <span class="free">fw2</span> <span class="free">p</span> <span class="main">=</span> None <span class="main">⟹</span> generalized_sfw <span class="main">(</span>generalized_fw_join <span class="free">fw1</span> <span class="free">fw2</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fw2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps generalized_sfw_append generalized_fw_join_2_nomatch <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits prod.splits<span class="main">)</span>
  
  <span class="keyword1" id="Generic_SimpleFw-generalized_sfw_1_join_None"><span class="command">lemma</span></span> generalized_sfw_1_join_None<span class="main">:</span>
    <span class="quoted"><span class="quoted">"generalized_sfw <span class="free">fw1</span> <span class="free">p</span> <span class="main">=</span> None <span class="main">⟹</span> generalized_sfw <span class="main">(</span>generalized_fw_join <span class="free">fw1</span> <span class="free">fw2</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fw1</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_sfw_simps generalized_fw_join_cons_1 generalized_sfw_append generalized_fw_join_1_nomatch <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits prod.splits<span class="main">)</span>


  <span class="keyword1" id="Generic_SimpleFw-generalized_sfw_join_set"><span class="command">lemma</span></span> generalized_sfw_join_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>generalized_fw_join <span class="free">f1</span> <span class="free">f2</span><span class="main">)</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">a1</span> <span class="bound">a2</span><span class="main">.</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="free">b1</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">f1</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a2</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">f2</span> <span class="main">∧</span> simple_match_and <span class="bound">a1</span> <span class="bound">a2</span> <span class="main">=</span> Some <span class="free">a</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> generalized_fw_join_def
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> generalized_fw_join_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option2set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option2set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Validity›</span></span>
  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹There's validity of matches on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> generalized_sfw<span class="antiquote"><span class="antiquote">}</span></span></span></span>, too, even on the join.›</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">gsfw_valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>len simple_match <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">gsfw_valid</span> <span class="main">≡</span> list_all <span class="main">(</span>simple_match_valid <span class="main">∘</span> fst<span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="Generic_SimpleFw-gsfw_join_valid"><span class="command">lemma</span></span> gsfw_join_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"gsfw_valid <span class="free">f1</span> <span class="main">⟹</span> gsfw_valid <span class="free">f2</span> <span class="main">⟹</span> gsfw_valid <span class="main">(</span>generalized_fw_join <span class="free">f1</span> <span class="free">f2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gsfw_valid_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f1</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> a f1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalized_fw_join_cons_1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"list_all <span class="main">_</span> <span class="improper">f1</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"list_all <span class="main">_</span> <span class="main">(</span>generalized_fw_join <span class="main">_</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f2</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option2list_def list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> simple_match_and_valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1" id="Generic_SimpleFw-gsfw_validI"><span class="command">lemma</span></span> gsfw_validI<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_fw_valid <span class="free">fw</span> <span class="main">⟹</span> gsfw_valid <span class="main">(</span>map simple_rule_dtor <span class="free">fw</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gsfw_valid_def simple_fw_valid_def 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_rule_dtor_def list_all_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> simple_rule.splits<span class="main">)</span> <span class="operator">fastforce</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Shadowed">
<div class="head">
<h1>Theory Shadowed</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Shadowed Rules›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Shadowed
<span class="keyword2"><span class="keyword">imports</span></span> <a href="SimpleFw_Semantics.html">SimpleFw_Semantics</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Removing Shadowed Rules›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Testing, not executable›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Assumes: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">simple_ruleset</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rmshadow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="tfree">'i</span> simple_packet set <span class="main">⇒</span> <span class="tfree">'i</span> simple_rule list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rmshadow</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rmshadow</span> <span class="main">(</span><span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="main">¬</span> simple_matches <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">p</span><span class="main">)</span>
    <span class="keyword1">then</span> 
      <span class="free">rmshadow</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>
    <span class="keyword1">else</span>
      <span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">rmshadow</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="main">¬</span> simple_matches <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Soundness›</span></span>
  <span class="keyword1" id="Shadowed-rmshadow_sound"><span class="command">lemma</span></span> rmshadow_sound<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> simple_fw <span class="main">(</span>rmshadow <span class="free">rs</span> <span class="free">P</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.IH Cons.prems <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_fw <span class="main">(</span>rmshadow <span class="skolem">rs</span> <span class="skolem">P</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> simple_fw <span class="skolem">rs</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">.</span> <span class="main">¬</span> simple_matches <span class="main">(</span>match_sel <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Cons.IH Cons.prems <span class="keyword1"><span class="command">have</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="var">?P'</span> <span class="main">⟹</span> simple_fw <span class="main">(</span>rmshadow <span class="skolem">rs</span> <span class="var">?P'</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> simple_fw <span class="skolem">rs</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> m a<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="main">¬</span> simple_matches <span class="improper">m</span> <span class="bound">p</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH1 nomatch<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="var">?P'</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> IH2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nomatch IH1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">corollary</span></span> rmshadow<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_packet"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_fw <span class="main">(</span>rmshadow <span class="free">rs</span> UNIV<span class="main">)</span> <span class="free">p</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rmshadow_sound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A different approach where we start with the empty set of packets and collect packets which are already ``matched-away''.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rmshadow'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="tfree">'i</span> simple_packet set <span class="main">⇒</span> <span class="tfree">'i</span> simple_rule list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rmshadow'</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rmshadow'</span> <span class="main">(</span><span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_matches <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">p</span><span class="main">}</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>
    <span class="keyword1">then</span> 
      <span class="free">rmshadow'</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>
    <span class="keyword1">else</span>
      <span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">rmshadow'</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_matches <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Shadowed-rmshadow'_sound"><span class="command">lemma</span></span> rmshadow'_sound<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="free">P</span> <span class="main">⟹</span> simple_fw <span class="main">(</span>rmshadow' <span class="free">rs</span> <span class="free">P</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.IH Cons.prems <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_fw <span class="main">(</span>rmshadow' <span class="skolem">rs</span> <span class="skolem">P</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> simple_fw <span class="skolem">rs</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_matches <span class="main">(</span>match_sel <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Cons.IH Cons.prems <span class="keyword1"><span class="command">have</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="free">p</span> <span class="main">∉</span> <span class="main">(</span>Collect <span class="main">(</span>simple_matches <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> simple_fw <span class="main">(</span>rmshadow' <span class="skolem">rs</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">∪</span> Collect <span class="main">(</span>simple_matches <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> simple_fw <span class="skolem">rs</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> nomatch_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="free">p</span> <span class="main">∉</span> <span class="skolem">P</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_matches <span class="bound">m</span> <span class="bound">p</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">P</span> <span class="main">⟹</span> <span class="main">¬</span> simple_matches <span class="bound">m</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> m a<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_matches <span class="improper">m</span> <span class="bound">p</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">P</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH1<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> nomatch_m<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nomatch<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_packet"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_fw <span class="main">(</span>rmshadow <span class="free">rs</span> UNIV<span class="main">)</span> <span class="free">p</span> <span class="main">=</span> simple_fw <span class="main">(</span>rmshadow' <span class="free">rs</span> <span class="main">{}</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rmshadow'_sound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> rmshadow_sound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Previous algorithm is not executable because we have no code for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'i</span></span><span class="main"><span class="main">::</span></span>len simple_packet set"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
      To get some code, some efficient set operations would be necessary.
        We either need union and subset or intersection and negation.
        Both subset and negation are complicated.
      Probably the BDDs which related work uses is really necessary.
›</span></span>

<span class="comment1">(*Drafting set operations which might be necessary for an executable implementation. But BDDs might just be the thing here.*)</span>
<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'i</span> simple_packet_set <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> simple_match list"</span></span>

  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_packet_set_toSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_packet_set <span class="main">⇒</span> <span class="tfree">'i</span> simple_packet set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_packet_set_toSet</span> <span class="free"><span class="bound"><span class="entity">ms</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">m</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ms</span></span></span><span class="main">.</span> simple_matches <span class="bound">m</span> <span class="bound">p</span><span class="main">}</span>"</span></span>

  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Shadowed-simple_packet_set_toSet_alt"><span class="command">lemma</span></span> simple_packet_set_toSet_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_packet_set_toSet <span class="free">ms</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">m</span> <span class="main">∈</span> set <span class="free">ms</span><span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_matches <span class="bound">m</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> simple_packet_set_toSet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_packet_set_union</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_packet_set <span class="main">⇒</span><span class="tfree">'i</span>  simple_match <span class="main">⇒</span> <span class="tfree">'i</span> simple_packet_set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">simple_packet_set_union</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>"</span></span>

  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"simple_packet_set_toSet <span class="main">(</span>simple_packet_set_union <span class="free">ps</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> simple_packet_set_toSet <span class="free">ps</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_matches <span class="free">m</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> simple_packet_set_toSet_def simple_packet_set_union_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>

   <span class="comment1">(*either a sound but not complete executable implementation or a better idea to implement subset*)</span>
   <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m'</span> <span class="main">∈</span> set <span class="free">ms</span><span class="main">.</span>
        <span class="main">{</span><span class="bound">i</span><span class="main">.</span> match_iface <span class="free">iif</span> <span class="bound">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> match_iface <span class="main">(</span>iiface <span class="bound">m'</span><span class="main">)</span> <span class="bound">i</span><span class="main">}</span> <span class="main">∧</span>
        <span class="main">{</span><span class="bound">i</span><span class="main">.</span> match_iface <span class="free">oif</span> <span class="bound">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> match_iface <span class="main">(</span>oiface <span class="bound">m'</span><span class="main">)</span> <span class="bound">i</span><span class="main">}</span> <span class="main">∧</span>
        <span class="main">{</span><span class="bound">ip</span><span class="main">.</span> simple_match_ip <span class="free">sip</span> <span class="bound">ip</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">ip</span><span class="main">.</span> simple_match_ip <span class="main">(</span>src <span class="bound">m'</span><span class="main">)</span> <span class="bound">ip</span><span class="main">}</span> <span class="main">∧</span>
        <span class="main">{</span><span class="bound">ip</span><span class="main">.</span> simple_match_ip <span class="free">dip</span> <span class="bound">ip</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">ip</span><span class="main">.</span> simple_match_ip <span class="main">(</span>dst <span class="bound">m'</span><span class="main">)</span> <span class="bound">ip</span><span class="main">}</span> <span class="main">∧</span>
        <span class="main">{</span><span class="bound">p</span><span class="main">.</span> match_proto <span class="free">protocol</span> <span class="bound">p</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> match_proto <span class="main">(</span>proto <span class="bound">m'</span><span class="main">)</span> <span class="bound">p</span><span class="main">}</span> <span class="main">∧</span>
        <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_match_port <span class="free">sps</span> <span class="bound">p</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_match_port <span class="main">(</span>sports <span class="bound">m'</span><span class="main">)</span> <span class="bound">p</span><span class="main">}</span> <span class="main">∧</span>
        <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_match_port <span class="free">dps</span> <span class="bound">p</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_match_port <span class="main">(</span>dports <span class="bound">m'</span><span class="main">)</span> <span class="bound">p</span><span class="main">}</span>
      <span class="main">)</span>
    <span class="main">⟹</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_matches <span class="main">⦇</span>iiface<span class="main">=</span><span class="free">iif</span><span class="main">,</span> oiface<span class="main">=</span><span class="free">oif</span><span class="main">,</span> src<span class="main">=</span><span class="free">sip</span><span class="main">,</span> dst<span class="main">=</span><span class="free">dip</span><span class="main">,</span> proto<span class="main">=</span><span class="free">protocol</span><span class="main">,</span> sports<span class="main">=</span><span class="free">sps</span><span class="main">,</span> dports<span class="main">=</span><span class="free">dps</span> <span class="main">⦈</span> <span class="bound">p</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span>simple_packet_set_toSet <span class="free">ms</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> simple_packet_set_toSet_def simple_packet_set_union_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_matches.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Set.Collect_mono_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">meson</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹subset or negation ... One efficient implementation would suffice.›</span></span>
    <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">::</span> <span class="tfree">'i</span><span class="main">::</span>len simple_packet<span class="main">.</span> simple_matches <span class="free">m</span> <span class="bound">p</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span>simple_packet_set_toSet <span class="free">ms</span><span class="main">)</span> <span class="main">⟷</span>
      <span class="main">{</span><span class="bound">p</span><span class="main">::</span> <span class="tfree">'i</span><span class="main">::</span>len simple_packet<span class="main">.</span> simple_matches <span class="free">m</span> <span class="bound">p</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋂</span> <span class="bound">m</span> <span class="main">∈</span> set <span class="free">ms</span><span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">¬</span> simple_matches <span class="bound">m</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_matches <span class="free">m</span> <span class="bound">p</span><span class="main">}</span> <span class="main">-</span> <span class="main">(</span>simple_packet_set_toSet <span class="free">ms</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> simple_matches <span class="free">m</span> <span class="bound">p</span><span class="main">}</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">m</span> <span class="main">∈</span> set <span class="free">ms</span><span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">::</span> <span class="tfree">'i</span><span class="main">::</span>len simple_packet<span class="main">.</span> simple_matches <span class="bound">m</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> simple_packet_set_toSet_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IP_Partition_Preliminaries">
<div class="head">
<h1>Theory IP_Partition_Preliminaries</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      IP_Partition_Preliminaries
    Authors:    Cornelius Diekmann, Max Haslbeck
*)</span>
<span class="comment1">(*SetPartitioning.thy
  Original Author: Max Haslbeck, 2015*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Partition a Set by a Specific Constraint›</span></span>
<span class="keyword1"><span class="command">theory</span></span> IP_Partition_Preliminaries
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Will be used for the IP address space partition of a firewall.
    However, this file is completely generic in terms of sets, it only imports Main.

    It will be used in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> ‹../Service_Matrix.thy›<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
    Core idea: This file partitions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> set set"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by some magic condition.
    Later, we will show that this magic condition implies that all IPs that have been grouped
    by the magic condition show the same behaviour for a simple firewall.›</span></span>

<span class="comment1">(* disjoint, ipPartition definitions *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">disjoint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">disjoint</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="bound">A</span> <span class="main">≠</span> <span class="bound">B</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∩</span> <span class="bound">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹We will call two partitioned sets \emph{complete} iff <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⋃</span></span> <span class="free"><span class="free">ss</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⋃</span></span> <span class="free"><span class="free">ts</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The condition we use to partition a set. If this holds and 
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the set of IP addresses in each rule in a firewall,
      then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a partition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⋃</span></span> <span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where each member has the same behavior
      w.r.t the firewall ruleset.›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the carrier set and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>* should be a partition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⋃</span></span> <span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
     which fulfills the following condition:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipPartition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ipPartition</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">∩</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="bound">b</span> <span class="main">⊆</span> <span class="bound">a</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">disjoint_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">disjoint_list</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">≡</span> distinct <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">∧</span> disjoint <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="comment1">(*internal*)</span>
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">disjoint_list_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">disjoint_list_rec</span> <span class="main">[]</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">disjoint_list_rec</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">disjoint_list_rec</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-disjoint_equi"><span class="command">lemma</span></span> disjoint_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_list_rec <span class="free">ts</span> <span class="main">⟹</span> disjoint <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-disjoint_list_disjoint_list_rec"><span class="command">lemma</span></span> disjoint_list_disjoint_list_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_list <span class="free">ts</span> <span class="main">⟹</span> disjoint_list_rec <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_list_def disjoint_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">addSubsetSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">addSubsetSet</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="main">⋃</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(∩)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">partitioning</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">partitioning</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">partitioning</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="free">partitioning</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">(</span>addSubsetSet <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
  
  
  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹simple examples›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"partitioning <span class="main">[</span><span class="main">{</span><span class="main">1</span><span class="main">::</span>nat<span class="main">,</span><span class="numeral">2</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">7</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">6</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">10</span><span class="main">}</span><span class="main">]</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="numeral">10</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="numeral">6</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="numeral">5</span><span class="main">,</span> <span class="numeral">7</span><span class="main">}</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="main">{</span><span class="numeral">3</span><span class="main">,</span> <span class="numeral">4</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">{</span><span class="main">{</span><span class="main">1</span><span class="main">::</span>nat<span class="main">,</span><span class="numeral">2</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">7</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">6</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">10</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>partitioning <span class="main">[</span><span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">7</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">6</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">10</span><span class="main">}</span><span class="main">]</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"disjoint <span class="main">(</span>partitioning <span class="main">[</span><span class="main">{</span><span class="main">1</span><span class="main">::</span>nat<span class="main">,</span><span class="numeral">2</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">7</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">6</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">10</span><span class="main">}</span><span class="main">]</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">{</span><span class="main">{</span><span class="main">1</span><span class="main">::</span>nat<span class="main">,</span><span class="numeral">2</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">7</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">6</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">10</span><span class="main">}</span><span class="main">}</span> <span class="main">(</span>partitioning <span class="main">[</span><span class="main">{</span><span class="main">1</span><span class="main">::</span>nat<span class="main">,</span><span class="numeral">2</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">7</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">6</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">10</span><span class="main">}</span><span class="main">]</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"ipPartition <span class="free">A</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipPartition_def<span class="main">)</span>
  
  <span class="keyword1" id="IP_Partition_Preliminaries-ipPartitionUnion"><span class="command">lemma</span></span> ipPartitionUnion<span class="main">:</span> <span class="quoted"><span class="quoted">"ipPartition <span class="free">As</span> <span class="free">Cs</span> <span class="main">∧</span> ipPartition <span class="free">Bs</span> <span class="free">Cs</span> <span class="main">⟷</span> ipPartition <span class="main">(</span><span class="free">As</span> <span class="main">∪</span> <span class="free">Bs</span><span class="main">)</span> <span class="free">Cs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ipPartition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-disjointAddSubset"><span class="command">lemma</span></span> disjointAddSubset<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint <span class="free">ts</span> <span class="main">⟹</span> disjoint <span class="main">(</span>addSubsetSet <span class="free">a</span> <span class="free">ts</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_def addSubsetSet_def<span class="main">)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-coversallAddSubset"><span class="command">lemma</span></span> coversallAddSubset<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>insert <span class="free">a</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>addSubsetSet <span class="free">a</span> <span class="free">ts</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> addSubsetSet_def<span class="main">)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-ipPartioningAddSubset0"><span class="command">lemma</span></span> ipPartioningAddSubset0<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint <span class="free">ts</span> <span class="main">⟹</span> ipPartition <span class="free">ts</span> <span class="main">(</span>addSubsetSet <span class="free">a</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> addSubsetSet_def ipPartition_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-ipPartitioningAddSubset1"><span class="command">lemma</span></span> ipPartitioningAddSubset1<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint <span class="free">ts</span> <span class="main">⟹</span> ipPartition <span class="main">(</span>insert <span class="free">a</span> <span class="free">ts</span><span class="main">)</span> <span class="main">(</span>addSubsetSet <span class="free">a</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> addSubsetSet_def ipPartition_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-addSubsetSetI"><span class="command">lemma</span></span> addSubsetSetI<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">-</span> <span class="main">⋃</span><span class="free">ts</span> <span class="main">∈</span> addSubsetSet <span class="free">s</span> <span class="free">ts</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∩</span> <span class="free">t</span> <span class="main">∈</span> addSubsetSet <span class="free">s</span> <span class="free">ts</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">-</span> <span class="free">s</span> <span class="main">∈</span> addSubsetSet <span class="free">s</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> addSubsetSet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-addSubsetSetE"><span class="command">lemma</span></span> addSubsetSetE<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> addSubsetSet <span class="free">s</span> <span class="free">ts</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">s</span> <span class="main">-</span> <span class="main">⋃</span><span class="free">ts</span>"</span></span> <span class="main">|</span> <span class="free">T</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∈</span> <span class="free">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∩</span> <span class="free">T</span>"</span></span> <span class="main">|</span> <span class="free">T</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∈</span> <span class="free">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">T</span> <span class="main">-</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> addSubsetSet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-Union_addSubsetSet"><span class="command">lemma</span></span> Union_addSubsetSet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>addSubsetSet <span class="free">b</span> <span class="free">As</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∪</span> <span class="main">⋃</span><span class="free">As</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> addSubsetSet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-addSubsetSetCom"><span class="command">lemma</span></span> addSubsetSetCom<span class="main">:</span> <span class="quoted"><span class="quoted">"addSubsetSet <span class="free">a</span> <span class="main">(</span>addSubsetSet <span class="free">b</span> <span class="free">As</span><span class="main">)</span> <span class="main">=</span> addSubsetSet <span class="free">b</span> <span class="main">(</span>addSubsetSet <span class="free">a</span> <span class="free">As</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> addSubsetSet <span class="skolem">a</span> <span class="main">(</span>addSubsetSet <span class="skolem">b</span> <span class="free">As</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> addSubsetSet <span class="skolem">b</span> <span class="main">(</span>addSubsetSet <span class="skolem">a</span> <span class="free">As</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> addSubsetSetE<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">-</span> <span class="main">⋃</span><span class="main">(</span>addSubsetSet <span class="skolem">b</span> <span class="free">As</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="main">⋃</span><span class="free">As</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Union_addSubsetSet<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> addSubsetSetI<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">T</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="main">⋃</span><span class="free">As</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">∈</span><span class="free">As</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">∩</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">∈</span><span class="free">As</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">∩</span> <span class="bound">S</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> addSubsetSetE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> addSubsetSetI<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">T</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">-</span> <span class="main">⋃</span><span class="main">(</span>addSubsetSet <span class="skolem">a</span> <span class="free">As</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">∈</span><span class="free">As</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">∩</span> <span class="main">(</span><span class="bound">S</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">∈</span><span class="free">As</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="bound">S</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> addSubsetSetE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 3<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Union_addSubsetSet<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> addSubsetSetI<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-ipPartitioningAddSubset2"><span class="command">lemma</span></span> ipPartitioningAddSubset2<span class="main">:</span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>addSubsetSet <span class="free">a</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> addSubsetSet_def ipPartition_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-disjointPartitioning_helper"><span class="command">lemma</span></span> disjointPartitioning_helper <span class="main">:</span><span class="quoted"><span class="quoted">"disjoint <span class="free">As</span> <span class="main">⟹</span> disjoint <span class="main">(</span>partitioning <span class="free">ss</span> <span class="free">As</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">As</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems disjointAddSubset <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint <span class="main">(</span>addSubsetSet <span class="skolem">s</span> <span class="skolem">As</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.IH d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint <span class="main">(</span>partitioning <span class="skolem">ss</span> <span class="main">(</span>addSubsetSet <span class="skolem">s</span> <span class="skolem">As</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-disjointPartitioning"><span class="command">lemma</span></span> disjointPartitioning<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint <span class="main">(</span>partitioning <span class="free">ss</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this disjointPartitioning_helper <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-coversallPartitioning"><span class="command">lemma</span></span> coversallPartitioning<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>partitioning <span class="free">ts</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>set <span class="free">ts</span> <span class="main">∪</span> <span class="skolem">As</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>partitioning <span class="free">ts</span> <span class="skolem">As</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">As</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">As</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_addSubsetSet sup_left_commute<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sup_bot.right_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="free">As</span> <span class="main">=</span> <span class="main">⋃</span> <span class="free">Bs</span> <span class="main">⟹</span> ipPartition <span class="free">As</span> <span class="free">Bs</span> <span class="main">⟹</span> ipPartition <span class="free">As</span> <span class="main">(</span>addSubsetSet <span class="free">a</span> <span class="free">Bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipPartition_def addSubsetSet_def<span class="main">)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-ipPartitionSingleSet"><span class="command">lemma</span></span> ipPartitionSingleSet<span class="main">:</span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">(</span>addSubsetSet <span class="free">t</span> <span class="free">Bs</span><span class="main">)</span> 
               <span class="main">⟹</span> ipPartition <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">(</span>partitioning <span class="free">ts</span> <span class="main">(</span>addSubsetSet <span class="free">t</span> <span class="free">Bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Bs</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> addSubsetSetCom ipPartitioningAddSubset2<span class="main">)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-ipPartitioning_helper"><span class="command">lemma</span></span> ipPartitioning_helper<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint <span class="free">As</span> <span class="main">⟹</span> ipPartition <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">(</span>partitioning <span class="free">ts</span> <span class="free">As</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">As</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipPartition_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems ipPartioningAddSubset0 <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"ipPartition <span class="skolem">As</span> <span class="main">(</span>addSubsetSet <span class="skolem">t</span> <span class="skolem">As</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems Cons.IH d disjointAddSubset ipPartitioningAddSubset1
      <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">(</span>set <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span>partitioning <span class="skolem">ts</span> <span class="main">(</span>addSubsetSet <span class="skolem">t</span> <span class="skolem">As</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> ipPartitioningAddSubset2 Cons.prems 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">{</span><span class="skolem">t</span><span class="main">}</span> <span class="main">(</span>addSubsetSet <span class="skolem">t</span> <span class="skolem">As</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">from</span></span> this Cons.prems ipPartitionSingleSet
      <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">{</span><span class="skolem">t</span><span class="main">}</span> <span class="main">(</span>partitioning <span class="skolem">ts</span> <span class="main">(</span>addSubsetSet <span class="skolem">t</span> <span class="skolem">As</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">t</span><span class="main">#</span><span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> ipPartitionUnion <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">As</span> <span class="bound">Bs</span> <span class="bound">Cs</span><span class="main">.</span> ipPartition <span class="bound">As</span> <span class="bound">Cs</span> <span class="main">⟹</span> ipPartition <span class="bound">Bs</span> <span class="bound">Cs</span> <span class="main">⟹</span> ipPartition <span class="main">(</span><span class="bound">As</span> <span class="main">∪</span> <span class="bound">Bs</span><span class="main">)</span> <span class="bound">Cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">with</span></span> this e f 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">(</span>set <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>partitioning <span class="skolem">ts</span> <span class="main">(</span>addSubsetSet <span class="skolem">t</span> <span class="skolem">As</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-ipPartitioning"><span class="command">lemma</span></span> ipPartitioning<span class="main">:</span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">(</span>partitioning <span class="free">ts</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this ipPartitioning_helper <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="comment1">(* OPTIMIZATION PROOFS *)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-inter_dif_help_lemma"><span class="command">lemma</span></span> inter_dif_help_lemma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>  <span class="main">⟹</span> <span class="free">B</span> <span class="main">-</span> <span class="free">S</span> <span class="main">=</span> <span class="free">B</span> <span class="main">-</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-disjoint_list_lem"><span class="command">lemma</span></span> disjoint_list_lem<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_list <span class="free">ls</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">ls</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">ls</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∩</span> <span class="bound">t</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_list_def disjoint_def<span class="main">)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-disjoint_list_empty"><span class="command">lemma</span></span> disjoint_list_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_list <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_list_def disjoint_def<span class="main">)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-disjoint_sublist"><span class="command">lemma</span></span> disjoint_sublist<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_list <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> disjoint_list <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_list_empty disjoint_list_def disjoint_def<span class="main">)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">intersection_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">intersection_list</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">intersection_list</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">intersection_list</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">intersection_list_opt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">intersection_list_opt</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">intersection_list_opt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">intersection_list_opt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-disjoint_subset"><span class="command">lemma</span></span> disjoint_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint <span class="free">A</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">a</span> <span class="main">⟹</span> disjoint <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-disjoint_intersection"><span class="command">lemma</span></span> disjoint_intersection<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint <span class="free">A</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> disjoint <span class="main">(</span><span class="main">{</span><span class="free">a</span> <span class="main">∩</span> <span class="free">b</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-intList_equi"><span class="command">lemma</span></span> intList_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_list_rec <span class="free">ts</span> <span class="main">⟹</span> intersection_list <span class="free">s</span> <span class="free">ts</span> <span class="main">=</span> intersection_list_opt <span class="free">s</span> <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intersection_list_opt <span class="free">s</span> <span class="skolem">ts</span> <span class="main">=</span> intersection_list_opt <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Cons
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="skolem">ts</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">∩</span> <span class="bound">t</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> intersection_list_opt <span class="skolem">s</span> <span class="skolem">ts</span> <span class="main">=</span> intersection_list_opt <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_Int_distrib2 Diff_empty Diff_eq Un_Diff_Int sup_bot.right_neutral<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_Int_distrib2 Diff_empty Un_empty inf_sup_distrib1<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">difference_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">difference_list</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">difference_list</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">difference_list</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">difference_list_opt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">difference_list_opt</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">difference_list_opt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">difference_list_opt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
  
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-difList_equi"><span class="command">lemma</span></span> difList_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_list_rec <span class="free">ts</span> <span class="main">⟹</span> difference_list <span class="free">s</span> <span class="free">ts</span> <span class="main">=</span> difference_list_opt <span class="free">s</span> <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> difference_list_opt_lem0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set<span class="main">(</span><span class="skolem">ts</span><span class="main">)</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">∩</span> <span class="bound">t</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
                                        difference_list_opt <span class="skolem">s</span> <span class="skolem">ts</span> <span class="main">=</span> difference_list_opt <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inter_dif_help_lemma<span class="main">)</span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_Int_distrib2 Diff_eq Un_Diff_Int sup_bot.right_neutral<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_list_rec <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span> difference_list_opt <span class="skolem">s</span> <span class="skolem">ts</span> <span class="main">=</span> difference_list_opt <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> difference_list_opt_lem0<span class="main">)</span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_empty inf_sup_distrib1 inter_dif_help_lemma<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
   
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">partList0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">partList0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">partList0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">partList0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partList0_set_equi"><span class="command">lemma</span></span> partList0_set_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>partList0 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(∩)</span> <span class="free">s</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partList_sub_equi0"><span class="command">lemma</span></span> partList_sub_equi0<span class="main">:</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>partList0 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span>
                             set<span class="main">(</span>difference_list <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∪</span> set<span class="main">(</span>intersection_list <span class="free">s</span> <span class="free">ts</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">partList1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">partList1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">partList1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">partList1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partList_sub_equi"><span class="command">lemma</span></span> partList_sub_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>partList1 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> 
                            set<span class="main">(</span>difference_list_opt <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∪</span> set<span class="main">(</span>intersection_list_opt <span class="free">s</span> <span class="free">ts</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partList0_partList1_equi"><span class="command">lemma</span></span> partList0_partList1_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_list_rec <span class="free">ts</span> <span class="main">⟹</span> set <span class="main">(</span>partList0 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>partList1 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partList_sub_equi partList_sub_equi0 intList_equi difList_equi<span class="main">)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">partList2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">partList2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">partList2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">partList2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>
                                         <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">partList2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partList2_empty"><span class="command">lemma</span></span> partList2_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"partList2 <span class="main">{}</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
   
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partList1_partList2_equi"><span class="command">lemma</span></span> partList1_partList2_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>partList1 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="main">=</span> set<span class="main">(</span>partList2 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">partList3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">partList3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">partList3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
                            <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">partList3</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>
                                           <span class="keyword1">else</span> 
                              <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">partList3</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>
                                             <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">partList3</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partList2_partList3_equi"><span class="command">lemma</span></span> partList2_partList3_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>partList2 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="main">=</span> set<span class="main">(</span>partList3 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partList2_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">partList4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">partList4</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">partList4</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
                            <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">partList4</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>
                                           <span class="keyword1">else</span> 
                              <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">partList4</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>
                                             <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">partList4</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partList4"><span class="command">lemma</span></span> partList4<span class="main">:</span> <span class="quoted"><span class="quoted">"partList4 <span class="free">s</span> <span class="free">ts</span> <span class="main">=</span> partList3 <span class="free">s</span> <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Diff_triv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partList0_addSubsetSet_equi"><span class="command">lemma</span></span> partList0_addSubsetSet_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> 
                                      addSubsetSet <span class="free">s</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="main">=</span> set<span class="main">(</span>partList0 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> addSubsetSet_def partList0_set_equi<span class="main">)</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">partitioning_nontail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">partitioning_nontail</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">partitioning_nontail</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> addSubsetSet <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">partitioning_nontail</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partitioningCom"><span class="command">lemma</span></span> partitioningCom<span class="main">:</span> <span class="quoted"><span class="quoted">"addSubsetSet <span class="free">a</span> <span class="main">(</span>partitioning <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> partitioning <span class="free">ss</span> <span class="main">(</span>addSubsetSet <span class="free">a</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> addSubsetSetCom<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partitioning_nottail_equi"><span class="command">lemma</span></span> partitioning_nottail_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"partitioning_nontail <span class="free">ss</span> <span class="free">ts</span> <span class="main">=</span> partitioning <span class="free">ss</span> <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> addSubsetSetCom partitioningCom<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">partitioning1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">partitioning1</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">partitioning1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> partList4 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">partitioning1</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="IP_Partition_Preliminaries-partList4_empty"><span class="command">lemma</span></span> partList4_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="free">ts</span> <span class="main">⟹</span> <span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>partList4 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1" id="IP_Partition_Preliminaries-partitioning1_empty0"><span class="command">lemma</span></span> partitioning1_empty0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="free">ts</span> <span class="main">⟹</span> <span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>partitioning1 <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partList4_empty<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1" id="IP_Partition_Preliminaries-partitioning1_empty1"><span class="command">lemma</span></span> partitioning1_empty1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="free">ts</span> <span class="main">⟹</span> 
                                set<span class="main">(</span>partitioning1 <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="main">=</span> set<span class="main">(</span>partitioning1 <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partitioning1_empty0<span class="main">)</span>
  
  <span class="keyword1" id="IP_Partition_Preliminaries-partList4_subset"><span class="command">lemma</span></span> partList4_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>partList4 <span class="free">b</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partList4<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> disjoint_list_rec <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">ts</span><span class="main">)</span> <span class="main">⟷</span> disjoint_list_rec <span class="free">ts</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">∩</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1" id="IP_Partition_Preliminaries-partList4_complete0"><span class="command">lemma</span></span> partList4_complete0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>partList4 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partList4
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Diff_subset_conv Un_Diff_Int inf_sup_aci<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> sup.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partList4_disjoint"><span class="command">lemma</span></span> partList4_disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> disjoint_list_rec <span class="free">ts</span> <span class="main">⟹</span> 
                             disjoint_list_rec <span class="main">(</span>partList4 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Diff_subset_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Diff_subset_conv Int_absorb1 Int_lower2 Un_absorb1 partList4_complete0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> partList4_complete0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Diff_subset_conv Diff_triv IntI UnionI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Diff_subset_conv Diff_triv<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> partList4_complete0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_subset_conv IntI UnionI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1" id="IP_Partition_Preliminaries-union_set_partList4"><span class="command">lemma</span></span> union_set_partList4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>partList4 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partList4_distinct_hlp"><span class="command">lemma</span></span> partList4_distinct_hlp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">ts</span>"</span></span> <span class="quoted"><span class="quoted">"disjoint <span class="main">(</span>insert <span class="free">a</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="main">(</span>partList4 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">a</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> disjoint_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">a</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>partList4 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> union_set_partList4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partList4_distinct"><span class="command">lemma</span></span> partList4_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="free">ts</span> <span class="main">⟹</span> disjoint_list <span class="free">ts</span> <span class="main">⟹</span> distinct <span class="main">(</span>partList4 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xa</span> <span class="bound">xb</span> <span class="bound">xc</span><span class="main">.</span>
         <span class="skolem">t</span> <span class="main">∉</span> set <span class="skolem">ts</span> <span class="main">⟹</span>
         disjoint <span class="main">(</span>insert <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
         <span class="bound">xa</span> <span class="main">∈</span> <span class="skolem">t</span> <span class="main">⟹</span>
         <span class="bound">xb</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">⟹</span> 
         <span class="bound">xb</span> <span class="main">∈</span> <span class="skolem">t</span> <span class="main">⟹</span> 
         <span class="bound">xb</span> <span class="main">∉</span> <span class="main">{}</span> <span class="main">⟹</span> 
         <span class="bound">xc</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">⟹</span> 
         <span class="bound">xc</span> <span class="main">∉</span> <span class="main">{}</span> <span class="main">⟹</span> 
         <span class="skolem">t</span> <span class="main">∩</span> <span class="skolem">s</span> <span class="main">∈</span> set <span class="main">(</span>partList4 <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span> 
         <span class="main">¬</span> <span class="skolem">t</span> <span class="main">∩</span> <span class="skolem">s</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>partList4 <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_set_partList4 disjoint_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span> <span class="comment1">(*1s*)</span>
      <span class="keyword1"><span class="command">have</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xa</span> <span class="bound">xb</span> <span class="bound">xc</span><span class="main">.</span>
         <span class="skolem">t</span> <span class="main">∉</span> set <span class="skolem">ts</span> <span class="main">⟹</span>
         disjoint <span class="main">(</span>insert <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
         <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">t</span> <span class="main">⟹</span>
         <span class="bound">xa</span> <span class="main">∈</span> <span class="skolem">t</span> <span class="main">⟹</span>
         <span class="bound">xa</span> <span class="main">∉</span> <span class="skolem">s</span> <span class="main">⟹</span>
         <span class="bound">xb</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">⟹</span> 
         <span class="bound">xc</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">⟹</span> 
         <span class="main">¬</span> <span class="skolem">t</span> <span class="main">-</span> <span class="skolem">s</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>partList4 <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_set_partList4 disjoint_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span> <span class="comment1">(*1s*)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>partList4 <span class="skolem">s</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
        <span class="keyword1"><span class="command">using</span></span> disjoint_sublist list.set_intros<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> disjoint_list_def
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> partList4_distinct_hlp<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> partList4_distinct_hlp<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> partList4_distinct_hlp<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">using</span></span> x1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command">using</span></span> x2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1" id="IP_Partition_Preliminaries-partList4_disjoint_list"><span class="command">lemma</span></span> partList4_disjoint_list<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">ts</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"disjoint_list <span class="free">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="free">ts</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"disjoint_list <span class="main">(</span>partList4 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> disjoint_list_def
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>partList4 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> partList4_distinct disjoint_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"disjoint <span class="main">(</span>set <span class="main">(</span>partList4 <span class="free">s</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> disjoint_list_disjoint_list_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_list <span class="free">ts</span> <span class="main">⟹</span> disjoint_list_rec <span class="free">ts</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_list_def disjoint_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> partList4_disjoint disjoint_equi assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1" id="IP_Partition_Preliminaries-partitioning1_subset"><span class="command">lemma</span></span> partitioning1_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>partitioning1 <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partList4_subset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1" id="IP_Partition_Preliminaries-partitioning1_disjoint_list"><span class="command">lemma</span></span> partitioning1_disjoint_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="free">ss</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span>
                                 disjoint_list <span class="free">ts</span> <span class="main">⟹</span> disjoint_list <span class="main">(</span>partitioning1 <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> partList4_disjoint_list<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> partitioning1_subset <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> partitioning1_empty0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partitioning1_disjoint"><span class="command">lemma</span></span> partitioning1_disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>set <span class="free">ss</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span>
                                 disjoint_list_rec <span class="free">ts</span> <span class="main">⟹</span> disjoint_list_rec <span class="main">(</span>partitioning1 <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partList4_disjoint partitioning1_subset<span class="main">)</span>

  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="IP_Partition_Preliminaries-partitioning_equi"><span class="command">lemma</span></span> partitioning_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="free">ts</span> <span class="main">⟹</span> disjoint_list_rec <span class="free">ts</span> <span class="main">⟹</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="free">ss</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span>
           set<span class="main">(</span>partitioning1 <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> partitioning_nontail <span class="free">ss</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> addSubsetSet_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"addSubsetSet <span class="skolem">s</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="main">=</span> addSubsetSet <span class="skolem">s</span> <span class="skolem">ts</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ts</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> addSubsetSet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_list_rec <span class="skolem">ts</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span>
                                        addSubsetSet <span class="skolem">s</span> <span class="main">(</span>set <span class="skolem">ts</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="main">=</span> set <span class="main">(</span>partList4 <span class="skolem">s</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ts</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> partList4
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partList0_addSubsetSet_equi partList0_partList1_equi partList1_partList2_equi
                   partList2_partList3_equi<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_list_rec <span class="main">(</span>partitioning1 <span class="skolem">ss</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> partitioning1_disjoint Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>partitioning1 <span class="skolem">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Sup_upper dual_order.trans list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> partitioning1_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>partitioning1 <span class="skolem">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> partitioning_nontail <span class="skolem">ss</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> r<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partList4_empty addSubsetSet_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1" id="IP_Partition_Preliminaries-ipPartitioning_helper_opt"><span class="command">lemma</span></span> ipPartitioning_helper_opt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="free">ts</span> <span class="main">⟹</span> disjoint_list <span class="free">ts</span> <span class="main">⟹</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="free">ss</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> 
                                    <span class="main">⟹</span> ipPartition <span class="main">(</span>set <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>partitioning1 <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> disjoint_list_disjoint_list_rec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partitioning_equi partitioning_nottail_equi<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Diff_subset disjoint_equi ipPartition_def ipPartitioning_helper subsetCE<span class="main">)</span>
  
  <span class="keyword1" id="IP_Partition_Preliminaries-complete_helper"><span class="command">lemma</span></span> complete_helper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="free">ts</span> <span class="main">⟹</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="free">ss</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span><span class="main">⟹</span>
        <span class="main">⋃</span> <span class="main">(</span>set <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>partitioning1 <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> partList4_complete0<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"partitioning1  <span class="main">[</span><span class="main">{</span><span class="main">1</span><span class="main">::</span>nat<span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">2</span><span class="main">}</span><span class="main">,</span><span class="main">{}</span><span class="main">]</span> <span class="main">[</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="main">{</span><span class="numeral">2</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">3</span><span class="main">}</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="main">{</span><span class="numeral">2</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="numeral">3</span><span class="main">}</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

  <span class="keyword1" id="IP_Partition_Preliminaries-partitioning_foldr"><span class="command">lemma</span></span> partitioning_foldr<span class="main">:</span> <span class="quoted"><span class="quoted">"partitioning <span class="free">X</span> <span class="free">B</span> <span class="main">=</span> foldr addSubsetSet <span class="free">X</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> partitioningCom<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">(</span>set <span class="free">X</span><span class="main">)</span> <span class="main">(</span>foldr addSubsetSet <span class="free">X</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> partitioning_foldr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ipPartitioning <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>set <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>foldr addSubsetSet <span class="free">X</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> partitioning_foldr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coversallPartitioning<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"partitioning1 <span class="free">X</span> <span class="free">B</span> <span class="main">=</span> foldr partList4 <span class="free">X</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">(</span>set <span class="free">X</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>partitioning1 <span class="free">X</span> <span class="main">[</span>UNIV<span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ipPartitioning_helper_opt<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_list_def disjoint_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>partitioning1 <span class="free">X</span> <span class="main">[</span>UNIV<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>partitioning1 <span class="free">X</span> <span class="main">[</span>UNIV<span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> complete_helper<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ts<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span>UNIV<span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="GroupF">
<div class="head">
<h1>Theory GroupF</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Group by Function›</span></span>
<span class="keyword1"><span class="command">theory</span></span> GroupF
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Grouping elements of a list according to a function.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">groupF</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">groupF</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">groupF</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">groupF</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹trying a more efficient implementation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">groupF</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">select_p_tuple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">select_p_tuple</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_tailrec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">partition_tailrec</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> foldr <span class="main">(</span>select_p_tuple <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="GroupF-partition_tailrec"><span class="command">lemma</span></span> partition_tailrec<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_tailrec <span class="free">f</span> <span class="free">as</span> <span class="main">=</span>  <span class="main">(</span>filter <span class="free">f</span> <span class="free">as</span><span class="main">,</span>  filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ts_accu</span> <span class="skolem">fs_accu</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldr <span class="main">(</span>select_p_tuple <span class="free">f</span><span class="main">)</span> <span class="free">as</span> <span class="main">(</span><span class="skolem">ts_accu</span><span class="main">,</span> <span class="skolem">fs_accu</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span>filter <span class="free">f</span> <span class="free">as</span> <span class="main">@</span> <span class="skolem">ts_accu</span><span class="main">,</span>  filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">as</span> <span class="main">@</span> <span class="skolem">fs_accu</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ts_accu</span></span> <span class="quoted"><span class="skolem">fs_accu</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_tailrec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span>
    <span class="quoted"><span class="quoted">"groupF <span class="free">f</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">ts</span><span class="main">,</span> <span class="bound">fs</span><span class="main">)</span> <span class="main">=</span> partition_tailrec <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="free">xs</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="bound">ts</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>groupF <span class="free">f</span> <span class="bound">fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_tailrec<span class="main">)</span>
  
  <span class="comment1">(*is this more efficient?*)</span>
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">function</span></span> <span class="entity">groupF_code</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">groupF_code</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">groupF_code</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
                               <span class="main">(</span><span class="bound">ts</span><span class="main">,</span> <span class="bound">fs</span><span class="main">)</span> <span class="main">=</span> partition_tailrec <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
                             <span class="keyword1">in</span>
                               <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="bound">ts</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">groupF_code</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">pat_completeness</span><span class="main">)</span> <span class="operator">auto</span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">termination</span></span> <span class="quoted">groupF_code</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">as</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_tailrec<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> le_imp_less_Suc length_filter_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1" id="GroupF-groupF_code"><span class="command">lemma</span></span> groupF_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"groupF <span class="free">f</span> <span class="free">as</span> <span class="main">=</span> groupF_code <span class="free">f</span> <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> groupF_code.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_tailrec<span class="main">)</span>
  
  <span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">groupF</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="GroupF-groupF_concat_set"><span class="command">lemma</span></span> groupF_concat_set<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>concat <span class="main">(</span>groupF <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> groupF.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="GroupF-groupF_Union_set"><span class="command">lemma</span></span> groupF_Union_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>groupF <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> set <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> groupF.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="GroupF-groupF_set"><span class="command">lemma</span></span> groupF_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> set <span class="main">(</span>groupF <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> groupF_concat_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="GroupF-groupF_equality"><span class="command">lemma</span></span> groupF_equality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">same</span> <span class="free">f</span> <span class="free">A</span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">a1</span> <span class="main">∈</span> set <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span> <span class="main">∈</span> set <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a1</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> set <span class="main">(</span>groupF <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">same</span> <span class="free">f</span> <span class="bound">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> groupF.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> groupF_fst<span class="main">:</span>
        <span class="quoted"><span class="quoted">"groupF <span class="skolem">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> groupF <span class="skolem">f</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>set <span class="main">[</span><span class="skolem">x</span> <span class="main">#</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">]</span><span class="main">]</span><span class="main">.</span> <span class="free">same</span> <span class="skolem">f</span> <span class="bound">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> same_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> groupF_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GroupF-groupF_nequality"><span class="command">lemma</span></span> groupF_nequality<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="main">(</span>groupF <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">∈</span> set <span class="main">(</span>groupF <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≠</span> <span class="free">B</span> <span class="main">⟹</span>
     <span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> set <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="free">f</span> <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> groupF.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> groupF.simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> groupF_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="comment1">(*1s*)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GroupF-groupF_cong"><span class="command">lemma</span></span> groupF_cong<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f1</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f2</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="free">f1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f1</span> <span class="bound">y</span> <span class="main">⟷</span> <span class="free">f2</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"groupF <span class="free">f1</span> <span class="free">xs</span> <span class="main">=</span> groupF <span class="free">f2</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f1</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> groupF.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> filter_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">f2</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">y</span>"</span></span><span class="main">]</span>
                                     filter_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="bound">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">f2</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">f2</span> <span class="bound">y</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="GroupF-groupF_empty"><span class="command">lemma</span></span> groupF_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"groupF <span class="free">f</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> groupF.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="GroupF-groupF_empty_elem"><span class="command">lemma</span></span> groupF_empty_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>groupF <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> groupF.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="GroupF-groupF_distinct"><span class="command">lemma</span></span> groupF_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span>concat <span class="main">(</span>groupF <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> groupF.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groupF_Union_set<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹It is possible to use
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"map <span class="main"><span class="main">(</span></span>map fst<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>groupF snd <span class="main"><span class="main">(</span></span>map <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">f</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">P</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  instead of
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"groupF <span class="free"><span class="free">f</span></span> <span class="free"><span class="free">P</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  for the following reasons:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> groupF<span class="antiquote"><span class="antiquote">}</span></span></span></span> executes its compare function (first parameter) very often;
    it always tests for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">f</span></span> <span class="free"><span class="free">y</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
    The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> may be really expensive.
    At least polyML does not share the result of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> but (probably) always recomputes (part of) it.
    The optimization pre-computes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and tells <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> groupF<span class="antiquote"><span class="antiquote">}</span></span></span></span> to use
    a really cheap function (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> snd<span class="antiquote"><span class="antiquote">}</span></span></span></span>) to compare.
    The following lemma tells that those are equal.›</span></span>
  <span class="comment1">(* is this also faster for Haskell?*)</span>

<span class="keyword1" id="GroupF-groupF_tuple"><span class="command">lemma</span></span> groupF_tuple<span class="main">:</span> <span class="quoted"><span class="quoted">"groupF <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span>map fst<span class="main">)</span> <span class="main">(</span>groupF snd <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> groupF.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> g1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span> map fst <span class="main">[</span><span class="bound">y</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> snd <span class="bound">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> g2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≠</span> snd <span class="bound">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 2 g1 g2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IP_Addr_WordInterval_toString">
<div class="head">
<h1>Theory IP_Addr_WordInterval_toString</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Helper: Pretty Printing Word Intervals which correspond to IP address Ranges›</span></span>
<span class="keyword1"><span class="command">theory</span></span> IP_Addr_WordInterval_toString
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../IP_Addresses/IP_Address_toString.html">IP_Addresses.IP_Address_toString</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*The "u" stands for union. I guess you may want to customize this pretty printing syntax :D*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ipv4addr_wordinterval_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">32</span> wordinterval <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ipv4addr_wordinterval_toString</span> <span class="main">(</span>WordInterval <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> ipv4addr_toString <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> <span class="inner_quoted">''{''</span><span class="main">@</span>ipv4addr_toString <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">@</span><span class="inner_quoted">'' .. ''</span><span class="main">@</span>ipv4addr_toString <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">@</span><span class="inner_quoted">''}''</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ipv4addr_wordinterval_toString</span> <span class="main">(</span>RangeUnion <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="free">ipv4addr_wordinterval_toString</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' u ''</span><span class="main">@</span><span class="free">ipv4addr_wordinterval_toString</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ipv6addr_wordinterval_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">128</span> wordinterval <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ipv6addr_wordinterval_toString</span> <span class="main">(</span>WordInterval <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> ipv6addr_toString <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> <span class="inner_quoted">''{''</span><span class="main">@</span>ipv6addr_toString <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">@</span><span class="inner_quoted">'' .. ''</span><span class="main">@</span>ipv6addr_toString <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">@</span><span class="inner_quoted">''}''</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ipv6addr_wordinterval_toString</span> <span class="main">(</span>RangeUnion <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="free">ipv6addr_wordinterval_toString</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' u ''</span><span class="main">@</span><span class="free">ipv6addr_wordinterval_toString</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Primitives_toString">
<div class="head">
<h1>Theory Primitives_toString</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹toString Functions for Primitives›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Primitives_toString
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Lib_Enum_toString.html">../Common/Lib_Enum_toString</a>"</span>
        <a href="../IP_Addresses/IP_Address_toString.html">IP_Addresses.IP_Address_toString</a>
        <a href="Iface.html">Iface</a>
        <a href="L4_Protocol.html">L4_Protocol</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipv4_cidr_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ipv4addr <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ipv4_cidr_toString</span> <span class="free"><span class="bound"><span class="entity">ip_n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ip_n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">base</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⇒</span>  <span class="main">(</span>ipv4addr_toString <span class="bound">base</span> <span class="main">@</span><span class="inner_quoted">''/''</span><span class="main">@</span> string_of_nat <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"ipv4_cidr_toString <span class="main">(</span>ipv4addr_of_dotdecimal <span class="main">(</span><span class="numeral">192</span><span class="main">,</span><span class="numeral">168</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="numeral">22</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">''192.168.0.1/22''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipv6_cidr_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ipv6addr <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ipv6_cidr_toString</span> <span class="free"><span class="bound"><span class="entity">ip_n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ip_n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">base</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⇒</span>  <span class="main">(</span>ipv6addr_toString <span class="bound">base</span> <span class="main">@</span><span class="inner_quoted">''/''</span><span class="main">@</span> string_of_nat <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"ipv6_cidr_toString <span class="main">(</span><span class="numeral">42540766411282592856906245548098208122</span><span class="main">,</span> <span class="numeral">64</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">''2001:db8::8:800:200c:417a/64''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primitive_protocol_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"primitive_protocol <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">primitive_protocol_toString</span> <span class="free"><span class="bound"><span class="entity">protid</span></span></span> <span class="main">≡</span> <span class="main">(</span> 
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">protid</span></span></span> <span class="main">=</span> TCP <span class="keyword1">then</span> <span class="inner_quoted">''tcp''</span> <span class="keyword1">else</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">protid</span></span></span> <span class="main">=</span> UDP <span class="keyword1">then</span> <span class="inner_quoted">''udp''</span> <span class="keyword1">else</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">protid</span></span></span> <span class="main">=</span> ICMP <span class="keyword1">then</span> <span class="inner_quoted">''icmp''</span> <span class="keyword1">else</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">protid</span></span></span> <span class="main">=</span> L4_Protocol.SCTP <span class="keyword1">then</span> <span class="inner_quoted">''sctp''</span> <span class="keyword1">else</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">protid</span></span></span> <span class="main">=</span> L4_Protocol.IGMP <span class="keyword1">then</span> <span class="inner_quoted">''igmp''</span> <span class="keyword1">else</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">protid</span></span></span> <span class="main">=</span> L4_Protocol.GRE <span class="keyword1">then</span> <span class="inner_quoted">''gre''</span> <span class="keyword1">else</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">protid</span></span></span> <span class="main">=</span> L4_Protocol.ESP <span class="keyword1">then</span> <span class="inner_quoted">''esp''</span> <span class="keyword1">else</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">protid</span></span></span> <span class="main">=</span> L4_Protocol.AH <span class="keyword1">then</span> <span class="inner_quoted">''ah''</span> <span class="keyword1">else</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">protid</span></span></span> <span class="main">=</span> L4_Protocol.IPv6ICMP <span class="keyword1">then</span> <span class="inner_quoted">''ipv6-icmp''</span> <span class="keyword1">else</span>
  <span class="inner_quoted">''protocolid:''</span><span class="main">@</span>dec_string_of_word0 <span class="free"><span class="bound"><span class="entity">protid</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">protocol_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"protocol <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">protocol_toString</span> <span class="main">(</span>ProtoAny<span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">''all''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">protocol_toString</span> <span class="main">(</span>Proto <span class="free"><span class="bound"><span class="entity">protid</span></span></span><span class="main">)</span> <span class="main">=</span> primitive_protocol_toString <span class="free"><span class="bound"><span class="entity">protid</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iface_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> iface <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">iface_toString</span> <span class="free"><span class="bound"><span class="entity">descr</span></span></span> <span class="free"><span class="bound"><span class="entity">iface</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">iface</span></span></span> <span class="main">=</span> ifaceAny <span class="keyword1">then</span> <span class="inner_quoted">''''</span> <span class="keyword1">else</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">iface</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Iface <span class="bound">name</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">descr</span></span></span><span class="main">@</span><span class="bound">name</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"iface_toString <span class="inner_quoted">''in: ''</span> <span class="main">(</span>Iface <span class="inner_quoted">''+''</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">''''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"iface_toString <span class="inner_quoted">''in: ''</span> <span class="main">(</span>Iface <span class="inner_quoted">''eth0''</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">''in: eth0''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">port_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">16</span> word <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">port_toString</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> dec_string_of_word0 <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ports_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="main">(</span><span class="numeral">16</span> word <span class="main">×</span> <span class="numeral">16</span> word<span class="main">)</span> <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ports_toString</span> <span class="free"><span class="bound"><span class="entity">descr</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> max_word <span class="keyword1">then</span> <span class="inner_quoted">''''</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">descr</span></span></span> <span class="main">@</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> port_toString <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> port_toString <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">@</span><span class="inner_quoted">'':''</span><span class="main">@</span>port_toString <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"ports_toString <span class="inner_quoted">''spt: ''</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="numeral">65535</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">''''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"ports_toString <span class="inner_quoted">''spt: ''</span> <span class="main">(</span><span class="numeral">1024</span><span class="main">,</span><span class="numeral">2048</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">''spt: 1024:2048''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"ports_toString <span class="inner_quoted">''spt: ''</span> <span class="main">(</span><span class="numeral">1024</span><span class="main">,</span><span class="numeral">1024</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">''spt: 1024''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipv4_cidr_opt_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> ipv4addr <span class="main">×</span> nat <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ipv4_cidr_opt_toString</span> <span class="free"><span class="bound"><span class="entity">descr</span></span></span> <span class="free"><span class="bound"><span class="entity">ip</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ip</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="inner_quoted">''''</span> <span class="keyword1">else</span>
      <span class="free"><span class="bound"><span class="entity">descr</span></span></span><span class="main">@</span>ipv4_cidr_toString <span class="free"><span class="bound"><span class="entity">ip</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">protocol_opt_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> protocol <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">protocol_opt_toString</span> <span class="free"><span class="bound"><span class="entity">descr</span></span></span> <span class="free"><span class="bound"><span class="entity">prot</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">prot</span></span></span> <span class="main">=</span> ProtoAny <span class="keyword1">then</span> <span class="inner_quoted">''''</span> <span class="keyword1">else</span>
      <span class="free"><span class="bound"><span class="entity">descr</span></span></span><span class="main">@</span>protocol_toString <span class="free"><span class="bound"><span class="entity">prot</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Service_Matrix">
<div class="head">
<h1>Theory Service_Matrix</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Service_Matrix.thy
    Authors:    Cornelius Diekmann, Max Haslbeck
*)</span>
<span class="comment1">(*IPPartitioning.thy
  Original Author: Max Haslbeck, 2015*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Service Matrices›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Service_Matrix
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="List_Product_More.html">Common/List_Product_More</a>"</span>
        <span class="quoted">"<a href="IP_Partition_Preliminaries.html">Common/IP_Partition_Preliminaries</a>"</span>
        <span class="quoted">"<a href="GroupF.html">Common/GroupF</a>"</span>
        <span class="quoted">"<a href="IP_Addr_WordInterval_toString.html">Common/IP_Addr_WordInterval_toString</a>"</span>
        <span class="quoted">"<a href="Primitives_toString.html">Primitives/Primitives_toString</a>"</span>
        <a href="SimpleFw_Semantics.html">SimpleFw_Semantics</a>
        <a href="../IP_Addresses/WordInterval_Sorted.html">IP_Addresses.WordInterval_Sorted</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹IP Address Space Partition›</span></span>

<span class="comment1">(* could be generalized more *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">extract_IPSets_generic0</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">::</span>len simple_match <span class="main">⇒</span> <span class="tfree">'i</span> word <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'i</span> simple_rule list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span> wordinterval<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extract_IPSets_generic0</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">extract_IPSets_generic0</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="main">(</span><span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ipcidr_tuple_to_wordinterval <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">#</span>
                                                       <span class="main">(</span><span class="free">extract_IPSets_generic0</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Service_Matrix-extract_IPSets_generic0_length"><span class="command">lemma</span></span> extract_IPSets_generic0_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>extract_IPSets_generic0 <span class="free">sel</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> extract_IPSets_generic0.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>


<span class="comment1">(*
The order in which extract_IPSets returns the collected IP ranges heavily influences the running time
of the subsequent algorithms.
For example:
1) iterating through the ruleset and collecting all source and destination ips:
   10:10:49 elapsed time, 38:41:17 cpu time, factor 3.80
2) iterating through the ruleset and first returning all source ips and iterating again and then return all destination ips:
   3:39:56 elapsed time, 21:08:34 cpu time, factor 5.76

To get a more deterministic runtime, we are sorting the output. As a performance optimization, we also remove duplicate entries.
We use mergesort_remdups, which does a mergesort (i.e sorts!) and removes duplicates and mergesort_by_rel which does a mergesort
(without removing duplicates) and allows to specify the relation we use to sort.
In theory, the largest ip ranges (smallest prefix length) should be put first, the following evaluation shows that this may not
be the fastest solution. The reason might be that access_matrix_pretty_ipv4 picks (almost randomly) one IP from the result and
there are fast and slower choices. The faster choices are the ones where the firewall ruleset has a decision very early. 
Therefore, the running time is still a bit unpredictable.

Here is the data:
map ipcidr_tuple_to_wordinterval (mergesort_by_rel (λ (a1,a2) (b1, b2). (a2, a1) ≤ (b2, b1)) (mergesort_remdups
                        ((map (src ∘ match_sel) rs) @ (map (dst ∘ match_sel) rs))))
 (2:47:04 elapsed time, 17:08:01 cpu time, factor 6.15)


map ipcidr_tuple_to_wordinterval (mergesort_remdups ((map (src ∘ match_sel) rs) @ (map (dst ∘ match_sel) rs)))
 (2:41:03 elapsed time, 16:56:46 cpu time, factor 6.31)


map ipcidr_tuple_to_wordinterval (mergesort_by_rel (λ (a1,a2) (b1, b2). (a2, a1) ≤ (b2, b1)) (
                         ((map (src ∘ match_sel) rs) @ (map (dst ∘ match_sel) rs)))
 (5:52:28 elapsed time, 41:50:10 cpu time, factor 7.12)


map ipcidr_tuple_to_wordinterval (mergesort_by_rel (≤)
                         ((map (src ∘ match_sel) rs) @ (map (dst ∘ match_sel) rs))))
  (3:10:57 elapsed time, 19:12:25 cpu time, factor 6.03)


map ipcidr_tuple_to_wordinterval (mergesort_by_rel (λ (a1,a2) (b1, b2). (a2, a1) ≤ (b2, b1)) (mergesort_remdups
                        (extract_src_dst_ips rs [])))
 (2:49:57 elapsed time, 17:10:49 cpu time, factor 6.06)

map ipcidr_tuple_to_wordinterval ((mergesort_remdups (extract_src_dst_ips rs [])))
 (2:43:44 elapsed time, 16:57:49 cpu time, factor 6.21)

map ipcidr_tuple_to_wordinterval (mergesort_by_rel (λ (a1,a2) (b1, b2). (a2, a1) ≥ (b2, b1)) (mergesort_remdups (extract_src_dst_ips rs [])))
 (2:47:37 elapsed time, 16:54:47 cpu time, factor 6.05)

There is a clear looser: not using mergesort_remdups
There is no clear winner. We will just stick to mergesort_remdups.

*)</span>

<span class="comment1">(*check the the order of mergesort_remdups did not change*)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"mergesort_remdups <span class="main">[</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>ipv4addr<span class="main">,</span> <span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">8</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">8</span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span>
        <span class="main">[</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">4</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">8</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">8</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>


<span class="comment1">(*a tail-recursive implementation*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">extract_src_dst_ips</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span> word <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span> word <span class="main">×</span> nat<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extract_src_dst_ips</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">extract_src_dst_ips</span> <span class="main">(</span><span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="free">extract_src_dst_ips</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span>  <span class="main">(</span>src <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">#</span> dst <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Service_Matrix-extract_src_dst_ips_length"><span class="command">lemma</span></span> extract_src_dst_ips_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>extract_src_dst_ips <span class="free">rs</span> <span class="free">acc</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>length <span class="free">rs</span> <span class="main">+</span> length <span class="free">acc</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">acc</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extract_IPSets</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span> wordinterval<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extract_IPSets</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span> map ipcidr_tuple_to_wordinterval <span class="main">(</span>mergesort_remdups <span class="main">(</span>extract_src_dst_ips <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1" id="Service_Matrix-extract_IPSets"><span class="command">lemma</span></span> extract_IPSets<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>extract_IPSets <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>extract_IPSets_generic0 src <span class="free">rs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>extract_IPSets_generic0 dst <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">acc</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipcidr_tuple_to_wordinterval <span class="main">`</span> set <span class="main">(</span>extract_src_dst_ips <span class="free">rs</span> <span class="skolem">acc</span><span class="main">)</span> <span class="main">=</span>
            ipcidr_tuple_to_wordinterval <span class="main">`</span> set <span class="skolem">acc</span> <span class="main">∪</span> set <span class="main">(</span>extract_IPSets_generic0 src <span class="free">rs</span><span class="main">)</span> <span class="main">∪</span>
            set <span class="main">(</span>extract_IPSets_generic0 dst <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">acc</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span> <span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> extract_IPSets_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_IPSets_def mergesort_remdups_correct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Service_Matrix-merge_length"><span class="command">lemma</span></span> merge_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge <span class="free">l1</span> <span class="free">l2</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">l1</span> <span class="main">+</span> length <span class="free">l2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l1</span></span> <span class="quoted"><span class="free">l2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Service_Matrix-merge_list_length"><span class="command">lemma</span></span> merge_list_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge_list <span class="free">as</span> <span class="free">ls</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>concat <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_list.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">acc2</span> <span class="skolem">ls</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge <span class="skolem">l2</span> <span class="skolem">acc2</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">l2</span> <span class="main">+</span> length <span class="skolem">acc2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> merge_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Service_Matrix-mergesort_remdups_length"><span class="command">lemma</span></span> mergesort_remdups_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>mergesort_remdups <span class="free">as</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">as</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mergesort_remdups_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> merge_list_length <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge_list <span class="main">[]</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Service_Matrix-extract_IPSets_length"><span class="command">lemma</span></span> extract_IPSets_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>extract_IPSets <span class="free">rs</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> length <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_IPSets_def<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> extract_src_dst_ips_length mergesort_remdups_length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> 


<span class="comment1">(*
export_code extract_IPSets in SML
why you no work?
*)</span>


<span class="keyword1" id="Service_Matrix-extract_equi0"><span class="command">lemma</span></span> extract_equi0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>extract_IPSets_generic0 <span class="free">sel</span> <span class="free">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">base</span><span class="main">,</span><span class="bound">len</span><span class="main">)</span><span class="main">.</span> ipset_from_cidr <span class="bound">base</span> <span class="bound">len</span><span class="main">)</span> <span class="main">`</span> <span class="free">sel</span> <span class="main">`</span> match_sel <span class="main">`</span> set <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> wordinterval_to_set_ipcidr_tuple_to_wordinterval <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Service_Matrix-src_ipPart_motivation"><span class="command">lemma</span></span> src_ipPart_motivation<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">rs</span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">base</span><span class="main">,</span><span class="bound">len</span><span class="main">)</span><span class="main">.</span> ipset_from_cidr <span class="bound">base</span> <span class="bound">len</span><span class="main">)</span> <span class="main">`</span> src <span class="main">`</span> match_sel <span class="main">`</span> set <span class="free">rs</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">B</span> <span class="main">⊆</span> <span class="bound">A</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_src<span class="main">:=</span><span class="free">s1</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_src<span class="main">:=</span><span class="free">s2</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">base</span><span class="main">,</span><span class="bound">len</span><span class="main">)</span><span class="main">.</span> ipset_from_cidr <span class="bound">base</span> <span class="bound">len</span><span class="main">)</span> <span class="main">`</span> src <span class="main">`</span> match_sel <span class="main">`</span> set <span class="free">rs</span><span class="main">.</span> <span class="free">B</span> <span class="main">⊆</span> <span class="bound">A</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s1</span> <span class="main">∈</span> <span class="free">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s2</span> <span class="main">∈</span> <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">case</span> src <span class="skolem">m</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">⇒</span> ipset_from_cidr <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∩</span> <span class="main">(</span><span class="keyword1">case</span> src <span class="skolem">m</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">)</span> 
                      <span class="main">⇒</span> ipset_from_cidr <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
             simple_matches <span class="skolem">m</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_src <span class="main">:=</span> <span class="free">s1</span><span class="main">⦈</span><span class="main">)</span> <span class="main">⟷</span> simple_matches <span class="skolem">m</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_src <span class="main">:=</span> <span class="free">s2</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> iiface oiface srca dst proto sports dports<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">srca</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_matches.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> helper<span class="main">=</span>this
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> m a<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> helper <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

    
<span class="keyword1" id="Service_Matrix-src_ipPart"><span class="command">lemma</span></span> src_ipPart<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>extract_IPSets_generic0 src <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_src<span class="main">:=</span><span class="free">s1</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_src<span class="main">:=</span><span class="free">s2</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> src_ipPart_motivation<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">base</span><span class="main">,</span><span class="bound">len</span><span class="main">)</span><span class="main">.</span> ipset_from_cidr <span class="bound">base</span> <span class="bound">len</span><span class="main">)</span> <span class="main">`</span> src <span class="main">`</span> match_sel <span class="main">`</span> set <span class="free">rs</span><span class="main">.</span> <span class="free">B</span> <span class="main">⊆</span> <span class="bound">A</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
      simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_src<span class="main">:=</span><span class="free">s1</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_src<span class="main">:=</span><span class="free">s2</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ipPartition_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Int_commute extract_equi0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="comment1">(*basically a copy of src_ipPart*)</span>
<span class="keyword1" id="Service_Matrix-dst_ipPart"><span class="command">lemma</span></span> dst_ipPart<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>extract_IPSets_generic0 dst <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_dst<span class="main">:=</span><span class="free">s1</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_dst<span class="main">:=</span><span class="free">s2</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">base</span><span class="main">,</span><span class="bound">len</span><span class="main">)</span><span class="main">.</span> ipset_from_cidr <span class="bound">base</span> <span class="bound">len</span><span class="main">)</span> <span class="main">`</span> dst <span class="main">`</span> match_sel <span class="main">`</span> set <span class="free">rs</span><span class="main">.</span> <span class="free">B</span> <span class="main">⊆</span> <span class="bound">A</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
      simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_dst<span class="main">:=</span><span class="free">s1</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_dst<span class="main">:=</span><span class="free">s2</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s1</span> <span class="main">∈</span> <span class="free">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s2</span> <span class="main">∈</span> <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">case</span> dst <span class="skolem">m</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">⇒</span> ipset_from_cidr <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∩</span> <span class="main">(</span><span class="keyword1">case</span> dst <span class="skolem">m</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">)</span> 
                  <span class="main">⇒</span> ipset_from_cidr <span class="bound">x</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
         simple_matches <span class="skolem">m</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_dst <span class="main">:=</span> <span class="free">s1</span><span class="main">⦈</span><span class="main">)</span> <span class="main">⟷</span> simple_matches <span class="skolem">m</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_dst <span class="main">:=</span> <span class="free">s2</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> iiface oiface src dsta proto sports dports<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">dsta</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_matches.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> helper<span class="main">=</span>this
    <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> m a<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> helper <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ipPartition_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Int_commute extract_equi0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="comment1">(* OPTIMIZED PARTITIONING *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wordinterval_list_to_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len wordinterval list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wordinterval_list_to_set</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Service_Matrix-wordinterval_list_to_set_compressed"><span class="command">lemma</span></span> wordinterval_list_to_set_compressed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wordinterval_to_set <span class="main">(</span>wordinterval_compress <span class="main">(</span>foldr wordinterval_union <span class="free">xs</span> Empty_WordInterval<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          wordinterval_list_to_set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wordinterval_compress wordinterval_list_to_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">partIps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len wordinterval <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len wordinterval list 
                <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len wordinterval list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partIps</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">partIps</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> wordinterval_empty <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
                        <span class="main">(</span><span class="keyword1">if</span> wordinterval_empty <span class="main">(</span>wordinterval_intersection <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
                          <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">partIps</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>
                          <span class="keyword1">else</span>
                            <span class="main">(</span><span class="keyword1">if</span> wordinterval_empty <span class="main">(</span>wordinterval_setminus <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
                              <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">partIps</span> <span class="main">(</span>wordinterval_setminus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>
                              <span class="keyword1">else</span> <span class="main">(</span>wordinterval_intersection <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="main">(</span>wordinterval_setminus <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">#</span>
                                   <span class="main">(</span><span class="free">partIps</span> <span class="main">(</span>wordinterval_setminus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"partIps <span class="main">(</span>WordInterval <span class="main">(</span><span class="main">1</span><span class="main">::</span>ipv4addr<span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span>WordInterval <span class="main">0</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span>WordInterval <span class="main">1</span> <span class="main">1</span><span class="main">,</span> WordInterval <span class="main">0</span> <span class="main">0</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1" id="Service_Matrix-partIps_length"><span class="command">lemma</span></span> partIps_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>partIps <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>length <span class="free">ts</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> le_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">partitioningIps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len wordinterval list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len wordinterval list <span class="main">⇒</span>
                        <span class="tfree">'a</span><span class="main">::</span>len wordinterval list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partitioningIps</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">partitioningIps</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> partIps <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">partitioningIps</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Service_Matrix-partitioningIps_length"><span class="command">lemma</span></span> partitioningIps_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>partitioningIps <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span>length <span class="free">ss</span><span class="main">)</span> <span class="main">*</span> length <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>partIps <span class="skolem">s</span> <span class="main">(</span>partitioningIps <span class="skolem">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>partitioningIps <span class="skolem">ss</span> <span class="free">ts</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> partIps_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span>  <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Service_Matrix-partIps_equi"><span class="command">lemma</span></span> partIps_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"map wordinterval_to_set <span class="main">(</span>partIps <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> 
    partList4 <span class="main">(</span>wordinterval_to_set <span class="free">s</span><span class="main">)</span> <span class="main">(</span>map wordinterval_to_set <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Service_Matrix-partitioningIps_equi"><span class="command">lemma</span></span> partitioningIps_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"map wordinterval_to_set <span class="main">(</span>partitioningIps <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span>
       <span class="main">=</span> <span class="main">(</span>partitioning1 <span class="main">(</span>map wordinterval_to_set <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>map wordinterval_to_set <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partIps_equi<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

           
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">getParts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="tfree">'i</span> wordinterval list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">getParts</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> partitioningIps <span class="main">(</span>extract_IPSets <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">[</span>wordinterval_UNIV<span class="main">]</span>"</span></span>

<span class="keyword1" id="Service_Matrix-partitioningIps_foldr"><span class="command">lemma</span></span> partitioningIps_foldr<span class="main">:</span> <span class="quoted"><span class="quoted">"partitioningIps <span class="free">ss</span> <span class="free">ts</span> <span class="main">=</span> foldr partIps <span class="free">ss</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Service_Matrix-getParts_foldr"><span class="command">lemma</span></span> getParts_foldr<span class="main">:</span> <span class="quoted"><span class="quoted">"getParts <span class="free">rs</span> <span class="main">=</span> foldr partIps <span class="main">(</span>extract_IPSets <span class="free">rs</span><span class="main">)</span> <span class="main">[</span>wordinterval_UNIV<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> getParts_def partitioningIps_foldr<span class="main">)</span>

<span class="keyword1" id="Service_Matrix-getParts_length"><span class="command">lemma</span></span> getParts_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> length <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> partitioningIps_length<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ss<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extract_IPSets <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ts<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>wordinterval_UNIV<span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>partitioningIps <span class="main">(</span>extract_IPSets <span class="free">rs</span><span class="main">)</span> <span class="main">[</span>wordinterval_UNIV<span class="main">]</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> length <span class="main">(</span>extract_IPSets <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> extract_IPSets_length <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> length <span class="main">(</span>extract_IPSets <span class="free">rs</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> length <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>partitioningIps <span class="main">(</span>extract_IPSets <span class="free">rs</span><span class="main">)</span> <span class="main">[</span>wordinterval_UNIV<span class="main">]</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> length <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> getParts_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Service_Matrix-getParts_ipPartition"><span class="command">lemma</span></span> getParts_ipPartition<span class="main">:</span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>extract_IPSets <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                         <span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> hlp_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>map wordinterval_to_set <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span> disjoint_list <span class="main">(</span>map wordinterval_to_set <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span> 
     <span class="main">(</span>wordinterval_list_to_set <span class="skolem">ss</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>wordinterval_list_to_set <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span> 
     ipPartition <span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> 
                 <span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>partitioningIps <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ts</span> <span class="skolem">ss</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wordinterval list"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ipPartitioning_helper_opt partitioningIps_equi wordinterval_list_to_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_list <span class="main">[</span>UNIV<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_list_def disjoint_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> 
                   <span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>partitioningIps <span class="skolem">ss</span> <span class="main">[</span>wordinterval_UNIV<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ss</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wordinterval list"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hlp_rule<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wordinterval_list_to_set_def <span class="quoted"><span class="quoted">‹disjoint_list <span class="main">[</span>UNIV<span class="main">]</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> getParts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Service_Matrix-getParts_complete"><span class="command">lemma</span></span> getParts_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"wordinterval_list_to_set <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>map wordinterval_to_set <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">(</span>wordinterval_list_to_set <span class="skolem">ss</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>wordinterval_list_to_set <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span> 
     wordinterval_list_to_set <span class="main">(</span>partitioningIps <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>wordinterval_list_to_set <span class="skolem">ts</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wordinterval list"</span></span>
    <span class="keyword1"><span class="command">using</span></span> complete_helper <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> partitioningIps_equi wordinterval_list_to_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wordinterval_list_to_set <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> wordinterval_list_to_set <span class="main">[</span>wordinterval_UNIV<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> getParts_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wordinterval_list_to_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wordinterval_list_to_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> getParts_samefw<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_src<span class="main">:=</span><span class="free">s1</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_src<span class="main">:=</span><span class="free">s2</span><span class="main">⦈</span><span class="main">)</span> <span class="main">∧</span>
         simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_dst<span class="main">:=</span><span class="free">s1</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span>p_dst<span class="main">:=</span><span class="free">s2</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> getParts_ipPartition <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>extract_IPSets <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipPartition <span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>extract_IPSets_generic0 src <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?X</span> <span class="main">∧</span>
         ipPartition <span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>extract_IPSets_generic0 dst <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_IPSets ipPartitionUnion image_Un<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms dst_ipPart src_ipPart <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Service_Matrix-partIps_nonempty"><span class="command">lemma</span></span> partIps_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> partIps <span class="free">s</span> <span class="free">ts</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1" id="Service_Matrix-partitioningIps_nonempty"><span class="command">lemma</span></span> partitioningIps_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> partitioningIps <span class="free">ss</span> <span class="free">ts</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> partIps_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
lemma partIps_nonempty: "∀t ∈ set ts. ¬ wordinterval_empty t 
       ⟹ {} ∉ set (map wordinterval_to_set (partIps s ts))"
  apply(induction ts arbitrary: s)
   apply(simp; fail)
  apply(simp)
  by blast
*)</span>

<span class="keyword1" id="Service_Matrix-getParts_nonempty"><span class="command">lemma</span></span> getParts_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"getParts <span class="free">rs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> getParts_def partitioningIps_nonempty<span class="main">)</span>
<span class="keyword1" id="Service_Matrix-getParts_nonempty_elems"><span class="command">lemma</span></span> getParts_nonempty_elems<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">∈</span>set <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> wordinterval_empty <span class="bound">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> getParts_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> partitioning_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="skolem">ts</span><span class="main">.</span> <span class="main">¬</span> wordinterval_empty <span class="bound">t</span> <span class="main">⟹</span>
      <span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>partitioningIps <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ts</span> <span class="skolem">ss</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wordinterval list"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partIps_equi partList4_empty<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="main">[</span>wordinterval_UNIV<span class="main">]</span><span class="main">.</span><span class="main">¬</span> wordinterval_empty <span class="bound">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> partitioning_nonempty <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>partitioningIps <span class="main">(</span>extract_IPSets <span class="free">rs</span><span class="main">)</span> <span class="main">[</span>wordinterval_UNIV<span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">∈</span>set <span class="main">(</span>partitioningIps <span class="main">(</span>extract_IPSets <span class="free">rs</span><span class="main">)</span> <span class="main">[</span>wordinterval_UNIV<span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> wordinterval_empty <span class="bound">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* HELPER FUNCTIONS UNIFICATION *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">getOneIp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len wordinterval <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">getOneIp</span> <span class="main">(</span>WordInterval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">getOneIp</span> <span class="main">(</span>RangeUnion <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> wordinterval_empty <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="keyword1">then</span> <span class="free">getOneIp</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span>
                                                           <span class="keyword1">else</span> <span class="free">getOneIp</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Service_Matrix-getOneIp_elem"><span class="command">lemma</span></span> getOneIp_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wordinterval_empty <span class="free">W</span> <span class="main">⟹</span> wordinterval_element <span class="main">(</span>getOneIp <span class="free">W</span><span class="main">)</span> <span class="free">W</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">W</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">record</span></span> parts_connection <span class="main">=</span> pc_iiface <span class="main">::</span> <span class="quoted">string</span>
                          pc_oiface <span class="main">::</span> <span class="quoted">string</span>
                          pc_proto <span class="main">::</span> <span class="quoted">primitive_protocol</span>
                          pc_sport <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">16</span> word"</span></span>
                          pc_dport <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">16</span> word"</span></span>



<span class="comment1">(* SAME FW DEFINITIONS AND PROOFS *)</span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">same_fw_behaviour</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="comment1">⌦‹'pkt_ext itself ⇒›</span> <span class="tfree">'i</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'i</span> word <span class="main">⇒</span> <span class="tfree">'i</span> simple_rule list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">same_fw_behaviour</span> <span class="comment1">⌦‹TYPE('pkt_ext)›</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span>
      <span class="main">∀</span><span class="main">(</span><span class="bound">p</span><span class="main">::</span> <span class="tfree">'i</span><span class="main">::</span>len simple_packet<span class="main">)</span><span class="main">.</span>
                simple_fw <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span><span class="bound">p</span><span class="main">⦇</span>p_src<span class="main">:=</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> simple_fw <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span><span class="bound">p</span><span class="main">⦇</span>p_src<span class="main">:=</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⦈</span><span class="main">)</span> <span class="main">∧</span>
                simple_fw <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span><span class="bound">p</span><span class="main">⦇</span>p_dst<span class="main">:=</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> simple_fw <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span><span class="bound">p</span><span class="main">⦇</span>p_dst<span class="main">:=</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Service_Matrix-getParts_same_fw_behaviour"><span class="command">lemma</span></span> getParts_same_fw_behaviour<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>  <span class="free">s1</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">s2</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> 
   same_fw_behaviour <span class="free">s1</span> <span class="free">s2</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> same_fw_behaviour_def
  <span class="keyword1"><span class="command">using</span></span> getParts_samefw <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">runFw</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> simple_fw <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⦇</span>p_iiface<span class="main">=</span>pc_iiface <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>p_oiface<span class="main">=</span>pc_oiface <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>
                          p_src<span class="main">=</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>p_dst<span class="main">=</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span>
                          p_proto<span class="main">=</span>pc_proto <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>
                          p_sport<span class="main">=</span>pc_sport <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>p_dport<span class="main">=</span>pc_dport <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>
                          p_tcp_flags<span class="main">=</span><span class="main">{</span>TCP_SYN<span class="main">}</span><span class="main">,</span>
                          p_payload<span class="main">=</span><span class="inner_quoted">''''</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> runFw<span class="antiquote"><span class="antiquote">}</span></span></span></span> for executable code, but in general, everything applies to generic packets›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">runFw_scheme</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'i</span> word <span class="main">⇒</span> <span class="tfree">'b</span> parts_connection_scheme <span class="main">⇒</span>
                              <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> simple_packet_scheme <span class="main">⇒</span> <span class="tfree">'i</span> simple_rule list <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">runFw_scheme</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> simple_fw <span class="free"><span class="bound"><span class="entity">rs</span></span></span>
                        <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⦇</span>p_iiface<span class="main">:=</span>pc_iiface <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>
                          p_oiface<span class="main">:=</span>pc_oiface <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>
                          p_src<span class="main">:=</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>
                          p_dst<span class="main">:=</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span>
                          p_proto<span class="main">:=</span>pc_proto <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>
                          p_sport<span class="main">:=</span>pc_sport <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>
                          p_dport<span class="main">:=</span>pc_dport <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Service_Matrix-runFw_scheme"><span class="command">lemma</span></span> runFw_scheme<span class="main">:</span> <span class="quoted"><span class="quoted">"runFw <span class="free">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw_scheme <span class="free">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">p</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> runFw_def runFw_scheme_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="main">_</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> SimpleRule <span class="skolem">m</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> simple_matches_extended_packet<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"pc_iiface <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"pc_oiface <span class="free">c</span>"</span></span>
                                      <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="quoted">"pc_proto <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"pc_sport <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"pc_dport <span class="free">c</span>"</span></span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>TCP_SYN<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> pext<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_matches <span class="skolem">m</span>
   <span class="main">⦇</span>p_iiface <span class="main">=</span> pc_iiface <span class="free">c</span><span class="main">,</span> p_oiface <span class="main">=</span> pc_oiface <span class="free">c</span><span class="main">,</span> p_src <span class="main">=</span> <span class="free">s</span><span class="main">,</span> p_dst <span class="main">=</span> <span class="free">d</span><span class="main">,</span> p_proto <span class="main">=</span> pc_proto <span class="free">c</span><span class="main">,</span> p_sport <span class="main">=</span> pc_sport <span class="free">c</span><span class="main">,</span> p_dport <span class="main">=</span> pc_dport <span class="free">c</span><span class="main">,</span>
      p_tcp_flags <span class="main">=</span> <span class="skolem">tcp_flags2</span><span class="main">,</span> p_payload <span class="main">=</span> <span class="skolem">payload2</span><span class="main">,</span> <span class="main">…</span> <span class="main">=</span> <span class="skolem">aux</span><span class="main">⦈</span> <span class="main">=</span>
  simple_matches <span class="skolem">m</span>
   <span class="main">⦇</span>p_iiface <span class="main">=</span> pc_iiface <span class="free">c</span><span class="main">,</span> p_oiface <span class="main">=</span> pc_oiface <span class="free">c</span><span class="main">,</span> p_src <span class="main">=</span> <span class="free">s</span><span class="main">,</span> p_dst <span class="main">=</span> <span class="free">d</span><span class="main">,</span> p_proto <span class="main">=</span> pc_proto <span class="free">c</span><span class="main">,</span> p_sport <span class="main">=</span> pc_sport <span class="free">c</span><span class="main">,</span> p_dport <span class="main">=</span> pc_dport <span class="free">c</span><span class="main">,</span>
      p_tcp_flags <span class="main">=</span> <span class="main">{</span>TCP_SYN<span class="main">}</span><span class="main">,</span> p_payload <span class="main">=</span> <span class="main">[]</span><span class="main">⦈</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">tcp_flags2</span> <span class="skolem">payload2</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">aux</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Cons.IH <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> 


<span class="keyword1" id="Service_Matrix-has_default_policy_runFw"><span class="command">lemma</span></span> has_default_policy_runFw<span class="main">:</span> <span class="quoted"><span class="quoted">"has_default_policy <span class="free">rs</span> <span class="main">⟹</span> runFw <span class="free">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalAllow <span class="main">∨</span> runFw <span class="free">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalDeny"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> runFw_def has_default_policy<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">same_fw_behaviour_one</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'i</span> word <span class="main">⇒</span> <span class="tfree">'a</span> parts_connection_scheme <span class="main">⇒</span> <span class="tfree">'i</span> simple_rule list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">same_fw_behaviour_one</span> <span class="free"><span class="bound"><span class="entity">ip1</span></span></span> <span class="free"><span class="bound"><span class="entity">ip2</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span>
            <span class="main">∀</span><span class="bound">d</span> <span class="bound">s</span><span class="main">.</span> runFw <span class="free"><span class="bound"><span class="entity">ip1</span></span></span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> runFw <span class="free"><span class="bound"><span class="entity">ip2</span></span></span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">∧</span> runFw <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">ip1</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> runFw <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">ip2</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>"</span></span>

<span class="keyword1" id="Service_Matrix-same_fw_spec"><span class="command">lemma</span></span> same_fw_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"same_fw_behaviour <span class="free">ip1</span> <span class="free">ip2</span> <span class="free">rs</span> <span class="main">⟹</span> same_fw_behaviour_one <span class="free">ip1</span> <span class="free">ip2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> same_fw_behaviour_def same_fw_behaviour_one_def runFw_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⦇</span>p_iiface <span class="main">=</span> pc_iiface <span class="free">c</span><span class="main">,</span> p_oiface <span class="main">=</span> pc_oiface <span class="free">c</span><span class="main">,</span> p_src <span class="main">=</span> <span class="free">ip1</span><span class="main">,</span> p_dst<span class="main">=</span> <span class="improper">d</span><span class="main">,</span>
                       p_proto <span class="main">=</span> pc_proto <span class="free">c</span><span class="main">,</span> p_sport <span class="main">=</span> pc_sport <span class="free">c</span><span class="main">,</span> p_dport <span class="main">=</span> pc_dport <span class="free">c</span><span class="main">,</span>
                       p_tcp_flags <span class="main">=</span> <span class="main">{</span>TCP_SYN<span class="main">}</span><span class="main">,</span>
                       p_payload<span class="main">=</span><span class="inner_quoted">''''</span><span class="main">⦈</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⦇</span>p_iiface <span class="main">=</span> pc_iiface <span class="free">c</span><span class="main">,</span> p_oiface <span class="main">=</span> pc_oiface <span class="free">c</span><span class="main">,</span> p_src <span class="main">=</span> <span class="improper">s</span><span class="main">,</span> p_dst<span class="main">=</span> <span class="free">ip1</span><span class="main">,</span>
                       p_proto <span class="main">=</span> pc_proto <span class="free">c</span><span class="main">,</span> p_sport <span class="main">=</span> pc_sport <span class="free">c</span><span class="main">,</span> p_dport <span class="main">=</span> pc_dport <span class="free">c</span><span class="main">,</span>
                       p_tcp_flags <span class="main">=</span> <span class="main">{</span>TCP_SYN<span class="main">}</span><span class="main">,</span>
                       p_payload<span class="main">=</span><span class="inner_quoted">''''</span><span class="main">⦈</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Is an equivalence relation›</span></span>
<span class="keyword1" id="Service_Matrix-same_fw_behaviour_one_equi"><span class="command">lemma</span></span> same_fw_behaviour_one_equi<span class="main">:</span>
  <span class="quoted"><span class="quoted">"same_fw_behaviour_one <span class="free">x</span> <span class="free">x</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
  <span class="quoted"><span class="quoted">"same_fw_behaviour_one <span class="free">x</span> <span class="free">y</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> same_fw_behaviour_one <span class="free">y</span> <span class="free">x</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
  <span class="quoted"><span class="quoted">"same_fw_behaviour_one <span class="free">x</span> <span class="free">y</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">∧</span> same_fw_behaviour_one <span class="free">y</span> <span class="free">z</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">⟹</span> same_fw_behaviour_one <span class="free">x</span> <span class="free">z</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> same_fw_behaviour_one_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Service_Matrix-same_fw_behaviour_equi"><span class="command">lemma</span></span> same_fw_behaviour_equi<span class="main">:</span>
  <span class="quoted"><span class="quoted">"same_fw_behaviour <span class="free">x</span> <span class="free">x</span> <span class="free">rs</span>"</span></span>
  <span class="quoted"><span class="quoted">"same_fw_behaviour <span class="free">x</span> <span class="free">y</span> <span class="free">rs</span> <span class="main">=</span> same_fw_behaviour <span class="free">y</span> <span class="free">x</span> <span class="free">rs</span>"</span></span>
  <span class="quoted"><span class="quoted">"same_fw_behaviour <span class="free">x</span> <span class="free">y</span> <span class="free">rs</span> <span class="main">∧</span> same_fw_behaviour <span class="free">y</span> <span class="free">z</span> <span class="free">rs</span> <span class="main">⟹</span> same_fw_behaviour <span class="free">x</span> <span class="free">z</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> same_fw_behaviour_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Service_Matrix-runFw_sameFw_behave"><span class="command">lemma</span></span> runFw_sameFw_behave<span class="main">:</span> 
       <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">W</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len word set set"</span></span>
       <span class="keyword2"><span class="keyword">shows</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="free">W</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a1</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">⋃</span> <span class="free">W</span> <span class="main">=</span> UNIV <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">W</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> <span class="bound">B</span><span class="main">.</span> runFw <span class="free">ip1</span> <span class="bound">b</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="free">ip2</span> <span class="bound">b</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">W</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> <span class="bound">B</span><span class="main">.</span> runFw <span class="bound">b</span> <span class="free">ip1</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="bound">b</span> <span class="free">ip2</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">⟹</span>
       same_fw_behaviour_one <span class="free">ip1</span> <span class="free">ip2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="free">W</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a1</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="free">W</span> <span class="main">=</span> UNIV "</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">W</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> <span class="bound">B</span><span class="main">.</span> runFw <span class="free">ip1</span> <span class="bound">b</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="free">ip2</span> <span class="bound">b</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">W</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> <span class="bound">B</span><span class="main">.</span> runFw <span class="bound">b</span> <span class="free">ip1</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="bound">b</span> <span class="free">ip2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>

   
  <span class="keyword1"><span class="command">have</span></span> relation_lem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span> <span class="main">∈</span> <span class="skolem">W</span><span class="main">.</span> <span class="main">∀</span><span class="bound">d1</span> <span class="main">∈</span> <span class="bound">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">d2</span> <span class="main">∈</span> <span class="bound">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">s</span> <span class="bound">d1</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">s</span> <span class="bound">d2</span> <span class="main">⟹</span> <span class="main">⋃</span> <span class="skolem">W</span> <span class="main">=</span> UNIV <span class="main">⟹</span>
                     <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="skolem">W</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">s1</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">s2</span> <span class="bound">b</span> <span class="main">⟹</span>
                     <span class="skolem">f</span> <span class="skolem">s1</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">s2</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">W</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s1</span> <span class="skolem">d</span> <span class="skolem">s2</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I Union_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> a1 <span class="keyword1"><span class="command">have</span></span> a1'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">W</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a1</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="bound">a1</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="bound">s</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> same_fw_behaviour_one_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> relation_lem<span class="main">[</span><span class="operator">OF</span> a1' a2 a3<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">d</span><span class="main">.</span> runFw <span class="free">ip1</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="free">ip2</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> a1 <span class="keyword1"><span class="command">have</span></span> a1''<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">W</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a1</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">.</span> runFw <span class="bound">a1</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="bound">a2</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> same_fw_behaviour_one_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> relation_lem<span class="main">[</span><span class="operator">OF</span> a1'' a2 a4<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="free">ip1</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="bound">s</span> <span class="free">ip2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> s1 s2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"same_fw_behaviour_one <span class="free">ip1</span> <span class="free">ip2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> same_fw_behaviour_one_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Service_Matrix-sameFw_behave_sets"><span class="command">lemma</span></span> sameFw_behave_sets<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a1</span> <span class="main">∈</span> <span class="bound">w</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span> <span class="main">∈</span> <span class="bound">w</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">w1</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w2</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a1</span><span class="main">∈</span><span class="bound">w1</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a2</span><span class="main">∈</span><span class="bound">w2</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">w1</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w2</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span>
     <span class="main">∀</span><span class="bound">a1</span><span class="main">∈</span><span class="bound">w1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span><span class="main">∈</span><span class="bound">w2</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a1</span> <span class="main">∈</span> <span class="bound">w</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span> <span class="main">∈</span> <span class="bound">w</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w1</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w2</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a1</span><span class="main">∈</span><span class="bound">w1</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a2</span><span class="main">∈</span><span class="bound">w2</span><span class="main">.</span>  same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w1</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w2</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a1</span><span class="main">∈</span><span class="bound">w1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span><span class="main">∈</span><span class="bound">w2</span><span class="main">.</span>  same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> same_fw_behaviour_one_equi<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> a1 this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w1</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w2</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a1</span><span class="main">∈</span><span class="bound">w1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span><span class="main">∈</span><span class="bound">w2</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> same_fw_behaviour_one_equi<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>
  



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">groupWIs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"parts_connection <span class="main">⇒</span> <span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="tfree">'i</span> wordinterval list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">groupWIs</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">W</span> <span class="main">=</span> getParts <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="keyword1">in</span> 
                       <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">wi</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="bound">W</span><span class="main">)</span><span class="main">,</span>
                                      map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="bound">W</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
                       groupF <span class="bound">f</span> <span class="bound">W</span><span class="main">)</span><span class="main">)</span>"</span></span>



<span class="keyword1" id="Service_Matrix-groupWIs_not_empty"><span class="command">lemma</span></span> groupWIs_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"groupWIs <span class="free">c</span> <span class="free">rs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"getParts <span class="free">rs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> getParts_def partitioningIps_nonempty<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> groupF_empty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> groupF <span class="bound">f</span> <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groupWIs_def Let_def<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Service_Matrix-groupWIs_not_empty_elem"><span class="command">lemma</span></span> groupWIs_not_empty_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">V</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groupWIs_def Let_def groupF_empty_elem<span class="main">)</span>
<span class="keyword1" id="Service_Matrix-groupWIs_not_empty_elems"><span class="command">lemma</span></span> groupWIs_not_empty_elems<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> set <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wordinterval_empty <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">∈</span>set <span class="main">(</span>concat <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> wordinterval_empty <span class="bound">w</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> groupWIs_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> groupF_concat_set<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> getParts_nonempty_elems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> this V w <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Service_Matrix-groupParts_same_fw_wi0"><span class="command">lemma</span></span> groupParts_same_fw_wi0<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="free">V</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a1</span> <span class="main">∈</span> <span class="bound">w</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span> <span class="main">∈</span> <span class="bound">w</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>concat <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
        <span class="main">∀</span><span class="bound">a1</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> groupWIs_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> set_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> groupF_concat_set<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> getParts_same_fw_behaviour same_fw_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Service_Matrix-groupWIs_same_fw_not"><span class="command">lemma</span></span> groupWIs_same_fw_not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> 
                            <span class="free">A</span> <span class="main">≠</span> <span class="free">B</span> <span class="main">⟹</span>
                             <span class="main">∀</span><span class="bound">aw</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="free">A</span><span class="main">)</span><span class="main">.</span>
                             <span class="main">∀</span><span class="bound">bw</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="free">B</span><span class="main">)</span><span class="main">.</span>
                             <span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="bound">aw</span><span class="main">.</span> <span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> <span class="bound">bw</span><span class="main">.</span> <span class="main">¬</span> same_fw_behaviour_one <span class="bound">a</span> <span class="bound">b</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">aw</span> <span class="main">∈</span> set <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">bw</span> <span class="main">∈</span> set <span class="free">B</span><span class="main">.</span>
                  <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="main">(</span>getOneIp <span class="bound">aw</span><span class="main">)</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                   map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="main">(</span>getOneIp <span class="bound">aw</span><span class="main">)</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span>
                  <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="main">(</span>getOneIp <span class="bound">bw</span><span class="main">)</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                   map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="main">(</span>getOneIp <span class="bound">bw</span><span class="main">)</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groupWIs_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> groupF_nequality <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> same_behave_runFw_not<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="skolem">x1</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="skolem">W</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="skolem">x1</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="skolem">W</span><span class="main">)</span> <span class="main">≠</span>
         <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="skolem">x2</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="skolem">W</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="skolem">x2</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="skolem">W</span><span class="main">)</span> <span class="main">⟹</span>
         <span class="main">¬</span> same_fw_behaviour_one <span class="skolem">x1</span> <span class="skolem">x2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x1</span> <span class="skolem">x2</span> <span class="skolem">W</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> same_fw_behaviour_one_def<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">c</span> <span class="main">∈</span> set <span class="bound">C</span><span class="main">.</span> getOneIp <span class="bound">c</span> <span class="main">∈</span> wordinterval_to_set <span class="bound">c</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groupWIs_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> getParts_nonempty_elems groupF_set getOneIp_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> this b1 asm <span class="keyword1"><span class="command">have</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">aw</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">bw</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="free">B</span><span class="main">)</span><span class="main">.</span>
   <span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> <span class="bound">aw</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> <span class="bound">bw</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="bound">a</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="bound">a</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="bound">b</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="bound">b</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this same_behave_runFw_not asm
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">aw</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">bw</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="free">B</span><span class="main">)</span><span class="main">.</span>
         <span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> <span class="bound">aw</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> <span class="bound">bw</span><span class="main">.</span> <span class="main">¬</span> same_fw_behaviour_one <span class="bound">a</span> <span class="bound">b</span> <span class="free">c</span> <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> this groupParts_same_fw_wi0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">rs</span></span><span class="main">]</span>  groupParts_same_fw_wi0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">rs</span></span><span class="main">]</span> asm
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">aw</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="free">A</span><span class="main">)</span><span class="main">.</span>
        <span class="main">∀</span><span class="bound">bw</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="free">B</span><span class="main">)</span><span class="main">.</span>
        <span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="bound">aw</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> <span class="bound">bw</span><span class="main">.</span> <span class="main">¬</span> same_fw_behaviour_one <span class="bound">a</span> <span class="bound">b</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> same_fw_behaviour_one_equi<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this groupParts_same_fw_wi0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">rs</span></span><span class="main">]</span>  groupParts_same_fw_wi0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">rs</span></span><span class="main">]</span> asm
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">aw</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="free">A</span><span class="main">)</span><span class="main">.</span>
        <span class="main">∀</span><span class="bound">bw</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="free">B</span><span class="main">)</span><span class="main">.</span>
        <span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="bound">aw</span><span class="main">.</span> <span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> <span class="bound">bw</span><span class="main">.</span> <span class="main">¬</span> same_fw_behaviour_one <span class="bound">a</span> <span class="bound">b</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> same_fw_behaviour_one_equi<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>





<span class="comment1">(*beginning is copy&amp;paste of previous proof*)</span>
<span class="keyword1" id="Service_Matrix-groupParts_same_fw_wi1"><span class="command">lemma</span></span> groupParts_same_fw_wi1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">w1</span> <span class="main">∈</span> set <span class="free">V</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w2</span> <span class="main">∈</span> set <span class="free">V</span><span class="main">.</span>
     <span class="main">∀</span><span class="bound">a1</span> <span class="main">∈</span> wordinterval_to_set <span class="bound">w1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span> <span class="main">∈</span> wordinterval_to_set <span class="bound">w2</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> getParts_same_fw_behaviour same_fw_spec
    <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="main">∀</span><span class="bound">a1</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span>
              same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> getParts_complete <span class="keyword1"><span class="command">have</span></span> complete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wordinterval_list_to_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> getParts_nonempty_elems <span class="keyword1"><span class="command">have</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">∈</span>set <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> wordinterval_empty <span class="bound">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">W</span> <span class="skolem">x1</span> <span class="skolem">x2</span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="skolem">W</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a1</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"wordinterval_list_to_set <span class="skolem">W</span> <span class="main">=</span> UNIV"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> set <span class="skolem">W</span><span class="main">.</span> <span class="main">¬</span> wordinterval_empty <span class="bound">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="skolem">x1</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="skolem">W</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="skolem">x1</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="skolem">W</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="skolem">x2</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="skolem">W</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="skolem">x2</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="skolem">W</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> a3 a4 getOneIp_elem
        <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="skolem">W</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> <span class="bound">B</span><span class="main">.</span> runFw <span class="skolem">x1</span> <span class="bound">b</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="skolem">x2</span> <span class="bound">b</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> a3 a4 getOneIp_elem
        <span class="keyword1"><span class="command">have</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> set <span class="main">(</span>map wordinterval_to_set <span class="skolem">W</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> <span class="bound">B</span><span class="main">.</span> runFw <span class="bound">b</span> <span class="skolem">x1</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="bound">b</span> <span class="skolem">x2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> runFw_sameFw_behave<span class="main">[</span><span class="operator">OF</span> a1 _ b1 b2<span class="main">]</span> a2<span class="main">[</span><span class="operator">unfolded</span> wordinterval_list_to_set_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"same_fw_behaviour_one <span class="skolem">x1</span> <span class="skolem">x2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> same_behave_runFw<span class="main">=</span>this

  <span class="keyword1"><span class="command">from</span></span> same_behave_runFw<span class="main">[</span><span class="operator">OF</span> b1 getParts_complete nonempty<span class="main">]</span>
       groupF_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">wi</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                             map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                     <span class="quoted"><span class="quoted">"<span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span>"</span></span><span class="main">]</span> asm
  <span class="keyword1"><span class="command">have</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a1</span><span class="main">∈</span>set <span class="free">V</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span><span class="main">∈</span>set <span class="free">V</span><span class="main">.</span> same_fw_behaviour_one <span class="main">(</span>getOneIp <span class="bound">a1</span><span class="main">)</span> <span class="main">(</span>getOneIp <span class="bound">a2</span><span class="main">)</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> groupWIs_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> groupWIs_not_empty_elems asm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> set <span class="free">V</span><span class="main">.</span> <span class="main">¬</span> wordinterval_empty <span class="bound">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this b2 getOneIp_elem
    <span class="keyword1"><span class="command">have</span></span> b3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w1</span><span class="main">∈</span>set <span class="main">(</span>map wordinterval_to_set <span class="free">V</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w2</span><span class="main">∈</span>set <span class="main">(</span>map wordinterval_to_set <span class="free">V</span><span class="main">)</span><span class="main">.</span> 
           <span class="main">∃</span><span class="bound">ip1</span><span class="main">∈</span> <span class="bound">w1</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ip2</span><span class="main">∈</span><span class="bound">w2</span><span class="main">.</span>
           same_fw_behaviour_one <span class="bound">ip1</span> <span class="bound">ip2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> groupParts_same_fw_wi0 asm 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>set <span class="main">(</span>map wordinterval_to_set <span class="free">V</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a1</span><span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span><span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> sameFw_behave_sets<span class="main">[</span><span class="operator">OF</span> this b3<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w1</span> <span class="main">∈</span> set <span class="free">V</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w2</span> <span class="main">∈</span> set <span class="free">V</span><span class="main">.</span>
   <span class="main">∀</span><span class="bound">a1</span> <span class="main">∈</span> wordinterval_to_set <span class="bound">w1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a2</span> <span class="main">∈</span> wordinterval_to_set <span class="bound">w2</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">a1</span> <span class="bound">a2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Service_Matrix-groupParts_same_fw_wi2"><span class="command">lemma</span></span> groupParts_same_fw_wi2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span>
                               <span class="main">∀</span><span class="bound">ip1</span> <span class="main">∈</span> wordinterval_list_to_set <span class="free">V</span><span class="main">.</span>
                               <span class="main">∀</span><span class="bound">ip2</span> <span class="main">∈</span> wordinterval_list_to_set <span class="free">V</span><span class="main">.</span>
                               same_fw_behaviour_one <span class="bound">ip1</span> <span class="bound">ip2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> groupParts_same_fw_wi0 groupParts_same_fw_wi1
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wordinterval_list_to_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Service_Matrix-groupWIs_same_fw_not2"><span class="command">lemma</span></span> groupWIs_same_fw_not2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> 
                                <span class="free">A</span> <span class="main">≠</span> <span class="free">B</span> <span class="main">⟹</span>
                                <span class="main">∀</span><span class="bound">ip1</span> <span class="main">∈</span> wordinterval_list_to_set <span class="free">A</span><span class="main">.</span>
                                <span class="main">∀</span><span class="bound">ip2</span> <span class="main">∈</span> wordinterval_list_to_set <span class="free">B</span><span class="main">.</span>
                                <span class="main">¬</span> same_fw_behaviour_one <span class="bound">ip1</span> <span class="bound">ip2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wordinterval_list_to_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> groupWIs_same_fw_not <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="comment1">(*I like this version -- corny*)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> 
                <span class="main">∃</span><span class="bound">ip1</span> <span class="main">∈</span> wordinterval_list_to_set <span class="free">A</span><span class="main">.</span>
                <span class="main">∃</span><span class="bound">ip2</span> <span class="main">∈</span> wordinterval_list_to_set <span class="free">B</span><span class="main">.</span> same_fw_behaviour_one <span class="bound">ip1</span> <span class="bound">ip2</span> <span class="free">c</span> <span class="free">rs</span>
                <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> groupWIs_same_fw_not2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1" id="Service_Matrix-groupWIs_complete"><span class="command">lemma</span></span> groupWIs_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span><span class="main">.</span> wordinterval_list_to_set <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'i</span><span class="main">::</span>len word set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span><span class="main">.</span> set <span class="bound">x</span><span class="main">)</span><span class="main">.</span> wordinterval_to_set <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'i</span> word set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groupWIs_def Let_def groupF_Union_set<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> getParts_complete wordinterval_list_to_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wordinterval_list_to_set_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(*begin groupWIs1 and groupWIs2 optimization*)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">groupWIs1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> parts_connection_scheme <span class="main">⇒</span> <span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="tfree">'i</span> wordinterval list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">groupWIs1</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">P</span> <span class="main">=</span> getParts <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="keyword1">in</span>
                        <span class="main">(</span><span class="keyword1">let</span> <span class="bound">W</span> <span class="main">=</span> map getOneIp <span class="bound">P</span> <span class="keyword1">in</span> 
                         <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">wi</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="bound">W</span><span class="main">,</span>
                                         map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="bound">W</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
                        map <span class="main">(</span>map fst<span class="main">)</span> <span class="main">(</span>groupF snd <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="Service_Matrix-groupWIs_groupWIs1_equi"><span class="command">lemma</span></span> groupWIs_groupWIs1_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"groupWIs1 <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> groupWIs <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> groupWIs1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> groupWIs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> groupF_tuple <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_conn_matches</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_match <span class="main">⇒</span> parts_connection <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">simple_conn_matches</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟷</span>
        <span class="main">(</span>match_iface <span class="main">(</span>iiface <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>pc_iiface <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span>match_iface <span class="main">(</span>oiface <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>pc_oiface <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span>match_proto <span class="main">(</span>proto <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>pc_proto <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span>simple_match_port <span class="main">(</span>sports <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>pc_sport <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span>simple_match_port <span class="main">(</span>dports <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>pc_dport <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="Service_Matrix-simple_conn_matches_simple_match_any"><span class="command">lemma</span></span> simple_conn_matches_simple_match_any<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_conn_matches simple_match_any <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_conn_matches_def simple_match_any_def match_ifaceAny<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">65535</span><span class="main">::</span><span class="numeral">16</span> word<span class="main">)</span> <span class="main">=</span> max_word"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1" id="Service_Matrix-has_default_policy_simple_conn_matches"><span class="command">lemma</span></span> has_default_policy_simple_conn_matches<span class="main">:</span>
    <span class="quoted"><span class="quoted">"has_default_policy <span class="free">rs</span> <span class="main">⟹</span> has_default_policy <span class="main">[</span><span class="bound">r</span><span class="main">←</span><span class="free">rs</span> <span class="main">.</span> simple_conn_matches <span class="main">(</span>match_sel <span class="bound">r</span><span class="main">)</span> <span class="free">c</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_default_policy.induct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_conn_matches_simple_match_any<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_default_policy_fst <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  
  <span class="keyword1" id="Service_Matrix-filter_conn_fw_lem"><span class="command">lemma</span></span> filter_conn_fw_lem<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"runFw <span class="free">s</span> <span class="free">d</span> <span class="free">c</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> simple_conn_matches <span class="main">(</span>match_sel <span class="bound">r</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> runFw <span class="free">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> runFw_def simple_conn_matches_def match_sel_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span>p_iiface <span class="main">=</span> pc_iiface <span class="free">c</span><span class="main">,</span> p_oiface <span class="main">=</span> pc_oiface <span class="free">c</span><span class="main">,</span>
                         p_src <span class="main">=</span> <span class="free">s</span><span class="main">,</span> p_dst <span class="main">=</span> <span class="free">d</span><span class="main">,</span> p_proto <span class="main">=</span> pc_proto <span class="free">c</span><span class="main">,</span> 
                         p_sport <span class="main">=</span> pc_sport <span class="free">c</span><span class="main">,</span> p_dport <span class="main">=</span> pc_dport <span class="free">c</span><span class="main">,</span>
                         p_tcp_flags <span class="main">=</span> <span class="main">{</span>TCP_SYN<span class="main">}</span><span class="main">,</span>p_payload<span class="main">=</span><span class="inner_quoted">''''</span><span class="main">⦈</span>"</span></span>
          <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> simple_fw.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_matches.simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  
  <span class="comment1">(*performance: despite optimization, this function takes quite long and can be optimized*)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">groupWIs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"parts_connection <span class="main">⇒</span> <span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="tfree">'i</span> wordinterval list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">groupWIs2</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">P</span> <span class="main">=</span> getParts <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="keyword1">in</span>
                         <span class="main">(</span><span class="keyword1">let</span> <span class="bound">W</span> <span class="main">=</span> map getOneIp <span class="bound">P</span> <span class="keyword1">in</span> 
                         <span class="main">(</span><span class="keyword1">let</span> <span class="bound">filterW</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> simple_conn_matches <span class="main">(</span>match_sel <span class="bound">r</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
                           <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">wi</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">filterW</span><span class="main">)</span> <span class="bound">W</span><span class="main">,</span>
                                           map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">filterW</span><span class="main">)</span> <span class="bound">W</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
                        map <span class="main">(</span>map fst<span class="main">)</span> <span class="main">(</span>groupF snd <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="Service_Matrix-groupWIs1_groupWIs2_equi"><span class="command">lemma</span></span> groupWIs1_groupWIs2_equi<span class="main">:</span> <span class="quoted"><span class="quoted">"groupWIs2 <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> groupWIs1 <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groupWIs2_def groupWIs1_def filter_conn_fw_lem<span class="main">)</span>
  
  
  <span class="keyword1" id="Service_Matrix-groupWIs_code"><span class="command">lemma</span></span> groupWIs_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"groupWIs <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> groupWIs2 <span class="free">c</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> groupWIs1_groupWIs2_equi groupWIs_groupWIs1_equi <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="comment1">(*end groupWIs1 and groupWIs2 optimization*)</span>


<span class="comment1">(*begin groupWIs3 optimization*)</span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">matching_dsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'i</span> simple_rule list <span class="main">⇒</span> <span class="tfree">'i</span> wordinterval <span class="main">⇒</span> <span class="tfree">'i</span> wordinterval"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">matching_dsts</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Empty_WordInterval"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">matching_dsts</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> Accept<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">if</span> simple_match_ip <span class="main">(</span>src <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span>
           wordinterval_union <span class="main">(</span>wordinterval_setminus <span class="main">(</span>ipcidr_tuple_to_wordinterval <span class="main">(</span>dst <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">matching_dsts</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span><span class="main">)</span>
         <span class="keyword1">else</span>
           <span class="free">matching_dsts</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">matching_dsts</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> Drop<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">if</span> simple_match_ip <span class="main">(</span>src <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span>
           <span class="free">matching_dsts</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span>wordinterval_union <span class="main">(</span>ipcidr_tuple_to_wordinterval <span class="main">(</span>dst <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span><span class="main">)</span>
         <span class="keyword1">else</span>
           <span class="free">matching_dsts</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="Service_Matrix-matching_dsts_pull_out_accu"><span class="command">lemma</span></span> matching_dsts_pull_out_accu<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wordinterval_to_set <span class="main">(</span>matching_dsts <span class="free">s</span> <span class="free">rs</span> <span class="main">(</span>wordinterval_union <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> wordinterval_to_set <span class="main">(</span>matching_dsts <span class="free">s</span> <span class="free">rs</span> <span class="free">a2</span><span class="main">)</span> <span class="main">-</span> wordinterval_to_set <span class="free">a1</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">a2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a1</span></span> <span class="quoted"><span class="free">a2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> matching_dsts.induct<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="comment1">(*a copy of matching_dsts*)</span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">matching_srcs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'i</span> simple_rule list <span class="main">⇒</span> <span class="tfree">'i</span> wordinterval <span class="main">⇒</span> <span class="tfree">'i</span> wordinterval"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">matching_srcs</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Empty_WordInterval"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">matching_srcs</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span><span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> Accept<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">if</span> simple_match_ip <span class="main">(</span>dst <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">then</span>
           wordinterval_union <span class="main">(</span>wordinterval_setminus <span class="main">(</span>ipcidr_tuple_to_wordinterval <span class="main">(</span>src <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">matching_srcs</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span><span class="main">)</span>
         <span class="keyword1">else</span>
           <span class="free">matching_srcs</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">matching_srcs</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span><span class="main">(</span>SimpleRule <span class="free"><span class="bound"><span class="entity">m</span></span></span> Drop<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">if</span> simple_match_ip <span class="main">(</span>dst <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">then</span>
           <span class="free">matching_srcs</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span>wordinterval_union <span class="main">(</span>ipcidr_tuple_to_wordinterval <span class="main">(</span>src <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span><span class="main">)</span>
         <span class="keyword1">else</span>
           <span class="free">matching_srcs</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">acc_dropped</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="Service_Matrix-matching_srcs_pull_out_accu"><span class="command">lemma</span></span> matching_srcs_pull_out_accu<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wordinterval_to_set <span class="main">(</span>matching_srcs <span class="free">d</span> <span class="free">rs</span> <span class="main">(</span>wordinterval_union <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> wordinterval_to_set <span class="main">(</span>matching_srcs <span class="free">d</span> <span class="free">rs</span> <span class="free">a2</span><span class="main">)</span> <span class="main">-</span> wordinterval_to_set <span class="free">a1</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">a2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a1</span></span> <span class="quoted"><span class="free">a2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> matching_srcs.induct<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  
  
  <span class="keyword1" id="Service_Matrix-matching_dsts"><span class="command">lemma</span></span> matching_dsts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">rs</span><span class="main">.</span> simple_conn_matches <span class="main">(</span>match_sel <span class="bound">r</span><span class="main">)</span> <span class="free">c</span> <span class="main">⟹</span>
          wordinterval_to_set <span class="main">(</span>matching_dsts <span class="free">s</span> <span class="free">rs</span> Empty_WordInterval<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> runFw <span class="free">s</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalAllow<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> runFw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> SimpleRule <span class="skolem">m</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      
      <span class="keyword1"><span class="command">from</span></span> Cons.prems r <span class="keyword1"><span class="command">have</span></span> simple_match_ip_Accept<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">d</span><span class="main">.</span> simple_match_ip <span class="main">(</span>src <span class="skolem">m</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span>
        runFw <span class="free">s</span> <span class="bound">d</span> <span class="free">c</span> <span class="main">(</span>SimpleRule <span class="skolem">m</span> Accept <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> Decision FinalAllow <span class="main">⟷</span> simple_match_ip <span class="main">(</span>dst <span class="skolem">m</span><span class="main">)</span> <span class="bound">d</span> <span class="main">∨</span> runFw <span class="free">s</span> <span class="bound">d</span> <span class="free">c</span> <span class="skolem">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_conn_matches_def runFw_def simple_matches.simps<span class="main">)</span>
  
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">a</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> simple_match_ip <span class="main">(</span>src <span class="skolem">m</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span>
         runFw <span class="free">s</span> <span class="skolem">d</span> <span class="free">c</span> <span class="main">(</span>SimpleRule <span class="skolem">m</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> Decision FinalAllow <span class="main">⟷</span> runFw <span class="free">s</span> <span class="skolem">d</span> <span class="free">c</span> <span class="skolem">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_conn_matches_def runFw_def simple_matches.simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> not_simple_match_ip<span class="main">=</span>this
  
      <span class="keyword1"><span class="command">from</span></span> Cons.prems r <span class="keyword1"><span class="command">have</span></span> simple_match_ip_Drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">d</span><span class="main">.</span> simple_match_ip <span class="main">(</span>src <span class="skolem">m</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span>
             runFw <span class="free">s</span> <span class="bound">d</span> <span class="free">c</span> <span class="main">(</span>SimpleRule <span class="skolem">m</span> Drop <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> Decision FinalAllow <span class="main">⟷</span> <span class="main">¬</span> simple_match_ip <span class="main">(</span>dst <span class="skolem">m</span><span class="main">)</span> <span class="bound">d</span> <span class="main">∧</span> runFw <span class="free">s</span> <span class="bound">d</span> <span class="free">c</span> <span class="skolem">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_conn_matches_def runFw_def simple_matches.simps<span class="main">)</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Accept <span class="keyword1"><span class="command">with</span></span> r Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI impI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_match_ip_Accept wordinterval_to_set_ipcidr_tuple_to_wordinterval_simple_match_ip_set<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_simple_match_ip<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Drop <span class="keyword1"><span class="command">with</span></span> r Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">intro</span> conjI impI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_match_ip_Drop matching_dsts_pull_out_accu wordinterval_to_set_ipcidr_tuple_to_wordinterval_simple_match_ip_set<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_simple_match_ip<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Service_Matrix-matching_srcs"><span class="command">lemma</span></span> matching_srcs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">rs</span><span class="main">.</span> simple_conn_matches <span class="main">(</span>match_sel <span class="bound">r</span><span class="main">)</span> <span class="free">c</span> <span class="main">⟹</span>
          wordinterval_to_set <span class="main">(</span>matching_srcs <span class="free">d</span> <span class="free">rs</span> Empty_WordInterval<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalAllow<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> runFw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> SimpleRule <span class="skolem">m</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      
      <span class="keyword1"><span class="command">from</span></span> Cons.prems r <span class="keyword1"><span class="command">have</span></span> simple_match_ip_Accept<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> simple_match_ip <span class="main">(</span>dst <span class="skolem">m</span><span class="main">)</span> <span class="free">d</span> <span class="main">⟹</span>
         runFw <span class="bound">s</span> <span class="free">d</span> <span class="free">c</span> <span class="main">(</span>SimpleRule <span class="skolem">m</span> Accept <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> Decision FinalAllow <span class="main">⟷</span>
          simple_match_ip <span class="main">(</span>src <span class="skolem">m</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∨</span> runFw <span class="bound">s</span> <span class="free">d</span> <span class="free">c</span> <span class="skolem">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_conn_matches_def runFw_def simple_matches.simps<span class="main">)</span>
  
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">a</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> simple_match_ip <span class="main">(</span>dst <span class="skolem">m</span><span class="main">)</span> <span class="free">d</span> <span class="main">⟹</span>
         runFw <span class="skolem">s</span> <span class="free">d</span> <span class="free">c</span> <span class="main">(</span>SimpleRule <span class="skolem">m</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> Decision FinalAllow <span class="main">⟷</span> runFw <span class="skolem">s</span> <span class="free">d</span> <span class="free">c</span> <span class="skolem">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_conn_matches_def runFw_def simple_matches.simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> not_simple_match_ip<span class="main">=</span>this
  
      <span class="keyword1"><span class="command">from</span></span> Cons.prems r <span class="keyword1"><span class="command">have</span></span> simple_match_ip_Drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> simple_match_ip <span class="main">(</span>dst <span class="skolem">m</span><span class="main">)</span> <span class="free">d</span> <span class="main">⟹</span>
         runFw <span class="bound">s</span> <span class="free">d</span> <span class="free">c</span> <span class="main">(</span>SimpleRule <span class="skolem">m</span> Drop <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> Decision FinalAllow <span class="main">⟷</span>
          <span class="main">¬</span> simple_match_ip <span class="main">(</span>src <span class="skolem">m</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span> runFw <span class="bound">s</span> <span class="free">d</span> <span class="free">c</span> <span class="skolem">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_conn_matches_def runFw_def simple_matches.simps<span class="main">)</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Accept <span class="keyword1"><span class="command">with</span></span> r Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI impI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_match_ip_Accept wordinterval_to_set_ipcidr_tuple_to_wordinterval_simple_match_ip_set<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_simple_match_ip<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Drop <span class="keyword1"><span class="command">with</span></span> r Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">intro</span> conjI impI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_match_ip_Drop matching_srcs_pull_out_accu wordinterval_to_set_ipcidr_tuple_to_wordinterval_simple_match_ip_set<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_simple_match_ip<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  
  
  <span class="comment1">(*TODO: if we can get wordinterval_element to log runtime ...*)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">groupWIs3_default_policy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"parts_connection <span class="main">⇒</span> <span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="tfree">'i</span> wordinterval list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">groupWIs3_default_policy</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">P</span> <span class="main">=</span> getParts <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="keyword1">in</span>
                         <span class="main">(</span><span class="keyword1">let</span> <span class="bound">W</span> <span class="main">=</span> map getOneIp <span class="bound">P</span> <span class="keyword1">in</span> 
                         <span class="main">(</span><span class="keyword1">let</span> <span class="bound">filterW</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> simple_conn_matches <span class="main">(</span>match_sel <span class="bound">r</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
                           <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">wi</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">mtch_dsts</span> <span class="main">=</span> <span class="main">(</span>matching_dsts <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="bound">filterW</span> Empty_WordInterval<span class="main">)</span><span class="main">;</span>
                                              <span class="bound">mtch_srcs</span> <span class="main">=</span> <span class="main">(</span>matching_srcs <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="bound">filterW</span> Empty_WordInterval<span class="main">)</span> <span class="keyword1">in</span> 
                                          <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> wordinterval_element <span class="bound">d</span> <span class="bound">mtch_dsts</span><span class="main">)</span> <span class="bound">W</span><span class="main">,</span>
                                           map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> wordinterval_element <span class="bound">s</span> <span class="bound">mtch_srcs</span><span class="main">)</span> <span class="bound">W</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
                        map <span class="main">(</span>map fst<span class="main">)</span> <span class="main">(</span>groupF snd <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  
  <span class="keyword1" id="Service_Matrix-groupWIs3_default_policy_groupWIs2"><span class="command">lemma</span></span> groupWIs3_default_policy_groupWIs2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_default_policy <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"groupWIs2 <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> groupWIs3_default_policy <span class="free">c</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">filterW</span> <span class="skolem">s</span> <span class="skolem">d</span>
      <span class="keyword1"><span class="command">from</span></span> matching_dsts<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">filterW</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> simple_conn_matches <span class="main">(</span>match_sel <span class="bound">r</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="free">rs</span> <span class="main">⟹</span>
           wordinterval_element <span class="skolem">d</span> <span class="main">(</span>matching_dsts <span class="skolem">s</span> <span class="skolem">filterW</span> Empty_WordInterval<span class="main">)</span> <span class="main">⟷</span> runFw <span class="skolem">s</span> <span class="skolem">d</span> <span class="free">c</span> <span class="skolem">filterW</span> <span class="main">=</span> Decision FinalAllow"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> matching_dsts_filterW<span class="main">=</span>this<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
  
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">filterW</span> <span class="skolem">s</span> <span class="skolem">d</span>
      <span class="keyword1"><span class="command">from</span></span> matching_srcs<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">filterW</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> simple_conn_matches <span class="main">(</span>match_sel <span class="bound">r</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="free">rs</span> <span class="main">⟹</span>
            wordinterval_element <span class="skolem">s</span> <span class="main">(</span>matching_srcs <span class="skolem">d</span> <span class="skolem">filterW</span> Empty_WordInterval<span class="main">)</span> <span class="main">⟷</span> runFw <span class="skolem">s</span> <span class="skolem">d</span> <span class="free">c</span> <span class="skolem">filterW</span> <span class="main">=</span> Decision FinalAllow"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> matching_srcs_filterW<span class="main">=</span>this<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
  
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">W</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> assms'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_default_policy <span class="skolem">rs</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"groupF <span class="main">(</span><span class="main">λ</span><span class="bound">wi</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="bound">d</span> <span class="free">c</span> <span class="skolem">rs</span> <span class="main">=</span> Decision FinalAllow<span class="main">)</span> <span class="main">(</span>map getOneIp <span class="skolem">W</span><span class="main">)</span><span class="main">,</span>
                           map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">rs</span> <span class="main">=</span> Decision FinalAllow<span class="main">)</span> <span class="main">(</span>map getOneIp <span class="skolem">W</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">W</span> <span class="main">=</span>
             groupF <span class="main">(</span><span class="main">λ</span><span class="bound">wi</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="bound">d</span> <span class="free">c</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="skolem">W</span><span class="main">)</span><span class="main">,</span>
                           map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="skolem">W</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">W</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(*unused fresh generic variables. 'a is used for the tuple already*)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f1</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'w</span> <span class="main">⇒</span> <span class="tfree">'u</span> <span class="main">⇒</span> <span class="tfree">'v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f2</span><span class="main">::</span><span class="quoted"><span class="quoted">" <span class="tfree">'w</span> <span class="main">⇒</span> <span class="tfree">'u</span> <span class="main">⇒</span> <span class="tfree">'x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">y</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">g1</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'w</span> <span class="main">⇒</span> <span class="tfree">'u</span> <span class="main">⇒</span> <span class="tfree">'y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">g2</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'w</span> <span class="main">⇒</span> <span class="tfree">'u</span> <span class="main">⇒</span> <span class="tfree">'z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">W</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'u</span> list"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> set <span class="skolem">W</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f1</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f1</span> <span class="skolem">y</span><span class="main">)</span> <span class="bound">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">f2</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">w</span> <span class="main">=</span>  <span class="main">(</span><span class="skolem">f2</span> <span class="skolem">y</span><span class="main">)</span> <span class="bound">w</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> set <span class="skolem">W</span><span class="main">.</span> <span class="main">(</span><span class="skolem">g1</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">g1</span> <span class="skolem">y</span><span class="main">)</span> <span class="bound">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">w</span> <span class="main">=</span>  <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">y</span><span class="main">)</span> <span class="bound">w</span>"</span></span>
               <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"
                 <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="skolem">f1</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">W</span><span class="main">,</span> map <span class="main">(</span><span class="skolem">g1</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">W</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="skolem">f1</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">W</span><span class="main">,</span> map <span class="main">(</span><span class="skolem">g1</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">W</span><span class="main">)</span><span class="main">)</span> 
                 <span class="main">⟷</span>
                 <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="skolem">f2</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">W</span><span class="main">,</span> map <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">W</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="skolem">f2</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">W</span><span class="main">,</span> map <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">W</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="skolem">f1</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">W</span> <span class="main">=</span> map <span class="main">(</span><span class="skolem">f1</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">W</span> <span class="main">⟷</span> map <span class="main">(</span><span class="skolem">f2</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">W</span> <span class="main">=</span> map <span class="main">(</span><span class="skolem">f2</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">W</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">W</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="skolem">g1</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">W</span> <span class="main">=</span> map <span class="main">(</span><span class="skolem">g1</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">W</span> <span class="main">⟷</span> map <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">W</span> <span class="main">=</span> map <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">W</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">W</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> p1 p2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> map_over_tuples_equal_helper<span class="main">=</span>this
      
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> groupF_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> ballI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> map_over_tuples_equal_helper<span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> has_default_policy_runFw<span class="main">[</span><span class="operator">OF</span> assms'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> has_default_policy_groupF<span class="main">=</span>this<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
  
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groupWIs3_default_policy_def groupWIs_code<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> groupF_tuple<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_srcs_filterW matching_dsts_filterW<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> has_default_policy_groupF<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_default_policy_simple_conn_matches<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> groupWIs_def Let_def filter_conn_fw_lem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">groupWIs3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"parts_connection <span class="main">⇒</span> <span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="tfree">'i</span> wordinterval list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">groupWIs3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> has_default_policy <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="keyword1">then</span> groupWIs3_default_policy <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="keyword1">else</span> groupWIs2 <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="Service_Matrix-groupWIs3"><span class="command">lemma</span></span> groupWIs3<span class="main">:</span> <span class="quoted"><span class="quoted">"groupWIs3 <span class="main">=</span> groupWIs"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff groupWIs3_def groupWIs_code groupWIs3_default_policy_groupWIs2<span class="main">)</span> 

<span class="comment1">(*end groupWIs3 optimization*)</span>

<span class="comment1">(*construct partitions. main function!*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">build_ip_partition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"parts_connection <span class="main">⇒</span> <span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="tfree">'i</span> wordinterval list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">build_ip_partition</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> map
    <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> wordinterval_sort <span class="main">(</span>wordinterval_compress <span class="main">(</span>foldr wordinterval_union <span class="bound">xs</span> Empty_WordInterval<span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>groupWIs3 <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">theorem</span></span> build_ip_partition_same_fw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span>
                               <span class="main">∀</span><span class="bound">ip1</span><span class="main">::</span><span class="tfree">'i</span><span class="main">::</span>len word <span class="main">∈</span> wordinterval_to_set <span class="free">V</span><span class="main">.</span>
                               <span class="main">∀</span><span class="bound">ip2</span><span class="main">::</span><span class="tfree">'i</span><span class="main">::</span>len word <span class="main">∈</span> wordinterval_to_set <span class="free">V</span><span class="main">.</span>
                               same_fw_behaviour_one <span class="bound">ip1</span> <span class="bound">ip2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> build_ip_partition_def groupWIs3<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> wordinterval_list_to_set_compressed groupParts_same_fw_wi2 wordinterval_sort <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> build_ip_partition_same_fw_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> 
                                <span class="free">A</span> <span class="main">≠</span> <span class="free">B</span> <span class="main">⟹</span>
                                <span class="main">∀</span><span class="bound">ip1</span><span class="main">::</span><span class="tfree">'i</span><span class="main">::</span>len word <span class="main">∈</span> wordinterval_to_set <span class="free">A</span><span class="main">.</span>
                                <span class="main">∀</span><span class="bound">ip2</span><span class="main">::</span><span class="tfree">'i</span><span class="main">::</span>len word <span class="main">∈</span> wordinterval_to_set <span class="free">B</span><span class="main">.</span>
                                <span class="main">¬</span> same_fw_behaviour_one <span class="bound">ip1</span> <span class="bound">ip2</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> build_ip_partition_def groupWIs3<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span>  groupWIs_same_fw_not2 wordinterval_list_to_set_compressed wordinterval_sort <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> build_ip_partition_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span><span class="main">.</span> wordinterval_to_set <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'i</span><span class="main">::</span>len word set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wordinterval_to_set <span class="main">(</span>foldr wordinterval_union <span class="skolem">x</span> Empty_WordInterval<span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'i</span> wordinterval list"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> build_ip_partition_def groupWIs3 wordinterval_compress wordinterval_sort<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> groupWIs_complete<span class="main">[</span><span class="operator">simplified</span> wordinterval_list_to_set_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1" id="Service_Matrix-build_ip_partition_no_empty_elems"><span class="command">lemma</span></span> build_ip_partition_no_empty_elems<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wi</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> wordinterval_empty <span class="free">wi</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">wi</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wi</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> wordinterval_sort <span class="main">(</span>wordinterval_compress <span class="main">(</span>foldr wordinterval_union <span class="bound">xs</span> Empty_WordInterval<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> build_ip_partition_def groupWIs3<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assm <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wi_orig</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wi_orig</span> <span class="main">∈</span>  set <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wi</span> <span class="main">=</span> wordinterval_sort <span class="main">(</span>wordinterval_compress <span class="main">(</span>foldr wordinterval_union <span class="skolem">wi_orig</span> Empty_WordInterval<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 1 groupWIs_not_empty_elem <span class="keyword1"><span class="command">have</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wi_orig</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 1 groupWIs_not_empty_elems <span class="keyword1"><span class="command">have</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> set <span class="skolem">wi_orig</span> <span class="main">⟹</span> <span class="main">¬</span> wordinterval_empty <span class="bound">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> i1 i2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wordinterval_to_set <span class="main">(</span>foldr wordinterval_union <span class="skolem">wi_orig</span> Empty_WordInterval<span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">wi_orig</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wordinterval_compress wordinterval_sort<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Service_Matrix-build_ip_partition_disjoint"><span class="command">lemma</span></span> build_ip_partition_disjoint<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="free">V1</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">V2</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="free">V1</span> <span class="main">≠</span> <span class="free">V2</span> <span class="main">⟹</span>
        wordinterval_to_set <span class="free">V1</span> <span class="main">∩</span> wordinterval_to_set <span class="free">V2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> build_ip_partition_same_fw build_ip_partition_same_fw_min disjoint_iff<span class="main">)</span>


<span class="keyword1" id="Service_Matrix-map_wordinterval_to_set_distinct"><span class="command">lemma</span></span> map_wordinterval_to_set_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x2</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x1</span> <span class="main">≠</span> <span class="bound">x2</span> <span class="main">⟶</span> wordinterval_to_set <span class="bound">x1</span> <span class="main">∩</span> wordinterval_to_set <span class="bound">x2</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> notempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> wordinterval_empty <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map wordinterval_to_set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wordinterval_empty <span class="skolem">x1</span> <span class="main">⟹</span> 
        wordinterval_to_set <span class="skolem">x1</span> <span class="main">∩</span> wordinterval_to_set <span class="skolem">x2</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
        wordinterval_to_set <span class="skolem">x1</span> <span class="main">≠</span> wordinterval_to_set <span class="skolem">x2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x1</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>len<span class="main">)</span> wordinterval"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x2</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> disjoint notempty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x2</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x1</span> <span class="main">≠</span> <span class="bound">x2</span> <span class="main">⟶</span> wordinterval_to_set <span class="bound">x1</span> <span class="main">≠</span> wordinterval_to_set <span class="bound">x2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> distinct <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map wordinterval_to_set <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Service_Matrix-map_getOneIp_distinct"><span class="command">lemma</span></span> map_getOneIp_distinct<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
  distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x2</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x1</span> <span class="main">≠</span> <span class="bound">x2</span> <span class="main">⟶</span> wordinterval_to_set <span class="bound">x1</span> <span class="main">∩</span> wordinterval_to_set <span class="bound">x2</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> notempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> wordinterval_empty <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map getOneIp <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wordinterval_empty <span class="skolem">x</span> <span class="main">⟹</span> <span class="main">¬</span> wordinterval_empty <span class="skolem">xa</span> <span class="main">⟹</span> 
          wordinterval_to_set <span class="skolem">x</span> <span class="main">∩</span> wordinterval_to_set <span class="skolem">xa</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> getOneIp <span class="skolem">x</span> <span class="main">≠</span> getOneIp <span class="skolem">xa</span>"</span></span>
     <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">xa</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">::</span>len wordinterval"</span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> getOneIp_elem<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> disjoint notempty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x2</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x1</span> <span class="main">≠</span> <span class="bound">x2</span> <span class="main">⟶</span> getOneIp <span class="bound">x1</span> <span class="main">≠</span> getOneIp <span class="bound">x2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">with</span></span> distinct <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Service_Matrix-getParts_disjoint_list"><span class="command">lemma</span></span> getParts_disjoint_list<span class="main">:</span> <span class="quoted"><span class="quoted">"disjoint_list <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> disjoint_list_partitioningIps<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>map wordinterval_to_set <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span> disjoint_list <span class="main">(</span>map wordinterval_to_set <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span> 
     <span class="main">(</span>wordinterval_list_to_set <span class="skolem">ss</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>wordinterval_list_to_set <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span>
     disjoint_list <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>partitioningIps <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ts</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len wordinterval list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ss</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partitioning1_disjoint_list partitioningIps_equi wordinterval_list_to_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>map wordinterval_to_set <span class="main">[</span>wordinterval_UNIV<span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"disjoint_list <span class="main">(</span>map wordinterval_to_set <span class="main">[</span>wordinterval_UNIV<span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wordinterval_list_to_set <span class="main">(</span>extract_IPSets <span class="free">rs</span><span class="main">)</span> <span class="main">⊆</span> wordinterval_list_to_set <span class="main">[</span>wordinterval_UNIV<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wordinterval_list_to_set_def disjoint_list_def disjoint_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> getParts_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> disjoint_list_partitioningIps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Service_Matrix-build_ip_partition_distinct"><span class="command">lemma</span></span> build_ip_partition_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map wordinterval_to_set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>  
  <span class="quoted"><span class="quoted">"<span class="main">(</span>wordinterval_to_set <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> wordinterval_sort <span class="main">(</span>wordinterval_compress <span class="main">(</span>foldr wordinterval_union <span class="bound">xs</span> Empty_WordInterval<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ws</span>
       <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ws</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len wordinterval list"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ws</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wordinterval_compress wordinterval_sort<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> hlp1<span class="main">:</span> <span class="quoted"><span class="quoted">"map wordinterval_to_set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span>
                   map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>groupWIs <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> build_ip_partition_def groupWIs3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹generic rule›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="main">¬</span> wordinterval_empty <span class="bound">x</span> <span class="main">⟹</span>
         disjoint_list <span class="main">(</span>map wordinterval_to_set <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟹</span>
         distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>groupF <span class="skolem">f</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'x</span><span class="main">::</span>len wordinterval <span class="main">⇒</span> <span class="tfree">'y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'x</span><span class="main">::</span>len wordinterval list"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> groupF.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> hlp_internal<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>groupF <span class="skolem">f</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'x</span> wordinterval <span class="main">⇒</span> <span class="tfree">'y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> groupF.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wordinterval_to_set <span class="skolem">x</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>wordinterval_to_set <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_def disjoint_list_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>wordinterval_to_set <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>wordinterval_to_set <span class="main">`</span> set <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wordinterval_to_set <span class="skolem">x</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wordinterval_to_set <span class="skolem">x</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">xa</span><span class="main">}</span><span class="main">.</span>
         wordinterval_to_set <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>groupF <span class="skolem">f</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> hlp_internal <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> g1<span class="main">:</span> <span class="quoted"><span class="quoted">"wordinterval_to_set <span class="skolem">x</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">xa</span><span class="main">}</span><span class="main">.</span> wordinterval_to_set <span class="bound">x</span><span class="main">)</span>
        <span class="main">∉</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="bound">x</span><span class="main">.</span> wordinterval_to_set <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>groupF <span class="skolem">f</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      
      <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map wordinterval_to_set <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_list_def  distinct_map_filter<span class="main">)</span> 
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint <span class="main">(</span>wordinterval_to_set <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="bound">xa</span><span class="main">}</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_def disjoint_list_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> g2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="bound">x</span><span class="main">.</span> wordinterval_to_set <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>groupF <span class="skolem">f</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> disjoint_list_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> g1 g2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> getParts_disjoint_list getParts_nonempty_elems <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"distinct
     <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map wordinterval_to_set <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>groupF <span class="main">(</span><span class="main">λ</span><span class="bound">wi</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> runFw <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                      map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="main">(</span>getOneIp <span class="bound">wi</span><span class="main">)</span> <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>map getOneIp <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>getParts <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> hlp1 groupWIs_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Service_Matrix-build_ip_partition_distinct'"><span class="command">lemma</span></span> build_ip_partition_distinct'<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> build_ip_partition_distinct distinct_mapI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Service Matrix over an IP Address Space Partition›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_firewall_without_interfaces</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simple_firewall_without_interfaces</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">m</span> <span class="main">∈</span> match_sel <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">.</span> iiface <span class="bound">m</span> <span class="main">=</span> ifaceAny <span class="main">∧</span> oiface <span class="bound">m</span> <span class="main">=</span> ifaceAny"</span></span>

<span class="keyword1" id="Service_Matrix-simple_fw_no_interfaces"><span class="command">lemma</span></span> simple_fw_no_interfaces<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no_ifaces<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_firewall_without_interfaces <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_fw <span class="free">rs</span> <span class="free">p</span> <span class="main">=</span> simple_fw <span class="free">rs</span> <span class="main">(</span><span class="free">p</span><span class="main">⦇</span> p_iiface<span class="main">:=</span> <span class="free">x</span><span class="main">,</span> p_oiface<span class="main">:=</span> <span class="free">y</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> no_ifaces <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="free">rs</span><span class="main">.</span> iiface <span class="main">(</span>match_sel <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> ifaceAny <span class="main">∧</span> oiface <span class="main">(</span>match_sel <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> ifaceAny"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_firewall_without_interfaces_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>simple_fw.induct<span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_matches.simps match_ifaceAny<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
   
<span class="keyword1" id="Service_Matrix-runFw_no_interfaces"><span class="command">lemma</span></span> runFw_no_interfaces<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no_ifaces<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_firewall_without_interfaces <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runFw <span class="free">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="free">s</span> <span class="free">d</span> <span class="main">(</span><span class="free">c</span><span class="main">⦇</span> pc_iiface<span class="main">:=</span> <span class="free">x</span><span class="main">,</span> pc_oiface<span class="main">:=</span> <span class="free">y</span><span class="main">⦈</span><span class="main">)</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> runFw_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> simple_fw_no_interfaces<span class="main"><span class="main">[</span></span><span class="operator">OF</span> no_ifaces<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span><span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"simple_firewall_without_interfaces <span class="free">rs</span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">m</span> <span class="main">∈</span> set <span class="free">rs</span><span class="main">.</span> iiface <span class="main">(</span>match_sel <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> ifaceAny <span class="main">∧</span> oiface <span class="main">(</span>match_sel <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> ifaceAny"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_firewall_without_interfaces_def<span class="main">)</span>

<span class="comment1">(*only defined for simple_firewall_without_interfaces*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">access_matrix</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"parts_connection <span class="main">⇒</span> <span class="tfree">'i</span><span class="main">::</span>len simple_rule list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span> word <span class="main">×</span> <span class="tfree">'i</span> wordinterval<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'i</span> word <span class="main">×</span> <span class="tfree">'i</span> word<span class="main">)</span> list"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">access_matrix</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">W</span> <span class="main">=</span> build_ip_partition <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">;</span>
         <span class="bound">R</span> <span class="main">=</span> map getOneIp <span class="bound">W</span>
     <span class="keyword1">in</span>
     <span class="main">(</span>zip <span class="bound">R</span> <span class="bound">W</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">←</span>all_pairs <span class="bound">R</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> Decision FinalAllow<span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Service_Matrix-access_matrix_nodes_defined"><span class="command">lemma</span></span> access_matrix_nodes_defined<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">E</span><span class="main">)</span> <span class="main">=</span> access_matrix <span class="free">c</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">E</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> dom <span class="main">(</span>map_of <span class="free">V</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">E</span><span class="main">)</span> <span class="main">=</span> access_matrix <span class="free">c</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">E</span> <span class="main">⟹</span> <span class="free">d</span> <span class="main">∈</span> dom <span class="main">(</span>map_of <span class="free">V</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> access_matrix_def Let_def all_pairs_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For all the entries <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the matrix, the access is allowed›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">E</span><span class="main">)</span> <span class="main">=</span> access_matrix <span class="free">c</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">E</span> <span class="main">⟹</span> runFw <span class="free">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> access_matrix_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹However, the entries are only a representation of a whole set of IP addresses. 
      For all IP addresses which the entries represent, the access must be allowed.›</span></span>


<span class="comment1">(*TODO: move to generic library*)</span>
<span class="keyword1" id="Service_Matrix-map_of_zip_map"><span class="command">lemma</span></span> map_of_zip_map<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>zip <span class="main">(</span>map <span class="free">f</span> <span class="free">rs</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">=</span> <span class="free">f</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Service_Matrix-access_matrix_sound"><span class="command">lemma</span></span> access_matrix_sound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> matrix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">E</span><span class="main">)</span> <span class="main">=</span> access_matrix <span class="free">c</span> <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
              repr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s_repr</span><span class="main">,</span> <span class="free">d_repr</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
              s_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_of <span class="free">V</span><span class="main">)</span> <span class="free">s_repr</span> <span class="main">=</span> Some <span class="free">s_range</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> wordinterval_to_set <span class="free">s_range</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
              d_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_of <span class="free">V</span><span class="main">)</span> <span class="free">d_repr</span> <span class="main">=</span> Some <span class="free">d_range</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> wordinterval_to_set <span class="free">d_range</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runFw <span class="free">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?part</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">(</span>zip <span class="main">(</span>map getOneIp <span class="var">?part</span><span class="main">)</span> <span class="var">?part</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> matrix <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> access_matrix_def Let_def<span class="main">)</span>
    <span class="comment1">(*have "E = [(s, d)←all_pairs (map getOneIp ?part). runFw s d c rs = Decision FinalAllow]"
      using matrix by(simp add: access_matrix_def Let_def)
    with repr have "(s_repr, d_repr) ∈ set (all_pairs (map getOneIp ?part))" by simp
    hence "s_repr ∈ set (map getOneIp ?part)" and
          "d_repr ∈ set (map getOneIp ?part)"
      by(simp add: all_pairs_set)+*)</span>
    <span class="comment1">(*from s_range have "(s_repr, s_range) ∈ set V" by (simp add: map_of_SomeD)*)</span>

    <span class="keyword1"><span class="command">from</span></span> matrix repr <span class="keyword1"><span class="command">have</span></span> repr_Allow<span class="main">:</span> <span class="quoted"><span class="quoted">"runFw <span class="free">s_repr</span> <span class="free">d_repr</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> access_matrix_def Let_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> s_range_in_part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s_range</span> <span class="main">∈</span> set <span class="var">?part</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> V s_range <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_set_zipE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> build_ip_partition_no_empty_elems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wordinterval_empty <span class="free">s_range</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> d_range_in_part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d_range</span> <span class="main">∈</span> set <span class="var">?part</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> V d_range <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_set_zipE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> build_ip_partition_no_empty_elems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wordinterval_empty <span class="free">d_range</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> map_of_zip_map V s_range <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s_repr</span> <span class="main">=</span> getOneIp <span class="free">s_range</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> wordinterval_empty <span class="free">s_range</span>›</span></span> getOneIp_elem wordinterval_element_set_eq 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s_repr</span> <span class="main">∈</span> wordinterval_to_set <span class="free">s_range</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

    <span class="keyword1"><span class="command">from</span></span> map_of_zip_map V d_range <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d_repr</span> <span class="main">=</span> getOneIp <span class="free">d_range</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> wordinterval_empty <span class="free">d_range</span>›</span></span> getOneIp_elem wordinterval_element_set_eq 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d_repr</span> <span class="main">∈</span> wordinterval_to_set <span class="free">d_range</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

    <span class="keyword1"><span class="command">from</span></span> s_range_in_part <span class="keyword1"><span class="command">have</span></span> s_range_in_part'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s_range</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> d_range_in_part <span class="keyword1"><span class="command">have</span></span> d_range_in_part'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d_range</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> build_ip_partition_same_fw<span class="main">[</span><span class="operator">OF</span> s_range_in_part'<span class="main">,</span> <span class="operator">unfolded</span> same_fw_behaviour_one_def<span class="main">]</span> s
                                                        <span class="quoted"><span class="quoted">‹<span class="free">s_repr</span> <span class="main">∈</span> wordinterval_to_set <span class="free">s_range</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> runFw <span class="free">s_repr</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="free">s</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> repr_Allow <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"runFw <span class="free">s</span> <span class="free">d_repr</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> build_ip_partition_same_fw<span class="main">[</span><span class="operator">OF</span> d_range_in_part'<span class="main">,</span> <span class="operator">unfolded</span> same_fw_behaviour_one_def<span class="main">]</span> d
                                                        <span class="quoted"><span class="quoted">‹<span class="free">d_repr</span> <span class="main">∈</span> wordinterval_to_set <span class="free">d_range</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="free">d_repr</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> runFw <span class="bound">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"runFw <span class="free">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Service_Matrix-distinct_map_getOneIp_obtain"><span class="command">lemma</span></span> distinct_map_getOneIp_obtain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span>map getOneIp <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">∃</span><span class="bound">s_repr</span><span class="main">.</span> map_of <span class="main">(</span>zip <span class="main">(</span>map getOneIp <span class="free">xs</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="bound">s_repr</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">with</span></span> Cons.IH Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s_repr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      s_repr<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>zip <span class="main">(</span>map getOneIp <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">s_repr</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">s_repr</span> <span class="main">≠</span> getOneIp <span class="skolem">x</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> Cons.prems s_repr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s_repr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Cons.prems s_repr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_set_zipE<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Service_Matrix-access_matrix_complete"><span class="command">lemma</span></span> access_matrix_complete<span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> matrix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">E</span><span class="main">)</span> <span class="main">=</span> access_matrix <span class="free">c</span> <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
              allow<span class="main">:</span> <span class="quoted"><span class="quoted">"runFw <span class="free">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s_repr</span> <span class="bound">d_repr</span> <span class="bound">s_range</span> <span class="bound">d_range</span><span class="main">.</span> <span class="main">(</span><span class="bound">s_repr</span><span class="main">,</span> <span class="bound">d_repr</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">E</span> <span class="main">∧</span>
              <span class="main">(</span>map_of <span class="free">V</span><span class="main">)</span> <span class="bound">s_repr</span> <span class="main">=</span> Some <span class="bound">s_range</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">∈</span> wordinterval_to_set <span class="bound">s_range</span> <span class="main">∧</span>
              <span class="main">(</span>map_of <span class="free">V</span><span class="main">)</span> <span class="bound">d_repr</span> <span class="main">=</span> Some <span class="bound">d_range</span> <span class="main">∧</span> <span class="free">d</span> <span class="main">∈</span> wordinterval_to_set <span class="bound">d_range</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?part</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> zip <span class="main">(</span>map getOneIp <span class="var">?part</span><span class="main">)</span> <span class="var">?part</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> matrix <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> access_matrix_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">←</span>all_pairs <span class="main">(</span>map getOneIp <span class="var">?part</span><span class="main">)</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="bound">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalAllow<span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> matrix <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> access_matrix_def Let_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> build_ip_partition_obtain<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">V</span><span class="main">.</span> <span class="bound">V</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">∈</span> wordinterval_to_set <span class="bound">V</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command">using</span></span> build_ip_partition_complete <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> distinct_map_getOneIp_build_ip_partition_obtain<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">⟹</span>
           <span class="main">∃</span><span class="bound">s_repr</span><span class="main">.</span> map_of <span class="main">(</span>zip <span class="main">(</span>map getOneIp <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="bound">s_repr</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">erule</span> distinct_map_getOneIp_obtain<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map getOneIp <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> map_getOneIp_distinct<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> build_ip_partition_distinct' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> build_ip_partition_disjoint build_ip_partition_distinct' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> build_ip_partition_no_empty_elems<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">from</span></span> build_ip_partition_obtain <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s_range</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s_range</span> <span class="main">∈</span> set <span class="var">?part</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> wordinterval_to_set <span class="skolem">s_range</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> this distinct_map_getOneIp_build_ip_partition_obtain V <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s_repr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      ex_s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_of <span class="free">V</span><span class="main">)</span> <span class="skolem">s_repr</span> <span class="main">=</span> Some <span class="skolem">s_range</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ex_s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> wordinterval_to_set <span class="skolem">s_range</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


    <span class="keyword1"><span class="command">from</span></span> build_ip_partition_obtain <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d_range</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">d_range</span> <span class="main">∈</span> set <span class="var">?part</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> wordinterval_to_set <span class="skolem">d_range</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> this distinct_map_getOneIp_build_ip_partition_obtain V <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d_repr</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      ex_d1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_of <span class="free">V</span><span class="main">)</span> <span class="skolem">d_repr</span> <span class="main">=</span> Some <span class="skolem">d_range</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ex_d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> wordinterval_to_set <span class="skolem">d_range</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s_repr</span> <span class="main">∈</span> getOneIp <span class="main">`</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> V <span class="quoted"><span class="quoted">‹map_of <span class="free">V</span> <span class="skolem">s_repr</span> <span class="main">=</span> Some <span class="skolem">s_range</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_set_zipE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d_repr</span> <span class="main">∈</span> getOneIp <span class="main">`</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> V <span class="quoted"><span class="quoted">‹map_of <span class="free">V</span> <span class="skolem">d_repr</span> <span class="main">=</span> Some <span class="skolem">d_range</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_set_zipE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"runFw <span class="skolem">s_repr</span> <span class="skolem">d_repr</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">w</span> <span class="bound">wa</span> <span class="bound">p</span> <span class="bound">ss</span><span class="main">.</span> <span class="main">¬</span> same_fw_behaviour_one <span class="bound">w</span> <span class="bound">wa</span> <span class="main">(</span><span class="bound">p</span><span class="main">::</span>parts_connection<span class="main">)</span> <span class="bound">ss</span> <span class="main">∨</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">wb</span> <span class="bound">wc</span><span class="main">.</span> runFw <span class="bound">w</span> <span class="bound">wb</span> <span class="bound">p</span> <span class="bound">ss</span> <span class="main">=</span> runFw <span class="bound">wa</span> <span class="bound">wb</span> <span class="bound">p</span> <span class="bound">ss</span> <span class="main">∧</span> runFw <span class="bound">wc</span> <span class="bound">w</span> <span class="bound">p</span> <span class="bound">ss</span> <span class="main">=</span> runFw <span class="bound">wc</span> <span class="bound">wa</span> <span class="bound">p</span> <span class="bound">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">w</span> <span class="bound">wa</span> <span class="bound">p</span> <span class="bound">ss</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">wb</span> <span class="bound">wc</span><span class="main">.</span> runFw <span class="bound">w</span> <span class="bound">wb</span> <span class="main">(</span><span class="bound">p</span><span class="main">::</span>parts_connection<span class="main">)</span> <span class="bound">ss</span> <span class="main">≠</span> runFw <span class="bound">wa</span> <span class="bound">wb</span> <span class="bound">p</span> <span class="bound">ss</span> <span class="main">∨</span> runFw <span class="bound">wc</span> <span class="bound">w</span> <span class="bound">p</span> <span class="bound">ss</span> <span class="main">≠</span> runFw <span class="bound">wc</span> <span class="bound">wa</span> <span class="bound">p</span> <span class="bound">ss</span><span class="main">)</span> <span class="main">∨</span>
              same_fw_behaviour_one <span class="bound">w</span> <span class="bound">wa</span> <span class="bound">p</span> <span class="bound">ss</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> same_fw_behaviour_one_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s_range</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>›</span></span>  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"same_fw_behaviour_one <span class="free">s</span> <span class="skolem">s_repr</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> map_of_zip_map V build_ip_partition_no_empty_elems
            build_ip_partition_same_fw ex_s1 ex_s2 getOneIp_elem wordinterval_element_set_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d_range</span> <span class="main">∈</span> set <span class="main">(</span>build_ip_partition <span class="free">c</span> <span class="free">rs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"same_fw_behaviour_one <span class="skolem">d_repr</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> map_of_zip_map V build_ip_partition_no_empty_elems
            build_ip_partition_same_fw ex_d1 ex_d2 getOneIp_elem wordinterval_element_set_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> f1 f2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> allow <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
      
    <span class="keyword1"><span class="command">hence</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s_repr</span><span class="main">,</span> <span class="skolem">d_repr</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> E all_pairs_set 1 2<span class="main">)</span>
    
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ex1 ex_s1 ex_s2 ex_d1 ex_d2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> access_matrix<span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span><span class="main">::</span>len simple_rule list"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> matrix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">E</span><span class="main">)</span> <span class="main">=</span> access_matrix <span class="free">c</span> <span class="free">rs</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">s_repr</span> <span class="bound">d_repr</span> <span class="bound">s_range</span> <span class="bound">d_range</span><span class="main">.</span> <span class="main">(</span><span class="bound">s_repr</span><span class="main">,</span> <span class="bound">d_repr</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">E</span> <span class="main">∧</span>
              <span class="main">(</span>map_of <span class="free">V</span><span class="main">)</span> <span class="bound">s_repr</span> <span class="main">=</span> Some <span class="bound">s_range</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">∈</span> wordinterval_to_set <span class="bound">s_range</span> <span class="main">∧</span>
              <span class="main">(</span>map_of <span class="free">V</span><span class="main">)</span> <span class="bound">d_repr</span> <span class="main">=</span> Some <span class="bound">d_range</span> <span class="main">∧</span> <span class="free">d</span> <span class="main">∈</span> wordinterval_to_set <span class="bound">d_range</span><span class="main">)</span>
             <span class="main">⟷</span>
             runFw <span class="free">s</span> <span class="free">d</span> <span class="free">c</span> <span class="free">rs</span> <span class="main">=</span> Decision FinalAllow"</span></span>
<span class="keyword1"><span class="command">using</span></span> matrix access_matrix_sound access_matrix_complete <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
For a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'i</span></span><span class="main"><span class="main">::</span></span>len simple_rule list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a fixed <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">parts_connection</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
we support to partition the IP address space; for IP addresses of arbitrary length (eg., IPv4, IPv6).

All members of a partition have the same access rights:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> build_ip_partition_same_fw <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

Minimal:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> build_ip_partition_same_fw_min <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>


The resulting access control matrix is sound and complete:

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> access_matrix <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

Theorem reads: 
For a fixed connection, you can look up IP addresses (source and destination pairs) in the matrix 
if and only if the firewall accepts this src,dst IP address pair for the fixed connection.
Note: The matrix is actually a graph (nice visualization!), you need to look up IP addresses 
in the Vertices and check the access of the representants in the edges. If you want to visualize
the graph (e.g. with Graphviz or tkiz): The vertices are the node description (i.e. header; 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dom <span class="free"><span class="free">V</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the label for each node which will also be referenced in the edges,
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ran <span class="free"><span class="free">V</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the human-readable description for each node (i.e. the full IP range it represents)), 
the edges are the edges. Result looks nice. Theorem also tells us that this visualization is correct.
›</span></span>




<span class="comment1">(*construct an ip partition and print it in some usable format
  returns:
  (vertices, edges) where
  vertices = (name, list of ip addresses this vertex corresponds to)
  and edges = (name × name) list

  Note that the WordInterval is already sorted, which is important for prettyness!
*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Only defined for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> simple_firewall_without_interfaces<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">access_matrix_pretty_ipv4</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"parts_connection <span class="main">⇒</span> <span class="numeral">32</span> simple_rule list <span class="main">⇒</span> <span class="main">(</span>string <span class="main">×</span> string<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span>string <span class="main">×</span> string<span class="main">)</span> list"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">access_matrix_pretty_ipv4</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> <span class="main">¬</span> simple_firewall_without_interfaces <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="keyword1">then</span> undefined <span class="keyword1">else</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">E</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>access_matrix <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main">;</span>
         <span class="bound">formatted_nodes</span> <span class="main">=</span>
              map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v_repr</span><span class="main">,</span> <span class="bound">v_range</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>ipv4addr_toString <span class="bound">v_repr</span><span class="main">,</span> ipv4addr_wordinterval_toString <span class="bound">v_range</span><span class="main">)</span><span class="main">)</span> <span class="bound">V</span><span class="main">;</span>
         <span class="bound">formatted_edges</span> <span class="main">=</span>
              map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>ipv4addr_toString <span class="bound">s</span><span class="main">,</span> ipv4addr_toString <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="bound">E</span>
     <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">formatted_nodes</span><span class="main">,</span> <span class="bound">formatted_edges</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">access_matrix_pretty_ipv4_code</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"parts_connection <span class="main">⇒</span> <span class="numeral">32</span> simple_rule list <span class="main">⇒</span> <span class="main">(</span>string <span class="main">×</span> string<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span>string <span class="main">×</span> string<span class="main">)</span> list"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">access_matrix_pretty_ipv4_code</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> <span class="main">¬</span> simple_firewall_without_interfaces <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="keyword1">then</span> undefined <span class="keyword1">else</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">W</span> <span class="main">=</span> build_ip_partition <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">;</span>
         <span class="bound">R</span> <span class="main">=</span> map getOneIp <span class="bound">W</span><span class="main">;</span>
         <span class="bound">U</span> <span class="main">=</span> all_pairs <span class="bound">R</span>
     <span class="keyword1">in</span>
     <span class="main">(</span>zip <span class="main">(</span>map ipv4addr_toString <span class="bound">R</span><span class="main">)</span> <span class="main">(</span>map ipv4addr_wordinterval_toString <span class="bound">W</span><span class="main">)</span><span class="main">,</span> 
      map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>ipv4addr_toString <span class="bound">x</span><span class="main">,</span> ipv4addr_toString <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">←</span>all_pairs <span class="bound">R</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> Decision FinalAllow<span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Service_Matrix-access_matrix_pretty_ipv4_code"><span class="command">lemma</span></span> access_matrix_pretty_ipv4_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"access_matrix_pretty_ipv4 <span class="main">=</span> access_matrix_pretty_ipv4_code"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff access_matrix_pretty_ipv4_def access_matrix_pretty_ipv4_code_def Let_def access_matrix_def map_prod_fun_zip<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">access_matrix_pretty_ipv6</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"parts_connection <span class="main">⇒</span> <span class="numeral">128</span> simple_rule list <span class="main">⇒</span> <span class="main">(</span>string <span class="main">×</span> string<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span>string <span class="main">×</span> string<span class="main">)</span> list"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">access_matrix_pretty_ipv6</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> <span class="main">¬</span> simple_firewall_without_interfaces <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="keyword1">then</span> undefined <span class="keyword1">else</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">E</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>access_matrix <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main">;</span>
         <span class="bound">formatted_nodes</span> <span class="main">=</span>
              map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v_repr</span><span class="main">,</span> <span class="bound">v_range</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>ipv6addr_toString <span class="bound">v_repr</span><span class="main">,</span> ipv6addr_wordinterval_toString <span class="bound">v_range</span><span class="main">)</span><span class="main">)</span> <span class="bound">V</span><span class="main">;</span>
         <span class="bound">formatted_edges</span> <span class="main">=</span>
              map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>ipv6addr_toString <span class="bound">s</span><span class="main">,</span> ipv6addr_toString <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="bound">E</span>
     <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">formatted_nodes</span><span class="main">,</span> <span class="bound">formatted_edges</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">access_matrix_pretty_ipv6_code</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"parts_connection <span class="main">⇒</span> <span class="numeral">128</span> simple_rule list <span class="main">⇒</span> <span class="main">(</span>string <span class="main">×</span> string<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span>string <span class="main">×</span> string<span class="main">)</span> list"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">access_matrix_pretty_ipv6_code</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> <span class="main">¬</span> simple_firewall_without_interfaces <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="keyword1">then</span> undefined <span class="keyword1">else</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">W</span> <span class="main">=</span> build_ip_partition <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">;</span>
         <span class="bound">R</span> <span class="main">=</span> map getOneIp <span class="bound">W</span><span class="main">;</span>
         <span class="bound">U</span> <span class="main">=</span> all_pairs <span class="bound">R</span>
     <span class="keyword1">in</span>
     <span class="main">(</span>zip <span class="main">(</span>map ipv6addr_toString <span class="bound">R</span><span class="main">)</span> <span class="main">(</span>map ipv6addr_wordinterval_toString <span class="bound">W</span><span class="main">)</span><span class="main">,</span> 
      map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>ipv6addr_toString <span class="bound">x</span><span class="main">,</span> ipv6addr_toString <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">←</span>all_pairs <span class="bound">R</span><span class="main">.</span> runFw <span class="bound">s</span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> Decision FinalAllow<span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Service_Matrix-access_matrix_pretty_ipv6_code"><span class="command">lemma</span></span> access_matrix_pretty_ipv6_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"access_matrix_pretty_ipv6 <span class="main">=</span> access_matrix_pretty_ipv6_code"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff access_matrix_pretty_ipv6_def access_matrix_pretty_ipv6_code_def Let_def access_matrix_def map_prod_fun_zip<span class="main">)</span>

  

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parts_connection_ssh</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parts_connection_ssh</span> <span class="main">≡</span> <span class="main">⦇</span>pc_iiface<span class="main">=</span><span class="inner_quoted">''1''</span><span class="main">,</span> pc_oiface<span class="main">=</span><span class="inner_quoted">''1''</span><span class="main">,</span> pc_proto<span class="main">=</span>TCP<span class="main">,</span> pc_sport<span class="main">=</span><span class="numeral">10000</span><span class="main">,</span> pc_dport<span class="main">=</span><span class="numeral">22</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parts_connection_http</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parts_connection_http</span> <span class="main">≡</span> <span class="main">⦇</span>pc_iiface<span class="main">=</span><span class="inner_quoted">''1''</span><span class="main">,</span> pc_oiface<span class="main">=</span><span class="inner_quoted">''1''</span><span class="main">,</span> pc_proto<span class="main">=</span>TCP<span class="main">,</span> pc_sport<span class="main">=</span><span class="numeral">10000</span><span class="main">,</span> pc_dport<span class="main">=</span><span class="numeral">80</span><span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_parts_connection_TCP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">16</span> word <span class="main">⇒</span> <span class="numeral">16</span> word <span class="main">⇒</span> parts_connection"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_parts_connection_TCP</span> <span class="free"><span class="bound"><span class="entity">sport</span></span></span> <span class="free"><span class="bound"><span class="entity">dport</span></span></span> <span class="main">=</span> <span class="main">⦇</span>pc_iiface<span class="main">=</span><span class="inner_quoted">''1''</span><span class="main">,</span> pc_oiface<span class="main">=</span><span class="inner_quoted">''1''</span><span class="main">,</span> pc_proto<span class="main">=</span>TCP<span class="main">,</span>
                               pc_sport<span class="main">=</span><span class="free"><span class="bound"><span class="entity">sport</span></span></span><span class="main">,</span> pc_dport<span class="main">=</span><span class="free"><span class="bound"><span class="entity">dport</span></span></span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"mk_parts_connection_TCP <span class="numeral">10000</span> <span class="numeral">22</span> <span class="main">=</span> parts_connection_ssh"</span></span>
      <span class="quoted"><span class="quoted">"mk_parts_connection_TCP <span class="numeral">10000</span> <span class="numeral">80</span> <span class="main">=</span> parts_connection_http"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_parts_connection_TCP_def parts_connection_ssh_def parts_connection_http_def<span class="main">)</span>


<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>code<span class="main">]</span> <span class="quoted"><span class="quoted">"partitioningIps <span class="main">[</span>WordInterval <span class="main">(</span><span class="main">0</span><span class="main">::</span>ipv4addr<span class="main">)</span> <span class="main">0</span><span class="main">]</span> <span class="main">[</span>WordInterval <span class="main">0</span> <span class="numeral">2</span><span class="main">,</span> WordInterval <span class="main">0</span> <span class="numeral">2</span><span class="main">]</span>"</span></span>


<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
Here is an example of a really large and complicated firewall:


\begin{figure}
\centering
\resizebox{\linewidth}{!}{%
\tikzset{every loop/.style={looseness=1}}
\tikzset{myptr/.style={decoration={markings,mark=at position 1 with %
    {\arrow[scale=2,&gt;=latex]{&gt;}}},shorten &gt;=0.1cm,shorten &lt;=0.2cm, postaction={decorate}}}%
\tikzset{myloop/.style={-to}}%
\begin{tikzpicture}
\node (m) at (2,-2) {$\{224.0.0.0 .. 239.255.255.255\}$};

\node[align=left] (inet) at (-3,8.5) {$\{0.0.0.0 .. 126.255.255.255\} \cup \{128.0.0.0 .. 131.159.13.255\} \cup $ \\ 
									 $ \{131.159.16.0 .. 131.159.19.255\} \cup \{131.159.22.0 .. 138.246.253.4\} \cup $ \\ 
									 $ \{138.246.253.11 .. 185.86.231.255\} \cup \{185.86.236.0 .. 188.1.239.85\} \cup $ \\ 
									 $ \{188.1.239.87 .. 188.95.232.63\} \cup \{188.95.232.224 .. 188.95.232.255\} \cup $\\
									 $ \{188.95.240.0 .. 192.48.106.255\} \cup \{192.48.108.0 .. 223.255.255.255\} \cup $\\
									 $ \{240.0.0.0 .. 255.255.255.255\}$};
\node[align=left] (internal) at (-5,-10) {$\{131.159.14.0 .. 131.159.14.7\} \cup \{131.159.14.12 .. 131.159.14.25\} \cup $ \\ 
$ 131.159.14.27 \cup \{131.159.14.29 .. 131.159.14.33\} \cup $ \\ 
$ \{131.159.14.38 .. 131.159.14.39\} \cup 131.159.14.41 \cup $ \\ 
$ \{131.159.14.43 .. 131.159.14.51\} \cup \{131.159.14.53 .. 131.159.14.55\} \cup $ \\ 
$ \{131.159.14.57 .. 131.159.14.59\} \cup \{131.159.14.61 .. 131.159.14.68\} \cup $ \\ 
$ 131.159.14.70 .. 131.159.14.82\} \cup \{131.159.14.84 .. 131.159.14.103\} \cup $ \\ 
$ \{131.159.14.105 .. 131.159.14.124\} \cup \{131.159.14.126 .. 131.159.14.136\} \cup $ \\  
$ \{131.159.14.138 .. 131.159.14.139\} \cup \{131.159.14.141 .. 131.159.14.144\} \cup $ \\ 
$ \{131.159.14.147 .. 131.159.14.154\} \cup \{131.159.14.157 .. 131.159.14.162\} \cup $ \\ 
$ \{131.159.14.164 .. 131.159.14.168\} \cup \{131.159.14.170 .. 131.159.14.200\} \cup $ \\ 
$ \{131.159.14.202 .. 131.159.14.213\} \cup \{131.159.14.215 .. 131.159.15.4\} \cup $ \\ 
$ 131.159.15.6 \cup \{131.159.15.14 .. 131.159.15.15\} \cup $ \\ 
$ \{131.159.15.21 .. 131.159.15.22\} \cup 131.159.15.26 \cup 131.159.15.28 \cup $ \\ 
$ 131.159.15.30 \cup \{131.159.15.33 .. 131.159.15.35\} \cup $ \\ 
$ \{131.159.15.37 .. 131.159.15.38\} \cup 131.159.15.40 \cup $ \\ 
$ \{131.159.15.45 .. 131.159.15.46\} \cup \{131.159.15.48 .. 131.159.15.49\} \cup $ \\ 
$ \{131.159.15.52 .. 131.159.15.55\} \cup 131.159.15.57 \cup 131.159.15.59 \cup $ \\ 
$ \{131.159.15.61 .. 131.159.15.67\} \cup \{131.159.15.70 .. 131.159.15.196\} \cup $ \\ 
$ \{131.159.15.198 .. 131.159.15.227\} \cup \{131.159.15.229 .. 131.159.15.233\} \cup $ \\ 
$ \{131.159.15.235 .. 131.159.15.246\} \cup \{131.159.15.250 .. 131.159.15.255\} \cup $ \\ 
$ \{131.159.20.0 .. 131.159.20.20\} \cup \{131.159.20.22 .. 131.159.20.28\} \cup $ \\ 
$ \{131.159.20.30 .. 131.159.20.35\} \cup \{131.159.20.37 .. 131.159.20.44\} \cup $ \\ 
$ \{131.159.20.46 .. 131.159.20.51\} \cup \{131.159.20.53 .. 131.159.20.58\} \cup $ \\ 
$ \{131.159.20.60 .. 131.159.20.62\} \cup \{131.159.20.64 .. 131.159.20.70\} \cup $ \\ 
$ \{131.159.20.72 .. 131.159.20.73\} \cup \{131.159.20.75 .. 131.159.20.84\} \cup $ \\ 
$ \{131.159.20.86 .. 131.159.20.96\} \cup \{131.159.20.98 .. 131.159.20.119\} \cup $ \\ 
$ \{131.159.20.121 .. 131.159.20.138\} \cup \{131.159.20.140 .. 131.159.20.149\} \cup $ \\ 
$ \{131.159.20.152 .. 131.159.20.154\} \cup \{131.159.20.156 .. 131.159.20.159\} \cup $ \\ 
$ \{131.159.20.161 .. 131.159.20.164\} \cup \{131.159.20.167 .. 131.159.20.179\} \cup $ \\ 
$ \{131.159.20.181 .. 131.159.20.184\} \cup \{131.159.20.186 .. 131.159.20.199\} \cup $ \\ 
$ \{131.159.20.201 .. 131.159.20.232\} \cup \{131.159.20.235 .. 131.159.20.255\} \cup $ \\ 
$ \{185.86.232.0 .. 185.86.235.255\} \cup \{188.95.233.0 .. 188.95.233.3\} \cup $ \\ 
$ \{188.95.233.5 .. 188.95.233.8\} \cup \{188.95.233.10 .. 188.95.233.255\} \cup $ \\ 
$ \{192.48.107.0 .. 192.48.107.255\}$}; 

\node[align=left] (srvs) at (10,0) {$\{131.159.14.8 .. 131.159.14.11\} \cup 131.159.14.26 \cup 131.159.14.28 \cup $ \\ 
$ \{131.159.14.34 .. 131.159.14.37\} \cup 131.159.14.40 \cup 131.159.14.42 \cup $ \\ 
$ 131.159.14.52 \cup 131.159.14.56 \cup 131.159.14.60 \cup 131.159.14.69 \cup $ \\ 
$ 131.159.14.83 \cup 131.159.14.104 \cup 131.159.14.125 \cup 131.159.14.137 \cup $ \\ 
$ 131.159.14.140 \cup \{131.159.14.145 .. 131.159.14.146\} \cup $ \\ 
$ \{131.159.14.155 .. 131.159.14.156\} \cup 131.159.14.163 \cup 131.159.14.169 \cup $ \\ 
$ 131.159.14.201 \cup 131.159.14.214 \cup 131.159.15.5 \cup $ \\ 
$ \{131.159.15.7 .. 131.159.15.13\} \cup \{131.159.15.16 .. 131.159.15.20\} \cup $ \\ 
$ \{131.159.15.23 .. 131.159.15.25\} \cup 131.159.15.27 \cup 131.159.15.29 \cup $ \\ 
$ \{131.159.15.31 .. 131.159.15.32\} \cup 131.159.15.36 \cup 131.159.15.39 \cup $ \\ 
$ \{131.159.15.41 .. 131.159.15.44\} \cup 131.159.15.47 \cup 131.159.15.51 \cup $ \\ 
$ 131.159.15.56 \cup 131.159.15.58 \cup 131.159.15.60 \cup $ \\ 
$ \{131.159.15.68 .. 131.159.15.69\} \cup 131.159.15.197 \cup 131.159.15.228 \cup $ \\ 
$ 131.159.15.234 \cup \{131.159.15.247 .. 131.159.15.249\} \cup 131.159.20.21 \cup $ \\ 
$ 131.159.20.29 \cup 131.159.20.36 \cup 131.159.20.45 \cup 131.159.20.52 \cup $ \\ 
$ 131.159.20.59 \cup 131.159.20.63 \cup 131.159.20.71 \cup 131.159.20.74 \cup $ \\ 
$ 131.159.20.85 \cup 131.159.20.97 \cup 131.159.20.120 \cup 131.159.20.139 \cup $ \\ 
$ \{131.159.20.150 .. 131.159.20.151\} \cup 131.159.20.155 \cup 131.159.20.160 \cup $ \\ 
$ \{131.159.20.165 .. 131.159.20.166\} \cup 131.159.20.180 \cup 131.159.20.185 \cup $ \\ 
$ 131.159.20.200 \cup \{131.159.20.233 .. 131.159.20.234\} \cup $ \\ 
$ \{131.159.21.0 .. 131.159.21.255\} \cup \{188.95.232.192 .. 188.95.232.223\} \cup $ \\ 
$ 188.95.233.4 \cup 188.95.233.9 \cup \{188.95.234.0 .. 188.95.239.255\}$}; 

\node[align=left] (ips1) at (-3,-1) {$188.1.239.86 \cup \{188.95.232.64 .. 188.95.232.191\}$};

\node[align=left] (ips2) at (10,-8) {$\{138.246.253.6 .. 138.246.253.10\}$};

\node[align=left] (ip3) at (5,-6) {$138.246.253.5$};

\node[align=left] (ip4) at (4.5,-8) {$131.159.15.50$};

\node[align=left] (l) at (8,-10) {$\{127.0.0.0 .. 127.255.255.255\}$};



\draw[myloop] (m) to[loop above] (m);
\draw[myptr] (m) to (srvs);
\draw[myptr] (inet) to (m);
\draw[myptr] (inet) to (srvs);
\draw[myptr,shorten &lt;=-0.8cm] (internal) to (m);
\draw[myptr] (internal) to (inet);
\draw[myloop] (internal) to[loop above] (internal);
\draw[myptr] (internal) to (srvs);
\draw[myptr] (internal) to (ips1);
\draw[myptr] (internal) to (ips2);
\draw[myptr] (internal) to (ip3);
\draw[myptr] (internal) to (ip4);
\draw[myptr] (internal) to (l);
\draw[myptr] (srvs) to (m);
\draw[myptr] (srvs) to (inet);
\draw[myptr] (srvs) to (internal);
\draw[myloop] (srvs) to[loop above] (srvs);
\draw[myptr] (srvs) to (ips1);
\draw[myptr] (srvs) to (ips2);
\draw[myptr] (srvs) to (ip3);
\draw[myptr] (srvs) to (ip4);
\draw[myptr] (srvs) to (l);
\draw[myptr] (ips1) to (m);
\draw[myptr] (ips1) to (inet);
\draw[myptr] (ips1) to (internal);
\draw[myptr] (ips1) to (srvs);
\draw[myloop] (ips1.west) to[loop left] (ips1);
\draw[myptr] (ips1) to (ips2);
\draw[myptr] (ips1) to (ip3);
\draw[myptr] (ips1) to (ip4);
\draw[myptr] (ips1) to (l);
\draw[myptr] (ips2) to (m);
\draw[myptr] (ips2) to (srvs);
\draw[myptr] (ips2) to (ip4);
\draw[myptr] (ip3) to (m);
\draw[myptr] (ip3) to (internal);
\draw[myptr] (ip3) to (srvs);
\draw[myptr] (ip3) to (ip4);
\draw[myptr] (ip4) to (m);
\draw[myptr] (ip4) to (inet);
\draw[myptr] (ip4) to (internal);
\draw[myptr] (ip4) to (srvs);
\draw[myptr] (ip4) to (ips1);
\draw[myptr] (ip4) to (ips2);
\draw[myptr] (ip4) to (ip3);
\draw[myloop] (ip4) to[loop below] (ip4);
\draw[myptr] (ip4) to (l);

\end{tikzpicture}%
}
\caption{TUM ssh Service Matrix}
\label{fig:tumssh}
\end{figure}

›</span></span>


<span class="keyword2"><span class="keyword">end</span></span>                            
</pre>
</div><div id="SimpleFw_toString">
<div class="head">
<h1>Theory SimpleFw_toString</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Simple Firewall toString Functions›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SimpleFw_toString
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Primitives_toString.html">Primitives/Primitives_toString</a>"</span>
        <a href="SimpleFw_Syntax.html">SimpleFw_Syntax</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_action_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"simple_action <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simple_action_toString</span> Accept <span class="main">=</span> <span class="inner_quoted">''ACCEPT''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">simple_action_toString</span> Drop <span class="main">=</span> <span class="inner_quoted">''DROP''</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_rule_ipv4_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">32</span> simple_rule <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simple_rule_ipv4_toString</span> <span class="main">(</span>SimpleRule <span class="main">⦇</span>iiface<span class="main">=</span><span class="free"><span class="bound"><span class="entity">iif</span></span></span><span class="main">,</span> oiface<span class="main">=</span><span class="free"><span class="bound"><span class="entity">oif</span></span></span><span class="main">,</span> src<span class="main">=</span><span class="free"><span class="bound"><span class="entity">sip</span></span></span><span class="main">,</span> dst<span class="main">=</span><span class="free"><span class="bound"><span class="entity">dip</span></span></span><span class="main">,</span> proto<span class="main">=</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> sports<span class="main">=</span><span class="free"><span class="bound"><span class="entity">sps</span></span></span><span class="main">,</span> dports<span class="main">=</span><span class="free"><span class="bound"><span class="entity">dps</span></span></span> <span class="main">⦈</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> 
      simple_action_toString <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">@</span> <span class="inner_quoted">''     ''</span> <span class="main">@</span> 
      protocol_toString <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">@</span> <span class="inner_quoted">''  --  ''</span> <span class="main">@</span> 
      ipv4_cidr_toString <span class="free"><span class="bound"><span class="entity">sip</span></span></span> <span class="main">@</span> <span class="inner_quoted">''            ''</span> <span class="main">@</span>
      ipv4_cidr_toString <span class="free"><span class="bound"><span class="entity">dip</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' ''</span> <span class="main">@</span> 
      iface_toString <span class="inner_quoted">''in: ''</span> <span class="free"><span class="bound"><span class="entity">iif</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' ''</span> <span class="main">@</span> 
      iface_toString <span class="inner_quoted">''out: ''</span> <span class="free"><span class="bound"><span class="entity">oif</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' ''</span> <span class="main">@</span> 
      ports_toString <span class="inner_quoted">''sports: ''</span> <span class="free"><span class="bound"><span class="entity">sps</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' ''</span> <span class="main">@</span> 
      ports_toString <span class="inner_quoted">''dports: ''</span> <span class="free"><span class="bound"><span class="entity">dps</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_rule_ipv6_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">128</span> simple_rule <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simple_rule_ipv6_toString</span>
    <span class="main">(</span>SimpleRule <span class="main">⦇</span>iiface<span class="main">=</span><span class="free"><span class="bound"><span class="entity">iif</span></span></span><span class="main">,</span> oiface<span class="main">=</span><span class="free"><span class="bound"><span class="entity">oif</span></span></span><span class="main">,</span> src<span class="main">=</span><span class="free"><span class="bound"><span class="entity">sip</span></span></span><span class="main">,</span> dst<span class="main">=</span><span class="free"><span class="bound"><span class="entity">dip</span></span></span><span class="main">,</span> proto<span class="main">=</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> sports<span class="main">=</span><span class="free"><span class="bound"><span class="entity">sps</span></span></span><span class="main">,</span> dports<span class="main">=</span><span class="free"><span class="bound"><span class="entity">dps</span></span></span> <span class="main">⦈</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> 
      simple_action_toString <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">@</span> <span class="inner_quoted">''     ''</span> <span class="main">@</span> 
      protocol_toString <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">@</span> <span class="inner_quoted">''  --  ''</span> <span class="main">@</span> 
      ipv6_cidr_toString <span class="free"><span class="bound"><span class="entity">sip</span></span></span> <span class="main">@</span> <span class="inner_quoted">''            ''</span> <span class="main">@</span>
      ipv6_cidr_toString <span class="free"><span class="bound"><span class="entity">dip</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' ''</span> <span class="main">@</span> 
      iface_toString <span class="inner_quoted">''in: ''</span> <span class="free"><span class="bound"><span class="entity">iif</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' ''</span> <span class="main">@</span> 
      iface_toString <span class="inner_quoted">''out: ''</span> <span class="free"><span class="bound"><span class="entity">oif</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' ''</span> <span class="main">@</span> 
      ports_toString <span class="inner_quoted">''sports: ''</span> <span class="free"><span class="bound"><span class="entity">sps</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' ''</span> <span class="main">@</span> 
      ports_toString <span class="inner_quoted">''dports: ''</span> <span class="free"><span class="bound"><span class="entity">dps</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_rule_iptables_save_toString</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="numeral">32</span> simple_rule <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simple_rule_iptables_save_toString</span> <span class="free"><span class="bound"><span class="entity">chain</span></span></span> <span class="main">(</span>SimpleRule <span class="main">⦇</span>iiface<span class="main">=</span><span class="free"><span class="bound"><span class="entity">iif</span></span></span><span class="main">,</span> oiface<span class="main">=</span><span class="free"><span class="bound"><span class="entity">oif</span></span></span><span class="main">,</span> src<span class="main">=</span><span class="free"><span class="bound"><span class="entity">sip</span></span></span><span class="main">,</span> dst<span class="main">=</span><span class="free"><span class="bound"><span class="entity">dip</span></span></span><span class="main">,</span> proto<span class="main">=</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> sports<span class="main">=</span><span class="free"><span class="bound"><span class="entity">sps</span></span></span><span class="main">,</span> dports<span class="main">=</span><span class="free"><span class="bound"><span class="entity">dps</span></span></span> <span class="main">⦈</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="inner_quoted">''-A ''</span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">chain</span></span></span><span class="main">@</span>iface_toString <span class="inner_quoted">'' -i ''</span> <span class="free"><span class="bound"><span class="entity">iif</span></span></span> <span class="main">@</span>
                  iface_toString <span class="inner_quoted">'' -o ''</span> <span class="free"><span class="bound"><span class="entity">oif</span></span></span> <span class="main">@</span>
                  ipv4_cidr_opt_toString <span class="inner_quoted">'' -s ''</span> <span class="free"><span class="bound"><span class="entity">sip</span></span></span> <span class="main">@</span>
                  ipv4_cidr_opt_toString <span class="inner_quoted">'' -d ''</span> <span class="free"><span class="bound"><span class="entity">dip</span></span></span> <span class="main">@</span>
                  protocol_opt_toString <span class="inner_quoted">'' -p ''</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">@</span>
                  ports_toString <span class="inner_quoted">'' --sport ''</span> <span class="free"><span class="bound"><span class="entity">sps</span></span></span> <span class="main">@</span>
                  ports_toString <span class="inner_quoted">'' --dport ''</span> <span class="free"><span class="bound"><span class="entity">dps</span></span></span> <span class="main">@</span>
                  <span class="inner_quoted">'' -j ''</span> <span class="main">@</span> simple_action_toString <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>