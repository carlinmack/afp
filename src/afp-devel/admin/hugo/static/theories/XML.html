<div id="Xml">
<div class="head">
<h1>Theory Xml</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     Xml
   Author:    Christian Sternagel
   Author:    René Thiemann
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Parsing and Printing XML Documents›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Xml
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Certification_Monads/Parser_Monad.html">Certification_Monads.Parser_Monad</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Char_ord.html">HOL-Library.Char_ord</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> xml <span class="main">=</span>
  <span class="comment1">― ‹node-name, attributes, child-nodes›</span>
  XML <span class="quoted">string</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string <span class="main">×</span> string<span class="main">)</span> list"</span></span> <span class="quoted"><span class="quoted">"xml list"</span></span> <span class="main">|</span>
  XML_text <span class="quoted">string</span>

<span class="keyword1"><span class="command">datatype</span></span> xmldoc <span class="main">=</span>
  <span class="comment1">― ‹header, body›</span>
  XMLDOC <span class="quoted"><span class="quoted">"string list"</span></span> <span class="main">(</span><span class="free"><span class="entity">root_node</span></span><span class="main">:</span> <span class="quoted">xml</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tag</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"xml <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tag</span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">tag</span> <span class="main">(</span>XML_text <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> tag

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">children</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"xml <span class="main">⇒</span> xml list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">children</span> <span class="main">(</span>XML <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">children</span> <span class="main">(</span>XML_text <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> children

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">num_children</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"xml <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">num_children</span> <span class="main">(</span>XML <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">num_children</span> <span class="main">(</span>XML_text <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> num_children


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Printing of XML Nodes and Documents›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> xml <span class="main">::</span> <span class="quoted"><span class="quoted">"show"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">shows_attr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">×</span> string <span class="main">⇒</span> shows"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shows_attr</span> <span class="free"><span class="bound"><span class="entity">av</span></span></span> <span class="main">=</span> shows <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">av</span></span></span><span class="main">)</span> <span class="keyword1">o</span> shows_string <span class="main">(</span><span class="inner_quoted">''=\"''</span> <span class="main">@</span> snd <span class="free"><span class="bound"><span class="entity">av</span></span></span> <span class="main">@</span> <span class="inner_quoted">''\"''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">shows_attrs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string <span class="main">×</span> string<span class="main">)</span> list <span class="main">⇒</span> shows"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shows_attrs</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="inner_quoted">'' ''</span> <span class="main">+#+</span> shows_attr <span class="bound">a</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">shows_XML_indent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> nat <span class="main">⇒</span> xml <span class="main">⇒</span> shows"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shows_XML_indent</span> <span class="free"><span class="bound"><span class="entity">ind</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="inner_quoted">''⏎''</span> <span class="main">+#+</span> <span class="free"><span class="bound"><span class="entity">ind</span></span></span> <span class="main">+#+</span> <span class="inner_quoted">''&lt;''</span> <span class="main">+#+</span> shows <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+@+</span> shows_attrs <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+@+</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> shows_string <span class="inner_quoted">''/&gt;''</span>
      <span class="keyword1">else</span> <span class="main">(</span>
        <span class="inner_quoted">''&gt;''</span> <span class="main">+#+</span>
          foldr <span class="main">(</span><span class="free">shows_XML_indent</span> <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="keyword1">CHR</span> <span class="inner_quoted">'' ''</span><span class="main">)</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ind</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+@+</span> <span class="inner_quoted">''⏎''</span> <span class="main">+#+</span> <span class="free"><span class="bound"><span class="entity">ind</span></span></span> <span class="main">+#+</span>
        <span class="inner_quoted">''&lt;/''</span> <span class="main">+#+</span> shows <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+@+</span> shows_string <span class="inner_quoted">''&gt;''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">shows_XML_indent</span> <span class="free"><span class="bound"><span class="entity">ind</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>XML_text <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> shows_string <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"shows_prec <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> shows_XML_indent <span class="inner_quoted">''''</span> <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"shows_list <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">::</span> xml list<span class="main">)</span> <span class="main">=</span> showsp_list shows_prec <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> shows_attr_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">+#+</span> shows_attr <span class="free">av</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">@</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">+#+</span> shows_attr <span class="free">av</span><span class="main">)</span> <span class="free">r</span> <span class="main">@</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> shows_attr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">av</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">show_law_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> shows_attrs_append <span class="main">[</span><span class="operator">show_law_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"shows_attrs <span class="free">as</span> <span class="main">(</span><span class="free">r</span> <span class="main">@</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> shows_attrs <span class="free">as</span> <span class="free">r</span> <span class="main">@</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> shows_attr_append <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shows_attrs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> append_xml'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"shows_XML_indent <span class="free">ind</span> <span class="free">i</span> <span class="free">xml</span> <span class="main">(</span><span class="free">r</span> <span class="main">@</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> shows_XML_indent <span class="free">ind</span> <span class="free">i</span> <span class="free">xml</span> <span class="free">r</span> <span class="main">@</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xml</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ind</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">show_law_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> shows_prec_xml_append <span class="main">[</span><span class="operator">show_law_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"shows_prec <span class="free">d</span> <span class="main">(</span><span class="free">xml</span><span class="main">::</span>xml<span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">@</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> shows_prec <span class="free">d</span> <span class="free">xml</span> <span class="free">r</span> <span class="main">@</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> shows_prec_xml_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> append_xml'<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">show_law_simps</span></span> shows_list_xml_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> xmldoc <span class="main">::</span> <span class="quoted"><span class="quoted">"show"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">shows_xmldoc</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shows_xmldoc</span> <span class="main">(</span>XMLDOC <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> shows_lines <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">o</span> shows_nl <span class="keyword1">o</span> shows <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"shows_prec <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">doc</span></span></span> <span class="main">=</span> shows_xmldoc <span class="free"><span class="bound"><span class="entity">doc</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"shows_list <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">::</span> xmldoc list<span class="main">)</span> <span class="main">=</span> showsp_list shows_prec <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> shows_prec_xmldoc_append <span class="main">[</span><span class="operator">show_law_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"shows_prec <span class="free">d</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>xmldoc<span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">@</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> shows_prec <span class="free">d</span> <span class="free">x</span> <span class="free">r</span> <span class="main">@</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shows_prec_xmldoc_def <span class="dynamic"><span class="dynamic">show_law_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">show_law_simps</span></span> shows_list_xmldoc_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹XML-Parsing›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parse_text</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string option parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parse_text</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">ts</span> <span class="main">←</span> many <span class="main">(</span><span class="main">(≠)</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&lt;''</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">text</span> <span class="main">=</span> trim <span class="bound">ts</span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">text</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> return None
    <span class="keyword1">else</span> return <span class="main">(</span>Some <span class="main">(</span>List.rev <span class="main">(</span>trim <span class="main">(</span>List.rev <span class="bound">text</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_parse_text <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser parse_text"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> parse_text_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parse_text_consumes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">ts</span> <span class="main">≠</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&lt;''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> parse<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_text <span class="free">ts</span> <span class="main">=</span> Inr <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">ts'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts'</span> <span class="main">&lt;</span> length <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">tss</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">tss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&lt;''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ts</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> parse <span class="main">=</span> parse <span class="main">[</span><span class="operator">unfolded</span> parse_text_def Let_def ts<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> parse <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="keyword2"><span class="keyword">where</span></span> many<span class="main">:</span> <span class="quoted"><span class="quoted">"many <span class="main">(</span><span class="main">(≠)</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&lt;''</span><span class="main">)</span> <span class="skolem">tss</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"many <span class="main">(</span><span class="main">(≠)</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&lt;''</span><span class="main">)</span> <span class="skolem">tss</span>"</span></span><span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> is_parser_many many <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">x2</span> <span class="main">≤</span> length <span class="skolem">tss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> parse many <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts'</span> <span class="main">≤</span> length <span class="skolem">x2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_def return_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> len <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ts <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parse_attribute_value</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parse_attribute_value</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    exactly <span class="main">[</span><span class="keyword1">CHR</span> <span class="inner_quoted">''\"''</span><span class="main">]</span><span class="main">;</span>
    <span class="bound">v</span> <span class="main">←</span> many <span class="main">(</span><span class="main">(≠)</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''\"''</span><span class="main">)</span><span class="main">;</span>
    exactly <span class="main">[</span><span class="keyword1">CHR</span> <span class="inner_quoted">''\"''</span><span class="main">]</span><span class="main">;</span>
    return <span class="bound">v</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_parse_attribute_value <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser parse_attribute_value"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> parse_attribute_value_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A list of characters that are considered to be "letters" for tag-names.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">letters</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"char list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">letters</span> <span class="main">=</span> <span class="inner_quoted">''abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789&amp;;:-''</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_letter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"char <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_letter</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∈</span> set letters"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_letter_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_letter <span class="free">c</span> <span class="main">⟷</span>
    <span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≤</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''z''</span> <span class="main">∨</span>
    <span class="keyword1">CHR</span> <span class="inner_quoted">''A''</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≤</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''Z''</span> <span class="main">∨</span>
    <span class="keyword1">CHR</span> <span class="inner_quoted">''0''</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≤</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''9''</span> <span class="main">∨</span>
    <span class="free">c</span> <span class="main">∈</span> set <span class="inner_quoted">''_&amp;;:-''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_letter_def letters_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">many_letters</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">many_letters</span> <span class="main">=</span> manyof letters"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> many_letters <span class="main">[</span><span class="operator">code</span><span class="main">,</span> <span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"many_letters <span class="main">=</span> many is_letter"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_letter_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> manyof_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parse_name</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parse_name</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">n</span> <span class="main">←</span> many_letters<span class="main">;</span>
    spaces<span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
      error <span class="main">(</span><span class="inner_quoted">''expected letter ''</span> <span class="main">@</span> letters <span class="main">@</span> <span class="inner_quoted">'' but first symbol is \"''</span> <span class="main">@</span> take <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">@</span> <span class="inner_quoted">''\"''</span><span class="main">)</span>
    <span class="keyword1">else</span> return <span class="bound">n</span>
  <span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_parse_name <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser parse_name"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_name <span class="skolem">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?exp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">n</span> <span class="main">←</span> many_letters<span class="main">;</span>
    spaces<span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
      error <span class="main">(</span><span class="inner_quoted">''expected letter ''</span> <span class="main">@</span> letters <span class="main">@</span> <span class="inner_quoted">'' but first symbol is \"''</span> <span class="main">@</span> take <span class="main">1</span> <span class="skolem">s</span> <span class="main">@</span> <span class="inner_quoted">''\"''</span><span class="main">)</span>
    <span class="keyword1">else</span> return <span class="bound">n</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> isp<span class="main">:</span> <span class="quoted"><span class="quoted">"is_parser <span class="var">?exp</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_name <span class="skolem">s</span> <span class="main">=</span> <span class="var">?exp</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parse_name_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> isp <span class="main">[</span><span class="operator">unfolded</span> is_parser_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> res <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id<span class="main"><span class="main">]</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">parse_attributes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string <span class="main">×</span> string<span class="main">)</span> list parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parse_attributes</span> <span class="main">[]</span> <span class="main">=</span> Error_Monad.return <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">parse_attributes</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∈</span> set <span class="inner_quoted">''/&gt;''</span> <span class="keyword1">then</span> Error_Monad.return <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">k</span> <span class="main">←</span> parse_name<span class="main">;</span>
      exactly <span class="inner_quoted">''=''</span><span class="main">;</span>
      <span class="bound">v</span> <span class="main">←</span> parse_attribute_value<span class="main">;</span>
      <span class="bound">atts</span> <span class="main">←</span> <span class="free">parse_attributes</span><span class="main">;</span>
      return <span class="main">(</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">#</span> <span class="bound">atts</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">parse_attributes</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>measure length<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">y</span> <span class="skolem">ts</span> <span class="skolem">ya</span> <span class="skolem">tsa</span> <span class="skolem">yb</span> <span class="skolem">tsb</span>
  <span class="keyword3"><span class="command">assume</span></span> pn<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_name <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> oo<span class="main">:</span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''=''</span> <span class="skolem">ts</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="skolem">tsa</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pav<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_attribute_value <span class="skolem">tsa</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="skolem">tsb</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">have</span></span> cp<span class="main">:</span> <span class="quoted"><span class="quoted">"is_cparser <span class="main">(</span>exactly <span class="inner_quoted">''=''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> cp <span class="main">[</span><span class="operator">unfolded</span> is_cparser_def<span class="main">]</span> oo <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span> <span class="main">&gt;</span> length <span class="skolem">tsa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> is_parser_parse_name <span class="main">[</span><span class="operator">unfolded</span> is_parser_def<span class="main">]</span> pn
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≥</span> length <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> is_parser_parse_attribute_value <span class="main">[</span><span class="operator">unfolded</span> is_parser_def<span class="main">]</span> pav
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">tsa</span> <span class="main">≥</span> length <span class="skolem">tsb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 3
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tsb</span><span class="main">,</span> <span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> measure length"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_parse_attributes <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser parse_attributes"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="skolem">x</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"parse_attributes <span class="skolem">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parse_attributes.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="inner_quoted">''/&gt;''</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> False 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y1</span></span> <span class="skolem"><span class="skolem">s1</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> pn<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_name <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">s1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"parse_name <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> False 2<span class="main">(</span>2<span class="main">)</span> pn <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y2</span></span> <span class="skolem"><span class="skolem">s2</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> oo<span class="main">:</span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''=''</span> <span class="skolem">s1</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y2</span><span class="main">,</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''=''</span> <span class="skolem">s1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> False 2<span class="main">(</span>2<span class="main">)</span> pn oo <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y3</span></span> <span class="skolem"><span class="skolem">s3</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> pav<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_attribute_value <span class="skolem">s2</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y3</span><span class="main">,</span> <span class="skolem">s3</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"parse_attribute_value <span class="skolem">s2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> False 2<span class="main">(</span>2<span class="main">)</span> pn oo pav <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y4</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> patts<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_attributes <span class="skolem">s3</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y4</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"parse_attributes <span class="skolem">s3</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_def bind_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">s3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False pn oo pav patts<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="skolem">s2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> is_parser_parse_attribute_value <span class="main">[</span><span class="operator">unfolded</span> is_parser_def<span class="main">]</span> pav <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="skolem">s1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_parser_exactly <span class="main">[</span><span class="operator">unfolded</span> is_parser_def<span class="main">]</span> oo <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> is_parser_parse_name <span class="main">[</span><span class="operator">unfolded</span> is_parser_def<span class="main">]</span> pn <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">function_internals</span><span class="main">]</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">parse_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"xml list parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parse_nodes</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> take <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="inner_quoted">''&lt;/''</span> <span class="keyword1">then</span> return <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> hd <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">≠</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&lt;''</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> parse_text<span class="main">;</span>
      <span class="bound">ns</span> <span class="main">←</span> <span class="free">parse_nodes</span><span class="main">;</span>
      return <span class="main">(</span>XML_text <span class="main">(</span>the <span class="bound">t</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ns</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
      exactly <span class="inner_quoted">''&lt;''</span><span class="main">;</span>
      <span class="bound">n</span> <span class="main">←</span> parse_name<span class="main">;</span>
      <span class="bound">atts</span> <span class="main">←</span> parse_attributes<span class="main">;</span>
      <span class="bound">e</span> <span class="main">←</span> oneof <span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span><span class="main">;</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">ts'</span><span class="main">.</span>
        <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">=</span> <span class="inner_quoted">''/&gt;''</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">cs</span> <span class="main">←</span> <span class="free">parse_nodes</span><span class="main">;</span>
          return <span class="main">(</span>XML <span class="bound">n</span> <span class="bound">atts</span> <span class="main">[]</span> <span class="main">#</span> <span class="bound">cs</span><span class="main">)</span>
        <span class="main">}</span><span class="main">)</span> <span class="bound">ts'</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">cs</span> <span class="main">←</span> <span class="free">parse_nodes</span><span class="main">;</span>
          exactly <span class="inner_quoted">''&lt;/''</span><span class="main">;</span>
          exactly <span class="bound">n</span><span class="main">;</span>
          exactly <span class="inner_quoted">''&gt;''</span><span class="main">;</span>
          <span class="bound">ns</span> <span class="main">←</span> <span class="free">parse_nodes</span><span class="main">;</span>
          return <span class="main">(</span>XML <span class="bound">n</span> <span class="bound">atts</span> <span class="bound">cs</span> <span class="main">#</span> <span class="bound">ns</span><span class="main">)</span>
        <span class="main">}</span><span class="main">)</span> <span class="bound">ts'</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parse_nodes_help<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parse_nodes_dom <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> parse_nodes <span class="free">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟶</span> length <span class="bound">r</span> <span class="main">≤</span> length <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prop</span> <span class="free">s</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?prop</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> r <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"measure length"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> measure length <span class="main">⟶</span> <span class="var">?prop</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ind1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span><span class="main">.</span> length <span class="bound">t</span> <span class="main">&lt;</span> length <span class="skolem">s</span> <span class="main">⟹</span> parse_nodes_dom <span class="bound">t</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> ind2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span> <span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> length <span class="bound">t</span> <span class="main">&lt;</span> length <span class="skolem">s</span> <span class="main">⟹</span> parse_nodes <span class="bound">t</span> <span class="main">=</span> Inr <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span> length <span class="bound">r</span> <span class="main">≤</span> length <span class="bound">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?check</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> take <span class="numeral">2</span> <span class="bound">s</span> <span class="main">=</span> <span class="inner_quoted">''&lt;/''</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?check2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">s</span> <span class="main">≠</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&lt;''</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> dom<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_nodes_dom <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"parse_nodes_rel <span class="skolem">y</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"parse_nodes_dom <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ts</span> <span class="skolem">ya</span> <span class="skolem">tsa</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">tsa</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> take <span class="numeral">2</span> <span class="skolem">ts</span> <span class="main">=</span> <span class="inner_quoted">''&lt;/''</span><span class="main">)</span>"</span></span>
         <span class="quoted"><span class="quoted">"hd <span class="skolem">ts</span> <span class="main">≠</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&lt;''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> parse<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_text <span class="skolem">ts</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="skolem">tsa</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> parse_text_consumes<span class="main">[</span><span class="operator">OF</span> _ _ parse<span class="main">]</span> *<span class="main">(</span>3-4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">tsa</span> <span class="main">&lt;</span> length <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">s</span> <span class="main">&gt;</span> length <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> ind1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"parse_nodes_dom <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ts</span> <span class="skolem">ya</span> <span class="skolem">tsa</span> <span class="skolem">yaa</span> <span class="skolem">tsb</span> <span class="skolem">yb</span> <span class="skolem">tsc</span> <span class="skolem">yc</span> <span class="skolem">tsd</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">tsd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?check</span> <span class="skolem">ts</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''&lt;''</span> <span class="skolem">ts</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="skolem">tsa</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"parse_name <span class="skolem">tsa</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yaa</span><span class="main">,</span> <span class="skolem">tsb</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"parse_attributes <span class="skolem">tsb</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="skolem">tsc</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"oneof <span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span> <span class="skolem">tsc</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yc</span><span class="main">,</span> <span class="skolem">tsd</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yc</span> <span class="main">=</span> <span class="inner_quoted">''/&gt;''</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">s</span> <span class="main">&gt;</span> length <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> is_cparser_exactly <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''&lt;''</span>"</span></span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> is_parser_oneof <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span>"</span></span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> is_parser_parse_attributes
        <span class="keyword2"><span class="keyword">and</span></span> is_parser_parse_name
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_parser_length is_cparser_length<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ind1<span class="main">[</span><span class="operator">OF</span> len<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"parse_nodes_dom <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ts</span> <span class="skolem">ya</span> <span class="skolem">tsa</span> <span class="skolem">yaa</span> <span class="skolem">tsb</span> <span class="skolem">yb</span> <span class="skolem">tsc</span> <span class="skolem">yc</span> <span class="skolem">tsd</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">tsd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?check</span> <span class="skolem">ts</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''&lt;''</span> <span class="skolem">ts</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="skolem">tsa</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"parse_name <span class="skolem">tsa</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yaa</span><span class="main">,</span> <span class="skolem">tsb</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"parse_attributes <span class="skolem">tsb</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="skolem">tsc</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"oneof <span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span> <span class="skolem">tsc</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yc</span><span class="main">,</span> <span class="skolem">tsd</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">s</span> <span class="main">&gt;</span> length <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> is_cparser_exactly <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''&lt;''</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> is_parser_oneof <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span>"</span></span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> is_parser_parse_attributes
        <span class="keyword2"><span class="keyword">and</span></span> is_parser_parse_name
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_parser_length is_cparser_length<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ind1<span class="main">[</span><span class="operator">OF</span> len<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"parse_nodes_dom <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ts</span> <span class="skolem">ya</span> <span class="skolem">tsa</span> <span class="skolem">yaa</span> <span class="skolem">tsb</span> <span class="skolem">yb</span> <span class="skolem">tsc</span> <span class="skolem">yc</span> <span class="skolem">tse</span> <span class="skolem">ye</span> <span class="skolem">tsf</span> <span class="skolem">yf</span> <span class="skolem">tsg</span> <span class="skolem">yg</span> <span class="skolem">tsh</span> <span class="skolem">yh</span> <span class="skolem">tsi</span> <span class="skolem">yi</span> <span class="skolem">tsj</span>
      <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">tsj</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?check</span> <span class="skolem">ts</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''&lt;''</span> <span class="skolem">ts</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="skolem">tsa</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"parse_name <span class="skolem">tsa</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yaa</span><span class="main">,</span> <span class="skolem">tsb</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"parse_attributes <span class="skolem">tsb</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="skolem">tsc</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"oneof <span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span> <span class="skolem">tsc</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yc</span><span class="main">,</span> <span class="skolem">tse</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_nodes_sumC <span class="skolem">tse</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">ye</span><span class="main">,</span> <span class="skolem">tsf</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> last<span class="main">:</span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''&lt;/''</span> <span class="skolem">tsf</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yf</span><span class="main">,</span> <span class="skolem">tsg</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"exactly <span class="skolem">yaa</span> <span class="skolem">tsg</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yg</span><span class="main">,</span> <span class="skolem">tsh</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''&gt;''</span> <span class="skolem">tsh</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">yi</span><span class="main">,</span> <span class="skolem">tsj</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">s</span> <span class="main">&gt;</span> length <span class="skolem">tse</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> is_cparser_exactly <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''&lt;''</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> is_parser_oneof <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span>"</span></span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> is_parser_parse_attributes
        <span class="keyword2"><span class="keyword">and</span></span> is_parser_parse_name
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_parser_length is_cparser_length<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> last<span class="main">(</span>1<span class="main">)</span> last<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> len2a<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">tsf</span> <span class="main">≥</span> length <span class="skolem">tsh</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> is_parser_exactly <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''&lt;/''</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> is_parser_exactly <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">yaa</span></span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> is_parser_parse_name <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_parser_length<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> len2c<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">tsh</span> <span class="main">≥</span> length <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> last<span class="main">(</span>3<span class="main">)</span> 
        <span class="keyword1"><span class="command">using</span></span> is_parser_exactly <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''&gt;''</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> y <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_parser_length<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> len2a len2c <span class="keyword1"><span class="command">have</span></span> len2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">tsf</span> <span class="main">≥</span> length <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> ind2<span class="main">[</span><span class="operator">OF</span> len rec<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> parse_nodes_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> len len2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">s</span> <span class="main">&gt;</span> length <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> ind1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>       
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"parse_nodes_dom <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">note</span></span> psimps <span class="main">=</span> parse_nodes.psimps<span class="main">[</span><span class="operator">OF</span> dom<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prop</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> dom<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">r</span>    
    <span class="keyword3"><span class="command">assume</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_nodes <span class="skolem">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> psimps<span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?check</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> res <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> oFalse <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?check2</span></span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">simplified</span> False True<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y1</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> pt<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_text <span class="skolem">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">s1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"parse_text <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> bind_def pt<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y2</span></span> <span class="skolem"><span class="skolem">s2</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> pn<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_nodes <span class="skolem">s1</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y2</span><span class="main">,</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"parse_nodes <span class="skolem">s1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">simplified</span> bind_def pn<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> res <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_def bind_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> parse_text_consumes<span class="main">[</span><span class="operator">OF</span> _ True pt<span class="main">]</span> False  
        <span class="keyword1"><span class="command">have</span></span> lens<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">s1</span> <span class="main">&lt;</span> length <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> ind2<span class="main">[</span><span class="operator">OF</span> lens pn<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">s2</span> <span class="main">≤</span> length <span class="skolem">s1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lens <span class="keyword1"><span class="command">unfolding</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> ooFalse <span class="main">=</span> this
        <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">simplified</span> oFalse ooFalse<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y1</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> oo<span class="main">:</span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''&lt;''</span> <span class="skolem">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">s1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''&lt;''</span> <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> bind_def oo<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y2</span></span> <span class="skolem"><span class="skolem">s2</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> pn<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_name <span class="skolem">s1</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y2</span><span class="main">,</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"parse_name <span class="skolem">s1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_def psimps<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">simplified</span> bind_def pn<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y3</span></span> <span class="skolem"><span class="skolem">s3</span></span> <span class="keyword2"><span class="keyword">where</span></span> pa<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_attributes <span class="skolem">s2</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y3</span><span class="main">,</span> <span class="skolem">s3</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"parse_attributes <span class="skolem">s2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_def bind_def<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">simplified</span> pa<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y4</span></span> <span class="skolem"><span class="skolem">s4</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> oo2<span class="main">:</span> <span class="quoted"><span class="quoted">"oneof <span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span> <span class="skolem">s3</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y4</span><span class="main">,</span> <span class="skolem">s4</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"oneof <span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span> <span class="skolem">s3</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_def bind_def<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> oo2<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> is_parser_parse_attributes <span class="keyword2"><span class="keyword">and</span></span> is_parser_oneof <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span>"</span></span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">and</span></span> is_cparser_exactly <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''&lt;''</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> is_parser_parse_name
          <span class="keyword2"><span class="keyword">and</span></span> oo pn pa oo2
          <span class="keyword1"><span class="command">have</span></span> s_s4<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">s</span> <span class="main">&gt;</span> length <span class="skolem">s4</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_parser_length is_cparser_length<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y4</span> <span class="main">=</span> <span class="inner_quoted">''/&gt;''</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">from</span></span> res True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y5</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> pns<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_nodes <span class="skolem">s4</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y5</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"parse_nodes <span class="skolem">s4</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_def bind_def<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> ind2<span class="main">[</span><span class="operator">OF</span> s_s4 pns<span class="main">]</span> s_s4 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">s</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">simplified</span> False<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y6</span></span> <span class="skolem"><span class="skolem">s6</span></span> <span class="keyword2"><span class="keyword">where</span></span> pns<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_nodes <span class="skolem">s4</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y6</span><span class="main">,</span> <span class="skolem">s6</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"parse_nodes <span class="skolem">s4</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_def bind_def<span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> bind_def pns<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">unfolded</span> bind_def<span class="main">]</span>
          <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y7</span></span> <span class="skolem"><span class="skolem">s7</span></span> <span class="keyword2"><span class="keyword">where</span></span> oo3<span class="main">:</span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''&lt;/''</span> <span class="skolem">s6</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y7</span><span class="main">,</span> <span class="skolem">s7</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''&lt;/''</span> <span class="skolem">s6</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> oo3<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">unfolded</span> bind_def<span class="main">,</span> 
            <span class="operator">simplified</span><span class="main">,</span> <span class="operator">unfolded</span> bind_def<span class="main">]</span>
          <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y8</span></span> <span class="skolem"><span class="skolem">s8</span></span> <span class="keyword2"><span class="keyword">where</span></span> oo4<span class="main">:</span> <span class="quoted"><span class="quoted">"exactly <span class="skolem">y2</span> <span class="skolem">s7</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y8</span><span class="main">,</span> <span class="skolem">s8</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"exactly <span class="skolem">y2</span> <span class="skolem">s7</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> oo4 bind_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y10</span></span> <span class="skolem"><span class="skolem">s10</span></span> <span class="keyword2"><span class="keyword">where</span></span> oo5<span class="main">:</span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''&gt;''</span> <span class="skolem">s8</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y10</span><span class="main">,</span><span class="skolem">s10</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"exactly <span class="inner_quoted">''&gt;''</span> <span class="skolem">s8</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> oo5 bind_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y11</span></span> <span class="skolem"><span class="skolem">s11</span></span> <span class="keyword2"><span class="keyword">where</span></span> pns2<span class="main">:</span> <span class="quoted"><span class="quoted">"parse_nodes <span class="skolem">s10</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y11</span><span class="main">,</span> <span class="skolem">s11</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"parse_nodes <span class="skolem">s10</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> bind_def pns2<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          <span class="keyword1"><span class="command">note</span></span> one <span class="main">=</span> is_parser_oneof <span class="main">[</span><span class="operator">unfolded</span> is_parser_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
          <span class="keyword1"><span class="command">note</span></span> exact <span class="main">=</span> is_parser_exactly <span class="main">[</span><span class="operator">unfolded</span> is_parser_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
          <span class="keyword1"><span class="command">from</span></span> ind2<span class="main">[</span><span class="operator">OF</span> s_s4 pns<span class="main">]</span> s_s4 exact<span class="main">[</span><span class="operator">OF</span> oo3<span class="main">]</span> exact<span class="main">[</span><span class="operator">OF</span> oo4<span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> s_s7<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">s</span> <span class="main">&gt;</span> length <span class="skolem">s8</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_parser_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
          <span class="keyword1"><span class="command">with</span></span> exact<span class="main">[</span><span class="operator">OF</span> oo5<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> s_s10<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">s</span> <span class="main">&gt;</span> length <span class="skolem">s10</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> ind2<span class="main">[</span><span class="operator">OF</span> s_s10 pns2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> s_s11<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">s</span> <span class="main">&gt;</span> length <span class="skolem">s11</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> res <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> return_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">parse_nodes</span> <span class="keyword1"><span class="command">using</span></span> parse_nodes_help <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> parse_nodes <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser parse_nodes"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> is_parser_def <span class="keyword1"><span class="command">using</span></span> parse_nodes_help <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A more efficient variant of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"oneof <span class="main"><span class="main">[</span></span><span class="inner_quoted"><span class="inner_quoted">''/&gt;''</span></span><span class="main"><span class="main">,</span></span> <span class="inner_quoted"><span class="inner_quoted">''&gt;''</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">oneof_closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">oneof_closed</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&gt;''</span> <span class="keyword1">then</span> Error_Monad.return <span class="main">(</span><span class="inner_quoted">''&gt;''</span><span class="main">,</span> trim <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''/''</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> False <span class="main">|</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">⇒</span> <span class="bound">y</span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&gt;''</span><span class="main">)</span> <span class="keyword1">then</span>
      Error_Monad.return <span class="main">(</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> trim <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> err_expecting <span class="main">(</span><span class="inner_quoted">''one of [/&gt;, &gt;]''</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">oneof_closed</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> err_expecting <span class="main">(</span><span class="inner_quoted">''one of [/&gt;, &gt;]''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> oneof_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"oneof <span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span> <span class="main">=</span> oneof_closed"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''one of ''</span> <span class="main">@</span> shows_list <span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span> <span class="main">[]</span> <span class="main">=</span> <span class="inner_quoted">''one of [/&gt;, &gt;]''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shows_list_list_def showsp_list_def pshowsp_list_def shows_list_gen_def
                  shows_string_def shows_prec_list_def shows_list_char_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> oneof_def oneof_aux.simps id
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="var">?r</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Nil d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> oCons <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&gt;''</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons d True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> oFalse <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''/''</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons d <span class="keyword1"><span class="command">using</span></span> False oFalse <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> Nil
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons Nil d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> oCons Cons d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> If_removal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">e</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="bound">e</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">e</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">g</span> <span class="bound">e</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">e</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="bound">e</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">e</span> <span class="keyword1">else</span> <span class="free">g</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> parse_nodes.simps <span class="main">[</span><span class="operator">unfolded</span> oneof_closed<span class="main">,</span>
  <span class="operator">unfolded</span> If_removal <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">=</span> <span class="inner_quoted">''/&gt;''</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parse_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"xml parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parse_node</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    exactly <span class="inner_quoted">''&lt;''</span><span class="main">;</span>
    <span class="bound">n</span> <span class="main">←</span> parse_name<span class="main">;</span>
    <span class="bound">atts</span> <span class="main">←</span> parse_attributes<span class="main">;</span>
    <span class="bound">e</span> <span class="main">←</span> oneof <span class="main">[</span><span class="inner_quoted">''/&gt;''</span><span class="main">,</span> <span class="inner_quoted">''&gt;''</span><span class="main">]</span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">=</span> <span class="inner_quoted">''/&gt;''</span> <span class="keyword1">then</span> return <span class="main">(</span>XML <span class="bound">n</span> <span class="bound">atts</span> <span class="main">[]</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">cs</span> <span class="main">←</span> parse_nodes<span class="main">;</span>
      exactly <span class="inner_quoted">''&lt;/''</span><span class="main">;</span>
      exactly <span class="bound">n</span><span class="main">;</span>
      exactly <span class="inner_quoted">''&gt;''</span><span class="main">;</span>
      return <span class="main">(</span>XML <span class="bound">n</span> <span class="bound">atts</span> <span class="bound">cs</span><span class="main">)</span>
    <span class="main">}</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> parse_node_def <span class="main">[</span><span class="operator">unfolded</span> oneof_closed<span class="main">,</span> <span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">parse_header</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string list parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parse_header</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> take <span class="numeral">2</span> <span class="main">(</span>trim <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">''&lt;?''</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">h</span> <span class="main">←</span> scan_upto <span class="inner_quoted">''?&gt;''</span><span class="main">;</span>
      <span class="bound">hs</span> <span class="main">←</span> <span class="free">parse_header</span><span class="main">;</span>
      return <span class="main">(</span><span class="bound">h</span> <span class="main">#</span> <span class="bound">hs</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
      spaces<span class="main">;</span>
      return <span class="main">[]</span>
    <span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">parse_header</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ts</span> <span class="skolem">y</span> <span class="skolem">tsa</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"scan_upto <span class="inner_quoted">''?&gt;''</span> <span class="skolem">ts</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">tsa</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> is_cparser_scan_upto <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span> <span class="main">&gt;</span> length <span class="skolem">tsa</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_cparser_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tsa</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">∈</span> measure length"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">consts</span></span> scala <span class="main">::</span> <span class="quoted">bool</span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">scala</span> <span class="main">⇀</span>
    <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"False"</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"true"</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"false"</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"false"</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"false"</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_comments_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> string <span class="main">⇒</span> string"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_comments_aux</span> False <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&lt;''</span> <span class="main">∧</span> take <span class="numeral">3</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="inner_quoted">''!--''</span> <span class="keyword1">then</span> <span class="free">remove_comments_aux</span> True <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free">remove_comments_aux</span> False <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_comments_aux</span> True <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''-''</span> <span class="main">∧</span> take <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="inner_quoted">''-&gt;''</span> <span class="keyword1">then</span> <span class="free">remove_comments_aux</span> False <span class="main">(</span>drop <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free">remove_comments_aux</span> True <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_comments_aux</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_comments_aux_acc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> bool <span class="main">⇒</span> string <span class="main">⇒</span> string"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_comments_aux_acc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> False <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''&lt;''</span> <span class="main">∧</span> take <span class="numeral">3</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="inner_quoted">''!--''</span> <span class="keyword1">then</span> <span class="free">remove_comments_aux_acc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> True <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free">remove_comments_aux_acc</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> False <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_comments_aux_acc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> True <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''-''</span> <span class="main">∧</span> take <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="inner_quoted">''-&gt;''</span> <span class="keyword1">then</span> <span class="free">remove_comments_aux_acc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> False <span class="main">(</span>drop <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free">remove_comments_aux_acc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> True <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_comments_aux_acc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A tail recursive variant for Scala to reduce stack size at the cost of double traversal.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remove_comments</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_comments</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> scala <span class="keyword1">then</span> rev <span class="keyword1">o</span> <span class="main">(</span>remove_comments_aux_acc <span class="main">[]</span> False<span class="main">)</span>
    <span class="keyword1">else</span> remove_comments_aux False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> remove_comments_aux remove_comments_aux_acc

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parse_doc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"xmldoc parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parse_doc</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    update_tokens remove_comments<span class="main">;</span>
    <span class="bound">h</span> <span class="main">←</span> parse_header<span class="main">;</span>
    <span class="bound">xml</span> <span class="main">←</span> parse_node<span class="main">;</span>
    eoi<span class="main">;</span>
    return <span class="main">(</span>XMLDOC <span class="bound">h</span> <span class="bound">xml</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">doc_of_string</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string <span class="main">+</span> xmldoc"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">doc_of_string</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">doc</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> parse_doc <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
    Error_Monad.return <span class="bound">doc</span>
  <span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Xmlt">
<div class="head">
<h1>Theory Xmlt</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     Xml
   Author:    Christian Sternagel
   Author:    René Thiemann
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹XML Transformers for Extracting Data from XML Nodes›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Xmlt
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Xml.html">Xml</a>
  <a href="../Certification_Monads/Strict_Sum.html">Certification_Monads.Strict_Sum</a>
  <a href="../../HOL/HOL/Rat.html">HOL.Rat</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  tag <span class="main">=</span> <span class="quoted">string</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The type of transformers on xml nodes.›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="tfree">'a</span> xmlt <span class="main">=</span> <span class="quoted"><span class="quoted">"xml <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>xml <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> xml list <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">map</span> <span class="main">=</span> map_sum_bot"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"xml <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">B</span> <span class="main">⟹</span> mono_sum_bot <span class="main">(</span><span class="free">C</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="bound">f</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> map_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span> C<span class="main">)</span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> map

<span class="keyword1"><span class="command">fun</span></span> <span class="quoted">"<span class="entity">text</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> string xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">text</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">[</span>XML_text <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> return <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="keyword1">else</span> error <span class="main">(</span>concat
      <span class="main">[</span><span class="inner_quoted">''could not extract text for ''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span><span class="main">,</span><span class="inner_quoted">'' from ''</span><span class="main">,</span> <span class="inner_quoted">''⏎''</span><span class="main">,</span> show <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">[</span>XML_text <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">text</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> error <span class="main">(</span>concat <span class="main">[</span><span class="inner_quoted">''could not extract text for ''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span><span class="main">,</span><span class="inner_quoted">'' from ''</span><span class="main">,</span> <span class="inner_quoted">''⏎''</span><span class="main">,</span> show <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> <span class="quoted">"text"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bool_of_string</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bool_of_string</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="inner_quoted">''true''</span> <span class="keyword1">then</span> return True
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="inner_quoted">''false''</span> <span class="keyword1">then</span> return False
    <span class="keyword1">else</span> error <span class="main">(</span><span class="inner_quoted">''cannot convert ''</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' into Boolean''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bool</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> bool xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bool</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="main">=</span> Xmlt.text <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="main">⤜</span> bool_of_string"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> bool

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> <span class="tfree">'a</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fail</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span>
    error <span class="main">(</span>concat
      <span class="main">[</span><span class="inner_quoted">''could not transform the following xml element (expected ''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span><span class="main">,</span> <span class="inner_quoted">'')''</span><span class="main">,</span> <span class="inner_quoted">''⏎''</span><span class="main">,</span> show <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> fail

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>xml <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'a</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">guard</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> guard

<span class="keyword1"><span class="command">lemma</span></span> guard_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Xmlt.guard <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span> p1 p2 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Xmlt.guard_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">leaf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">leaf</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> return <span class="free"><span class="bound"><span class="entity">x</span></span></span> 
    <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">leaf</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> leaf

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list1element</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list1element</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">list1element</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">singleton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">singleton</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="keyword1">of</span>
      XML <span class="bound">name</span> <span class="bound">atts</span> <span class="bound">cs</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="bound">name</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="bound">atts</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="keyword1">case</span> list1element <span class="bound">cs</span> <span class="keyword1">of</span> 
          Some <span class="main">(</span><span class="bound">cs1</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="bound">cs1</span> <span class="main">⤜</span> return <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
        <span class="main">|</span> None <span class="main">⇒</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> singleton

<span class="keyword1"><span class="command">lemma</span></span> singleton_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Xmlt.singleton <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"list1element <span class="main">(</span>Xml.children <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span> p<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list2elements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list2elements</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">list2elements</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pair</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="keyword1">of</span>
      XML <span class="bound">name</span> <span class="bound">atts</span> <span class="bound">cs</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="bound">name</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="bound">atts</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="keyword1">case</span> list2elements <span class="bound">cs</span> <span class="keyword1">of</span> 
          Some <span class="main">(</span><span class="bound">cs1</span><span class="main">,</span> <span class="bound">cs2</span><span class="main">)</span> <span class="main">⇒</span>
          <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">a</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="bound">cs1</span><span class="main">;</span>
            <span class="bound">b</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="bound">cs2</span><span class="main">;</span>
            return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>
          <span class="main">}</span>
        <span class="main">|</span> None <span class="main">⇒</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> pair

<span class="keyword1"><span class="command">lemma</span></span> pair_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Xmlt.pair <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"list2elements <span class="main">(</span>Xml.children <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list3elements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list3elements</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">list3elements</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">triple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="tfree">'c</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">triple</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="keyword1">of</span> XML <span class="bound">name</span> <span class="bound">atts</span> <span class="bound">cs</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="bound">name</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="bound">atts</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="keyword1">case</span> list3elements <span class="bound">cs</span> <span class="keyword1">of</span> 
        Some <span class="main">(</span><span class="bound">cs1</span><span class="main">,</span> <span class="bound">cs2</span><span class="main">,</span> <span class="bound">cs3</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">a</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="bound">cs1</span><span class="main">;</span>
          <span class="bound">b</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="bound">cs2</span><span class="main">;</span>
          <span class="bound">c</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="bound">cs3</span><span class="main">;</span>
          return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span>
        <span class="main">}</span>
      <span class="main">|</span> None <span class="main">⇒</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> triple_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p3</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Xmlt.triple <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p3</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"list3elements <span class="main">(</span>Xml.children <span class="free">x</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list4elements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list4elements</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">]</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">list4elements</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">tuple4</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="tfree">'c</span> xmlt <span class="main">⇒</span> <span class="tfree">'d</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'e</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tuple4</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="keyword1">of</span>
      XML <span class="bound">name</span> <span class="bound">atts</span> <span class="bound">cs</span> <span class="main">⇒</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">name</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="bound">atts</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
          <span class="main">(</span><span class="keyword1">case</span> list4elements <span class="bound">cs</span> <span class="keyword1">of</span> 
            Some <span class="main">(</span><span class="bound">cs1</span><span class="main">,</span> <span class="bound">cs2</span><span class="main">,</span> <span class="bound">cs3</span><span class="main">,</span> <span class="bound">cs4</span><span class="main">)</span> <span class="main">⇒</span>
            <span class="keyword1">do</span> <span class="main">{</span>
              <span class="bound">a</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="bound">cs1</span><span class="main">;</span>
              <span class="bound">b</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="bound">cs2</span><span class="main">;</span>
              <span class="bound">c</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="bound">cs3</span><span class="main">;</span>
              <span class="bound">d</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="bound">cs4</span><span class="main">;</span>
              return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">)</span>
            <span class="main">}</span>
          <span class="main">|</span> None <span class="main">⇒</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>
        <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>
   <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tuple4_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p3</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p4</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Xmlt.tuple4 <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p3</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p4</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"list4elements <span class="main">(</span>Xml.children <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list5elements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list5elements</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">list5elements</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">tuple5</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="tfree">'c</span> xmlt <span class="main">⇒</span> <span class="tfree">'d</span> xmlt <span class="main">⇒</span> <span class="tfree">'e</span> xmlt <span class="main">⇒</span>
      <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'f</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'f</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tuple5</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="free"><span class="bound"><span class="entity">p5</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="keyword1">of</span>
      XML <span class="bound">name</span> <span class="bound">atts</span> <span class="bound">cs</span> <span class="main">⇒</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">name</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="bound">atts</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
          <span class="main">(</span><span class="keyword1">case</span> list5elements <span class="bound">cs</span> <span class="keyword1">of</span> 
            Some <span class="main">(</span><span class="bound">cs1</span><span class="main">,</span><span class="bound">cs2</span><span class="main">,</span><span class="bound">cs3</span><span class="main">,</span><span class="bound">cs4</span><span class="main">,</span><span class="bound">cs5</span><span class="main">)</span> <span class="main">⇒</span>
            <span class="keyword1">do</span> <span class="main">{</span>
              <span class="bound">a</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="bound">cs1</span><span class="main">;</span>
              <span class="bound">b</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="bound">cs2</span><span class="main">;</span>
              <span class="bound">c</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="bound">cs3</span><span class="main">;</span>
              <span class="bound">d</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="bound">cs4</span><span class="main">;</span>
              <span class="bound">e</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p5</span></span></span> <span class="bound">cs5</span><span class="main">;</span>
              return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span><span class="main">)</span>
            <span class="main">}</span>
          <span class="main">|</span> None <span class="main">⇒</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>
        <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tuple5_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p3</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p4</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p5</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Xmlt.tuple5 <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p3</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p4</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p5</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"list5elements <span class="main">(</span>Xml.children <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list6elements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list6elements</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">]</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">list6elements</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">tuple6</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="tfree">'c</span> xmlt <span class="main">⇒</span> <span class="tfree">'d</span> xmlt <span class="main">⇒</span> <span class="tfree">'e</span> xmlt <span class="main">⇒</span> <span class="tfree">'f</span> xmlt <span class="main">⇒</span>
      <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">⇒</span> <span class="tfree">'g</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'g</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tuple6</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="free"><span class="bound"><span class="entity">p5</span></span></span> <span class="free"><span class="bound"><span class="entity">p6</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="keyword1">of</span>
      XML <span class="bound">name</span> <span class="bound">atts</span> <span class="bound">cs</span>  <span class="main">⇒</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">name</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="bound">atts</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
          <span class="main">(</span><span class="keyword1">case</span> list6elements <span class="bound">cs</span> <span class="keyword1">of</span> 
            Some <span class="main">(</span><span class="bound">cs1</span><span class="main">,</span><span class="bound">cs2</span><span class="main">,</span><span class="bound">cs3</span><span class="main">,</span><span class="bound">cs4</span><span class="main">,</span><span class="bound">cs5</span><span class="main">,</span><span class="bound">cs6</span><span class="main">)</span> <span class="main">⇒</span>
            <span class="keyword1">do</span> <span class="main">{</span>
              <span class="bound">a</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="bound">cs1</span><span class="main">;</span>
              <span class="bound">b</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="bound">cs2</span><span class="main">;</span>
              <span class="bound">c</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="bound">cs3</span><span class="main">;</span>
              <span class="bound">d</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="bound">cs4</span><span class="main">;</span>
              <span class="bound">e</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p5</span></span></span> <span class="bound">cs5</span><span class="main">;</span>
              <span class="bound">ff</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p6</span></span></span> <span class="bound">cs6</span><span class="main">;</span>
              return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">ff</span><span class="main">)</span>
            <span class="main">}</span>
          <span class="main">|</span> None <span class="main">⇒</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>
        <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tuple6_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p3</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p4</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p5</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p6</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Xmlt.tuple6 <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p3</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p4</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p5</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p6</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"list6elements <span class="main">(</span>Xml.children <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">optional</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">optional</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">x1</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
        return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Some <span class="bound">x1</span><span class="main">)</span><span class="main">)</span>
      <span class="main">}</span> <span class="keyword1">else</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> None<span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optional</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> optional_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Xmlt.optional <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">xml1to2elements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xml1to2elements</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="numeral">2</span>
       <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">x1</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
         <span class="main">(</span><span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> <span class="numeral">2</span>
           <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
             <span class="bound">x2</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
             return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x1</span> <span class="main">(</span>Some <span class="bound">x2</span><span class="main">)</span><span class="main">)</span>
           <span class="main">}</span> <span class="keyword1">else</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x1</span> None<span class="main">)</span><span class="main">)</span>
       <span class="main">}</span> <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">xml1to2elements</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> xml1to2elements_mono<span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> xml1to2elements <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span> p1<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Apply the first transformer to the first child-node, then check the second child-node,
  which is must be a Boolean. If the Boolean is true, then apply the second transformer
  to the last child-node.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">xml2nd_choice</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> tag <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xml2nd_choice</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">x1</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">b</span> <span class="main">←</span> Xmlt.bool <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">x2</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="bound">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x1</span> <span class="main">(</span>Some <span class="bound">x2</span><span class="main">)</span><span class="main">)</span>
      <span class="main">}</span> <span class="keyword1">else</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x1</span> None<span class="main">)</span><span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">xml2nd_choice</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> xml2nd_choice_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> xml2nd_choice <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">h</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span> p1<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">xml2to3elements</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="tfree">'c</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> option <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xml2to3elements</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">x1</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">x2</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> <span class="numeral">3</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">x3</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="numeral">2</span><span class="main">)</span><span class="main">;</span>
         return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="main">(</span>Some <span class="bound">x3</span><span class="main">)</span><span class="main">)</span>
       <span class="main">}</span> <span class="keyword1">else</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x1</span> <span class="bound">x2</span> None<span class="main">)</span><span class="main">)</span>
     <span class="main">}</span> <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">xml2to3elements</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> xml2to3elements_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p3</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> xml2to3elements <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p3</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span> p1<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">xml3to4elements</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="tfree">'c</span> xmlt <span class="main">⇒</span> <span class="tfree">'d</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> option <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="tfree">'e</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xml3to4elements</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">x1</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">x2</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> <span class="numeral">4</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">x3</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="numeral">2</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">x4</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="numeral">3</span><span class="main">)</span><span class="main">;</span>
         return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="main">(</span>Some <span class="bound">x3</span><span class="main">)</span> <span class="bound">x4</span><span class="main">)</span>
       <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">x4</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="numeral">2</span><span class="main">)</span><span class="main">;</span>
         return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x1</span> <span class="bound">x2</span> None <span class="bound">x4</span><span class="main">)</span>
       <span class="main">}</span> <span class="main">)</span>
     <span class="main">}</span> <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">xml3to4elements</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> xml3to4elements_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p3</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p4</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> xml3to4elements <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p3</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p4</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span> p1<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">many</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">many</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">(</span>Xmlt.map <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⤜</span> <span class="main">(</span>return <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">many</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> many

<span class="keyword1"><span class="command">lemma</span></span> many_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"xml <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span>string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>Xml.children <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Xmlt.many <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">many1_gen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> xmlt<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">many1_gen</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">of</span> <span class="bound">h</span> <span class="main">#</span> <span class="bound">t</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="bound">h</span><span class="main">;</span>
        <span class="bound">xs</span> <span class="main">←</span> Xmlt.map <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">;</span>
        return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span>
    <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">many1_gen</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>

<span class="comment1">(* TODO 
lemma Xmlt.many1_gen_mono[partial_function_mono]:
  fixes p1 :: "xml ⇒ ('b ⇒ 'c sum_bot) ⇒ 'd sum_bot"
  assumes p1: "⋀y. mono_sum_bot (p1 y)"
              "⋀y. mono_sum_bot (p2 y)"
  shows "mono_sum_bot (λg. Xmlt.many1_gen t (λy. p1 y g) (λy. p2 y g) f x)" 
  by (cases x, auto intro!: partial_function_mono p1)
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">many1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">many1</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="main">=</span> Xmlt.many1_gen <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> many1

<span class="keyword1"><span class="command">lemma</span></span> many1_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"xml <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span>string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>tl <span class="main">(</span>Xml.children <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Xmlt.many1 <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Xmlt.many1_def <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"Xml.children <span class="free">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">length_ge_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">length_ge_2</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">length_ge_2</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">many2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="tfree">'c</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> list <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">many2</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> length_ge_2 <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">of</span> <span class="bound">cs0</span> <span class="main">#</span> <span class="bound">cs1</span> <span class="main">#</span> <span class="bound">t</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="bound">cs0</span><span class="main">;</span>
        <span class="bound">y</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="bound">cs1</span><span class="main">;</span>
        <span class="bound">xs</span> <span class="main">←</span> Xmlt.map <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="bound">t</span><span class="main">;</span>
        return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">xs</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span>
    <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">many2</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> many2_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"xml <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span>string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p3</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Xmlt.many2 <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p3</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"Xml.children <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>Xml.children <span class="free">x</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">xml1or2many_elements</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="tfree">'c</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option <span class="main">⇒</span> <span class="tfree">'c</span> list <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xml1or2many_elements</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">of</span>
        <span class="bound">cs0</span> <span class="main">#</span> <span class="bound">tt</span> <span class="main">⇒</span>
        <span class="keyword1">do</span> <span class="main">{</span> 
          <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="bound">cs0</span><span class="main">;</span>
          <span class="main">(</span><span class="keyword1">case</span> <span class="bound">tt</span> <span class="keyword1">of</span>
            <span class="bound">cs1</span> <span class="main">#</span> <span class="bound">t</span> <span class="main">⇒</span>
            <span class="keyword1">do</span> <span class="main">{</span>
              <span class="keyword1">try</span> <span class="keyword1">do</span> <span class="main">{</span>
                <span class="bound">y</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="bound">cs1</span><span class="main">;</span>
                <span class="bound">xs</span> <span class="main">←</span> Xmlt.map <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="bound">t</span><span class="main">;</span>
                return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">(</span>Some <span class="bound">y</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span>
              <span class="main">}</span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
                <span class="bound">xs</span> <span class="main">←</span> Xmlt.map <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="bound">tt</span><span class="main">;</span>
                return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> None <span class="bound">xs</span><span class="main">)</span>
              <span class="main">}</span><span class="main">)</span>
            <span class="main">}</span>
          <span class="main">|</span> <span class="main">[]</span> <span class="main">⇒</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> None <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> 
     <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">xml1or2many_elements</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>  <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">xml1many2elements_gen</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> xmlt<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> xmlt <span class="main">⇒</span> <span class="tfree">'d</span> xmlt <span class="main">⇒</span>
      <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'e</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xml1many2elements_gen</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="bound">ds</span> <span class="main">=</span> List.rev <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">;</span> <span class="bound">l</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">xs</span> <span class="main">←</span> Xmlt.map <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>take <span class="main">(</span><span class="bound">l</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">y</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="main">(</span><span class="bound">ds</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">z</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="main">(</span><span class="bound">ds</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
       return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span>
     <span class="main">}</span> <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">xml1many2elements_gen</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">p4</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> xml1many2elements_gen_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"xml <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span>string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p3</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p4</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> xml1many2elements_gen <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">p2</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p3</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p4</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span> p1<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">xml1many2elements</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="tfree">'c</span> xmlt <span class="main">⇒</span> <span class="tfree">'d</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="tfree">'e</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xml1many2elements</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="main">=</span> xml1many2elements_gen <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">xml_many2elements</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="tfree">'b</span> xmlt <span class="main">⇒</span> <span class="tfree">'c</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xml_many2elements</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="bound">ds</span> <span class="main">=</span> List.rev <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> length_ge_2 <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">xs</span> <span class="main">←</span> Xmlt.map <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">(</span>List.rev <span class="main">(</span>tl <span class="main">(</span>tl <span class="bound">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">y</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="main">(</span><span class="bound">ds</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">z</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="main">(</span><span class="bound">ds</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
       return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span>
     <span class="main">}</span> <span class="keyword1">else</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="main">(</span>XML <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">atts</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">xml_many2elements</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p3</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span> <span class="main">=</span> Xmlt.fail <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">xml</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">options</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string <span class="main">×</span> <span class="tfree">'a</span> xmlt<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">options</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> map_of <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">(</span>Xml.tag <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">of</span> 
      None <span class="main">⇒</span> error <span class="main">(</span>concat
        <span class="main">[</span><span class="inner_quoted">''expected one of: ''</span><span class="main">,</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">@</span> <span class="inner_quoted">'' ''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">,</span> <span class="inner_quoted">''⏎''</span><span class="main">,</span> <span class="inner_quoted">''but found''</span><span class="main">,</span> <span class="inner_quoted">''⏎''</span><span class="main">,</span> show <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> options

<span class="keyword1"><span class="command">lemma</span></span> options_mono_gen <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">⟹</span> mono_sum_bot <span class="main">(</span><span class="bound">p</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> Xmlt.options <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">p</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">@</span> <span class="inner_quoted">'' ''</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">p</span> <span class="bound">y</span> <span class="skolem">g</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">@</span> <span class="inner_quoted">'' ''</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> id <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot
      <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="keyword1">case</span> map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">p</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span>Xml.tag <span class="free">x</span><span class="main">)</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> <span class="skolem">z</span>
      <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">kp</span> <span class="skolem">ps</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> kp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">kp</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">note</span></span> Cons <span class="main">=</span> Cons<span class="main">[</span><span class="operator">unfolded</span> kp<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> monop<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="skolem">p</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">⟹</span> mono_sum_bot <span class="main">(</span><span class="bound">p</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Xml.tag <span class="free">x</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> kp <span class="keyword1"><span class="command">using</span></span> monop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> mono <span class="keyword1"><span class="command">unfolding</span></span> kp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Xmlt.options_def 
    <span class="keyword1"><span class="command">unfolding</span></span> id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> main<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* instantiate this lemma to have the monotonicity lemmas for lists of variable lengths which
   are then applicable, e.g., for lists of length 3 it would be

mono_sum_bot (p1 x) ⟹ mono_sum_bot (p2 x) ⟹ mono_sum_bot (p3 x) 
⟹ mono_sum_bot (λg. Xmlt.options [(k1, λy. p1 y g), (k2, λy. p2 y g), (k3, λy. p3 y g)] x)

*)</span>
<span class="keyword1"><span class="command">local_setup</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lthy</span> <span class="main">=&gt;</span> 
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">N</span> <span class="main">=</span> <span class="inner_numeral">30</span> <span class="comment1">(* we require monotonicity lemmas for xml-options for lists up to length N *)</span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">lthy</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">options</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Xmlt.options <span class="main">::</span> <span class="main">(</span>string <span class="main">×</span> <span class="main">(</span>xml <span class="main">⇒</span> <span class="main">(</span>string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> list <span class="main">⇒</span> xml <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'d</span>"</span><span class="antiquote">}</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mono_sum_bot</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"mono_sum_bot <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> bool"</span><span class="antiquote">}</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ktyp</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">string</span><span class="antiquote">}</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">x</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">x</span> <span class="main">::</span> xml"</span><span class="antiquote">}</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">y</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">y</span> <span class="main">::</span> xml"</span><span class="antiquote">}</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">g</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">g</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span>"</span><span class="antiquote">}</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ptyp</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"xml <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'d</span>"</span><span class="antiquote">}</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">k</span> <span class="entity">i</span> <span class="main">=</span> Free <span class="main">(</span><span class="inner_quoted">"k"</span> ^ string_of_int <span class="entity">i</span><span class="main">,</span><span class="entity">ktyp</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">p</span> <span class="entity">i</span> <span class="main">=</span> Free <span class="main">(</span><span class="inner_quoted">"p"</span> ^ string_of_int <span class="entity">i</span><span class="main">,</span><span class="entity">ptyp</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prem</span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span><span class="entity">mono_sum_bot</span> $ <span class="main">(</span><span class="entity">p</span> <span class="entity">i</span> $ <span class="entity">x</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prems</span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">1</span> upto <span class="entity">n</span> |&gt; map <span class="entity">prem</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pair</span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">k</span> <span class="entity">i</span><span class="main">,</span> lambda <span class="entity">y</span> <span class="main">(</span><span class="entity">p</span> <span class="entity">i</span> $ <span class="entity">y</span> $ <span class="entity">g</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pair2</span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">k</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">p</span> <span class="entity">i</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list</span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">1</span> upto <span class="entity">n</span> |&gt; map <span class="entity">pair</span> |&gt; <span class="entity">HOLogic.mk_list</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"<span class="main">(</span>string <span class="main">×</span> <span class="main">(</span>xml <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'d</span><span class="main">)</span><span class="main">)</span>"</span><span class="antiquote">}</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list2</span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">1</span> upto <span class="entity">n</span> |&gt; map <span class="entity">pair2</span> |&gt; <span class="entity">HOLogic.mk_list</span> <span class="main">(</span><span class="entity">HOLogic.mk_prodT</span> <span class="main">(</span><span class="entity">ktyp</span><span class="main">,</span><span class="entity">ptyp</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">concl</span> <span class="entity">n</span> <span class="main">=</span> <span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span><span class="entity">mono_sum_bot</span> $ lambda <span class="entity">g</span> <span class="main">(</span><span class="entity">options</span> $ <span class="main">(</span><span class="entity">list</span> <span class="entity">n</span><span class="main">)</span> $ <span class="entity">x</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">xs</span> <span class="entity">n</span> <span class="main">=</span> <span class="entity">x</span> :: <span class="main">(</span><span class="inner_numeral">1</span> upto <span class="entity">n</span> |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">p</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">k</span> <span class="entity">i</span><span class="main">]</span><span class="main">)</span> |&gt; List.concat<span class="main">)</span>
       |&gt; map <span class="main">(</span>fst o dest_Free<span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="entity">n</span> <span class="entity">pc</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>prems <span class="main">=</span> <span class="entity">prems</span><span class="main">,</span> context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">}</span> <span class="main">=</span> <span class="entity">pc</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mono_thm</span> <span class="main">=</span> Thm.instantiate' 
            <span class="main">(</span>map <span class="main">(</span>SOME o Thm.ctyp_of <span class="entity">ctxt</span><span class="main">)</span> <span class="main">[</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'a</span></span><span class="antiquote">}</span></span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'b</span></span><span class="antiquote">}</span></span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'c</span></span><span class="antiquote">}</span></span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'d</span></span><span class="antiquote">}</span></span><span class="main">]</span><span class="main">)</span> 
            <span class="main">(</span>map <span class="main">(</span>SOME o Thm.cterm_of <span class="entity">ctxt</span><span class="main">)</span> <span class="main">[</span><span class="entity">list2</span> <span class="entity">n</span><span class="main">,</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Xmlt.options_mono_gen<span class="antiquote">}</span></span></span>
      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="entity">Method.insert_tac</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">mono_thm</span> :: <span class="entity">prems</span><span class="main">)</span> <span class="inner_numeral">1</span> THEN <span class="entity">force_tac</span> <span class="entity">ctxt</span> <span class="inner_numeral">1</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">thm</span> <span class="entity">n</span> <span class="main">=</span> Goal.prove <span class="entity">lthy</span> <span class="main">(</span><span class="entity">xs</span> <span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="entity">prems</span> <span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="entity">concl</span> <span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="entity">tac</span> <span class="entity">n</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> map <span class="entity">thm</span> <span class="main">(</span><span class="inner_numeral">0</span> upto <span class="entity">N</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> Local_Theory.note <span class="main">(</span><span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "options_mono_thms"<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="entity">thms</span><span class="main">)</span> <span class="entity">lthy</span> |&gt; snd <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">declare</span></span> Xmlt.options_mono_thms <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">choice</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="tfree">'a</span> xmlt list <span class="main">⇒</span> <span class="tfree">'a</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">choice</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> error <span class="main">(</span>concat <span class="main">[</span><span class="inner_quoted">''error in parsing choice for ''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="inner_quoted">''⏎''</span><span class="main">,</span> show <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">choice</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">try</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">choice</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> choice

<span class="keyword1"><span class="command">lemma</span></span> choice_mono_2 <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="free">x</span><span class="main">)</span>"</span></span>
             <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> Xmlt.choice <span class="free">e</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span><span class="main">]</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> choice_mono_3 <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="free">x</span><span class="main">)</span>"</span></span>
             <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="free">p2</span> <span class="free">x</span><span class="main">)</span>"</span></span>
             <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="free">p3</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> Xmlt.choice <span class="free">e</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p2</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p3</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span><span class="main">]</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">change</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> xmlt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">change</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⤜</span> return <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> change

<span class="keyword1"><span class="command">lemma</span></span> change_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="free">p1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> Xmlt.change <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">p1</span> <span class="bound">y</span> <span class="bound">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">int_of_digit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"char <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> int"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">int_of_digit</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''0''</span> <span class="keyword1">then</span> return <span class="main">0</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''1''</span> <span class="keyword1">then</span> return <span class="main">1</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''2''</span> <span class="keyword1">then</span> return <span class="numeral">2</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''3''</span> <span class="keyword1">then</span> return <span class="numeral">3</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''4''</span> <span class="keyword1">then</span> return <span class="numeral">4</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''5''</span> <span class="keyword1">then</span> return <span class="numeral">5</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''6''</span> <span class="keyword1">then</span> return <span class="numeral">6</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''7''</span> <span class="keyword1">then</span> return <span class="numeral">7</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''8''</span> <span class="keyword1">then</span> return <span class="numeral">8</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''9''</span> <span class="keyword1">then</span> return <span class="numeral">9</span>
    <span class="keyword1">else</span> error <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="inner_quoted">'' is not a digit''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">int_of_string_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> string <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> int"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">int_of_string_aux</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="main">=</span> return <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">int_of_string_aux</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>int_of_digit <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="free">int_of_string_aux</span> <span class="main">(</span><span class="numeral">10</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">int_of_string</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> int"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">int_of_string</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> error <span class="inner_quoted">''cannot convert empty string into number''</span> 
    <span class="keyword1">else</span> <span class="keyword1">if</span> take <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="inner_quoted">''-''</span> <span class="keyword1">then</span> int_of_string_aux <span class="main">0</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> return <span class="main">(</span><span class="main">0</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> int_of_string_aux <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> int_of_string_aux

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> int xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">int</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>Xmlt.text <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⤜</span> int_of_string<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> int

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> nat xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nat</span> <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">txt</span> <span class="main">←</span> Xmlt.text <span class="free"><span class="bound"><span class="entity">tag</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="bound">i</span> <span class="main">←</span> int_of_string <span class="bound">txt</span><span class="main">;</span>
    return <span class="main">(</span>Int.nat <span class="bound">i</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> nat

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat xmlt"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rat</span> <span class="main">=</span> Xmlt.options <span class="main">[</span>
    <span class="main">(</span><span class="inner_quoted">''integer''</span><span class="main">,</span> Xmlt.change <span class="main">(</span>Xmlt.int <span class="inner_quoted">''integer''</span><span class="main">)</span> of_int<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''rational''</span><span class="main">,</span>
      Xmlt.pair <span class="inner_quoted">''rational''</span> <span class="main">(</span>Xmlt.int <span class="inner_quoted">''numerator''</span><span class="main">)</span> <span class="main">(</span>Xmlt.int <span class="inner_quoted">''denominator''</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> of_int <span class="bound">x</span> <span class="main">/</span> of_int <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> rat

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>