<div id="Case_Labeling">
<div class="head">
<h1>Theory Case_Labeling</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Case_Labeling
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">keywords</span></span> <span class="quoted">"print_nested_cases"</span> <span class="main">::</span> diag
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Labeling Subgoals›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> prg_ctxt_var <span class="main">=</span> <span class="quoted">unit</span>
  <span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> prg_ctxt <span class="main">=</span> <span class="quoted"><span class="quoted">"string <span class="main">×</span> nat <span class="main">×</span> prg_ctxt_var list"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Embed variables in terms›</span></span>
  <span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">VAR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> prg_ctxt_var"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">VAR</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">()</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Labeling of a subgoal›</span></span>
  <span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">VC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prg_ctxt list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">VC</span> <span class="free"><span class="bound"><span class="entity">ct</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Computing the statement numbers and context›</span></span>
  <span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">CTXT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> prg_ctxt list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">CTXT</span> <span class="free"><span class="bound"><span class="entity">inp</span></span></span> <span class="free"><span class="bound"><span class="entity">ct</span></span></span> <span class="free"><span class="bound"><span class="entity">outp</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Labeling of a term binding or assumption›</span></span>
  <span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">BIND</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">BIND</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">inp</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Hierarchy labeling›</span></span>
  <span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">HIER</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prg_ctxt list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">HIER</span> <span class="free"><span class="bound"><span class="entity">ct</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Split Labeling. This is used as an assumption›</span></span>
  <span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">SPLIT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">SPLIT</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Disambiguation Labeling. This is used as an assumption›</span></span>
  <span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">DISAMBIG</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">DISAMBIG</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> True"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> LABEL_simps <span class="main">=</span> BIND_def CTXT_def HIER_def SPLIT_def VC_def

  <span class="keyword1"><span class="command">lemma</span></span> Initial_Label<span class="main">:</span> <span class="quoted"><span class="quoted">"CTXT <span class="main">0</span> <span class="main">[]</span> <span class="free">outp</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Case_Labeling.CTXT_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span>
    BIND_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> BIND <span class="free">name</span> <span class="free">inp</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    BIND_D<span class="main">:</span> <span class="quoted"><span class="quoted">"BIND <span class="free">name</span> <span class="free">inp</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    VC_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> VC <span class="free">ct</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Case_Labeling.BIND_def Case_Labeling.VC_def <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> DISAMBIG_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DISAMBIG <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> DISAMBIG_def Case_Labeling.VC_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> DISAMBIG_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DISAMBIG <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> DISAMBIG_def<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas for the tuple postprocessing›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> SPLIT_reflection<span class="main">:</span> <span class="quoted"><span class="quoted">"SPLIT <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">≡</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SPLIT_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_reflection<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> rev_SPLIT_reflection<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">≡</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> SPLIT <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SPLIT_def <span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> SPLIT_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"SPLIT <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> SPLIT <span class="free">y</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SPLIT_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> SPLIT_thin_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>SPLIT <span class="free">x</span> <span class="free">x</span><span class="main">;</span> <span class="keyword1">PROP</span> <span class="free">W</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">PROP</span> <span class="free">W</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> SPLIT_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>SPLIT <span class="free">x</span> <span class="free">y</span><span class="main">;</span> <span class="free">P</span> <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SPLIT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">hypsubst</span>

  <span class="keyword1"><span class="command">lemma</span></span> SPLIT_prodE<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SPLIT <span class="main">(</span><span class="free">x1</span><span class="main">,</span> <span class="free">y1</span><span class="main">)</span> <span class="main">(</span><span class="free">x2</span><span class="main">,</span> <span class="free">y2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"SPLIT <span class="free">x1</span> <span class="free">x2</span>"</span></span> <span class="quoted"><span class="quoted">"SPLIT <span class="free">y1</span> <span class="free">y2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> SPLIT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The labeling constants were qualified to not interfere with any other theory.
  The following locale allows using a nice syntax in other theories
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Labeling_Syntax <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">VAR</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">VAR</span> <span class="main">≡</span> Case_Labeling.VAR"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">VC</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">V⟨</span><span class="keyword3">(2</span>_<span class="keyword1">,</span>_<span class="keyword1">:</span><span class="keyword3">/ </span>_<span class="keyword3">)</span><span class="keyword1">⟩</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">VC</span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">ct</span></span></span>  <span class="main">≡</span> Case_Labeling.VC <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ct</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">CTXT</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">C⟨</span><span class="keyword3">(2</span>_<span class="keyword1">,</span>_<span class="keyword1">,</span>_<span class="keyword1">:</span><span class="keyword3">/ </span>_<span class="keyword1">⟩</span><span class="keyword3">)</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CTXT</span> <span class="main">≡</span> Case_Labeling.CTXT"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">BIND</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">B⟨</span><span class="keyword3">(2</span>_<span class="keyword1">,</span>_<span class="keyword1">:</span><span class="keyword3">/ </span>_<span class="keyword1">⟩</span><span class="keyword3">)</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">BIND</span> <span class="main">≡</span> Case_Labeling.BIND"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">HIER</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">H⟨</span><span class="keyword3">(2</span>_<span class="keyword1">:</span><span class="keyword3">/ </span>_<span class="keyword1">⟩</span><span class="keyword3">)</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HIER</span> <span class="main">≡</span> Case_Labeling.HIER"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SPLIT</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SPLIT</span> <span class="main">≡</span> Case_Labeling.SPLIT"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas for converting terms from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Suc</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>/<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>nat"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> notation to numerals›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Suc_numerals_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">=</span> Numeral1"</span></span>
  <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="main">=</span> numeral <span class="main">(</span><span class="free">n</span> <span class="main">+</span> num.One<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> Suc_numeral_simps <span class="main">=</span> Suc_numerals_conv add_num_simps


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Casify›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Introduces a command <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> print_nested_cases<span class="antiquote"><span class="antiquote">}</span></span></span></span>. This is similar to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> print_cases<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  but shows also the nested cases.
›</span></span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹print_nested_cases.ML›</span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹util.ML›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Introduces the proof method.›</span></span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹casify.ML›</span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">casify_defs</span> <span class="main">=</span> <span class="entity">Casify.Options</span> <span class="main">{</span> simp_all_cases<span class="main">=</span>true<span class="main">,</span> split_right_only<span class="main">=</span>true<span class="main">,</span> protect_subgoals<span class="main">=</span>false <span class="main">}</span>
›</span>

<span class="keyword1"><span class="command">method_setup</span></span> prepare_labels <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span>ALLGOALS <span class="main">(</span><span class="entity">Casify.prepare_labels_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"VCG labelling: prepare labels"</span>

<span class="keyword1"><span class="command">method_setup</span></span> casify <span class="main">=</span> <span class="quoted">‹<span class="entity">Casify.casify_method_setup</span> <span class="entity">casify_defs</span>›</span>
  <span class="quoted">"VCG labelling: Turn the labels into cases"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/print_nested_cases.ML">
<div class="head">
<h1>File ‹print_nested_cases.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">PRINT_NESTED_CASES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> pretty_cases<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> Pretty.T
  <span class="keyword1"><span class="keyword">val</span></span> print_cases<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> unit
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Print_Nested_Cases</span> <span class="main">:</span> <span class="entity">PRINT_NESTED_CASES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_cases</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prt_term</span> <span class="main">=</span> Syntax.pretty_term <span class="entity">ctxt</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prt_asm</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span> Pretty.block <span class="main">(</span>Pretty.breaks
      <span class="main">(</span><span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">a</span> <span class="main">=</span> <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span>Pretty.str <span class="entity">a</span><span class="main">,</span> Pretty.str <span class="inner_quoted">":"</span><span class="main">]</span><span class="main">)</span> @ map <span class="main">(</span>Pretty.quote o <span class="entity">prt_term</span><span class="main">)</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prt_let</span> <span class="main">(</span><span class="entity">xi</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> Pretty.block
      <span class="main">[</span>Pretty.quote <span class="main">(</span><span class="entity">prt_term</span> <span class="main">(</span>Var <span class="main">(</span><span class="entity">xi</span><span class="main">,</span> Term.fastype_of <span class="entity">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Pretty.str <span class="inner_quoted">" ="</span><span class="main">,</span> Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
        Pretty.quote <span class="main">(</span><span class="entity">prt_term</span> <span class="entity">t</span><span class="main">)</span><span class="main">]</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prt_sect</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">|</span> <span class="entity">prt_sect</span> <span class="entity">head</span> <span class="entity">sep</span> <span class="entity">prt</span> <span class="entity">xs</span> <span class="main">=</span>
          <span class="main">[</span>Pretty.block <span class="main">(</span>Pretty.breaks <span class="main">(</span><span class="entity">head</span> ::
            flat <span class="main">(</span>separate <span class="entity">sep</span> <span class="main">(</span>map <span class="main">(</span>single o <span class="entity">prt</span><span class="main">)</span> <span class="entity">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prt_and</span> <span class="main">=</span> Pretty.keyword2 <span class="inner_quoted">"and"</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_assumes</span> <span class="entity">asms</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> forall <span class="main">(</span>null o <span class="main">#</span><span class="inner_numeral">2</span><span class="main">)</span> <span class="entity">asms</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">prt_sect</span> <span class="main">(</span>Pretty.keyword1 <span class="inner_quoted">"assume"</span><span class="main">)</span> <span class="main">[</span><span class="entity">prt_and</span><span class="main">]</span> <span class="entity">prt_asm</span> <span class="entity">asms</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pretty_binds</span> <span class="main">=</span> <span class="entity">prt_sect</span> <span class="main">(</span>Pretty.keyword1 <span class="inner_quoted">"let"</span><span class="main">)</span> <span class="main">[</span><span class="entity">prt_and</span><span class="main">]</span> <span class="entity">prt_let</span>
          o map_filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">xi</span><span class="main">,</span> SOME <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="entity">xi</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pretty_fixes</span> <span class="main">=</span> <span class="entity">prt_sect</span> <span class="main">(</span>Pretty.keyword1 <span class="inner_quoted">"fix"</span><span class="main">)</span> <span class="main">[</span><span class="entity">prt_and</span><span class="main">]</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">ty</span><span class="main">)</span> <span class="main">=&gt;</span>
      Pretty.block <span class="main">[</span>Pretty.str <span class="main">(</span>Binding.name_of <span class="entity">x</span><span class="main">)</span><span class="main">,</span> Pretty.str <span class="inner_quoted">" :: "</span><span class="main">,</span> Syntax.pretty_typ <span class="entity">ctxt</span> <span class="entity">ty</span><span class="main">]</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_case</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> Rule_Cases.Case <span class="main">{</span><span class="entity">cases</span><span class="main">,</span> <span class="entity">fixes</span><span class="main">,</span> <span class="entity">binds</span><span class="main">,</span> <span class="entity">assumes</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
      Pretty.chunks <span class="main">[</span>Pretty.big_list <span class="main">(</span><span class="entity">name</span> ^ <span class="inner_quoted">":"</span><span class="main">)</span>
        <span class="main">(</span><span class="entity">pretty_fixes</span> <span class="entity">fixes</span> @ <span class="entity">pretty_binds</span> <span class="entity">binds</span> @ <span class="entity">pretty_assumes</span> <span class="entity">assumes</span> @ <span class="entity">pretty_cases</span> <span class="entity">cases</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">pretty_cases</span> <span class="entity">cases</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">cases</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span>Pretty.big_list <span class="inner_quoted">"subcases:"</span> <span class="main">(</span>map <span class="entity">pretty_case</span> <span class="entity">cases</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cases</span> <span class="main">=</span> Proof_Context.dest_cases NONE <span class="entity">ctxt</span>
      |&gt; Pretty.big_list <span class="inner_quoted">"cases:"</span>  o map <span class="main">(</span>Pretty.chunks o single o <span class="entity">pretty_case</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">cases</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">print_cases</span> <span class="main">=</span> Pretty.writeln o <span class="entity">pretty_cases</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> "<span class="keyword1">print_nested_cases</span>"<span class="antiquote">}</span></span></span> <span class="inner_quoted">"print nested cases of proof context"</span>
    <span class="main">(</span>Scan.succeed <span class="main">(</span><span class="entity">Toplevel.keep</span> <span class="main">(</span><span class="entity">print_cases</span> o <span class="entity">Toplevel.context_of</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
</pre>
</div><div id="files/util.ML">
<div class="head">
<h1>File ‹util.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">1</span> THEN_CONTEXT
<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">1</span> THEN_ALL_NEW_FWD

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">BASIC_UTIL</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> INTERVAL_FWD<span class="main">:</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> REPEAT_ALL_NEW_FWD<span class="main">:</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> THEN_CONTEXT<span class="main">:</span> tactic * <span class="entity">context_tactic</span> <span class="main">-&gt;</span> <span class="entity">context_tactic</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> THEN_ALL_NEW_FWD<span class="main">:</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> * <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">UTIL</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">include</span></span> <span class="entity">BASIC_UTIL</span>
  <span class="keyword1"><span class="keyword">val</span></span> appair<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'c<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'b <span class="main">-&gt;</span> 'd<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'c * 'd<span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> infst<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> 'c * 'b<span class="main">)</span> <span class="main">-&gt;</span> 'a * 'e <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> <span class="main">(</span>'c * 'e<span class="main">)</span> * 'b

  <span class="keyword1"><span class="keyword">val</span></span> fst_ord<span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> order<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">)</span> * <span class="main">(</span>'a * 'b<span class="main">)</span> <span class="main">-&gt;</span> order
  <span class="keyword1"><span class="keyword">val</span></span> snd_ord<span class="main">:</span> <span class="main">(</span>'b * 'b <span class="main">-&gt;</span> order<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">)</span> * <span class="main">(</span>'a * 'b<span class="main">)</span> <span class="main">-&gt;</span> order
  <span class="keyword1"><span class="keyword">val</span></span> none_inf_ord<span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> order<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a option * 'a option<span class="main">)</span> <span class="main">-&gt;</span> order

  <span class="keyword1"><span class="keyword">val</span></span> dest_bool<span class="main">:</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> dest_option<span class="main">:</span> term <span class="main">-&gt;</span> term option
  <span class="keyword1"><span class="keyword">val</span></span> dest_pair<span class="main">:</span> term <span class="main">-&gt;</span> term * term
  <span class="keyword1"><span class="keyword">val</span></span> dest_tuple<span class="main">:</span> term <span class="main">-&gt;</span> term list

  <span class="keyword1"><span class="keyword">val</span></span> SIMPLE_METHOD_CASES<span class="main">:</span> <span class="entity">context_tactic</span> <span class="main">-&gt;</span> <span class="entity">Method.method</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Util</span> <span class="main">:</span> <span class="entity">UTIL</span> <span class="main">=</span>
 <span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">tac1</span> <span class="entity">THEN_CONTEXT</span> <span class="entity">tac2</span><span class="main">)</span> <span class="main">:</span> <span class="entity">context_tactic</span> <span class="main">=</span>
  <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">st</span> |&gt; <span class="entity">tac1</span> |&gt; Seq.maps <span class="main">(</span>pair <span class="entity">ctxt</span> #&gt; <span class="entity">tac2</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">appair</span> <span class="entity">f</span> <span class="entity">g</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">g</span> <span class="entity">y</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">infst</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="entity">c</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x'</span><span class="main">,</span><span class="entity">c'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">x'</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">,</span> <span class="entity">c'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fst_ord</span> <span class="entity">ord</span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">x'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">x'</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">snd_ord</span> <span class="entity">ord</span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">y'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">y'</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">none_inf_ord</span> <span class="entity">ord</span> <span class="main">(</span>SOME <span class="entity">x</span><span class="main">,</span> SOME <span class="entity">y</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">none_inf_ord</span> <span class="main">_</span> <span class="main">(</span>NONE<span class="main">,</span> NONE<span class="main">)</span> <span class="main">=</span> EQUAL
  <span class="main">|</span> <span class="entity">none_inf_ord</span> <span class="main">_</span> <span class="main">(</span>NONE<span class="main">,</span> SOME <span class="main">_</span><span class="main">)</span> <span class="main">=</span> GREATER
  <span class="main">|</span> <span class="entity">none_inf_ord</span> <span class="main">_</span> <span class="main">(</span>SOME <span class="main">_</span><span class="main">,</span> NONE<span class="main">)</span> <span class="main">=</span> LESS<span class="main">;</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_option</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "None"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> NONE
  <span class="main">|</span> <span class="entity">dest_option</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Some"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> SOME <span class="entity">t</span>
  <span class="main">|</span> <span class="entity">dest_option</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_option"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_bool</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "True"<span class="antiquote">}</span></span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">dest_bool</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "False"<span class="antiquote">}</span></span> <span class="main">=</span> false
  <span class="main">|</span> <span class="entity">dest_bool</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_bool"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_pair</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Pair"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t</span> $ <span class="entity">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">u</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">dest_pair</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_pair"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_tuple</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pair<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t1</span> $ <span class="entity">t2</span><span class="main">)</span> <span class="main">=</span>
      <span class="entity">t1</span> :: <span class="entity">dest_tuple</span> <span class="entity">t2</span>
  <span class="main">|</span> <span class="entity">dest_tuple</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span>



<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">SIMPLE_METHOD_CASES</span> <span class="entity">tac</span> <span class="main">=</span>
  <span class="entity">CONTEXT_METHOD</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">facts</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> |&gt; <span class="main">(</span>ALLGOALS <span class="main">(</span><span class="entity">Method.insert_tac</span> <span class="entity">ctxt</span> <span class="entity">facts</span><span class="main">)</span> <span class="entity">THEN_CONTEXT</span> <span class="entity">tac</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* Apply tactic to subgoals in interval, in a forward manner, skipping over
  emerging subgoals *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">INTERVAL_FWD</span> <span class="entity">tac</span> <span class="entity">l</span> <span class="entity">u</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l</span>&gt;<span class="entity">u</span> <span class="keyword2"><span class="keyword">then</span></span> all_tac <span class="entity">st</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">tac</span> <span class="entity">l</span> THEN <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st'</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ofs</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st'</span> - Thm.nprems_of <span class="entity">st</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">ofs</span> &lt; <span class="inner_numeral">~1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span>
        <span class="inner_quoted">"INTERVAL_FWD: Tac solved more than one goal"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">st</span><span class="main">,</span><span class="entity">st'</span><span class="main">]</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">INTERVAL_FWD</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">l</span>+<span class="inner_numeral">1</span>+<span class="entity">ofs</span><span class="main">)</span> <span class="main">(</span><span class="entity">u</span>+<span class="entity">ofs</span><span class="main">)</span> <span class="entity">st'</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span><span class="main">;</span>

<span class="comment1">(* Apply tac2 to all subgoals emerged from tac1, in forward manner. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">tac1</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="entity">tac2</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">tac1</span> <span class="entity">i</span>
    THEN <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st'</span> <span class="main">=&gt;</span> <span class="entity">INTERVAL_FWD</span> <span class="entity">tac2</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">i</span> + Thm.nprems_of <span class="entity">st'</span> - Thm.nprems_of <span class="entity">st</span><span class="main">)</span> <span class="entity">st'</span><span class="main">)</span>
  <span class="main">)</span> <span class="entity">st</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="entity">tac</span> <span class="main">=</span>
  <span class="entity">tac</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="main">(</span>TRY o <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="entity">tac</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Basic_Util</span><span class="main">:</span> <span class="entity">BASIC_UTIL</span> <span class="main">=</span> <span class="entity">Util</span>
<span class="keyword3"><span class="keyword">open</span></span> <span class="entity">Basic_Util</span>
</pre>
</div><div id="files/casify.ML">
<div class="head">
<h1>File ‹casify.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">CASIFY</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">options</span> <span class="main">=</span> <span class="entity">Options</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">{</span> simp_all_cases<span class="main">:</span> bool<span class="main">,</span> split_right_only<span class="main">:</span> bool<span class="main">,</span>
    protect_subgoals<span class="main">:</span> bool <span class="main">}</span>

  <span class="keyword1"><span class="keyword">val</span></span> hyp_subst_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> SPLIT_subst_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> extract_cases_tac<span class="main">:</span> <span class="entity">context_tactic</span>
  <span class="keyword1"><span class="keyword">val</span></span> prepare_labels_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> split_bind_all_tac<span class="main">:</span> <span class="main">{</span>right_only<span class="main">:</span> bool<span class="main">,</span> simp_all_cases<span class="main">:</span> bool<span class="main">}</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> casify_tac<span class="main">:</span> <span class="entity">options</span> <span class="main">-&gt;</span> <span class="entity">context_tactic</span>
  <span class="keyword1"><span class="keyword">val</span></span> casify_options<span class="main">:</span> <span class="entity">options</span> <span class="main">-&gt;</span> <span class="entity">options</span> parser
  <span class="keyword1"><span class="keyword">val</span></span> casify_method_setup<span class="main">:</span> <span class="entity">options</span> <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Method.method</span><span class="main">)</span> context_parser
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Casify</span> <span class="main">:</span> <span class="entity">CASIFY</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bind_unnamedN</span> <span class="main">=</span> <span class="inner_quoted">"case"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">case_premsN</span> <span class="main">=</span> <span class="inner_quoted">"prems"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">case_unnamedN</span> <span class="main">=</span> <span class="inner_quoted">"unnamed"</span>

<span class="keyword1"><span class="keyword">datatype</span></span> 'a <span class="entity">prg_ctxt</span> <span class="main">=</span> <span class="entity">Block</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span>string * 'a list<span class="main">)</span>
<span class="keyword1"><span class="keyword">datatype</span></span> 'a <span class="entity">prg_concl</span> <span class="main">=</span> <span class="entity">Prg_Concl</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="main">(</span>string * 'a<span class="main">)</span> option * term<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_var</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Case_Labeling.VAR<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Util.dest_tuple</span> <span class="entity">t</span>
  <span class="main">|</span> <span class="entity">dest_var</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_var"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_vars</span> <span class="main">=</span> <span class="entity">HOLogic.dest_list</span> #&gt; maps <span class="entity">dest_var</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_ct</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_block</span> <span class="entity">na</span> <span class="entity">ic</span> <span class="entity">vs</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">idx</span><span class="main">)</span> <span class="main">=</span> <span class="entity">HOLogic.dest_number</span> <span class="entity">ic</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">idx</span><span class="main">,</span> <span class="entity">Block</span> <span class="main">(</span><span class="entity">HOLogic.dest_string</span> <span class="entity">na</span><span class="main">,</span> <span class="entity">dest_vars</span> <span class="entity">vs</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_block</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pair<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">na</span> $ <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pair<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">ic</span> $ <span class="entity">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="entity">mk_block</span> <span class="entity">na</span> <span class="entity">ic</span> <span class="entity">vs</span>
      <span class="main">|</span> <span class="entity">dest_block</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_block"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">HOLogic.dest_list</span> #&gt; rev #&gt; map <span class="entity">dest_block</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_VC</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Case_Labeling.VC<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">ct</span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">dest_ct</span> <span class="entity">ct</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">dest_VC</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">try_dest_Trueprop</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> try <span class="entity">HOLogic.dest_Trueprop</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
    NONE <span class="main">=&gt;</span> <span class="entity">t</span>
  <span class="main">|</span> SOME <span class="entity">t'</span> <span class="main">=&gt;</span> <span class="entity">t'</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_BIND</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Case_Labeling.BIND<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">na</span> $ <span class="entity">ic</span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">HOLogic.dest_string</span> <span class="entity">na</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">n</span><span class="main">)</span> <span class="main">=</span> <span class="entity">HOLogic.dest_number</span> <span class="entity">ic</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">dest_BIND</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">(</span>NONE<span class="main">,</span> <span class="entity">t</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_SPLIT</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Case_Labeling.SPLIT<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t</span> $ <span class="entity">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">u</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">dest_SPLIT</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_SPLIT"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_Bound</span> <span class="main">(</span>Bound <span class="entity">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="entity">i</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">dest_Bound</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_bound"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_HIER</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Case_Labeling.HIER<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ <span class="entity">ct</span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span>SOME <span class="main">(</span>length <span class="main">(</span><span class="entity">HOLogic.dest_list</span> <span class="entity">ct</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">dest_HIER</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">(</span>NONE<span class="main">,</span> <span class="entity">t</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_label</span> <span class="entity">prop</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> Term.strip_all_vars <span class="entity">prop</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">prems</span><span class="main">,</span> <span class="entity">label</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">prop</span>
      |&gt; <span class="main">(</span>Logic.strip_horn o Term.strip_all_body<span class="main">)</span>
      ||&gt; <span class="entity">try_dest_Trueprop</span>
      ||&gt;&gt; <span class="entity">dest_VC</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">{</span> vars<span class="main">=</span><span class="entity">vars</span><span class="main">,</span> label<span class="main">=</span><span class="entity">label</span><span class="main">,</span> prems<span class="main">=</span><span class="entity">prems</span><span class="main">}</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_prem</span> <span class="entity">prop</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> Term.strip_all_vars <span class="entity">prop</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">prems</span><span class="main">,</span> <span class="main">(</span><span class="entity">hier</span><span class="main">,</span> <span class="entity">concl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">prop</span>
      |&gt; <span class="main">(</span>Logic.strip_horn o Term.strip_all_body<span class="main">)</span>
      ||&gt; <span class="entity">try_dest_Trueprop</span>
      ||&gt; <span class="entity">dest_HIER</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop'</span> <span class="main">=</span> Logic.list_all <span class="main">(</span><span class="entity">vars</span><span class="main">,</span> Logic.list_implies <span class="main">(</span><span class="entity">prems</span><span class="main">,</span> <span class="entity">HOLogic.mk_Trueprop</span> <span class="entity">concl</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">hier</span><span class="main">,</span> <span class="entity">prop'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_prg_ctxt</span> <span class="entity">n</span> <span class="main">(</span><span class="main">(</span><span class="entity">params</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lookup_delete</span> <span class="entity">eq</span> <span class="entity">y</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">aux</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> error <span class="main">(</span><span class="inner_quoted">"Term is not a parameter: "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">y</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">aux</span> <span class="entity">acc</span> <span class="main">(</span><span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">eq</span> <span class="main">(</span><span class="entity">k</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">v</span><span class="main">,</span> rev <span class="entity">acc</span> @ <span class="entity">xs</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">aux</span> <span class="main">(</span><span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span> :: <span class="entity">acc</span><span class="main">)</span> <span class="entity">xs</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">aux</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">upd_label_vars</span> <span class="entity">ps</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span>~<span class="entity">n</span><span class="main">,</span> <span class="entity">Block</span> <span class="main">(</span><span class="entity">case_unnamedN</span><span class="main">,</span> map snd <span class="entity">ps</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
      <span class="main">|</span> <span class="entity">upd_label_vars</span> <span class="entity">ps</span> <span class="main">[</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">Block</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">vs</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">vs'</span><span class="main">,</span> <span class="entity">ps'</span><span class="main">)</span> <span class="main">=</span> fold_map <span class="main">(</span><span class="entity">lookup_delete</span> <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> aconv<span class="main">)</span><span class="main">)</span> <span class="entity">vs</span> <span class="entity">ps</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">[</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">Block</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">vs'</span> @ map snd <span class="entity">ps'</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">upd_label_vars</span> <span class="entity">ps</span> <span class="main">(</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">Block</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">vs</span><span class="main">)</span><span class="main">)</span> :: <span class="entity">ct</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">vs'</span><span class="main">,</span> <span class="entity">ps'</span><span class="main">)</span> <span class="main">=</span> fold_map <span class="main">(</span><span class="entity">lookup_delete</span> <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> aconv<span class="main">)</span><span class="main">)</span> <span class="entity">vs</span> <span class="entity">ps</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">Block</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">vs'</span><span class="main">)</span><span class="main">)</span> :: <span class="entity">upd_label_vars</span> <span class="entity">ps'</span> <span class="entity">ct</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">build_param_map</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="main">(</span><span class="entity">s'</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">s'</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">,</span> <span class="main">{</span>fix<span class="main">=</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">,</span> abs<span class="main">=</span><span class="main">(</span><span class="entity">s'</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">asms</span><span class="main">,</span> <span class="main">(</span><span class="entity">label</span><span class="main">,</span> <span class="entity">concl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span>
      |&gt; Logic.strip_horn
      ||&gt; <span class="entity">try_dest_Trueprop</span>
      ||&gt; <span class="entity">dest_VC</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prg_ctxt</span> <span class="main">=</span> <span class="entity">upd_label_vars</span> <span class="main">(</span><span class="entity">build_param_map</span> <span class="entity">params</span><span class="main">)</span> <span class="entity">label</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt_len</span> <span class="main">=</span> length <span class="entity">prg_ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">asms'</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">parse_prem</span> #&gt; apfst <span class="main">(</span>the_default <span class="entity">ctxt_len</span><span class="main">)</span><span class="main">)</span> <span class="entity">asms</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="entity">prg_ctxt</span><span class="main">,</span> <span class="main">(</span><span class="entity">asms'</span><span class="main">,</span> <span class="entity">concl</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_prg_ctxts</span> <span class="entity">xs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> length <span class="entity">xs</span> <span class="keyword2"><span class="keyword">in</span></span> map_index <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">strip_prg_ctxt</span> <span class="main">(</span><span class="entity">n</span> - <span class="entity">i</span><span class="main">)</span> <span class="entity">x</span><span class="main">)</span> <span class="entity">xs</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="main">(</span>'a<span class="main">,</span>'b<span class="main">)</span> <span class="entity">precase</span> <span class="main">=</span> <span class="entity">Precase</span> <span class="keyword2"><span class="keyword">of</span></span>
 <span class="main">{</span>fixes<span class="main">:</span> <span class="main">(</span>binding * typ<span class="main">)</span> list<span class="main">,</span>
  assumes<span class="main">:</span> <span class="main">(</span>'b * term list<span class="main">)</span> list<span class="main">,</span>
  binds<span class="main">:</span> <span class="main">(</span>indexname * term option<span class="main">)</span> list<span class="main">,</span>
  cases<span class="main">:</span> <span class="main">(</span>'a * <span class="main">(</span>'a<span class="main">,</span>'b<span class="main">)</span> precase<span class="main">)</span> list<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">bindings</span> <span class="entity">args</span> <span class="main">=</span> map <span class="main">(</span>apfst Binding.name<span class="main">)</span> <span class="entity">args</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">coalesce_order</span> <span class="entity">ord</span> <span class="main">=</span> sort <span class="main">(</span><span class="entity">Util.fst_ord</span> <span class="entity">ord</span><span class="main">)</span> #&gt; AList.coalesce <span class="main">(</span>is_equal o <span class="entity">ord</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unique_names</span> <span class="entity">xs</span> <span class="main">=</span> fst <span class="main">(</span>fold_map <span class="main">(</span><span class="entity">Util.infst</span> Name.variant<span class="main">)</span> <span class="entity">xs</span> Name.context<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">build_precase</span> <span class="main">(</span><span class="entity">prg_ctxt</span><span class="main">,</span> <span class="main">(</span><span class="entity">prems</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span><span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sorted_prems</span> <span class="main">=</span> <span class="entity">prems</span>
      |&gt; map <span class="main">(</span>apsnd <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="main">(</span>fst <span class="main">(</span><span class="entity">dest_BIND</span> <span class="main">(</span><span class="entity">try_dest_Trueprop</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      |&gt; sort <span class="main">(</span>prod_ord int_ord <span class="main">(</span>prod_ord <span class="main">(</span>option_ord <span class="main">(</span>prod_ord fast_string_ord int_ord<span class="main">)</span><span class="main">)</span> <span class="main">(</span>K EQUAL<span class="main">)</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">drop_labels</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Case_Labeling.BIND"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> $ <span class="entity">t</span> <span class="main">)</span> <span class="main">=</span> <span class="entity">drop_labels</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">drop_labels</span> <span class="main">(</span><span class="entity">t1</span> $ <span class="entity">t2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">drop_labels</span> <span class="entity">t1</span> $ <span class="entity">drop_labels</span> <span class="entity">t2</span>
      <span class="main">|</span> <span class="entity">drop_labels</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span> <span class="entity">drop_labels</span> <span class="entity">t</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">drop_labels</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">t</span>

    <span class="comment1">(* XXX integrate with drop_labels, to save a second pass *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_binds</span> <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Case_Labeling.BIND"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">dest_BIND</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">(</span>NONE<span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">find_binds</span> <span class="entity">t</span>
        <span class="main">|</span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> :: <span class="entity">find_binds</span> <span class="entity">t</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">find_binds</span> <span class="main">(</span><span class="entity">t1</span> $ <span class="entity">t2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">find_binds</span> <span class="entity">t1</span> @ <span class="entity">find_binds</span> <span class="entity">t2</span>
      <span class="main">|</span> <span class="entity">find_binds</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">find_binds</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">find_binds</span> <span class="main">_</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">has_loose_bounds</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> loose_bnos <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> false
      <span class="main">|</span> <span class="main">_</span> :: <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span>warning <span class="inner_quoted">"loose bounds in term"</span><span class="main">;</span> true<span class="main">)</span> <span class="comment1">(*XXX*)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unique_binds</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">|</span> <span class="entity">unique_binds</span> <span class="entity">acc</span> <span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> AList.lookup <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span><span class="main">)</span> <span class="entity">acc</span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">of</span></span>
            NONE <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> :: <span class="entity">unique_binds</span> <span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span> :: <span class="entity">acc</span><span class="main">)</span> <span class="entity">xs</span>
          <span class="main">|</span> SOME <span class="entity">n</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">n</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> :: <span class="entity">unique_binds</span> <span class="main">(</span>AList.update <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span><span class="main">)</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">n</span>+<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">acc</span><span class="main">)</span> <span class="entity">xs</span>
          <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_precase</span> <span class="main">_</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">|</span> <span class="entity">mk_precase</span> <span class="main">_</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="main">_</span>::<span class="main">_</span><span class="main">)</span> <span class="main">=</span> error <span class="inner_quoted">"premise with a too long HIERarchy label"</span>
      <span class="main">|</span> <span class="entity">mk_precase</span> <span class="entity">n</span> <span class="entity">abs_ofixes</span> <span class="main">(</span><span class="entity">bl</span> :: <span class="entity">prg_ctxt</span><span class="main">)</span> <span class="entity">prems</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">m</span><span class="main">,</span> <span class="entity">Block</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">vars</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">bl</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fixes</span> <span class="main">=</span> map <span class="main">#</span>fix <span class="entity">vars</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">params</span> <span class="main">=</span> map <span class="main">#</span>abs <span class="entity">vars</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">prems1</span><span class="main">,</span> <span class="entity">prems2</span><span class="main">)</span> <span class="main">=</span> chop_prefix <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">m</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">m</span> <span class="main">=</span> <span class="entity">n</span><span class="main">)</span> <span class="entity">prems</span>

            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">abs_fixes</span> <span class="main">=</span> <span class="entity">abs_ofixes</span> o fold_rev Term.absfree <span class="entity">params</span>

            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems'</span> <span class="main">=</span> <span class="entity">prems1</span>
              |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>swap <span class="main">(</span>the_default <span class="main">(</span><span class="entity">case_premsN</span><span class="main">,</span> <span class="inner_numeral">~1</span><span class="main">)</span> <span class="entity">x</span><span class="main">)</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span>
              |&gt; <span class="entity">coalesce_order</span> <span class="main">(</span>prod_ord int_ord string_ord<span class="main">)</span>
              |&gt; map <span class="main">(</span>apfst snd<span class="main">)</span>
              |&gt; <span class="entity">unique_names</span>

            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">assumes</span> <span class="main">=</span> map <span class="main">(</span>apsnd <span class="main">(</span>map <span class="entity">abs_fixes</span><span class="main">)</span><span class="main">)</span> <span class="entity">prems'</span>

            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fixes'</span> <span class="main">=</span> <span class="entity">bindings</span> <span class="entity">fixes</span>

            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">binds</span> <span class="main">=</span>
              <span class="keyword2"><span class="keyword">let</span></span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prem_bs</span> <span class="main">=</span> maps <span class="entity">find_binds</span> <span class="main">(</span>maps snd <span class="entity">prems'</span><span class="main">)</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">concl_cases</span><span class="main">,</span> <span class="entity">concl_bs</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">prg_ctxt</span> <span class="keyword2"><span class="keyword">of</span></span>
                    <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="entity">bind_unnamedN</span><span class="main">,</span> <span class="entity">abs_fixes</span> <span class="entity">t</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="entity">find_binds</span> <span class="entity">t</span><span class="main">)</span>
                  <span class="main">|</span> <span class="main">(</span><span class="main">_</span>::<span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bs</span> <span class="main">=</span> <span class="entity">concl_bs</span> @ <span class="entity">prem_bs</span>
                  |&gt; sort <span class="main">(</span>prod_ord int_ord <span class="main">(</span>prod_ord string_ord Term_Ord.fast_term_ord<span class="main">)</span><span class="main">)</span>
                  |&gt; map snd
                  |&gt; map <span class="main">(</span>apsnd <span class="entity">abs_fixes</span><span class="main">)</span>
                  |&gt; filter_out <span class="main">(</span><span class="entity">has_loose_bounds</span> o snd<span class="main">)</span>
              <span class="keyword2"><span class="keyword">in</span></span>
                <span class="entity">concl_cases</span> @ <span class="entity">bs</span>
                |&gt; <span class="entity">unique_binds</span> <span class="main">[</span><span class="main">]</span>
                |&gt; map <span class="main">(</span>apsnd SOME<span class="main">)</span>
              <span class="keyword2"><span class="keyword">end</span></span>

            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">precase</span> <span class="main">=</span> <span class="entity">Precase</span> <span class="main">{</span>
              fixes <span class="main">=</span> <span class="entity">fixes'</span><span class="main">,</span>
              assumes <span class="main">=</span> <span class="entity">assumes</span><span class="main">,</span>
              binds <span class="main">=</span> <span class="entity">binds</span><span class="main">,</span>
              cases <span class="main">=</span> <span class="entity">mk_precase</span> <span class="main">(</span><span class="entity">n</span>+<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">abs_fixes</span> <span class="entity">prg_ctxt</span> <span class="entity">prems2</span> <span class="main">}</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="entity">m</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">precase</span><span class="main">)</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">mk_precase</span> <span class="inner_numeral">1</span> <span class="entity">drop_labels</span> <span class="entity">prg_ctxt</span> <span class="entity">sorted_prems</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge_precases</span> <span class="entity">precases</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">precases</span> <span class="main">:</span> <span class="main">(</span><span class="main">(</span>int * string<span class="main">)</span> * <span class="main">(</span>int * string<span class="main">,</span> string<span class="main">)</span> <span class="entity">precase</span><span class="main">)</span> list <span class="comment1">(*XXX*)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge_p</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> error <span class="inner_quoted">"empty case"</span> <span class="comment1">(*XXX*)</span>
      <span class="main">|</span> <span class="entity">merge_p</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">Precase</span> <span class="main">{</span><span class="entity">fixes</span><span class="main">,</span> <span class="entity">assumes</span><span class="main">,</span> <span class="entity">binds</span><span class="main">,</span> <span class="entity">cases</span><span class="main">}</span> :: <span class="entity">pcs</span><span class="main">)</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sel_cases</span> <span class="main">(</span><span class="entity">Precase</span> <span class="main">{</span><span class="entity">cases</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="entity">cases</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cases'</span> <span class="main">=</span> <span class="entity">merge_precases</span> <span class="main">(</span><span class="entity">cases</span> @ maps <span class="entity">sel_cases</span> <span class="entity">pcs</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> Rule_Cases.Case <span class="main">{</span>fixes <span class="main">=</span> <span class="entity">fixes</span><span class="main">,</span> assumes <span class="main">=</span> <span class="entity">assumes</span><span class="main">,</span> binds <span class="main">=</span> <span class="entity">binds</span><span class="main">,</span> cases <span class="main">=</span> <span class="entity">cases'</span><span class="main">}</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cases</span> <span class="main">=</span> <span class="entity">precases</span>
      |&gt; <span class="entity">coalesce_order</span> <span class="main">(</span>prod_ord int_ord string_ord<span class="main">)</span>
      |&gt; map <span class="main">(</span>apfst snd<span class="main">)</span>
      |&gt; <span class="entity">unique_names</span>
      |&gt; map <span class="entity">merge_p</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">cases</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_cases'</span> <span class="entity">ctxt</span> <span class="main">=</span> Thm.prems_of
  #&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> Variable.focus NONE <span class="entity">t</span> <span class="entity">ctxt</span><span class="main">)</span>
  #&gt; <span class="entity">strip_prg_ctxts</span>
  #&gt; maps <span class="entity">build_precase</span>
  #&gt; <span class="entity">merge_precases</span>
  #&gt; map <span class="main">(</span>apsnd SOME<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">normalize_conv</span> <span class="entity">cv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span> Conv.bottom_conv <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> Conv.try_conv <span class="main">(</span>
  <span class="entity">cv</span> then_conv <span class="entity">normalize_conv</span> <span class="entity">cv</span> <span class="entity">ctxt</span>
  <span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">ct</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prepare_labels_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">suc_numeral_simps</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span>
      Suc_numeral_simps<span class="main">[</span><span class="operator">THEN</span> eq_reflection<span class="main">]</span>
      append.simps<span class="main">[</span><span class="operator">THEN</span> eq_reflection<span class="main">]</span><span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">app_simps</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> append.simps<span class="main">[</span><span class="operator">THEN</span> eq_reflection<span class="main">]</span><span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">suc_to_num_conv</span> <span class="main">=</span> <span class="entity">normalize_conv</span> <span class="main">(</span>Conv.rewrs_conv <span class="main">(</span><span class="entity">suc_numeral_simps</span> @ <span class="entity">app_simps</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">label_fun_conv</span> <span class="main">=</span> Conv.fun_conv o <span class="entity">suc_to_num_conv</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">label_conv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Thm.term_of <span class="entity">ct</span> <span class="keyword2"><span class="keyword">of</span></span>
       Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Case_Labeling.BIND<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">label_fun_conv</span> <span class="entity">ctxt</span> <span class="entity">ct</span>
      <span class="main">|</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Case_Labeling.HIER<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">label_fun_conv</span> <span class="entity">ctxt</span> <span class="entity">ct</span>
      <span class="main">|</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Case_Labeling.VC<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">label_fun_conv</span> <span class="entity">ctxt</span> <span class="entity">ct</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Conv.no_conv <span class="entity">ct</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">norm_labels_conv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
      Conv.bottom_conv <span class="main">(</span>Conv.try_conv o <span class="entity">label_conv</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">ct</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    CONVERSION <span class="main">(</span><span class="entity">norm_labels_conv</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">extract_cases_tac</span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tac</span> <span class="main">=</span> <span class="entity">unfold_tac</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> LABEL_simps<span class="antiquote">}</span></span></span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">CONTEXT_CASES</span> <span class="main">(</span><span class="entity">mk_cases'</span> <span class="entity">ctxt</span> <span class="entity">st</span><span class="main">)</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>


<span class="comment1">(* Splits the nth ∀ into its components and simplifies any case_prod over this variable*)</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Splitsubst</span> <span class="main">=</span> <span class="entity">Hypsubst</span>
<span class="main">(</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_Trueprop</span> <span class="main">=</span> <span class="entity">HOLogic.dest_Trueprop</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_eq</span> <span class="main">=</span> <span class="entity">dest_SPLIT</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_imp</span> <span class="main">=</span> <span class="entity">HOLogic.dest_imp</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq_reflection</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> SPLIT_reflection<span class="antiquote">}</span></span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rev_eq_reflection</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rev_SPLIT_reflection<span class="antiquote">}</span></span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">imp_intr</span>         <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> impI<span class="antiquote">}</span></span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rev_mp</span>           <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rev_mp<span class="antiquote">}</span></span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">subst</span>            <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> SPLIT_subst<span class="antiquote">}</span></span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sym</span>              <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> SPLIT_sym<span class="antiquote">}</span></span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thin_refl</span>        <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> SPLIT_thin_refl<span class="antiquote">}</span></span></span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hyp_subst_tac</span> <span class="main">=</span> <span class="entity">Splitsubst.hyp_subst_tac</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">SPLIT_subst_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  REPEAT_ALL_NEW <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>ematch_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> SPLIT_prodE<span class="antiquote">}</span></span></span><span class="main">)</span> THEN' <span class="entity">Splitsubst.hyp_subst_tac</span> <span class="entity">ctxt</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">local</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">case_prod_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> split_conv<span class="main">[</span><span class="operator">THEN</span> eq_reflection<span class="main">]</span><span class="antiquote">}</span></span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">case_prod_conv</span> <span class="entity">ctxt</span> <span class="main">=</span>
  Conv.forall_conv <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=&gt;</span>
  Conv.forall_conv <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ct</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="main">[</span>NONE<span class="main">,</span> SOME <span class="entity">x</span><span class="main">,</span> SOME <span class="entity">y</span><span class="main">]</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">typ_insts</span> <span class="main">=</span> map <span class="main">(</span>Option.map Thm.ctyp_of_cterm<span class="main">)</span> <span class="entity">insts</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> Thm.instantiate' <span class="entity">typ_insts</span> <span class="entity">insts</span> <span class="entity">case_prod_th</span>
    <span class="keyword2"><span class="keyword">in</span></span> Conv.bottom_conv <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Conv.try_conv <span class="main">(</span>Conv.rewr_conv <span class="entity">th</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ctxt</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">split_nth_all_conv</span> <span class="main">{</span><span class="entity">right_only</span><span class="main">:</span>bool<span class="main">}</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">desc_conv</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">right_only</span> <span class="keyword2"><span class="keyword">then</span></span> Conv.try_conv <span class="keyword2"><span class="keyword">else</span></span> Conv.repeat_conv
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">conv</span> <span class="entity">ctxt</span> <span class="inner_numeral">0</span> <span class="entity">ct</span> <span class="main">=</span>
          <span class="entity">desc_conv</span> <span class="main">(</span>
            Conv.rewr_conv <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> split_paired_all<span class="antiquote">}</span></span></span>
            then_conv <span class="entity">case_prod_conv</span> <span class="entity">ctxt</span>
            then_conv Conv.try_conv <span class="main">(</span><span class="entity">conv</span> <span class="entity">ctxt</span> <span class="inner_numeral">1</span><span class="main">)</span>
          <span class="main">)</span> <span class="entity">ct</span>
      <span class="main">|</span> <span class="entity">conv</span> <span class="entity">ctxt</span> <span class="entity">n</span> <span class="entity">ct</span> <span class="main">=</span>
          Conv.forall_conv <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">conv</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">ct</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">conv</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">split_bind_all_conv</span> <span class="entity">right_only</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">vars</span><span class="main">,</span> <span class="entity">label</span><span class="main">,</span> <span class="entity">prems</span><span class="main">}</span> <span class="main">=</span> <span class="entity">parse_label</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nvars</span> <span class="main">=</span> length <span class="entity">vars</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bv_ts</span> <span class="main">=</span> <span class="entity">label</span> |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">Block</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">vs</span><span class="main">)</span> |&gt; flat

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sv_ts</span> <span class="main">=</span> <span class="entity">prems</span>
      |&gt; map_filter <span class="main">(</span>try <span class="entity">dest_SPLIT</span><span class="main">)</span>
      |&gt; map snd
      |&gt; maps <span class="entity">Util.dest_tuple</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lvars</span> <span class="main">=</span> <span class="entity">bv_ts</span> @ <span class="entity">sv_ts</span>
      |&gt; maps <span class="entity">dest_Bound</span>
      |&gt; sort_distinct int_ord
      |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">nvars</span> - <span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> Conv.every_conv <span class="main">(</span>map <span class="main">(</span><span class="entity">split_nth_all_conv</span> <span class="entity">right_only</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">lvars</span><span class="main">)</span> <span class="entity">ct</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">RAWCONV</span> <span class="entity">cv</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> Seq.single <span class="main">(</span>Conv.gconv_rule <span class="entity">cv</span> <span class="entity">i</span> <span class="entity">st</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">split_bind_all_tac</span> <span class="main">{</span><span class="entity">right_only</span><span class="main">:</span> bool<span class="main">,</span> <span class="entity">simp_all_cases</span><span class="main">:</span> bool<span class="main">}</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rewr_tac</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">simp_all_cases</span>
      <span class="keyword2"><span class="keyword">then</span></span> Raw_Simplifier.rewrite_goal_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">case_prod_th</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> K all_tac
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">RAWCONV</span> <span class="main">(</span><span class="entity">split_bind_all_conv</span> <span class="main">{</span>right_only <span class="main">=</span> <span class="entity">right_only</span><span class="main">}</span> <span class="entity">ctxt</span><span class="main">)</span> THEN' <span class="entity">rewr_tac</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">options</span> <span class="main">=</span> <span class="entity">Options</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">{</span> simp_all_cases<span class="main">:</span> bool<span class="main">,</span> split_right_only<span class="main">:</span> bool<span class="main">,</span> protect_subgoals<span class="main">:</span> bool<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">casify_tac</span> <span class="main">(</span><span class="entity">Options</span> <span class="main">{</span> <span class="entity">simp_all_cases</span><span class="main">,</span> <span class="entity">split_right_only</span><span class="main">,</span> <span class="entity">protect_subgoals</span> <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">inst_disambig</span> <span class="entity">ct</span> <span class="main">=</span> Thm.instantiate <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="inner_quoted">"n"</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">nat</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> DISAMBIG_I<span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">disambig_tac</span> <span class="entity">i</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">protect_subgoals</span>
      <span class="keyword2"><span class="keyword">then</span></span> match_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">inst_disambig</span> <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">HOLogic.mk_number</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">nat</span><span class="antiquote">}</span></span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">else</span></span> K all_tac
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prep_tac</span> <span class="main">=</span> DETERM <span class="main">(</span>ALLGOALS <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> EVERY'
      <span class="main">[</span> <span class="entity">prepare_labels_tac</span> <span class="entity">ctxt</span><span class="main">,</span>
        <span class="entity">split_bind_all_tac</span> <span class="main">{</span> simp_all_cases <span class="main">=</span> <span class="entity">simp_all_cases</span><span class="main">,</span> right_only <span class="main">=</span> <span class="entity">split_right_only</span> <span class="main">}</span> <span class="entity">ctxt</span><span class="main">,</span>
        TRY o <span class="entity">SPLIT_subst_tac</span> <span class="entity">ctxt</span><span class="main">,</span>
        <span class="entity">disambig_tac</span> <span class="entity">i</span>
        <span class="main">]</span> <span class="entity">i</span>
      <span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> |&gt; <span class="main">(</span><span class="entity">prep_tac</span> <span class="entity">THEN_CONTEXT</span> <span class="entity">extract_cases_tac</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">local</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set_simp_all_cases</span> <span class="entity">simp_all_cases</span>
    <span class="main">(</span><span class="entity">Options</span> <span class="main">{</span> simp_all_cases <span class="main">=</span> <span class="main">_</span><span class="main">,</span> <span class="entity">split_right_only</span><span class="main">,</span> <span class="entity">protect_subgoals</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">Options</span> <span class="main">{</span> simp_all_cases <span class="main">=</span> <span class="entity">simp_all_cases</span><span class="main">,</span> split_right_only <span class="main">=</span> <span class="entity">split_right_only</span><span class="main">,</span>
    protect_subgoals <span class="main">=</span> <span class="entity">protect_subgoals</span> <span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set_protect_subgoals</span> <span class="entity">protect_subgoals</span>
    <span class="main">(</span><span class="entity">Options</span> <span class="main">{</span> <span class="entity">simp_all_cases</span><span class="main">,</span> <span class="entity">split_right_only</span><span class="main">,</span> protect_subgoals <span class="main">=</span> <span class="main">_</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">Options</span> <span class="main">{</span> simp_all_cases <span class="main">=</span> <span class="entity">simp_all_cases</span><span class="main">,</span> split_right_only <span class="main">=</span> <span class="entity">split_right_only</span><span class="main">,</span>
    protect_subgoals <span class="main">=</span> <span class="entity">protect_subgoals</span> <span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set_split_right_only</span> <span class="entity">split_right_only</span>
    <span class="main">(</span><span class="entity">Options</span> <span class="main">{</span> <span class="entity">simp_all_cases</span><span class="main">,</span> split_right_only <span class="main">=</span> <span class="main">_</span><span class="main">,</span> <span class="entity">protect_subgoals</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">Options</span> <span class="main">{</span> simp_all_cases <span class="main">=</span> <span class="entity">simp_all_cases</span><span class="main">,</span> split_right_only <span class="main">=</span> <span class="entity">split_right_only</span><span class="main">,</span>
    protect_subgoals <span class="main">=</span> <span class="entity">protect_subgoals</span> <span class="main">}</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">options</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">f</span><span class="main">)</span> <span class="main">=&gt;</span> Args.parens <span class="main">(</span>Args.$$$ <span class="entity">s</span><span class="main">)</span> &gt;&gt; K <span class="entity">f</span><span class="main">)</span>
  <span class="main">[</span> <span class="main">(</span><span class="inner_quoted">"simp"</span><span class="main">,</span> <span class="entity">set_simp_all_cases</span> true<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">"no_simp"</span><span class="main">,</span> <span class="entity">set_simp_all_cases</span> false<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">"disambig_subgoals"</span><span class="main">,</span> <span class="entity">set_protect_subgoals</span> true<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">"no_disambig_subgoals"</span><span class="main">,</span> <span class="entity">set_protect_subgoals</span> false<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">"split_right_only"</span><span class="main">,</span> <span class="entity">set_split_right_only</span> true<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">"no_split_right_only"</span><span class="main">,</span> <span class="entity">set_split_right_only</span> false<span class="main">)</span>
  <span class="main">]</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">scan_alt</span> <span class="entity">scans</span> <span class="main">=</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">scan1</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">scan2</span> <span class="main">=&gt;</span> <span class="entity">scan1</span> || <span class="entity">scan2</span><span class="main">)</span> <span class="entity">scans</span> Scan.fail

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">casify_options</span> <span class="entity">def</span> <span class="main">=</span> Scan.repeat <span class="main">(</span><span class="entity">scan_alt</span> <span class="entity">options</span><span class="main">)</span>
  &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">xs</span> <span class="main">=&gt;</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">x</span><span class="main">)</span> <span class="entity">xs</span> <span class="entity">def</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">casify_method_setup</span> <span class="entity">def</span> <span class="main">=</span>
  Scan.lift <span class="main">(</span><span class="entity">casify_options</span> <span class="entity">def</span><span class="main">)</span> &gt;&gt;
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">opt</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Util.SIMPLE_METHOD_CASES</span> <span class="main">(</span><span class="entity">casify_tac</span> <span class="entity">opt</span><span class="main">)</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Labeled_Hoare">
<div class="head">
<h1>Theory Labeled_Hoare</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Labeled_Hoare
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Case_Labeling.html">../../Case_Labeling</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Hoare/Hoare_Logic.html">HOL-Hoare.Hoare_Logic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A labeling VCG for HOL/Hoare›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">interpretation</span></span> Labeling_Syntax <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> LSeqRule<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">IC</span><span class="main">,</span><span class="free">CT</span><span class="main">,</span><span class="free">OC1</span><span class="main">:</span> Valid <span class="free">P</span> <span class="free">c1</span> <span class="free">Q</span><span class="main">⟩</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span>Suc <span class="free">OC1</span><span class="main">,</span><span class="free">CT</span><span class="main">,</span><span class="free">OC</span><span class="main">:</span> Valid <span class="free">Q</span> <span class="free">c2</span> <span class="free">R</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">IC</span><span class="main">,</span><span class="free">CT</span><span class="main">,</span><span class="free">OC</span><span class="main">:</span> Valid <span class="free">P</span> <span class="main">(</span>Seq <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="free">R</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SeqRule<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> LSkipRule<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">V⟨</span><span class="main">(</span><span class="inner_quoted">''weaken''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="free">CT</span><span class="main">:</span> <span class="free">p</span> <span class="main">⊆</span> <span class="free">q</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">IC</span><span class="main">,</span><span class="free">CT</span><span class="main">,</span><span class="free">IC</span><span class="main">:</span> Valid <span class="free">p</span> <span class="keyword1">SKIP</span> <span class="free">q</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SkipRule<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> LAbortRule <span class="main">=</span> LSkipRule  <span class="comment1">― ‹dummy version›</span>

  <span class="keyword1"><span class="command">lemma</span></span> LBasicRule<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">V⟨</span><span class="main">(</span><span class="inner_quoted">''basic''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="free">CT</span><span class="main">:</span> <span class="free">p</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">q</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">IC</span><span class="main">,</span><span class="free">CT</span><span class="main">,</span><span class="free">IC</span><span class="main">:</span> Valid <span class="free">p</span> <span class="main">(</span>Basic <span class="free">f</span><span class="main">)</span> <span class="free">q</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> BasicRule<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> LCondRule<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">IC</span> <span class="free">CT</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT'</span> <span class="main">≡</span> <span class="main">(</span><span class="inner_quoted">''cond''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT</span> "</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">V⟨</span><span class="main">(</span><span class="inner_quoted">''vc''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="inner_quoted">''cond''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT</span><span class="main">:</span> <span class="free">p</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span> <span class="main">∈</span> <span class="free">b</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span> <span class="main">∉</span> <span class="free">b</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">w'</span><span class="main">)</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span>Suc <span class="free">IC</span><span class="main">,</span><span class="main">(</span><span class="inner_quoted">''then''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="inner_quoted">''cond''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT</span><span class="main">,</span><span class="free">OC1</span><span class="main">:</span> Valid <span class="free">w</span> <span class="free">c1</span> <span class="free">q</span><span class="main">⟩</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span>Suc <span class="free">OC1</span><span class="main">,</span><span class="main">(</span><span class="inner_quoted">''else''</span><span class="main">,</span> Suc <span class="free">OC1</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="inner_quoted">''cond''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT</span><span class="main">,</span><span class="free">OC</span><span class="main">:</span> Valid <span class="free">w'</span> <span class="free">c2</span> <span class="free">q</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">IC</span><span class="main">,</span><span class="free">CT</span><span class="main">,</span><span class="free">OC</span><span class="main">:</span> Valid <span class="free">p</span> <span class="main">(</span>Cond <span class="free">b</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="free">q</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> CondRule<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> LWhileRule<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">IC</span> <span class="free">CT</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT'</span> <span class="main">≡</span> <span class="main">(</span><span class="inner_quoted">''while''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">V⟨</span><span class="main">(</span><span class="inner_quoted">''precondition''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="inner_quoted">''while''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT</span><span class="main">:</span> <span class="free">p</span> <span class="main">⊆</span> <span class="free">i</span><span class="main">⟩</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span>Suc <span class="free">IC</span><span class="main">,</span><span class="main">(</span><span class="inner_quoted">''invariant''</span><span class="main">,</span> Suc <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="inner_quoted">''while''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT</span><span class="main">,</span><span class="free">OC</span><span class="main">:</span> Valid <span class="main">(</span><span class="free">i</span> <span class="main">∩</span> <span class="free">b</span><span class="main">)</span> <span class="free">c</span> <span class="free">i</span><span class="main">⟩</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">V⟨</span><span class="main">(</span><span class="inner_quoted">''postcondition''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="inner_quoted">''while''</span><span class="main">,</span> <span class="free">IC</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">CT</span><span class="main">:</span> <span class="free">i</span> <span class="main">∩</span> <span class="main">-</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">q</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">IC</span><span class="main">,</span><span class="free">CT</span><span class="main">,</span><span class="free">OC</span><span class="main">:</span> Valid <span class="free">p</span> <span class="main">(</span>While <span class="free">b</span> <span class="free">i</span> <span class="free">v</span> <span class="free">c</span><span class="main">)</span> <span class="free">q</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WhileRule<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> LABELs_to_prems<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">C⟨</span><span class="free">IC</span><span class="main">,</span> <span class="free">CT</span><span class="main">,</span> <span class="free">OC</span><span class="main">:</span> True<span class="main">⟩</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">C⟨</span><span class="free">IC</span><span class="main">,</span> <span class="free">CT</span><span class="main">,</span> <span class="free">OC</span><span class="main">:</span> <span class="free">P</span><span class="main">⟩</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">V⟨</span><span class="free">x</span><span class="main">,</span> <span class="free">ct</span><span class="main">:</span> True<span class="main">⟩</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">V⟨</span><span class="free">x</span><span class="main">,</span> <span class="free">ct</span><span class="main">:</span> <span class="free">P</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">lemma</span></span> LABELs_to_concl<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">IC</span><span class="main">,</span> <span class="free">CT</span><span class="main">,</span> <span class="free">OC</span><span class="main">:</span> True<span class="main">⟩</span> <span class="main">⟹</span> <span class="keyword1">C⟨</span><span class="free">IC</span><span class="main">,</span> <span class="free">CT</span><span class="main">,</span> <span class="free">OC</span><span class="main">:</span> <span class="free">P</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">V⟨</span><span class="free">x</span><span class="main">,</span> <span class="free">ct</span><span class="main">:</span> True<span class="main">⟩</span> <span class="main">⟹</span> <span class="keyword1">V⟨</span><span class="free">x</span><span class="main">,</span> <span class="free">ct</span><span class="main">:</span> <span class="free">P</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹labeled_hoare_tac.ML›</span>

<span class="keyword1"><span class="command">method_setup</span></span> labeled_vcg <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">Labeled_Hoare.hoare_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>K all_tac<span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span>
  <span class="quoted">"verification condition generator"</span>

<span class="keyword1"><span class="command">method_setup</span></span> labeled_vcg_simp <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">Labeled_Hoare.hoare_tac</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">asm_full_simp_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span>
  <span class="quoted">"verification condition generator"</span>

<span class="keyword1"><span class="command">method_setup</span></span> casified_vcg <span class="main">=</span> <span class="quoted">‹
  Scan.lift <span class="main">(</span><span class="entity">Casify.casify_options</span> <span class="entity">casify_defs</span><span class="main">)</span> &gt;&gt;
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">opt</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">Util.SIMPLE_METHOD_CASES</span> <span class="main">(</span>
      HEADGOAL <span class="main">(</span><span class="entity">Labeled_Hoare.hoare_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>K all_tac<span class="main">)</span><span class="main">)</span>
      <span class="entity">THEN_CONTEXT</span> <span class="entity">Casify.casify_tac</span> <span class="entity">opt</span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">method_setup</span></span> casified_vcg_simp <span class="main">=</span> <span class="quoted">‹
  Scan.lift <span class="main">(</span><span class="entity">Casify.casify_options</span> <span class="entity">casify_defs</span><span class="main">)</span> &gt;&gt;
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">opt</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">Util.SIMPLE_METHOD_CASES</span> <span class="main">(</span>
      HEADGOAL <span class="main">(</span><span class="entity">Labeled_Hoare.hoare_tac</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">asm_full_simp_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
      <span class="entity">THEN_CONTEXT</span> <span class="entity">Casify.casify_tac</span> <span class="entity">opt</span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/labeled_hoare_tac.ML">
<div class="head">
<h1>File ‹labeled_hoare_tac.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      labeled_hoare_tac.ML
    Author:     Leonor Prensa Nieto &amp; Tobias Nipkow &amp; Lars Noschinski

Derivation of the proof rules and, most importantly, the VCG tactic.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">LABELED_HOARE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> wrap_label_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> hoare_rule_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term list * thm <span class="main">-&gt;</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> bool <span class="main">-&gt;</span>
    int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> hoare_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Labeled_Hoare</span><span class="main">:</span> <span class="entity">LABELED_HOARE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="comment1">(*** The tactics ***)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">to_prems_ths</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> LABELs_to_prems<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">to_concl_ths</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> LABELs_to_concl<span class="antiquote">}</span></span></span>

<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">0</span> THEN_ELSE'<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">tac</span> <span class="entity">THEN_ELSE'</span> <span class="main">(</span><span class="entity">tac1</span><span class="main">,</span> <span class="entity">tac2</span><span class="main">)</span><span class="main">)</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">tac</span> <span class="entity">x</span> THEN_ELSE <span class="main">(</span><span class="entity">tac1</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">tac2</span> <span class="entity">x</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wrap_label_tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wrap_tac</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
      <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="entity">to_prems_ths</span>
       <span class="entity">THEN_ELSE'</span> <span class="main">(</span><span class="entity">wrap_tac</span> THEN_ALL_NEW eresolve_tac <span class="entity">ctxt</span> <span class="entity">to_concl_ths</span><span class="main">,</span> <span class="entity">tac</span><span class="main">)</span>
      <span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">wrap_tac</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*****************************************************************************)</span>
<span class="comment1">(** The function Mset makes the theorem                                     **)</span>
<span class="comment1">(** "?Mset &lt;= {(x1,...,xn). ?P (x1,...,xn)} ==&gt; ?Mset &lt;= {s. ?P s}",        **)</span>
<span class="comment1">(** where (x1,...,xn) are the variables of the particular program we are    **)</span>
<span class="comment1">(** working on at the moment of the call                                    **)</span>
<span class="comment1">(*****************************************************************************)</span>

<span class="keyword2"><span class="keyword">local</span></span>

<span class="comment1">(** maps (%x1 ... xn. t) to [x1,...,xn] **)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">abs2list</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> case_prod<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> :: <span class="entity">abs2list</span> <span class="entity">t</span>
  <span class="main">|</span> <span class="entity">abs2list</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>Free <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">abs2list</span> <span class="main">_</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">;</span>

<span class="comment1">(** maps {(x1,...,xn). t} to [x1,...,xn] **)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_vars</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Collect<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ <span class="entity">T</span><span class="main">)</span> <span class="main">=</span> <span class="entity">abs2list</span> <span class="entity">T</span>
  <span class="main">|</span> <span class="entity">mk_vars</span> <span class="main">_</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">;</span>

<span class="comment1">(** abstraction of body over a tuple formed from a list of free variables.
Types are also built **)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_abstupleC</span> <span class="main">[</span><span class="main">]</span> <span class="entity">body</span> <span class="main">=</span> absfree <span class="main">(</span><span class="inner_quoted">"x"</span><span class="main">,</span> <span class="entity">HOLogic.unitT</span><span class="main">)</span> <span class="entity">body</span>
  <span class="main">|</span> <span class="entity">mk_abstupleC</span> <span class="main">[</span><span class="entity">v</span><span class="main">]</span> <span class="entity">body</span> <span class="main">=</span> absfree <span class="main">(</span>dest_Free <span class="entity">v</span><span class="main">)</span> <span class="entity">body</span>
  <span class="main">|</span> <span class="entity">mk_abstupleC</span> <span class="main">(</span><span class="entity">v</span> :: <span class="entity">w</span><span class="main">)</span> <span class="entity">body</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> <span class="main">=</span> dest_Free <span class="entity">v</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">z</span> <span class="main">=</span> <span class="entity">mk_abstupleC</span> <span class="entity">w</span> <span class="entity">body</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T2</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">z</span> <span class="keyword2"><span class="keyword">of</span></span>
            Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">T</span>
          <span class="main">|</span> Const <span class="main">(</span><span class="main">_</span><span class="main">,</span> Type <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">[</span><span class="main">_</span><span class="main">,</span> Type <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">[</span><span class="entity">T</span><span class="main">,</span> <span class="main">_</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> $ <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">T</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> case_prod<span class="antiquote">}</span></span><span class="main">,</span>
            <span class="main">(</span><span class="entity">T</span> --&gt; <span class="entity">T2</span> --&gt; <span class="entity">HOLogic.boolT</span><span class="main">)</span> --&gt; <span class="entity">HOLogic.mk_prodT</span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span> <span class="entity">T2</span><span class="main">)</span> --&gt; <span class="entity">HOLogic.boolT</span><span class="main">)</span> $
          absfree <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> <span class="entity">z</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(** maps [x1,...,xn] to (x1,...,xn) and types**)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_bodyC</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">HOLogic.unit</span>
  <span class="main">|</span> <span class="entity">mk_bodyC</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="main">=</span> <span class="entity">x</span>
  <span class="main">|</span> <span class="entity">mk_bodyC</span> <span class="main">(</span><span class="entity">x</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> <span class="main">=</span> dest_Free <span class="entity">x</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">z</span> <span class="main">=</span> <span class="entity">mk_bodyC</span> <span class="entity">xs</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T2</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">z</span> <span class="keyword2"><span class="keyword">of</span></span>
            Free <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">T</span>
          <span class="main">|</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pair<span class="antiquote">}</span></span><span class="main">,</span> Type <span class="main">(</span><span class="inner_quoted">"fun"</span><span class="main">,</span> <span class="main">[</span><span class="main">_</span><span class="main">,</span> Type <span class="main">(</span><span class="inner_quoted">"fun"</span><span class="main">,</span> <span class="main">[</span><span class="main">_</span><span class="main">,</span> <span class="entity">T</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">T</span><span class="main">)</span><span class="main">;</span>
     <span class="keyword2"><span class="keyword">in</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pair<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">[</span><span class="entity">T</span><span class="main">,</span> <span class="entity">T2</span><span class="main">]</span> ---&gt; <span class="entity">HOLogic.mk_prodT</span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span> <span class="entity">T2</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">x</span> $ <span class="entity">z</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(** maps a subgoal of the form:
    VARS x1 ... xn {._.} _ {._.} or to [x1,...,xn]
**)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_vars</span> <span class="entity">c</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">d</span> <span class="main">=</span> Logic.strip_assums_concl <span class="entity">c</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> Const <span class="main">_</span> $ <span class="entity">pre</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">=</span> <span class="entity">HOLogic.dest_Trueprop</span> <span class="entity">d</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">mk_vars</span> <span class="entity">pre</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_CollectC</span> <span class="entity">tm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T</span> <span class="keyword1"><span class="keyword">as</span></span> Type <span class="main">(</span><span class="inner_quoted">"fun"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">,</span><span class="main">_</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> fastype_of <span class="entity">tm</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">HOLogic.Collect_const</span> <span class="entity">t</span> $ <span class="entity">tm</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">inclt</span> <span class="entity">ty</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Orderings.less_eq<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">[</span><span class="entity">ty</span><span class="main">,</span><span class="entity">ty</span><span class="main">]</span> ---&gt; <span class="entity">HOLogic.boolT</span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">Mset</span> <span class="entity">ctxt</span> <span class="entity">prop</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">[</span><span class="main">(</span><span class="entity">Mset</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> Variable.variant_frees <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">"Mset"</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"P"</span><span class="main">,</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> <span class="entity">get_vars</span> <span class="entity">prop</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">varsT</span> <span class="main">=</span> fastype_of <span class="main">(</span><span class="entity">mk_bodyC</span> <span class="entity">vars</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">big_Collect</span> <span class="main">=</span>
      <span class="entity">mk_CollectC</span> <span class="main">(</span><span class="entity">mk_abstupleC</span> <span class="entity">vars</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="entity">varsT</span> --&gt; <span class="entity">HOLogic.boolT</span><span class="main">)</span> $ <span class="entity">mk_bodyC</span> <span class="entity">vars</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">small_Collect</span> <span class="main">=</span>
      <span class="entity">mk_CollectC</span> <span class="main">(</span>Abs <span class="main">(</span><span class="inner_quoted">"x"</span><span class="main">,</span> <span class="entity">varsT</span><span class="main">,</span> Free <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="entity">varsT</span> --&gt; <span class="entity">HOLogic.boolT</span><span class="main">)</span> $ Bound <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">MsetT</span> <span class="main">=</span> fastype_of <span class="entity">big_Collect</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">Mset_incl</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span><span class="entity">inclt</span> <span class="entity">MsetT</span> $ Free <span class="main">(</span><span class="entity">Mset</span><span class="main">,</span> <span class="entity">MsetT</span><span class="main">)</span> $ <span class="entity">t</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">impl</span> <span class="main">=</span> Logic.mk_implies <span class="main">(</span><span class="entity">Mset_incl</span> <span class="entity">big_Collect</span><span class="main">,</span> <span class="entity">Mset_incl</span> <span class="entity">small_Collect</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> Goal.prove <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">Mset</span><span class="main">,</span> <span class="entity">P</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">impl</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">blast_tac</span> <span class="entity">ctxt</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">;</span>
 <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">vars</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>


<span class="comment1">(*****************************************************************************)</span>
<span class="comment1">(** Simplifying:                                                            **)</span>
<span class="comment1">(** Some useful lemmata, lists and simplification tactics to control which  **)</span>
<span class="comment1">(** theorems are used to simplify at each moment, so that the original      **)</span>
<span class="comment1">(** input does not suffer any unexpected transformation                     **)</span>
<span class="comment1">(*****************************************************************************)</span>

<span class="comment1">(**Simp_tacs**)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">before_set2pred_simp_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="entity">simp_tac</span> <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span> addsimps <span class="main">[</span><span class="entity">Collect_conj_eq</span> RS <span class="entity">sym</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Compl_Collect<span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">split_simp_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="entity">simp_tac</span> <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span> addsimps <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> split_conv<span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(*****************************************************************************)</span>
<span class="comment1">(** set_to_pred_tac transforms sets inclusion into predicates implication,  **)</span>
<span class="comment1">(** maintaining the original variable names.                                **)</span>
<span class="comment1">(** Ex. "{x. x=0} &lt;= {x. x &lt;= 1}" -set2pred-&gt; "x=0 --&gt; x &lt;= 1"              **)</span>
<span class="comment1">(** Subgoals containing intersections (A Int B) or complement sets (-A)     **)</span>
<span class="comment1">(** are first simplified by "before_set2pred_simp_tac", that returns only   **)</span>
<span class="comment1">(** subgoals of the form "{x. P x} &lt;= {x. Q x}", which are easily           **)</span>
<span class="comment1">(** transformed.                                                            **)</span>
<span class="comment1">(** This transformation may solve very easy subgoals due to a ligth         **)</span>
<span class="comment1">(** simplification done by (split_all_tac)                                  **)</span>
<span class="comment1">(*****************************************************************************)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set_to_pred_tac</span> <span class="entity">ctxt</span> <span class="entity">var_names</span> <span class="main">=</span> SUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span>
  <span class="entity">before_set2pred_simp_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> THEN_MAYBE
  EVERY <span class="main">[</span>
    resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">subsetI</span><span class="main">]</span> <span class="entity">i</span><span class="main">,</span>
    resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">CollectI</span><span class="main">]</span> <span class="entity">i</span><span class="main">,</span>
    dresolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">CollectD</span><span class="main">]</span> <span class="entity">i</span><span class="main">,</span>
    TRY <span class="main">(</span><span class="entity">split_all_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">)</span> THEN_MAYBE
     <span class="main">(</span>rename_tac <span class="entity">var_names</span> <span class="entity">i</span> THEN
      <span class="entity">full_simp_tac</span> <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span> addsimps <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> split_conv<span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span> <span class="entity">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(*******************************************************************************)</span>
<span class="comment1">(** basic_simp_tac is called to simplify all verification conditions. It does **)</span>
<span class="comment1">(** a light simplification by applying "mem_Collect_eq", then it calls        **)</span>
<span class="comment1">(** max_simp_tac, which solves subgoals of the form "A &lt;= A",                 **)</span>
<span class="comment1">(** and transforms any other into predicates, applying then                   **)</span>
<span class="comment1">(** the tactic chosen by the user, which may solve the subgoal completely.    **)</span>
<span class="comment1">(*******************************************************************************)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">max_simp_tac</span> <span class="entity">ctxt</span> <span class="entity">var_names</span> <span class="entity">tac</span> <span class="main">=</span>
  FIRST' <span class="main">[</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">subset_refl</span><span class="main">]</span><span class="main">,</span> <span class="entity">set_to_pred_tac</span> <span class="entity">ctxt</span> <span class="entity">var_names</span> THEN_MAYBE' <span class="entity">tac</span><span class="main">]</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">basic_simp_tac</span> <span class="entity">ctxt</span> <span class="entity">var_names</span> <span class="entity">tac</span> <span class="main">=</span>
  <span class="entity">wrap_label_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>
    <span class="entity">simp_tac</span>
      <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span>
        addsimps <span class="main">[</span><span class="entity">mem_Collect_eq</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> split_conv<span class="antiquote">}</span></span></span><span class="main">]</span> addsimprocs <span class="main">[</span><span class="entity">Record.simproc</span><span class="main">]</span><span class="main">)</span>
    THEN_MAYBE' <span class="entity">max_simp_tac</span> <span class="entity">ctxt</span> <span class="entity">var_names</span> <span class="entity">tac</span>
  <span class="main">)</span><span class="main">;</span>


<span class="comment1">(** hoare_rule_tac **)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">hoare_rule_tac</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">vars</span><span class="main">,</span> <span class="entity">Mlem</span><span class="main">)</span> <span class="entity">tac</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">var_names</span> <span class="main">=</span> map <span class="main">(</span>fst o dest_Free<span class="main">)</span> <span class="entity">vars</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wlp_tac</span> <span class="entity">i</span> <span class="main">=</span>
      resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> LSeqRule<span class="antiquote">}</span></span></span> <span class="entity">i</span> THEN <span class="entity">rule_tac</span> false <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">rule_tac</span> <span class="entity">pre_cond</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">st</span> |&gt; <span class="comment1">(*abstraction over st prevents looping*)</span>
      <span class="main">(</span><span class="main">(</span><span class="entity">wlp_tac</span> <span class="entity">i</span> THEN <span class="entity">rule_tac</span> <span class="entity">pre_cond</span> <span class="entity">i</span><span class="main">)</span>
        ORELSE
        TRY <span class="main">(</span>FIRST <span class="main">[</span>
          resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> LSkipRule<span class="antiquote">}</span></span></span> <span class="entity">i</span><span class="main">,</span>
          resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> LAbortRule<span class="antiquote">}</span></span></span> <span class="entity">i</span><span class="main">,</span>
          EVERY <span class="main">[</span>
            resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> LBasicRule<span class="antiquote">}</span></span></span> <span class="entity">i</span><span class="main">,</span>
            <span class="entity">wrap_label_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">Mlem</span><span class="main">]</span><span class="main">)</span> <span class="entity">i</span><span class="main">,</span>
            <span class="entity">split_simp_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">]</span><span class="main">,</span>
          EVERY <span class="main">[</span>
            resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> LCondRule<span class="antiquote">}</span></span></span> <span class="entity">i</span><span class="main">,</span>
            <span class="entity">rule_tac</span> false <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
            <span class="entity">rule_tac</span> false <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
          EVERY <span class="main">[</span>
            resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> LWhileRule<span class="antiquote">}</span></span></span> <span class="entity">i</span><span class="main">,</span>
            <span class="entity">basic_simp_tac</span> <span class="entity">ctxt</span> <span class="entity">var_names</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span>
            <span class="entity">rule_tac</span> true <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span><span class="main">]</span><span class="main">]</span>
         THEN
          <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">pre_cond</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">basic_simp_tac</span> <span class="entity">ctxt</span> <span class="entity">var_names</span> <span class="entity">tac</span> <span class="entity">i</span>
           <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">wrap_label_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">subset_refl</span><span class="main">]</span><span class="main">)</span> <span class="entity">i</span><span class="main">)</span>
        <span class="main">)</span>
      <span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">rule_tac</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>


<span class="comment1">(** tac is the tactic the user chooses to solve or simplify **)</span>
<span class="comment1">(** the final verification conditions                       **)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">hoare_tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="main">=</span> SUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">goal</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mset</span> <span class="main">=</span> <span class="entity">Mset</span> <span class="entity">ctxt</span> <span class="entity">goal</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    SELECT_GOAL
     <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> Initial_Label<span class="antiquote">}</span></span></span> <span class="inner_numeral">1</span> THEN
      <span class="entity">hoare_rule_tac</span> <span class="entity">ctxt</span> <span class="entity">mset</span> <span class="entity">tac</span> true <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">i</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
</pre>
</div><div id="Labeled_Hoare_Examples">
<div class="head">
<h1>Theory Labeled_Hoare_Examples</h1>
</div>
<pre class="source"><span class="comment1">(*  Based on:   HOL/Hoare/Examples.thy
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Labeled_Hoare_Examples
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Labeled_Hoare.html">Labeled_Hoare</a>
  <span class="quoted">"<a href="../../HOL/HOL-Hoare/Arith2.html">HOL-Hoare.Arith2</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Multiplication by successive addition›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> multiply_by_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">m</span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">s</span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">a</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">b</span></span></span></span></span></span></span></span></span></span></span></span></span>
  <span class="main">{</span><span class="bound">a</span><span class="main">=</span><span class="free">A</span> <span class="main">∧</span> <span class="bound">b</span><span class="main">=</span><span class="free">B</span><span class="main">}</span>
  m <span class="main">:=</span> <span class="main">0</span><span class="main">;</span> s <span class="main">:=</span> <span class="main">0</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">m</span><span class="main">≠</span><span class="bound">a</span>
  <span class="keyword1">INV</span> <span class="main">{</span><span class="bound">s</span><span class="main">=</span><span class="bound">m</span><span class="main">*</span><span class="bound">b</span> <span class="main">∧</span> <span class="bound">a</span><span class="main">=</span><span class="free">A</span> <span class="main">∧</span> <span class="bound">b</span><span class="main">=</span><span class="free">B</span><span class="main">}</span>
  <span class="keyword1">DO</span> s <span class="main">:=</span> <span class="bound">s</span><span class="main">+</span><span class="bound">b</span><span class="main">;</span> m <span class="main">:=</span> <span class="bound">m</span><span class="main">+</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span> <span class="keyword1">OD</span>
  <span class="main">{</span><span class="bound">s</span> <span class="main">=</span> <span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">M</span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">N</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">P</span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> int
 <span class="main">{</span><span class="free">m</span><span class="main">=</span><span class="bound">M</span> <span class="main">∧</span> <span class="free">n</span><span class="main">=</span><span class="bound">N</span><span class="main">}</span>
 <span class="keyword1">IF</span> <span class="bound">M</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">THEN</span> M <span class="main">:=</span> <span class="main">-</span><span class="bound">M</span><span class="main">;</span> N <span class="main">:=</span> <span class="main">-</span><span class="bound">N</span> <span class="keyword1">ELSE</span> <span class="keyword1">SKIP</span> <span class="keyword1">FI</span><span class="main">;</span>
 P <span class="main">:=</span> <span class="main">0</span><span class="main">;</span>
 <span class="keyword1">WHILE</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">M</span>
 <span class="keyword1">INV</span> <span class="main">{</span><span class="main">0</span> <span class="main">≤</span> <span class="bound">M</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">m</span><span class="main">&lt;</span><span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span><span class="free">m</span> <span class="keyword1">else</span> <span class="free">m</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">*</span><span class="bound">N</span> <span class="main">=</span> <span class="free">m</span><span class="main">*</span><span class="free">n</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">(</span><span class="bound">p</span><span class="main">-</span><span class="bound">M</span><span class="main">)</span><span class="main">*</span><span class="bound">N</span><span class="main">)</span><span class="main">}</span>
 <span class="keyword1">DO</span> P <span class="main">:=</span> <span class="bound">P</span><span class="main">+</span><span class="bound">N</span><span class="main">;</span> M <span class="main">:=</span> <span class="bound">M</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">OD</span>
 <span class="main">{</span><span class="bound">P</span> <span class="main">=</span> <span class="free">m</span><span class="main">*</span><span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">casified_vcg_simp</span>
  <span class="keyword3"><span class="command">case</span></span> while
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> postcondition
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> invariant
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> basic
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> int_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Euclid's algorithm for GCD›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Euclid_GCD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">a</span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">b</span></span></span></span></span></span></span></span></span></span></span></span>
 <span class="main">{</span><span class="main">0</span><span class="main">&lt;</span><span class="free">A</span> <span class="main">∧</span> <span class="main">0</span><span class="main">&lt;</span><span class="free">B</span><span class="main">}</span>
 a <span class="main">:=</span> <span class="free">A</span><span class="main">;</span> b <span class="main">:=</span> <span class="free">B</span><span class="main">;</span>
 <span class="keyword1">WHILE</span>  <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span>
 <span class="keyword1">INV</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;</span><span class="bound">a</span> <span class="main">∧</span> <span class="main">0</span><span class="main">&lt;</span><span class="bound">b</span> <span class="main">∧</span> gcd <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> gcd <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>
 <span class="keyword1">DO</span> <span class="keyword1">IF</span> <span class="bound">a</span><span class="main">&lt;</span><span class="bound">b</span> <span class="keyword1">THEN</span> b <span class="main">:=</span> <span class="bound">b</span><span class="main">-</span><span class="bound">a</span> <span class="keyword1">ELSE</span> a <span class="main">:=</span> <span class="bound">a</span><span class="main">-</span><span class="bound">b</span> <span class="keyword1">FI</span> <span class="keyword1">OD</span>
 <span class="main">{</span><span class="bound">a</span> <span class="main">=</span> gcd <span class="free">A</span> <span class="free">B</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">casified_vcg_simp</span>
  <span class="keyword3"><span class="command">case</span></span> while
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> postcondition
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> gcd_nnn<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> invariant
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> cond
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> vc
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_not_less gcd_diff_l gcd_diff_r less_imp_le<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Dijkstra's extension of Euclid's algorithm for simultaneous GCD and SCM›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  From E.W. Disjkstra. Selected Writings on Computing, p 98 (EWD474),
  where it is given without the invariant. Instead of defining scm
  explicitly we have used the theorem scm x y = x*y/gcd x y and avoided
  division by mupltiplying with gcd x y.
›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> distribs <span class="main">=</span>
  diff_mult_distrib diff_mult_distrib2 add_mult_distrib add_mult_distrib2

<span class="keyword1"><span class="command">lemma</span></span> gcd_scm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">a</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">b</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">x</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">y</span></span></span></span></span></span></span></span></span></span></span></span></span>
 <span class="main">{</span><span class="main">0</span><span class="main">&lt;</span><span class="free">A</span> <span class="main">∧</span> <span class="main">0</span><span class="main">&lt;</span><span class="free">B</span> <span class="main">∧</span> <span class="bound">a</span><span class="main">=</span><span class="free">A</span> <span class="main">∧</span> <span class="bound">b</span><span class="main">=</span><span class="free">B</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">=</span><span class="free">B</span> <span class="main">∧</span> <span class="bound">y</span><span class="main">=</span><span class="free">A</span><span class="main">}</span>
 <span class="keyword1">WHILE</span>  <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span>
 <span class="keyword1">INV</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;</span><span class="bound">a</span> <span class="main">∧</span> <span class="main">0</span><span class="main">&lt;</span><span class="bound">b</span> <span class="main">∧</span> gcd <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> gcd <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="free">A</span><span class="main">*</span><span class="free">B</span> <span class="main">=</span> <span class="bound">a</span><span class="main">*</span><span class="bound">x</span> <span class="main">+</span> <span class="bound">b</span><span class="main">*</span><span class="bound">y</span><span class="main">}</span>
 <span class="keyword1">DO</span> <span class="keyword1">IF</span> <span class="bound">a</span><span class="main">&lt;</span><span class="bound">b</span> <span class="keyword1">THEN</span> <span class="main">(</span>b <span class="main">:=</span> <span class="bound">b</span><span class="main">-</span><span class="bound">a</span><span class="main">;</span> x <span class="main">:=</span> <span class="bound">x</span><span class="main">+</span><span class="bound">y</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="main">(</span>a <span class="main">:=</span> <span class="bound">a</span><span class="main">-</span><span class="bound">b</span><span class="main">;</span> y <span class="main">:=</span> <span class="bound">y</span><span class="main">+</span><span class="bound">x</span><span class="main">)</span> <span class="keyword1">FI</span> <span class="keyword1">OD</span>
 <span class="main">{</span><span class="bound">a</span> <span class="main">=</span> gcd <span class="free">A</span> <span class="free">B</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="free">A</span><span class="main">*</span><span class="free">B</span> <span class="main">=</span> <span class="bound">a</span><span class="main">*</span><span class="main">(</span><span class="bound">x</span><span class="main">+</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">casified_vcg</span>
  <span class="keyword3"><span class="command">case</span></span> while <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">case</span></span> precondition <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> invariant
    <span class="keyword3"><span class="command">case</span></span> cond
    <span class="keyword3"><span class="command">case</span></span> vc
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distribs gcd_diff_r linorder_not_less gcd_diff_l<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> postcondition <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distribs gcd_nnn<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Power by iterated squaring and multiplication›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> power_by_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">a</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">b</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">c</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
 <span class="main">{</span><span class="bound">a</span><span class="main">=</span><span class="free">A</span> <span class="main">∧</span> <span class="bound">b</span><span class="main">=</span><span class="free">B</span><span class="main">}</span>
 c <span class="main">:=</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">;</span>
 <span class="keyword1">WHILE</span> <span class="bound">b</span> <span class="main">≠</span> <span class="main">0</span>
 <span class="keyword1">INV</span> <span class="main">{</span><span class="free">A</span><span class="main">^</span><span class="free">B</span> <span class="main">=</span> <span class="bound">c</span> <span class="main">*</span> <span class="bound">a</span><span class="main">^</span><span class="bound">b</span><span class="main">}</span>
 <span class="keyword1">DO</span>  <span class="keyword1">WHILE</span> <span class="bound">b</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span>
     <span class="keyword1">INV</span> <span class="main">{</span><span class="free">A</span><span class="main">^</span><span class="free">B</span> <span class="main">=</span> <span class="bound">c</span> <span class="main">*</span> <span class="bound">a</span><span class="main">^</span><span class="bound">b</span><span class="main">}</span>
     <span class="keyword1">DO</span>  a <span class="main">:=</span> <span class="bound">a</span><span class="main">*</span><span class="bound">a</span><span class="main">;</span> b <span class="main">:=</span> <span class="bound">b</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="keyword1">OD</span><span class="main">;</span>
     c <span class="main">:=</span> <span class="bound">c</span><span class="main">*</span><span class="bound">a</span><span class="main">;</span> b <span class="main">:=</span> <span class="bound">b</span> <span class="main">-</span> <span class="main">1</span>
 <span class="keyword1">OD</span>
 <span class="main">{</span><span class="bound">c</span> <span class="main">=</span> <span class="free">A</span><span class="main">^</span><span class="free">B</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">casified_vcg_simp</span>
  <span class="keyword3"><span class="command">case</span></span> while
  <span class="keyword3"><span class="command">case</span></span> invariant
  <span class="keyword3"><span class="command">case</span></span> while
  <span class="keyword3"><span class="command">case</span></span> postcondition
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Factorial›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> factorial<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">a</span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">b</span></span></span></span></span></span></span></span></span>
 <span class="main">{</span><span class="bound">a</span><span class="main">=</span><span class="free">A</span><span class="main">}</span>
 b <span class="main">:=</span> <span class="main">1</span><span class="main">;</span>
 <span class="keyword1">WHILE</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">0</span>
 <span class="keyword1">INV</span> <span class="main">{</span>fac <span class="free">A</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">*</span> fac <span class="bound">a</span><span class="main">}</span>
 <span class="keyword1">DO</span> b <span class="main">:=</span> <span class="bound">b</span><span class="main">*</span><span class="bound">a</span><span class="main">;</span> a <span class="main">:=</span> <span class="bound">a</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">OD</span>
 <span class="main">{</span><span class="bound">b</span> <span class="main">=</span> fac <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat_diff_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">i</span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">f</span></span></span></span></span></span></span></span></span></span></span>
 <span class="main">{</span>True<span class="main">}</span>
 i <span class="main">:=</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">;</span> f <span class="main">:=</span> <span class="main">1</span><span class="main">;</span>
 <span class="keyword1">WHILE</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">INV</span> <span class="main">{</span><span class="bound">f</span> <span class="main">=</span> fac<span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>
 <span class="keyword1">DO</span> f <span class="main">:=</span> <span class="bound">f</span><span class="main">*</span><span class="bound">i</span><span class="main">;</span> i <span class="main">:=</span> <span class="bound">i</span><span class="main">+</span><span class="main">1</span> <span class="keyword1">OD</span>
 <span class="main">{</span><span class="bound">f</span> <span class="main">=</span> fac <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">casified_vcg_simp</span>
  <span class="keyword3"><span class="command">case</span></span> while
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> invariant
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> basic
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> postcondition
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Quicksort›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The `partition' procedure for quicksort.
  `A' is the array to be sorted (modelled as a list).
  Elements of A must be of class order to infer at the end
  that the elements between u and l are equal to pivot.

  Ambiguity warnings of parser are due to := being used
  both for assignment and list update.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">pivot</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">leq</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">A</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">&lt;</span><span class="bound">i</span> <span class="main">⟶</span> <span class="bound">A</span><span class="main">!</span><span class="bound">k</span> <span class="main">≤</span> <span class="free">pivot</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">geq</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">A</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span><span class="main">&lt;</span>length <span class="bound">A</span> <span class="main">⟶</span> <span class="free">pivot</span> <span class="main">≤</span> <span class="bound">A</span><span class="main">!</span><span class="bound">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
   <span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">A</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">u</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">l</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
   <span class="main">{</span><span class="main">0</span> <span class="main">&lt;</span> length<span class="main">(</span><span class="bound">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>order<span class="main">)</span>list<span class="main">)</span><span class="main">}</span>
   l <span class="main">:=</span> <span class="main">0</span><span class="main">;</span> u <span class="main">:=</span> length <span class="bound">A</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">;</span>
   <span class="keyword1">WHILE</span> <span class="bound">l</span> <span class="main">≤</span> <span class="bound">u</span>
    <span class="keyword1">INV</span> <span class="main">{</span><span class="free">leq</span> <span class="bound">A</span> <span class="bound">l</span> <span class="main">∧</span> <span class="free">geq</span> <span class="bound">A</span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">u</span><span class="main">&lt;</span>length <span class="bound">A</span> <span class="main">∧</span> <span class="bound">l</span><span class="main">≤</span>length <span class="bound">A</span><span class="main">}</span>
    <span class="keyword1">DO</span> <span class="keyword1">WHILE</span> <span class="bound">l</span> <span class="main">&lt;</span> length <span class="bound">A</span> <span class="main">∧</span> <span class="bound">A</span><span class="main">!</span><span class="bound">l</span> <span class="main">≤</span> <span class="free">pivot</span>
        <span class="keyword1">INV</span> <span class="main">{</span><span class="free">leq</span> <span class="bound">A</span> <span class="bound">l</span> <span class="main">∧</span> <span class="free">geq</span> <span class="bound">A</span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">u</span><span class="main">&lt;</span>length <span class="bound">A</span> <span class="main">∧</span> <span class="bound">l</span><span class="main">≤</span>length <span class="bound">A</span><span class="main">}</span>
        <span class="keyword1">DO</span> l <span class="main">:=</span> <span class="bound">l</span><span class="main">+</span><span class="main">1</span> <span class="keyword1">OD</span><span class="main">;</span>
       <span class="keyword1">WHILE</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">u</span> <span class="main">∧</span> <span class="free">pivot</span> <span class="main">≤</span> <span class="bound">A</span><span class="main">!</span><span class="bound">u</span>
        <span class="keyword1">INV</span> <span class="main">{</span><span class="free">leq</span> <span class="bound">A</span> <span class="bound">l</span> <span class="main">∧</span> <span class="free">geq</span> <span class="bound">A</span> <span class="bound">u</span>  <span class="main">∧</span> <span class="bound">u</span><span class="main">&lt;</span>length <span class="bound">A</span> <span class="main">∧</span> <span class="bound">l</span><span class="main">≤</span>length <span class="bound">A</span><span class="main">}</span>
        <span class="keyword1">DO</span> u <span class="main">:=</span> <span class="bound">u</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">OD</span><span class="main">;</span>
       <span class="keyword1">IF</span> <span class="bound">l</span> <span class="main">≤</span> <span class="bound">u</span> <span class="keyword1">THEN</span> A <span class="main">:=</span> <span class="bound">A</span><span class="main">[</span><span class="bound">l</span> <span class="main">:=</span> <span class="bound">A</span><span class="main">!</span><span class="bound">u</span><span class="main">,</span> <span class="bound">u</span> <span class="main">:=</span> <span class="bound">A</span><span class="main">!</span><span class="bound">l</span><span class="main">]</span> <span class="keyword1">ELSE</span> <span class="keyword1">SKIP</span> <span class="keyword1">FI</span>
    <span class="keyword1">OD</span>
   <span class="main">{</span><span class="free">leq</span> <span class="bound">A</span> <span class="bound">u</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">u</span><span class="main">&lt;</span><span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span><span class="main">&lt;</span><span class="bound">l</span> <span class="main">⟶</span> <span class="bound">A</span><span class="main">!</span><span class="bound">k</span> <span class="main">=</span> <span class="free">pivot</span><span class="main">)</span> <span class="main">∧</span> <span class="free">geq</span> <span class="bound">A</span> <span class="bound">l</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> leq_def geq_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">casified_vcg_simp</span>
  <span class="keyword3"><span class="command">case</span></span> basic
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> while
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> postcondition
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_list_update<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> invariant
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> while
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> invariant
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> basic
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_SucE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> whilea
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> invariant
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> basic
          <span class="keyword1"><span class="command">have</span></span> lem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="bound">m</span> <span class="main">&lt;</span> Suc <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">from</span></span> basic <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_SucE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_imp_diff_less <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lem<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Conditionals">
<div class="head">
<h1>Theory Conditionals</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Decomposing Conditionals›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Conditionals
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="Case_Labeling.html">../Case_Labeling</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">interpretation</span></span> Labeling_Syntax <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> DC_conj<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">inp</span><span class="main">,</span><span class="free">ct</span><span class="main">,</span><span class="free">outp'</span><span class="main">:</span> <span class="free">a</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">outp'</span><span class="main">,</span><span class="free">ct</span><span class="main">,</span><span class="free">outp</span><span class="main">:</span> <span class="free">b</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">inp</span><span class="main">,</span><span class="free">ct</span><span class="main">,</span><span class="free">outp</span><span class="main">:</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">b</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> DC_if<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ct</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ct'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">pos</span> <span class="bound">name</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">pos</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">ct</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H⟨</span><span class="free">ct'</span> <span class="free">inp</span> <span class="inner_quoted">''then''</span><span class="main">:</span> <span class="free">a</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="keyword1">C⟨</span>Suc <span class="free">inp</span><span class="main">,</span><span class="free">ct'</span> <span class="free">inp</span> <span class="inner_quoted">''then''</span><span class="main">,</span> <span class="free">outp'</span><span class="main">:</span> <span class="free">b</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">H⟨</span><span class="free">ct'</span> <span class="free">outp'</span> <span class="inner_quoted">''else''</span><span class="main">:</span> <span class="main">¬</span><span class="free">a</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="keyword1">C⟨</span>Suc <span class="free">outp'</span><span class="main">,</span><span class="free">ct'</span> <span class="free">outp'</span> <span class="inner_quoted">''else''</span><span class="main">,</span> <span class="free">outp</span><span class="main">:</span> <span class="free">c</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">inp</span><span class="main">,</span><span class="free">ct</span><span class="main">,</span><span class="free">outp</span><span class="main">:</span> <span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> DC_final<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">V⟨</span><span class="main">(</span><span class="inner_quoted">''g''</span><span class="main">,</span><span class="free">inp</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="free">ct</span><span class="main">:</span> <span class="free">a</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">inp</span><span class="main">,</span><span class="free">ct</span><span class="main">,</span>Suc <span class="free">inp</span><span class="main">:</span> <span class="free">a</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">method</span></span> vcg_dc <span class="main">=</span> <span class="main">(</span><span class="operator">intro</span> DC_conj DC_if<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> DC_final<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> d'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">d'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⟹</span> <span class="main">¬</span><span class="free">c</span> <span class="main">⟹</span> <span class="free">e</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="keyword1">then</span> <span class="free">d</span> <span class="main">∧</span> <span class="free">d'</span> <span class="keyword1">else</span> <span class="free">e</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Initial_Label<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_dc</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">casify</span>
  <span class="keyword3"><span class="command">case</span></span> g <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> a<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"then"</span> <span class="keyword1"><span class="command">note</span></span> b <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">b</span>›</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"then"</span> <span class="keyword1"><span class="command">note</span></span> c <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">c</span>›</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> g <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> b c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> d<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> ga <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> b c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> d'<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> else
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> g <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"then"</span> else <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> e<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"else"</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> g <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> else <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> f<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Protecting similar subgoals›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The proof below fails if the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">disambig_subgoals</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> option is omitted: all three
  subgoals have the same conclusion and can be discharged without using their assumptions.
  If the case <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">g</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is solved first, it discharges instead the subgoal <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  making the case <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> then<span class="antiquote"><span class="antiquote">}</span></span></span></span> fail afterwards.

  The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">verbatim</span></span> <span class="raw_text"><span class="raw_text">disambig_subgoals</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> options prevents this by inserting vacuous assumptions.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="free">b</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">b</span><span class="main">)</span> <span class="main">∧</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Initial_Label<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_dc</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">casify</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">disambig_subgoals</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> g <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> <span class="quoted"><span class="quoted">‹<span class="free">b</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"then"</span> <span class="keyword3"><span class="command">case</span></span> g <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> <span class="quoted"><span class="quoted">‹<span class="free">b</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"else"</span> <span class="keyword3"><span class="command">case</span></span> g <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> <span class="quoted"><span class="quoted">‹<span class="free">b</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Unnamed Cases›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⟹</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">a</span> <span class="main">⟹</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Initial_Label<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_dc</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> LABEL_simps<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">casify</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">disambig_subgoals</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> unnamed <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> unnameda <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="free">a</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> g <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Monadic_Language">
<div class="head">
<h1>Theory Monadic_Language</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A labeling VCG for a monadic language›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Monadic_Language
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="Case_Labeling.html">../Case_Labeling</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹../util.ML›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">vcg_tac</span> <span class="entity">nt_rules</span> <span class="entity">nt_comb</span> <span class="entity">ctxt</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rules</span> <span class="main">=</span> <span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="entity">nt_rules</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">comb</span> <span class="main">=</span> <span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="entity">nt_comb</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="main">(</span> resolve_tac <span class="entity">ctxt</span> <span class="entity">rules</span> ORELSE' <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="entity">comb</span> THEN' resolve_tac <span class="entity">ctxt</span> <span class="entity">rules</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This language is inspired by the languages used in AutoCorres <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> greenaway_bridging_2012<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">consts</span></span> bind <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">|&gt;&gt;</span>"</span> 4<span class="main">)</span>
<span class="keyword1"><span class="command">consts</span></span> return <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span>
<span class="keyword1"><span class="command">consts</span></span> while <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">consts</span></span> valid <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> vcg
<span class="keyword1"><span class="command">named_theorems</span></span> vcg_comb

<span class="keyword1"><span class="command">method_setup</span></span> vcg <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span>FIRSTGOAL <span class="main">(</span><span class="entity">vcg_tac</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> "vcg"<span class="antiquote">}</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> "vcg_comb"<span class="antiquote">}</span></span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
›</span>


<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   return<span class="main">[</span><span class="operator">vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span><span class="free">Q</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>return <span class="free">x</span><span class="main">)</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   bind<span class="main">[</span><span class="operator">vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> valid <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Q</span><span class="main">;</span> valid <span class="free">P</span> <span class="free">c1</span> <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="free">P</span> <span class="main">(</span>bind <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   while<span class="main">[</span><span class="operator">vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> valid <span class="main">(</span><span class="free">I</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">c</span> <span class="bound">x</span><span class="main">)</span> <span class="free">I</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">I</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="main">(</span><span class="free">I</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>while <span class="free">b</span> <span class="free">I</span> <span class="bound">c</span> <span class="free">x</span><span class="main">)</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   cond<span class="main">[</span><span class="operator">vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> valid <span class="free">P1</span> <span class="bound">c1</span> <span class="free">Q</span> <span class="main">⟹</span> valid <span class="free">P2</span> <span class="bound">c2</span> <span class="free">Q</span> <span class="main">⟹</span> valid <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">P1</span> <span class="keyword1">else</span> <span class="free">P2</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="bound">c1</span> <span class="keyword1">else</span> <span class="bound">c2</span><span class="main">)</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   case_prod<span class="main">[</span><span class="operator">vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> valid <span class="main">(</span><span class="bound">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">Q</span><span class="main">⟧</span>
    <span class="main">⟹</span> valid <span class="main">(</span><span class="keyword1">case</span> <span class="free">v</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">v</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">B</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   conseq<span class="main">[</span><span class="operator">vcg_comb</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>valid <span class="free">P'</span> <span class="free">c</span> <span class="free">Q</span><span class="main">;</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">P'</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Labeled rules›</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> vcg_l
<span class="keyword1"><span class="command">named_theorems</span></span> vcg_l_comb
<span class="keyword1"><span class="command">named_theorems</span></span> vcg_elim

<span class="keyword1"><span class="command">method_setup</span></span> vcg_l <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span>FIRSTGOAL <span class="main">(</span><span class="entity">vcg_tac</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> "vcg_l"<span class="antiquote">}</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> "vcg_l_comb"<span class="antiquote">}</span></span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">method</span></span> vcg_l' <span class="main">=</span> <span class="main">(</span><span class="operator">vcg_l</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> <span class="dynamic"><span class="dynamic">vcg_elim</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">interpretation</span></span> Labeling_Syntax <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> L_return<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"CTXT <span class="free">inp</span> <span class="free">ct</span> <span class="main">(</span>Suc <span class="free">inp</span><span class="main">)</span> <span class="main">(</span>valid <span class="main">(</span><span class="free">P</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>return <span class="free">x</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> return<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> L_bind<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> CTXT <span class="main">(</span>Suc <span class="free">outp'</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''bind''</span><span class="main">,</span><span class="free">outp'</span><span class="main">,</span> <span class="main">[</span>VAR <span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">ct</span><span class="main">)</span> <span class="free">outp</span> <span class="main">(</span>valid <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">inp</span> <span class="free">ct</span> <span class="free">outp'</span> <span class="main">(</span>valid <span class="free">P</span> <span class="free">c1</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">inp</span> <span class="free">ct</span> <span class="free">outp</span> <span class="main">(</span>valid <span class="free">P</span> <span class="main">(</span>bind <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bind<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> L_while<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">inp</span> <span class="free">ct</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ct'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="inner_quoted">''while''</span><span class="main">,</span> <span class="free">inp</span><span class="main">,</span> <span class="main">[</span>VAR <span class="bound">x</span><span class="main">]</span><span class="main">)</span>  <span class="main">#</span> <span class="free">ct</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> CTXT <span class="main">(</span>Suc <span class="free">inp</span><span class="main">)</span> <span class="main">(</span><span class="free">ct'</span> <span class="bound">x</span><span class="main">)</span> <span class="free">outp'</span>
      <span class="main">(</span>valid <span class="main">(</span>BIND <span class="inner_quoted">''inv_pre''</span> <span class="free">inp</span> <span class="main">(</span><span class="free">I</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> BIND <span class="inner_quoted">''lcond''</span> <span class="free">inp</span> <span class="main">(</span><span class="free">b</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> BIND <span class="inner_quoted">''inv_post''</span> <span class="free">inp</span> <span class="main">(</span><span class="free">I</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">B⟨</span><span class="inner_quoted">''inv_pre''</span><span class="main">,</span><span class="free">inp</span><span class="main">:</span> <span class="free">I</span> <span class="bound">x</span><span class="main">⟩</span> <span class="main">∧</span> <span class="keyword1">B⟨</span><span class="inner_quoted">''lcond''</span><span class="main">,</span><span class="free">inp</span><span class="main">:</span> <span class="main">¬</span><span class="free">b</span> <span class="bound">x</span><span class="main">⟩</span> <span class="main">⟹</span> VC <span class="main">(</span><span class="inner_quoted">''post''</span><span class="main">,</span><span class="free">outp'</span> <span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="free">ct'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">inp</span> <span class="free">ct</span> <span class="main">(</span>Suc <span class="free">outp'</span><span class="main">)</span> <span class="main">(</span>valid <span class="main">(</span><span class="free">I</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>while <span class="free">b</span> <span class="free">I</span> <span class="free">c</span> <span class="free">x</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> while<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> L_cond<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">inp</span> <span class="free">ct</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ct'</span> <span class="main">≡</span> <span class="main">(</span><span class="inner_quoted">''if''</span><span class="main">,</span><span class="free">inp</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">ct</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span>Suc <span class="free">inp</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''then''</span><span class="main">,</span><span class="free">inp</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">ct'</span><span class="main">,</span><span class="free">outp</span><span class="main">:</span> valid <span class="free">P1</span> <span class="free">c1</span> <span class="free">Q</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span>Suc <span class="free">outp</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''else''</span><span class="main">,</span><span class="free">outp</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">ct'</span><span class="main">,</span><span class="free">outp'</span><span class="main">:</span> valid <span class="free">P2</span> <span class="free">c2</span> <span class="free">Q</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">C⟨</span><span class="free">inp</span><span class="main">,</span><span class="free">ct</span><span class="main">,</span><span class="free">outp'</span><span class="main">:</span> valid <span class="main">(</span><span class="keyword1">if</span> <span class="keyword1">B⟨</span><span class="inner_quoted">''cond''</span><span class="main">,</span><span class="free">inp</span><span class="main">:</span> <span class="free">b</span><span class="main">⟩</span> <span class="keyword1">then</span> <span class="keyword1">B⟨</span><span class="inner_quoted">''then''</span><span class="main">,</span><span class="free">inp</span><span class="main">:</span> <span class="free">P1</span><span class="main">⟩</span> <span class="keyword1">else</span> <span class="keyword1">B⟨</span><span class="inner_quoted">''else''</span><span class="main">,</span><span class="free">inp</span><span class="main">:</span> <span class="free">P2</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">c1</span> <span class="keyword1">else</span> <span class="free">c2</span><span class="main">)</span> <span class="free">Q</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cond<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> L_case_prod<span class="main">[</span><span class="operator">vcg_l</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> CTXT <span class="free">inp</span> <span class="free">ct</span> <span class="free">outp</span> <span class="main">(</span>valid <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">inp</span> <span class="free">ct</span> <span class="free">outp</span> <span class="main">(</span>valid <span class="main">(</span><span class="keyword1">case</span> <span class="free">v</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">v</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">B</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> case_prod<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> L_conseq<span class="main">[</span><span class="operator">vcg_l_comb</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="main">(</span>Suc <span class="free">inp</span><span class="main">)</span> <span class="free">ct</span> <span class="free">outp</span> <span class="main">(</span>valid <span class="free">P'</span> <span class="free">c</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> VC <span class="main">(</span><span class="inner_quoted">''conseq''</span><span class="main">,</span><span class="free">inp</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="free">ct</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CTXT <span class="free">inp</span> <span class="free">ct</span> <span class="free">outp</span> <span class="main">(</span>valid <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conseq<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> L_assm_conjE<span class="main">[</span><span class="operator">vcg_elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"BIND <span class="free">name</span> <span class="free">inp</span> <span class="main">(</span><span class="free">P</span> <span class="main">∧</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"BIND <span class="free">name</span> <span class="free">inp</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"BIND <span class="free">name</span> <span class="free">inp</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LABEL_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">declare</span></span> conjE<span class="main">[</span><span class="operator">vcg_elim</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">lemma</span></span> dvd_div<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">dvd</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">div</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms coprime_dvd_mult_left_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> divides<span class="main">:</span> <span class="quoted"><span class="quoted">"
valid
  <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span> <span class="main">::</span> int<span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>
    return <span class="free">a</span>
    <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span>
      while
        <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">n</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> odd <span class="bound">m</span> <span class="main">∧</span> <span class="bound">m</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">⟶</span> <span class="bound">m</span> <span class="keyword1">dvd</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> return <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
        <span class="bound">n</span>
    <span class="main">)</span>
  <span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> odd <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> odd <span class="bound">m</span> <span class="main">∧</span> <span class="bound">m</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">⟶</span> <span class="bound">m</span> <span class="main">≤</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zdvd_imp_le dvd_div div_positive_int <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>
      evenE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dvd_mult_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> L_divides<span class="main">:</span> <span class="quoted"><span class="quoted">"
valid
  <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span> <span class="main">::</span> int<span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>
    return <span class="free">a</span>
    <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span>
      while
        <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">n</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> odd <span class="bound">m</span> <span class="main">∧</span> <span class="bound">m</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">⟶</span> <span class="bound">m</span> <span class="keyword1">dvd</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> return <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
        <span class="bound">n</span>
    <span class="main">)</span>
  <span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> odd <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> odd <span class="bound">m</span> <span class="main">∧</span> <span class="bound">m</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">⟶</span> <span class="bound">m</span> <span class="main">≤</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Initial_Label<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_l'</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">casify</span>
<span class="keyword1"><span class="command">print_nested_cases</span></span>
  <span class="keyword3"><span class="command">case</span></span> bind
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> post <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zdvd_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> conseq
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹even <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_imp_zdiv_pos_iff zdvd_imp_le<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="keyword1">dvd</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹even <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_div_mult_self dvd_mult_left<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conseq.inv_pre<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹even <span class="skolem">n</span>›</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">m</span> <span class="numeral">2</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_eq_mod_eq_0 invertible_coprime mult_cancel_left2 not_mod_2_eq_1_eq_0<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="keyword1">dvd</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_div<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> conseq <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">lemma</span></span> add<span class="main">:</span> <span class="quoted"><span class="quoted">"
valid
  True
  <span class="main">(</span>
    while
      <span class="comment1">― ‹COND:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">b</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>
      <span class="comment1">― ‹INV:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span>
      <span class="comment1">― ‹BODY:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> return <span class="main">(</span><span class="bound">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
      <span class="comment1">― ‹START:›</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>
    <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> return <span class="bound">r</span><span class="main">)</span>
  <span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span>
"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> mult<span class="main">:</span> <span class="quoted"><span class="quoted">"
valid
  True
  <span class="main">(</span>
    while
      <span class="comment1">― ‹COND:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>
      <span class="comment1">― ‹INV:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span>
      <span class="comment1">― ‹BODY:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span>
        while
          <span class="comment1">― ‹COND:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">)</span>
          <span class="comment1">― ‹INV:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span>
          <span class="comment1">― ‹BODY:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> return <span class="main">(</span><span class="bound">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
          <span class="comment1">― ‹START:›</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>
        <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> return <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span>
      <span class="comment1">― ‹START:›</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>
    <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> return <span class="bound">r</span><span class="main">)</span>
  <span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span>
"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Labeled›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"
valid
  True
  <span class="main">(</span>
    while
      <span class="comment1">― ‹COND:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>
      <span class="comment1">― ‹INV:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span>
      <span class="comment1">― ‹BODY:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span>
        while
          <span class="comment1">― ‹COND:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">)</span>
          <span class="comment1">― ‹INV:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span>
          <span class="comment1">― ‹BODY:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> return <span class="main">(</span><span class="bound">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
          <span class="comment1">― ‹START:›</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>
        <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> return <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span>
      <span class="comment1">― ‹START:›</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>
    <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> return <span class="bound">r</span><span class="main">)</span>
  <span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span>
"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Initial_Label<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_l'</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">casify</span>
  <span class="keyword3"><span class="command">case</span></span> while
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> while
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> post <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> conseq <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> post <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> conseq <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> conseq <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L_paths<span class="main">:</span> <span class="quoted"><span class="quoted">"
valid
  <span class="main">(</span><span class="free">path</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span>
  <span class="main">(</span> while
      <span class="comment1">― ‹COND:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span>
      <span class="comment1">― ‹INV:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> distinct <span class="bound">r</span> <span class="main">∧</span> hd <span class="main">(</span><span class="bound">r</span> <span class="main">@</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> hd <span class="free">path</span> <span class="main">∧</span> last <span class="main">(</span><span class="bound">r</span> <span class="main">@</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> last <span class="free">path</span><span class="main">)</span>
      <span class="comment1">― ‹BODY:›</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span>
        return <span class="main">(</span>hd <span class="bound">p</span><span class="main">)</span>
        <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span>
          <span class="keyword1">if</span> <span class="main">(</span><span class="bound">r</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> hd <span class="bound">r</span><span class="main">)</span>
          <span class="keyword1">then</span> return <span class="main">[]</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">r</span>
            <span class="keyword1">then</span> return <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
            <span class="keyword1">else</span> return <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> return <span class="main">(</span>tl <span class="bound">p</span><span class="main">,</span> <span class="bound">r'</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>
        <span class="main">)</span>
        <span class="main">)</span>
        <span class="main">)</span>
      <span class="comment1">― ‹START:›</span> <span class="main">(</span><span class="free">path</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>
    <span class="main">|&gt;&gt;</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> return <span class="bound">r</span><span class="main">)</span>
  <span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> distinct <span class="bound">r</span> <span class="main">∧</span> hd <span class="bound">r</span> <span class="main">=</span> hd <span class="free">path</span> <span class="main">∧</span> last <span class="bound">r</span> <span class="main">=</span> last <span class="free">path</span><span class="main">)</span>
"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Initial_Label<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_l'</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">casify</span>
  <span class="keyword3"><span class="command">case</span></span> conseq <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> conseq
    <span class="keyword1"><span class="command">from</span></span> conseq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="var">?case</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> conseq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> hd <span class="skolem">p</span> <span class="main">=</span> hd <span class="skolem">r</span> <span class="main">⟹</span> <span class="var">?case</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">p</span> <span class="main">≠</span> hd <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> hd <span class="skolem">p</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">@</span> hd <span class="skolem">p</span> <span class="main">#</span> tl <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> hd <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> hd <span class="skolem">p</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">@</span> hd <span class="skolem">p</span> <span class="main">#</span> tl <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span><span class="skolem">r</span> <span class="main">@</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> hd <span class="skolem">p</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span>hd <span class="skolem">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> conseq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_takeWhileD<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> A conseq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> post <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/AFP/Case_Labeling/util.ML">
<div class="head">
<h1>File ‹$AFP/Case_Labeling/util.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">1</span> THEN_CONTEXT
<span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">1</span> THEN_ALL_NEW_FWD

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">BASIC_UTIL</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> INTERVAL_FWD<span class="main">:</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> REPEAT_ALL_NEW_FWD<span class="main">:</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> THEN_CONTEXT<span class="main">:</span> tactic * <span class="entity">context_tactic</span> <span class="main">-&gt;</span> <span class="entity">context_tactic</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> THEN_ALL_NEW_FWD<span class="main">:</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> * <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">UTIL</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">include</span></span> <span class="entity">BASIC_UTIL</span>
  <span class="keyword1"><span class="keyword">val</span></span> appair<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'c<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'b <span class="main">-&gt;</span> 'd<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'c * 'd<span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> infst<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> 'c * 'b<span class="main">)</span> <span class="main">-&gt;</span> 'a * 'e <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> <span class="main">(</span>'c * 'e<span class="main">)</span> * 'b

  <span class="keyword1"><span class="keyword">val</span></span> fst_ord<span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> order<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">)</span> * <span class="main">(</span>'a * 'b<span class="main">)</span> <span class="main">-&gt;</span> order
  <span class="keyword1"><span class="keyword">val</span></span> snd_ord<span class="main">:</span> <span class="main">(</span>'b * 'b <span class="main">-&gt;</span> order<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">)</span> * <span class="main">(</span>'a * 'b<span class="main">)</span> <span class="main">-&gt;</span> order
  <span class="keyword1"><span class="keyword">val</span></span> none_inf_ord<span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> order<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a option * 'a option<span class="main">)</span> <span class="main">-&gt;</span> order

  <span class="keyword1"><span class="keyword">val</span></span> dest_bool<span class="main">:</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> dest_option<span class="main">:</span> term <span class="main">-&gt;</span> term option
  <span class="keyword1"><span class="keyword">val</span></span> dest_pair<span class="main">:</span> term <span class="main">-&gt;</span> term * term
  <span class="keyword1"><span class="keyword">val</span></span> dest_tuple<span class="main">:</span> term <span class="main">-&gt;</span> term list

  <span class="keyword1"><span class="keyword">val</span></span> SIMPLE_METHOD_CASES<span class="main">:</span> <span class="entity">context_tactic</span> <span class="main">-&gt;</span> <span class="entity">Method.method</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Util</span> <span class="main">:</span> <span class="entity">UTIL</span> <span class="main">=</span>
 <span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">tac1</span> <span class="entity">THEN_CONTEXT</span> <span class="entity">tac2</span><span class="main">)</span> <span class="main">:</span> <span class="entity">context_tactic</span> <span class="main">=</span>
  <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">st</span> |&gt; <span class="entity">tac1</span> |&gt; Seq.maps <span class="main">(</span>pair <span class="entity">ctxt</span> #&gt; <span class="entity">tac2</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">appair</span> <span class="entity">f</span> <span class="entity">g</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">g</span> <span class="entity">y</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">infst</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="entity">c</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x'</span><span class="main">,</span><span class="entity">c'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">x'</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">,</span> <span class="entity">c'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fst_ord</span> <span class="entity">ord</span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">x'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">x'</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">snd_ord</span> <span class="entity">ord</span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">y'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">y'</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">none_inf_ord</span> <span class="entity">ord</span> <span class="main">(</span>SOME <span class="entity">x</span><span class="main">,</span> SOME <span class="entity">y</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">none_inf_ord</span> <span class="main">_</span> <span class="main">(</span>NONE<span class="main">,</span> NONE<span class="main">)</span> <span class="main">=</span> EQUAL
  <span class="main">|</span> <span class="entity">none_inf_ord</span> <span class="main">_</span> <span class="main">(</span>NONE<span class="main">,</span> SOME <span class="main">_</span><span class="main">)</span> <span class="main">=</span> GREATER
  <span class="main">|</span> <span class="entity">none_inf_ord</span> <span class="main">_</span> <span class="main">(</span>SOME <span class="main">_</span><span class="main">,</span> NONE<span class="main">)</span> <span class="main">=</span> LESS<span class="main">;</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_option</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "None"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> NONE
  <span class="main">|</span> <span class="entity">dest_option</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Some"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> SOME <span class="entity">t</span>
  <span class="main">|</span> <span class="entity">dest_option</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_option"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_bool</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "True"<span class="antiquote">}</span></span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">dest_bool</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "False"<span class="antiquote">}</span></span> <span class="main">=</span> false
  <span class="main">|</span> <span class="entity">dest_bool</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_bool"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_pair</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Pair"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t</span> $ <span class="entity">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">u</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">dest_pair</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_pair"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_tuple</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pair<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t1</span> $ <span class="entity">t2</span><span class="main">)</span> <span class="main">=</span>
      <span class="entity">t1</span> :: <span class="entity">dest_tuple</span> <span class="entity">t2</span>
  <span class="main">|</span> <span class="entity">dest_tuple</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span>



<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">SIMPLE_METHOD_CASES</span> <span class="entity">tac</span> <span class="main">=</span>
  <span class="entity">CONTEXT_METHOD</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">facts</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">st</span><span class="main">)</span> |&gt; <span class="main">(</span>ALLGOALS <span class="main">(</span><span class="entity">Method.insert_tac</span> <span class="entity">ctxt</span> <span class="entity">facts</span><span class="main">)</span> <span class="entity">THEN_CONTEXT</span> <span class="entity">tac</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* Apply tactic to subgoals in interval, in a forward manner, skipping over
  emerging subgoals *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">INTERVAL_FWD</span> <span class="entity">tac</span> <span class="entity">l</span> <span class="entity">u</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l</span>&gt;<span class="entity">u</span> <span class="keyword2"><span class="keyword">then</span></span> all_tac <span class="entity">st</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">tac</span> <span class="entity">l</span> THEN <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st'</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ofs</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st'</span> - Thm.nprems_of <span class="entity">st</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">ofs</span> &lt; <span class="inner_numeral">~1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span>
        <span class="inner_quoted">"INTERVAL_FWD: Tac solved more than one goal"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">st</span><span class="main">,</span><span class="entity">st'</span><span class="main">]</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">INTERVAL_FWD</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">l</span>+<span class="inner_numeral">1</span>+<span class="entity">ofs</span><span class="main">)</span> <span class="main">(</span><span class="entity">u</span>+<span class="entity">ofs</span><span class="main">)</span> <span class="entity">st'</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span><span class="main">;</span>

<span class="comment1">(* Apply tac2 to all subgoals emerged from tac1, in forward manner. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">tac1</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="entity">tac2</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">tac1</span> <span class="entity">i</span>
    THEN <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st'</span> <span class="main">=&gt;</span> <span class="entity">INTERVAL_FWD</span> <span class="entity">tac2</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">i</span> + Thm.nprems_of <span class="entity">st'</span> - Thm.nprems_of <span class="entity">st</span><span class="main">)</span> <span class="entity">st'</span><span class="main">)</span>
  <span class="main">)</span> <span class="entity">st</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="entity">tac</span> <span class="main">=</span>
  <span class="entity">tac</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="main">(</span>TRY o <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="entity">tac</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Basic_Util</span><span class="main">:</span> <span class="entity">BASIC_UTIL</span> <span class="main">=</span> <span class="entity">Util</span>
<span class="keyword3"><span class="keyword">open</span></span> <span class="entity">Basic_Util</span>
</pre>
</div><div id="Case_Labeling_Examples">
<div class="head">
<h1>Theory Case_Labeling_Examples</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Case_Labeling_Examples
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Labeled_Hoare_Examples.html">Examples/Hoare/Labeled_Hoare_Examples</a>"</span>
  <span class="quoted">"<a href="Conditionals.html">Examples/Conditionals</a>"</span>
  <span class="quoted">"<a href="Monadic_Language.html">Examples/Monadic_Language</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>